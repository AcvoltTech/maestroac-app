<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tutor IA ‚Äî Maestro Mario | Nivel 33</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Press+Start+2P&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0a0c10;
    --bg-card: #161a24;
    --bg-input: #1c2130;
    --border: #252b3a;
    --accent-orange: #f97316;
    --accent-orange-dim: rgba(249, 115, 22, 0.15);
    --accent-blue: #3b82f6;
    --text-primary: #f1f3f7;
    --text-secondary: #8b95aa;
    --text-muted: #5a6478;
    --success: #22c55e;
    --gradient-orange: linear-gradient(135deg, #f97316, #ea580c);
    --gradient-blue: linear-gradient(135deg, #3b82f6, #2563eb);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow: hidden;
  }
  body::before {
    content: '';
    position: fixed; inset: 0;
    background: radial-gradient(ellipse 80% 50% at 20% 0%, rgba(249,115,22,0.06) 0%, transparent 60%),
                radial-gradient(ellipse 60% 40% at 80% 100%, rgba(59,130,246,0.04) 0%, transparent 60%);
    pointer-events: none;
  }
  body::after {
    content: '';
    position: fixed; inset: 0;
    background-image: linear-gradient(rgba(255,255,255,0.012) 1px, transparent 1px),
                      linear-gradient(90deg, rgba(255,255,255,0.012) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
  }

  .app { position: relative; z-index: 1; display: flex; flex-direction: column; height: 100vh; max-width: 860px; margin: 0 auto; }

  /* HEADER */
  .header { padding: 16px 20px; display: flex; align-items: center; gap: 14px; border-bottom: 1px solid var(--border); background: rgba(10,12,16,0.85); backdrop-filter: blur(20px); }
  .header-avatar { width: 46px; height: 46px; border-radius: 14px; overflow: hidden; flex-shrink: 0; box-shadow: 0 4px 20px rgba(249,115,22,0.3); }
  .header-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .header-info { flex: 1; }
  .header-title { font-family: 'Bebas Neue', sans-serif; font-size: 20px; letter-spacing: 2px; line-height: 1; }
  .header-title span { color: var(--accent-orange); }
  .header-subtitle { font-size: 12px; color: var(--text-secondary); margin-top: 3px; display: flex; align-items: center; gap: 6px; }
  .status-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--success); animation: pulse-dot 2s ease-in-out infinite; }
  @keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .header-badge { background: var(--accent-orange-dim); color: var(--accent-orange); font-size: 10px; font-weight: 700; padding: 4px 10px; border-radius: 20px; letter-spacing: 0.5px; text-transform: uppercase; border: 1px solid rgba(249,115,22,0.2); }

  /* CATEGORIES */
  .categories { padding: 12px 20px; display: flex; gap: 8px; overflow-x: auto; border-bottom: 1px solid var(--border); background: rgba(10,12,16,0.6); scrollbar-width: none; }
  .categories::-webkit-scrollbar { display: none; }
  .chip { padding: 7px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: all 0.25s; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-secondary); user-select: none; }
  .chip:hover { border-color: var(--accent-orange); color: var(--accent-orange); }
  .chip.active { background: var(--gradient-orange); color: white; border-color: transparent; box-shadow: 0 2px 12px rgba(249,115,22,0.3); }

  /* CHAT */
  .chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth; }
  .chat-area::-webkit-scrollbar { width: 4px; }
  .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .message { display: flex; gap: 10px; max-width: 88%; animation: msg-in 0.35s cubic-bezier(0.16,1,0.3,1); }
  @keyframes msg-in { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
  .message.user { align-self: flex-end; flex-direction: row-reverse; }
  .msg-avatar { width: 32px; height: 32px; border-radius: 10px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; margin-top: 2px; overflow: hidden; }
  .message.assistant .msg-avatar { background: var(--gradient-orange); }
  .message.assistant .msg-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; }
  .message.user .msg-avatar { background: var(--gradient-blue); color: white; }
  .msg-bubble { padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.6; }
  .message.assistant .msg-bubble { background: var(--bg-card); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
  .message.user .msg-bubble { background: linear-gradient(135deg,#2563eb,#1d4ed8); border-bottom-right-radius: 4px; color: white; }
  .msg-bubble code { font-family: 'JetBrains Mono', monospace; background: rgba(249,115,22,0.1); color: var(--accent-orange); padding: 2px 6px; border-radius: 4px; font-size: 12.5px; }
  .msg-bubble strong { color: var(--accent-orange); font-weight: 700; }
  .msg-time { font-size: 10px; color: var(--text-muted); margin-top: 5px; text-align: right; }

  /* NO ENTENDI */
  .no-entendi-row { display: flex; justify-content: flex-start; padding-left: 42px; animation: msg-in 0.4s ease 0.3s both; }
  .no-entendi-btn { background: transparent; border: 1.5px dashed rgba(249,115,22,0.4); border-radius: 12px; padding: 8px 16px; color: var(--accent-orange); font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
  .no-entendi-btn:hover { background: var(--accent-orange-dim); border-color: var(--accent-orange); transform: scale(1.03); }

  /* WELCOME */
  .welcome { text-align: center; padding: 40px 20px 20px; animation: fade-in 0.6s ease; }
  @keyframes fade-in { from{opacity:0} to{opacity:1} }
  .welcome-icon { width: 80px; height: 80px; border-radius: 50%; overflow: hidden; margin: 0 auto 18px; box-shadow: 0 0 40px rgba(249,115,22,0.2); border: 3px solid var(--accent-orange); }
  .welcome-icon img { width: 100%; height: 100%; object-fit: cover; }
  .welcome h2 { font-family: 'Bebas Neue', sans-serif; font-size: 26px; letter-spacing: 3px; margin-bottom: 8px; }
  .welcome h2 span { color: var(--accent-orange); }
  .welcome p { color: var(--text-secondary); font-size: 14px; max-width: 400px; margin: 0 auto; line-height: 1.6; }
  .welcome-quote { margin-top: 16px; padding: 12px 20px; background: var(--accent-orange-dim); border: 1px solid rgba(249,115,22,0.15); border-radius: 12px; display: inline-block; font-size: 13px; font-weight: 600; color: var(--accent-orange); }

  /* QUICK */
  .quick-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 20px 10px; animation: fade-in 0.6s ease 0.2s both; }
  .quick-btn { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 14px; cursor: pointer; transition: all 0.25s; text-align: left; }
  .quick-btn:hover { border-color: var(--accent-orange); background: var(--accent-orange-dim); transform: translateY(-2px); }
  .quick-btn-icon { font-size: 20px; margin-bottom: 8px; }
  .quick-btn-title { font-size: 13px; font-weight: 700; margin-bottom: 3px; }
  .quick-btn-desc { font-size: 11px; color: var(--text-muted); line-height: 1.4; }

  /* TYPING */
  .typing { display: flex; gap: 10px; max-width: 88%; animation: msg-in 0.3s ease; }
  .typing-dots { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; border-bottom-left-radius: 4px; padding: 14px 20px; display: flex; gap: 5px; }
  .typing-dots span { width: 7px; height: 7px; border-radius: 50%; background: var(--accent-orange); animation: typing-bounce 1.4s ease-in-out infinite; }
  .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
  .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typing-bounce { 0%,60%,100%{transform:translateY(0);opacity:0.3} 30%{transform:translateY(-6px);opacity:1} }

  /* INPUT */
  .input-area { padding: 14px 20px 20px; border-top: 1px solid var(--border); background: rgba(10,12,16,0.9); backdrop-filter: blur(20px); }
  .input-wrapper { display: flex; gap: 10px; align-items: flex-end; }
  .input-field { flex: 1; background: var(--bg-input); border: 1.5px solid var(--border); border-radius: 14px; padding: 12px 16px; color: var(--text-primary); font-family: 'DM Sans', sans-serif; font-size: 14px; resize: none; outline: none; min-height: 46px; max-height: 120px; line-height: 1.5; transition: border-color 0.25s; }
  .input-field::placeholder { color: var(--text-muted); }
  .input-field:focus { border-color: var(--accent-orange); box-shadow: 0 0 0 3px var(--accent-orange-dim); }
  .send-btn { width: 46px; height: 46px; border-radius: 14px; border: none; background: var(--gradient-orange); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.25s; flex-shrink: 0; box-shadow: 0 4px 16px rgba(249,115,22,0.3); }
  .send-btn:hover { transform: scale(1.05); }
  .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .send-btn svg { width: 20px; height: 20px; }
  .input-hint { text-align: center; font-size: 10px; color: var(--text-muted); margin-top: 8px; }
  .input-hint span { color: var(--accent-orange); font-weight: 600; }

  /* ===== POKEMON BATTLE ===== */
  .pokemon-flash { position: fixed; inset: 0; background: white; z-index: 999; opacity: 0; pointer-events: none; }
  .pokemon-flash.active { animation: screen-flash 0.8s ease-out; }
  @keyframes screen-flash { 0%{opacity:0} 15%{opacity:1} 30%{opacity:0} 45%{opacity:0.7} 60%{opacity:0} 75%{opacity:0.3} 100%{opacity:0} }

  .battle-transition { position: fixed; inset: 0; z-index: 998; pointer-events: none; overflow: hidden; }
  .battle-transition.active .bt-stripe { animation: stripe-sweep 0.6s cubic-bezier(0.7,0,0.3,1) forwards; }
  .bt-stripe { position: absolute; left: 0; width: 100%; height: 12.5%; background: var(--bg-primary); transform: translateX(100%); }
  .bt-stripe:nth-child(odd) { transform: translateX(-100%); }
  .bt-stripe:nth-child(1){top:0%} .bt-stripe:nth-child(2){top:12.5%;animation-delay:.03s} .bt-stripe:nth-child(3){top:25%;animation-delay:.06s} .bt-stripe:nth-child(4){top:37.5%;animation-delay:.09s}
  .bt-stripe:nth-child(5){top:50%;animation-delay:.12s} .bt-stripe:nth-child(6){top:62.5%;animation-delay:.15s} .bt-stripe:nth-child(7){top:75%;animation-delay:.18s} .bt-stripe:nth-child(8){top:87.5%;animation-delay:.21s}
  @keyframes stripe-sweep { to{transform:translateX(0)} }

  .battle-scene { position: fixed; inset: 0; z-index: 1001; display: none; flex-direction: column; background: linear-gradient(180deg,#0d1117 0%,#161b28 40%,#1e2640 100%); overflow: hidden; }
  .battle-scene.active { display: flex; }

  .encounter-banner { text-align: center; padding: 30px 20px 10px; opacity: 0; }
  .encounter-banner.show { animation: encounter-text-in 0.5s ease forwards; }
  @keyframes encounter-text-in { from{opacity:0;transform:translateY(-20px)} to{opacity:1;transform:translateY(0)} }
  .encounter-label { font-family: 'Press Start 2P', monospace; font-size: 10px; color: var(--accent-orange); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; text-shadow: 0 0 20px rgba(249,115,22,0.5); }
  .encounter-title { font-family: 'Bebas Neue', sans-serif; font-size: 36px; letter-spacing: 5px; color: white; text-shadow: 0 0 30px rgba(249,115,22,0.3); }
  .encounter-title span { color: var(--accent-orange); }

  .maestro-stage { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; padding: 10px 20px; }
  .maestro-stage::after { content: ''; position: absolute; bottom: 15%; left: 10%; right: 10%; height: 4px; background: linear-gradient(90deg,transparent,rgba(249,115,22,0.3),transparent); border-radius: 50%; filter: blur(2px); }

  .maestro-avatar-container { position: relative; transform: translateX(120vw); }
  .maestro-avatar-container.slide-in { animation: pokemon-slide-in 0.8s cubic-bezier(0.2,0.8,0.2,1) forwards; }
  @keyframes pokemon-slide-in { 0%{transform:translateX(120vw) scale(0.5)} 60%{transform:translateX(-10px) scale(1.05)} 80%{transform:translateX(5px) scale(0.98)} 100%{transform:translateX(0) scale(1)} }

  .maestro-avatar-container.idle { animation: maestro-breathe 3s ease-in-out infinite; }
  @keyframes maestro-breathe { 0%,100%{transform:translateY(0) scale(1)} 50%{transform:translateY(-6px) scale(1.02)} }

  .maestro-avatar-container.talking { animation: maestro-talk 0.4s ease-in-out infinite; }
  @keyframes maestro-talk { 0%,100%{transform:translateY(0) scale(1) rotate(0deg)} 25%{transform:translateY(-3px) scale(1.01) rotate(-0.5deg)} 75%{transform:translateY(-2px) scale(1.005) rotate(0.5deg)} }

  .maestro-avatar-container.emphasis { animation: maestro-emphasis 0.5s ease; }
  @keyframes maestro-emphasis { 0%{transform:scale(1)} 25%{transform:scale(1.08) rotate(-2deg)} 50%{transform:scale(1.1) rotate(2deg)} 75%{transform:scale(1.05) rotate(-1deg)} 100%{transform:scale(1)} }

  .maestro-avatar-large {
    width: 180px; height: 180px; border-radius: 50%; overflow: hidden; position: relative;
    box-shadow: 0 0 60px rgba(249,115,22,0.3), 0 0 120px rgba(249,115,22,0.1);
    border: 4px solid var(--accent-orange);
  }
  .maestro-avatar-large::before { content: ''; position: absolute; inset: -8px; border-radius: 50%; border: 3px solid var(--accent-orange); opacity: 0.4; animation: avatar-ring-pulse 2s ease-in-out infinite; }
  @keyframes avatar-ring-pulse { 0%,100%{transform:scale(1);opacity:0.4} 50%{transform:scale(1.08);opacity:0.15} }
  .maestro-avatar-large img { width: 100%; height: 100%; object-fit: cover; }

  .maestro-avatar-large.speaking::after {
    content: ''; position: absolute; inset: -12px; border-radius: 50%;
    border: 3px solid var(--accent-orange);
    animation: speak-ring 0.8s ease-in-out infinite;
  }
  @keyframes speak-ring { 0%,100%{transform:scale(1);opacity:0.6} 50%{transform:scale(1.12);opacity:0} }

  .maestro-name-tag { position: absolute; bottom: -38px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); border: 1.5px solid var(--accent-orange); border-radius: 8px; padding: 5px 16px; white-space: nowrap; }
  .maestro-name-tag span { font-family: 'Press Start 2P', monospace; font-size: 9px; color: var(--accent-orange); letter-spacing: 1px; }

  .sparkle { position: absolute; width: 6px; height: 6px; background: var(--accent-orange); border-radius: 50%; opacity: 0; }
  .maestro-avatar-container.slide-in .sparkle { animation: sparkle-pop 0.6s ease forwards; }
  .sparkle:nth-child(1){top:10%;left:-20px;animation-delay:.5s} .sparkle:nth-child(2){top:0;right:-15px;animation-delay:.6s}
  .sparkle:nth-child(3){bottom:20%;left:-25px;animation-delay:.7s} .sparkle:nth-child(4){bottom:10%;right:-20px;animation-delay:.55s}
  .sparkle:nth-child(5){top:30%;right:-30px;animation-delay:.65s}
  @keyframes sparkle-pop { 0%{transform:scale(0);opacity:1} 50%{transform:scale(1.5);opacity:1} 100%{transform:scale(0);opacity:0} }

  .sound-waves { position: absolute; bottom: -55px; left: 50%; transform: translateX(-50%); display: none; gap: 3px; align-items: flex-end; height: 20px; }
  .sound-waves.active { display: flex; }
  .sound-wave-bar { width: 4px; background: var(--accent-orange); border-radius: 2px; animation: wave-bar 0.8s ease-in-out infinite; }
  .sound-wave-bar:nth-child(1){height:8px;animation-delay:0s} .sound-wave-bar:nth-child(2){height:14px;animation-delay:.1s}
  .sound-wave-bar:nth-child(3){height:20px;animation-delay:.2s} .sound-wave-bar:nth-child(4){height:14px;animation-delay:.3s}
  .sound-wave-bar:nth-child(5){height:8px;animation-delay:.4s}
  @keyframes wave-bar { 0%,100%{transform:scaleY(0.4)} 50%{transform:scaleY(1)} }

  .pokemon-textbox { margin: 0 16px 20px; background: #1a1a2e; border: 3px solid var(--accent-orange); border-radius: 16px; padding: 20px 22px; position: relative; min-height: 120px; box-shadow: 0 0 30px rgba(249,115,22,0.15), inset 0 1px 0 rgba(255,255,255,0.05); opacity: 0; }
  .pokemon-textbox.show { animation: textbox-pop 0.4s cubic-bezier(0.2,0.8,0.2,1) forwards; }
  @keyframes textbox-pop { from{opacity:0;transform:translateY(20px) scale(0.95)} to{opacity:1;transform:translateY(0) scale(1)} }
  .pokemon-textbox::before { content: ''; position: absolute; inset: 4px; border: 1.5px solid rgba(249,115,22,0.2); border-radius: 12px; pointer-events: none; }
  .pokemon-text { font-family: 'Press Start 2P', monospace; font-size: 12px; line-height: 2.2; color: var(--text-primary); min-height: 60px; }
  .pokemon-cursor { display: inline-block; width: 10px; height: 14px; background: var(--accent-orange); margin-left: 4px; animation: blink-cursor 0.6s step-end infinite; vertical-align: middle; }
  @keyframes blink-cursor { 0%,100%{opacity:1} 50%{opacity:0} }
  .pokemon-arrow { position: absolute; bottom: 12px; right: 16px; width: 0; height: 0; border-left: 7px solid transparent; border-right: 7px solid transparent; border-top: 9px solid var(--accent-orange); animation: bounce-arrow 1s ease-in-out infinite; opacity: 0; cursor: pointer; }
  .pokemon-arrow.show { opacity: 1; }
  @keyframes bounce-arrow { 0%,100%{transform:translateY(0)} 50%{transform:translateY(5px)} }

  .pokemon-close { display: none; margin: 0 16px 24px; padding: 14px; background: var(--gradient-orange); border: none; border-radius: 12px; color: white; font-family: 'Bebas Neue', sans-serif; font-size: 18px; letter-spacing: 3px; cursor: pointer; transition: all 0.25s; box-shadow: 0 4px 20px rgba(249,115,22,0.3); }
  .pokemon-close.show { display: block; }
  .pokemon-close:hover { transform: scale(1.02); }

  @media (max-width: 600px) {
    .quick-actions { grid-template-columns: 1fr; }
    .header-badge { display: none; }
    .message { max-width: 92%; }
    .maestro-avatar-large { width: 140px; height: 140px; }
    .encounter-title { font-size: 28px; }
    .pokemon-text { font-size: 11px; }
  }
</style>
</head>
<body>

<div class="app">
  <div class="header">
    <div class="header-avatar"><img src="AVATAR_PLACEHOLDER" alt="Maestro Mario"></div>
    <div class="header-info">
      <div class="header-title">TUTOR IA ‚Äî <span>MAESTRO MARIO</span></div>
      <div class="header-subtitle"><span class="status-dot"></span> HVAC ¬∑ Refrigeraci√≥n ¬∑ El√©ctrico</div>
    </div>
    <div class="header-badge">NIVEL 33</div>
  </div>
  <div class="categories">
    <div class="chip active" data-cat="general">General</div>
    <div class="chip" data-cat="hvac">HVAC</div>
    <div class="chip" data-cat="refrigeracion">Refrigeraci√≥n</div>
    <div class="chip" data-cat="electrico">El√©ctrico</div>
    <div class="chip" data-cat="diagnostico">Diagn√≥stico</div>
    <div class="chip" data-cat="negocio">Negocio</div>
  </div>
  <div class="chat-area" id="chatArea">
    <div class="welcome" id="welcome">
      <div class="welcome-icon"><img src="AVATAR_PLACEHOLDER" alt="Maestro Mario"></div>
      <h2>TUTOR IA <span>NIVEL 33</span></h2>
      <p>Tu asistente de aprendizaje en HVAC, Refrigeraci√≥n y Sistemas El√©ctricos.</p>
      <div class="welcome-quote">"Si no mides, est√°s adivinando" ‚Äî Maestro Mario</div>
    </div>
    <div class="quick-actions" id="quickActions">
      <div class="quick-btn" onclick="sendQuick('¬øC√≥mo diagnostico un compresor que no arranca?')"><div class="quick-btn-icon">üîß</div><div class="quick-btn-title">Diagn√≥stico de Compresor</div><div class="quick-btn-desc">Pasos para identificar la falla</div></div>
      <div class="quick-btn" onclick="sendQuick('Expl√≠came c√≥mo calcular la carga t√©rmica de un espacio')"><div class="quick-btn-icon">üìê</div><div class="quick-btn-title">Carga T√©rmica</div><div class="quick-btn-desc">C√°lculo paso a paso</div></div>
      <div class="quick-btn" onclick="sendQuick('¬øCu√°l es la diferencia entre un capacitor de arranque y uno de marcha?')"><div class="quick-btn-icon">‚ö°</div><div class="quick-btn-title">Capacitores</div><div class="quick-btn-desc">Arranque vs Marcha</div></div>
      <div class="quick-btn" onclick="sendQuick('¬øQu√© lecturas debo tomar con el mult√≠metro en un sistema split?')"><div class="quick-btn-icon">üìä</div><div class="quick-btn-title">Mediciones</div><div class="quick-btn-desc">Lecturas con mult√≠metro</div></div>
    </div>
  </div>
  <div class="input-area">
    <div class="input-wrapper">
      <textarea class="input-field" id="userInput" placeholder="Pregunta sobre HVAC, refrigeraci√≥n o el√©ctrico..." rows="1" onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
    </div>
    <div class="input-hint">Powered by <span>Nivel 33</span> ¬∑ La Trinidad del Oficio</div>
  </div>
</div>

<!-- POKEMON OVERLAY -->
<div class="pokemon-flash" id="pokemonFlash"></div>
<div class="battle-transition" id="battleTransition"><div class="bt-stripe"></div><div class="bt-stripe"></div><div class="bt-stripe"></div><div class="bt-stripe"></div><div class="bt-stripe"></div><div class="bt-stripe"></div><div class="bt-stripe"></div><div class="bt-stripe"></div></div>
<div class="battle-scene" id="battleScene">
  <div class="encounter-banner" id="encounterBanner">
    <div class="encounter-label">¬° PREG√öNTALE AL MAESTRO !</div>
    <div class="encounter-title">MAESTRO <span>MARIO</span></div>
  </div>
  <div class="maestro-stage">
    <div class="maestro-avatar-container" id="maestroAvatar">
      <div class="sparkle"></div><div class="sparkle"></div><div class="sparkle"></div><div class="sparkle"></div><div class="sparkle"></div>
      <div class="maestro-avatar-large" id="avatarLarge">
        <img src="AVATAR_PLACEHOLDER" alt="Maestro Mario">
      </div>
      <div class="maestro-name-tag"><span>LV.33 MAESTRO MARIO</span></div>
      <div class="sound-waves" id="soundWaves">
        <div class="sound-wave-bar"></div><div class="sound-wave-bar"></div><div class="sound-wave-bar"></div><div class="sound-wave-bar"></div><div class="sound-wave-bar"></div>
      </div>
    </div>
  </div>
  <div class="pokemon-textbox" id="pokemonTextbox">
    <div class="pokemon-text" id="pokemonText"></div>
    <div class="pokemon-arrow" id="pokemonArrow" onclick="advancePokemonText()"></div>
  </div>
  <button class="pokemon-close" id="pokemonClose" onclick="closeBattleScene()">¬° ENTENDIDO, MAESTRO ! ‚ñ∂</button>
</div>

<script>
  // ==========================================
  // SUPABASE CONFIG ‚Äî API Keys are SECURE on server
  // ==========================================
  const SUPABASE_URL = 'https://htklsowiyjwsjnacnvnr.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_Appokp_k6dAzxDjjmlED9g_bLi4kLQs';

  // Edge Function endpoints
  const CHAT_ENDPOINT = `${SUPABASE_URL}/functions/v1/tutor-ia-chat`;
  const VOICE_ENDPOINT = `${SUPABASE_URL}/functions/v1/tutor-ia-voice`;

  // Avatar base64
  const AVATAR_B64 = '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';
  const AVATAR_SRC = `data:image/jpeg;base64,${AVATAR_B64}`;

  // Set all avatar images
  document.querySelectorAll('[src="AVATAR_PLACEHOLDER"]').forEach(img => img.src = AVATAR_SRC);

  const SYSTEM_PROMPT = `Eres el Tutor IA de Nivel 33, el asistente virtual de aprendizaje creado por Maestro Mario (Mario Flores Corona), instructor master con m√°s de 25 a√±os de experiencia en HVAC, Refrigeraci√≥n y Sistemas El√©ctricos.

Tu personalidad: filosof√≠a "Si no mides, est√°s adivinando". Hablas en espa√±ol profesional, directo pero amable. Usas analog√≠as pr√°cticas del taller.

Reglas:
1) Siempre pide que midan antes de asumir
2) Explica el POR QU√â detr√°s de cada paso
3) Incluye valores esperados y rangos normales
4) Seguridad PRIMERO siempre
5) Formato claro con negritas y c√≥digo para valores
6) Nunca inventes datos o especificaciones
7) Menciona las herramientas necesarias

Formato: respuestas concisas (m√°ximo 300 palabras), usa **negritas** para conceptos clave y \`c√≥digo\` para valores num√©ricos y mediciones.`;

  const MAESTRO_EXPLAIN_PROMPT = `Eres Maestro Mario en persona explicando directamente a un estudiante que NO entendi√≥ la explicaci√≥n anterior. Habla como si estuvieras en el taller, cara a cara con el t√©cnico.

REGLAS ESTRICTAS:
- Usa analog√≠as simples de la vida diaria
- M√ÅXIMO 3 oraciones cortas por p√°gina
- Separa cada p√°gina con |||
- Habla en primera persona, casual pero profesional
- Empieza con algo motivador como "Mira carnal..." o "√ìrale, te lo explico as√≠..."
- Termina SIEMPRE con alguna variaci√≥n de "si no mides, est√°s adivinando"
- NO uses markdown ni formato especial
- M√°ximo 5 p√°ginas`;

  let conversationHistory = [];
  let isProcessing = false;
  let activeCategory = 'general';
  let lastAssistantMessage = '';
  let lastUserQuestion = '';
  let pokemonPages = [];
  let currentPage = 0;
  let isTypingPokemon = false;
  let typewriterTimeout = null;
  let currentAudio = null;

  const categoryContext = {
    general:'', hvac:'Contexto: pregunta sobre HVAC/aire acondicionado.',
    refrigeracion:'Contexto: pregunta sobre refrigeraci√≥n comercial/industrial.',
    electrico:'Contexto: pregunta sobre sistemas el√©ctricos.',
    diagnostico:'Contexto: necesita ayuda con diagn√≥stico. Enf√≥cate en medici√≥n y pasos sistem√°ticos.',
    negocio:'Contexto: pregunta sobre el negocio de HVAC, ventas, o administraci√≥n.'
  };

  document.querySelectorAll('.chip').forEach(c => c.addEventListener('click', () => {
    document.querySelector('.chip.active').classList.remove('active');
    c.classList.add('active');
    activeCategory = c.dataset.cat;
  }));

  function getTimestamp() { return new Date().toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'}); }
  function autoResize(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,120)+'px'; }
  function handleKey(e) { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} }
  function scrollToBottom() { const c=document.getElementById('chatArea'); setTimeout(()=>c.scrollTop=c.scrollHeight,50); }

  function addMessage(role, content, showNoEntendi=false) {
    const chat = document.getElementById('chatArea');
    const div = document.createElement('div');
    div.className = `message ${role}`;
    let html = content.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/`([^`]+)`/g,'<code>$1</code>').replace(/\n/g,'<br>');
    const avatarHTML = role==='assistant' ? `<img src="${AVATAR_SRC}" alt="M">` : 'üë§';
    div.innerHTML = `<div class="msg-avatar">${avatarHTML}</div><div><div class="msg-bubble">${html}</div><div class="msg-time">${getTimestamp()}</div></div>`;
    chat.appendChild(div);
    if (role==='assistant' && showNoEntendi) {
      const btnRow = document.createElement('div');
      btnRow.className = 'no-entendi-row';
      btnRow.innerHTML = `<button class="no-entendi-btn" onclick="triggerMaestroEncounter()"><span style="font-size:16px">üéì</span> ¬øNo entendiste? Preg√∫ntale al Maestro</button>`;
      chat.appendChild(btnRow);
    }
    scrollToBottom();
  }

  function showTyping() {
    const chat = document.getElementById('chatArea');
    const div = document.createElement('div');
    div.className='typing'; div.id='typingIndicator';
    div.innerHTML = `<div class="msg-avatar" style="background:var(--gradient-orange);overflow:hidden"><img src="${AVATAR_SRC}" style="width:100%;height:100%;object-fit:cover;border-radius:10px" alt="M"></div><div class="typing-dots"><span></span><span></span><span></span></div>`;
    chat.appendChild(div); scrollToBottom();
  }
  function hideTyping() { const el=document.getElementById('typingIndicator'); if(el)el.remove(); }
  function hideWelcome() { const w=document.getElementById('welcome'),q=document.getElementById('quickActions'); if(w)w.style.display='none'; if(q)q.style.display='none'; }
  function sendQuick(t) { document.getElementById('userInput').value=t; sendMessage(); }

  // ===== CHAT VIA SUPABASE EDGE FUNCTION =====
  async function callChatAPI(messages, system, max_tokens = 1000) {
    const response = await fetch(CHAT_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
      },
      body: JSON.stringify({ messages, system, max_tokens }),
    });
    return await response.json();
  }

  async function sendMessage() {
    const input = document.getElementById('userInput');
    const text = input.value.trim();
    if (!text || isProcessing) return;
    isProcessing = true;
    document.getElementById('sendBtn').disabled = true;
    hideWelcome();
    addMessage('user', text);
    lastUserQuestion = text;
    input.value = '';
    input.style.height = 'auto';

    const catCtx = categoryContext[activeCategory];
    const userMsg = catCtx ? `[${activeCategory}] ${catCtx}\n\n${text}` : text;
    conversationHistory.push({ role: 'user', content: userMsg });

    showTyping();
    try {
      const data = await callChatAPI(conversationHistory, SYSTEM_PROMPT);
      hideTyping();
      if (data.content && data.content.length > 0) {
        const reply = data.content.map(c => c.text || '').join('\n');
        conversationHistory.push({ role: 'assistant', content: reply });
        lastAssistantMessage = reply;
        addMessage('assistant', reply, true);
      } else {
        addMessage('assistant', '‚ö†Ô∏è Hubo un problema con la respuesta. Intenta de nuevo.');
      }
    } catch (err) {
      hideTyping();
      addMessage('assistant', '‚ö†Ô∏è Error de conexi√≥n. Verifica tu internet e intenta de nuevo.');
      console.error('Chat error:', err);
    }
    isProcessing = false;
    document.getElementById('sendBtn').disabled = false;
    input.focus();
  }

  // ===== ELEVENLABS VOICE VIA SUPABASE EDGE FUNCTION =====
  async function speakText(text) {
    try {
      const response = await fetch(VOICE_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        },
        body: JSON.stringify({ text }),
      });
      if (!response.ok) return null;
      const blob = await response.blob();
      if (blob.type.includes('json')) return null; // error response
      const url = URL.createObjectURL(blob);
      return new Audio(url);
    } catch (e) {
      console.error('Voice error:', e);
      return null;
    }
  }

  function stopCurrentAudio() {
    if (currentAudio) { currentAudio.pause(); currentAudio = null; }
  }

  // ===== POKEMON ENCOUNTER =====
  async function triggerMaestroEncounter() {
    document.querySelectorAll('.no-entendi-row').forEach(el => el.remove());
    stopCurrentAudio();

    // Phase 1: Flash
    document.getElementById('pokemonFlash').classList.add('active');
    setTimeout(() => document.getElementById('battleTransition').classList.add('active'), 400);

    // Phase 2: Battle scene
    setTimeout(() => {
      document.getElementById('pokemonFlash').classList.remove('active');
      document.getElementById('battleTransition').classList.remove('active');
      const scene = document.getElementById('battleScene');
      scene.classList.add('active');

      setTimeout(() => document.getElementById('encounterBanner').classList.add('show'), 200);

      const avatar = document.getElementById('maestroAvatar');
      setTimeout(() => {
        avatar.classList.add('slide-in');
        setTimeout(() => {
          avatar.classList.remove('slide-in');
          avatar.classList.add('idle');
        }, 900);
      }, 700);

      setTimeout(() => fetchMaestroExplanation(), 1600);
    }, 1000);
  }

  async function fetchMaestroExplanation() {
    const textbox = document.getElementById('pokemonTextbox');
    const textEl = document.getElementById('pokemonText');
    textbox.classList.add('show');
    textEl.innerHTML = '<span class="pokemon-cursor"></span>';

    try {
      const data = await callChatAPI(
        [{ role: 'user', content: `Pregunta original: "${lastUserQuestion}"\n\nRespuesta que no entendi√≥:\n${lastAssistantMessage}\n\nExpl√≠cale m√°s simple como Maestro Mario en persona.` }],
        MAESTRO_EXPLAIN_PROMPT,
        600
      );
      if (data.content && data.content.length > 0) {
        const full = data.content.map(c => c.text || '').join('');
        pokemonPages = full.split('|||').map(p => p.trim()).filter(p => p.length > 0);
      } else {
        pokemonPages = ['D√©jame explicarte de otra forma... Intenta con una pregunta m√°s espec√≠fica, carnal.'];
      }
    } catch (err) {
      pokemonPages = ['Hay un problema de conexi√≥n. Pero recuerda: si no mides, est√°s adivinando.'];
    }

    currentPage = 0;
    showPokemonPage(0);
  }

  async function showPokemonPage(pageIndex) {
    const textEl = document.getElementById('pokemonText');
    const arrow = document.getElementById('pokemonArrow');
    const closeBtn = document.getElementById('pokemonClose');
    const avatar = document.getElementById('maestroAvatar');
    const avatarLarge = document.getElementById('avatarLarge');
    const soundWaves = document.getElementById('soundWaves');

    arrow.classList.remove('show');
    closeBtn.classList.remove('show');
    textEl.innerHTML = '';
    isTypingPokemon = true;

    const text = pokemonPages[pageIndex];

    // Switch to talking animation
    avatar.classList.remove('idle');
    avatar.classList.add('talking');
    avatarLarge.classList.add('speaking');

    // Start voice (async)
    let audio = null;
    try {
      audio = await speakText(text);
      if (audio) {
        currentAudio = audio;
        soundWaves.classList.add('active');
        audio.play();
        audio.onended = () => {
          soundWaves.classList.remove('active');
          if (!isTypingPokemon) {
            avatar.classList.remove('talking');
            avatar.classList.add('idle');
            avatarLarge.classList.remove('speaking');
          }
        };
      }
    } catch(e) { console.log('Voice not available yet'); }

    // Typewriter effect
    let charIndex = 0;
    function typeChar() {
      if (charIndex < text.length) {
        textEl.textContent = text.substring(0, charIndex + 1);
        charIndex++;
        let delay = 35;
        const ch = text[charIndex - 1];
        if (ch === '.' || ch === '!' || ch === '?') delay = 300;
        else if (ch === ',') delay = 150;
        else if (ch === ':') delay = 200;

        // Random emphasis shake on punctuation
        if ((ch === '!' || ch === '?') && Math.random() > 0.5) {
          avatar.classList.remove('talking');
          avatar.classList.add('emphasis');
          setTimeout(() => { avatar.classList.remove('emphasis'); avatar.classList.add('talking'); }, 500);
        }

        typewriterTimeout = setTimeout(typeChar, delay);
      } else {
        isTypingPokemon = false;
        if (!audio || audio.ended) {
          avatar.classList.remove('talking');
          avatar.classList.add('idle');
          avatarLarge.classList.remove('speaking');
          soundWaves.classList.remove('active');
        }
        if (pageIndex < pokemonPages.length - 1) arrow.classList.add('show');
        else closeBtn.classList.add('show');
      }
    }
    typeChar();
  }

  function advancePokemonText() {
    if (isTypingPokemon) {
      clearTimeout(typewriterTimeout);
      document.getElementById('pokemonText').textContent = pokemonPages[currentPage];
      isTypingPokemon = false;
      const avatar = document.getElementById('maestroAvatar');
      const avatarLarge = document.getElementById('avatarLarge');
      if (!currentAudio || currentAudio.ended) {
        avatar.classList.remove('talking');
        avatar.classList.add('idle');
        avatarLarge.classList.remove('speaking');
      }
      if (currentPage < pokemonPages.length - 1) document.getElementById('pokemonArrow').classList.add('show');
      else { document.getElementById('pokemonArrow').classList.remove('show'); document.getElementById('pokemonClose').classList.add('show'); }
      return;
    }
    currentPage++;
    if (currentPage < pokemonPages.length) {
      stopCurrentAudio();
      showPokemonPage(currentPage);
    }
  }

  document.getElementById('pokemonTextbox').addEventListener('click', e => {
    if (e.target.id !== 'pokemonArrow') advancePokemonText();
  });

  function closeBattleScene() {
    stopCurrentAudio();
    const scene = document.getElementById('battleScene');
    scene.classList.remove('active');
    document.getElementById('encounterBanner').classList.remove('show');
    const avatar = document.getElementById('maestroAvatar');
    avatar.classList.remove('slide-in', 'idle', 'talking', 'emphasis');
    document.getElementById('avatarLarge').classList.remove('speaking');
    document.getElementById('pokemonTextbox').classList.remove('show');
    document.getElementById('pokemonArrow').classList.remove('show');
    document.getElementById('pokemonClose').classList.remove('show');
    document.getElementById('soundWaves').classList.remove('active');
    document.getElementById('pokemonText').innerHTML = '';
    pokemonPages = [];
    currentPage = 0;
    document.getElementById('userInput').focus();
  }
</script>
</body>
</html>
