<!DOCTYPE html>
<html lang="es">
<head>
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f39c12">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Maestro ACVOLT">
    <link rel="apple-touch-icon" href="icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Maestro ACVOLT">
    <meta name="msapplication-TileColor" content="#1a1a2e">
    <meta name="msapplication-TileImage" content="icons/icon-144.png">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- Open Graph / Social -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Maestro ACVOLT - Certificaci√≥n HVAC Profesional">
    <meta property="og:description" content="App #1 de certificaci√≥n HVAC en espa√±ol. 3,500+ preguntas para EPA 608, NATE, OSHA 30. Por Maestro Mario - Nivel 33.">
    <meta property="og:image" content="icons/icon-512.png">
    <meta name="twitter:card" content="summary_large_image">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1565C0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Maestro ACVOLT - HVAC Training App</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; min-height: 100vh; color: #1e293b; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; min-height: 100vh; }
    .screen { display: none; }
    .screen.active { display: flex !important; flex-direction: column; }
    .header { text-align: center; padding: 8px 0 4px; }
    .logo { font-size: 50px; margin-bottom: 10px; }
    .logo-img { max-width: 140px; height: auto; margin-bottom: 5px; }
    h1 { font-size: 28px; margin-bottom: 5px; }
    h2 { font-size: 22px; color: #E31937; margin-bottom: 10px; }
    .subtitle { color: #64748b; font-size: 16px; }
    .card { background: #ffffff; border-radius: 15px; padding: 12px; margin: 6px 0; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: 1px solid #e2e8f0; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; color: #64748b; font-size: 14px; }
    .form-group input { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; background: #f8fafc; color: #1e293b; font-size: 16px; }
    .form-group input::placeholder { color: #94a3b8; }
    .form-group input:focus { outline: none; border-color: #f39c12; background: #fff; }
    .btn { width: 100%; padding: 10px; border: none; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #E31937, #C62828); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(227,25,55,0.3); }
    .btn-secondary { background: #f0f2f5; color: #1e293b; margin-top: 6px; border: 1px solid #e2e8f0; }
    .btn-secondary:hover { background: #e2e8f0; }
    .level-card { background: #ffffff; border-radius: 12px; padding: 15px 18px; margin: 8px 0; cursor: pointer; transition: all 0.3s; display: flex; justify-content: space-between; align-items: center; }
    .level-card:hover { background: #f8fafc; transform: translateX(5px); border-color: #f39c12; }
    .level-info h3 { font-size: 18px; margin-bottom: 5px; }
    .level-icon { font-size: 30px; }
    .progress-bar { height: 8px; background: #e2e8f0; border-radius: 4px; margin-top: 10px; overflow: hidden; }
    .progress-fill { height: 100%; background: #f39c12; border-radius: 4px; transition: width 0.5s; }
    .progress-text { font-size: 12px; color: #64748b; margin-top: 5px; }
    .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .question-count { background: #e2e8f0; padding: 8px 15px; border-radius: 20px; font-size: 14px; color: #1e293b; }
    .question-category { background: #f39c12; padding: 5px 12px; border-radius: 15px; font-size: 12px; color: #000; }
    .question-text { font-size: 20px; line-height: 1.5; margin-bottom: 25px; padding: 20px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; }
    .options { display: flex; flex-direction: column; gap: 12px; }
    .option { padding: 18px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 15px; }
    .option:hover:not(.disabled) { background: #fff; border-color: #f39c12; }
    .option.correct { background: rgba(39,174,96,0.3); border-color: #27ae60; }
    .option.incorrect { background: rgba(231,76,60,0.3); border-color: #e74c3c; }
    .option.disabled { cursor: not-allowed; opacity: 0.7; }
    .option-letter { width: 35px; height: 35px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
    .option.correct .option-letter { background: #27ae60; }
    .option.incorrect .option-letter { background: #e74c3c; }
    .feedback { margin-top: 20px; padding: 15px; border-radius: 12px; display: none; }
    .feedback.show { display: block; }
    .feedback.correct { background: rgba(39,174,96,0.2); border: 1px solid #27ae60; }
    .feedback.incorrect { background: rgba(231,76,60,0.2); border: 1px solid #e74c3c; }
    .results { text-align: center; }
    .score-circle { width: 180px; height: 180px; margin: 30px auto; position: relative; }
    .score-circle svg { transform: rotate(-90deg); }
    .score-bg { fill: none; stroke: #e2e8f0; stroke-width: 12; }
    .score-fill { fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 1s ease-out; }
    .score-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
    .score-value { font-size: 48px; font-weight: bold; }
    .score-label { font-size: 14px; color: #64748b; }
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 25px 0; }
    .stat { background: #f8fafc; padding: 20px 10px; border-radius: 12px; text-align: center; }
    .stat-value { font-size: 28px; font-weight: bold; }
    .stat-label { font-size: 12px; color: #64748b; margin-top: 5px; }
    .stat.correct .stat-value { color: #27ae60; }
    .stat.incorrect .stat-value { color: #e74c3c; }
    .stat.time .stat-value { color: #3498db; }
    .greeting { font-size: 18px; color: #f39c12; margin-bottom: 5px; }
    .back-btn { background: #e2e8f0; border: none; color: #1e293b; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; }
    .back-btn:hover { background: #cbd5e1; }
    .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    /* Study Sections Styles */
    .study-category-card { background: #ffffff; border-radius: 15px; padding: 20px; margin: 12px 0; cursor: pointer; transition: all 0.3s; display: flex; justify-content: space-between; align-items: center; }
    .study-category-card:hover { background: #f8fafc; transform: translateX(5px); }
    .study-category-info h3 { font-size: 18px; margin-bottom: 5px; }
    .study-category-info p { font-size: 14px; color: #64748b; }
    .study-category-icon { font-size: 30px; }
    .study-question-card { background: #f8fafc; border-radius: 12px; padding: 20px; margin: 15px 0; border-left: 4px solid #f39c12; }
    .study-question-text { font-size: 18px; line-height: 1.5; margin-bottom: 15px; color: #1e293b; }
    .study-options { margin-bottom: 15px; }
    .study-option { padding: 12px 15px; margin: 8px 0; background: #ffffff; border-radius: 8px; display: flex; align-items: center; gap: 12px; }
    .study-option.correct-answer { background: rgba(39,174,96,0.2); border: 1px solid #27ae60; }
    .study-option-letter { width: 28px; height: 28px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; flex-shrink: 0; }
    .study-option.correct-answer .study-option-letter { background: #27ae60; }
    .study-explanation { background: #fff8e7; border-radius: 8px; padding: 15px; margin-top: 10px; border-left: 3px solid #f39c12; }
    .study-explanation-title { font-weight: bold; color: #f39c12; margin-bottom: 5px; font-size: 14px; }
    .study-explanation-text { color: #64748b; font-size: 14px; line-height: 1.5; }
    .study-question-number { background: #f39c12; color: #000; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; display: inline-block; margin-bottom: 10px; }
    .study-level-tabs { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
    .study-level-tab { padding: 10px 20px; background: #e2e8f0; border: none; border-radius: 20px; color: #1e293b; cursor: pointer; transition: all 0.3s; font-size: 14px; }
    .study-level-tab:hover { background: #cbd5e1; }
    .study-level-tab.active { background: #f39c12; color: #000; }
    .study-back-nav { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
    .study-breadcrumb { color: #64748b; font-size: 14px; }
    /* Video Lesson Styles */
    .video-lesson-card { background: #ffffff; border-radius: 15px; padding: 20px; margin: 12px 0; cursor: pointer; transition: all 0.3s; display: flex; justify-content: space-between; align-items: center; }
    .video-lesson-card:hover { background: #f8fafc; transform: translateX(5px); }
    .video-lesson-info h3 { font-size: 18px; margin-bottom: 5px; }
    .video-lesson-info p { font-size: 14px; color: #64748b; }
    .video-lesson-icon { font-size: 30px; }
    .video-lesson-progress { margin-top: 8px; }
    .video-progress-bar { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; }
    .video-progress-fill { height: 100%; background: #27ae60; border-radius: 3px; transition: width 0.3s; }
    .video-progress-text { font-size: 11px; color: #64748b; margin-top: 4px; }
    .video-player-container { background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 20px; position: relative; }
    .video-player-container video { width: 100%; display: block; }
    .video-player-container iframe { width: 100%; aspect-ratio: 16/9; border: none; display: block; }
    .video-info { margin-bottom: 20px; }
    .video-title { font-size: 20px; margin-bottom: 8px; }
    .video-description { color: #64748b; font-size: 14px; line-height: 1.5; }
    .video-controls { display: flex; flex-direction: column; gap: 10px; }
    .video-status { display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8fafc; border-radius: 12px; margin-bottom: 15px; }
    .video-status-icon { font-size: 24px; }
    .video-status-text { flex: 1; }
    .video-status-title { font-weight: bold; }
    .video-status-detail { font-size: 12px; color: #64748b; }
    .video-completed-badge { background: rgba(39,174,96,0.2); border: 1px solid #27ae60; }
    .video-in-progress-badge { background: rgba(243,156,18,0.2); border: 1px solid #f39c12; }
    .btn-video-primary { background: linear-gradient(135deg, #27ae60, #2ecc71); }
    .btn-video-primary:hover { box-shadow: 0 10px 30px rgba(39,174,96,0.3); }
    .btn-video-completed { background: rgba(39,174,96,0.3); border: 2px solid #27ae60; cursor: default; }
    .btn-video-secondary { background: #f0f2f5; border: 1px solid #e2e8f0; color: #1e293b; }
    .btn-video-secondary:hover { background: #e2e8f0; }
    .video-lesson-completed { border-left: 4px solid #27ae60; }
    /* YouTube Video Integration Styles */
    .video-level-tabs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; justify-content: center; }
    .video-level-tab { padding: 10px 16px; background: #e2e8f0; border: none; border-radius: 20px; color: #1e293b; cursor: pointer; transition: all 0.3s; font-size: 13px; }
    .video-level-tab:hover { background: #cbd5e1; }
    .video-level-tab.active { background: #f39c12; color: #000; font-weight: bold; }
    .video-progress-summary { display: flex; justify-content: space-between; padding: 12px 15px; background: #f8fafc; border-radius: 10px; margin-bottom: 15px; font-size: 14px; }
    .video-category-section { margin-bottom: 20px; }
    .video-category-header { background: rgba(243,156,18,0.2); padding: 12px 15px; border-radius: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
    .video-category-header h3 { font-size: 16px; color: #f39c12; margin: 0; }
    .video-card { background: #ffffff; border-radius: 12px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s; display: flex; gap: 12px; align-items: center; }
    .video-card:hover { background: #f8fafc; transform: translateX(5px); }
    .video-thumbnail { width: 120px; height: 68px; border-radius: 8px; object-fit: cover; flex-shrink: 0; background: rgba(0,0,0,0.3); }
    .video-card-info { flex: 1; min-width: 0; }
    .video-card-info h4 { font-size: 14px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .video-card-info p { font-size: 12px; color: #64748b; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .video-card-meta { font-size: 11px; color: #888; display: flex; gap: 10px; }
    .video-card.completed { border-left: 3px solid #27ae60; }
    .video-card.in-progress { border-left: 3px solid #f39c12; }
    .youtube-embed { width: 100%; aspect-ratio: 16/9; border: none; border-radius: 12px; }
    .video-lesson-in-progress { border-left: 4px solid #f39c12; }
    /* Certificates Styles */
    .cert-qr-code { margin: 8px auto 0; }
    .cert-qr-code svg { display: block; margin: 0 auto; }
    .share-cert-btns { display: flex; gap: 8px; justify-content: center; margin-top: 12px; flex-wrap: wrap; }
    .share-cert-btn { padding: 8px 14px; border: none; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; gap: 5px; }
    .share-cert-btn.whatsapp { background: #25D366; }
    .share-cert-btn.facebook { background: #1877F2; }
    .share-cert-btn.twitter { background: #1DA1F2; }
    .share-cert-btn.linkedin { background: #0A66C2; }
    .share-cert-btn.copy-link { background: #64748b; }
    .cert-congrats-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.92); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px; animation: fadeIn 0.3s; }
    @keyframes confettiFall { 0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
    .confetti-piece { position: fixed; width: 10px; height: 10px; top: -10px; animation: confettiFall 3s ease-in forwards; z-index: 10000; }

    /* Onboarding Styles */
    .onboarding-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 9998; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .onboarding-card { background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 20px; padding: 30px; max-width: 420px; width: 100%; text-align: center; border: 2px solid #f39c12; max-height: 90vh; overflow-y: auto; }
    .onboarding-step { display: none; }
    .onboarding-step.active { display: block; }
    .onboarding-dots { display: flex; justify-content: center; gap: 8px; margin: 20px 0 15px; }
    .onboarding-dot { width: 10px; height: 10px; border-radius: 50%; background: rgba(255,255,255,0.2); transition: all 0.3s; }
    .onboarding-dot.active { background: #f39c12; transform: scale(1.3); }
    .onboarding-dot.completed { background: #27ae60; }
    .certificates-header { text-align: center; padding: 20px 0; }
    .certificate-card { background: #ffffff; border-radius: 15px; padding: 25px; margin: 15px 0; border: 2px solid rgba(255,215,0,0.3); position: relative; overflow: hidden; }
    .certificate-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #f39c12, #ffd700, #f39c12); }
    .certificate-badge { width: 70px; height: 70px; background: linear-gradient(135deg, #ffd700, #f39c12); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 35px; margin: 0 auto 15px; box-shadow: 0 4px 15px rgba(243,156,18,0.4); }
    .certificate-level { font-size: 22px; font-weight: bold; color: #ffd700; margin-bottom: 5px; text-align: center; }
    .certificate-title { font-size: 14px; color: #64748b; text-align: center; margin-bottom: 15px; }
    .certificate-details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .certificate-detail { background: #f8fafc; padding: 12px; border-radius: 8px; text-align: center; }
    .certificate-detail-label { font-size: 11px; color: #64748b; margin-bottom: 3px; }
    .certificate-detail-value { font-size: 16px; font-weight: bold; color: #1e293b; }
    .certificate-id { font-size: 10px; color: #94a3b8; text-align: center; margin-top: 15px; font-family: monospace; }
    .btn-print-cert { margin-top: 15px; background: linear-gradient(135deg, #3498db, #2980b9); font-size: 14px; padding: 12px; }
    .btn-print-cert:hover { background: linear-gradient(135deg, #2980b9, #1f6dad); }
    
    /* Print Certificate Styles */
    @media print {
      body * { visibility: hidden; }
      #printableCertificate, #printableCertificate * { visibility: visible; }
      #printableCertificate { position: absolute; left: 0; top: 0; width: 100%; }
    }
    
    .printable-certificate {
      display: none;
      width: 800px;
      min-height: 600px;
      margin: 0 auto;
      background: white;
      padding: 40px;
      font-family: 'Georgia', serif;
      color: #333;
      position: relative;
      border: 15px solid #1565C0;
      box-shadow: inset 0 0 0 5px #E31937, inset 0 0 0 10px #FFD700;
    }
    
    .cert-header { text-align: center; margin-bottom: 30px; }
    .cert-logo { max-width: 200px; height: auto; margin-bottom: 15px; }
    .cert-school-name { font-size: 28px; font-weight: bold; color: #1565C0; margin: 10px 0; letter-spacing: 2px; }
    .cert-subtitle { font-size: 14px; color: #666; letter-spacing: 1px; }
    
    .cert-body { text-align: center; margin: 30px 0; }
    .cert-title { font-size: 36px; color: #E31937; font-weight: bold; margin-bottom: 20px; letter-spacing: 3px; }
    .cert-level-badge { display: inline-block; background: linear-gradient(135deg, #FFD700, #FFA500); color: #333; padding: 10px 30px; border-radius: 25px; font-size: 20px; font-weight: bold; margin-bottom: 25px; }
    .cert-recipient { font-size: 16px; color: #666; margin-bottom: 10px; }
    .cert-recipient-name { font-size: 32px; color: #1565C0; font-weight: bold; border-bottom: 2px solid #1565C0; display: inline-block; padding-bottom: 5px; margin-bottom: 20px; }
    .cert-description { font-size: 14px; color: #555; line-height: 1.6; max-width: 600px; margin: 0 auto 25px; }
    
    .cert-details { display: flex; justify-content: space-around; margin: 30px 0; padding: 20px; background: #f9f9f9; border-radius: 10px; }
    .cert-detail-item { text-align: center; }
    .cert-detail-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
    .cert-detail-value { font-size: 18px; color: #333; font-weight: bold; margin-top: 5px; }
    
    .cert-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; }
    .cert-signature { text-align: center; }
    .cert-signature-line { width: 200px; border-bottom: 1px solid #333; margin-bottom: 5px; }
    .cert-signature-name { font-size: 14px; font-weight: bold; }
    .cert-signature-title { font-size: 11px; color: #666; }
    .cert-qr { text-align: center; }
    .cert-id-text { font-size: 10px; color: #888; margin-top: 10px; font-family: monospace; }
    
    .cert-seal { position: absolute; bottom: 30px; right: 140px; width: 80px; height: 80px; border: 3px solid #FFD700; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,165,0,0.1)); }
    .cert-seal-text { font-size: 10px; text-align: center; color: #B8860B; font-weight: bold; text-transform: uppercase; }
    .no-certificates { text-align: center; padding: 40px 20px; }
    .no-certificates-icon { font-size: 60px; margin-bottom: 20px; opacity: 0.5; }
    .no-certificates-text { color: #64748b; font-size: 16px; line-height: 1.6; }
    .certificates-nav-btn { display: flex; align-items: center; justify-content: center; gap: 10px; background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(243,156,18,0.2)); border: 1px solid rgba(255,215,0,0.3); }
    .certificates-nav-btn:hover { background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(243,156,18,0.3)); }
    .certificate-earned-badge { position: absolute; top: 15px; right: 15px; background: #27ae60; color: white; padding: 5px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; }
    /* Mi Perfil Styles */
    .profile-section { border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; }
    .profile-section:last-of-type { border-bottom: none; }
    .profile-field { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f2f5; }
    .profile-field:last-child { border-bottom: none; }
    
    /* Avatar and Badge System */
    .profile-avatar-section { text-align: center; padding: 20px 0 30px; }
    .profile-avatar-container { position: relative; display: inline-block; }
    .profile-avatar { width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 60px; margin: 0 auto 15px; position: relative; box-shadow: 0 8px 32px rgba(0,0,0,0.15); border: 4px solid #e2e8f0; }
    .profile-avatar.nivel-nuevo { background: linear-gradient(135deg, #607D8B, #455A64); }
    .profile-avatar.nivel-principiante { background: linear-gradient(135deg, #4CAF50, #2E7D32); }
    .profile-avatar.nivel-intermedio { background: linear-gradient(135deg, #2196F3, #1565C0); }
    .profile-avatar.nivel-avanzado { background: linear-gradient(135deg, #9C27B0, #6A1B9A); }
    .profile-avatar.nivel-elite { background: linear-gradient(135deg, #FF9800, #E65100); }
    .profile-avatar.nivel-platino { background: linear-gradient(135deg, #FFD700, #FFA000); border-color: #FFD700; }
    .profile-badge { position: absolute; bottom: -5px; right: -5px; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 3px solid #e2e8f0; }
    .profile-badge.badge-nuevo { background: linear-gradient(135deg, #607D8B, #455A64); }
    .profile-badge.badge-principiante { background: linear-gradient(135deg, #4CAF50, #2E7D32); }
    .profile-badge.badge-intermedio { background: linear-gradient(135deg, #2196F3, #1565C0); }
    .profile-badge.badge-avanzado { background: linear-gradient(135deg, #9C27B0, #6A1B9A); }
    .profile-badge.badge-elite { background: linear-gradient(135deg, #FF9800, #E65100); }
    .profile-badge.badge-platino { background: linear-gradient(135deg, #FFD700, #FFA000); }
    .profile-level-title { font-size: 22px; font-weight: bold; margin-bottom: 5px; }
    .profile-level-title.titulo-nuevo { color: #90A4AE; }
    .profile-level-title.titulo-principiante { color: #81C784; }
    .profile-level-title.titulo-intermedio { color: #64B5F6; }
    .profile-level-title.titulo-avanzado { color: #BA68C8; }
    .profile-level-title.titulo-elite { color: #FFB74D; }
    .profile-level-title.titulo-platino { color: #FFD700; text-shadow: 0 0 10px rgba(255,215,0,0.5); }
    .profile-level-subtitle { color: #64748b; font-size: 14px; }
    .profile-progress-bar { width: 80%; max-width: 250px; height: 8px; background: #e2e8f0; border-radius: 4px; margin: 15px auto 5px; overflow: hidden; }
    .profile-progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
    .profile-progress-fill.progress-nuevo { background: #607D8B; }
    .profile-progress-fill.progress-principiante { background: linear-gradient(90deg, #4CAF50, #81C784); }
    .profile-progress-fill.progress-intermedio { background: linear-gradient(90deg, #2196F3, #64B5F6); }
    .profile-progress-fill.progress-avanzado { background: linear-gradient(90deg, #9C27B0, #BA68C8); }
    .profile-progress-fill.progress-elite { background: linear-gradient(90deg, #FF9800, #FFB74D); }
    .profile-progress-fill.progress-platino { background: linear-gradient(90deg, #FFD700, #FFEB3B); }
    .profile-progress-text { color: #64748b; font-size: 12px; }
    .profile-badges-earned { display: flex; justify-content: center; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    .mini-badge { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; opacity: 0.3; transition: all 0.3s; }
    .mini-badge.earned { opacity: 1; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transform: scale(1.1); }
    .mini-badge.badge-principiante { background: linear-gradient(135deg, #4CAF50, #2E7D32); }
    .mini-badge.badge-intermedio { background: linear-gradient(135deg, #2196F3, #1565C0); }
    .mini-badge.badge-avanzado { background: linear-gradient(135deg, #9C27B0, #6A1B9A); }
    .mini-badge.badge-elite { background: linear-gradient(135deg, #FF9800, #E65100); }
    .mini-badge.badge-platino { background: linear-gradient(135deg, #FFD700, #FFA000); }
    .profile-label { color: #64748b; font-size: 14px; }
    .profile-value { color: #1e293b; font-size: 14px; font-weight: 500; text-align: right; max-width: 60%; word-break: break-word; }
    .technician-number-card { background: linear-gradient(135deg, rgba(243,156,18,0.2) 0%, rgba(230,126,34,0.2) 100%); border: 2px solid rgba(243,156,18,0.5); border-radius: 15px; padding: 25px; text-align: center; margin-top: 10px; }
    .technician-number-value { font-size: 24px; font-weight: bold; color: #f39c12; font-family: monospace; letter-spacing: 2px; margin-bottom: 10px; word-break: break-all; }
    .technician-number-date { font-size: 12px; color: #64748b; }
    .profile-nav-btn { display: flex; align-items: center; justify-content: center; gap: 10px; background: linear-gradient(135deg, rgba(52,152,219,0.2), rgba(41,128,185,0.2)); border: 1px solid rgba(52,152,219,0.3); }
    .profile-nav-btn:hover { background: linear-gradient(135deg, rgba(52,152,219,0.3), rgba(41,128,185,0.3)); }
    /* Login Screen Styles */
    /* ========== MAINTENANCE BANNER ========== */
    .maintenance-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      z-index: 9999; display: flex; align-items: center; justify-content: center;
      padding: 20px;
    }
    .maintenance-card {
      background: #ffffff; border-radius: 20px; padding: 40px 30px;
      max-width: 420px; width: 100%; text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      position: relative; overflow: hidden;
      animation: maintSlideUp 0.6s ease;
    }
    @keyframes maintSlideUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .maintenance-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px;
      background: linear-gradient(90deg, #E31937, #f39c12, #E31937);
      background-size: 200% 100%;
      animation: maintShimmer 2s ease-in-out infinite;
    }
    @keyframes maintShimmer {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    .maint-icon {
      width: 80px; height: 80px; margin: 0 auto 20px;
      background: linear-gradient(135deg, #E31937, #f39c12);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 40px;
      animation: maintPulse 2s ease-in-out infinite;
      box-shadow: 0 8px 30px rgba(227, 25, 55, 0.3);
    }
    @keyframes maintPulse {
      0%, 100% { transform: scale(1); box-shadow: 0 8px 30px rgba(227,25,55,0.3); }
      50% { transform: scale(1.08); box-shadow: 0 12px 40px rgba(227,25,55,0.5); }
    }
    .maint-status {
      display: inline-flex; align-items: center; gap: 8px;
      background: rgba(227,25,55,0.1); border: 1px solid rgba(227,25,55,0.3);
      border-radius: 50px; padding: 6px 16px; margin-bottom: 16px;
      font-size: 11px; font-weight: 700; color: #E31937;
      text-transform: uppercase; letter-spacing: 1.5px;
    }
    .maint-dot {
      width: 8px; height: 8px; background: #E31937; border-radius: 50%;
      animation: maintBlink 1.2s ease-in-out infinite;
    }
    @keyframes maintBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
    .maintenance-card h2 {
      font-size: 24px; color: #1e293b; margin-bottom: 12px; line-height: 1.3;
    }
    .maintenance-card h2 span { color: #E31937; }
    .maintenance-card .maint-msg {
      font-size: 15px; color: #64748b; line-height: 1.7; margin-bottom: 24px;
    }
    .maintenance-card .maint-msg strong { color: #1e293b; }
    .maint-progress {
      margin-bottom: 20px;
    }
    .maint-progress-label {
      display: flex; justify-content: space-between;
      font-size: 11px; color: #94a3b8; font-weight: 600; margin-bottom: 6px;
    }
    .maint-progress-bar {
      height: 6px; background: #e2e8f0; border-radius: 50px; overflow: hidden;
    }
    .maint-progress-fill {
      height: 100%; width: 30%;
      background: linear-gradient(90deg, #E31937, #f39c12);
      border-radius: 50px;
      animation: maintProgress 3s ease-in-out infinite;
    }
    @keyframes maintProgress {
      0% { width: 20%; } 50% { width: 60%; } 100% { width: 20%; }
    }
    .maint-gears {
      display: flex; justify-content: center; gap: 2px; margin-bottom: 8px;
    }
    .maint-gear { font-size: 22px; display: inline-block; }
    .maint-gear-1 { animation: spin 3s linear infinite; }
    .maint-gear-2 { animation: spin 3s linear infinite reverse; margin-top: 6px; font-size: 18px; }
    @keyframes spin { from { transform: rotate(0); } to { transform: rotate(360deg); } }
    .maint-footer {
      font-size: 11px; color: #94a3b8; padding-top: 16px;
      border-top: 1px solid #e2e8f0;
    }
    .maint-footer strong { color: #64748b; }
    .maint-brand {
      font-size: 12px; color: #94a3b8; letter-spacing: 2px;
      text-transform: uppercase; margin-bottom: 4px; font-weight: 600;
    }
    /* ========== END MAINTENANCE ========== */

    /* FLOATING HOME BUTTON */
    .home-fab{position:fixed;top:16px;right:16px;z-index:800;width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#1a1a2e,#16213e);border:2px solid rgba(243,156,18,0.4);color:#f39c12;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(0,0,0,0.3);transition:all 0.3s}
    .home-fab:hover{transform:scale(1.1);border-color:#f39c12;box-shadow:0 4px 20px rgba(243,156,18,0.3)}

    /* AI PAYWALL MODAL */
    .paywall-overlay{position:fixed;inset:0;z-index:10000;background:rgba(10,10,20,0.92);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;padding:20px}
    .paywall-overlay.active{display:flex}
    .paywall-card{background:#fff;border-radius:20px;max-width:400px;width:100%;padding:36px 28px;text-align:center;position:relative;overflow:hidden;animation:pwSlide 0.4s ease}
    @keyframes pwSlide{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    .paywall-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#E31937,#f39c12)}
    .pw-icon{font-size:50px;margin-bottom:12px}
    .pw-title{font-size:22px;font-weight:800;color:#1e293b;margin-bottom:6px}
    .pw-subtitle{font-size:14px;color:#64748b;margin-bottom:20px}
    .pw-features{text-align:left;margin-bottom:24px}
    .pw-feature{display:flex;align-items:center;gap:10px;padding:8px 0;font-size:14px;color:#334155}
    .pw-feature span{color:#27ae60;font-size:16px}
    .pw-price{font-size:32px;font-weight:800;color:#E31937;margin-bottom:4px}
    .pw-period{font-size:13px;color:#94a3b8;margin-bottom:20px}
    .pw-btn{width:100%;padding:16px;border:none;border-radius:12px;background:linear-gradient(135deg,#E31937,#C62828);color:#fff;font-size:17px;font-weight:700;cursor:pointer;transition:all 0.2s}
    .pw-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(227,25,55,0.3)}
    .pw-close{margin-top:14px;background:none;border:none;color:#94a3b8;font-size:14px;cursor:pointer;padding:8px}
    .pw-close:hover{color:#64748b}

    /* AI CHARACTER COUNTER */
    .ai-chars-banner{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:799;background:rgba(26,26,46,0.95);border:1px solid rgba(243,156,18,0.3);border-radius:50px;padding:6px 16px;font-size:12px;color:#f39c12;font-weight:600;display:none;align-items:center;gap:6px;box-shadow:0 4px 15px rgba(0,0,0,0.3);white-space:nowrap}
    .ai-chars-banner.show{display:inline-flex}

    .login-error { color: #e74c3c; background: rgba(231,76,60,0.2); padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center; display: none; }
    .login-error.show { display: block; }
    .form-group input[type="password"] { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; background: #f8fafc; color: #1e293b; font-size: 16px; }
    /* Admin Section Styles */
    .admin-link { color: #f39c12; text-decoration: underline; cursor: pointer; font-size: 14px; margin-top: 15px; display: inline-block; }
    .admin-link:hover { color: #ffd700; }
    .admin-container { max-width: 1400px !important; width:100% !important; margin:0 auto; padding:15px 25px !important; min-height:100vh; }
    /* When admin dashboard is active, expand the parent container */
    #adminDashboardScreen.active { position:fixed; top:0; left:0; right:0; bottom:0; z-index:400; overflow-y:auto; background:linear-gradient(135deg,#fef9f0,#fff7ed); width:100vw !important; max-width:100vw !important; padding:0; }
    #adminTechnicianProfileScreen.active { position:fixed; top:0; left:0; right:0; bottom:0; z-index:400; overflow-y:auto; background:linear-gradient(135deg,#fef9f0,#fff7ed); width:100vw !important; max-width:100vw !important; padding:0; }
    .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
    .admin-title { display: flex; align-items: center; gap: 10px; }
    .admin-title h1 { font-size: 24px; margin: 0; }
    .admin-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
    .admin-stat-card { background: #f8fafc; border-radius: 12px; padding: 20px; text-align: center; transition: transform 0.2s, background 0.2s; }
    .admin-stat-card:hover { background: #ffffff; transform: translateY(-2px); }
    .admin-stat-value { font-size: 32px; font-weight: bold; color: #f39c12; }
    .admin-stat-label { font-size: 12px; color: #64748b; margin-top: 5px; }
    .admin-section { background: #f8fafc; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
    .admin-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: #1e293b; }
    .admin-section-title { font-size: 15px; font-weight: 700; color: #1e293b; letter-spacing:0.3px; }
    .admin-nav-btn { background:#ffffff;border:1px solid #e2e8f0;color:#64748b;padding:6px 12px;border-radius:8px;font-size:10px;cursor:pointer;transition:all 0.2s;font-weight:500; }
    .admin-nav-btn:hover { background:#f39c12;color:#ffffff;border-color:#f39c12;box-shadow:0 2px 8px rgba(243,156,18,0.3); }
    /* Admin 2-column layout for wide screens */
    .admin-grid-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .admin-grid-full { grid-column: 1 / -1; }
    /* Force landscape message on mobile portrait */
    .admin-landscape-msg { display:none; text-align:center; padding:60px 20px; }
    .admin-landscape-msg .icon { font-size:60px; margin-bottom:15px; }
    .admin-landscape-msg p { color:#64748b; font-size:16px; line-height:1.6; }
    .admin-main-content { display:block; }
    @media (max-width: 768px) and (orientation: portrait) {
      .admin-landscape-msg { display:block; }
      .admin-main-content { display:none; }
    }
    @media (max-width: 900px) {
      .admin-grid-2col { grid-template-columns: 1fr; }
      .admin-stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
    .technician-list { max-height: 400px; overflow-y: auto; }
    .technician-card { background: #ffffff; border-radius: 10px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s; border-left: 4px solid #3498db; }
    .technician-card:hover { background: #f8fafc; transform: translateX(5px); }
    .technician-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .technician-name { font-size: 16px; font-weight: bold; color: #1e293b; }
    .technician-id { font-size: 11px; color: #64748b; font-family: monospace; }
    .technician-meta { display: flex; gap: 15px; flex-wrap: wrap; font-size: 12px; color: #64748b; }
    .technician-meta-item { display: flex; align-items: center; gap: 5px; }
    .admin-filter-bar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .admin-filter-input { padding: 10px 15px; border: 1px solid #d1d5db; border-radius: 8px; background: #ffffff; color: #1e293b; font-size: 14px; flex: 1; min-width: 200px; }
    .admin-filter-input::placeholder { color: #94a3b8; }
    .admin-filter-select { padding: 10px 15px; border: 1px solid #d1d5db; border-radius: 8px; background: #ffffff; color: #1e293b; font-size: 14px; cursor: pointer; }
    .admin-filter-select option { background: #ffffff; color: #1e293b; }
    /* Admin Profile Detail */
    .admin-profile-card { background: #ffffff; border-radius: 15px; padding: 25px; margin-bottom: 20px; }
    .admin-profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e2e8f0; }
    .admin-profile-avatar { width: 80px; height: 80px; background: linear-gradient(135deg, #f39c12, #e67e22); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 36px; }
    .admin-profile-info h2 { margin: 0 0 5px 0; font-size: 22px; }
    .admin-profile-info p { margin: 0; color: #64748b; font-size: 14px; }
    .admin-profile-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .admin-detail-item { background: #f8fafc; padding: 12px; border-radius: 8px; }
    .admin-detail-label { font-size: 11px; color: #64748b; margin-bottom: 3px; text-transform: uppercase; }
    .admin-detail-value { font-size: 14px; color: #1e293b; font-weight: 500; }
    /* Progress Timeline */
    .progress-timeline { margin-top: 20px; }
    .timeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .timeline-tabs { display: flex; gap: 8px; }
    .timeline-tab { padding: 8px 16px; border: none; border-radius: 20px; background: #e2e8f0; color: #1e293b; cursor: pointer; font-size: 13px; transition: all 0.3s; }
    .timeline-tab:hover { background: #cbd5e1; }
    .timeline-tab.active { background: #f39c12; color: #000; }
    .timeline-content { background: #f8fafc; border-radius: 12px; padding: 20px; }
    .timeline-entry { display: flex; gap: 15px; padding: 15px 0; border-bottom: 1px solid #e2e8f0; }
    .timeline-entry:last-child { border-bottom: none; }
    .timeline-date { min-width: 100px; color: #64748b; font-size: 13px; }
    .timeline-event { flex: 1; }
    .timeline-event-title { font-weight: bold; color: #1e293b; margin-bottom: 3px; }
    .timeline-event-detail { font-size: 13px; color: #64748b; }
    .timeline-empty { text-align: center; padding: 30px; color: #64748b; }
    /* Admin Charts */
    .admin-chart { background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
    .admin-chart-title { font-size: 14px; color: #64748b; margin-bottom: 15px; }
    .admin-bar-chart { display: flex; flex-direction: column; gap: 10px; }
    .admin-bar-item { display: flex; align-items: center; gap: 10px; }
    .admin-bar-label { min-width: 100px; font-size: 13px; color: #1e293b; }
    .admin-bar-container { flex: 1; height: 24px; background: #e2e8f0; border-radius: 12px; overflow: hidden; }
    .admin-bar-fill { height: 100%; border-radius: 12px; transition: width 0.5s; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 11px; color: white; font-weight: bold; }
    .no-data-message { text-align: center; padding: 40px 20px; color: #64748b; }
    .no-data-icon { font-size: 50px; margin-bottom: 15px; opacity: 0.5; }
    /* Lock System Styles */
    .level-card.locked { opacity: 0.6; cursor: not-allowed; position: relative; border: 2px solid #fecaca; }
    .level-card.locked:hover { transform: none; background: #fff; }
    .cert-card, .membership-card { background: #ffffff; border-radius:12px; padding:10px 6px; text-align:center; cursor:pointer; transition: all 0.3s; border: 1px solid #e2e8f0; position:relative; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
    .cert-card:hover, .membership-card:hover { transform: translateY(-2px); background: #f8fafc; border-color: #f39c12; }
    .cert-icon { font-size:28px; margin-bottom:4px; }
    .cert-name { color:#1e293b; font-size:11px; font-weight:bold; line-height:1.2; margin-bottom:3px; }
    .cert-price { color:#f39c12; font-size:11px; font-weight:bold; }
    .cert-lock { position:absolute; top:4px; right:4px; font-size:10px; opacity:0.7; }
    .membership-card.bronze { border-color: rgba(205,127,50,0.5); background: linear-gradient(135deg, rgba(205,127,50,0.15), rgba(139,90,43,0.15)); }
    .membership-card.silver { border-color: rgba(192,192,192,0.5); background: linear-gradient(135deg, rgba(192,192,192,0.15), rgba(150,150,150,0.15)); }
    .membership-card.gold { border-color: rgba(255,215,0,0.5); background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(218,165,32,0.15)); }
    .level-locked-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); border-radius: 15px; display: flex; align-items: center; justify-content: center; }
    .level-locked-icon { font-size: 40px; }
    .matrix-unlock-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .matrix-unlock-content { background: linear-gradient(135deg, #1a5276 0%, #154360 100%); border-radius: 20px; padding: 30px; max-width: 400px; width: 90%; text-align: center; border: 2px solid #f39c12; }
    .matrix-unlock-content h3 { color: #f39c12; margin-bottom: 20px; font-size: 20px; }
    .matrix-unlock-content p { color: #64748b; margin-bottom: 20px; font-size: 14px; }
    .matrix-unlock-input { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; background: #f8fafc; color: #1e293b; font-size: 16px; text-align: center; letter-spacing: 2px; font-family: monospace; margin-bottom: 15px; }
    .matrix-unlock-input:focus { outline: none; border-color: #f39c12; }
    .matrix-unlock-input::placeholder { color: #94a3b8; letter-spacing: normal; }
    .matrix-unlock-error { color: #e74c3c; background: rgba(231,76,60,0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; font-size: 14px; }
    .matrix-unlock-error.show { display: block; }
    .matrix-unlock-buttons { display: flex; gap: 10px; }
    .matrix-unlock-buttons .btn { flex: 1; padding: 15px; font-size: 14px; }
    .admin-lock-section { background: rgba(231,76,60,0.1); border: 1px solid rgba(231,76,60,0.3); border-radius: 12px; padding: 20px; margin-top: 20px; }
    .admin-lock-title { color: #e74c3c; font-size: 16px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .admin-lock-status { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e2e8f0; }
    .admin-lock-status:last-child { border-bottom: none; }
    .admin-lock-toggle { padding: 8px 16px; border-radius: 20px; border: none; cursor: pointer; font-size: 12px; font-weight: bold; transition: all 0.3s; }
    .admin-lock-toggle.locked { background: #e74c3c; color: white; }
    .admin-lock-toggle.unlocked { background: #27ae60; color: white; }
    .matrix-id-display { font-family: monospace; background: rgba(243,156,18,0.2); padding: 5px 10px; border-radius: 5px; color: #f39c12; font-size: 12px; }
    .admin-lock-disabled-notice { background: rgba(243,156,18,0.1); border: 1px solid rgba(243,156,18,0.3); border-radius: 8px; padding: 15px; margin-top: 15px; color: #f39c12; font-size: 13px; text-align: center; }
  </style>
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- OFFLINE / CONNECTION BANNER -->
<div id="offlineBanner" style="display:none;position:fixed;top:0;left:0;right:0;z-index:9999;background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff;text-align:center;padding:10px 15px;font-size:14px;font-weight:bold;box-shadow:0 2px 10px rgba(0,0,0,0.3);">
  <span id="offlineBannerText">üì° Sin conexi√≥n a internet ‚Äî Algunas funciones no estar√°n disponibles</span>
  <button onclick="location.reload()" style="margin-left:10px;padding:4px 12px;background:rgba(255,255,255,0.25);color:#fff;border:1px solid rgba(255,255,255,0.5);border-radius:6px;cursor:pointer;font-size:12px;">üîÑ Reintentar</button>
</div>
<!-- SUPABASE LOAD FAILED BANNER -->
<div id="supabaseFailBanner" style="display:none;position:fixed;top:0;left:0;right:0;z-index:9998;background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff;text-align:center;padding:10px 15px;font-size:13px;font-weight:600;box-shadow:0 2px 10px rgba(0,0,0,0.3);">
  ‚ö†Ô∏è Problemas de conexi√≥n con el servidor. <button onclick="location.reload()" style="margin-left:8px;padding:4px 12px;background:rgba(255,255,255,0.3);color:#fff;border:1px solid rgba(255,255,255,0.5);border-radius:6px;cursor:pointer;font-size:12px;">üîÑ Recargar</button>
</div>
<script>
// Global offline/online detection
(function(){
  function showOffline() { document.getElementById('offlineBanner').style.display = 'block'; }
  function hideOffline() { document.getElementById('offlineBanner').style.display = 'none'; }
  window.addEventListener('offline', showOffline);
  window.addEventListener('online', function() { hideOffline(); });
  if (!navigator.onLine) showOffline();
  // Check if Supabase loaded
  setTimeout(function() {
    if (!window.supabase) {
      document.getElementById('supabaseFailBanner').style.display = 'block';
      console.error('[MaestroAC] Supabase library failed to load!');
    }
  }, 5000);
})();
</script>
<style id="wow-theme">
/* WOW THEME - Vibrant overrides */
body { background: linear-gradient(180deg, #f0f4ff 0%, #faf8ff 50%, #f0f4ff 100%) !important; }
.card { box-shadow: 0 4px 24px rgba(99,102,241,0.10), 0 1px 4px rgba(0,0,0,0.05) !important; border: 1px solid rgba(99,102,241,0.08) !important; border-radius: 20px !important; }
.form-group input:focus { border-color: #6366f1 !important; box-shadow: 0 0 0 4px rgba(99,102,241,0.15) !important; }
.btn { border-radius: 14px !important; font-weight: 700 !important; transition: all 0.3s !important; }
.btn-primary { box-shadow: 0 4px 15px rgba(227,25,55,0.35) !important; }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(227,25,55,0.45) !important; }
.btn-secondary { border: 2px solid #e0e7ff !important; }
.btn-secondary:hover { border-color: #6366f1 !important; box-shadow: 0 4px 16px rgba(99,102,241,0.15) !important; transform: translateY(-1px); }
.level-card { border: 2px solid #eef2ff !important; border-radius: 16px !important; box-shadow: 0 2px 12px rgba(99,102,241,0.08) !important; transition: all 0.3s !important; }
.level-card:hover { transform: translateX(5px) !important; border-color: #6366f1 !important; box-shadow: 0 4px 20px rgba(99,102,241,0.2) !important; }
.progress-fill { background: linear-gradient(90deg, #6366f1, #8b5cf6) !important; }
.progress-text { color: #6366f1 !important; font-weight: 600 !important; }
.question-number { background: linear-gradient(135deg, #6366f1, #8b5cf6) !important; color: white !important; box-shadow: 0 2px 10px rgba(99,102,241,0.3) !important; }
.question-text { background: linear-gradient(135deg, #fafbff, #f0f4ff) !important; border: 1px solid #e0e7ff !important; border-radius: 16px !important; }
.option { border: 2px solid #eef2ff !important; border-radius: 14px !important; transition: all 0.3s !important; }
.option:hover:not(.disabled) { border-color: #6366f1 !important; box-shadow: 0 4px 16px rgba(99,102,241,0.15) !important; transform: translateY(-2px); }
.option.correct { border-color: #10b981 !important; background: linear-gradient(135deg, #ecfdf5, #d1fae5) !important; box-shadow: 0 4px 16px rgba(16,185,129,0.2) !important; }
.option.incorrect { border-color: #ef4444 !important; background: linear-gradient(135deg, #fef2f2, #fee2e2) !important; }
.option-letter { background: linear-gradient(135deg, #eef2ff, #e0e7ff) !important; color: #6366f1 !important; font-weight: 700 !important; border-radius: 12px !important; }
.score-fill { filter: drop-shadow(0 0 6px rgba(99,102,241,0.4)) !important; }
.stat { background: linear-gradient(135deg, #fafbff, #f0f4ff) !important; border: 1px solid #e0e7ff !important; border-radius: 16px !important; }
.stat-value { color: #6366f1 !important; font-weight: 800 !important; }
.video-lesson-card, .video-card { border: 2px solid #eef2ff !important; border-radius: 16px !important; box-shadow: 0 2px 10px rgba(99,102,241,0.06) !important; transition: all 0.3s !important; }
.video-lesson-card:hover, .video-card:hover { border-color: #6366f1 !important; box-shadow: 0 4px 20px rgba(99,102,241,0.15) !important; transform: translateY(-2px) !important; }
.video-level-tab, .study-level-tab { border: 2px solid #eef2ff !important; border-radius: 25px !important; transition: all 0.3s !important; }
.video-level-tab:hover, .study-level-tab:hover { border-color: #6366f1 !important; color: #6366f1 !important; }
.video-level-tab.active, .study-level-tab.active { background: linear-gradient(135deg, #6366f1, #8b5cf6) !important; color: white !important; border-color: transparent !important; box-shadow: 0 4px 12px rgba(99,102,241,0.35) !important; }
.study-category-card { border: 2px solid #eef2ff !important; border-radius: 16px !important; box-shadow: 0 2px 10px rgba(99,102,241,0.06) !important; transition: all 0.3s !important; }
.study-category-card:hover { border-color: #6366f1 !important; box-shadow: 0 4px 20px rgba(99,102,241,0.15) !important; transform: translateY(-2px) !important; }
.specialty-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.2) !important; }
.specialty-card:active { transform: scale(0.96); }
.cert-card, .membership-card { border: 2px solid #eef2ff !important; border-radius: 16px !important; box-shadow: 0 2px 10px rgba(99,102,241,0.08) !important; transition: all 0.3s !important; }
.cert-card:hover, .membership-card:hover { transform: translateY(-3px) !important; border-color: #6366f1 !important; box-shadow: 0 8px 25px rgba(99,102,241,0.2) !important; }
.certificate-card { box-shadow: 0 4px 20px rgba(255,215,0,0.15) !important; border-radius: 20px !important; }
.certificate-earned-badge { background: linear-gradient(135deg, #10b981, #059669) !important; box-shadow: 0 2px 8px rgba(16,185,129,0.3) !important; }
.profile-avatar { box-shadow: 0 8px 30px rgba(99,102,241,0.2) !important; border: 4px solid #e0e7ff !important; }
.admin-stat-card { 
      background: #ffffff !important; 
      border: 1px solid #e2e8f0 !important; 
      border-radius: 12px !important; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.06) !important; 
      transition: all 0.2s !important;
      color: #1e293b !important;
    }
    .admin-stat-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important; }
.admin-stat-card:hover { transform: translateY(-3px) !important; box-shadow: 0 8px 25px rgba(99,102,241,0.15) !important; border-color: #6366f1 !important; }
.admin-section { 
      background: #ffffff !important; 
      border: 1px solid #e2e8f0 !important; 
      border-radius: 16px !important; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04) !important;
      padding: 20px !important;
    }
.technician-card { border-left: 4px solid #6366f1 !important; transition: all 0.3s !important; }
.technician-card:hover { box-shadow: 0 4px 16px rgba(99,102,241,0.12) !important; transform: translateX(5px) !important; }
.admin-lock-toggle.locked { background: linear-gradient(135deg, #ef4444, #dc2626) !important; box-shadow: 0 2px 8px rgba(239,68,68,0.3) !important; }
.admin-lock-toggle.unlocked { background: linear-gradient(135deg, #10b981, #059669) !important; box-shadow: 0 2px 8px rgba(16,185,129,0.3) !important; }
.timeline-tab.active { background: linear-gradient(135deg, #6366f1, #8b5cf6) !important; color: white !important; }

/* TEXT BRILLO */
h1, h2, h3, .level-info h3, .technician-name, .cert-name, .video-lesson-info h3, .study-category-info h3 { color: #000000 !important; font-weight: 800 !important; text-shadow: 0 1px 2px rgba(0,0,0,0.08) !important; }
.subtitle, .profile-level-subtitle, .study-breadcrumb, .certificate-title, .admin-chart-title, .video-progress-text, .progress-text, .timeline-date, .score-label { color: #4f46e5 !important; font-weight: 700 !important; }
.stat-value, .admin-stat-value { color: #4338ca !important; font-weight: 900 !important; text-shadow: 0 1px 3px rgba(67,56,202,0.15) !important; }
.btn-primary { background: linear-gradient(135deg, #E31937, #b91c1c) !important; text-shadow: 0 1px 2px rgba(0,0,0,0.2) !important; }
.option-text, .question-text, .profile-value, .admin-detail-value, .certificate-detail-value, .cert-detail-value, .admin-bar-label { color: #0f172a !important; font-weight: 600 !important; }
.profile-label, .certificate-detail-label, .cert-detail-label, .admin-detail-label, .stat-label, .admin-stat-label, .video-card-info p, .technician-meta, .technician-id { color: #475569 !important; }

/* PREMIUM BADGE ICONS - Metallic circles behind emojis */
.level-icon {
  font-size: 32px !important;
  width: 56px !important; height: 56px !important;
  display: flex !important; align-items: center !important; justify-content: center !important;
  border-radius: 50% !important;
  background: linear-gradient(145deg, #f8fafc, #e2e8f0) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.12), inset 0 2px 4px rgba(255,255,255,0.8), inset 0 -2px 4px rgba(0,0,0,0.06) !important;
  border: 2px solid rgba(0,0,0,0.08) !important;
  position: relative !important;
}
.level-icon::after {
  content: '' !important;
  position: absolute !important;
  top: 3px !important; left: 3px !important; right: 3px !important; bottom: 3px !important;
  border-radius: 50% !important;
  border: 1.5px solid rgba(255,255,255,0.6) !important;
  pointer-events: none !important;
}
.cert-icon {
  font-size: 32px !important;
  width: 52px !important; height: 52px !important;
  display: inline-flex !important; align-items: center !important; justify-content: center !important;
  border-radius: 50% !important;
  background: linear-gradient(145deg, #fffbeb, #fde68a) !important;
  box-shadow: 0 4px 12px rgba(245,158,11,0.25), inset 0 2px 4px rgba(255,255,255,0.8) !important;
  border: 2px solid rgba(245,158,11,0.3) !important;
}
.mini-badge {
  font-size: 16px !important;
  width: 32px !important; height: 32px !important;
  display: inline-flex !important; align-items: center !important; justify-content: center !important;
  border-radius: 50% !important;
  background: linear-gradient(145deg, #f8fafc, #e2e8f0) !important;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1), inset 0 1px 2px rgba(255,255,255,0.8) !important;
  border: 1.5px solid rgba(0,0,0,0.08) !important;
}

/* Per-level badge colors */
.badge-principiante, .level-card:nth-child(1) .level-icon { background: linear-gradient(145deg, #d1fae5, #6ee7b7) !important; border-color: rgba(16,185,129,0.3) !important; box-shadow: 0 4px 12px rgba(16,185,129,0.2), inset 0 2px 4px rgba(255,255,255,0.6) !important; }
.badge-intermedio, .level-card:nth-child(2) .level-icon { background: linear-gradient(145deg, #dbeafe, #93c5fd) !important; border-color: rgba(59,130,246,0.3) !important; box-shadow: 0 4px 12px rgba(59,130,246,0.2), inset 0 2px 4px rgba(255,255,255,0.6) !important; }
.badge-avanzado, .level-card:nth-child(3) .level-icon { background: linear-gradient(145deg, #fef3c7, #fcd34d) !important; border-color: rgba(245,158,11,0.3) !important; box-shadow: 0 4px 12px rgba(245,158,11,0.25), inset 0 2px 4px rgba(255,255,255,0.6) !important; }
.badge-elite, .level-card:nth-child(4) .level-icon { background: linear-gradient(145deg, #ede9fe, #c4b5fd) !important; border-color: rgba(139,92,246,0.3) !important; box-shadow: 0 4px 12px rgba(139,92,246,0.2), inset 0 2px 4px rgba(255,255,255,0.6) !important; }
.badge-platino, .level-card:nth-child(5) .level-icon { background: linear-gradient(145deg, #ccfbf1, #5eead4) !important; border-color: rgba(20,184,166,0.3) !important; box-shadow: 0 4px 12px rgba(20,184,166,0.2), inset 0 2px 4px rgba(255,255,255,0.6) !important; }

/* Study category icons */
.study-category-card .level-icon { width: 48px !important; height: 48px !important; font-size: 28px !important; }

/* CERT COURSE CARDS - Bigger, 3-column grid */
div[style*="grid-template-columns: repeat(4, 1fr)"] {
  grid-template-columns: repeat(3, 1fr) !important;
  gap: 12px !important;
}
.cert-card {
  padding: 16px 10px !important;
  border-radius: 16px !important;
  min-height: 110px !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
}
.cert-card .cert-icon {
  width: 60px !important; height: 60px !important;
  display: flex !important; align-items: center !important; justify-content: center !important;
  border-radius: 16px !important;
  background: linear-gradient(145deg, #f8fafc, #e2e8f0) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08), inset 0 2px 4px rgba(255,255,255,0.9) !important;
  margin-bottom: 8px !important;
  font-size: 32px !important;
}
.cert-card .cert-icon svg {
  width: 38px !important; height: 38px !important;
}
.cert-card .cert-name {
  font-size: 13px !important; font-weight: 700 !important; color: #0f172a !important;
  margin-bottom: 2px !important;
}
.cert-card .cert-price, .cert-card .cert-status {
  font-size: 11px !important; font-weight: 600 !important;
}
    /* ============================================ */
    /* SISTEMA DE ASISTENCIA */
    /* ============================================ */
    .attendance-card {
      background: #ffffff;
      border-radius: 15px;
      padding: 25px;
      margin: 15px 0;
      text-align: center;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
    }
    .attendance-timer {
      font-size: 48px;
      font-weight: bold;
      color: #E31937;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
    }
    .attendance-status {
      display: inline-block;
      padding: 8px 20px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 14px;
      margin: 10px 0;
    }
    .status-active { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
    .status-inactive { background: #fce4ec; color: #c62828; border: 1px solid #ef9a9a; }
    .btn-checkin {
      width: 100%;
      padding: 18px;
      border: none;
      border-radius: 12px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin: 10px 0;
    }
    .btn-checkin-in { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; box-shadow: 0 4px 15px rgba(46,204,113,0.3); }
    .btn-checkin-in:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(46,204,113,0.4); }
    .btn-checkin-out { background: linear-gradient(135deg, #E31937, #C62828); color: white; box-shadow: 0 4px 15px rgba(227,25,55,0.3); }
    .btn-checkin-out:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(227,25,55,0.4); }
    .attendance-type-selector { display: flex; gap: 10px; margin: 15px 0; }
    .type-option {
      flex: 1; padding: 12px; border-radius: 10px; border: 2px solid #e2e8f0;
      background: #f8fafc; color: #1e293b; cursor: pointer; text-align: center; transition: all 0.3s;
    }
    .type-option.selected { border-color: #E31937; background: #fce4ec; color: #E31937; font-weight: bold; }
    .attendance-history { margin-top: 20px; }
    .history-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 15px; background: #f8fafc; border-radius: 10px; margin: 8px 0; font-size: 14px; border: 1px solid #e2e8f0;
    }
    .history-date { color: #64748b; }
    .history-hours { color: #E31937; font-weight: bold; }
    .history-type { padding: 3px 10px; border-radius: 10px; font-size: 12px; }
    .type-presencial { background: #e8f5e9; color: #2e7d32; }
    .type-zoom { background: #e3f2fd; color: #1565c0; }
    .admin-attendance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin: 15px 0; }
    .admin-att-card { background: #ffffff; border-radius: 12px; padding: 15px; border-left: 4px solid #f39c12; border:1px solid #e2e8f0; }
    .admin-att-card h4 { margin: 0 0 5px 0; color: #f39c12; font-size: 13px; }
    .admin-att-stat { font-size: 28px; font-weight: bold; color: white; }
    .admin-att-label { font-size: 12px; color: #ccc; }
    .live-indicator { display: inline-block; width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; margin-right: 5px; animation: pulse-dot 1.5s infinite; }
    @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .attendance-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 13px; }
    .attendance-table th { background: rgba(243,156,18,0.2); padding: 10px 8px; text-align: left; color: #f39c12; border-bottom: 1px solid rgba(255,255,255,0.15); }
    .attendance-table td { padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,0.08); color: #ddd; }
    .attendance-table tr:hover td { background: rgba(255,255,255,0.05); }
    .attendance-summary-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
    .att-summary-card { background: #f8fafc; border-radius: 10px; padding: 15px; text-align: center; border: 1px solid #e2e8f0; }
    .att-summary-number { font-size: 24px; font-weight: bold; color: #E31937; }
    .att-summary-text { font-size: 11px; color: #64748b; margin-top: 5px; }
    .filter-bar { display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; }
    .filter-bar select { padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); color: white; font-size: 13px; }

/* ===== NOTIFICATION BELL SYSTEM ===== */
.notif-bell-container { position: fixed; top: 70px; right: 15px; z-index: 500; }
.notif-bell-btn { background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none; width: 48px; height: 48px; border-radius: 50%; font-size: 22px; cursor: pointer; position: relative; box-shadow: 0 4px 15px rgba(99,102,241,0.4); transition: transform 0.2s; display: flex; align-items: center; justify-content: center; }
.notif-bell-btn:hover { transform: scale(1.1); }
.notif-badge { position: absolute; top: -2px; right: -2px; background: #ef4444; color: white; font-size: 11px; font-weight: bold; min-width: 20px; height: 20px; border-radius: 10px; display: flex; align-items: center; justify-content: center; border: 2px solid white; }
.notif-badge.hidden { display: none; }
.notif-panel { position: fixed; top: 70px; right: 10px; width: 340px; max-width: calc(100vw - 20px); max-height: 70vh; background: linear-gradient(135deg, #1e293b, #0f172a); border: 1px solid rgba(99,102,241,0.3); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); overflow: hidden; display: none; z-index: 501; }
.notif-panel.open { display: block; }
.notif-panel-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 18px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.notif-panel-title { color: white; font-size: 16px; font-weight: bold; }
.notif-clear-btn { background: none; border: none; color: #64748b; font-size: 12px; cursor: pointer; padding: 5px 10px; border-radius: 8px; }
.notif-clear-btn:hover { background: rgba(255,255,255,0.1); color: #94a3b8; }
.notif-list { overflow-y: auto; max-height: calc(70vh - 55px); padding: 8px; }
.notif-item { display: flex; gap: 12px; padding: 12px; border-radius: 12px; margin-bottom: 4px; transition: background 0.2s; }
.notif-item:hover { background: rgba(255,255,255,0.05); }
.notif-item.unread { background: rgba(99,102,241,0.1); border-left: 3px solid #6366f1; }
.notif-icon { font-size: 24px; flex-shrink: 0; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 10px; }
.notif-icon.checkin { background: rgba(39,174,96,0.2); }
.notif-icon.quiz { background: rgba(243,156,18,0.2); }
.notif-icon.payment { background: rgba(46,204,113,0.2); }
.notif-icon.register { background: rgba(52,152,219,0.2); }
.notif-content { flex: 1; min-width: 0; }
.notif-text { color: #e2e8f0; font-size: 13px; line-height: 1.4; }
.notif-time { color: #64748b; font-size: 11px; margin-top: 3px; }
.notif-empty { text-align: center; padding: 40px 20px; color: #64748b; }
.notif-empty-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.5; }
@keyframes bounceArrow { 0%,100%{transform:translateY(-50%);} 50%{transform:translateY(calc(-50% - 6px));} }
</style>
</head>
<body>

<!-- ======= BANNER DE MANTENIMIENTO ======= -->
<!-- MAINTENANCE BANNER REMOVED -->
<!-- ======= FIN BANNER MANTENIMIENTO ======= -->

<!-- ======= LAUNCHER OVERLAY ======= -->
<div id="launcherOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;z-index:99999;background:radial-gradient(ellipse at center,#0d1117 0%,#060609 100%);display:flex;align-items:center;justify-content:center;font-family:'Segoe UI',system-ui,sans-serif;overflow:hidden;">
  <style>
    #launcherOverlay .lo-bg{position:absolute;width:350px;height:350px;border-radius:50%;filter:blur(100px);opacity:0.15}
    #launcherOverlay .lo-bg1{background:#0066ff;top:-100px;left:-80px;animation:loBgA 8s ease-in-out infinite}
    #launcherOverlay .lo-bg2{background:#ff6b2b;bottom:-100px;right:-80px;animation:loBgB 8s ease-in-out infinite}
    @keyframes loBgA{0%,100%{transform:translate(0,0);opacity:0.12}50%{transform:translate(30px,20px);opacity:0.2}}
    @keyframes loBgB{0%,100%{transform:translate(0,0);opacity:0.12}50%{transform:translate(-30px,-20px);opacity:0.2}}

    #launcherOverlay .lo-wrap{position:relative;z-index:2;text-align:center;padding:20px;width:100%;max-width:400px}

    /* LOGO */
    #launcherOverlay .lo-logo-wrap{margin:0 auto 20px;width:100px;height:100px;position:relative;animation:loLogoFloat 4s ease-in-out infinite}
    #launcherOverlay .lo-logo-wrap img{width:100%;height:100%;border-radius:20px;object-fit:contain;position:relative;z-index:2}
    #launcherOverlay .lo-logo-glow{position:absolute;inset:-8px;border-radius:24px;background:linear-gradient(135deg,rgba(0,170,255,0.25),rgba(255,107,43,0.25));filter:blur(12px);z-index:1;animation:loGlowPulse 3s ease-in-out infinite}
    @keyframes loLogoFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
    @keyframes loGlowPulse{0%,100%{opacity:0.5}50%{opacity:0.9}}

    #launcherOverlay .lo-brand{font-size:11px;letter-spacing:4px;color:rgba(255,255,255,0.45);text-transform:uppercase;margin-bottom:4px;font-weight:600}
    #launcherOverlay .lo-title{font-size:22px;font-weight:800;color:#fff;margin-bottom:4px}
    #launcherOverlay .lo-sub{font-size:13px;color:rgba(255,255,255,0.35);margin-bottom:28px}
    #launcherOverlay .lo-greeting{color:#f39c12;font-size:15px;margin-bottom:20px;display:none}

    /* CIRCLES AREA */
    #launcherOverlay .lo-circles{display:flex;gap:32px;justify-content:center;align-items:center;margin-bottom:28px}
    #launcherOverlay .lo-circle{cursor:pointer;text-align:center;transition:transform 0.3s ease}
    #launcherOverlay .lo-circle:hover{transform:scale(1.05)}
    #launcherOverlay .lo-circle:active{transform:scale(0.95)}

    /* ORB CONTAINER */
    #launcherOverlay .lo-orb{position:relative;width:115px;height:115px;margin:0 auto}
    #launcherOverlay .lo-img-wrap{width:96px;height:96px;border-radius:50%;overflow:hidden;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:3px solid;z-index:2}
    #launcherOverlay .lo-img-wrap img{width:100%;height:100%;object-fit:cover}

    /* BLUE ACVOLT */
    #launcherOverlay .lo-blue .lo-img-wrap{border-color:#00aaff;box-shadow:0 0 18px rgba(0,170,255,0.3)}
    #launcherOverlay .lo-blue .lo-orb{animation:loFloatA 5s ease-in-out infinite}
    #launcherOverlay .lo-blue .lo-ring{position:absolute;inset:0;border-radius:50%;border:2px solid transparent;border-top-color:rgba(0,170,255,0.5);border-right-color:rgba(0,120,255,0.2);animation:loSpin 6s linear infinite;z-index:1}
    #launcherOverlay .lo-blue .lo-ring2{position:absolute;inset:-6px;border-radius:50%;border:1px solid transparent;border-bottom-color:rgba(0,212,255,0.2);animation:loSpin 10s linear infinite reverse;z-index:0}
    #launcherOverlay .lo-blue .lo-pulse{position:absolute;inset:2px;border-radius:50%;border:1px solid rgba(0,170,255,0.15);animation:loPulseRing 3s ease-in-out infinite;z-index:0}

    /* ORANGE Mario AI */
    #launcherOverlay .lo-orange .lo-img-wrap{border-color:#ff6b2b;box-shadow:0 0 18px rgba(255,107,43,0.3)}
    #launcherOverlay .lo-orange .lo-orb{animation:loFloatB 5s ease-in-out infinite}
    #launcherOverlay .lo-orange .lo-ring{position:absolute;inset:0;border-radius:50%;border:2px solid transparent;border-top-color:rgba(255,107,43,0.5);border-left-color:rgba(255,69,0,0.2);animation:loSpin 5s linear infinite reverse;z-index:1}
    #launcherOverlay .lo-orange .lo-ring2{position:absolute;inset:-6px;border-radius:50%;border:1px solid transparent;border-bottom-color:rgba(255,170,0,0.2);animation:loSpin 9s linear infinite;z-index:0}
    #launcherOverlay .lo-orange .lo-pulse{position:absolute;inset:2px;border-radius:50%;border:1px solid rgba(255,107,43,0.15);animation:loPulseRing 3s ease-in-out infinite 1.5s;z-index:0}

    #launcherOverlay .lo-ai{position:absolute;top:2px;right:2px;background:linear-gradient(135deg,#ff6b2b,#e84500);color:#fff;font-size:10px;font-weight:800;padding:3px 7px;border-radius:8px;z-index:4;box-shadow:0 0 8px rgba(255,107,43,0.4)}
    #launcherOverlay .lo-label{color:#fff;font-size:14px;font-weight:700;margin-top:8px}
    #launcherOverlay .lo-sublabel{color:rgba(255,255,255,0.35);font-size:11px;margin-top:3px}
    #launcherOverlay .lo-divider{width:1px;height:70px;background:linear-gradient(to bottom,transparent,rgba(255,255,255,0.1),transparent)}

    /* SMOOTH ANIMATIONS */
    @keyframes loFloatA{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    @keyframes loFloatB{0%,100%{transform:translateY(0)}60%{transform:translateY(-7px)}}
    @keyframes loSpin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    @keyframes loPulseRing{0%,100%{transform:scale(1);opacity:0.4}50%{transform:scale(1.08);opacity:0.8}}

    #launcherOverlay .lo-footer{font-size:10px;color:rgba(255,255,255,0.15);margin-top:10px}
    #launcherOverlay .lo-footer b{color:rgba(255,255,255,0.3);font-size:11px;letter-spacing:2px}
  </style>
  <div class="lo-bg lo-bg1"></div>
  <div class="lo-bg lo-bg2"></div>
  <div class="lo-wrap">
    <div class="lo-logo-wrap">
      <div class="lo-logo-glow"></div>
      <img src="logo.png" alt="ACVOLT" onerror="this.parentElement.style.display='none'">
    </div>
    <div class="lo-brand">A.C. VOLT TECH SCHOOL</div>
    <div class="lo-title">Tech School</div>
    <div class="lo-sub">Elige tu herramienta de estudio</div>
    <div class="lo-greeting" id="loGreeting"></div>
    <div class="lo-circles">
      <div class="lo-circle lo-blue" onclick="closeLauncher()">
        <div class="lo-orb">
          <div class="lo-ring"></div>
          <div class="lo-ring2"></div>
          <div class="lo-pulse"></div>
          <div class="lo-img-wrap">
            <img src="logo.png" alt="ACVOLT" style="object-fit:contain;padding:8px;background:rgba(255,255,255,0.95);border-radius:50%;" onerror="this.src='mario-white.jpg'">
          </div>
        </div>
        <div class="lo-label">Maestro ACVOLT</div>
        <div class="lo-sublabel">Certificaci√≥n HVAC</div>
      </div>
      <div class="lo-divider"></div>
      <div class="lo-circle lo-orange" onclick="stopLauncherMusic();window.location.href='https://acvolttech.github.io/maestroac-v2/'">
        <div class="lo-orb">
          <div class="lo-ring"></div>
          <div class="lo-ring2"></div>
          <div class="lo-pulse"></div>
          <div class="lo-img-wrap">
            <img src="mario-black.jpg" alt="Mario AI" onerror="this.src='mario-white.jpg'">
          </div>
          <span class="lo-ai">AI</span>
        </div>
        <div class="lo-label">Maestro Mario</div>
        <div class="lo-sublabel">AI Biling√ºe</div>
      </div>
    </div>
    <div class="lo-footer">
      <b>A.C. VOLT TECH SCHOOL‚Ñ¢</b><br>
      ¬© 2026 A.C. VOLT TECH SCHOOL, INC. All Rights Reserved.
    </div>
  </div>
</div>
<script>
function closeLauncher(){
  var lo=document.getElementById('launcherOverlay');
  lo.style.transition='opacity 0.5s ease';lo.style.opacity='0';
  setTimeout(function(){lo.style.display='none';},500);
  sessionStorage.setItem('launcher_seen','1');
  stopLauncherMusic();
}
function showLauncher(){
  var lo=document.getElementById('launcherOverlay');
  lo.style.display='flex';
  lo.style.opacity='0';
  lo.style.transition='opacity 0.4s ease';
  setTimeout(function(){lo.style.opacity='1';},10);
  sessionStorage.removeItem('launcher_seen');
  try{playLauncherJingle();}catch(e){}
}

// === LOOPING MOTIVATIONAL LAUNCHER THEME ===
window._launcherLoop=false;
function playLauncherJingle(){
  try{
    if(window._launcherAudioCtx)try{window._launcherAudioCtx.close();}catch(e){}
    var ctx=new(window.AudioContext||window.webkitAudioContext)();
    window._launcherAudioCtx=ctx;
    window._launcherLoop=true;
    var master=ctx.createGain();
    master.gain.value=0.15;
    master.connect(ctx.destination);
    var loopN=0;

    function n(freq,start,dur,type,vol){
      if(!window._launcherLoop)return;
      var o=ctx.createOscillator(),g=ctx.createGain();
      o.type=type||'triangle';o.frequency.value=freq;
      var t=ctx.currentTime+start;
      g.gain.setValueAtTime(0,t);
      g.gain.linearRampToValueAtTime(vol||0.2,t+0.04);
      g.gain.setValueAtTime((vol||0.2)*0.7,t+dur*0.6);
      g.gain.linearRampToValueAtTime(0,t+dur);
      o.connect(g);g.connect(master);
      o.start(t);o.stop(t+dur+0.02);
    }
    function p(freq,start,dur,vol){
      if(!window._launcherLoop)return;
      var o=ctx.createOscillator(),g=ctx.createGain();
      o.type='sine';o.frequency.value=freq;
      var t=ctx.currentTime+start;
      g.gain.setValueAtTime(0,t);
      g.gain.linearRampToValueAtTime(vol||0.055,t+0.6);
      g.gain.setValueAtTime((vol||0.055)*0.85,t+dur-0.8);
      g.gain.linearRampToValueAtTime(0,t+dur);
      o.connect(g);g.connect(master);
      o.start(t);o.stop(t+dur+0.1);
    }

    function loop(){
      if(!window._launcherLoop)return;
      var b=0.44,L=b*16,v=loopN%4;loopN++;
      // PADS - chord progression Eb Ab Bb Cm
      if(v===0){p(155.56,0,L/2);p(196,0,L/2);p(233.08,0,L/2);p(207.65,L/2,L/2);p(261.63,L/2,L/2);p(311.13,L/2,L/2);}
      else if(v===1){p(116.54,0,L/2);p(146.83,0,L/2);p(174.61,0,L/2);p(130.81,L/2,L/2);p(155.56,L/2,L/2);p(196,L/2,L/2);}
      else if(v===2){p(174.61,0,L/2);p(207.65,0,L/2);p(261.63,0,L/2);p(155.56,L/2,L/2);p(196,L/2,L/2);p(233.08,L/2,L/2);}
      else{p(130.81,0,L/2);p(164.81,0,L/2);p(196,0,L/2);p(155.56,L/2,L/2);p(196,L/2,L/2);p(233.08,L/2,L/2);}
      // BASS
      if(v===0){n(77.78,0,b*2,'triangle',0.25);n(77.78,b*4,b*1.5,'triangle',0.2);n(103.83,b*8,b*2,'triangle',0.25);n(103.83,b*12,b*1.5,'triangle',0.2);}
      else if(v===1){n(58.27,0,b*2,'triangle',0.25);n(58.27,b*4,b*1.5,'triangle',0.2);n(65.41,b*8,b*2,'triangle',0.25);n(65.41,b*12,b*1.5,'triangle',0.2);}
      else if(v===2){n(87.31,0,b*2,'triangle',0.25);n(87.31,b*4,b*1.5,'triangle',0.2);n(77.78,b*8,b*2,'triangle',0.25);n(77.78,b*12,b*1.5,'triangle',0.2);}
      else{n(65.41,0,b*2,'triangle',0.25);n(65.41,b*4,b*1.5,'triangle',0.2);n(77.78,b*8,b*2,'triangle',0.25);n(77.78,b*12,b*1.5,'triangle',0.2);}
      // MELODY - 4 variations
      if(v===0){
        n(311.13,b*0,b*1.3,'triangle',0.22);n(349.23,b*1.5,b*1.3,'triangle',0.22);
        n(392,b*3,b*2,'triangle',0.26);n(466.16,b*5.5,b*1,'triangle',0.22);
        n(523.25,b*7,b*2.5,'triangle',0.28);n(466.16,b*10,b*1,'triangle',0.2);
        n(392,b*11.5,b*1,'triangle',0.2);n(349.23,b*13,b*2.5,'triangle',0.22);
      }else if(v===1){
        n(466.16,b*0,b*1,'triangle',0.24);n(392,b*1.5,b*1,'triangle',0.22);
        n(466.16,b*3,b*1,'triangle',0.24);n(523.25,b*4.5,b*2.5,'triangle',0.28);
        n(587.33,b*7.5,b*2,'triangle',0.26);n(523.25,b*10,b*1.2,'triangle',0.24);
        n(466.16,b*11.5,b*1.2,'triangle',0.22);n(392,b*13,b*2.5,'triangle',0.24);
      }else if(v===2){
        n(523.25,b*0,b*2,'triangle',0.26);n(466.16,b*2.5,b*1,'triangle',0.22);
        n(392,b*4,b*1.5,'triangle',0.24);n(349.23,b*6,b*1,'triangle',0.2);
        n(311.13,b*7.5,b*2.5,'triangle',0.24);n(392,b*10.5,b*1,'triangle',0.22);
        n(466.16,b*12,b*1,'triangle',0.24);n(523.25,b*13.5,b*2,'triangle',0.26);
      }else{
        n(392,b*0,b*1.5,'triangle',0.24);n(311.13,b*2,b*1,'triangle',0.2);
        n(349.23,b*3.5,b*1.5,'triangle',0.22);n(392,b*5.5,b*1,'triangle',0.22);
        n(466.16,b*7,b*3,'triangle',0.28);n(523.25,b*10.5,b*1.2,'triangle',0.26);
        n(466.16,b*12,b*1,'triangle',0.22);n(392,b*13.5,b*2,'triangle',0.24);
      }
      // HARMONY accent every other loop
      if(loopN%2===0){n(392,b*7,b*2,'sine',0.05);n(311.13,b*13,b*2,'sine',0.05);}
      // Schedule next
      window._launcherTimer=setTimeout(function(){if(window._launcherLoop)loop();},L*1000-50);
    }
    loop();
  }catch(e){console.log('Music:',e);}
}
function stopLauncherMusic(){
  window._launcherLoop=false;
  clearTimeout(window._launcherTimer);
  if(window._launcherAudioCtx){try{window._launcherAudioCtx.close();window._launcherAudioCtx=null;}catch(e){}}
}

function showV2Paywall(){
  // Check if user has v2 access (paid $49/mes)
  var hasV2 = false;
  if(window.currentUser && window.currentUser.email){
    hasV2 = localStorage.getItem('maestroac_v2_access_' + window.currentUser.email) === 'true';
  }
  // Also check if currentMembership has v2 tier
  if(window.currentMembership && window.currentMembership.activa && window.currentMembership.tipo === 'v2'){
    hasV2 = true;
  }
  if(hasV2){
    window.location.href='https://acvolttech.github.io/maestroac-v2/';
    return;
  }
  var modal = document.createElement('div');
  modal.id = 'v2PaywallModal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
  modal.innerHTML = '<div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:20px;padding:30px;max-width:400px;text-align:center;border:2px solid #f97316;">' +
    '<div style="font-size:50px;margin-bottom:15px;">ü§ñ</div>' +
    '<h2 style="color:#f97316;margin-bottom:10px;font-size:22px;">Maestro Mario AI Biling√ºe</h2>' +
    '<p style="color:#94a3b8;margin-bottom:20px;font-size:14px;">Tu tutor personal de HVAC con Inteligencia Artificial. Responde preguntas t√©cnicas en <strong style="color:white;">espa√±ol e ingl√©s</strong>.</p>' +
    '<div style="background:#0d1117;border-radius:12px;padding:15px;margin-bottom:20px;">' +
    '<p style="color:#f97316;font-size:32px;font-weight:bold;margin:0;">$49<span style="font-size:14px;color:#64748b;">/mes</span></p>' +
    '<p style="color:#64748b;font-size:12px;margin:5px 0 0 0;">Acceso completo a Maestro Mario AI V2</p>' +
    '</div>' +
    '<p style="color:white;font-size:13px;margin-bottom:20px;text-align:left;padding-left:20px;">‚úÖ Tutor AI biling√ºe ilimitado<br>‚úÖ Diagn√≥sticos interactivos<br>‚úÖ Explicaciones paso a paso<br>‚úÖ Pr√°ctica conversacional en ingl√©s<br>‚úÖ Soporte t√©cnico 24/7</p>' +
    '<button onclick="window.open(\'https://buy.stripe.com/v2_49\',\'_blank\');document.getElementById(\'v2PaywallModal\').remove();" style="background:linear-gradient(135deg,#f97316,#ea580c);color:white;border:none;padding:16px 30px;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer;width:100%;margin-bottom:10px;box-shadow:0 4px 15px rgba(249,115,22,0.4);">üí≥ Suscribirme - $49/mes</button>' +
    '<button onclick="document.getElementById(\'v2PaywallModal\').remove();" style="background:transparent;color:#64748b;border:1px solid #64748b;padding:10px 20px;border-radius:8px;font-size:13px;cursor:pointer;width:100%;">Ahora no</button>' +
    '</div>';
  document.body.appendChild(modal);
}

try{
  var u=JSON.parse(localStorage.getItem('maestroac_user')||'{}');
  if(u&&u.nombre){
    var g=document.getElementById('loGreeting');
    g.textContent='Bienvenido, '+u.nombre.split(' ')[0];
    g.style.display='block';
  }
}catch(e){}
if(sessionStorage.getItem('launcher_seen')==='1'){
  document.getElementById('launcherOverlay').style.display='none';
}else{
  document.getElementById('launcherOverlay').addEventListener('click',function _lf(){
    playLauncherJingle();
    document.getElementById('launcherOverlay').removeEventListener('click',_lf);
  },{once:false,capture:true});
  setTimeout(function(){try{playLauncherJingle();}catch(e){}},400);
}
</script>
<!-- ======= FIN LAUNCHER ======= -->
  <div class="container">
    <!-- Login Screen -->
    <div class="screen active" id="loginScreen">
      <div class="header">
        <div class="logo" style="font-size:14px; line-height:1;">
          <img src="logo.png" alt="ACVOLT" style="width:72px;height:72px;object-fit:contain;border-radius:12px;background:rgba(255,255,255,0.9);padding:4px;box-shadow:0 4px 15px rgba(0,0,0,0.1);" onerror="this.style.display='none'">
        </div>
        <h1>MAESTRO ACVOLT</h1>
      </div>

      <!-- Connection Status Indicator -->
      <div id="connectionStatus" style="text-align:center;margin-bottom:10px;">
        <span id="connStatusDot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#27ae60;margin-right:6px;"></span>
        <span id="connStatusText" style="font-size:12px;color:#64748b;">Conectado al servidor</span>
      </div>
      <script>
        (function checkConn(){
          var dot = document.getElementById('connStatusDot');
          var txt = document.getElementById('connStatusText');
          if(!dot || !txt) return;
          function update(){
            if(!navigator.onLine){ dot.style.background='#e74c3c'; txt.textContent='Sin conexi√≥n a internet'; txt.style.color='#e74c3c'; }
            else if(!window.supabase){ dot.style.background='#f39c12'; txt.textContent='Conectando al servidor...'; txt.style.color='#f39c12'; }
            else { dot.style.background='#27ae60'; txt.textContent='Conectado al servidor'; txt.style.color='#64748b'; }
          }
          update();
          setInterval(update, 3000);
          window.addEventListener('online', update);
          window.addEventListener('offline', update);
        })();
      </script>

      <!-- YA TIENES CUENTA - Zona de Login -->
      <div class="card" style="border:2px solid rgba(243,156,18,0.4); background:linear-gradient(135deg, rgba(243,156,18,0.08), rgba(230,126,34,0.05));">
        <div style="text-align:center; margin-bottom:15px;">
          <p style="color:#f39c12; font-size:20px; font-weight:bold; margin:0;">üîë ¬øYA TIENES CUENTA?</p>
          <p style="color:#94a3b8; font-size:14px; margin-top:5px;">Inicia sesi√≥n con tu correo y contrase√±a</p>
        </div>
        <div class="login-error" id="loginError">Correo o contrase√±a incorrectos</div>
        <form id="loginForm" onsubmit="return handleLogin(event)">
          <div class="form-group">
            <label>Correo Electr√≥nico</label>
            <input type="email" id="loginEmail" placeholder="tucorreo@ejemplo.com" required>
          </div>
          <div class="form-group">
            <label>Contrase√±a</label>
            <input type="password" id="loginPassword" placeholder="Ingresa tu contrase√±a" required>
          </div>
          <!-- Terms Checkbox -->
          <div style="margin-bottom:15px; padding:12px; background:rgba(243,156,18,0.1); border-radius:10px; border:1px solid rgba(243,156,18,0.3);">
            <label style="display:flex; align-items:flex-start; gap:10px; cursor:pointer; font-size:13px; color:#64748b;">
              <input type="checkbox" id="loginTermsCheckbox" style="margin-top:3px; width:18px; height:18px; cursor:pointer;" required>
              <span>Al continuar, acepto los <a href="terms.html" target="_blank" style="color:#E31937; font-weight:bold;">T√©rminos de Servicio</a> y la <a href="privacy.html" target="_blank" style="color:#E31937; font-weight:bold;">Pol√≠tica de Privacidad</a> de MaestroAC App y ACVOLT Tech School Inc.</span>
            </label>
          </div>
          <button type="submit" class="btn btn-primary" style="font-size:18px; padding:16px;">üîì INICIAR SESI√ìN</button>
        </form>
        <div style="text-align:center; margin-top:12px;">
          <span onclick="showForgotPassword()" style="color:#3498db; cursor:pointer; font-size:15px; text-decoration:underline;">üîë ¬øOlvidaste tu contrase√±a?</span>
        </div>
        <div id="forgotPasswordBox" style="display:none; margin-top:15px; padding:15px; background:rgba(52,152,219,0.1); border:1px solid rgba(52,152,219,0.3); border-radius:12px;">
          <p style="color:#3498db; font-size:14px; font-weight:bold; margin:0 0 10px; text-align:center;">Ingresa tu correo para recibir un link de recuperaci√≥n</p>
          <input type="email" id="forgotEmail" placeholder="tucorreo@ejemplo.com" style="width:100%; padding:12px; border-radius:8px; border:2px solid rgba(52,152,219,0.4); background:white; color:#333; font-size:15px; box-sizing:border-box; margin-bottom:10px;">
          <button onclick="sendPasswordReset()" class="btn btn-primary" style="width:100%; background:linear-gradient(135deg, #3498db, #2980b9); font-size:15px; padding:12px;">üìß ENVIAR LINK DE RECUPERACI√ìN</button>
          <div id="forgotPasswordMsg" style="display:none; margin-top:10px; text-align:center; font-size:14px;"></div>
        </div>
        <!-- Magic Link / OTP Section -->
        <div style="text-align:center; margin-top:15px; padding-top:15px; border-top:1px solid rgba(243,156,18,0.2);">
          <p style="color:#94a3b8; font-size:13px; margin-bottom:10px;">¬øProblemas para entrar?</p>
          <button onclick="showMagicLinkBox()" class="btn btn-secondary" style="background:linear-gradient(135deg, #9b59b6, #8e44ad); color:white; font-size:14px; padding:12px; width:100%;">‚ú® RECIBIR LINK DE ACCESO POR EMAIL</button>
        </div>
        <div id="magicLinkBox" style="display:none; margin-top:15px; padding:15px; background:rgba(155,89,182,0.1); border:1px solid rgba(155,89,182,0.3); border-radius:12px;">
          <p style="color:#9b59b6; font-size:14px; font-weight:bold; margin:0 0 10px; text-align:center;">Ingresa tu correo y te enviamos un link para entrar sin contrase√±a</p>
          <input type="email" id="magicLinkEmail" placeholder="tucorreo@ejemplo.com" style="width:100%; padding:12px; border-radius:8px; border:2px solid rgba(155,89,182,0.4); background:white; color:#333; font-size:15px; box-sizing:border-box; margin-bottom:10px;">
          <!-- Terms Checkbox for Magic Link -->
          <div style="margin-bottom:12px; padding:10px; background:rgba(243,156,18,0.1); border-radius:8px;">
            <label style="display:flex; align-items:flex-start; gap:8px; cursor:pointer; font-size:12px; color:#64748b;">
              <input type="checkbox" id="magicLinkTermsCheckbox" style="margin-top:2px; width:16px; height:16px; cursor:pointer;">
              <span>Acepto los <a href="terms.html" target="_blank" style="color:#9b59b6; font-weight:bold;">T√©rminos</a> y <a href="privacy.html" target="_blank" style="color:#9b59b6; font-weight:bold;">Privacidad</a></span>
            </label>
          </div>
          <button onclick="sendMagicLink()" class="btn btn-primary" style="width:100%; background:linear-gradient(135deg, #9b59b6, #8e44ad); font-size:15px; padding:12px;">üìß ENVIAR LINK DE ACCESO</button>
          <div id="magicLinkMsg" style="display:none; margin-top:10px; text-align:center; font-size:14px;"></div>
        </div>
      </div>

      <!-- RESET PASSWORD FORM (hidden by default, shown when recovery token detected) -->
      <div id="resetPasswordBox" style="display:none; margin-top:15px;">
        <div class="card" style="border:2px solid #27ae60; background:rgba(39,174,96,0.05);">
          <div style="text-align:center; margin-bottom:20px;">
            <div style="font-size:50px; margin-bottom:10px;">üîê</div>
            <h2 style="color:#27ae60; font-size:22px; margin-bottom:5px;">NUEVA CONTRASE√ëA</h2>
            <p style="color:#64748b; font-size:14px;">Ingresa tu nueva contrase√±a para restablecer tu acceso</p>
          </div>
          <div class="form-group">
            <label>Nueva Contrase√±a</label>
            <input type="password" id="resetNewPassword" placeholder="M√≠nimo 6 caracteres" style="width:100%; padding:15px; border:2px solid #e2e8f0; border-radius:10px; background:#f8fafc; color:#1e293b; font-size:16px;">
          </div>
          <div class="form-group">
            <label>Confirmar Contrase√±a</label>
            <input type="password" id="resetConfirmPassword" placeholder="Repite tu nueva contrase√±a" style="width:100%; padding:15px; border:2px solid #e2e8f0; border-radius:10px; background:#f8fafc; color:#1e293b; font-size:16px;">
          </div>
          <button onclick="submitNewPassword()" class="btn btn-primary" style="width:100%; background:linear-gradient(135deg, #27ae60, #2ecc71); font-size:18px; padding:16px;">‚úÖ CAMBIAR CONTRASE√ëA</button>
          <div id="resetPasswordMsg" style="display:none; margin-top:15px; text-align:center; font-size:14px; padding:12px; border-radius:8px;"></div>
        </div>
      </div>

      <!-- Separador -->
      <div style="text-align:center; margin:20px 0; position:relative;">
        <div style="border-top:2px solid rgba(255,255,255,0.15); position:absolute; top:50%; left:20%; right:20%;"></div>
        <span style="background:#0f172a; padding:5px 20px; color:#f39c12; font-size:18px; font-weight:bold; position:relative; border:1px solid rgba(243,156,18,0.3); border-radius:20px;">√≥</span>
      </div>

      <!-- Zona de Registro -->
      <div class="card" style="border:2px solid rgba(46,204,113,0.3); background:linear-gradient(135deg, rgba(46,204,113,0.08), rgba(39,174,96,0.05));">
        <div style="text-align:center;">
          <p style="color:#2ecc71; font-size:18px; font-weight:bold; margin:0 0 5px;">üìù ¬øERES NUEVO?</p>
          <p style="color:#94a3b8; font-size:13px; margin-bottom:12px;">Crea tu cuenta gratis ‚Äî Acceso al Nivel 1 Principiante</p>
          <button class="btn btn-secondary" onclick="showScreen('registerScreen')" style="background: linear-gradient(135deg, #27ae60, #2ecc71); color:white; font-size:16px; padding:14px; width:100%; font-weight:bold;">REG√çSTRATE GRATIS</button>
        </div>
      </div>

      <!-- Landing Page Link -->
      <div style="text-align:center; margin-top:15px;">
        <button onclick="showScreen('landingPageScreen')" style="background:none;border:1px solid rgba(0,212,255,0.3);padding:10px 25px;border-radius:20px;color:#00d4ff;font-size:13px;cursor:pointer;">üìñ Conoce m√°s sobre MaestroAC ‚Üí</button>
      </div>

      <div style="text-align:center; margin-top:15px;">
        <span class="admin-link" onclick="showScreen('adminLoginScreen')">üîë Acceso Administrador</span>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- LANDING PAGE CON TESTIMONIOS ‚Äî FASE 2 #8   -->
    <!-- ============================================ -->
    <div class="screen" id="landingPageScreen">
      <div class="container" style="max-width:600px;margin:auto;padding:15px;">

        <!-- Hero -->
        <div style="text-align:center;padding:30px 15px;background:linear-gradient(135deg,rgba(243,156,18,0.15),rgba(230,126,34,0.05));border-radius:20px;border:1px solid rgba(243,156,18,0.3);margin-bottom:20px;">
          <div style="font-size:60px;margin-bottom:10px;">üîß</div>
          <h1 style="color:#f39c12;font-size:28px;margin:0 0 8px;">MaestroAC</h1>
          <p style="color:#e2e8f0;font-size:16px;margin:0 0 5px;">La App #1 de Entrenamiento HVAC en Espa√±ol</p>
          <p style="color:#64748b;font-size:13px;">Por <strong style="color:#f39c12;">Maestro Mario</strong> ‚Äî Nivel 33 Podcast</p>
          <div style="display:flex;justify-content:center;gap:15px;margin-top:20px;">
            <div style="text-align:center;">
              <div style="font-size:24px;font-weight:bold;color:#2ecc71;">640K+</div>
              <div style="font-size:10px;color:#64748b;">Seguidores</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:24px;font-weight:bold;color:#3498db;">2,350+</div>
              <div style="font-size:10px;color:#64748b;">Preguntas de Quiz</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:24px;font-weight:bold;color:#f39c12;">5</div>
              <div style="font-size:10px;color:#64748b;">Niveles de Certificaci√≥n</div>
            </div>
          </div>
        </div>

        <!-- Qu√© incluye -->
        <div class="card" style="padding:20px;margin-bottom:15px;">
          <h2 style="color:#f39c12;font-size:18px;margin:0 0 15px;text-align:center;">üéØ ¬øQu√© incluye MaestroAC?</h2>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div style="background:rgba(52,152,219,0.1);border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:24px;">üìù</div>
              <div style="color:#e2e8f0;font-size:12px;font-weight:bold;">Quiz System</div>
              <div style="color:#64748b;font-size:10px;">2,350+ preguntas por nivel</div>
            </div>
            <div style="background:rgba(46,204,113,0.1);border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:24px;">üèÖ</div>
              <div style="color:#e2e8f0;font-size:12px;font-weight:bold;">Certificados QR</div>
              <div style="color:#64748b;font-size:10px;">Verificables digitalmente</div>
            </div>
            <div style="background:rgba(155,89,182,0.1);border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:24px;">üé•</div>
              <div style="color:#e2e8f0;font-size:12px;font-weight:bold;">Clases en Vivo</div>
              <div style="color:#64748b;font-size:10px;">Lunes a S√°bado por Zoom</div>
            </div>
            <div style="background:rgba(243,156,18,0.1);border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:24px;">üìö</div>
              <div style="color:#e2e8f0;font-size:12px;font-weight:bold;">Material de Estudio</div>
              <div style="color:#64748b;font-size:10px;">Videos + documentos HVAC</div>
            </div>
          </div>
        </div>

        <!-- Niveles -->
        <div class="card" style="padding:20px;margin-bottom:15px;">
          <h2 style="color:#f39c12;font-size:18px;margin:0 0 15px;text-align:center;">üìä 5 Niveles de Certificaci√≥n</h2>
          <div style="line-height:2.2;font-size:14px;">
            <div style="color:#3498db;">üîß <strong>Nivel 1 ‚Äî Principiante:</strong> <span style="color:#2ecc71;">GRATIS</span></div>
            <div style="color:#27ae60;">üìä <strong>Nivel 2 ‚Äî Intermedio:</strong> Membres√≠a</div>
            <div style="color:#f39c12;">‚ö° <strong>Nivel 3 ‚Äî Avanzado:</strong> Membres√≠a</div>
            <div style="color:#e74c3c;">üèÜ <strong>Nivel 4 ‚Äî Elite:</strong> Membres√≠a</div>
            <div style="color:#9b59b6;">üíé <strong>Nivel 5 ‚Äî Platino:</strong> Membres√≠a</div>
          </div>
          <p style="color:#64748b;font-size:12px;text-align:center;margin-top:10px;">Cada nivel requiere 80%+ para certificarte</p>
        </div>

        <!-- Testimonios -->
        <div class="card" style="padding:20px;margin-bottom:15px;border:2px solid rgba(46,204,113,0.3);background:linear-gradient(135deg,rgba(46,204,113,0.05),rgba(39,174,96,0.02));">
          <h2 style="color:#2ecc71;font-size:18px;margin:0 0 15px;text-align:center;">‚≠ê Lo que dicen nuestros estudiantes</h2>
          
          <div style="background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;margin-bottom:12px;border-left:3px solid #f39c12;">
            <p style="color:#e2e8f0;font-size:13px;font-style:italic;margin:0 0 8px;">"Gracias a MaestroAC pas√© mi examen EPA 608 al primer intento. Las preguntas del quiz son exactamente lo que viene en el examen real. ¬°Recomendado al 100%!"</p>
            <div style="display:flex;align-items:center;gap:8px;">
              <div style="width:32px;height:32px;background:#f39c12;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;">JR</div>
              <div><strong style="color:#f39c12;font-size:12px;">Jos√© Ram√≠rez</strong><br><span style="color:#64748b;font-size:10px;">T√©cnico HVAC ‚Äî Los Angeles, CA</span></div>
            </div>
          </div>
          
          <div style="background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;margin-bottom:12px;border-left:3px solid #3498db;">
            <p style="color:#e2e8f0;font-size:13px;font-style:italic;margin:0 0 8px;">"Llevo 3 meses usando la app y ya complet√© hasta el nivel avanzado. Mi jefe me subi√≥ el sueldo porque ahora puedo diagnosticar problemas que antes no entend√≠a. La inversi√≥n se paga sola."</p>
            <div style="display:flex;align-items:center;gap:8px;">
              <div style="width:32px;height:32px;background:#3498db;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;">MH</div>
              <div><strong style="color:#3498db;font-size:12px;">Miguel Hern√°ndez</strong><br><span style="color:#64748b;font-size:10px;">T√©cnico Senior ‚Äî Houston, TX</span></div>
            </div>
          </div>
          
          <div style="background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;margin-bottom:12px;border-left:3px solid #2ecc71;">
            <p style="color:#e2e8f0;font-size:13px;font-style:italic;margin:0 0 8px;">"Lo mejor es que todo est√° en espa√±ol. Yo no hablo mucho ingl√©s y siempre batallaba con los materiales de estudio. Con MaestroAC por fin entiendo todo. Ya tengo 2 certificados."</p>
            <div style="display:flex;align-items:center;gap:8px;">
              <div style="width:32px;height:32px;background:#2ecc71;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;">CL</div>
              <div><strong style="color:#2ecc71;font-size:12px;">Carlos L√≥pez</strong><br><span style="color:#64748b;font-size:10px;">Ayudante HVAC ‚Äî Phoenix, AZ</span></div>
            </div>
          </div>
          
          <div style="background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;border-left:3px solid #9b59b6;">
            <p style="color:#e2e8f0;font-size:13px;font-style:italic;margin:0 0 8px;">"Soy due√±o de mi empresa y inscrib√≠ a mis 5 t√©cnicos en MaestroAC. En 2 meses ya todos pasaron el nivel intermedio. Es la mejor herramienta para entrenar personal nuevo."</p>
            <div style="display:flex;align-items:center;gap:8px;">
              <div style="width:32px;height:32px;background:#9b59b6;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;">RF</div>
              <div><strong style="color:#9b59b6;font-size:12px;">Roberto Flores</strong><br><span style="color:#64748b;font-size:10px;">Due√±o HVAC Company ‚Äî Dallas, TX</span></div>
            </div>
          </div>
        </div>

        <!-- Podcast -->
        <div class="card" style="padding:20px;margin-bottom:15px;background:linear-gradient(135deg,rgba(243,156,18,0.1),rgba(230,126,34,0.05));border:1px solid rgba(243,156,18,0.2);">
          <div style="display:flex;align-items:center;gap:15px;">
            <div style="font-size:40px;">üéôÔ∏è</div>
            <div>
              <h3 style="color:#f39c12;font-size:16px;margin:0 0 4px;">Nivel 33 Podcast</h3>
              <p style="color:#e2e8f0;font-size:13px;margin:0;">El podcast #1 de HVAC en espa√±ol con 640,000+ seguidores. Esc√∫chalo diario para seguir aprendiendo.</p>
            </div>
          </div>
        </div>

        <!-- CTA -->
        <div style="padding:20px;text-align:center;">
          <button onclick="showScreen('registerScreen')" style="width:100%;padding:18px;border:none;border-radius:12px;background:linear-gradient(135deg,#27ae60,#2ecc71);color:white;font-size:18px;font-weight:bold;cursor:pointer;margin-bottom:10px;">üìù REG√çSTRATE GRATIS</button>
          <button onclick="showScreen('loginScreen')" style="width:100%;padding:14px;border:none;border-radius:12px;background:rgba(243,156,18,0.15);color:#f39c12;font-size:15px;font-weight:bold;cursor:pointer;border:1px solid rgba(243,156,18,0.3);">üîë Ya tengo cuenta ‚Äî Iniciar Sesi√≥n</button>
        </div>

        <div style="text-align:center;padding:15px;color:#64748b;font-size:11px;">
          <p>ACVOLT Tech School Inc. ‚Äî San Bernardino, CA</p>
          <p>maestromario.com | @nivel33podcast</p>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- PANTALLA: CALENDARIO DE CLASES (ESTUDIANTE) -->
    <!-- ============================================ -->
    <div class="screen" id="studentCalendarScreen">
      <div class="container">
        <div class="header">
          <h1>üìÖ Clases en Vivo</h1>
          <p class="subtitle">Horarios y pr√≥ximas clases</p>
        </div>
        <div class="card" style="padding:15px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3 style="color:#1e40af;margin:0;font-size:16px;font-weight:800;">üìÖ Pr√≥ximas Clases</h3>
            <span id="stuCalWeek" style="color:#4b5563;font-size:12px;font-weight:600;"></span>
          </div>
          <div id="studentClassList" style="min-height:200px;">
            <div style="text-align:center;color:#94a3b8;padding:30px;">
              <div style="font-size:40px;margin-bottom:10px;">üìÖ</div>
              <p>Cargando calendario de clases...</p>
            </div>
          </div>
        </div>
        <div class="card" style="padding:15px;margin-top:15px;background:linear-gradient(135deg,#eef2ff,#e0e7ff);border:2px solid #6366f1;">
          <h3 style="color:#4338ca;font-size:15px;margin:0 0 8px;font-weight:800;">üîî Horario Regular</h3>
          <div style="color:#1e293b;font-size:14px;line-height:2;">
            <div>üìå <strong style="color:#dc2626;">Lunes a Viernes:</strong> <strong>7:00 PM - 9:00 PM (PST)</strong></div>
            <div>üìå <strong style="color:#dc2626;">S√°bados:</strong> <strong>10:00 AM - 12:00 PM (PST)</strong></div>
            <div style="color:#6b7280;font-size:11px;margin-top:8px;">* Los horarios pueden cambiar. Revisa este calendario antes de cada clase.</div>
          </div>
        </div>
        <button class="btn btn-secondary" onclick="showScreen('welcomeScreen')" style="margin-top:15px;">‚Üê Volver al Men√∫</button>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- PANTALLA: PROGRAMA DE EMBAJADORES (ESTUDIANTE) -->
    <!-- ============================================ -->
    <div class="screen" id="referidosScreen">
      <div class="container">
        <!-- CSS Animations -->
        <style>
          @keyframes floatMoney { 0%,100%{transform:translateY(0) rotate(0deg);} 25%{transform:translateY(-15px) rotate(5deg);} 50%{transform:translateY(-8px) rotate(-3deg);} 75%{transform:translateY(-20px) rotate(3deg);} }
          @keyframes pulseCash { 0%,100%{transform:scale(1);} 50%{transform:scale(1.15);} }
          @keyframes shimmer { 0%{background-position:-200% center;} 100%{background-position:200% center;} }
          @keyframes bounceArrow { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-8px);} }
          @keyframes rainMoney { 0%{transform:translateY(-100%) rotate(0deg);opacity:1;} 100%{transform:translateY(100vh) rotate(720deg);opacity:0;} }
          @keyframes glowPulse { 0%,100%{box-shadow:0 0 10px rgba(243,156,18,0.3);} 50%{box-shadow:0 0 30px rgba(243,156,18,0.6),0 0 60px rgba(39,174,96,0.3);} }
          @keyframes slideUp { 0%{transform:translateY(30px);opacity:0;} 100%{transform:translateY(0);opacity:1;} }
          @keyframes countUp { 0%{transform:scale(0.5);opacity:0;} 50%{transform:scale(1.2);} 100%{transform:scale(1);opacity:1;} }
          .amb-float { animation: floatMoney 3s ease-in-out infinite; display:inline-block; }
          .amb-float-delay1 { animation-delay: 0.3s; }
          .amb-float-delay2 { animation-delay: 0.6s; }
          .amb-float-delay3 { animation-delay: 0.9s; }
          .amb-pulse { animation: pulseCash 2s ease-in-out infinite; }
          .amb-shimmer { background:linear-gradient(90deg,#f39c12 0%,#ffd700 25%,#f39c12 50%,#2ecc71 75%,#f39c12 100%); background-size:200% auto; -webkit-background-clip:text; -webkit-text-fill-color:transparent; animation:shimmer 3s linear infinite; }
          .amb-bounce { animation: bounceArrow 1.5s ease-in-out infinite; }
          .amb-glow { animation: glowPulse 2s ease-in-out infinite; }
          .amb-slide { animation: slideUp 0.6s ease-out forwards; opacity:0; }
          .amb-slide-d1 { animation-delay:0.1s; }
          .amb-slide-d2 { animation-delay:0.2s; }
          .amb-slide-d3 { animation-delay:0.3s; }
          .amb-slide-d4 { animation-delay:0.4s; }
          .amb-rain { position:absolute; animation: rainMoney linear infinite; pointer-events:none; font-size:20px; opacity:0.6; }
          .amb-share-btn { padding:12px 18px; border:none; border-radius:12px; font-weight:bold; font-size:14px; cursor:pointer; transition:all 0.3s; display:flex; align-items:center; gap:8px; justify-content:center; }
          .amb-share-btn:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,0.2); }
          .amb-share-btn:active { transform:scale(0.95); }
          .amb-step { display:flex; align-items:center; gap:12px; padding:10px; border-radius:10px; margin-bottom:6px; transition:all 0.3s; }
          .amb-step:hover { background:rgba(243,156,18,0.08); transform:translateX(5px); }
        </style>

        <!-- Money Rain Background -->
        <div style="position:relative;overflow:hidden;pointer-events:none;height:0;">
          <div class="amb-rain" style="left:5%;animation-duration:4s;animation-delay:0s;">üíµ</div>
          <div class="amb-rain" style="left:20%;animation-duration:5s;animation-delay:1s;">üí∞</div>
          <div class="amb-rain" style="left:40%;animation-duration:4.5s;animation-delay:0.5s;">ü§ë</div>
          <div class="amb-rain" style="left:60%;animation-duration:5.5s;animation-delay:1.5s;">üí≤</div>
          <div class="amb-rain" style="left:80%;animation-duration:4s;animation-delay:2s;">üíµ</div>
          <div class="amb-rain" style="left:90%;animation-duration:5s;animation-delay:0.8s;">üí∞</div>
        </div>

        <!-- Hero Banner -->
        <div class="amb-slide" style="background:linear-gradient(135deg,#0a1628 0%,#1a2a4a 50%,#0d1f3c 100%);border-radius:24px;padding:28px 20px;margin-bottom:18px;border:2px solid rgba(243,156,18,0.5);position:relative;overflow:hidden;">
          <!-- Decorative glow -->
          <div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:radial-gradient(circle,rgba(243,156,18,0.2),transparent);border-radius:50%;"></div>
          <div style="position:absolute;bottom:-30px;left:-30px;width:100px;height:100px;background:radial-gradient(circle,rgba(39,174,96,0.15),transparent);border-radius:50%;"></div>
          
          <div style="text-align:center;position:relative;z-index:2;">
            <div style="margin-bottom:8px;">
              <span class="amb-float" style="font-size:40px;">üíµ</span>
              <span class="amb-float amb-float-delay1" style="font-size:50px;">ü§ë</span>
              <span class="amb-float amb-float-delay2" style="font-size:40px;">üíµ</span>
            </div>
            <h2 class="amb-shimmer" style="font-size:26px;margin:0 0 6px;font-weight:900;">¬°GANA DINERO CON ACVOLT!</h2>
            <p style="color:#e2e8f0;font-size:15px;margin:0 0 12px;">Convi√©rtete en <strong style="color:#f39c12;">Embajador</strong> y gana dinero real</p>
            
            <!-- Animated arrow -->
            <div class="amb-bounce" style="margin:8px 0;">
              <span style="font-size:28px;">üëá</span>
            </div>
            
            <!-- Big money amount -->
            <div class="amb-glow" style="background:linear-gradient(135deg,rgba(39,174,96,0.2),rgba(243,156,18,0.15));border:2px solid rgba(39,174,96,0.5);border-radius:16px;padding:16px;display:inline-block;margin-bottom:10px;">
              <div class="amb-pulse" style="font-size:42px;font-weight:900;color:#2ecc71;letter-spacing:2px;">$20 <span style="font-size:16px;color:#94a3b8;font-weight:normal;">USD</span></div>
              <div style="color:#e2e8f0;font-size:13px;">por cada referido que active membres√≠a</div>
            </div>
          </div>
        </div>

        <!-- Earnings Scale Cards -->
        <div class="amb-slide amb-slide-d1" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:18px;">
          <div style="background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:2px solid #86efac;border-radius:14px;padding:14px 8px;text-align:center;">
            <div class="amb-float" style="font-size:28px;">1Ô∏è‚É£</div>
            <div style="color:#16a34a;font-size:22px;font-weight:900;">$20</div>
            <div style="color:#64748b;font-size:10px;">1 referido</div>
          </div>
          <div style="background:linear-gradient(135deg,#fffbeb,#fef3c7);border:2px solid #fcd34d;border-radius:14px;padding:14px 8px;text-align:center;">
            <div class="amb-float amb-float-delay1" style="font-size:28px;">5Ô∏è‚É£</div>
            <div style="color:#d97706;font-size:22px;font-weight:900;">$100</div>
            <div style="color:#64748b;font-size:10px;">5 referidos</div>
          </div>
          <div style="background:linear-gradient(135deg,#fdf2f8,#fce7f3);border:2px solid #f9a8d4;border-radius:14px;padding:14px 8px;text-align:center;">
            <div class="amb-float amb-float-delay2" style="font-size:28px;">üîü</div>
            <div style="color:#db2777;font-size:22px;font-weight:900;">$200</div>
            <div style="color:#64748b;font-size:10px;">10 referidos</div>
          </div>
        </div>

        <!-- Payment Method -->
        <div class="amb-slide amb-slide-d1" style="background:linear-gradient(135deg,#faf5ff,#f3e8ff);border:2px solid #d8b4fe;border-radius:12px;padding:12px;text-align:center;margin-bottom:18px;">
          <span style="font-size:18px;">üí≥</span> <span style="color:#7c3aed;font-size:13px;font-weight:bold;">Pago directo por <strong>Zelle</strong> o <strong>Transferencia Bancaria</strong></span>
        </div>

        <!-- Share Section -->
        <div class="amb-slide amb-slide-d2 amb-glow" style="background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:20px;padding:22px;margin-bottom:18px;border:2px solid rgba(243,156,18,0.4);">
          <div style="text-align:center;margin-bottom:14px;">
            <span style="font-size:24px;">üîó</span>
            <span style="color:#f39c12;font-size:16px;font-weight:bold;"> Tu Link de Embajador</span>
          </div>
          
          <div style="background:rgba(255,255,255,0.08);border:1px dashed rgba(243,156,18,0.5);border-radius:12px;padding:14px;text-align:center;margin-bottom:14px;">
            <code id="refLinkCode" style="color:#2ecc71;font-size:13px;word-break:break-all;font-weight:bold;">Cargando...</code>
          </div>
          
          <p style="text-align:center;color:#94a3b8;font-size:11px;margin-bottom:12px;">‚ö° Comparte tu link y el mensaje se genera autom√°ticamente</p>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <button onclick="copyRefLink()" class="amb-share-btn" style="background:linear-gradient(135deg,#f39c12,#e67e22);color:#1a1a2e;">üìã Copiar Mensaje</button>
            <button onclick="shareRefWhatsApp()" class="amb-share-btn" style="background:linear-gradient(135deg,#25D366,#128C7E);color:white;">üì± WhatsApp</button>
            <button onclick="shareRefFacebook()" class="amb-share-btn" style="background:linear-gradient(135deg,#1877F2,#0d5db8);color:white;">üìò Facebook</button>
            <button onclick="shareRefSMS()" class="amb-share-btn" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;">üí¨ SMS</button>
          </div>
        </div>

        <!-- Stats Dashboard -->
        <div class="amb-slide amb-slide-d3" style="background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:20px;padding:18px;margin-bottom:18px;border:1px solid rgba(255,255,255,0.1);">
          <div style="text-align:center;margin-bottom:14px;">
            <span style="font-size:18px;">üìä</span>
            <span style="color:#e2e8f0;font-size:15px;font-weight:bold;"> Tu Dashboard de Embajador</span>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
            <div style="background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(59,130,246,0.05));border:1px solid rgba(59,130,246,0.3);border-radius:14px;padding:14px 8px;text-align:center;">
              <div style="font-size:22px;">üì§</div>
              <div id="myRefCount" style="font-size:28px;font-weight:900;color:#3b82f6;">0</div>
              <div style="color:#94a3b8;font-size:10px;">Registrados</div>
            </div>
            <div style="background:linear-gradient(135deg,rgba(34,197,94,0.15),rgba(34,197,94,0.05));border:1px solid rgba(34,197,94,0.3);border-radius:14px;padding:14px 8px;text-align:center;">
              <div style="font-size:22px;">‚úÖ</div>
              <div id="myRefActive" style="font-size:28px;font-weight:900;color:#22c55e;">0</div>
              <div style="color:#94a3b8;font-size:10px;">Activos</div>
            </div>
            <div style="background:linear-gradient(135deg,rgba(243,156,18,0.15),rgba(243,156,18,0.05));border:1px solid rgba(243,156,18,0.3);border-radius:14px;padding:14px 8px;text-align:center;">
              <div style="font-size:22px;">ü§ë</div>
              <div id="myFreeMonths" style="font-size:28px;font-weight:900;color:#f39c12;">$0</div>
              <div style="color:#94a3b8;font-size:10px;">Ganado</div>
            </div>
          </div>
        </div>

        <!-- W-9 Requirement -->
        <div class="amb-slide amb-slide-d3" style="padding:18px;margin-bottom:18px;border-radius:18px;border:2px solid rgba(231,76,60,0.4);background:linear-gradient(135deg,rgba(231,76,60,0.1),rgba(192,57,43,0.05));">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
            <span style="font-size:28px;">üìã</span>
            <div>
              <h3 style="color:#e74c3c;font-size:15px;margin:0;">Requisito: Formulario W-9</h3>
              <p style="color:#94a3b8;font-size:11px;margin:2px 0 0;">Requerido por el IRS para procesarte el pago</p>
            </div>
          </div>
          <p style="color:#cbd5e1;font-size:12px;line-height:1.6;margin-bottom:12px;">Para recibir tu dinero, necesitas llenar el <strong style="color:#f39c12;">formulario W-9</strong> una sola vez. Sin este formulario no podemos pagarte.</p>
          <div id="w9StatusBox">
            <button onclick="showW9Form()" style="width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#e74c3c,#c0392b);color:white;font-weight:bold;font-size:15px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">üìù Llenar Formulario W-9</button>
          </div>
        </div>

        <!-- How it works - Visual Steps -->
        <div class="amb-slide amb-slide-d4" style="background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:20px;padding:20px;margin-bottom:18px;border:1px solid rgba(255,255,255,0.1);">
          <h3 style="color:#f39c12;font-size:16px;margin:0 0 14px;text-align:center;">‚ö° ¬øC√≥mo funciona?</h3>
          
          <div class="amb-step">
            <div style="background:#e74c3c;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;">üìù</div>
            <div><span style="color:#e2e8f0;font-size:13px;">Llena tu <strong style="color:#f39c12;">formulario W-9</strong> (una sola vez)</span></div>
          </div>
          
          <div style="margin-left:18px;border-left:2px dashed rgba(243,156,18,0.3);height:12px;"></div>
          
          <div class="amb-step">
            <div style="background:#3b82f6;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;">üì§</div>
            <div><span style="color:#e2e8f0;font-size:13px;"><strong style="color:#3b82f6;">Comparte</strong> tu link con t√©cnicos HVAC</span></div>
          </div>
          
          <div style="margin-left:18px;border-left:2px dashed rgba(243,156,18,0.3);height:12px;"></div>
          
          <div class="amb-step">
            <div style="background:#8b5cf6;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;">üë§</div>
            <div><span style="color:#e2e8f0;font-size:13px;">Tu referido se <strong style="color:#8b5cf6;">registra</strong> con tu link</span></div>
          </div>
          
          <div style="margin-left:18px;border-left:2px dashed rgba(243,156,18,0.3);height:12px;"></div>
          
          <div class="amb-step">
            <div style="background:#2ecc71;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;">üí≥</div>
            <div><span style="color:#e2e8f0;font-size:13px;">Activa su membres√≠a = <strong style="color:#2ecc71;">¬°$20 para ti!</strong></span></div>
          </div>
          
          <div style="margin-left:18px;border-left:2px dashed rgba(243,156,18,0.3);height:12px;"></div>
          
          <div class="amb-step">
            <div style="background:#f39c12;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;">üè¶</div>
            <div><span style="color:#e2e8f0;font-size:13px;">Recibe tu <strong style="color:#f39c12;">pago por Zelle</strong> o transferencia</span></div>
          </div>
        </div>

        <!-- Motivational CTA -->
        <div class="amb-slide amb-slide-d4" style="background:linear-gradient(135deg,rgba(243,156,18,0.15),rgba(39,174,96,0.1));border:2px solid rgba(243,156,18,0.3);border-radius:18px;padding:18px;text-align:center;margin-bottom:18px;">
          <div style="font-size:32px;margin-bottom:8px;">üöÄ</div>
          <p style="color:#f39c12;font-size:15px;font-weight:bold;margin:0 0 6px;">¬øConoces 5 t√©cnicos HVAC?</p>
          <p style="color:#e2e8f0;font-size:13px;margin:0 0 12px;">¬°Son <strong style="color:#2ecc71;">$100 d√≥lares</strong> directo a tu bolsillo! üí∞</p>
          <button onclick="shareRefWhatsApp()" style="padding:14px 28px;border:none;border-radius:12px;background:linear-gradient(135deg,#25D366,#128C7E);color:white;font-weight:bold;font-size:15px;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='none'">üì± ¬°Compartir Ahora por WhatsApp!</button>
        </div>

        <button class="btn btn-secondary" onclick="showScreen('welcomeScreen')" style="margin-top:8px;margin-bottom:20px;">‚Üê Volver al Men√∫</button>
      </div>
    </div>

    <!-- Register Screen -->
    <div class="screen" id="registerScreen">
      <div class="header">
        <div class="logo"><img src="logo.png" alt="ACVOLT" style="width:60px;height:60px;object-fit:contain;border-radius:10px;background:rgba(255,255,255,0.9);padding:3px;" onerror="this.parentElement.textContent='üìù'"></div>
        <h1>MAESTRO ACVOLT</h1>
        <h2>Crear Cuenta Gratis</h2>
        <p class="subtitle">Acceso al Nivel 1 Principiante gratis</p>
      </div>
      <div class="card" style="max-height:80vh;overflow-y:auto;">
        <div class="login-error" id="registerError">Error al registrar</div>
        <form id="newRegisterForm" onsubmit="return handleRegister(event)">
          <div class="form-group">
            <label>Nombre Completo *</label>
            <input type="text" id="regName" placeholder="Nombre y Apellido" required minlength="3">
          </div>
          <div class="form-group">
            <label>Correo Electr√≥nico *</label>
            <input type="email" id="regEmail" placeholder="tucorreo@ejemplo.com" required>
          </div>
          <div class="form-group">
            <label>Tel√©fono *</label>
            <input type="tel" id="regPhone" placeholder="(000) 000-0000" required minlength="7">
          </div>
          <div class="form-group">
            <label>Ciudad / Estado *</label>
            <input type="text" id="regCity" placeholder="Ej: Los Angeles, CA" required minlength="3">
          </div>
          <div class="form-group">
            <label>A√±os de Experiencia en HVAC *</label>
            <select id="regExperience" required>
              <option value="">-- Selecciona --</option>
              <option value="Estudiante">Estudiante (sin experiencia)</option>
              <option value="0-2 a√±os">0-2 a√±os</option>
              <option value="3-5 a√±os">3-5 a√±os</option>
              <option value="6-10 a√±os">6-10 a√±os</option>
              <option value="10+ a√±os">10+ a√±os</option>
              <option value="20+ a√±os">20+ a√±os</option>
            </select>
          </div>
          <p style="color:#f39c12;font-size:12px;margin:10px 0 5px;text-align:center;">Certificaciones (opcional - si las tienes)</p>
          <div class="form-group">
            <label>N√∫mero EPA 608</label>
            <input type="text" id="regEPA" placeholder="Opcional">
          </div>
          <div class="form-group">
            <label>N√∫mero OSHA</label>
            <input type="text" id="regOSHA" placeholder="Opcional">
          </div>
          <div class="form-group">
            <label>HVAC Excellence / NATE</label>
            <input type="text" id="regHVACE" placeholder="Opcional">
          </div>
          <div class="form-group">
            <label>Contrase√±a *</label>
            <input type="password" id="regPassword" placeholder="M√≠nimo 6 caracteres" required minlength="6">
          </div>
          <div class="form-group">
            <label>Confirmar Contrase√±a *</label>
            <input type="password" id="regPasswordConfirm" placeholder="Repite tu contrase√±a" required minlength="6">
          </div>
          <!-- Terms Checkbox for Registration -->
          <div style="margin:15px 0; padding:12px; background:rgba(243,156,18,0.1); border-radius:10px; border:1px solid rgba(243,156,18,0.3);">
            <label style="display:flex; align-items:flex-start; gap:10px; cursor:pointer; font-size:12px; color:#64748b;">
              <input type="checkbox" id="registerTermsCheckbox" style="margin-top:3px; width:18px; height:18px; cursor:pointer;" required>
              <span>Al registrarme, acepto los <a href="terms.html" target="_blank" style="color:#E31937; font-weight:bold;">T√©rminos de Servicio</a>, la <a href="privacy.html" target="_blank" style="color:#E31937; font-weight:bold;">Pol√≠tica de Privacidad</a>. Entiendo que el <strong>periodo gratis es de 30 d√≠as</strong> y despu√©s requiere suscripci√≥n ($20/mes o $200/a√±o).</span>
            </label>
          </div>
          <button type="submit" class="btn btn-primary">Crear Cuenta</button>
        </form>
        <div style="text-align:center; margin-top:20px; padding-top:15px; border-top:2px solid rgba(243,156,18,0.3);">
          <p style="color:#94a3b8; font-size:15px; margin-bottom:10px;">¬øYa tienes cuenta?</p>
          <button class="btn btn-primary" onclick="showScreen('loginScreen')" style="background: linear-gradient(135deg, #f39c12, #e67e22); font-size:16px; padding:14px; width:100%; font-weight:bold;">üîë INICIAR SESI√ìN</button>
        </div>
      </div>
    </div>

    <!-- Email Confirmation Pending Screen -->
    <div class="screen" id="emailPendingScreen">
      <div class="header">
        <div class="logo"><img src="logo.png" alt="ACVOLT" style="width:60px;height:60px;object-fit:contain;border-radius:10px;background:rgba(255,255,255,0.9);padding:3px;" onerror="this.parentElement.textContent='üìß'"></div>
        <h1>MAESTRO ACVOLT</h1>
        <h2>Confirma tu Correo</h2>
      </div>
      <div class="card" style="text-align:center;">
        <div style="font-size:60px;margin-bottom:15px;">üì¨</div>
        <h3 style="color:#f39c12;margin-bottom:10px;">¬°Revisa tu correo electr√≥nico!</h3>
        <p style="color:#64748b;font-size:14px;margin-bottom:15px;" id="pendingEmailText">Te enviamos un link de confirmaci√≥n a tu correo.</p>
        <div style="background:rgba(243,156,18,0.15);border:1px solid rgba(243,156,18,0.4);border-radius:12px;padding:15px;margin-bottom:15px;">
          <p style="color:#1e293b;font-size:14px;font-weight:bold;margin-bottom:8px;">üìå Sigue estos pasos:</p>
          <p style="color:#64748b;font-size:13px;margin-top:8px;">1Ô∏è‚É£ Abre tu correo electr√≥nico (Gmail, Outlook, Yahoo, etc.)</p>
          <p style="color:#64748b;font-size:13px;">2Ô∏è‚É£ Busca un email de <strong style="color:#f39c12;">ACVOLT Tech School</strong> o <strong style="color:#f39c12;">noreply@</strong></p>
          <p style="color:#64748b;font-size:13px;">3Ô∏è‚É£ Haz click en el bot√≥n o link de confirmaci√≥n</p>
          <p style="color:#64748b;font-size:13px;">4Ô∏è‚É£ Regresa aqu√≠ e inicia sesi√≥n con tu correo y contrase√±a</p>
        </div>
        <div style="background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.3);border-radius:12px;padding:12px;margin-bottom:15px;">
          <p style="color:#e74c3c;font-size:13px;font-weight:bold;">‚ö†Ô∏è ¬øNo encuentras el correo?</p>
          <p style="color:#64748b;font-size:12px;margin-top:5px;">‚Ä¢ Revisa tu carpeta de <strong>SPAM</strong> o <strong>Correo no deseado</strong></p>
          <p style="color:#64748b;font-size:12px;">‚Ä¢ En Gmail: revisa la pesta√±a <strong>"Promociones"</strong> o <strong>"Social"</strong></p>
          <p style="color:#64748b;font-size:12px;">‚Ä¢ Espera 2-3 minutos y vuelve a revisar</p>
        </div>
        <button class="btn btn-primary" onclick="showScreen('loginScreen')" style="margin-bottom:8px;">üîë Ya confirm√© ‚Äî Ir al Login</button>
        <button class="btn btn-secondary" onclick="resendConfirmation()" style="margin-top:8px;font-size:13px;">üìß Reenviar correo de confirmaci√≥n</button>
        <div style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(243,156,18,0.2);">
          <p style="color:#94a3b8;font-size:12px;margin-bottom:8px;">¬øSigues sin recibir el correo? Intenta entrar sin contrase√±a:</p>
          <button class="btn btn-secondary" onclick="pendingRegEmail && sendMagicLinkDirect(pendingRegEmail); this.textContent='‚úÖ Link enviado! Revisa tu correo'" style="background:linear-gradient(135deg,#9b59b6,#8e44ad);color:white;font-size:13px;padding:10px;">‚ú® Recibir Link de Acceso Directo</button>
        </div>
      </div>
    </div>

    <!-- Admin Login Screen -->
    <!-- Membership Login Screen -->
    <!-- Membership Zone Screen - Clases en Vivo -->
    <div class="screen" id="membershipZoneScreen">
      <div class="header">
        <div class="logo">üé•</div>
        <h1>Clases en Vivo</h1>
        <h2 style="color:#9b59b6;" id="memberTierTitle">Verificando membres√≠a...</h2>
        <p class="subtitle" id="memberWelcomeName">Bienvenido</p>
      </div>

      <!-- Loading state -->
      <div id="membershipLoading" class="card" style="text-align:center; padding:40px;">
        <div style="font-size:40px; margin-bottom:15px;">‚è≥</div>
        <p style="color:#64748b;">Verificando tu membres√≠a...</p>
      </div>

      <!-- Active membership content -->
      <div id="membershipActiveContent" style="display:none;">
        <!-- Webinars en Vivo -->
        <div class="card" style="background:linear-gradient(135deg,#6c3ce0,#4a1fb8); color:white;">
          <h3 style="margin-bottom:10px;">üé• Webinars en Vivo</h3>
          <p style="font-size:13px; opacity:0.8; margin-bottom:15px;">Accede a tu clase en vivo por Zoom</p>
          <div id="webinarLinksContainer">
            <p style="opacity:0.6; font-size:13px;">Cargando links de webinars...</p>
          </div>
        </div>

        <!-- Clases Pregrabadas -->
        <div class="card">
          <h3 style="margin-bottom:10px; color:#1a1a2e;">üìö Clases Pregrabadas</h3>
          <p style="font-size:13px; color:#64748b; margin-bottom:15px;">Contenido disponible seg√∫n tu nivel de membres√≠a</p>
          <div id="pregrabadoContent">
            <p style="color:#64748b; font-size:13px;">Cargando contenido...</p>
          </div>
        </div>

        <!-- Telegram -->
        <div class="card" style="text-align:center;">
          <button class="btn btn-secondary" onclick="window.open('https://t.me/+Cm9rjthVu8pjMjJh', '_blank')" style="background: linear-gradient(135deg, #0088cc, #005f99); color:white;">‚úàÔ∏è Telegram - Canal Exclusivo</button>
        </div>
      </div>

      <!-- No membership - show payment options -->
      <div id="membershipPaywall" style="display:none;">
        <div class="card" style="text-align:center;">
          <div style="font-size:50px; margin-bottom:15px;">üîí</div>
          <h3 style="margin-bottom:10px;">No tienes membres√≠a activa</h3>
          <p style="color:#64748b; font-size:14px; margin-bottom:20px;">Suscr√≠bete para acceder a clases en vivo y contenido pregrabado exclusivo</p>
          
          <div style="display:grid; grid-template-columns:1fr; gap:12px; text-align:left;">
            <div onclick="window.open('https://buy.stripe.com/9B6cN52rB6tagjd1nV3sI04','_blank')" style="background:linear-gradient(135deg, rgba(205,127,50,0.15), rgba(139,90,43,0.15)); border:2px solid rgba(205,127,50,0.5); border-radius:12px; padding:15px; cursor:pointer;">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <div style="font-weight:bold; font-size:16px;">ü•â Principiante</div>
                  <div style="font-size:12px; color:#64748b; margin-top:4px;">Webinars Nivel 1 + Clases Pregrabadas Nivel 1</div>
                </div>
                <div style="font-weight:bold; font-size:18px; color:#cd7f32;">$119<span style="font-size:12px;">/mes</span></div>
              </div>
            </div>
            <div onclick="window.open('https://buy.stripe.com/7sYcN5d6feZG3wr2rZ3sI0e','_blank')" style="background:linear-gradient(135deg, rgba(192,192,192,0.15), rgba(150,150,150,0.15)); border:2px solid rgba(192,192,192,0.5); border-radius:12px; padding:15px; cursor:pointer;">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <div style="font-weight:bold; font-size:16px;">ü•à Intermedio</div>
                  <div style="font-size:12px; color:#64748b; margin-top:4px;">Todo de Principiante + Webinars y Clases Nivel 2</div>
                </div>
                <div style="font-weight:bold; font-size:18px; color:#999;">$299<span style="font-size:12px;">/mes</span></div>
              </div>
            </div>
            <div onclick="window.open('https://buy.stripe.com/6oU28r3vF5p6aYTaYv3sI0d','_blank')" style="background:linear-gradient(135deg, rgba(255,215,0,0.15), rgba(218,165,32,0.15)); border:2px solid rgba(255,215,0,0.5); border-radius:12px; padding:15px; cursor:pointer; position:relative;">
              <div style="position:absolute; top:-8px; right:10px; background:#e74c3c; color:white; font-size:10px; padding:2px 8px; border-radius:10px; font-weight:bold;">‚≠ê POPULAR</div>
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <div style="font-weight:bold; font-size:16px;">ü•á Avanzado - Mentor√≠a</div>
                  <div style="font-size:12px; color:#64748b; margin-top:4px;">ACCESO TOTAL: Todos los niveles + Mentor√≠a + La Trinidad del Oficio</div>
                </div>
                <div style="font-weight:bold; font-size:18px; color:#daa520;">$699<span style="font-size:12px;">/mes</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Back button -->
      <div style="margin-top:15px;">
        <button class="btn btn-secondary" onclick="showScreen('welcomeScreen')">‚Üê Volver al Men√∫</button>
      </div>
    </div>

    <!-- Admin Login Screen -->
    <div class="screen" id="adminLoginScreen">
      <div class="header">
        <div class="logo">üë®‚Äçüíº</div>
        <h1>Panel de Administrador</h1>
        <h2>Acceso Restringido</h2>
        <p class="subtitle">Solo personal autorizado</p>
      </div>
      <div class="card">
        <div class="login-error" id="adminLoginError">Credenciales de administrador incorrectas</div>
        <form id="adminLoginForm" onsubmit="return handleAdminLogin(event)">
          <div class="form-group">
            <label>Usuario Admin</label>
            <input type="text" id="adminLoginUser" placeholder="Usuario administrador" required>
          </div>
          <div class="form-group">
            <label>Contrase√±a Admin</label>
            <input type="password" id="adminLoginPassword" placeholder="Contrase√±a administrador" required>
          </div>
          <button type="submit" class="btn btn-primary">Acceder al Panel</button>
        </form>
        <button class="btn btn-secondary" onclick="showScreen('loginScreen')">‚Üê Volver al Login</button>
      </div>
    </div>

    <!-- Admin Dashboard Screen -->
    <div class="screen" id="adminDashboardScreen">
      <div class="admin-container">
        <div class="admin-header">
          <div class="admin-title">
            <span style="font-size: 28px;">üë®‚Äçüíº</span>
            <h1>Panel de Administrador</h1>
          </div>
          <button class="back-btn" onclick="adminLogout()">üö™ Cerrar Sesi√≥n</button>
        </div>

        <!-- Landscape message for mobile portrait -->
        <div class="admin-landscape-msg">
          <div class="icon">üì±üîÑ</div>
          <p><strong>Gira tu tel√©fono en modo horizontal</strong><br>para ver el Panel de Administrador completo.</p>
          <p style="font-size:40px; margin-top:20px;">‚Üª</p>
        </div>

        <!-- Main admin content (hidden in mobile portrait) -->
        <div class="admin-main-content">

        <!-- Quick Stats -->
        <div class="admin-stats-grid" id="adminStatsGrid">
          <div class="admin-stat-card" onclick="showStatDetail('tecnicos')" style="cursor:pointer;">
            <div class="admin-stat-value" id="statTotalTecnicos">0</div>
            <div class="admin-stat-label">T√©cnicos Registrados</div>
          </div>
          <div class="admin-stat-card" onclick="showStatDetail('certificados')" style="cursor:pointer;">
            <div class="admin-stat-value" id="statTotalCertificados">0</div>
            <div class="admin-stat-label">Certificados Otorgados</div>
          </div>
          <div class="admin-stat-card" onclick="showStatDetail('promedio')" style="cursor:pointer;">
            <div class="admin-stat-value" id="statPromedioScore">0%</div>
            <div class="admin-stat-label">Promedio General</div>
          </div>
          <div class="admin-stat-card" onclick="showStatDetail('activos')" style="cursor:pointer;">
            <div class="admin-stat-value" id="statActivosHoy">0</div>
            <div class="admin-stat-label">Activos Hoy</div>
          </div>
        </div>

        <!-- Stat Detail Modal -->
        <div id="statDetailPanel" style="display:none;background:rgba(255,255,255,0.08);border-radius:12px;padding:15px;margin-bottom:15px;border:1px solid rgba(243,156,18,0.3);">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <h3 id="statDetailTitle" style="color:#f39c12;font-size:15px;margin:0;"></h3>
            <button onclick="document.getElementById('statDetailPanel').style.display='none'" style="background:none;border:none;color:#64748b;font-size:18px;cursor:pointer;">‚úï</button>
          </div>
          <div id="statDetailContent"></div>
        </div>

        
        <!-- ============ NAVEGACI√ìN R√ÅPIDA ADMIN ============ -->
        <div style="background:#ffffff;border-radius:12px;padding:10px;margin-bottom:15px;display:flex;flex-wrap:wrap;gap:5px;justify-content:center;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
          <button onclick="document.getElementById('adminTecnicos').scrollIntoView({behavior:'smooth'})" class="admin-nav-btn">üë• T√©cnicos</button>
          <button onclick="document.getElementById('adminAsistencia').scrollIntoView({behavior:'smooth'})" class="admin-nav-btn">üìã Asistencia</button>
          <button onclick="document.getElementById('adminStudentSuccess').scrollIntoView({behavior:'smooth'})" class="admin-nav-btn">üé´ Success</button>
          <button onclick="document.getElementById('adminFinanzas').scrollIntoView({behavior:'smooth'})" class="admin-nav-btn">üí∞ Finanzas</button>
          <button onclick="document.getElementById('adminReferidos').scrollIntoView({behavior:'smooth'})" class="admin-nav-btn">ü§ù Embajadores</button>
          <button onclick="document.getElementById('adminCalendario').scrollIntoView({behavior:'smooth'})" class="admin-nav-btn">üìÖ Clases</button>
          <button onclick="document.getElementById('adminWeeklyEmails').scrollIntoView({behavior:'smooth'})" class="admin-nav-btn">üìß Emails</button>
          <button onclick="document.getElementById('adminAnalytics').scrollIntoView({behavior:'smooth'})" class="admin-nav-btn">üìä Analytics</button>
          <button onclick="document.getElementById('adminCertificados').scrollIntoView({behavior:'smooth'})" class="admin-nav-btn">üèÜ Certificados</button>
          <button onclick="document.getElementById('adminInactivityAlerts').scrollIntoView({behavior:'smooth'})" class="admin-nav-btn">‚ö†Ô∏è Alertas</button>
        </div>

<!-- ============ BANDEJA DE ENTRADA DEL ADMINISTRADOR ============ -->
        <div class="admin-section admin-grid-full" style="background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
            <h3 style="color: #e74c3c; font-size: 1.3em; display: flex; align-items: center; gap: 10px;">
              üì• Bandeja de Entrada
              <span id="inboxTotalCount" style="background: #e74c3c; color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 0.7em;">0 nuevos</span>
            </h3>
            <button onclick="loadAdminInbox()" style="padding: 8px 15px; background: #e74c3c; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üîÑ Actualizar</button>
          </div>

          <!-- Filtros de la Bandeja -->
          <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;">
            <button onclick="filterInbox('all')" id="inboxFilterAll" class="inbox-filter-btn active" style="padding: 8px 15px; background: #f39c12; color: #000; border: none; border-radius: 20px; cursor: pointer; font-size: 0.85em; font-weight: bold;">üì¨ Todos</button>
            <button onclick="filterInbox('tareas')" id="inboxFilterTareas" class="inbox-filter-btn" style="padding: 8px 15px; background: rgba(255,255,255,0.1); color: #fff; border: none; border-radius: 20px; cursor: pointer; font-size: 0.85em;">üìù Tareas <span id="countTareas" style="background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:10px;margin-left:5px;">0</span></button>
            <button onclick="filterInbox('pagos')" id="inboxFilterPagos" class="inbox-filter-btn" style="padding: 8px 15px; background: rgba(255,255,255,0.1); color: #fff; border: none; border-radius: 20px; cursor: pointer; font-size: 0.85em;">üí∞ Pagos <span id="countPagos" style="background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:10px;margin-left:5px;">0</span></button>
            <button onclick="filterInbox('taxes')" id="inboxFilterTaxes" class="inbox-filter-btn" style="padding: 8px 15px; background: rgba(255,255,255,0.1); color: #fff; border: none; border-radius: 20px; cursor: pointer; font-size: 0.85em;">üìÑ Taxes <span id="countTaxes" style="background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:10px;margin-left:5px;">0</span></button>
            <button onclick="filterInbox('renovaciones')" id="inboxFilterRenovaciones" class="inbox-filter-btn" style="padding: 8px 15px; background: rgba(255,255,255,0.1); color: #fff; border: none; border-radius: 20px; cursor: pointer; font-size: 0.85em;">üèÖ Renovaciones <span id="countRenovaciones" style="background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:10px;margin-left:5px;">0</span></button>
          </div>

          <!-- Lista de Items de la Bandeja -->
          <div id="adminInboxList" style="max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 10px;">
            <div style="color: #888; text-align: center; padding: 40px;">
              <div style="font-size: 3em; margin-bottom: 15px;">üì≠</div>
              <p>Cargando bandeja de entrada...</p>
            </div>
          </div>

          <!-- Acciones R√°pidas -->
          <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
            <button onclick="markAllAsRead()" style="padding: 8px 15px; background: rgba(46,204,113,0.2); color: #2ecc71; border: 1px solid #2ecc71; border-radius: 6px; cursor: pointer; font-size: 0.85em;">‚úÖ Marcar todo como le√≠do</button>
            <button onclick="exportInboxToCSV()" style="padding: 8px 15px; background: rgba(52,152,219,0.2); color: #3498db; border: 1px solid #3498db; border-radius: 6px; cursor: pointer; font-size: 0.85em;">üì• Exportar a CSV</button>
          </div>
        </div>
        <!-- ============ FIN BANDEJA DE ENTRADA ============ -->

        <!-- 2 Column Grid Layout -->
        <div class="admin-grid-2col">

        <!-- Technicians List Section -->
        <div class="admin-section admin-grid-full" id="adminTecnicos">
          <div class="admin-section-header">
            <span class="admin-section-title">üë• T√©cnicos Inscritos</span>
            <span id="technicianCount" style="color: #64748b; font-size: 14px;">0 t√©cnicos</span>
          </div>
          <div class="admin-filter-bar">
            <input type="text" class="admin-filter-input" id="searchTechnician" placeholder="üîç Buscar por nombre, email o n√∫mero..." oninput="filterTechnicians()">
            <select class="admin-filter-select" id="filterPeriod" onchange="filterTechnicians()">
              <option value="all">Todos los per√≠odos</option>
              <option value="today">Hoy</option>
              <option value="week">Esta semana</option>
              <option value="month">Este mes</option>
            </select>
          </div>
          <div class="technician-list" id="technicianList">
            <div class="no-data-message">
              <div class="no-data-icon">üë•</div>
              <p>No hay t√©cnicos registrados a√∫n.</p>
            </div>
          </div>
        </div>

        <!-- Activity Chart -->
        <div class="admin-section admin-grid-full" id="adminRendimiento">
          <div class="admin-section-header">
            <span class="admin-section-title">üìä Rendimiento por Nivel</span>
          </div>
          <div class="admin-chart" id="levelPerformanceChart">
            <div class="admin-bar-chart" id="levelBarChart"></div>
          </div>
        </div>

        <!-- ===== SECCI√ìN ASISTENCIA ADMIN ===== -->
        <div class="admin-section admin-grid-full" id="adminAsistencia">
          <div class="admin-section-header">
            <span class="admin-section-title">üìã Control de Asistencia</span>
          </div>
          <div class="admin-attendance-grid">
            <div class="admin-att-card">
              <h4><span class="live-indicator"></span> En Clase Ahora</h4>
              <div class="admin-att-stat" id="adminLiveCount">0</div>
              <div class="admin-att-label">t√©cnicos activos</div>
            </div>
            <div class="admin-att-card">
              <h4>üìÖ Asistencia Hoy</h4>
              <div class="admin-att-stat" id="adminTodayCount">0</div>
              <div class="admin-att-label">check-ins hoy</div>
            </div>
            <div class="admin-att-card">
              <h4>‚è±Ô∏è Horas Semana</h4>
              <div class="admin-att-stat" id="adminWeekHours">0</div>
              <div class="admin-att-label">horas totales</div>
            </div>
          </div>
          <div class="filter-bar">
            <select id="adminAttFilter" onchange="loadAdminAttendance()">
              <option value="today">Hoy</option>
              <option value="week">Esta Semana</option>
              <option value="month">Este Mes</option>
              <option value="all">Todo</option>
            </select>
            <select id="adminAttTypeFilter" onchange="loadAdminAttendance()">
              <option value="all">Todos los tipos</option>
              <option value="presencial">Presencial</option>
              <option value="zoom">Zoom</option>
              <option value="computadora">Computadora</option>
              <option value="movil">M√≥vil</option>
            </select>
          </div>
          <div style="overflow-x:auto;">
            <table class="attendance-table">
              <thead>
                <tr>
                  <th>T√©cnico</th>
                  <th>Tipo</th>
                  <th>Check-in</th>
                  <th>Check-out</th>
                  <th>Horas</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody id="adminAttendanceBody">
                <tr><td colspan="6" style="text-align:center; color:#888;">Cargando...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ===== EX√ÅMENES SOLICITADOS ===== -->
        <div class="admin-section">
          <div class="admin-section-header">
            <span class="admin-section-title">üéì Ex√°menes Solicitados</span>
            <span id="examRequestCount" style="color:#64748b; font-size:14px;">0 solicitudes</span>
          </div>
          <div id="adminExamRequestsList" style="max-height:400px; overflow-y:auto;">
            <div class="no-data-message">
              <div class="no-data-icon">üéì</div>
              <p>No hay solicitudes de examen a√∫n.</p>
            </div>
          </div>
        </div>

        <!-- ===== ACTIVIDAD DE ESTUDIANTES ===== -->
        <div class="admin-section">
          <div class="admin-section-header">
            <span class="admin-section-title">üìä Actividad de Estudiantes</span>
            <button onclick="loadAdminStudentActivity()" style="background:#f39c12;color:white;border:none;padding:6px 12px;border-radius:8px;font-size:12px;cursor:pointer;">üîÑ Actualizar</button>
          </div>
          <div id="adminStudentActivityList" style="max-height:500px; overflow-y:auto;">
            <div class="no-data-message">
              <div class="no-data-icon">üìä</div>
              <p>Cargando actividad...</p>
            </div>
          </div>
        </div>

        
        <!-- ===== CREAR USUARIOS SECTION ===== -->
        <div class="admin-section admin-grid-full" style="background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
            <h3 style="color: #27ae60; font-size: 1.3em; margin-bottom: 15px;">üë§ Crear Nuevo Usuario</h3>
            <p style="color: #888; font-size: 13px; margin-bottom: 15px;">Crea una cuenta para un estudiante y le llegara un correo con sus credenciales automaticamente.</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="color: #27ae60; font-size: 12px; display: block; margin-bottom: 5px;">Nombre Completo *</label>
                    <input type="text" id="createUserName" placeholder="Juan Perez" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff; box-sizing: border-box;">
                </div>
                <div>
                    <label style="color: #27ae60; font-size: 12px; display: block; margin-bottom: 5px;">Email *</label>
                    <input type="email" id="createUserEmail" placeholder="correo@ejemplo.com" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff; box-sizing: border-box;">
                </div>
                <div>
                    <label style="color: #27ae60; font-size: 12px; display: block; margin-bottom: 5px;">Telefono</label>
                    <input type="tel" id="createUserPhone" placeholder="(000) 000-0000" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff; box-sizing: border-box;">
                </div>
                <div>
                    <label style="color: #27ae60; font-size: 12px; display: block; margin-bottom: 5px;">Contrasena *</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="createUserPassword" placeholder="Min 6 caracteres" style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff; box-sizing: border-box;">
                        <button onclick="generateRandomPassword()" style="padding: 12px; background: #444; color: #fff; border: none; border-radius: 8px; cursor: pointer;" title="Generar contrasena">üé≤</button>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <button onclick="createNewUser()" style="padding: 12px 25px; background: linear-gradient(135deg, #27ae60, #2ecc71); color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px;">üë§ CREAR USUARIO Y ENVIAR CORREO</button>
                <div id="createUserMsg" style="color: #888; font-size: 14px;"></div>
            </div>
            
            <!-- Lista de usuarios creados recientemente -->
            <div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 15px;">
                <h4 style="color: #27ae60; font-size: 14px; margin-bottom: 10px;">üìã Usuarios Creados Recientemente</h4>
                <div id="recentCreatedUsers" style="color: #888; font-size: 13px;">No hay usuarios creados en esta sesion.</div>
            </div>
        </div>

        <!-- Centro de Mando Section -->
        <div class="admin-section admin-grid-full" style="background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
            <h3 style="color: #f39c12; font-size: 1.3em; margin-bottom: 15px;">üéØ Centro de Mando</h3>
            
            <!-- Generar C√≥digo Manual -->
            <div style="background: rgba(243,156,18,0.1); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <h4 style="color: #f39c12; margin-bottom: 10px;">üîë Generar C√≥digo de Acceso</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="manualCodeName" placeholder="Nombre del t√©cnico" style="flex: 1; min-width: 150px; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff;">
                    <input type="email" id="manualCodeEmail" placeholder="Email del t√©cnico" style="flex: 1; min-width: 150px; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff;">
                    <select id="manualCodeLevel" style="padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff; min-width: 150px;">
                        <option value="full_app">üîì App Completa</option>
                        <option value="principiante">üîß Principiante</option>
                        <option value="intermedio">üìä Intermedio</option>
                        <option value="avanzado">‚ö° Avanzado</option>
                        <option value="elite">üèÜ Elite</option>
                        <option value="platino">üíé Platino</option>
                        <option value="clases_vivo">üé¨ Clases en Vivo</option>
                    </select>
                    <select id="manualCodeDuration" style="padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff;">
                        <option value="30">30 d√≠as</option>
                        <option value="90">90 d√≠as</option>
                        <option value="180">6 meses</option>
                        <option value="365">1 a√±o</option>
                        <option value="lifetime">De por vida</option>
                    </select>
                    <button onclick="generateManualAccessCode()" style="padding: 10px 20px; background: #f39c12; color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; white-space: nowrap;">‚ö° GENERAR C√ìDIGO</button>
                </div>
                <div id="generatedCodeDisplay" style="margin-top: 10px; display: none; background: rgba(46,204,113,0.15); border: 1px solid #2ecc71; border-radius: 8px; padding: 12px; text-align: center;">
                    <span style="color: #2ecc71; font-size: 0.9em;">C√≥digo generado:</span>
                    <div id="generatedCodeValue" style="color: #2ecc71; font-size: 1.5em; font-weight: bold; letter-spacing: 3px; margin: 5px 0;"></div>
                    <button onclick="copyGeneratedCode()" style="padding: 6px 15px; background: #2ecc71; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üìã Copiar C√≥digo</button>
                </div>
            </div>

            <!-- Solicitudes de Acceso -->
            <div style="background: rgba(52,152,219,0.1); border-radius: 12px; padding: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #3498db;">üìã Solicitudes de T√©cnicos</h4>
                    <button onclick="renderAccessCodes()" style="padding: 6px 15px; background: #3498db; color: #fff; border: none; border-radius: 6px; cursor: pointer;">üîÑ Actualizar</button>
                </div>
                <div id="accessCodesList" style="color: #ccc;">Cargando solicitudes...</div>
            </div>

            <!-- C√≥digos Activos -->
            <div style="background: rgba(46,204,113,0.1); border-radius: 12px; padding: 15px; margin-top: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #2ecc71;">‚úÖ C√≥digos Activos</h4>
                    <button onclick="loadActiveCodes()" style="padding: 6px 15px; background: #2ecc71; color: #000; border: none; border-radius: 6px; cursor: pointer;">üîÑ Actualizar</button>
                </div>
                <div id="activeCodesList" style="color: #ccc;">Cargando c√≥digos activos...</div>
            </div>

            <!-- ============ BATCH EMAIL SECTION ============ -->
            <div style="background: linear-gradient(135deg, rgba(155,89,182,0.2) 0%, rgba(142,68,173,0.15) 100%); border-radius: 12px; padding: 20px; margin-top: 20px; border: 1px solid rgba(155,89,182,0.4);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h4 style="color: #9b59b6; font-size: 1.2em;">üìß Env√≠o Masivo de C√≥digos (Batch)</h4>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span id="batchSelectedCount" style="color: #9b59b6; font-size: 0.9em; font-weight: bold;">0 seleccionados</span>
                        <button onclick="loadStudentsForBatch()" style="padding: 8px 15px; background: #9b59b6; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üîÑ Cargar Estudiantes</button>
                    </div>
                </div>
                
                <!-- Batch Controls -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; align-items: center;">
                    <input type="text" id="batchSearchStudent" placeholder="üîç Buscar estudiante..." oninput="filterBatchStudents()" style="flex: 1; min-width: 180px; padding: 10px; border-radius: 8px; border: 1px solid #666; background: #1a1a2e; color: #fff;">
                    <select id="batchCodeLevel" style="padding: 10px; border-radius: 8px; border: 1px solid #666; background: #1a1a2e; color: #fff;">
                        <option value="clases_vivo">üé¨ Clases en Vivo (Zoom)</option>
                        <option value="full_app">üîì App Completa</option>
                        <option value="principiante">üîß Principiante</option>
                        <option value="intermedio">üìä Intermedio</option>
                        <option value="avanzado">‚ö° Avanzado</option>
                    </select>
                    <select id="batchCodeDuration" style="padding: 10px; border-radius: 8px; border: 1px solid #666; background: #1a1a2e; color: #fff;">
                        <option value="7">7 d√≠as</option>
                        <option value="30" selected>30 d√≠as</option>
                        <option value="90">90 d√≠as</option>
                    </select>
                </div>

                <!-- Quick Select Buttons -->
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;">
                    <button onclick="selectBatchStudents(20)" style="padding: 6px 12px; background: rgba(155,89,182,0.3); color: #d4a5ff; border: 1px solid #9b59b6; border-radius: 6px; cursor: pointer; font-size: 0.85em;">Seleccionar 20</button>
                    <button onclick="selectBatchStudents(50)" style="padding: 6px 12px; background: rgba(155,89,182,0.3); color: #d4a5ff; border: 1px solid #9b59b6; border-radius: 6px; cursor: pointer; font-size: 0.85em;">Seleccionar 50</button>
                    <button onclick="selectAllBatchStudents()" style="padding: 6px 12px; background: rgba(155,89,182,0.3); color: #d4a5ff; border: 1px solid #9b59b6; border-radius: 6px; cursor: pointer; font-size: 0.85em;">Seleccionar Todos</button>
                    <button onclick="deselectAllBatchStudents()" style="padding: 6px 12px; background: rgba(231,76,60,0.3); color: #ff8a80; border: 1px solid #e74c3c; border-radius: 6px; cursor: pointer; font-size: 0.85em;">‚ùå Deseleccionar</button>
                </div>

                <!-- Student List with Checkboxes -->
                <div id="batchStudentList" style="max-height: 350px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                    <div style="color: #888; text-align: center; padding: 30px;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üë•</div>
                        <p>Haz clic en "Cargar Estudiantes" para ver la lista</p>
                    </div>
                </div>

                <!-- Batch Actions -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: space-between; align-items: center;">
                    <div style="color: #aaa; font-size: 0.85em;">
                        üí° <strong>Tip:</strong> Selecciona hasta 20 estudiantes por batch para mejor deliverabilidad de emails
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="generateBatchCodes()" style="padding: 12px 25px; background: linear-gradient(135deg, #9b59b6, #8e44ad); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em;">
                            üîë Generar C√≥digos para Seleccionados
                        </button>
                    </div>
                </div>

                <!-- Generated Codes Results -->
                <div id="batchCodesResult" style="display: none; margin-top: 15px; background: rgba(46,204,113,0.15); border: 1px solid #2ecc71; border-radius: 8px; padding: 15px;">
                    <h5 style="color: #2ecc71; margin-bottom: 10px;">‚úÖ C√≥digos Generados</h5>
                    <div id="batchCodesContent" style="max-height: 200px; overflow-y: auto;"></div>
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button onclick="copyAllBatchCodes()" style="padding: 10px 20px; background: #2ecc71; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üìã Copiar Todo</button>
                        <button onclick="exportBatchToCSV()" style="padding: 10px 20px; background: #3498db; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üì• Exportar CSV</button>
                        <button onclick="openBatchEmailClient()" style="padding: 10px 20px; background: #e67e22; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üìß Abrir en Email</button>
                    </div>
                </div>
            </div>
            <!-- ============ END BATCH EMAIL SECTION ============ -->
        </div>

        <!-- ============ SECCION: DIAGNOSTICO DE ESTUDIANTES ============ -->
        <div class="admin-section admin-grid-full" style="background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
            <h3 style="color: #e74c3c; font-size: 1.3em; margin-bottom: 15px;">üîç Diagn√≥stico de Estudiantes</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                <button onclick="runStudentDiagnostic()" style="padding: 10px 20px; background: #e74c3c; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">üîç ANALIZAR ESTUDIANTES</button>
                <button onclick="showDiagFilter('all')" class="diag-filter-btn" id="diagFilterAll" style="padding: 8px 16px; background: #3498db; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">üìä Todos</button>
                <button onclick="showDiagFilter('inactive')" class="diag-filter-btn" id="diagFilterInactive" style="padding: 8px 16px; background: transparent; color: #e74c3c; border: 1px solid #e74c3c; border-radius: 8px; cursor: pointer;">üî¥ Sin Actividad</button>
                <button onclick="showDiagFilter('duplicates')" class="diag-filter-btn" id="diagFilterDuplicates" style="padding: 8px 16px; background: transparent; color: #f39c12; border: 1px solid #f39c12; border-radius: 8px; cursor: pointer;">üü° Duplicados</button>
                <button onclick="showDiagFilter('active')" class="diag-filter-btn" id="diagFilterActive" style="padding: 8px 16px; background: transparent; color: #2ecc71; border: 1px solid #2ecc71; border-radius: 8px; cursor: pointer;">üü¢ Activos</button>
            </div>
            <div id="diagStats" style="display: none; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 15px;">
                <div style="background: rgba(52,152,219,0.15); border-radius: 10px; padding: 12px; text-align: center;">
                    <div id="diagTotalCount" style="font-size: 1.8em; font-weight: bold; color: #3498db;">-</div>
                    <div style="font-size: 0.8em; color: #94a3b8;">Total Registrados</div>
                </div>
                <div style="background: rgba(46,204,113,0.15); border-radius: 10px; padding: 12px; text-align: center;">
                    <div id="diagActiveCount" style="font-size: 1.8em; font-weight: bold; color: #2ecc71;">-</div>
                    <div style="font-size: 0.8em; color: #94a3b8;">Activos</div>
                </div>
                <div style="background: rgba(231,76,60,0.15); border-radius: 10px; padding: 12px; text-align: center;">
                    <div id="diagInactiveCount" style="font-size: 1.8em; font-weight: bold; color: #e74c3c;">-</div>
                    <div style="font-size: 0.8em; color: #94a3b8;">Sin Actividad</div>
                </div>
                <div style="background: rgba(243,156,18,0.15); border-radius: 10px; padding: 12px; text-align: center;">
                    <div id="diagDuplicateCount" style="font-size: 1.8em; font-weight: bold; color: #f39c12;">-</div>
                    <div style="font-size: 0.8em; color: #94a3b8;">Posibles Duplicados</div>
                </div>
            </div>
            <div id="diagResults" style="color: #ccc;">Presiona "Analizar Estudiantes" para ver el diagn√≥stico</div>
        </div>

        <!-- ============ SECCION: SUBIR LIBROS / PDFs ============ -->
        <div class="admin-section admin-grid-full" style="background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
            <h3 style="color: #3498db; font-size: 1.3em; margin-bottom: 15px;">üìö Libros de Trabajo / Material</h3>
            <div style="background: rgba(52,152,219,0.1); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <h4 style="color: #3498db; margin-bottom: 10px;">üì§ Subir Nuevo Material</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 10px;">
                    <input type="text" id="bookTitle" placeholder="T√≠tulo del libro/material" style="flex: 2; min-width: 200px; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff;">
                    <select id="bookCategory" style="padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff;">
                        <option value="General">üìÅ General</option>
                        <option value="HVAC">‚ùÑÔ∏è HVAC</option>
                        <option value="Refrigeracion">üßä Refrigeraci√≥n</option>
                        <option value="Electrico">‚ö° El√©ctrico</option>
                        <option value="Calefaccion">üî• Calefacci√≥n</option>
                        <option value="Negocio">üíº Negocio</option>
                        <option value="EPA">üåç EPA</option>
                        <option value="NATE">üìã NATE</option>
                    </select>
                </div>
                <textarea id="bookDescription" placeholder="Descripci√≥n (opcional)" rows="2" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff; margin-bottom: 10px; resize: vertical;"></textarea>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <select id="bookAssignTo" style="padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff;">
                        <option value="todos">üë• Todos los estudiantes</option>
                    </select>
                    <label style="padding: 10px 20px; background: #3498db; color: #fff; border-radius: 8px; cursor: pointer; font-weight: bold; display: inline-block;">
                        üìé Seleccionar Archivo
                        <input type="file" id="bookFileInput" accept=".pdf,.doc,.docx,.xlsx,.pptx,.jpg,.png" style="display: none;" onchange="previewBookFile(this)">
                    </label>
                    <span id="bookFileName" style="color: #94a3b8; font-size: 0.85em;">Ning√∫n archivo seleccionado</span>
                    <button onclick="uploadBook()" style="padding: 10px 20px; background: #2ecc71; color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">üì§ SUBIR MATERIAL</button>
                </div>
                <div id="bookUploadProgress" style="display: none; margin-top: 10px;">
                    <div style="background: #333; border-radius: 8px; overflow: hidden; height: 8px;">
                        <div id="bookProgressBar" style="width: 0%; height: 100%; background: #3498db; transition: width 0.3s;"></div>
                    </div>
                    <span id="bookUploadStatus" style="color: #3498db; font-size: 0.85em;">Subiendo...</span>
                </div>
            </div>
            <div style="background: rgba(52,152,219,0.05); border-radius: 12px; padding: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #3498db;">üìñ Material Disponible</h4>
                    <button onclick="loadAdminBooks()" style="padding: 6px 15px; background: #3498db; color: #fff; border: none; border-radius: 6px; cursor: pointer;">üîÑ Actualizar</button>
                </div>
                <div id="adminBooksList" style="color: #ccc;">Cargando libros...</div>
            </div>
        </div>

        <!-- ============ SECCION: ASIGNAR EXAMENES ============ -->
        <div class="admin-section admin-grid-full" style="background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
            <h3 style="color: #9b59b6; font-size: 1.3em; margin-bottom: 15px;">üìù Asignar Ex√°menes</h3>
            <div style="background: rgba(155,89,182,0.1); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <h4 style="color: #9b59b6; margin-bottom: 10px;">‚ûï Nuevo Examen</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 10px;">
                    <select id="examStudentEmail" style="flex: 1; min-width: 200px; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff;">
                        <option value="">Seleccionar estudiante...</option>
                    </select>
                    <input type="text" id="examTitle" placeholder="T√≠tulo del examen" style="flex: 1; min-width: 200px; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff;">
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 10px;">
                    <textarea id="examDescription" placeholder="Instrucciones / descripci√≥n del examen" rows="2" style="flex: 2; min-width: 250px; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff; resize: vertical;"></textarea>
                    <input type="date" id="examDeadline" style="padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff;">
                </div>
                <button onclick="assignExam()" style="padding: 10px 20px; background: #9b59b6; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">üìù ASIGNAR EXAMEN</button>
            </div>
            <div style="background: rgba(155,89,182,0.05); border-radius: 12px; padding: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #9b59b6;">üìã Ex√°menes Asignados</h4>
                    <button onclick="loadAdminExams()" style="padding: 6px 15px; background: #9b59b6; color: #fff; border: none; border-radius: 6px; cursor: pointer;">üîÑ Actualizar</button>
                </div>
                <div id="adminExamsList" style="color: #ccc;">Cargando ex√°menes...</div>
            </div>
        </div>

        <!-- ============ SECCION: RECORDS DE PAGOS / TAXES ============ -->
        <div class="admin-section admin-grid-full" style="background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
            <h3 style="color: #2ecc71; font-size: 1.3em; margin-bottom: 15px;">üí≥ Records de Pagos / Taxes</h3>
            <div style="background: rgba(46,204,113,0.1); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <h4 style="color: #2ecc71; margin-bottom: 10px;">‚ûï Registrar Pago Manual</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 10px;">
                    <select id="paymentStudentEmail" style="flex: 1; min-width: 200px; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff;">
                        <option value="">Seleccionar estudiante...</option>
                    </select>
                    <input type="number" id="paymentAmount" placeholder="Monto $" step="0.01" style="width: 120px; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff;">
                    <input type="text" id="paymentConcept" placeholder="Concepto (ej: Tuici√≥n Marzo)" style="flex: 1; min-width: 200px; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff;">
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <select id="paymentMethod" style="padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff;">
                        <option value="efectivo">üíµ Efectivo</option>
                        <option value="stripe">üí≥ Stripe</option>
                        <option value="zelle">üì± Zelle</option>
                        <option value="check">üè¶ Check</option>
                        <option value="otro">üìù Otro</option>
                    </select>
                    <input type="text" id="paymentNote" placeholder="Nota (opcional)" style="flex: 1; min-width: 150px; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: #fff;">
                    <button onclick="registerPayment()" style="padding: 10px 20px; background: #2ecc71; color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">üí∞ REGISTRAR PAGO</button>
                </div>
            </div>
            <div style="background: rgba(46,204,113,0.05); border-radius: 12px; padding: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #2ecc71;">üìä Historial de Pagos</h4>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="paymentSearchEmail" placeholder="Buscar por email..." style="padding: 6px 12px; border-radius: 6px; border: 1px solid #444; background: #1a1a2e; color: #fff; font-size: 0.85em;">
                        <button onclick="loadAdminPayments()" style="padding: 6px 15px; background: #2ecc71; color: #000; border: none; border-radius: 6px; cursor: pointer;">üîÑ</button>
                    </div>
                </div>
                <div id="adminPaymentsList" style="color: #ccc;">Cargando pagos...</div>
            </div>
        </div>

        </div><!-- close admin-grid-2col -->
        </div><!-- close admin-main-content -->


        <!-- ========== STUDENT SUCCESS - CRM & SURVEY SECTION ========== -->
        <div class="admin-section admin-grid-full" id="adminStudentSuccess" style="background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
          <div class="admin-section-header">
            <span class="admin-section-title">üé´ Student Success</span>
            <div style="display:flex;gap:6px;flex-wrap:wrap;">
              <button onclick="ssShowTab('tickets')" id="ssTabTickets" style="background:#fef2f2;padding:6px 12px;border-radius:8px;color:#dc2626;border:1px solid #fecaca;cursor:pointer;font-size:11px;">üî¥ Cobros Fallidos</button>
              <button onclick="ssShowTab('surveys')" id="ssTabSurveys" style="background:#eff6ff;padding:6px 12px;border-radius:8px;color:#2563eb;border:1px solid #bfdbfe;cursor:pointer;font-size:11px;">üìã Surveys</button>
              <button onclick="ssShowTab('newsurvey')" id="ssTabNew" style="background:#f0fdf4;padding:6px 12px;border-radius:8px;color:#16a34a;border:1px solid #bbf7d0;cursor:pointer;font-size:11px;">‚ûï Nuevo Survey</button>
              <button onclick="ssShowTab('staff')" id="ssTabStaff" class="ssStaffOnly" style="background:#fffbeb;padding:6px 12px;border-radius:8px;color:#d97706;border:1px solid #fde68a;cursor:pointer;font-size:11px;">üë• Staff</button>
            </div>
          </div>

          <!-- Stats Cards -->
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:15px;">
            <div style="background:#ffffff;border-radius:12px;padding:12px;text-align:center;border:1px solid #e2e8f0;">
              <div style="font-size:24px;font-weight:bold;color:#dc2626;" id="ssOpenCount">0</div>
              <div style="font-size:11px;color:#64748b;">Cobros Fallidos</div>
            </div>
            <div style="background:#ffffff;border-radius:12px;padding:12px;text-align:center;border:1px solid #e2e8f0;">
              <div style="font-size:24px;font-weight:bold;color:#2563eb;" id="ssSurveyCount">0</div>
              <div style="font-size:11px;color:#64748b;">Surveys Hechos</div>
            </div>
            <div style="background:#ffffff;border-radius:12px;padding:12px;text-align:center;border:1px solid #e2e8f0;">
              <div style="font-size:24px;font-weight:bold;color:#d97706;" id="ssCancelCount">0</div>
              <div style="font-size:11px;color:#64748b;">Cancelaciones</div>
            </div>
            <div style="background:#ffffff;border-radius:12px;padding:12px;text-align:center;border:1px solid #e2e8f0;">
              <div style="font-size:24px;font-weight:bold;color:#16a34a;" id="ssCertCount">0</div>
              <div style="font-size:11px;color:#64748b;">Con Certificado</div>
            </div>
          </div>

          <!-- TAB 1: Cobros Fallidos -->
          <div id="ssTicketsPanel">
            <!-- Status Filters -->
            <div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap;">
              <button onclick="ssFilterStatus('abierto')" id="ssBtnAbierto" style="background:rgba(231,76,60,0.2);border:1px solid #e74c3c;padding:5px 10px;border-radius:6px;color:#e74c3c;cursor:pointer;font-size:11px;">üî¥ Abiertos</button>
              <button onclick="ssFilterStatus('en_proceso')" id="ssBtnProceso" style="background:rgba(243,156,18,0.2);border:1px solid #f39c12;padding:5px 10px;border-radius:6px;color:#f39c12;cursor:pointer;font-size:11px;">üü° En Proceso</button>
              <button onclick="ssFilterStatus('resuelto')" id="ssBtnResuelto" style="background:rgba(39,174,96,0.2);border:1px solid #27ae60;padding:5px 10px;border-radius:6px;color:#27ae60;cursor:pointer;font-size:11px;">üü¢ Resueltos</button>
              <button onclick="ssFilterStatus(null)" id="ssBtnTodos" style="background:rgba(52,152,219,0.2);border:1px solid #3498db;padding:5px 10px;border-radius:6px;color:#3498db;cursor:pointer;font-size:11px;">üìã Todos</button>
            </div>
            <!-- Time Period Filters -->
            <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;align-items:center;">
              <span style="color:#94a3b8;font-size:11px;font-weight:bold;">üìÖ Periodo:</span>
              <button onclick="ssFilterTime('today')" id="ssBtnToday" style="background:rgba(220,38,38,0.15);border:1px solid #dc2626;padding:5px 10px;border-radius:6px;color:#dc2626;cursor:pointer;font-size:11px;font-weight:bold;">üî• Hoy</button>
              <button onclick="ssFilterTime('week')" id="ssBtnWeek" style="background:rgba(234,88,12,0.15);border:1px solid #ea580c;padding:5px 10px;border-radius:6px;color:#ea580c;cursor:pointer;font-size:11px;">üìÜ Esta Semana</button>
              <button onclick="ssFilterTime('month')" id="ssBtnMonth" style="background:rgba(202,138,4,0.15);border:1px solid #ca8a04;padding:5px 10px;border-radius:6px;color:#ca8a04;cursor:pointer;font-size:11px;">üìÖ Este Mes</button>
              <button onclick="ssFilterTime('year')" id="ssBtnYear" style="background:rgba(37,99,235,0.15);border:1px solid #2563eb;padding:5px 10px;border-radius:6px;color:#2563eb;cursor:pointer;font-size:11px;">üìä Este A√±o</button>
              <button onclick="ssFilterTime(null)" id="ssBtnAllTime" style="background:rgba(100,116,139,0.15);border:1px solid #64748b;padding:5px 10px;border-radius:6px;color:#64748b;cursor:pointer;font-size:11px;">üóÑÔ∏è Todo</button>
            </div>
            <!-- Summary Bar -->
            <div id="ssTimeSummary" style="display:none;background:linear-gradient(135deg,#1e293b,#0f172a);border:1px solid #334155;border-radius:10px;padding:10px 15px;margin-bottom:10px;">
              <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                <span id="ssTimeSummaryText" style="color:#e2e8f0;font-size:12px;font-weight:bold;"></span>
                <div style="display:flex;gap:12px;">
                  <span id="ssTimeSummaryOpen" style="color:#dc2626;font-size:11px;">üî¥ 0 abiertos</span>
                  <span id="ssTimeSummaryProcess" style="color:#f39c12;font-size:11px;">üü° 0 en proceso</span>
                  <span id="ssTimeSummaryResolved" style="color:#27ae60;font-size:11px;">üü¢ 0 resueltos</span>
                </div>
              </div>
            </div>
            <div id="ssTicketsList" style="max-height:500px;overflow-y:auto;">
              <div style="text-align:center;color:#94a3b8;padding:20px;">Cargando tickets...</div>
            </div>
          </div>

          <!-- TAB 2: Surveys List -->
          <div id="ssSurveysPanel" style="display:none;">
            <div style="display:flex;gap:6px;margin-bottom:10px;">
              <button onclick="loadSSSurveys()" style="background:rgba(52,152,219,0.2);border:1px solid #3498db;padding:5px 10px;border-radius:6px;color:#3498db;cursor:pointer;font-size:11px;">üìã Todos</button>
              <button onclick="loadSSSurveys('cancelacion')" style="background:rgba(231,76,60,0.2);border:1px solid #e74c3c;padding:5px 10px;border-radius:6px;color:#e74c3c;cursor:pointer;font-size:11px;">üö™ Cancelaciones</button>
              <button onclick="loadSSSurveys('seguimiento')" style="background:rgba(39,174,96,0.2);border:1px solid #27ae60;padding:5px 10px;border-radius:6px;color:#27ae60;cursor:pointer;font-size:11px;">üìû Seguimiento</button>
            </div>
            <div id="ssSurveysList" style="max-height:400px;overflow-y:auto;">
              <div style="text-align:center;color:#94a3b8;padding:20px;">Cargando surveys...</div>
            </div>
          </div>

          <!-- TAB 3: New Survey Form -->
          <div id="ssNewSurveyPanel" style="display:none;">
            <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:20px;">
              <h3 style="color:#00d4ff;margin:0 0 15px;">üìã Nuevo Survey de Estudiante</h3>
              
              <div style="margin-bottom:12px;">
                <label style="color:#94a3b8;font-size:12px;display:block;margin-bottom:4px;">üë§ Email del Estudiante</label>
                <input type="email" id="ssFormEmail" placeholder="email@ejemplo.com" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:white;font-size:14px;box-sizing:border-box;">
                <button onclick="ssLookupStudent()" style="background:#3498db;color:white;border:none;padding:6px 12px;border-radius:6px;font-size:11px;cursor:pointer;margin-top:6px;">üîç Buscar Estudiante</button>
                <div id="ssStudentInfo" style="margin-top:8px;"></div>
              </div>

              <div style="margin-bottom:12px;">
                <label style="color:#94a3b8;font-size:12px;display:block;margin-bottom:4px;">üìù Tipo de Survey</label>
                <select id="ssFormTipo" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:white;font-size:14px;" onchange="ssToggleCancelFields()">
                  <option value="seguimiento">üìû Seguimiento General</option>
                  <option value="cancelacion">üö™ Desea Cancelar</option>
                  <option value="pago_fallido">üí≥ Pago Fallido</option>
                  <option value="nuevo_ingreso">üéâ Nuevo Ingreso</option>
                </select>
              </div>

              <div style="background:rgba(243,156,18,0.1);border:1px solid rgba(243,156,18,0.3);border-radius:10px;padding:15px;margin-bottom:12px;">
                <h4 style="color:#f39c12;margin:0 0 10px;">1Ô∏è‚É£ ¬øC√≥mo ingres√≥ a la escuela?</h4>
                <select id="ssFormIngreso" style="width:100%;padding:8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;font-size:13px;">
                  <option value="">-- Seleccionar --</option>
                  <option value="sitio_web">üåê Sitio Web</option>
                  <option value="app">üì± App Maestro ACVOLT</option>
                  <option value="redes_sociales">üì≤ Redes Sociales (TikTok, YouTube, FB)</option>
                  <option value="referido">üë• Referido por otro estudiante</option>
                  <option value="vendedor">ü§ù Vendedor / Promotor</option>
                  <option value="evento">üé§ Evento / Clase gratis</option>
                  <option value="otro">üìå Otro</option>
                </select>
              </div>

              <div style="background:rgba(52,152,219,0.1);border:1px solid rgba(52,152,219,0.3);border-radius:10px;padding:15px;margin-bottom:12px;">
                <h4 style="color:#3498db;margin:0 0 10px;">2Ô∏è‚É£ ¬øQui√©n le ayud√≥ a inscribirse?</h4>
                <select id="ssFormAyuda" style="width:100%;padding:8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;font-size:13px;">
                  <option value="">-- Seleccionar --</option>
                  <option value="solo">üôã Se registr√≥ solo/a</option>
                  <option value="vendedor">ü§ù Vendedor / Promotor</option>
                  <option value="soporte">üìû Soporte t√©cnico</option>
                  <option value="maestro_mario">üë®‚Äçüè´ Maestro Mario</option>
                  <option value="otro_estudiante">üë• Otro estudiante</option>
                </select>
                <input type="text" id="ssFormAyudaNombre" placeholder="Nombre del vendedor/persona (opcional)" style="width:100%;padding:8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;font-size:13px;margin-top:6px;box-sizing:border-box;">
              </div>

              <div style="background:#faf5ff;border:1px solid #e9d5ff;border-radius:10px;padding:15px;margin-bottom:12px;">
                <h4 style="color:#9b59b6;margin:0 0 10px;">3Ô∏è‚É£ Comentarios sobre la escuela</h4>
                <label style="color:#94a3b8;font-size:11px;">Opini√≥n general de la escuela:</label>
                <div style="display:flex;gap:4px;margin:6px 0;">
                  <button onclick="ssSetRating('general',1)" id="ssRate_general_1" style="padding:4px 8px;border-radius:4px;border:1px solid #555;background:transparent;color:white;cursor:pointer;">‚≠ê1</button>
                  <button onclick="ssSetRating('general',2)" id="ssRate_general_2" style="padding:4px 8px;border-radius:4px;border:1px solid #555;background:transparent;color:white;cursor:pointer;">‚≠ê2</button>
                  <button onclick="ssSetRating('general',3)" id="ssRate_general_3" style="padding:4px 8px;border-radius:4px;border:1px solid #555;background:transparent;color:white;cursor:pointer;">‚≠ê3</button>
                  <button onclick="ssSetRating('general',4)" id="ssRate_general_4" style="padding:4px 8px;border-radius:4px;border:1px solid #555;background:transparent;color:white;cursor:pointer;">‚≠ê4</button>
                  <button onclick="ssSetRating('general',5)" id="ssRate_general_5" style="padding:4px 8px;border-radius:4px;border:1px solid #555;background:transparent;color:white;cursor:pointer;">‚≠ê5</button>
                </div>
                <label style="color:#94a3b8;font-size:11px;">Clases en l√≠nea (app):</label>
                <div style="display:flex;gap:4px;margin:6px 0;">
                  <button onclick="ssSetRating('online',1)" id="ssRate_online_1" style="padding:4px 8px;border-radius:4px;border:1px solid #555;background:transparent;color:white;cursor:pointer;">‚≠ê1</button>
                  <button onclick="ssSetRating('online',2)" id="ssRate_online_2" style="padding:4px 8px;border-radius:4px;border:1px solid #555;background:transparent;color:white;cursor:pointer;">‚≠ê2</button>
                  <button onclick="ssSetRating('online',3)" id="ssRate_online_3" style="padding:4px 8px;border-radius:4px;border:1px solid #555;background:transparent;color:white;cursor:pointer;">‚≠ê3</button>
                  <button onclick="ssSetRating('online',4)" id="ssRate_online_4" style="padding:4px 8px;border-radius:4px;border:1px solid #555;background:transparent;color:white;cursor:pointer;">‚≠ê4</button>
                  <button onclick="ssSetRating('online',5)" id="ssRate_online_5" style="padding:4px 8px;border-radius:4px;border:1px solid #555;background:transparent;color:white;cursor:pointer;">‚≠ê5</button>
                </div>
                <label style="color:#94a3b8;font-size:11px;">Clases en vivo (Zoom):</label>
                <div style="display:flex;gap:4px;margin:6px 0;">
                  <button onclick="ssSetRating('vivo',1)" id="ssRate_vivo_1" style="padding:4px 8px;border-radius:4px;border:1px solid #555;background:transparent;color:white;cursor:pointer;">‚≠ê1</button>
                  <button onclick="ssSetRating('vivo',2)" id="ssRate_vivo_2" style="padding:4px 8px;border-radius:4px;border:1px solid #555;background:transparent;color:white;cursor:pointer;">‚≠ê2</button>
                  <button onclick="ssSetRating('vivo',3)" id="ssRate_vivo_3" style="padding:4px 8px;border-radius:4px;border:1px solid #555;background:transparent;color:white;cursor:pointer;">‚≠ê3</button>
                  <button onclick="ssSetRating('vivo',4)" id="ssRate_vivo_4" style="padding:4px 8px;border-radius:4px;border:1px solid #555;background:transparent;color:white;cursor:pointer;">‚≠ê4</button>
                  <button onclick="ssSetRating('vivo',5)" id="ssRate_vivo_5" style="padding:4px 8px;border-radius:4px;border:1px solid #555;background:transparent;color:white;cursor:pointer;">‚≠ê5</button>
                </div>
                <textarea id="ssFormComentarios" rows="3" placeholder="Comentarios adicionales del estudiante..." style="width:100%;padding:8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;font-size:13px;margin-top:6px;box-sizing:border-box;resize:vertical;"></textarea>
              </div>

              <div style="background:rgba(39,174,96,0.1);border:1px solid rgba(39,174,96,0.3);border-radius:10px;padding:15px;margin-bottom:12px;">
                <h4 style="color:#27ae60;margin:0 0 10px;">4Ô∏è‚É£ ¬øC√≥mo le va en la escuela?</h4>
                <label style="color:#94a3b8;font-size:11px;">¬øYa obtuvo alg√∫n certificado?</label>
                <select id="ssFormCertificado" style="width:100%;padding:8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;font-size:13px;margin-top:4px;">
                  <option value="">-- Seleccionar --</option>
                  <option value="si">‚úÖ S√≠, ya tiene certificado</option>
                  <option value="en_proceso">üîÑ En proceso / estudiando</option>
                  <option value="no_todavia">‚è≥ No todav√≠a, pero sigue activo</option>
                  <option value="no_dificultad">‚ùå No, tiene dificultad</option>
                  <option value="no_tiempo">‚è∞ No, no ha tenido tiempo</option>
                </select>
                <textarea id="ssFormProgreso" rows="2" placeholder="¬øEn qu√© nivel va? ¬øQu√© dificultades tiene?" style="width:100%;padding:8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;font-size:13px;margin-top:6px;box-sizing:border-box;resize:vertical;"></textarea>
              </div>

              <!-- Cancelation fields (shown only if tipo=cancelacion) -->
              <div id="ssCancelFields" style="display:none;">
                <div style="background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.3);border-radius:10px;padding:15px;margin-bottom:12px;">
                  <h4 style="color:#e74c3c;margin:0 0 10px;">5Ô∏è‚É£ ¬øPor qu√© se sali√≥ / desea cancelar?</h4>
                  <select id="ssFormMotivoCancelacion" style="width:100%;padding:8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;font-size:13px;">
                    <option value="">-- Seleccionar motivo --</option>
                    <option value="precio">üí∞ Precio / No puede pagar</option>
                    <option value="tiempo">‚è∞ No tiene tiempo</option>
                    <option value="no_usa">üìµ No usa la plataforma</option>
                    <option value="no_entiende">ü§î No entiende el contenido</option>
                    <option value="ya_aprendio">üéì Ya aprendi√≥ lo que necesitaba</option>
                    <option value="competencia">üèÉ Se fue con otra escuela</option>
                    <option value="problemas_tecnicos">üîß Problemas t√©cnicos</option>
                    <option value="servicio">üòû Mal servicio</option>
                    <option value="otro">üìå Otro motivo</option>
                  </select>
                  <textarea id="ssFormMotivoCancelacionDetalle" rows="2" placeholder="Detalles adicionales sobre la cancelaci√≥n..." style="width:100%;padding:8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;font-size:13px;margin-top:6px;box-sizing:border-box;resize:vertical;"></textarea>
                  <label style="color:#94a3b8;font-size:11px;margin-top:8px;display:block;">¬øSe le ofreci√≥ soluci√≥n para retenerlo?</label>
                  <select id="ssFormRetencion" style="width:100%;padding:8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;font-size:13px;margin-top:4px;">
                    <option value="">-- Seleccionar --</option>
                    <option value="descuento">üí∞ Se ofreci√≥ descuento</option>
                    <option value="pausa">‚è∏Ô∏è Se ofreci√≥ pausar membres√≠a</option>
                    <option value="soporte">üìû Se ofreci√≥ soporte extra</option>
                    <option value="nada">‚ùå No se ofreci√≥ nada</option>
                    <option value="acepto_quedarse">‚úÖ Acept√≥ quedarse</option>
                    <option value="cancelo_definitivo">üö™ Cancel√≥ definitivo</option>
                  </select>
                </div>
              </div>

              <div style="margin-bottom:12px;">
                <label style="color:#94a3b8;font-size:12px;display:block;margin-bottom:4px;">üìù Notas internas del agente</label>
                <textarea id="ssFormNotas" rows="2" placeholder="Notas adicionales..." style="width:100%;padding:8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;font-size:13px;box-sizing:border-box;resize:vertical;"></textarea>
              </div>

              <button onclick="ssSubmitSurvey()" style="width:100%;background:linear-gradient(135deg,#27ae60,#2ecc71);color:white;border:none;padding:14px;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer;">üíæ Guardar Survey</button>
            </div>
          </div>

          <!-- TAB 4: Staff Management (Master only) -->
          <div id="ssStaffPanel" style="display:none;">
            <div style="background:rgba(230,126,34,0.1);border:1px solid #e67e22;border-radius:12px;padding:20px;margin-bottom:15px;">
              <h3 style="color:#e67e22;margin:0 0 15px;">‚ûï Crear Nuevo Usuario de Staff</h3>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div>
                  <label style="color:#94a3b8;font-size:11px;">Username (para login)</label>
                  <input type="text" id="staffFormUser" placeholder="ej: jessica01" style="width:100%;padding:8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;font-size:13px;box-sizing:border-box;">
                </div>
                <div>
                  <label style="color:#94a3b8;font-size:11px;">Contrase√±a</label>
                  <input type="text" id="staffFormPass" placeholder="ej: Staff2025$" style="width:100%;padding:8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;font-size:13px;box-sizing:border-box;">
                </div>
                <div>
                  <label style="color:#94a3b8;font-size:11px;">Nombre completo</label>
                  <input type="text" id="staffFormNombre" placeholder="ej: Jessica L√≥pez" style="width:100%;padding:8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;font-size:13px;box-sizing:border-box;">
                </div>
                <div>
                  <label style="color:#94a3b8;font-size:11px;">Email</label>
                  <input type="email" id="staffFormEmail" placeholder="ej: jessica@acvolt.com" style="width:100%;padding:8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;font-size:13px;box-sizing:border-box;">
                </div>
                <div>
                  <label style="color:#94a3b8;font-size:11px;">Tel√©fono</label>
                  <input type="text" id="staffFormTel" placeholder="ej: 909-555-1234" style="width:100%;padding:8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;font-size:13px;box-sizing:border-box;">
                </div>
                <div>
                  <label style="color:#94a3b8;font-size:11px;">Rol</label>
                  <select id="staffFormRol" style="width:100%;padding:8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;font-size:13px;">
                    <option value="student_success">üé´ Student Success</option>
                    <option value="master">üëë Master (acceso total)</option>
                  </select>
                </div>
              </div>
              <button onclick="ssCreateStaff()" style="margin-top:12px;width:100%;background:linear-gradient(135deg,#e67e22,#d35400);color:white;border:none;padding:12px;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;">üë• Crear Usuario</button>
            </div>
            
            <h3 style="color:#e2e8f0;margin:0 0 10px;">üìã Usuarios Registrados</h3>
            <div id="ssStaffList" style="max-height:300px;overflow-y:auto;">
              <div style="text-align:center;color:#94a3b8;padding:20px;">Cargando staff...</div>
            </div>
          </div>

          <!-- Ticket/Survey Detail Modal -->
          <div id="ssDetailModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:9999;">
            <div style="background:#1a1a2e;border-radius:15px;padding:25px;max-width:550px;width:90%;max-height:80vh;overflow-y:auto;border:2px solid #00d4ff;margin:auto;margin-top:8vh;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <h3 style="color:#00d4ff;margin:0;">üìã Detalle</h3>
                <button onclick="document.getElementById('ssDetailModal').style.display='none'" style="background:none;border:none;color:white;font-size:24px;cursor:pointer;">‚úï</button>
              </div>
              <div id="ssDetailContent"></div>
            </div>
          </div>
        </div>



        <!-- ========== LANDING PAGE MANAGER ‚Äî FASE 2 #8 ========== -->
        <div class="admin-section admin-grid-full" id="adminLandingPage" style="background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
          <div class="admin-section-header">
            <span class="admin-section-title">üìñ Landing Page & Testimonios</span>
            <button onclick="showScreen('landingPageScreen')" style="background:#f1f5f9;padding:5px 10px;border-radius:6px;color:#475569;border:1px solid #e2e8f0;cursor:pointer;font-size:10px;">üëÅÔ∏è</button>
          </div>
          <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:12px;margin-top:8px;">
            <p style="color:#2ecc71;font-size:12px;font-weight:bold;margin:0 0 8px;">üìä Landing Page Status</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div style="color:#e2e8f0;font-size:12px;">‚úÖ Landing page activa</div>
              <div style="color:#e2e8f0;font-size:12px;">‚úÖ 4 testimonios publicados</div>
              <div style="color:#e2e8f0;font-size:12px;">‚úÖ Bot√≥n visible en login</div>
              <div style="color:#e2e8f0;font-size:12px;">‚úÖ CTA registro + login</div>
            </div>
            <p style="color:#64748b;font-size:11px;margin:10px 0 0;">üí° Para agregar testimonios reales, edita la secci√≥n landingPageScreen en el index.html o implementa carga din√°mica desde Supabase.</p>
          </div>
        </div>

        <!-- ========== üí∞ MIS INGRESOS ‚Äî STRIPE + SUPABASE ‚Äî SESI√ìN 5 ========== -->
        <div class="admin-section admin-grid-full" id="adminFinanzas" style="background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
          <div class="admin-section-header">
            <span class="admin-section-title">üí∞ Mis Ingresos ‚Äî Stripe + Membres√≠as</span>
            <div style="display:flex;gap:6px;flex-wrap:wrap;">
              <button onclick="loadFinanzasStripe()" style="background:#635bff;padding:5px 12px;border-radius:6px;color:#fff;border:none;cursor:pointer;font-size:10px;font-weight:bold;">‚ö° Cargar Stripe</button>
              <button onclick="loadFinanzasData()" style="background:#f1f5f9;padding:5px 10px;border-radius:6px;color:#475569;border:1px solid #e2e8f0;cursor:pointer;font-size:10px;">üîÑ Supabase</button>
              <button onclick="generatePDFReport()" style="background:#fffbeb;padding:5px 10px;border-radius:6px;color:#d97706;border:1px solid #fde68a;cursor:pointer;font-size:10px;">üìÑ PDF</button>
            </div>
          </div>

          <!-- STRIPE DATA SOURCE TABS -->
          <div style="display:flex;gap:6px;margin:10px 0;flex-wrap:wrap;">
            <button onclick="finShowTab('stripe')" id="finTabStripe" style="background:#635bff;color:white;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;font-size:12px;font-weight:bold;">üí≥ Stripe (Datos Reales)</button>
            <button onclick="finShowTab('supabase')" id="finTabSupabase" style="background:#f1f5f9;color:#475569;padding:8px 16px;border-radius:8px;border:1px solid #e2e8f0;cursor:pointer;font-size:12px;">üóÑÔ∏è Supabase (Membres√≠as)</button>
            <button onclick="finShowTab('reconcile')" id="finTabReconcile" style="background:#f1f5f9;color:#475569;padding:8px 16px;border-radius:8px;border:1px solid #e2e8f0;cursor:pointer;font-size:12px;">üîÑ Reconciliaci√≥n</button>
          </div>

          <!-- ===== TAB: STRIPE REAL DATA ===== -->
          <div id="finStripePanel">
            <!-- Stripe Status Banner -->
            <div id="stripeStatusBanner" style="background:linear-gradient(135deg,#635bff,#7c3aed);border-radius:12px;padding:15px;margin-bottom:15px;">
              <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                <div>
                  <div style="color:rgba(255,255,255,0.7);font-size:11px;">CONEXI√ìN STRIPE</div>
                  <div id="stripeConnStatus" style="color:white;font-size:16px;font-weight:bold;">‚è≥ Sin conectar ‚Äî Configura tu API Key</div>
                </div>
                <div style="text-align:right;">
                  <div style="color:rgba(255,255,255,0.7);font-size:11px;">MERCHANT</div>
                  <div style="color:white;font-size:13px;font-weight:bold;">Tech School AC Volt</div>
                </div>
              </div>
            </div>

            <!-- Stripe KPI Cards -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:15px;">
              <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:12px;padding:18px;text-align:center;">
                <div style="font-size:11px;color:#16a34a;font-weight:bold;">üí∞ MRR Real (Stripe)</div>
                <div id="stripeMRR" style="font-size:32px;font-weight:900;color:#16a34a;margin:5px 0;">‚Äî</div>
                <div style="font-size:10px;color:#64748b;">Ingresos recurrentes del mes</div>
              </div>
              <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:12px;padding:18px;text-align:center;">
                <div style="font-size:11px;color:#2563eb;font-weight:bold;">üìä Suscripciones Activas</div>
                <div id="stripeActiveSubs" style="font-size:32px;font-weight:900;color:#2563eb;margin:5px 0;">‚Äî</div>
                <div style="font-size:10px;color:#64748b;">Pagando ahora mismo</div>
              </div>
              <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:12px;padding:18px;text-align:center;">
                <div style="font-size:11px;color:#dc2626;font-weight:bold;">‚ùå Cobros Fallidos</div>
                <div id="stripeFailedCharges" style="font-size:32px;font-weight:900;color:#dc2626;margin:5px 0;">‚Äî</div>
                <div id="stripeFailedAmount" style="font-size:10px;color:#dc2626;">$0 perdido</div>
              </div>
              <div style="background:#faf5ff;border:1px solid #e9d5ff;border-radius:12px;padding:18px;text-align:center;">
                <div style="font-size:11px;color:#7c3aed;font-weight:bold;">üè¶ Balance Disponible</div>
                <div id="stripeBalance" style="font-size:32px;font-weight:900;color:#7c3aed;margin:5px 0;">‚Äî</div>
                <div style="font-size:10px;color:#64748b;">Listo para transferir</div>
              </div>
            </div>

            <!-- Stripe Revenue Chart -->
            <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:20px;margin-bottom:15px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <div style="font-size:14px;color:#1e293b;font-weight:bold;">üìà Revenue Mensual (√öltimos 6 Meses)</div>
                <div id="stripeRevenueTotal" style="font-size:14px;color:#16a34a;font-weight:bold;">Total: ‚Äî</div>
              </div>
              <div id="stripeRevenueChart" style="display:flex;align-items:flex-end;gap:8px;height:160px;padding:10px 0;">
                <div style="text-align:center;color:#94a3b8;width:100%;padding:40px;">‚è≥ Conecta Stripe para ver tu gr√°fica de ingresos</div>
              </div>
              <div id="stripeRevenueLabels" style="display:flex;gap:8px;margin-top:5px;"></div>
            </div>

            <!-- Stripe Detailed Metrics -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
              <!-- Transacciones -->
              <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:15px;">
                <div style="font-size:13px;color:#1e293b;font-weight:bold;margin-bottom:12px;">üìã Resumen de Transacciones</div>
                <div id="stripeTransSummary" style="display:grid;gap:8px;">
                  <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f1f5f9;">
                    <span style="color:#64748b;font-size:12px;">Total transacciones</span>
                    <span id="stripeTotalTrans" style="color:#1e293b;font-weight:bold;font-size:12px;">‚Äî</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f1f5f9;">
                    <span style="color:#64748b;font-size:12px;">‚úÖ Exitosas</span>
                    <span id="stripeSuccessTrans" style="color:#16a34a;font-weight:bold;font-size:12px;">‚Äî</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f1f5f9;">
                    <span style="color:#64748b;font-size:12px;">‚ùå Fallidas</span>
                    <span id="stripeFailedTrans" style="color:#dc2626;font-weight:bold;font-size:12px;">‚Äî</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f1f5f9;">
                    <span style="color:#64748b;font-size:12px;">‚Ü©Ô∏è Reembolsadas</span>
                    <span id="stripeRefundTrans" style="color:#d97706;font-weight:bold;font-size:12px;">‚Äî</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;padding:6px 0;">
                    <span style="color:#64748b;font-size:12px;">‚ö†Ô∏è Disputadas</span>
                    <span id="stripeDisputeTrans" style="color:#e74c3c;font-weight:bold;font-size:12px;">‚Äî</span>
                  </div>
                </div>
              </div>
              <!-- Suscripciones -->
              <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:15px;">
                <div style="font-size:13px;color:#1e293b;font-weight:bold;margin-bottom:12px;">üîÑ Suscripciones</div>
                <div id="stripeSubsSummary" style="display:grid;gap:8px;">
                  <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f1f5f9;">
                    <span style="color:#64748b;font-size:12px;">Precio mensual</span>
                    <span id="stripeSubPrice" style="color:#1e293b;font-weight:bold;font-size:12px;">$111.00</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f1f5f9;">
                    <span style="color:#64748b;font-size:12px;">‚úÖ Activas</span>
                    <span id="stripeSubsActive" style="color:#16a34a;font-weight:bold;font-size:12px;">‚Äî</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f1f5f9;">
                    <span style="color:#64748b;font-size:12px;">‚è∏Ô∏è Pausadas</span>
                    <span id="stripeSubsPaused" style="color:#d97706;font-weight:bold;font-size:12px;">‚Äî</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f1f5f9;">
                    <span style="color:#64748b;font-size:12px;">‚ùå Canceladas (30d)</span>
                    <span id="stripeSubsCanceled" style="color:#dc2626;font-weight:bold;font-size:12px;">‚Äî</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;padding:6px 0;">
                    <span style="color:#64748b;font-size:12px;">üìâ Churn Real</span>
                    <span id="stripeChurnReal" style="color:#e74c3c;font-weight:bold;font-size:12px;">‚Äî</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Failed Payments Alert -->
            <div id="stripeFailedAlert" style="display:none;background:#fef2f2;border:2px solid #fecaca;border-radius:12px;padding:15px;margin-bottom:15px;">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                <span style="font-size:24px;">üö®</span>
                <div style="flex:1;">
                  <div style="color:#dc2626;font-weight:bold;font-size:14px;">Cobros Fallidos ‚Äî Requieren Atenci√≥n</div>
                  <div style="color:#64748b;font-size:11px;">Estos estudiantes tienen pagos que no pasaron. Contactar para actualizar m√©todo de pago.</div>
                </div>
                <button onclick="importFailedToStudentSuccess()" style="background:linear-gradient(135deg,#dc2626,#b91c1c);color:white;border:none;padding:10px 16px;border-radius:8px;font-size:12px;font-weight:bold;cursor:pointer;white-space:nowrap;">üé´ Importar TODOS a Student Success</button>
              </div>
              <div id="stripeImportStatus" style="display:none;padding:8px;border-radius:8px;margin-bottom:10px;font-size:12px;"></div>
              <div id="stripeFailedList" style="max-height:200px;overflow-y:auto;"></div>
            </div>

            <!-- Recent Charges -->
            <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:15px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <div style="font-size:13px;color:#1e293b;font-weight:bold;">üí≥ √öltimos Cobros de Stripe</div>
                <div style="font-size:11px;color:#64748b;" id="stripeLastUpdate">Sin datos</div>
              </div>
              <div id="stripeRecentCharges" style="max-height:300px;overflow-y:auto;">
                <div style="text-align:center;color:#94a3b8;padding:20px;font-size:13px;">
                  ‚ö° Presiona "Cargar Stripe" para ver tus cobros recientes<br>
                  <span style="font-size:11px;">Requiere Edge Function <code>get-stripe-data</code> deployada en Supabase</span>
                </div>
              </div>
            </div>
          </div>

          <!-- ===== TAB: SUPABASE MEMBERSHIPS (existing) ===== -->
          <div id="finSupabasePanel" style="display:none;">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:15px 0;">
              <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:12px;padding:15px;text-align:center;">
                <div style="font-size:11px;color:#27ae60;font-weight:bold;">MRR (Ingreso Mensual)</div>
                <div id="finMRR" style="font-size:28px;font-weight:bold;color:#2ecc71;margin:5px 0;">$0</div>
                <div style="font-size:10px;color:#64748b;">Membres√≠as activas √ó precio</div>
              </div>
              <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:12px;padding:15px;text-align:center;">
                <div style="font-size:11px;color:#2563eb;font-weight:bold;">Estudiantes Pagando</div>
                <div id="finPaying" style="font-size:28px;font-weight:bold;color:#3498db;margin:5px 0;">0</div>
                <div id="finPayingPct" style="font-size:10px;color:#64748b;">0% del total</div>
              </div>
              <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:12px;padding:15px;text-align:center;">
                <div style="font-size:11px;color:#dc2626;font-weight:bold;">Churn Rate (Mensual)</div>
                <div id="finChurn" style="font-size:28px;font-weight:bold;color:#e74c3c;margin:5px 0;">0%</div>
                <div style="font-size:10px;color:#64748b;">Cancelaciones / Total</div>
              </div>
              <div style="background:#fffbeb;border:1px solid #fde68a;border-radius:12px;padding:15px;text-align:center;">
                <div style="font-size:11px;color:#f39c12;font-weight:bold;">LTV Promedio</div>
                <div id="finLTV" style="font-size:28px;font-weight:bold;color:#f39c12;margin:5px 0;">$0</div>
                <div style="font-size:10px;color:#64748b;">Valor promedio por estudiante</div>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:15px;">
              <div style="background:#faf5ff;border:1px solid #e9d5ff;border-radius:12px;padding:15px;text-align:center;">
                <div style="font-size:11px;color:#9b59b6;font-weight:bold;">Revenue Acumulado</div>
                <div id="finTotal" style="font-size:24px;font-weight:bold;color:#9b59b6;margin:5px 0;">$0</div>
                <div style="font-size:10px;color:#64748b;">Hist√≥rico total</div>
              </div>
              <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:12px;padding:15px;text-align:center;">
                <div style="font-size:11px;color:#16a34a;font-weight:bold;">Membres√≠as Activas</div>
                <div id="finActive" style="font-size:24px;font-weight:bold;color:#2ecc71;margin:5px 0;">0</div>
                <div style="font-size:10px;color:#64748b;">Status: active</div>
              </div>
              <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:12px;padding:15px;text-align:center;">
                <div style="font-size:11px;color:#dc2626;font-weight:bold;">Cancelaciones (30 d√≠as)</div>
                <div id="finCanceled" style="font-size:24px;font-weight:bold;color:#e74c3c;margin:5px 0;">0</div>
                <div style="font-size:10px;color:#64748b;">Membres√≠as canceladas</div>
              </div>
              <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:12px;padding:15px;text-align:center;">
                <div style="font-size:11px;color:#2563eb;font-weight:bold;">Gratis / Trial</div>
                <div id="finFree" style="font-size:24px;font-weight:bold;color:#3498db;margin:5px 0;">0</div>
                <div style="font-size:10px;color:#64748b;">Sin membres√≠a pagada</div>
              </div>
            </div>
            <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px;">
              <div style="font-size:12px;color:#f39c12;font-weight:bold;margin-bottom:8px;">üìä Desglose de Revenue</div>
              <div id="finBreakdown" style="color:#94a3b8;font-size:12px;">Cargando datos de Stripe/memberships...</div>
            </div>
          </div>

          <!-- ===== TAB: RECONCILIATION ===== -->
          <div id="finReconcilePanel" style="display:none;">
            <div style="background:#fffbeb;border:2px solid #fde68a;border-radius:12px;padding:20px;margin-bottom:15px;">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                <span style="font-size:28px;">üîÑ</span>
                <div>
                  <div style="color:#92400e;font-weight:bold;font-size:15px;">Reconciliaci√≥n Stripe ‚Üî Supabase</div>
                  <div style="color:#a16207;font-size:12px;">Sincroniza suscripciones de Stripe con membres√≠as en tu base de datos</div>
                </div>
              </div>
              <div id="reconcileResults" style="margin-bottom:15px;">
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:15px;">
                  <div style="background:white;border-radius:10px;padding:15px;text-align:center;border:1px solid #e2e8f0;">
                    <div style="font-size:11px;color:#635bff;font-weight:bold;">Stripe</div>
                    <div id="reconStripeCount" style="font-size:28px;font-weight:bold;color:#635bff;">‚Äî</div>
                    <div style="font-size:10px;color:#64748b;">Suscripciones activas</div>
                  </div>
                  <div style="background:white;border-radius:10px;padding:15px;text-align:center;border:1px solid #e2e8f0;">
                    <div style="font-size:11px;color:#3ecf8e;font-weight:bold;">Supabase</div>
                    <div id="reconSupaCount" style="font-size:28px;font-weight:bold;color:#3ecf8e;">‚Äî</div>
                    <div style="font-size:10px;color:#64748b;">Membres√≠as activas</div>
                  </div>
                  <div style="background:white;border-radius:10px;padding:15px;text-align:center;border:1px solid #e2e8f0;">
                    <div style="font-size:11px;color:#e74c3c;font-weight:bold;">Diferencia</div>
                    <div id="reconDiff" style="font-size:28px;font-weight:bold;color:#e74c3c;">‚Äî</div>
                    <div style="font-size:10px;color:#64748b;">Faltan sincronizar</div>
                  </div>
                </div>
              </div>
              <button onclick="runReconciliation()" style="width:100%;background:linear-gradient(135deg,#635bff,#7c3aed);color:white;border:none;padding:14px;border-radius:10px;font-size:14px;font-weight:bold;cursor:pointer;">üîÑ Ejecutar Reconciliaci√≥n</button>
              <div id="reconLog" style="margin-top:12px;max-height:200px;overflow-y:auto;font-family:monospace;font-size:11px;color:#64748b;"></div>
            </div>
          </div>

        </div>


        <!-- ========== EMAILS DE PROGRESO SEMANAL ‚Äî FASE 2 #4 ========== -->
        <div class="admin-section admin-grid-full" id="adminWeeklyEmails" style="background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
          <div class="admin-section-header">
            <span class="admin-section-title">üìß Emails de Progreso Semanal</span>
            <div style="display:flex;gap:6px;">
              <button onclick="previewWeeklyEmail()" style="background:#f1f5f9;padding:5px 10px;border-radius:6px;color:#475569;border:1px solid #e2e8f0;cursor:pointer;font-size:10px;">üëÅÔ∏è</button>
              <button onclick="sendWeeklyEmails()" style="background:#dcfce7;padding:5px 10px;border-radius:6px;color:#16a34a;border:1px solid #bbf7d0;cursor:pointer;font-size:10px;">üì§ Enviar</button>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin:12px 0;">
            <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:10px;color:#3498db;">üìä Estudiantes Activos</div>
              <div id="weActiveStudents" style="font-size:22px;font-weight:bold;color:#3498db;">0</div>
            </div>
            <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:10px;color:#27ae60;">‚úÖ Con Progreso</div>
              <div id="weWithProgress" style="font-size:22px;font-weight:bold;color:#27ae60;">0</div>
            </div>
            <div style="background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:10px;color:#f39c12;">‚è≥ √öltimo Env√≠o</div>
              <div id="weLastSent" style="font-size:14px;font-weight:bold;color:#f39c12;">Nunca</div>
            </div>
          </div>
          <div id="weeklyEmailPreview" style="display:none;background:rgba(255,255,255,0.05);border-radius:10px;padding:15px;margin-top:10px;border:1px solid rgba(52,152,219,0.3);">
          </div>
          <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;margin-top:8px;">
            <p style="color:#475569;font-size:11px;margin:0;">üìå Cada estudiante recibe un email personalizado con sus niveles, score, certificados y pr√≥ximo objetivo. Se env√≠a via Resend desde <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="cca2a3bea9bca0b58ca1ada9bfb8bea3a1adbea5a3e2afa3a1">[email&#160;protected]</a></p>
          </div>
        </div>

        <!-- ========== PROGRAMA DE REFERIDOS ‚Äî FASE 2 #7 ========== -->
        <div class="admin-section admin-grid-full" id="adminReferidos" style="background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
          <div class="admin-section-header">
            <span class="admin-section-title">üí∞ Programa de Embajadores</span>
            <button onclick="loadReferidosData()" style="background:#f1f5f9;padding:5px 10px;border-radius:6px;color:#475569;border:1px solid #e2e8f0;cursor:pointer;font-size:10px;">üîÑ</button>
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin:12px 0;">
            <div style="background:#faf5ff;border:1px solid #e9d5ff;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:10px;color:#9b59b6;">üì§ Links Compartidos</div>
              <div id="refShared" style="font-size:22px;font-weight:bold;color:#9b59b6;">0</div>
            </div>
            <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:10px;color:#2ecc71;">‚úÖ Membres√≠as Activas</div>
              <div id="refSuccess" style="font-size:22px;font-weight:bold;color:#2ecc71;">0</div>
            </div>
            <div style="background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:10px;color:#f39c12;">üí∞ Pagos Pendientes</div>
              <div id="refFreeMonths" style="font-size:22px;font-weight:bold;color:#f39c12;">0</div>
            </div>
          </div>
          <div style="background:#faf5ff;border:1px solid #e9d5ff;border-radius:10px;padding:12px;">
            <p style="color:#7c3aed;font-size:12px;font-weight:bold;margin:0 0 8px;">üèÜ Top Embajadores</p>
            <div id="refTopList" style="color:#94a3b8;font-size:12px;">Cargando...</div>
          </div>
          
          <!-- W-9 REVIEW PANEL -->
          <div style="margin-top:12px;background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
              <p style="color:#e74c3c;font-size:12px;font-weight:bold;margin:0;">üìã Formularios W-9 Pendientes</p>
              <button onclick="loadW9Reviews()" style="background:#f1f5f9;padding:4px 8px;border-radius:6px;color:#475569;border:1px solid #e2e8f0;cursor:pointer;font-size:10px;">üîÑ</button>
            </div>
            <div id="w9ReviewList" style="max-height:250px;overflow-y:auto;">
              <div style="text-align:center;color:#64748b;padding:10px;font-size:12px;">Haz clic en üîÑ para cargar</div>
            </div>
          </div>
          
          <!-- PAYMENT TRACKER -->
          <div style="margin-top:12px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
              <p style="color:#27ae60;font-size:12px;font-weight:bold;margin:0;">üí≥ Pagos a Embajadores</p>
              <button onclick="loadAmbassadorPayments()" style="background:#f1f5f9;padding:4px 8px;border-radius:6px;color:#475569;border:1px solid #e2e8f0;cursor:pointer;font-size:10px;">üîÑ</button>
            </div>
            <div id="ambassadorPaymentList" style="max-height:250px;overflow-y:auto;">
              <div style="text-align:center;color:#64748b;padding:10px;font-size:12px;">Haz clic en üîÑ para cargar</div>
            </div>
          </div>
        </div>

        <!-- ========== CALENDARIO CLASES EN VIVO ‚Äî FASE 2 #9 ========== -->
        <div class="admin-section admin-grid-full" id="adminCalendario" style="background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
          <div class="admin-section-header">
            <span class="admin-section-title">üìÖ Calendario de Clases en Vivo</span>
            <button onclick="showAddClassModal()" style="background:#ecfeff;padding:5px 10px;border-radius:6px;color:#0891b2;border:1px solid #a5f3fc;cursor:pointer;font-size:10px;">‚ûï Nueva</button>
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin:12px 0;">
            <div style="background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:10px;color:#00d4ff;">üìÖ Esta Semana</div>
              <div id="calThisWeek" style="font-size:22px;font-weight:bold;color:#00d4ff;">0</div>
            </div>
            <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:10px;color:#27ae60;">‚úÖ Completadas (Mes)</div>
              <div id="calCompleted" style="font-size:22px;font-weight:bold;color:#27ae60;">0</div>
            </div>
            <div style="background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:10px;color:#f39c12;">üë• Asistencia Prom.</div>
              <div id="calAvgAttendance" style="font-size:22px;font-weight:bold;color:#f39c12;">0</div>
            </div>
          </div>
          <div id="calendarClassList" style="max-height:350px;overflow-y:auto;">
            <div style="text-align:center;color:#94a3b8;padding:15px;font-size:13px;">Cargando calendario...</div>
          </div>
        </div>


        <!-- ========== ANALYTICS AVANZADOS ‚Äî FASE 3 #15 ========== -->
        <div class="admin-section admin-grid-full" id="adminAnalytics" style="background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
          <div class="admin-section-header">
            <span class="admin-section-title">üìä Analytics Avanzados</span>
            <button onclick="loadAnalytics()" style="background:#f1f5f9;padding:5px 10px;border-radius:6px;color:#475569;border:1px solid #e2e8f0;cursor:pointer;font-size:10px;">üîÑ</button>
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:8px;margin:12px 0;">
            <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:9px;color:#64748b;font-weight:500;">üî• DAU (Hoy)</div>
              <div id="anDAU" style="font-size:20px;font-weight:bold;color:#1e293b;">‚Äî</div>
            </div>
            <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:9px;color:#64748b;">üìä WAU (7d)</div>
              <div id="anWAU" style="font-size:20px;font-weight:bold;color:#1e293b;">‚Äî</div>
            </div>
            <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:9px;color:#64748b;">üìà Completion</div>
              <div id="anCompRate" style="font-size:20px;font-weight:bold;color:#1e293b;">‚Äî</div>
            </div>
            <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:9px;color:#64748b;">üéØ Avg Score</div>
              <div id="anAvgScore" style="font-size:20px;font-weight:bold;color:#1e293b;">‚Äî</div>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
            <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px;">
              <p style="color:#475569;font-size:11px;font-weight:600;margin:0 0 8px;">Distribuci√≥n por Nivel</p>
              <div id="anLevelChart" style="display:flex;gap:4px;align-items:flex-end;height:100px;"></div>
              <div id="anLevelLabels" style="display:flex;gap:4px;justify-content:space-around;margin-top:4px;"></div>
            </div>
            <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px;">
              <p style="color:#475569;font-size:11px;font-weight:600;margin:0 0 8px;">Embudo de Retenci√≥n</p>
              <div id="anFunnel"></div>
            </div>
          </div>
          <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px;margin-top:8px;">
            <p style="color:#475569;font-size:11px;font-weight:600;margin:0 0 8px;">üèÜ Top 10 Estudiantes</p>
            <div id="anTopStudents" style="max-height:200px;overflow-y:auto;color:#64748b;font-size:12px;">Haz clic üîÑ para cargar</div>
          </div>
        </div>


        <!-- ========== CERTIFICADOS DE ESTUDIANTES ‚Äî ADMIN ========== -->
        <div class="admin-section admin-grid-full" id="adminCertificados" style="background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
          <div class="admin-section-header">
            <span class="admin-section-title">üèÜ Certificados Emitidos</span>
            <button onclick="loadAdminCertificates()" style="background:#f1f5f9;padding:5px 10px;border-radius:6px;color:#475569;border:1px solid #e2e8f0;cursor:pointer;font-size:10px;">üîÑ</button>
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin:10px 0;">
            <div style="background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:9px;color:#92400e;font-weight:500;">üèÜ Total Certificados</div>
              <div id="acTotalCerts" style="font-size:22px;font-weight:bold;color:#92400e;">‚Äî</div>
            </div>
            <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:9px;color:#166534;font-weight:500;">üë§ Estudiantes con Cert</div>
              <div id="acStudentsWithCert" style="font-size:22px;font-weight:bold;color:#166534;">‚Äî</div>
            </div>
            <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:9px;color:#1e40af;font-weight:500;">üìä Tasa de Certificaci√≥n</div>
              <div id="acCertRate" style="font-size:22px;font-weight:bold;color:#1e40af;">‚Äî</div>
            </div>
          </div>
          <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px;margin-top:8px;">
            <p style="color:#475569;font-size:11px;font-weight:600;margin:0 0 8px;">üìã Certificados por Nivel</p>
            <div id="acByLevel" style="color:#64748b;font-size:12px;">Haz clic üîÑ para cargar</div>
          </div>
          <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px;margin-top:8px;">
            <p style="color:#475569;font-size:11px;font-weight:600;margin:0 0 8px;">üèÖ √öltimos Certificados Emitidos</p>
            <div id="acRecentCerts" style="max-height:250px;overflow-y:auto;color:#64748b;font-size:12px;">Haz clic üîÑ para cargar</div>
          </div>
        </div>

        <!-- ========== ALERTAS DE INACTIVIDAD - AUDITOR√çA #4 ========== -->
        <div class="admin-section admin-grid-full" id="adminInactivityAlerts" style="background:#ffffff;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
          <div class="admin-section-header">
            <span class="admin-section-title">‚ö†Ô∏è Alertas de Inactividad (7+ d√≠as)</span>
            <div style="display:flex;gap:6px;">
              <button onclick="loadInactivityAlerts()" style="background:#f1f5f9;padding:5px 10px;border-radius:6px;color:#475569;border:1px solid #e2e8f0;cursor:pointer;font-size:10px;">üîÑ</button>
              <button onclick="createInactivityTickets()" style="background:#e74c3c;padding:6px 12px;border-radius:8px;color:white;border:none;cursor:pointer;font-size:11px;">üé´ Crear Tickets</button>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:12px 0;">
            <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:10px;color:#e74c3c;">üî¥ Cr√≠tico (14+ d√≠as)</div>
              <div id="inactCritical" style="font-size:24px;font-weight:bold;color:#e74c3c;">0</div>
            </div>
            <div style="background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:10px;color:#f39c12;">üü° Alerta (7-13 d√≠as)</div>
              <div id="inactWarning" style="font-size:24px;font-weight:bold;color:#f39c12;">0</div>
            </div>
            <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:10px;color:#27ae60;">üü¢ Activos</div>
              <div id="inactActive" style="font-size:24px;font-weight:bold;color:#27ae60;">0</div>
            </div>
          </div>
          <div id="inactivityList" style="max-height:300px;overflow-y:auto;">
            <div style="text-align:center;color:#94a3b8;padding:20px;font-size:13px;">Haz clic en "Escanear" para detectar estudiantes inactivos</div>
          </div>
        </div>


      </div>
    </div>
    <div class="screen" id="adminTechnicianProfileScreen">
      <div class="admin-container">
        <div class="admin-header">
          <button class="back-btn" onclick="showScreen('adminDashboardScreen')">‚Üê Volver al Panel</button>
        </div>

        <!-- Profile Card -->
        <div class="admin-profile-card" id="adminProfileCard">
          <div class="admin-profile-header">
            <div class="admin-profile-avatar" id="adminProfileAvatar" style="width:80px;height:80px;border-radius:50%;background:#1e293b;display:flex;align-items:center;justify-content:center;font-size:40px;overflow:hidden;border:3px solid #f39c12;">
              <img id="adminViewPhoto" src="" style="display:none;width:100%;height:100%;object-fit:cover;">
              <span id="adminViewPhotoEmoji">üë§</span>
            </div>
            <div class="admin-profile-info">
              <h2 id="adminViewName">Nombre del T√©cnico</h2>
              <p id="adminViewTechNumber">TECH-0000-N33-XXXX</p>
            </div>
          </div>
          <div class="admin-profile-details">
            <div class="admin-detail-item">
              <div class="admin-detail-label">Email</div>
              <div class="admin-detail-value" id="adminViewEmail">-</div>
            </div>
            <div class="admin-detail-item">
              <div class="admin-detail-label">Tel√©fono</div>
              <div class="admin-detail-value" id="adminViewPhone">-</div>
            </div>
            <div class="admin-detail-item">
              <div class="admin-detail-label">EPA 608</div>
              <div class="admin-detail-value" id="adminViewEPA">-</div>
            </div>
            <div class="admin-detail-item">
              <div class="admin-detail-label">NATE</div>
              <div class="admin-detail-value" id="adminViewNATE">-</div>
            </div>
            <div class="admin-detail-item">
              <div class="admin-detail-label">ESCO</div>
              <div class="admin-detail-value" id="adminViewESCO">-</div>
            </div>
            <div class="admin-detail-item">
              <div class="admin-detail-label">Fecha de Registro</div>
              <div class="admin-detail-value" id="adminViewRegDate">-</div>
            </div>
          </div>
        </div>

        <!-- Progress Section -->
        <div class="admin-section">
          <div class="admin-section-header">
            <span class="admin-section-title">üìà Progreso del T√©cnico</span>
          </div>
          <div class="admin-chart">
            <div class="admin-chart-title">Rendimiento por Nivel</div>
            <div class="admin-bar-chart" id="technicianLevelProgress"></div>
          </div>
        </div>

        <!-- Activity Timeline -->
        <div class="admin-section">
          <div class="admin-section-header">
            <span class="admin-section-title">üïê Historial de Actividad</span>
          </div>
          <div class="progress-timeline">
            <div class="timeline-header">
              <div class="timeline-tabs">
                <button class="timeline-tab active" onclick="setTimelineView('minutes', this)">Minutos</button>
                <button class="timeline-tab" onclick="setTimelineView('hours', this)">Horas</button>
                <button class="timeline-tab" onclick="setTimelineView('days', this)">D√≠as</button>
                <button class="timeline-tab" onclick="setTimelineView('months', this)">Meses</button>
              </div>
            </div>
            <div class="timeline-content" id="activityTimeline">
              <div class="timeline-empty">
                <p>üì≠ No hay actividad registrada</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Certificates Section -->
        <div class="admin-section">
          <div class="admin-section-header">
            <span class="admin-section-title">üèÖ Certificados Obtenidos</span>
          </div>
          <div id="adminTechnicianCertificates">
            <div class="no-data-message">
              <p>No hay certificados a√∫n</p>
            </div>
          </div>
        </div>

        <!-- Lock Management Section -->
        <div class="admin-section">
          <div class="admin-section-header">
            <span class="admin-section-title">üîì Verificaci√≥n y Acceso</span>
          </div>
          <div id="adminAppAccess" style="padding:10px;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
              <button class="btn btn-primary" id="adminVerifyBtn" onclick="toggleVerification()" style="margin:0;font-size:13px;background:linear-gradient(135deg,#f39c12,#e67e22);">
                ‚úÖ Verificar Cuenta
              </button>
              <button class="btn btn-primary" id="adminActivateAppBtn" onclick="toggleAppAccess()" style="margin:0;font-size:13px;background:linear-gradient(135deg,#2ecc71,#27ae60);">
                üîì Activar App Completa
              </button>
            </div>
            <p id="adminVerifyStatus" style="color:#64748b;font-size:12px;text-align:center;margin-bottom:4px;"></p>
            <p id="adminAppAccessStatus" style="color:#64748b;font-size:12px;text-align:center;"></p>
            
            <!-- Code Generation Section -->
            <div style="border-top:1px solid rgba(255,255,255,0.1);margin-top:12px;padding-top:12px;">
              <p style="color:#f39c12;font-size:13px;font-weight:bold;margin-bottom:8px;">üîë C√≥digo de Acceso Individual</p>
              <div id="adminCodeSection">
                <button class="btn btn-primary" onclick="generateAccessCode()" style="width:100%;font-size:13px;background:linear-gradient(135deg,#9b59b6,#8e44ad);margin-bottom:8px;">
                  üé´ Generar C√≥digo √önico
                </button>
              </div>
              <div id="adminCodeDisplay" style="display:none;">
                <div style="background:rgba(155,89,182,0.2);border:2px solid #9b59b6;border-radius:12px;padding:12px;text-align:center;margin-bottom:8px;">
                  <p style="color:#64748b;font-size:11px;margin-bottom:4px;">C√≥digo para este t√©cnico:</p>
                  <div id="adminCodeValue" style="color:#f39c12;font-size:24px;font-weight:bold;letter-spacing:3px;font-family:monospace;"></div>
                  <p style="color:#7f8c8d;font-size:10px;margin-top:4px;">V√°lido solo para: <span id="adminCodeFor"></span></p>
                </div>
                <button class="btn btn-secondary" onclick="copyAccessCode()" style="width:100%;font-size:12px;margin-bottom:4px;">
                  üìã Copiar C√≥digo
                </button>
                <button class="btn btn-secondary" onclick="revokeAccessCode()" style="width:100%;font-size:12px;background:rgba(231,76,60,0.2);color:#e74c3c;">
                  ‚ùå Revocar C√≥digo
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Membership Code Section -->
        <div class="admin-section">
          <div class="admin-section-header">
            <span class="admin-section-title">üé• Clases en Vivo - Membres√≠a</span>
          </div>
          <div style="padding:10px;">
            <button class="btn btn-primary" onclick="generateMembershipCode()" style="width:100%;font-size:13px;background:linear-gradient(135deg,#9b59b6,#8e44ad);margin-bottom:8px;">
              üé´ Generar C√≥digo de Membres√≠a
            </button>
            <div id="adminMemberCodeDisplay" style="display:none;">
              <div style="background:rgba(155,89,182,0.2);border:2px solid #9b59b6;border-radius:12px;padding:12px;text-align:center;margin-bottom:8px;">
                <p style="color:#64748b;font-size:11px;margin-bottom:4px;">C√≥digo de Clases en Vivo:</p>
                <div id="adminMemberCodeValue" style="color:#9b59b6;font-size:24px;font-weight:bold;letter-spacing:3px;font-family:monospace;"></div>
                <p style="color:#7f8c8d;font-size:10px;margin-top:4px;">Para: <span id="adminMemberCodeFor"></span></p>
              </div>
              <button class="btn btn-secondary" onclick="copyMembershipCode()" style="width:100%;font-size:12px;margin-bottom:4px;">
                üìã Copiar C√≥digo de Membres√≠a
              </button>
              <button class="btn btn-secondary" onclick="revokeMembershipCode()" style="width:100%;font-size:12px;background:rgba(231,76,60,0.2);color:#e74c3c;">
                ‚ùå Revocar Membres√≠a
              </button>
            </div>
          </div>
        </div>

        <!-- Lock Management Section -->
        <div class="admin-section">
          <div class="admin-section-header">
            <span class="admin-section-title">üîê Control de Acceso por Nivel</span>
          </div>
          <div id="adminLockManagement">
            <div class="admin-lock-disabled-notice" id="lockSystemNotice">
              ‚úÖ Sistema de acceso ACTIVADO. Nivel 1 gratis. Niveles 2-5 requieren compra ($20/mo) o acceso de estudiante ACVOLT.
            </div>
            <div id="adminLockControls" style="display: none;">
              <!-- Lock controls will be rendered by JavaScript -->
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Welcome Screen -->
    <div class="screen" id="welcomeScreen">
      <div class="header" style="padding:3px 0 1px;">
        <img src="logo.png" alt="ACVOLT" class="logo-img" style="max-width:95px;margin-bottom:1px;">
        <h1 style="font-size:20px;margin:0;">MAESTRO ACVOLT</h1>
        <p class="subtitle" style="margin:2px 0 4px;font-size:12px;">Bienvenido</p>
      </div>
      <div class="card" style="padding:10px;">
        <!-- Progress Badge for free users -->
        <div id="freeUserProgress" style="display:none;background:linear-gradient(135deg,#fef3c7,#fde68a);border-radius:10px;padding:8px 12px;margin-bottom:6px;border:1px solid #f59e0b;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
            <span style="font-size:11px;font-weight:800;color:#92400e;">üìä Tu Progreso</span>
            <span id="progressCount" style="font-size:11px;font-weight:800;color:#d97706;">0/50 preguntas</span>
          </div>
          <div style="background:rgba(146,64,14,0.15);border-radius:6px;height:8px;overflow:hidden;">
            <div id="progressBar" style="height:100%;background:linear-gradient(90deg,#f59e0b,#d97706);border-radius:6px;width:0%;transition:width 0.5s;"></div>
          </div>
          <div id="progressMsg" style="font-size:9px;color:#92400e;margin-top:3px;text-align:center;"></div>
        </div>
        <button class="btn btn-primary" onclick="handleComenzar()" style="margin-bottom:3px;padding:11px;font-size:14px;">üéì Comenzar Entrenamiento</button>
        <button class="btn btn-secondary profile-nav-btn" onclick="showProfile('welcomeScreen')" style="margin-top:3px;padding:11px;font-size:14px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;">üìö Mis Clases (Biblioteca y Tareas)</button>
        <button class="btn btn-secondary" onclick="showScreen('studySectionsScreen')" style="margin-top:3px;padding:11px;font-size:14px; background: linear-gradient(135deg, #7c3aed, #6d28d9); color: white;">üéì Desarrollo de Habilidades (3,500+ Preguntas)</button>
        <button class="btn btn-secondary" onclick="showScreen('videoLessonsScreen')" style="margin-top:3px;padding:11px;font-size:14px; background: linear-gradient(135deg, #0891b2, #0e7490); color: white;">üé• Clases Pregrabadas (Zoom y YouTube)</button>
        <button class="btn btn-secondary" onclick="showScreen('attendanceScreen'); loadAttendanceData();" style="margin-top:3px;padding:11px;font-size:14px; background: linear-gradient(135deg, #16a34a, #15803d); color: white; font-weight:800;">‚úÖ Mi Asistencia - Check In/Out</button>
        <button class="btn btn-secondary" onclick="showScreen('certOficialesScreen')" style="margin-top:3px;padding:11px;font-size:14px; background: linear-gradient(135deg, #b45309, #92400e); color: white;">üèÜ Obt√©n tus Certificados Oficiales</button>
        
        <!-- Referidos + CRM -->
        <div style="margin-top:3px; padding-top:3px; border-top:1px solid rgba(255,255,255,0.1);">
          
          <!-- GANA DINERO -->
          <div onclick="showScreen('referidosScreen')" style="margin-top:2px;position:relative;border-radius:10px;padding:2px;cursor:pointer;background:linear-gradient(90deg,#ff0000,#ff8c00,#ffd700,#00ff00,#00bfff,#8b00ff,#ff0000);background-size:400% 100%;animation:vegasLights 3s linear infinite;box-shadow:0 0 10px rgba(255,215,0,0.4);">
            <div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:8px;padding:8px 10px;text-align:center;">
              <div style="display:flex;align-items:center;justify-content:center;gap:6px;">
                <span style="font-size:16px;animation:vegasBounce 1s ease infinite;">ü§ë</span>
                <span style="font-size:13px;font-weight:900;color:#ffd700;letter-spacing:1px;">¬°GANA DINERO!</span>
              </div>
              <div style="font-size:10px;font-weight:700;color:#fff;">RECOMIENDA LA ESCUELA</div>
            </div>
          </div>
          
          <!-- Trade Master CRM - Compact -->
          <div onclick="window.open('https://acvolttech.github.io/trademaster-crm/','_blank')" style="margin-top:3px;position:relative;border-radius:10px;padding:2px;cursor:pointer;background:linear-gradient(90deg,#f97316,#fbbf24,#22c55e,#3b82f6,#8b5cf6,#f97316);background-size:400% 100%;animation:vegasLights 4s linear infinite;">
            <div style="background:linear-gradient(135deg,#1e3a5f,#2d5a8e);border-radius:8px;padding:8px 10px;color:#fff;text-align:center;">
              <div style="font-size:14px;font-weight:900;margin-bottom:2px;">Trade Master CRM</div>
              <div style="font-size:9px;color:#94a3b8;margin-bottom:4px;">Maneja clientes, t√©cnicos, facturas, cobros y n√≥mina</div>
              <div style="display:flex;gap:4px;justify-content:center;flex-wrap:wrap;margin-bottom:4px;">
                <span style="background:rgba(249,115,22,.15);color:#f97316;padding:1px 5px;border-radius:20px;font-size:8px;font-weight:600">üìã Clientes</span>
                <span style="background:rgba(59,130,246,.15);color:#60a5fa;padding:1px 5px;border-radius:20px;font-size:8px;font-weight:600">üìç GPS</span>
                <span style="background:rgba(34,197,94,.15);color:#4ade80;padding:1px 5px;border-radius:20px;font-size:8px;font-weight:600">üí∞ Cobros</span>
                <span style="background:rgba(168,85,247,.15);color:#c084fc;padding:1px 5px;border-radius:20px;font-size:8px;font-weight:600">üìä N√≥mina</span>
              </div>
              <div style="display:flex;gap:5px;justify-content:center;">
                <a href="https://acvolttech.github.io/trademaster-crm/?tab=register&ref=maestro" target="_blank" style="text-decoration:none;background:linear-gradient(135deg,#22c55e,#16a34a);padding:6px 12px;border-radius:8px;font-size:10px;font-weight:800;color:#fff;animation:crmPulse 2s ease infinite;">üìù REG√çSTRATE GRATIS</a>
                <a href="https://acvolttech.github.io/trademaster-crm/?demo=true" target="_blank" style="text-decoration:none;background:linear-gradient(135deg,#f97316,#ea580c);padding:6px 12px;border-radius:8px;font-size:10px;font-weight:800;color:#fff;">üé¨ VER DEMO AI</a>
              </div>
              <div style="font-size:7px;color:#64748b;margin-top:3px;">Free para 10 clientes ‚Ä¢ No necesitas tarjeta</div>
            </div>
          </div>
          <style>
            @keyframes vegasLights{0%{background-position:0% 50%}100%{background-position:400% 50%}}
            @keyframes vegasBlink{0%,100%{opacity:1;filter:brightness(1.5);}50%{opacity:0.3;filter:brightness(0.5);}}
            @keyframes vegasBounce{0%,100%{transform:scale(1);}50%{transform:scale(1.15);}}
            @keyframes crmTextPop{0%,100%{transform:scale(1);opacity:1;}15%{transform:scale(0) translateY(20px);opacity:0;}30%{transform:scale(1.2) translateY(-5px);opacity:1;}40%{transform:scale(1);}}
            @keyframes crmShimmer{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
            @keyframes crmPulse{0%,100%{transform:scale(1);box-shadow:0 2px 12px rgba(34,197,94,.4)}50%{transform:scale(1.03);box-shadow:0 4px 20px rgba(34,197,94,.6)}}
            @keyframes crmBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
          </style>
        </div>

        <!-- Calendario + Membres√≠as -->
        <div style="margin-top:4px; padding-top:4px; border-top:1px solid rgba(255,255,255,0.1);">
          <button class="btn btn-secondary" onclick="showScreen('studentCalendarScreen')" style="margin-top:3px;padding:11px;font-size:14px; background: linear-gradient(135deg, #4338ca, #3730a3); color:white;">üìÖ Calendario de Clases en Vivo</button>
          <button class="btn btn-secondary" onclick="showScreen('membresiasScreen')" style="margin-top:3px;padding:11px;font-size:14px; background: linear-gradient(135deg, #9333ea, #7e22ce); color:white;">üëë Membres√≠as en Vivo</button>
        </div>
        
        <div style="text-align:center; margin-top:6px; padding-top:6px; border-top:1px solid rgba(255,255,255,0.1);">
          <span class="admin-link" onclick="showScreen('adminLoginScreen')">üîê Acceso Administrador</span>
        </div>
        <div style="text-align:center; margin-top:4px;">
          <button class="btn btn-secondary" onclick="cerrarSesion()" style="background:rgba(231,76,60,0.15); border:1px solid rgba(231,76,60,0.4); color:#e74c3c; font-size:12px; padding:6px 16px;">üö™ Cerrar Sesi√≥n</button>
        </div>
        
        <!-- ACVOLT School Info -->
        <div style="margin-top:6px;padding:6px 10px;background:#f1f5f9;border-radius:8px;text-align:center;">
          <div style="font-size:9px;color:#475569;line-height:1.5;">
            üìç 484 E Valley Blvd, Colton, CA 92324 ¬∑ üìû <a href="tel:9098244849" style="color:#2563eb;text-decoration:none;">909-824-4849</a><br>
            ‚úâÔ∏è <a href="mailto:ventas@acvolt.school" style="color:#2563eb;text-decoration:none;">ventas@acvolt.school</a> ¬∑ üåê <a href="https://acvolt.school" target="_blank" style="color:#2563eb;text-decoration:none;">acvolt.school</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Register Screen -->
    <div class="screen" id="registerScreen">
      <div class="header">
        <img src="logo.png" alt="ACVOLT" class="logo-img">
        <h1>MAESTRO ACVOLT</h1>
        <h2>Registro de T√©cnico</h2>
      </div>
      <div class="card">
        <form id="registerForm">
          <div class="form-group">
            <label>Nombre Completo *</label>
            <input type="text" id="nombre" placeholder="Ingresa tu nombre completo" required>
          </div>
          <div class="form-group">
            <label>Email *</label>
            <input type="email" id="email" placeholder="tu@email.com" required>
          </div>
          <div class="form-group">
            <label>Tel√©fono</label>
            <input type="tel" id="telefono" placeholder="(123) 456-7890">
          </div>
          <div class="form-group">
            <label>Ciudad</label>
            <input type="text" id="ciudad" placeholder="Tu ciudad">
          </div>
          <div class="form-group">
            <label>Estado</label>
            <input type="text" id="estado" placeholder="Tu estado (ej: California)">
          </div>
          <div class="form-group">
            <label>N√∫mero EPA 608</label>
            <input type="text" id="epa" placeholder="N√∫mero de certificaci√≥n EPA">
          </div>
          <div class="form-group">
            <label>N√∫mero NATE</label>
            <input type="text" id="nate" placeholder="N√∫mero de certificaci√≥n NATE">
          </div>
          <div class="form-group">
            <label>N√∫mero ESCO</label>
            <input type="text" id="esco" placeholder="N√∫mero de certificaci√≥n ESCO">
          </div>
          <button type="submit" class="btn btn-primary">Crear Perfil</button>
        </form>
      </div>
    </div>

    <!-- Levels Screen -->
    <div class="screen" id="levelsScreen">
      <div class="header">
        <img src="logo.png" alt="ACVOLT" class="logo-img" style="max-width:120px;">
        <p class="greeting" id="userGreeting">Hola, T√©cnico</p>
        <h1>Selecciona tu Nivel</h1>
        <p class="subtitle">Elige un nivel para comenzar el quiz</p>
      </div>
      <button class="btn btn-secondary" onclick="showScreen('welcomeScreen')" style="margin-bottom:8px;">‚Üê Volver al Men√∫</button>
      
      <div id="levelsList"></div>

      <!-- Memberships Grid -->
      <!-- Access Code Section -->
      <div style="background:linear-gradient(135deg,#2c3e50,#3498db);border-radius:16px;padding:20px;margin:20px 0;text-align:center;color:white;">
        <h3 style="margin:0 0 8px 0;font-size:18px;">üîì Desbloquear Niveles</h3>
        <p style="margin:0 0 15px 0;font-size:13px;opacity:0.9;">Ingresa tu c√≥digo de acceso o solicita uno</p>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
          <input type="text" id="accessCodeInput" placeholder="Ingresa tu c√≥digo" 
            style="padding:10px 15px;border-radius:8px;border:2px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.15);color:white;font-size:14px;width:180px;text-align:center;text-transform:uppercase;" 
            maxlength="8">
          <button onclick="redeemAccessCode()" 
            style="padding:10px 20px;border-radius:8px;border:none;background:#27ae60;color:white;font-weight:bold;cursor:pointer;font-size:14px;">‚úÖ Activar</button>
        </div>
        <button onclick="requestAccessCode()" 
          style="margin-top:12px;padding:8px 20px;border-radius:8px;border:2px solid rgba(255,255,255,0.4);background:transparent;color:white;cursor:pointer;font-size:13px;">üì© Solicitar C√≥digo de Acceso</button>
        <div id="accessCodeMessage" style="margin-top:10px;font-size:13px;display:none;"></div>
      </div>

      <!-- Soporte -->
      <div style="margin-top:20px;background:#fff;border-radius:12px;padding:18px;border:1px solid #e2e8f0;"><h3 style="color:#1565C0;text-align:center;margin-bottom:12px;font-size:16px;">üõ†Ô∏è Soporte T√©cnico</h3><p style="text-align:center;color:#64748b;font-size:13px;margin-bottom:12px;">¬øNecesitas ayuda?</p><div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;"><button onclick="window.open('https://wa.me/19096390448?text=Hola%20ACVOLT','_blank')" style="background:linear-gradient(135deg,#25D366,#128C7E);color:white;border:none;border-radius:10px;padding:12px 8px;cursor:pointer;font-size:12px;font-weight:600;">üí¨ WhatsApp</button><button onclick="openEmailComposer('Techschoolacvolt@gmail.com','Soporte T√©cnico - ACVOLT','Hola, necesito ayuda con...','üìß Soporte T√©cnico')" style="background:linear-gradient(135deg,#1565C0,#0D47A1);color:white;border:none;border-radius:10px;padding:12px 8px;cursor:pointer;font-size:12px;font-weight:600;">üìß Email</button></div></div>
    </div>

    <!-- Membres√≠as en Vivo Screen -->
    <div class="screen" id="membresiasScreen">
      <div class="header" style="padding:8px 0 4px;">
        <h1 style="font-size:22px;margin:0;">üëë Membres√≠as en Vivo</h1>
        <p class="subtitle" style="margin:4px 0 8px;font-size:13px;">Clases en vivo con Maestro Mario</p>
      </div>
      <button class="btn btn-secondary" onclick="showScreen('welcomeScreen')" style="margin-bottom:8px;">‚Üê Volver al Men√∫</button>
      
      <!-- Maestro Mario Quote -->
      <div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:14px;padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:12px;border:1px solid rgba(243,156,18,0.3);">
        <div style="min-width:50px;width:50px;height:50px;border-radius:50%;overflow:hidden;border:2px solid #f39c12;">
          <img src="mario-black.jpg" alt="Mario" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';this.parentElement.innerHTML='üë®‚Äçüè´';">
        </div>
        <div>
          <div style="color:#f39c12;font-weight:800;font-size:13px;">Maestro Mario</div>
          <div style="color:#e2e8f0;font-size:12px;line-height:1.4;font-style:italic;">"Invierte en tu educaci√≥n y tu carrera te lo devuelve 100x. Mis estudiantes est√°n ganando $30-$80/hr en el campo."</div>
        </div>
      </div>

      <div style="display:grid; grid-template-columns: repeat(1, 1fr); gap:10px;">
        <!-- Principiante $119 -->
        <div style="background:linear-gradient(135deg,#fef3c7,#fde68a);border-radius:14px;padding:16px;border:2px solid #f59e0b;">
          <div style="text-align:center;">
            <div style="font-size:28px;">ü•â</div>
            <div style="font-size:18px;font-weight:900;color:#92400e;">Principiante</div>
            <div style="font-size:28px;font-weight:900;color:#d97706;margin:4px 0;">$119<span style="font-size:14px;font-weight:600;">/mes</span></div>
          </div>
          <div style="margin:10px 0;border-top:1px solid rgba(146,64,14,0.2);padding-top:10px;">
            <div style="font-size:12px;color:#78350f;line-height:1.8;">
              ‚úÖ Clases en VIVO Martes y Mi√©rcoles 6-10PM PST<br>
              ‚úÖ Preguntas y Respuestas en VIVO ‚Äî Lunes 6-10PM<br>
              ‚úÖ Clases en l√≠nea por acvolt.school<br>
              ‚úÖ Acceso TOTAL a la App de entrenamiento<br>
              ‚úÖ Grupo privado de WhatsApp ‚Äî Comunidad + Soporte<br>
              ‚úÖ Certificado de participaci√≥n
            </div>
          </div>
          <div style="text-align:center;">
            <div onclick="window.open('https://buy.stripe.com/9B6cN52rB6tagjd1nV3sI04','_blank')" style="cursor:pointer;background:#f59e0b;color:white;padding:10px 20px;border-radius:10px;display:inline-block;font-weight:800;font-size:14px;">üí≥ Suscribirme</div>
          </div>
        </div>
        
        <!-- Intermedio $299 -->
        <div style="background:linear-gradient(135deg,#e0e7ff,#c7d2fe);border-radius:14px;padding:16px;border:2px solid #6366f1;">
          <div style="text-align:center;">
            <div style="font-size:14px;font-weight:800;color:#fff;background:#6366f1;border-radius:20px;display:inline-block;padding:2px 12px;margin-bottom:4px;">‚≠ê M√ÅS POPULAR</div>
            <div style="font-size:28px;">ü•à</div>
            <div style="font-size:18px;font-weight:900;color:#3730a3;">Intermedio</div>
            <div style="font-size:28px;font-weight:900;color:#4f46e5;margin:4px 0;">$299<span style="font-size:14px;font-weight:600;">/mes</span></div>
          </div>
          <div style="margin:10px 0;border-top:1px solid rgba(55,48,163,0.2);padding-top:10px;">
            <div style="font-size:12px;color:#312e81;line-height:1.8;">
              ‚úÖ <strong>TODO lo del plan Principiante</strong> +<br>
              ‚úÖ Clases S√°bado y Domingo 7-11AM PST<br>
              ‚úÖ üî• <strong>La Trinidad del Oficio:</strong><br>
              <span style="margin-left:18px;">‚ö° Electricidad Residencial y Comercial</span><br>
              <span style="margin-left:18px;">‚ùÑÔ∏è Aire Acondicionado Comercial</span><br>
              <span style="margin-left:18px;">üßä Refrigeraci√≥n Comercial</span><br>
              ‚úÖ Preparaci√≥n para certificaciones EPA, OSHA, NATE<br>
              ‚úÖ Soporte directo por WhatsApp con Maestro Mario
            </div>
          </div>
          <div style="text-align:center;">
            <div onclick="window.open('https://buy.stripe.com/7sYcN5d6feZG3wr2rZ3sI0e','_blank')" style="cursor:pointer;background:#6366f1;color:white;padding:10px 20px;border-radius:10px;display:inline-block;font-weight:800;font-size:14px;">üí≥ Suscribirme</div>
          </div>
        </div>
        
        <!-- Mentor√≠a $699 -->
        <div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:14px;padding:16px;border:2px solid #ffd700;box-shadow:0 0 20px rgba(255,215,0,0.2);">
          <div style="text-align:center;">
            <div style="font-size:14px;font-weight:800;color:#1a1a2e;background:linear-gradient(135deg,#ffd700,#f59e0b);border-radius:20px;display:inline-block;padding:2px 12px;margin-bottom:4px;">üèÜ PREMIUM</div>
            <div style="font-size:28px;">ü•á</div>
            <div style="font-size:18px;font-weight:900;color:#ffd700;">Mentor√≠a</div>
            <div style="font-size:28px;font-weight:900;color:#fbbf24;margin:4px 0;">$699<span style="font-size:14px;font-weight:600;">/mes</span></div>
          </div>
          <div style="margin:10px 0;border-top:1px solid rgba(255,215,0,0.2);padding-top:10px;">
            <div style="font-size:12px;color:#e2e8f0;line-height:1.8;">
              ‚úÖ <strong style="color:#ffd700;">TODO lo del plan Intermedio</strong> +<br>
              ‚úÖ Mentor√≠a Profesional de Contratista<br>
              ‚úÖ Clases Pregrabadas ‚Äî acceso completo<br>
              ‚úÖ Acceso prioritario ‚Äî preguntas respondidas primero<br>
              ‚úÖ Ayuda para iniciar tu propio negocio HVAC
            </div>
          </div>
          <div style="text-align:center;">
            <div onclick="window.open('https://buy.stripe.com/6oU28r3vF5p6aYTaYv3sI0d','_blank')" style="cursor:pointer;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:10px 20px;border-radius:10px;display:inline-block;font-weight:800;font-size:14px;">üí≥ Suscribirme</div>
          </div>
        </div>
      </div>
      
      <!-- Garant√≠a -->
      <div style="text-align:center;margin-top:12px;padding:10px;background:#f0fdf4;border-radius:10px;border:1px solid #bbf7d0;">
        <div style="font-size:12px;color:#166534;font-weight:600;">üõ°Ô∏è Cancela cuando quieras ‚Äî sin contratos ni penalidades</div>
      </div>
    </div>

    <!-- Certificaciones Oficiales Screen -->
    <div class="screen" id="certOficialesScreen">
      <div class="header" style="padding:8px 0 4px;">
        <h1 style="font-size:20px;margin:0;">üèÜ Obt√©n tus Certificados Oficiales</h1>
        <p class="subtitle" style="margin:4px 0 8px;font-size:13px;">Prep√°rate para tus certificaciones profesionales</p>
      </div>
      <button class="btn btn-secondary" onclick="showScreen('welcomeScreen')" style="margin-bottom:10px;">‚Üê Volver al Men√∫</button>
      
      <!-- Insignias - matching acvolt.school -->
      <div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:14px;padding:14px;border:2px solid rgba(243,156,18,0.3);margin-bottom:12px;">
        <div style="display:flex;justify-content:center;gap:12px;flex-wrap:wrap;">
          <div style="text-align:center;">
            <div style="width:56px;height:56px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 4px;border:3px solid #ffd700;box-shadow:0 0 12px rgba(255,215,0,0.3);"><span style="color:#1a237e;font-weight:900;font-size:10px;letter-spacing:-0.5px;">OSHA</span></div>
            <div style="font-size:9px;color:#ffd700;font-weight:600;">OSHA</div>
          </div>
          <div style="text-align:center;">
            <div style="width:56px;height:56px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 4px;border:3px solid #ffd700;box-shadow:0 0 12px rgba(255,215,0,0.3);"><span style="color:#c62828;font-weight:900;font-size:10px;">NATE</span></div>
            <div style="font-size:9px;color:#ffd700;font-weight:600;">NATE</div>
          </div>
          <div style="text-align:center;">
            <div style="width:56px;height:56px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 4px;border:3px solid #ffd700;box-shadow:0 0 12px rgba(255,215,0,0.3);"><span style="color:#1565C0;font-weight:900;font-size:8px;">NCCER</span></div>
            <div style="font-size:9px;color:#ffd700;font-weight:600;">NCCER</div>
          </div>
          <div style="text-align:center;">
            <div style="width:56px;height:56px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 4px;border:3px solid #ffd700;box-shadow:0 0 12px rgba(255,215,0,0.3);"><span style="color:#2e7d32;font-weight:900;font-size:10px;">EPA</span></div>
            <div style="font-size:9px;color:#ffd700;font-weight:600;">EPA</div>
          </div>
        </div>
      </div>

      <!-- 6 Course Cards -->
      <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;">
        <div class="cert-card" onclick="openCertCourse('epa608')">
          <div class="cert-icon"><svg width="28" height="28" viewBox="0 0 32 32"><rect x="4" y="2" width="24" height="28" rx="3" fill="#1565C0"/><rect x="7" y="5" width="18" height="4" rx="1" fill="#fff"/><text x="16" y="8.2" text-anchor="middle" font-size="3.2" fill="#1565C0" font-weight="bold">EPA 608</text><rect x="7" y="22" width="8" height="5" rx="1" fill="#FFD700"/><text x="11" y="25.5" text-anchor="middle" font-size="3" fill="#1565C0" font-weight="bold">ID</text><circle cx="22" cy="24" r="3" fill="#4CAF50"/><path d="M20.5 24L21.5 25L23.5 23" stroke="#fff" stroke-width=".8"/></svg></div>
          <div class="cert-name">EPA 608</div>
          <div class="cert-price">Estudio Gratis</div>
        </div>
        <div class="cert-card" onclick="openCertCourse('osha')">
          <div class="cert-icon"><svg width="28" height="28" viewBox="0 0 32 32"><rect x="10" y="4" width="3" height="22" rx="1" fill="#FF9800"/><rect x="19" y="4" width="3" height="22" rx="1" fill="#FF9800"/><rect x="8" y="8" width="16" height="2" rx=".5" fill="#FFB74D"/><rect x="8" y="15" width="16" height="2" rx=".5" fill="#FFB74D"/><rect x="8" y="22" width="16" height="2" rx=".5" fill="#FFB74D"/><rect x="1" y="24" width="10" height="6" rx="2" fill="#E53935"/><rect x="1" y="17" width="3" height="9" rx="1" fill="#E53935"/><circle cx="2.5" cy="16" r="1.5" fill="#E53935"/></svg></div>
          <div class="cert-name">OSHA</div>
          <div class="cert-price">Estudio Gratis</div>
        </div>
        <div class="cert-card" onclick="openCertCourse('a2l')">
          <div class="cert-icon"><svg width="28" height="28" viewBox="0 0 32 32"><rect x="10" y="2" width="12" height="24" rx="5" fill="#42A5F5"/><rect x="12" y="4" width="8" height="20" rx="3.5" fill="#BBDEFB"/><text x="16" y="16" text-anchor="middle" font-size="5" fill="#1565C0" font-weight="bold">R32</text><circle cx="16" cy="6" r="1.5" fill="#1565C0"/><rect x="13" y="24" width="6" height="4" rx="1" fill="#1565C0"/></svg></div>
          <div class="cert-name">A2L</div>
          <div class="cert-price">Estudio Gratis</div>
        </div>
        <div class="cert-card" onclick="openCertCourse('calefaccion')">
          <div class="cert-icon">üî•</div>
          <div class="cert-name">Calefacci√≥n</div>
          <div class="cert-price">Estudio Gratis</div>
        </div>
        <div class="cert-card" onclick="openCertCourse('hvaccore')">
          <div class="cert-icon">‚ùÑÔ∏è</div>
          <div class="cert-name">HVAC Core</div>
          <div class="cert-price">Estudio Gratis</div>
        </div>
        <div class="cert-card" onclick="openCertCourse('hvacr')">
          <div class="cert-icon"><svg width="28" height="28" viewBox="0 0 32 32"><rect width="16" height="32" fill="#E3F2FD" rx="2"/><rect x="16" width="16" height="32" fill="#FFF3E0" rx="2"/><path d="M8 8L5 14L8 12L11 14Z" fill="#42A5F5"/><circle cx="8" cy="6" r="1.5" fill="#42A5F5"/><path d="M24 16C24 13 22 11 22 9C22 7 23 6 24 6C25 6 26 7 26 9C26 11 24 13 24 16Z" fill="#FF9800"/><circle cx="24" cy="18" r="1.5" fill="#E65100"/></svg></div>
          <div class="cert-name">HVACR</div>
          <div class="cert-price">Estudio Gratis</div>
        </div>
      </div>
    </div>

    <!-- Certification Course Screen -->
    <div class="screen" id="certCourseScreen">
      <div class="quiz-header">
        <button class="back-btn" onclick="showScreen('levelsScreen')">‚Üê Volver</button>
        <span class="question-category" id="certCourseTitle">Certificaci√≥n</span>
      </div>
      <div style="text-align:center; padding:20px 10px;">
        <div id="certCourseIcon" style="font-size:60px; margin-bottom:10px;"></div>
        <h2 id="certCourseName" style="color:#1e293b; margin-bottom:5px;"></h2>
        <p id="certCourseDesc" style="color:#64748b; font-size:14px; margin-bottom:20px;"></p>
        
        <div style="background:rgba(255,255,255,0.1); border-radius:15px; padding:15px; margin-bottom:15px;">
          <h3 style="color:#2ecc71; margin-bottom:10px; font-size:16px;">üìö Secciones de Estudio (GRATIS)</h3>
          <p style="color:#64748b; font-size:13px; margin-bottom:12px;">700 preguntas de pr√°ctica para prepararte</p>
          <div id="certStudySections" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;"></div>
          <button class="btn btn-primary" id="certStartStudyBtn" onclick="startCertStudy()" style="margin-top:12px; width:100%; background:linear-gradient(135deg, #27ae60, #2ecc71);">
            üìñ Comenzar Estudio
          </button>
        </div>

        <div style="background:linear-gradient(135deg, rgba(243,156,18,0.2), rgba(231,76,60,0.2)); border:2px solid rgba(243,156,18,0.5); border-radius:15px; padding:15px;">
          <h3 style="color:#f39c12; margin-bottom:8px; font-size:16px;">üéì Solicitar Examen de Certificaci√≥n</h3>
          <p style="color:#64748b; font-size:13px; margin-bottom:5px;">Cuando est√©s listo, solicita tu examen oficial</p>
          <p id="certExamPrice" style="color:#f39c12; font-size:22px; font-weight:bold; margin-bottom:12px;"></p>
          <button class="btn btn-primary" id="certExamBtn" onclick="requestCertExam()" style="width:100%; background:linear-gradient(135deg, #f39c12, #e67e22);">
            üîí Solicitar Examen
          </button>
        </div>
      </div>
    </div>

    <!-- Quiz Screen -->
    <div class="screen" id="quizScreen">
      <div class="quiz-header">
        <button class="back-btn" onclick="confirmExit()">‚Üê Volver</button>
        <span class="question-category" id="questionCategory">Categor√≠a</span>
        <span class="question-count" id="questionCount">1/50</span>
      </div>
      <div class="question-text" id="questionText">Pregunta...</div>
      <div class="options" id="optionsContainer"></div>
      <div class="feedback" id="feedback">
        <strong id="feedbackTitle">Correcto!</strong>
        <p id="feedbackText"></p>
      </div>
      <!-- Navegaci√≥n tipo examen: botones lado a lado -->
      <div id="quizNavigation" style="display:flex; justify-content:center; margin-top:20px; gap:15px;">
        <button class="btn" id="prevBtn" onclick="prevQuestion()" style="background:#6b7280; color:white; padding:12px 25px; border-radius:8px; font-weight:bold; min-width:130px;">‚Üê Anterior</button>
        <button class="btn" id="nextBtn" onclick="nextQuestion()" style="background:#6366f1; color:white; padding:12px 25px; border-radius:8px; font-weight:bold; min-width:130px;">Siguiente ‚Üí</button>
      </div>
      <!-- Indicadores de estado: contestadas (verde) y flags (rojo) -->
      <div id="quizStatusIndicators" style="display:flex; justify-content:center; margin-top:15px; gap:25px;">
        <div style="display:flex; align-items:center; gap:8px; background:#dcfce7; padding:8px 16px; border-radius:20px;">
          <span style="background:#22c55e; color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">‚úì</span>
          <span style="color:#166534; font-weight:bold;"><span id="answeredCount">0</span> Contestadas</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px; background:#fee2e2; padding:8px 16px; border-radius:20px;">
          <span style="background:#ef4444; color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">üö©</span>
          <span style="color:#991b1b; font-weight:bold;"><span id="flaggedCount">0</span> Sin contestar</span>
        </div>
      </div>
    </div>

    <!-- Results Screen -->
    <div class="screen" id="resultsScreen">
      <div class="results">
        <div class="header">
          <div class="logo" id="resultsIcon">üèÜ</div>
          <h1 id="resultsTitle">¬°Excelente!</h1>
          <p class="subtitle" id="resultsSubtitle">Quiz completado</p>
        </div>
        <div class="score-circle">
          <svg width="180" height="180">
            <circle class="score-bg" cx="90" cy="90" r="78"/>
            <circle class="score-fill" id="scoreCircle" cx="90" cy="90" r="78" stroke-dasharray="490" stroke-dashoffset="490"/>
          </svg>
          <div class="score-text">
            <div class="score-value" id="scoreValue">0%</div>
            <div class="score-label">Puntuaci√≥n</div>
          </div>
        </div>
        <div class="stats">
          <div class="stat correct">
            <div class="stat-value" id="correctCount">0</div>
            <div class="stat-label">Correctas</div>
          </div>
          <div class="stat incorrect">
            <div class="stat-value" id="incorrectCount">0</div>
            <div class="stat-label">Incorrectas</div>
          </div>
          <div class="stat time">
            <div class="stat-value" id="timeSpent">0:00</div>
            <div class="stat-label">Tiempo</div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="retryQuiz()">üîÑ Intentar de Nuevo</button>
        <button class="btn btn-secondary" onclick="showScreen('levelsScreen')">‚Üê Volver a Niveles</button>
      </div>
    </div>

    <!-- Quiz Only Screen (without registration) -->
    <div class="screen" id="quizOnlyScreen">
      <div class="header">
        <div class="logo">‚ùÑÔ∏èüîß</div>
        <h1>Prueba tu Conocimiento</h1>
        <p class="subtitle">50 Preguntas de HVAC</p>
      </div>
      <div class="card">
        <p style="margin-bottom:20px;">Este quiz incluye preguntas sobre:</p>
        <ul style="margin-left:20px; margin-bottom:20px; line-height:1.8;">
          <li>Herramientas y equipos</li>
          <li>Instalaci√≥n</li>
          <li>Tuber√≠a</li>
          <li>Soldadura</li>
          <li>Vac√≠o</li>
          <li>Recuperaci√≥n de refrigerante</li>
          <li>Electricidad b√°sica</li>
          <li>Refrigeraci√≥n b√°sica</li>
        </ul>
        <button class="btn btn-primary" onclick="startQuickQuiz()">Comenzar Quiz</button>
        <button class="btn btn-secondary" onclick="showScreen('welcomeScreen')">‚Üê Volver</button>
      </div>
    </div>

    <!-- Study Sections Screen -->
    <div class="screen" id="studySectionsScreen">
      <div class="header">
        <img src="logo.png" alt="ACVOLT" class="logo-img" style="max-width:80px;">
        <h1>Desarrollo de Habilidades</h1>
        <p class="subtitle">Selecciona tu especialidad</p>
      </div>
      <div class="study-level-tabs" id="studyLevelTabs"></div>
      
      <!-- 9 Specialty Grid -->
      <div id="specialtyGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:15px;">
        <div class="specialty-card" onclick="showSpecialtyCategories('electricidad-residencial')" style="background:linear-gradient(135deg,#fbbf24,#f59e0b);border-radius:16px;padding:16px 10px;text-align:center;cursor:pointer;color:#fff;box-shadow:0 4px 15px rgba(245,158,11,0.3);transition:all 0.3s;">
          <div style="font-size:32px;margin-bottom:6px;">‚ö°</div>
          <div style="font-size:12px;font-weight:800;line-height:1.2;">Electricidad</div>
          <div style="font-size:10px;opacity:0.9;">Residencial</div>
        </div>
        <div class="specialty-card" onclick="showSpecialtyCategories('electricidad-comercial')" style="background:linear-gradient(135deg,#f97316,#ea580c);border-radius:16px;padding:16px 10px;text-align:center;cursor:pointer;color:#fff;box-shadow:0 4px 15px rgba(249,115,22,0.3);transition:all 0.3s;">
          <div style="font-size:32px;margin-bottom:6px;">‚ö°</div>
          <div style="font-size:12px;font-weight:800;line-height:1.2;">Electricidad</div>
          <div style="font-size:10px;opacity:0.9;">Comercial</div>
        </div>
        <div class="specialty-card" onclick="showSpecialtyCategories('electricidad-industrial')" style="background:linear-gradient(135deg,#ef4444,#dc2626);border-radius:16px;padding:16px 10px;text-align:center;cursor:pointer;color:#fff;box-shadow:0 4px 15px rgba(239,68,68,0.3);transition:all 0.3s;">
          <div style="font-size:32px;margin-bottom:6px;">‚ö°</div>
          <div style="font-size:12px;font-weight:800;line-height:1.2;">Electricidad</div>
          <div style="font-size:10px;opacity:0.9;">Industrial</div>
        </div>
        <div class="specialty-card" onclick="showSpecialtyCategories('ac-residencial')" style="background:linear-gradient(135deg,#3b82f6,#2563eb);border-radius:16px;padding:16px 10px;text-align:center;cursor:pointer;color:#fff;box-shadow:0 4px 15px rgba(59,130,246,0.3);transition:all 0.3s;">
          <div style="font-size:32px;margin-bottom:6px;">‚ùÑÔ∏è</div>
          <div style="font-size:12px;font-weight:800;line-height:1.2;">Aire Acond.</div>
          <div style="font-size:10px;opacity:0.9;">Residencial</div>
        </div>
        <div class="specialty-card" onclick="showSpecialtyCategories('ac-comercial')" style="background:linear-gradient(135deg,#6366f1,#4f46e5);border-radius:16px;padding:16px 10px;text-align:center;cursor:pointer;color:#fff;box-shadow:0 4px 15px rgba(99,102,241,0.3);transition:all 0.3s;">
          <div style="font-size:32px;margin-bottom:6px;">‚ùÑÔ∏è</div>
          <div style="font-size:12px;font-weight:800;line-height:1.2;">Aire Acond.</div>
          <div style="font-size:10px;opacity:0.9;">Comercial</div>
        </div>
        <div class="specialty-card" onclick="showSpecialtyCategories('ac-industrial')" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);border-radius:16px;padding:16px 10px;text-align:center;cursor:pointer;color:#fff;box-shadow:0 4px 15px rgba(139,92,246,0.3);transition:all 0.3s;">
          <div style="font-size:32px;margin-bottom:6px;">‚ùÑÔ∏è</div>
          <div style="font-size:12px;font-weight:800;line-height:1.2;">Aire Acond.</div>
          <div style="font-size:10px;opacity:0.9;">Industrial</div>
        </div>
        <div class="specialty-card" onclick="showSpecialtyCategories('refri-residencial')" style="background:linear-gradient(135deg,#06b6d4,#0891b2);border-radius:16px;padding:16px 10px;text-align:center;cursor:pointer;color:#fff;box-shadow:0 4px 15px rgba(6,182,212,0.3);transition:all 0.3s;">
          <div style="font-size:32px;margin-bottom:6px;">üßä</div>
          <div style="font-size:12px;font-weight:800;line-height:1.2;">Refrigeraci√≥n</div>
          <div style="font-size:10px;opacity:0.9;">Residencial</div>
        </div>
        <div class="specialty-card" onclick="showSpecialtyCategories('refri-comercial')" style="background:linear-gradient(135deg,#14b8a6,#0d9488);border-radius:16px;padding:16px 10px;text-align:center;cursor:pointer;color:#fff;box-shadow:0 4px 15px rgba(20,184,166,0.3);transition:all 0.3s;">
          <div style="font-size:32px;margin-bottom:6px;">üßä</div>
          <div style="font-size:12px;font-weight:800;line-height:1.2;">Refrigeraci√≥n</div>
          <div style="font-size:10px;opacity:0.9;">Comercial</div>
        </div>
        <div class="specialty-card" onclick="showSpecialtyCategories('refri-industrial')" style="background:linear-gradient(135deg,#10b981,#059669);border-radius:16px;padding:16px 10px;text-align:center;cursor:pointer;color:#fff;box-shadow:0 4px 15px rgba(16,185,129,0.3);transition:all 0.3s;">
          <div style="font-size:32px;margin-bottom:6px;">üßä</div>
          <div style="font-size:12px;font-weight:800;line-height:1.2;">Refrigeraci√≥n</div>
          <div style="font-size:10px;opacity:0.9;">Industrial</div>
        </div>
      </div>

      <!-- C√≥digos, Manuales & Certificaciones -->
      <div style="margin:10px 0 8px;padding-top:8px;">
        <p style="text-align:center;font-size:13px;font-weight:700;color:#64748b;letter-spacing:1px;text-transform:uppercase;">üìñ C√≥digos, Manuales & Certificaciones</p>
      </div>
      <div id="codesGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:15px;">
        <div class="specialty-card" onclick="showSpecialtyCategories('acca-residencial')" style="background:linear-gradient(135deg,#1e40af,#1d4ed8);border-radius:16px;padding:16px 10px;text-align:center;cursor:pointer;color:#fff;box-shadow:0 4px 15px rgba(30,64,175,0.3);transition:all 0.3s;">
          <div style="font-size:28px;margin-bottom:6px;">üìò</div>
          <div style="font-size:11px;font-weight:800;line-height:1.2;">Manuales</div>
          <div style="font-size:10px;opacity:0.9;">ACCA</div>
        </div>
        <div class="specialty-card" onclick="showSpecialtyCategories('acca-comercial')" style="background:linear-gradient(135deg,#1e3a8a,#1e40af);border-radius:16px;padding:16px 10px;text-align:center;cursor:pointer;color:#fff;box-shadow:0 4px 15px rgba(30,58,138,0.3);transition:all 0.3s;">
          <div style="font-size:28px;margin-bottom:6px;">üìò</div>
          <div style="font-size:11px;font-weight:800;line-height:1.2;">ACCA</div>
          <div style="font-size:10px;opacity:0.9;">A/C Comercial</div>
        </div>
        <div class="specialty-card" onclick="showSpecialtyCategories('ashrae')" style="background:linear-gradient(135deg,#0f766e,#0d9488);border-radius:16px;padding:16px 10px;text-align:center;cursor:pointer;color:#fff;box-shadow:0 4px 15px rgba(15,118,110,0.3);transition:all 0.3s;">
          <div style="font-size:28px;margin-bottom:6px;">üìó</div>
          <div style="font-size:11px;font-weight:800;line-height:1.2;">Manuales</div>
          <div style="font-size:10px;opacity:0.9;">ASHRAE</div>
        </div>
        <div class="specialty-card" onclick="showSpecialtyCategories('nec')" style="background:linear-gradient(135deg,#b91c1c,#dc2626);border-radius:16px;padding:16px 10px;text-align:center;cursor:pointer;color:#fff;box-shadow:0 4px 15px rgba(185,28,28,0.3);transition:all 0.3s;">
          <div style="font-size:28px;margin-bottom:6px;">üìï</div>
          <div style="font-size:11px;font-weight:800;line-height:1.2;">C√≥digo</div>
          <div style="font-size:10px;opacity:0.9;">NEC</div>
        </div>
        <div class="specialty-card" onclick="showSpecialtyCategories('nfpa54')" style="background:linear-gradient(135deg,#c2410c,#ea580c);border-radius:16px;padding:16px 10px;text-align:center;cursor:pointer;color:#fff;box-shadow:0 4px 15px rgba(194,65,12,0.3);transition:all 0.3s;">
          <div style="font-size:28px;margin-bottom:6px;">üìô</div>
          <div style="font-size:11px;font-weight:800;line-height:1.2;">C√≥digo</div>
          <div style="font-size:10px;opacity:0.9;">NFPA 54</div>
        </div>
        <div class="specialty-card" onclick="showSpecialtyCategories('bpi')" style="background:linear-gradient(135deg,#16a34a,#22c55e);border-radius:16px;padding:16px 10px;text-align:center;cursor:pointer;color:#fff;box-shadow:0 4px 15px rgba(22,163,74,0.3);transition:all 0.3s;">
          <div style="font-size:28px;margin-bottom:6px;">üèõÔ∏è</div>
          <div style="font-size:11px;font-weight:800;line-height:1.2;">Certificaci√≥n</div>
          <div style="font-size:10px;opacity:0.9;">BPI</div>
        </div>
      </div>

      <!-- Subcategories list (hidden by default, shows when specialty is clicked) -->
      <div id="specialtySubcategories" style="display:none;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
          <button onclick="document.getElementById('specialtySubcategories').style.display='none';document.getElementById('specialtyGrid').style.display='grid';document.getElementById('studyLevelTabs').style.display='flex';" style="background:#e2e8f0;border:none;color:#1e293b;padding:8px 15px;border-radius:8px;font-size:14px;cursor:pointer;">‚Üê Volver</button>
          <h3 id="specialtyTitle" style="margin:0;font-size:16px;color:#1e293b;"></h3>
        </div>
        <div id="studyCategoriesList"></div>
      </div>

      <button class="btn btn-secondary" onclick="showScreen('welcomeScreen')" style="margin-top:15px;">‚Üê Volver al Inicio</button>
    </div>

    <!-- Study Category Detail Screen -->
    <div class="screen" id="studyCategoryDetailScreen">
      <div class="study-back-nav">
        <button class="back-btn" onclick="showScreen('studySectionsScreen')">‚Üê Volver</button>
        <span class="study-breadcrumb" id="studyBreadcrumb">Principiante > Herramientas</span>
      </div>
      <div class="header" style="padding: 15px 0;">
        <h2 id="studyCategoryTitle">Categor√≠a</h2>
        <p class="subtitle" id="studyCategorySubtitle">0 preguntas</p>
      </div>
      <div id="studyQuestionsList"></div>
      <button class="btn btn-secondary" onclick="showScreen('studySectionsScreen')" style="margin-top:20px;">‚Üê Volver a Categor√≠as</button>
    </div>

    <!-- Video Lessons Screen -->
    <div class="screen" id="videoLessonsScreen">
      <div style="position:sticky;top:0;z-index:50;background:linear-gradient(135deg,#1a5276,#154360);padding:8px 15px;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid rgba(255,255,255,0.1);">
        <button onclick="showScreen('welcomeScreen')" style="background:#e2e8f0;border:none;color:#1e293b;padding:8px 15px;border-radius:8px;font-size:14px;cursor:pointer;">‚Üê Volver</button>
        <span style="color:#f39c12;font-weight:bold;font-size:14px;">üé• Clases Pregrabadas</span>
      </div>
      <div class="header" style="padding-top:10px;">
        <div class="logo">üé¨</div>
        <h1>Clases Pregrabadas</h1>
        <p class="subtitle">Zoom y YouTube ‚Äî organizados por categor√≠a</p>
      </div>
      
      <!-- Zoom Classes Button -->
      <div style="margin:0 15px 12px;background:linear-gradient(135deg,#2D8CFF,#0B5CFF);border-radius:12px;padding:14px;text-align:center;box-shadow:0 4px 15px rgba(45,140,255,0.3);">
        <div style="display:flex;align-items:center;justify-content:center;gap:10px;">
          <div style="width:40px;height:40px;background:#fff;border-radius:10px;display:flex;align-items:center;justify-content:center;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><rect x="1" y="5" width="15" height="14" rx="2" fill="#2D8CFF"/><path d="M17 9.5L22 7V17L17 14.5V9.5Z" fill="#2D8CFF"/><rect x="3" y="7" width="11" height="10" rx="1" fill="#fff"/></svg>
          </div>
          <div style="text-align:left;">
            <div style="color:#fff;font-weight:800;font-size:15px;">üìπ Clases por Zoom</div>
            <div style="color:rgba(255,255,255,0.8);font-size:11px;">635+ clases grabadas ¬∑ 2,000+ horas de contenido</div>
          </div>
        </div>
        <div style="margin-top:8px;background:rgba(255,255,255,0.15);border-radius:8px;padding:8px 12px;">
          <div style="color:#fff;font-weight:700;font-size:12px;">üîê Exclusivo para alumnos con membres√≠a</div>
          <div style="color:rgba(255,255,255,0.7);font-size:10px;margin-top:3px;">Tu c√≥digo se entrega al activar tu membres√≠a en<br><strong style="color:#fbbf24;">üëë Membres√≠as en Vivo</strong> desde el men√∫ principal</div>
        </div>
      </div>

      <!-- YouTube Section Header -->
      <div style="margin:0 15px 8px;"><div style="font-size:13px;font-weight:800;color:#1e293b;display:flex;align-items:center;gap:6px;">üì∫ Videos de YouTube</div></div>
      
      <!-- Level Filter Tabs -->
      <div class="video-level-tabs" id="videoLevelTabs">
        <button class="video-level-tab active" data-level="all" onclick="filterVideosByLevel('all')">üìö Todos</button>
      </div>
      
      <!-- Progress Summary -->
      <div class="video-progress-summary" id="videoProgressSummary">
        <span>Videos vistos: <span style="color:#f39c12;" id="videosWatchedCount">0</span> / <span id="videosTotalCount">0</span></span>
        <span><span style="color:#27ae60;" id="videosCompletionPercent">0%</span> completado</span>
      </div>
      
      <!-- Loading indicator -->
      <div id="videoLoadingIndicator" style="text-align:center; padding:40px; display:none;">
        <div style="font-size:40px; margin-bottom:15px;">‚è≥</div>
        <p style="color:#64748b;">Cargando videos desde YouTube...</p>
      </div>
      
      <!-- Error message -->
      <div id="videoErrorMessage" style="text-align:center; padding:40px; display:none;">
        <div style="font-size:40px; margin-bottom:15px;">‚ö†Ô∏è</div>
        <p style="color:#e74c3c;" id="videoErrorText">Error al cargar videos</p>
        <button class="btn btn-secondary" onclick="loadYouTubeVideos()" style="margin-top:15px;">Reintentar</button>
      </div>
      
      <div id="videoLessonsList"></div>
      <button class="btn btn-secondary" onclick="showScreen('welcomeScreen')" style="margin-top:20px;">‚Üê Volver al Inicio</button>
    </div>

    <!-- Video Player Screen -->
    <div class="screen" id="videoPlayerScreen">
      <div class="study-back-nav">
        <button class="back-btn" onclick="exitVideoPlayer()">‚Üê Volver</button>
        <span class="study-breadcrumb" id="videoBreadcrumb">Video Lecciones > Video</span>
      </div>
      <div class="video-player-container" id="videoPlayerContainer">
        <div id="youtubePlayerWrapper"></div>
        <video id="videoPlayer" playsinline style="display:none;">
          Tu navegador no soporta video HTML5.
        </video>
      </div>
      <div class="video-info">
        <h2 class="video-title" id="videoTitle">T√≠tulo del Video</h2>
        <p class="video-description" id="videoDescription">Descripci√≥n del video.</p>
      </div>
      <div class="video-status" id="videoStatusBadge">
        <span class="video-status-icon" id="videoStatusIcon">‚ñ∂Ô∏è</span>
        <div class="video-status-text">
          <div class="video-status-title" id="videoStatusTitle">En progreso</div>
          <div class="video-status-detail" id="videoStatusDetail">0% completado</div>
        </div>
      </div>
      <div class="video-lesson-progress" style="margin-bottom:20px;">
        <div class="video-progress-bar" style="height:10px;">
          <div class="video-progress-fill" id="videoProgressFill" style="width:0%"></div>
        </div>
        <div class="video-progress-text" id="videoProgressText" style="font-size:13px; margin-top:8px;">0:00 / 0:00</div>
      </div>
      <div class="video-controls">
        <button class="btn btn-video-primary" id="videoCTAButton" onclick="handleVideoCTA()">
          Continuar video
        </button>
        <button class="btn btn-video-secondary" id="videoMarkAsWatchedBtn" onclick="markVideoAsWatched()">
          Marcar como Visto
        </button>
      </div>
    </div>

    <!-- Certificates Screen -->
    <div class="screen" id="certificatesScreen">
      <div class="certificates-header">
        <div class="logo">üèÖ</div>
        <h1>Mis Certificados</h1>
        <p class="subtitle">Certificados obtenidos al aprobar cada nivel</p>
      </div>
      <div id="certificatesList"></div>
      <button class="btn btn-secondary" onclick="goBackFromCertificates()" style="margin-top:20px;">‚Üê Volver</button>
    </div>

    <!-- Mi Perfil Screen -->
    <!-- ============================================ -->
    <!-- PANTALLA: ASISTENCIA (T√âCNICO) -->
    <!-- ============================================ -->
    <div class="screen" id="attendanceScreen">
      <div class="container">
        <div class="header">
          <h1>üìã Mi Asistencia</h1>
          <p class="subtitle">Control de horas de entrenamiento</p>
        </div>
        <button class="btn btn-secondary" onclick="showScreen('welcomeScreen')" style="margin-bottom:15px;">‚Üê Volver al Men√∫</button>
        
        <!-- Class Schedule Info -->
        <div class="attendance-card" id="scheduleInfoCard" style="border:1px solid rgba(243,156,18,0.3);background:linear-gradient(135deg,rgba(243,156,18,0.08),rgba(230,126,34,0.05));">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
            <span style="font-size:28px;">üìÖ</span>
            <div>
              <p style="color:#f39c12;font-size:16px;font-weight:bold;margin:0;">Clases en Vivo</p>
              <p style="color:#64748b;font-size:13px;margin:0;">Mar y Mi√© 6-10 PM California = sin l√≠mite de inactividad</p>
            </div>
          </div>
          <div style="background:rgba(52,152,219,0.08);border-radius:8px;padding:10px;margin-bottom:8px;">
            <p style="color:#64748b;font-size:12px;margin:0;">‚è±Ô∏è <strong>M√°x 4 horas</strong> por sesi√≥n ¬∑ Fuera de clase: check-out auto si <strong>15 min sin actividad</strong></p>
          </div>
          <div id="scheduleStatusLine" style="text-align:center;padding:8px;border-radius:8px;font-size:13px;font-weight:bold;"></div>
        </div>
        <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
          (function updateScheduleStatus(){
            var el = document.getElementById('scheduleStatusLine');
            if(!el) return;
            var now = new Date();
            var ca = new Date(now.toLocaleString('en-US',{timeZone:'America/Los_Angeles'}));
            var day = ca.getDay(), hr = ca.getHours(), mn = ca.getMinutes();
            var totalMin = hr*60+mn;
            var isDay = (day===2||day===3);
            var isHour = (totalMin>=1080&&totalMin<=1320);
            var caStr = ca.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',hour12:true});
            var days = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
            if(isDay && isHour){
              el.style.background='rgba(39,174,96,0.15)'; el.style.color='#27ae60';
              el.innerHTML='üü¢ CLASE EN VIVO ‚Äî '+days[day]+' '+caStr+' ¬∑ Sin detecci√≥n de inactividad';
            } else {
              el.style.background='rgba(52,152,219,0.1)'; el.style.color='#3498db';
              el.innerHTML='üìñ Modo Estudio ‚Äî '+days[day]+' '+caStr+'<br><span style="font-size:11px;color:#94a3b8;">Check-out autom√°tico si 15 min sin actividad</span>';
            }
            setTimeout(updateScheduleStatus, 30000);
          })();
        </script>
        
        <div class="attendance-card">
          <div id="attendanceStatusBadge" class="attendance-status status-inactive">‚≠ï Sin Check-in</div>
          <div id="attendanceTimer" class="attendance-timer">00:00:00</div>
          <p style="margin-bottom:5px; color:#64748b; font-size:14px;">Tipo de clase:</p>
          <div class="attendance-type-selector" style="flex-wrap:wrap;">
            <div class="type-option selected" id="typePresencial" onclick="selectClassType('presencial')">üè´ Presencial</div>
            <div class="type-option" id="typeZoom" onclick="selectClassType('zoom')">üìπ Zoom</div>
            <div class="type-option" id="typeComputadora" onclick="selectClassType('computadora')">üñ•Ô∏è Computadora</div>
            <div class="type-option" id="typeMovil" onclick="selectClassType('movil')">üì± M√≥vil</div>
          </div>
          <button id="btnCheckIn" class="btn-checkin btn-checkin-in" onclick="doCheckIn()">‚úÖ HACER CHECK-IN</button>
          <button id="btnCheckOut" class="btn-checkin btn-checkin-out" onclick="doCheckOut()" style="display:none;">üõë HACER CHECK-OUT</button>
        </div>
        <div class="attendance-card">
          <h2 style="color:#E31937; margin-bottom:10px;">‚è±Ô∏è Horas Acumuladas</h2>
          <div class="attendance-summary-cards">
            <div class="att-summary-card">
              <div class="att-summary-number" id="attHoursToday">0</div>
              <div class="att-summary-text">Hoy</div>
            </div>
            <div class="att-summary-card">
              <div class="att-summary-number" id="attHoursWeek">0</div>
              <div class="att-summary-text">Esta Semana</div>
            </div>
            <div class="att-summary-card">
              <div class="att-summary-number" id="attHoursTotal">0</div>
              <div class="att-summary-text">Total</div>
            </div>
          </div>
        </div>
        <div class="attendance-card">
          <h2 style="color:#E31937; margin-bottom:10px;">üìÖ Historial Reciente</h2>
          <div id="attendanceHistory" class="attendance-history">
            <p style="color:#94a3b8; text-align:center;">Cargando historial...</p>
          </div>
        </div>
        <button class="btn btn-secondary" onclick="showScreen('welcomeScreen')" style="margin-top:15px;">‚Üê Volver al Men√∫</button>
      </div>
    </div>

    <div class="screen" id="miPerfilScreen">
      <!-- Bot√≥n Flotante Volver - Sigue el scroll -->
      <div id="floatingBackBtn" style="position:fixed;bottom:20px;right:20px;z-index:100;transition:all 0.3s ease;">
        <button onclick="showScreen('welcomeScreen')" style="background:linear-gradient(135deg,#E31937,#C62828);color:white;border:none;padding:15px 25px;border-radius:50px;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(227,25,55,0.4);display:flex;align-items:center;gap:8px;">
          ‚Üê Volver
        </button>
      </div>
      <div class="header">
        <h1>Mi Perfil</h1>
        <p class="subtitle">T√©cnico HVACR - Nivel 33</p>
      </div>
      <div class="card">
        <div id="profileContent">
          <!-- Avatar and Level Section -->
          <div class="profile-avatar-section" id="profileAvatarSection">
            <!-- Foto de perfil con bot√≥n visible -->
            <div style="position:relative;display:inline-block;margin-bottom:15px;">
              <div class="profile-avatar nivel-nuevo" id="profileAvatar" style="overflow:hidden;position:relative;width:120px;height:120px;border-radius:50%;background:#1e293b;display:flex;align-items:center;justify-content:center;font-size:50px;border:4px solid #f39c12;">
                <img id="profilePhotoImg" src="" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:50%;position:absolute;top:0;left:0;">
                <span id="profileAvatarEmoji">üë§</span>
              </div>
              <div class="profile-badge badge-nuevo" id="profileBadge" style="position:absolute;top:-5px;right:-5px;">üî∞</div>
            </div>
            
            <!-- Bot√≥n visible para subir foto -->
            <div style="margin-bottom:20px;">
              <label for="profilePhotoInput" style="display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,#3498db,#2980b9);color:white;padding:12px 20px;border-radius:25px;cursor:pointer;font-size:14px;font-weight:bold;box-shadow:0 4px 15px rgba(52,152,219,0.3);transition:all 0.3s ease;">
                <span style="font-size:20px;">üì∑</span>
                <span>Subir Mi Foto</span>
              </label>
              <input type="file" id="profilePhotoInput" accept="image/jpeg,image/png,image/gif,image/webp,image/*" capture="user" style="display:none;" onchange="handleProfilePhoto(this)">
              <p style="color:#64748b;font-size:12px;margin-top:8px;">Toca el bot√≥n para agregar o cambiar tu foto</p>
            </div>
            
            <div class="profile-level-title titulo-nuevo" id="profileLevelTitle">T√©cnico Nuevo</div>
            <div class="profile-level-subtitle" id="profileLevelSubtitle">Completa niveles para subir de rango</div>
            <div class="profile-progress-bar">
              <div class="profile-progress-fill progress-nuevo" id="profileProgressFill" style="width: 0%;"></div>
            </div>
            <div class="profile-progress-text" id="profileProgressText">0/5 niveles completados</div>
            
            <!-- Mini badges earned -->
            <div class="profile-badges-earned">
              <div class="mini-badge badge-principiante" id="miniBadgePrincipiante" title="Principiante">üå±</div>
              <div class="mini-badge badge-intermedio" id="miniBadgeIntermedio" title="Intermedio">üìò</div>
              <div class="mini-badge badge-avanzado" id="miniBadgeAvanzado" title="Avanzado">‚ö°</div>
              <div class="mini-badge badge-elite" id="miniBadgeElite" title="Elite">üèÜ</div>
              <div class="mini-badge badge-platino" id="miniBadgePlatino" title="Platino">üíé</div>
            </div>
          </div>

          <div class="profile-section">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;">
              <h3 style="color:#f39c12; margin:0; font-size:18px;">üìã Datos Personales</h3>
              <button id="btnEditProfile" onclick="toggleEditProfile()" style="background:linear-gradient(135deg,#3498db,#2980b9);color:white;border:none;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:bold;cursor:pointer;display:flex;align-items:center;gap:5px;">
                ‚úèÔ∏è Editar
              </button>
            </div>
            <!-- View Mode -->
            <div id="profileViewMode">
              <div class="profile-field">
                <span class="profile-label">Nombre:</span>
                <span class="profile-value" id="profileNombre">-</span>
              </div>
              <div class="profile-field">
                <span class="profile-label">Email:</span>
                <span class="profile-value" id="profileEmail">-</span>
              </div>
              <div class="profile-field">
                <span class="profile-label">Tel√©fono:</span>
                <span class="profile-value" id="profileTelefono">-</span>
              </div>
              <div class="profile-field">
                <span class="profile-label">Ciudad:</span>
                <span class="profile-value" id="profileCiudad">-</span>
              </div>
              <div class="profile-field">
                <span class="profile-label">Estado:</span>
                <span class="profile-value" id="profileEstado">-</span>
              </div>
            </div>
            <!-- Edit Mode -->
            <div id="profileEditMode" style="display:none;">
              <div style="display:flex;flex-direction:column;gap:12px;">
                <div>
                  <label style="color:#94a3b8;font-size:12px;font-weight:bold;display:block;margin-bottom:4px;">Nombre Completo *</label>
                  <input type="text" id="editNombre" placeholder="Tu nombre completo" style="width:100%;padding:12px;border-radius:10px;border:2px solid #334155;background:#1e293b;color:white;font-size:14px;box-sizing:border-box;">
                </div>
                <div>
                  <label style="color:#94a3b8;font-size:12px;font-weight:bold;display:block;margin-bottom:4px;">Email *</label>
                  <input type="email" id="editEmail" placeholder="tu@email.com" style="width:100%;padding:12px;border-radius:10px;border:2px solid #334155;background:#1e293b;color:white;font-size:14px;box-sizing:border-box;">
                </div>
                <div>
                  <label style="color:#94a3b8;font-size:12px;font-weight:bold;display:block;margin-bottom:4px;">Tel√©fono *</label>
                  <input type="tel" id="editTelefono" placeholder="(123) 456-7890" style="width:100%;padding:12px;border-radius:10px;border:2px solid #334155;background:#1e293b;color:white;font-size:14px;box-sizing:border-box;">
                </div>
                <div>
                  <label style="color:#94a3b8;font-size:12px;font-weight:bold;display:block;margin-bottom:4px;">Ciudad *</label>
                  <input type="text" id="editCiudad" placeholder="Tu ciudad" style="width:100%;padding:12px;border-radius:10px;border:2px solid #334155;background:#1e293b;color:white;font-size:14px;box-sizing:border-box;">
                </div>
                <div>
                  <label style="color:#94a3b8;font-size:12px;font-weight:bold;display:block;margin-bottom:4px;">Estado *</label>
                  <input type="text" id="editEstado" placeholder="Tu estado (ej: California)" style="width:100%;padding:12px;border-radius:10px;border:2px solid #334155;background:#1e293b;color:white;font-size:14px;box-sizing:border-box;">
                </div>
                <div id="editProfileMsg" style="display:none;padding:8px 12px;border-radius:8px;font-size:13px;text-align:center;"></div>
                <div style="display:flex;gap:10px;margin-top:5px;">
                  <button onclick="saveProfileEdits()" style="flex:1;padding:12px;border-radius:10px;border:none;background:linear-gradient(135deg,#27ae60,#2ecc71);color:white;font-size:14px;font-weight:bold;cursor:pointer;">‚úÖ Guardar Cambios</button>
                  <button onclick="cancelEditProfile()" style="flex:1;padding:12px;border-radius:10px;border:2px solid #475569;background:transparent;color:#94a3b8;font-size:14px;font-weight:bold;cursor:pointer;">‚ùå Cancelar</button>
                </div>
              </div>
            </div>
          </div>

          <div class="profile-section" style="margin-top:25px;">
            <h3 style="color:#f39c12; margin-bottom:15px; font-size:18px;">üéñÔ∏è Certificaciones</h3>
            <div class="profile-field">
              <span class="profile-label">EPA 608:</span>
              <span class="profile-value" id="profileEPA">-</span>
            </div>
            <div class="profile-field">
              <span class="profile-label">NATE:</span>
              <span class="profile-value" id="profileNATE">-</span>
            </div>
            <div class="profile-field">
              <span class="profile-label">ESCO:</span>
              <span class="profile-value" id="profileESCO">-</span>
            </div>
          </div>

          <div class="profile-section" style="margin-top:25px;">
            <h3 style="color:#f39c12; margin-bottom:15px; font-size:18px;">üî¢ Mi N√∫mero de T√©cnico</h3>
            <div id="technicianNumberSection">
              <div id="technicianNumberDisplay" style="display:none;">
                <div class="technician-number-card">
                  <div class="technician-number-value" id="technicianNumberValue">-</div>
                  <div class="technician-number-date" id="technicianNumberDate">-</div>
                </div>
              </div>
              <div id="technicianNumberGenerator">
                <p style="color:#64748b; margin-bottom:15px; font-size:14px; line-height:1.5;">
                  Genera tu n√∫mero √∫nico de t√©cnico para identificarte en la plataforma Nivel 33.
                </p>
                <button class="btn btn-primary" onclick="generateTechnicianNumber()" style="margin-top:10px;">
                  üî¢ Generar Mi N√∫mero de T√©cnico
                </button>
              </div>
            </div>
          </div>
          <div class="profile-section" style="margin-top:25px;">
            <h3 style="color:#f39c12; margin-bottom:15px; font-size:18px;">ü™™ Mi Credencial de Estudiante</h3>
            <div id="credentialSection">
              <p style="color:#64748b; font-size:14px;">Cargando credencial...</p>
            </div>
          </div>
        </div>

        <div id="noProfileContent" style="display:none; text-align:center; padding:30px 0;">
          <div style="font-size:60px; margin-bottom:20px; opacity:0.5;">üë§</div>
          <p style="color:#64748b; font-size:16px; line-height:1.6; margin-bottom:20px;">
            No has creado tu perfil todav√≠a.<br>Reg√≠strate para acceder a todas las funciones.
          </p>
          <button class="btn btn-primary" onclick="showScreen('registerScreen')">Crear Perfil</button>
        </div>
      </div>

      <!-- ===== STUDENT PROFILE SECTIONS ===== -->
      
      <!-- 1. ACCESO A CLASES EN VIVO -->
      <div style="margin-top: 20px; background: linear-gradient(135deg, #6c3ce0 0%, #4a1fb8 100%); border-radius: 16px; padding: 20px; text-align: center;">
        <h3 style="color: #fff; margin-bottom: 8px;">üé• Clases en Vivo</h3>
        <p style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-bottom: 15px;">Accede a webinars y clases pregrabadas</p>
        <button onclick="openMembershipZone()" style="padding: 14px 40px; background: #f39c12; color: #000; border: none; border-radius: 12px; font-size: 1.1em; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
          üìπ VER CLASES EN VIVO
        </button>
        <div id="zoomClassStatus" style="color: rgba(255,255,255,0.6); font-size: 0.8em; margin-top: 10px;"></div>
      </div>

      <!-- 2. MI PROGRESO -->
      <div style="margin-top: 20px; background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
        <h3 style="color: #1a1a2e; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">üìä Mi Progreso</h3>
        <div id="studentProgressBars" style="display: flex; flex-direction: column; gap: 12px;">
          <!-- Populated by JS -->
        </div>
        <button onclick="loadStudentProgress()" style="margin-top: 12px; padding: 8px 20px; background: #6c3ce0; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85em;">üîÑ Actualizar Progreso</button>
      </div>

      <!-- 3. MIS TAREAS ASIGNADAS -->
      <div style="margin-top: 20px; background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
        <h3 style="color: #1a1a2e; margin-bottom: 15px;">üìù Mis Tareas Asignadas</h3>
        <div id="studentTasksList" style="color: #666;">Cargando tareas...</div>
        <!-- Enviar tarea completada -->
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
          <h4 style="color: #1a1a2e; margin-bottom: 10px;">üì§ Enviar Tarea Completada</h4>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <select id="taskToSubmit" style="flex: 1; min-width: 150px; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
              <option value="">Seleccionar tipo de documento...</option>
              <option value="tarea_asignada">üìù Tarea Asignada</option>
              <option value="hoja_trabajo">üìã Hoja de Trabajo</option>
              <option value="pretest">üìä Pre-Test Contestado</option>
              <option value="posttest">‚úÖ Post-Test Contestado</option>
              <option value="examen_practica">üéØ Examen de Pr√°ctica</option>
              <option value="proyecto">üîß Proyecto / Evidencia de Trabajo</option>
              <option value="certificacion">üèÖ Documento de Certificaci√≥n</option>
              <option value="otro">üìé Otro Documento</option>
            </select>
            <input type="file" id="taskFile" accept=".pdf,.jpg,.png,.doc,.docx" style="flex: 1; min-width: 150px; padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 0.85em;">
            <textarea id="taskNotes" placeholder="Notas adicionales (descripci√≥n de la tarea, cap√≠tulo, fecha, etc.)..." rows="2" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; resize: vertical;"></textarea>
            <button onclick="submitCompletedTask()" style="padding: 10px 25px; background: #2ecc71; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">‚úÖ ENVIAR TAREA</button>
          </div>
        </div>
      </div>

      <!-- 4. MIS EX√ÅMENES ASIGNADOS -->
      <div style="margin-top: 20px; background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
        <h3 style="color: #1a1a2e; margin-bottom: 15px;">üéØ Mis Ex√°menes Asignados</h3>
        <div id="studentExamsList" style="color: #666;">Cargando ex√°menes...</div>
      </div>

      <!-- 5. MIS LIBROS DE TRABAJO -->
      <div style="margin-top: 20px; background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
        <h3 style="color: #1a1a2e; margin-bottom: 15px;">üìö Mis Libros de Trabajo</h3>
        <p style="color: #888; font-size: 0.85em; margin-bottom: 12px;">Material compartido por el instructor</p>
        <div id="studentWorkbooks" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- 6. MIS RECORDS DE PAGOS -->
      <div style="margin-top: 20px; background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
        <h3 style="color: #1a1a2e; margin-bottom: 15px;">üí≥ Mis Records de Pagos</h3>
        <div id="studentPaymentRecords" style="color: #666;">Cargando historial de pagos...</div>
        <!-- Solicitar forma de taxes -->
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
          <button onclick="requestTaxForm()" style="padding: 10px 25px; background: #e67e22; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 6px;">
            üìÑ SOLICITAR FORMA DE TAXES
          </button>
          <span id="taxFormStatus" style="color: #888; font-size: 0.85em;"></span>
        </div>
      </div>

      <!-- 7. HACER UN PAGO - PAYMENT SYSTEM -->
      <div style="margin-top: 20px; background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); border-radius: 16px; padding: 20px; box-shadow: 0 4px 15px rgba(39,174,96,0.3);">
        <h3 style="color: #fff; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
          üí∞ Hacer un Pago
        </h3>
        <p style="color: rgba(255,255,255,0.8); font-size: 0.85em; margin-bottom: 20px;">Selecciona tu m√©todo de pago preferido</p>
        
        <!-- Payment Amount Selection -->
        <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
          <label style="color: #fff; font-size: 0.9em; display: block; margin-bottom: 8px;">üíµ Monto a Pagar:</label>
          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
            <button onclick="setPaymentAmount(99)" class="payment-amount-btn" style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: #fff; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-weight: bold;">$99</button>
            <button onclick="setPaymentAmount(199)" class="payment-amount-btn" style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: #fff; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-weight: bold;">$199</button>
            <button onclick="setPaymentAmount(299)" class="payment-amount-btn" style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: #fff; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-weight: bold;">$299</button>
            <button onclick="setPaymentAmount(499)" class="payment-amount-btn" style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: #fff; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-weight: bold;">$499</button>
          </div>
          <div style="display: flex; gap: 10px; align-items: center;">
            <span style="color: #fff;">Otro monto: $</span>
            <input type="number" id="customPaymentAmount" placeholder="0.00" min="1" style="flex: 1; max-width: 120px; padding: 10px; border-radius: 8px; border: none; font-size: 1.1em; text-align: center;" onchange="setPaymentAmount(this.value)">
          </div>
          <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; text-align: center;">
            <span style="color: rgba(255,255,255,0.7); font-size: 0.85em;">Total a pagar:</span>
            <span id="paymentTotalDisplay" style="color: #fff; font-size: 1.5em; font-weight: bold; margin-left: 10px;">$0.00</span>
          </div>
        </div>

        <!-- Payment Concept -->
        <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
          <label style="color: #fff; font-size: 0.9em; display: block; margin-bottom: 8px;">üìù Concepto del Pago:</label>
          <select id="paymentConcept" style="width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 1em;">
            <option value="">Seleccionar concepto...</option>
            <option value="mensualidad">üìÖ Mensualidad de Clases</option>
            <option value="inscripcion">üìã Inscripci√≥n</option>
            <option value="certificacion_epa">üèÖ Certificaci√≥n EPA 608</option>
            <option value="certificacion_nate">üèÖ Certificaci√≥n NATE</option>
            <option value="certificacion_osha">üèÖ Certificaci√≥n OSHA</option>
            <option value="materiales">üìö Materiales de Estudio</option>
            <option value="examen">üìù Examen de Certificaci√≥n</option>
            <option value="otro">‚ûï Otro</option>
          </select>
        </div>

        <!-- Payment Methods Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 15px;">
          
          <!-- Cash Payment -->
          <div onclick="selectPaymentMethod('cash')" id="payMethodCash" style="background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s;">
            <div style="font-size: 2.5em; margin-bottom: 8px;">üíµ</div>
            <div style="color: #fff; font-weight: bold; font-size: 0.95em;">Cash</div>
            <div style="color: rgba(255,255,255,0.6); font-size: 0.75em; margin-top: 4px;">Pago en Efectivo</div>
          </div>

          <!-- Card Payment (Stripe) -->
          <div onclick="selectPaymentMethod('card')" id="payMethodCard" style="background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s;">
            <div style="font-size: 2.5em; margin-bottom: 8px;">üí≥</div>
            <div style="color: #fff; font-weight: bold; font-size: 0.95em;">Tarjeta</div>
            <div style="color: rgba(255,255,255,0.6); font-size: 0.75em; margin-top: 4px;">D√©bito / Cr√©dito</div>
          </div>

          <!-- Zelle Payment -->
          <div onclick="selectPaymentMethod('zelle')" id="payMethodZelle" style="background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s;">
            <div style="font-size: 2.5em; margin-bottom: 8px;">üè¶</div>
            <div style="color: #fff; font-weight: bold; font-size: 0.95em;">Zelle</div>
            <div style="color: rgba(255,255,255,0.6); font-size: 0.75em; margin-top: 4px;">Transferencia Bancaria</div>
          </div>

        </div>

        <!-- Payment Instructions Container (Shows based on selection) -->
        <div id="paymentInstructions" style="display: none; background: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px; margin-top: 15px;">
          
          <!-- Cash Instructions -->
          <div id="cashInstructions" style="display: none;">
            <h4 style="color: #1a1a2e; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">üíµ Instrucciones para Pago en Efectivo</h4>
            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
              <p style="color: #333; margin-bottom: 10px;"><strong>1.</strong> Visita nuestra oficina en:</p>
              <p style="color: #666; margin-left: 20px; margin-bottom: 15px;">
                üìç <strong>ACVOLT Tech School</strong><br>
                &nbsp;&nbsp;&nbsp;&nbsp;San Bernardino, California<br>
                &nbsp;&nbsp;&nbsp;&nbsp;Horario: Lun-Vie 9am - 6pm
              </p>
              <p style="color: #333; margin-bottom: 10px;"><strong>2.</strong> Menciona tu nombre y n√∫mero de t√©cnico</p>
              <p style="color: #333;"><strong>3.</strong> Recibir√°s un recibo inmediatamente</p>
            </div>
            <button onclick="confirmCashPayment()" style="width: 100%; padding: 15px; background: #27ae60; color: #fff; border: none; border-radius: 8px; font-weight: bold; font-size: 1em; cursor: pointer;">
              ‚úÖ CONFIRMAR QUE PAGAR√â EN EFECTIVO
            </button>
          </div>

          <!-- Card Instructions (Stripe) -->
          <div id="cardInstructions" style="display: none;">
            <h4 style="color: #1a1a2e; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">üí≥ Pago con Tarjeta de D√©bito/Cr√©dito</h4>
            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
              <p style="color: #666; margin-bottom: 15px;">Ser√°s redirigido a nuestra plataforma segura de pago (Stripe)</p>
              <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
                <img src="https://img.icons8.com/color/48/visa.png" alt="Visa" style="height: 30px;">
                <img src="https://img.icons8.com/color/48/mastercard.png" alt="Mastercard" style="height: 30px;">
                <img src="https://img.icons8.com/color/48/amex.png" alt="Amex" style="height: 30px;">
                <img src="https://img.icons8.com/color/48/discover.png" alt="Discover" style="height: 30px;">
              </div>
              <p style="color: #888; font-size: 0.85em; text-align: center;">üîí Pago 100% seguro con encriptaci√≥n SSL</p>
            </div>
            <button onclick="processCardPayment()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; border: none; border-radius: 8px; font-weight: bold; font-size: 1em; cursor: pointer;">
              üí≥ PAGAR CON TARJETA - $<span id="cardPaymentAmount">0.00</span>
            </button>
          </div>

          <!-- Zelle Instructions -->
          <div id="zelleInstructions" style="display: none;">
            <h4 style="color: #1a1a2e; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">üè¶ Pago con Zelle</h4>
            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
              <p style="color: #333; margin-bottom: 10px;"><strong>Env√≠a tu pago a:</strong></p>
              <div style="background: #e8f5e9; border: 2px dashed #27ae60; border-radius: 8px; padding: 15px; text-align: center; margin-bottom: 15px;">
                <p style="color: #1a1a2e; font-size: 1.2em; font-weight: bold; margin-bottom: 5px;">üì± (714) 709-3942</p>
                <p style="color: #666; font-size: 0.85em;">Nombre: <strong>ACVOLT Tech School</strong></p>
              </div>
              <button onclick="copyZelleNumber()" style="width: 100%; padding: 10px; background: #3498db; color: #fff; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 15px;">
                üìã Copiar N√∫mero de Zelle
              </button>
              <p style="color: #333; margin-bottom: 8px;"><strong>Importante:</strong></p>
              <ul style="color: #666; font-size: 0.9em; margin-left: 20px;">
                <li>En el memo incluye tu <strong>nombre completo</strong></li>
                <li>Incluye tu <strong>n√∫mero de t√©cnico</strong></li>
                <li>Incluye el <strong>concepto del pago</strong></li>
              </ul>
            </div>
            <div style="background: #fff3cd; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
              <p style="color: #856404; font-size: 0.85em;">‚ö†Ô∏è <strong>Nota:</strong> Tu pago ser√° verificado en 24-48 horas h√°biles</p>
            </div>
            <button onclick="confirmZellePayment()" style="width: 100%; padding: 15px; background: #6c3ce0; color: #fff; border: none; border-radius: 8px; font-weight: bold; font-size: 1em; cursor: pointer;">
              ‚úÖ YA ENVI√â MI PAGO POR ZELLE
            </button>
          </div>

        </div>

        <!-- Payment Confirmation Message -->
        <div id="paymentConfirmationMsg" style="display: none; margin-top: 15px; background: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px; text-align: center;">
          <div style="font-size: 3em; margin-bottom: 10px;">‚úÖ</div>
          <h4 style="color: #27ae60; margin-bottom: 10px;">¬°Solicitud de Pago Registrada!</h4>
          <p id="paymentConfirmationText" style="color: #666;"></p>
        </div>

      </div>

      <!-- 8. CR√âDITOS Y RENOVACIONES -->
      <div style="margin-top: 20px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 16px; padding: 20px;">
        <h3 style="color: #f39c12; margin-bottom: 8px;">üèÖ Cr√©ditos y Renovaciones</h3>
        <p style="color: rgba(255,255,255,0.6); font-size: 0.85em; margin-bottom: 15px;">Administra tus cr√©ditos de educaci√≥n continua para certificaciones</p>
        
        <div id="certCreditsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px;">
          <!-- ACVOLT NIVEL 33 - PRIMERO -->
          <div style="background: linear-gradient(135deg, rgba(243,156,18,0.2), rgba(230,126,34,0.15)); border-radius: 12px; padding: 15px; border-left: 4px solid #f39c12; grid-column: span 2;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
              <img src="logo.png" alt="ACVOLT" style="width: 40px; height: 40px; border-radius: 8px; background: #fff; padding: 3px;">
              <div>
                <div style="color: #f39c12; font-weight: bold; font-size: 1.1em;">ACVOLT TECH SCHOOL - NIVEL 33</div>
                <div style="color: rgba(255,255,255,0.7); font-size: 0.75em;">Certificaci√≥n HVACR Profesional</div>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
              <div>
                <div style="color: #fff; font-size: 0.8em;">Progreso: <span id="nivel33Progress" style="color: #2ecc71; font-weight: bold;">0/5 niveles</span></div>
                <div style="color: #888; font-size: 0.75em;">Principiante ‚Üí Platino</div>
              </div>
              <div>
                <div style="color: #fff; font-size: 0.8em;">Estado: <span id="nivel33Status" style="color: #f39c12; font-weight: bold;">En Progreso</span></div>
                <div style="color: #888; font-size: 0.75em;">Instructor: Mario Flores Corona</div>
              </div>
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="showScreen('levelsScreen')" style="padding: 8px 15px; background: #f39c12; color: #000; border: none; border-radius: 6px; font-size: 0.8em; cursor: pointer; font-weight: bold;">üìö Continuar Estudiando</button>
              <button onclick="showScreen('certificatesScreen')" style="padding: 8px 15px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid #f39c12; border-radius: 6px; font-size: 0.8em; cursor: pointer;">üèÖ Ver Mis Certificados</button>
            </div>
          </div>
          
          <!-- NATE -->
          <div style="background: rgba(255,255,255,0.08); border-radius: 12px; padding: 15px; border-left: 3px solid #3498db;">
            <div style="color: #3498db; font-weight: bold; font-size: 0.95em;">NATE</div>
            <div style="color: #fff; font-size: 0.8em; margin: 4px 0;">Cr√©ditos: <span id="nateCredits" style="color: #2ecc71; font-weight: bold;">0/16</span></div>
            <div style="color: #888; font-size: 0.75em;">Renovaci√≥n: <span id="nateRenewal">--</span></div>
            <button onclick="requestCertRenewal('NATE')" style="margin-top: 8px; padding: 5px 12px; background: #3498db; color: #fff; border: none; border-radius: 6px; font-size: 0.75em; cursor: pointer;">Solicitar Renovaci√≥n</button>
          </div>
          <!-- EPA 608 -->
          <div style="background: rgba(255,255,255,0.08); border-radius: 12px; padding: 15px; border-left: 3px solid #2ecc71;">
            <div style="color: #2ecc71; font-weight: bold; font-size: 0.95em;">EPA 608</div>
            <div style="color: #fff; font-size: 0.8em; margin: 4px 0;">Estado: <span id="epaStatus" style="color: #f39c12; font-weight: bold;">Pendiente</span></div>
            <div style="color: #888; font-size: 0.75em;">Tipo: <span id="epaType">Universal</span></div>
            <button onclick="requestCertRenewal('EPA608')" style="margin-top: 8px; padding: 5px 12px; background: #2ecc71; color: #000; border: none; border-radius: 6px; font-size: 0.75em; cursor: pointer;">Solicitar Renovaci√≥n</button>
          </div>
          <!-- OSHA -->
          <div style="background: rgba(255,255,255,0.08); border-radius: 12px; padding: 15px; border-left: 3px solid #e74c3c;">
            <div style="color: #e74c3c; font-weight: bold; font-size: 0.95em;">OSHA 30</div>
            <div style="color: #fff; font-size: 0.8em; margin: 4px 0;">Cr√©ditos: <span id="oshaCredits" style="color: #2ecc71; font-weight: bold;">0/30</span></div>
            <div style="color: #888; font-size: 0.75em;">Renovaci√≥n: <span id="oshaRenewal">--</span></div>
            <button onclick="requestCertRenewal('OSHA')" style="margin-top: 8px; padding: 5px 12px; background: #e74c3c; color: #fff; border: none; border-radius: 6px; font-size: 0.75em; cursor: pointer;">Solicitar Renovaci√≥n</button>
          </div>
          <!-- ESCO -->
          <div style="background: rgba(255,255,255,0.08); border-radius: 12px; padding: 15px; border-left: 3px solid #9b59b6;">
            <div style="color: #9b59b6; font-weight: bold; font-size: 0.95em;">ESCO</div>
            <div style="color: #fff; font-size: 0.8em; margin: 4px 0;">Estado: <span id="escoStatus" style="color: #f39c12; font-weight: bold;">Pendiente</span></div>
            <div style="color: #888; font-size: 0.75em;">Certificaci√≥n activa</div>
            <button onclick="requestCertRenewal('ESCO')" style="margin-top: 8px; padding: 5px 12px; background: #9b59b6; color: #fff; border: none; border-radius: 6px; font-size: 0.75em; cursor: pointer;">Solicitar Renovaci√≥n</button>
          </div>
          <!-- ACCA -->
          <div style="background: rgba(255,255,255,0.08); border-radius: 12px; padding: 15px; border-left: 3px solid #1abc9c;">
            <div style="color: #1abc9c; font-weight: bold; font-size: 0.95em;">ACCA</div>
            <div style="color: #fff; font-size: 0.8em; margin: 4px 0;">Estado: <span id="accaStatus" style="color: #f39c12; font-weight: bold;">Pendiente</span></div>
            <div style="color: #888; font-size: 0.75em;">Manual J/D/S</div>
            <button onclick="requestCertRenewal('ACCA')" style="margin-top: 8px; padding: 5px 12px; background: #1abc9c; color: #000; border: none; border-radius: 6px; font-size: 0.75em; cursor: pointer;">Solicitar Renovaci√≥n</button>
          </div>
          <!-- NCCER -->
          <div style="background: rgba(255,255,255,0.08); border-radius: 12px; padding: 15px; border-left: 3px solid #f39c12;">
            <div style="color: #f39c12; font-weight: bold; font-size: 0.95em;">NCCER</div>
            <div style="color: #fff; font-size: 0.8em; margin: 4px 0;">Nivel: <span id="nccerLevel" style="color: #2ecc71; font-weight: bold;">--</span></div>
            <div style="color: #888; font-size: 0.75em;">Refrigeraci√≥n/HVAC</div>
            <button onclick="requestCertRenewal('NCCER')" style="margin-top: 8px; padding: 5px 12px; background: #f39c12; color: #000; border: none; border-radius: 6px; font-size: 0.75em; cursor: pointer;">Solicitar Renovaci√≥n</button>
          </div>
          <!-- R-410A / R-32 -->
          <div style="background: rgba(255,255,255,0.08); border-radius: 12px; padding: 15px; border-left: 3px solid #00bcd4;">
            <div style="color: #00bcd4; font-weight: bold; font-size: 0.95em;">R-410A / R-32 A2L</div>
            <div style="color: #fff; font-size: 0.8em; margin: 4px 0;">Estado: <span id="refrigStatus" style="color: #f39c12; font-weight: bold;">Pendiente</span></div>
            <div style="color: #888; font-size: 0.75em;">Seguridad en refrigerantes</div>
            <button onclick="requestCertRenewal('R32')" style="margin-top: 8px; padding: 5px 12px; background: #00bcd4; color: #000; border: none; border-radius: 6px; font-size: 0.75em; cursor: pointer;">Solicitar Renovaci√≥n</button>
          </div>
        </div>
      </div>
      
      <!-- 8. FORMULAS Y REFERENCIAS TECNICAS -->
      <div style="margin-top:20px;background:linear-gradient(135deg,#0a0a1a 0%,#1a1a2e 100%);border-radius:16px;padding:20px;border:1px solid #333;">
        <h3 style="color:#f39c12;margin-bottom:5px;font-size:1.3em;">üìê F√≥rmulas y Referencias T√©cnicas</h3>
        <p style="color:rgba(255,255,255,0.5);font-size:0.85em;margin-bottom:20px;">Toca cada secci√≥n para expandir</p>
        <div style="margin-bottom:8px;border:1px solid #333;border-radius:12px;overflow:hidden;">
          <div onclick="toggleFormula('elecFormulas')" style="padding:14px 16px;background:rgba(241,196,15,0.1);cursor:pointer;display:flex;align-items:center;gap:10px;">
            <span style="font-size:1.5em;">‚ö°</span><span style="color:#f1c40f;font-weight:bold;flex:1;">Electricidad</span><span id="elecFormulas_arrow" style="color:#f1c40f;">‚ñ∂</span>
          </div>
          <div id="elecFormulas" style="display:none;padding:16px;background:rgba(0,0,0,0.3);color:#ddd;font-size:0.85em;line-height:1.8;">
            <div style="margin-bottom:15px;"><div style="color:#f1c40f;font-weight:bold;margin-bottom:4px;">Ley de Ohm</div><div style="background:rgba(241,196,15,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">V = I √ó R &nbsp;|&nbsp; I = V / R &nbsp;|&nbsp; R = V / I</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Motor 240V, 10A. R = 240/10 = <b>24Œ©</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#f1c40f;font-weight:bold;margin-bottom:4px;">Potencia (Watts)</div><div style="background:rgba(241,196,15,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">P = V √ó I &nbsp;|&nbsp; P = I¬≤ √ó R &nbsp;|&nbsp; P = V¬≤ / R</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Motor 240V, 15A: P = 240√ó15 = <b>3,600W (3.6kW)</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#f1c40f;font-weight:bold;margin-bottom:4px;">Potencia Trif√°sica</div><div style="background:rgba(241,196,15,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">P = V √ó I √ó ‚àö3 √ó PF &nbsp;&nbsp;(‚àö3 = 1.732)</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Motor 3œÜ 208V, 20A, PF=0.85: P = <b>6,127W</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#f1c40f;font-weight:bold;margin-bottom:4px;">Breaker &amp; Cableado</div><div style="background:rgba(241,196,15,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">I = P / V &nbsp;|&nbsp; Breaker = FLA √ó 1.25 &nbsp;|&nbsp; MCA en placa</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> FLA=28A: Breaker=28√ó1.25=35A ‚Üí <b>usar 40A</b><br>Cable: 28A ‚Üí <b>#8 AWG cobre</b> (40A@60¬∞C)</div></div>
            <div style="margin-bottom:15px;"><div style="color:#f1c40f;font-weight:bold;margin-bottom:4px;">Ca√≠da de Voltaje</div><div style="background:rgba(241,196,15,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">VD = (2 √ó L √ó I √ó R) / 1000 &nbsp;|&nbsp; M√°ximo: 3%</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 100ft, 20A, #12AWG: VD=6.35V = <b>2.6% ‚úÖ</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#f1c40f;font-weight:bold;margin-bottom:4px;">Capacitores (MFD)</div><div style="background:rgba(241,196,15,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">MFD = (A √ó 2652) / V &nbsp;|&nbsp; Tolerancia: ¬±6%</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 5A, 370V: MFD=(5√ó2652)/370 = <b>35.8 ‚âà 35 MFD</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#f1c40f;font-weight:bold;margin-bottom:4px;">Transformadores</div><div style="background:rgba(241,196,15,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">VA = V √ó A &nbsp;|&nbsp; Carga m√°x = VA / Vsec</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 40VA, 24V: Carga m√°x = 40/24 = <b>1.67A</b></div></div>
            <div style=""><div style="color:#f1c40f;font-weight:bold;margin-bottom:4px;">Resistencias</div><div style="background:rgba(241,196,15,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">Serie: Rt=R1+R2+R3 &nbsp;|&nbsp; Paralelo: 1/Rt=1/R1+1/R2+1/R3</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> R1=10Œ©, R2=20Œ© paralelo ‚Üí <b>Rt=6.67Œ©</b></div></div>
          </div>
        </div>
        <div style="margin-bottom:8px;border:1px solid #333;border-radius:12px;overflow:hidden;">
          <div onclick="toggleFormula('acFormulas')" style="padding:14px 16px;background:rgba(52,152,219,0.1);cursor:pointer;display:flex;align-items:center;gap:10px;">
            <span style="font-size:1.5em;">‚ùÑÔ∏è</span><span style="color:#2563eb;font-weight:bold;flex:1;">Aire Acondicionado</span><span id="acFormulas_arrow" style="color:#3498db;">‚ñ∂</span>
          </div>
          <div id="acFormulas" style="display:none;padding:16px;background:rgba(0,0,0,0.3);color:#ddd;font-size:0.85em;line-height:1.8;">
            <div style="margin-bottom:15px;"><div style="color:#2563eb;font-weight:bold;margin-bottom:4px;">Tonelaje / BTU</div><div style="background:rgba(52,152,219,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">1 Ton = 12,000 BTU/h &nbsp;|&nbsp; Tons = BTU / 12,000</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 60,000 BTU = <b>5 Toneladas</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#2563eb;font-weight:bold;margin-bottom:4px;">C√°lculo R√°pido</div><div style="background:rgba(52,152,219,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">Tons ‚âà Sq.Ft. / 500 &nbsp;(regla general)</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 2,000 sq.ft: <b>4 Toneladas</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#2563eb;font-weight:bold;margin-bottom:4px;">SEER / EER / COP</div><div style="background:rgba(52,152,219,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">EER = SEER √ó 0.875 &nbsp;|&nbsp; COP = EER / 3.412</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> SEER 16: EER=<b>14</b>, COP=<b>4.1</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#2563eb;font-weight:bold;margin-bottom:4px;">Superheat</div><div style="background:rgba(52,152,219,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">SH = T¬∞ L√≠nea Succi√≥n - T¬∞ Sat. Succi√≥n &nbsp;(5-15¬∞F)</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> L√≠nea 55¬∞F, Sat R-410A@118psi=45¬∞F ‚Üí SH=<b>10¬∞F ‚úÖ</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#2563eb;font-weight:bold;margin-bottom:4px;">Subcooling</div><div style="background:rgba(52,152,219,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">SC = T¬∞ Sat. Desc. - T¬∞ L√≠nea L√≠quido &nbsp;(8-14¬∞F)</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Sat R-410A@418psi=115¬∞F, L√≠nea=105¬∞F ‚Üí SC=<b>10¬∞F ‚úÖ</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#2563eb;font-weight:bold;margin-bottom:4px;">Delta T</div><div style="background:rgba(52,152,219,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">ŒîT = T¬∞ Return - T¬∞ Supply &nbsp;(Normal: 15-22¬∞F)</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Return 75¬∞F, Supply 55¬∞F ‚Üí ŒîT=<b>20¬∞F ‚úÖ</b></div></div>
            <div style=""><div style="color:#2563eb;font-weight:bold;margin-bottom:4px;">SHR</div><div style="background:rgba(52,152,219,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">SHR = Carga Sensible / Carga Total &nbsp;(0.70-0.80)</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Sensible 30k, Total 40k ‚Üí SHR=<b>0.75</b></div></div>
          </div>
        </div>
        <div style="margin-bottom:8px;border:1px solid #333;border-radius:12px;overflow:hidden;">
          <div onclick="toggleFormula('refFormulas')" style="padding:14px 16px;background:rgba(46,204,113,0.1);cursor:pointer;display:flex;align-items:center;gap:10px;">
            <span style="font-size:1.5em;">üßä</span><span style="color:#16a34a;font-weight:bold;flex:1;">Refrigeraci√≥n</span><span id="refFormulas_arrow" style="color:#2ecc71;">‚ñ∂</span>
          </div>
          <div id="refFormulas" style="display:none;padding:16px;background:rgba(0,0,0,0.3);color:#ddd;font-size:0.85em;line-height:1.8;">
            <div style="margin-bottom:15px;"><div style="color:#16a34a;font-weight:bold;margin-bottom:4px;">Net Refrigeration Effect</div><div style="background:rgba(46,204,113,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">NRE = h1 - h4 &nbsp;(entalp√≠a salida-entrada evap)</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> h1=110, h4=42 ‚Üí NRE=<b>68 BTU/lb</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#16a34a;font-weight:bold;margin-bottom:4px;">Carga Refrigerante Extra</div><div style="background:rgba(46,204,113,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">Extra = (Long. lineset - 15ft) √ó oz/ft</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 50ft, R-410A 3/8" (0.6oz/ft): <b>21oz extra</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#16a34a;font-weight:bold;margin-bottom:4px;">Compression Ratio</div><div style="background:rgba(46,204,113,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">CR = P desc.(abs) / P succ.(abs) &nbsp;(2:1 a 4:1)</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> (260+14.7)/(70+14.7) = <b>3.2:1 ‚úÖ</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#16a34a;font-weight:bold;margin-bottom:4px;">Tabla P/T</div><div style="background:rgba(46,204,113,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">R-410A: 118psi=45¬∞F | R-22: 69psi=40¬∞F | R-404A: 62psi=20¬∞F</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Siempre usar tabla P/T del refrigerante espec√≠fico</div></div>
            <div style="margin-bottom:15px;"><div style="color:#16a34a;font-weight:bold;margin-bottom:4px;">Heat of Rejection</div><div style="background:rgba(46,204,113,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">HR ‚âà Capacidad √ó 1.25</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 3 Ton: 36,000√ó1.25 = <b>45,000 BTU/h</b></div></div>
            <div style=""><div style="color:#16a34a;font-weight:bold;margin-bottom:4px;">TD Evap/Cond</div><div style="background:rgba(46,204,113,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">TD Evap=T¬∞Box-T¬∞Sat.Succ | TD Cond=T¬∞Sat.Desc-T¬∞Amb</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Walk-in 35-25=<b>10¬∞F</b> | Cond 120-95=<b>25¬∞F</b></div></div>
          </div>
        </div>
        <div style="margin-bottom:8px;border:1px solid #333;border-radius:12px;overflow:hidden;">
          <div onclick="toggleFormula('airFormulas')" style="padding:14px 16px;background:rgba(155,89,182,0.1);cursor:pointer;display:flex;align-items:center;gap:10px;">
            <span style="font-size:1.5em;">üí®</span><span style="color:#9b59b6;font-weight:bold;flex:1;">Airflow</span><span id="airFormulas_arrow" style="color:#9b59b6;">‚ñ∂</span>
          </div>
          <div id="airFormulas" style="display:none;padding:16px;background:rgba(0,0,0,0.3);color:#ddd;font-size:0.85em;line-height:1.8;">
            <div style="margin-bottom:15px;"><div style="color:#9b59b6;font-weight:bold;margin-bottom:4px;">CFM por Tonelada</div><div style="background:rgba(155,89,182,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">CFM = Tons √ó 400 &nbsp;(350-450 CFM/Ton)</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 3 Ton = <b>1,200 CFM</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#9b59b6;font-weight:bold;margin-bottom:4px;">Sensible Heat</div><div style="background:rgba(155,89,182,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">BTU/h = 1.08 √ó CFM √ó ŒîT</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 1200CFM, ŒîT=20: <b>25,920 BTU/h</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#9b59b6;font-weight:bold;margin-bottom:4px;">Total Heat</div><div style="background:rgba(155,89,182,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">BTU/h = 4.5 √ó CFM √ó Œîh</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 1200CFM, Œîh=8: <b>43,200 BTU/h</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#9b59b6;font-weight:bold;margin-bottom:4px;">Velocidad FPM</div><div style="background:rgba(155,89,182,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">FPM = CFM / √Årea(sqft) &nbsp;|&nbsp; √Årea=(W√óH)/144</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Ducto 12"√ó8"=0.67sqft ‚Üí <b>1,791 FPM</b><br>Supply:700-900 | Return:500-700</div></div>
            <div style="margin-bottom:15px;"><div style="color:#9b59b6;font-weight:bold;margin-bottom:4px;">Presi√≥n Est√°tica</div><div style="background:rgba(155,89,182,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">TESP = P supply + P return &nbsp;|&nbsp; Normal: 0.50" WC</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Filtro limpio: 0.10-0.20" WC</div></div>
            <div style=""><div style="color:#9b59b6;font-weight:bold;margin-bottom:4px;">Duct Leakage</div><div style="background:rgba(155,89,182,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">% Fuga = (CFM supply-CFM registros)/CFM supply √ó 100</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 1200-1020=180 ‚Üí <b>15% ‚ùå</b> (m√°x 10%)</div></div>
          </div>
        </div>
        <div style="margin-bottom:8px;border:1px solid #333;border-radius:12px;overflow:hidden;">
          <div onclick="toggleFormula('heatFormulas')" style="padding:14px 16px;background:rgba(231,76,60,0.1);cursor:pointer;display:flex;align-items:center;gap:10px;">
            <span style="font-size:1.5em;">üî•</span><span style="color:#dc2626;font-weight:bold;flex:1;">C√°lculo T√©rmico</span><span id="heatFormulas_arrow" style="color:#e74c3c;">‚ñ∂</span>
          </div>
          <div id="heatFormulas" style="display:none;padding:16px;background:rgba(0,0,0,0.3);color:#ddd;font-size:0.85em;line-height:1.8;">
            <div style="margin-bottom:15px;"><div style="color:#dc2626;font-weight:bold;margin-bottom:4px;">Heat Transfer</div><div style="background:rgba(231,76,60,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">Q = U √ó A √ó ŒîT</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> U=0.08, A=200sqft, ŒîT=30 ‚Üí <b>480 BTU/h</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#dc2626;font-weight:bold;margin-bottom:4px;">Infiltraci√≥n</div><div style="background:rgba(231,76,60,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">Qs = 1.08 √ó CFM √ó ŒîT &nbsp;|&nbsp; Ql = 0.68 √ó CFM √ó ŒîW</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 100CFM, ŒîT=20: <b>2,160 BTU/h</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#dc2626;font-weight:bold;margin-bottom:4px;">Carga Solar</div><div style="background:rgba(231,76,60,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">Q = √Årea √ó SHGC √ó Factor Solar</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Ventana sur 30sqft: <b>1,800 BTU/h</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#dc2626;font-weight:bold;margin-bottom:4px;">Personas/Equipos</div><div style="background:rgba(231,76,60,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">Persona: ~600 BTU/h | Equipos: W √ó 3.412</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 10 personas + 5kW: <b>23,060 BTU/h</b></div></div>
            <div style=""><div style="color:#dc2626;font-weight:bold;margin-bottom:4px;">Calefacci√≥n</div><div style="background:rgba(231,76,60,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">BTU = Sqft √ó Factor &nbsp;|&nbsp; Zona4:35-40 | Zona5:45-50</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 2,000sqft√ó38 = <b>76,000 ‚Üí Furnace 80,000</b></div></div>
          </div>
        </div>
        <div style="margin-bottom:8px;border:1px solid #333;border-radius:12px;overflow:hidden;">
          <div onclick="toggleFormula('ductFormulas')" style="padding:14px 16px;background:rgba(230,126,34,0.1);cursor:pointer;display:flex;align-items:center;gap:10px;">
            <span style="font-size:1.5em;">üìè</span><span style="color:#e67e22;font-weight:bold;flex:1;">C√°lculo de Ductos</span><span id="ductFormulas_arrow" style="color:#e67e22;">‚ñ∂</span>
          </div>
          <div id="ductFormulas" style="display:none;padding:16px;background:rgba(0,0,0,0.3);color:#ddd;font-size:0.85em;line-height:1.8;">
            <div style="margin-bottom:15px;"><div style="color:#e67e22;font-weight:bold;margin-bottom:4px;">Tama√±o por CFM</div><div style="background:rgba(230,126,34,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">√Årea = CFM/FPM &nbsp;|&nbsp; D = ‚àö(√Årea√ó4/œÄ) √ó 12</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 400CFM@800FPM ‚Üí <b>10" redondo</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#e67e22;font-weight:bold;margin-bottom:4px;">Rect. Equivalente</div><div style="background:rgba(230,126,34,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">10"‚âà8"√ó12" | 12"‚âà10"√ó14" | 14"‚âà12"√ó16"</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Deq = 1.3√ó(a√ób)^0.625/(a+b)^0.25</div></div>
            <div style="margin-bottom:15px;"><div style="color:#e67e22;font-weight:bold;margin-bottom:4px;">Tabla CFM/Tama√±o</div><div style="background:rgba(230,126,34,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">6"=85 | 8"=160 | 10"=275 | 12"=425 | 14"=610 | 16"=850</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Basado en 0.08"WC fricci√≥n/100ft (Manual D)</div></div>
            <div style="margin-bottom:15px;"><div style="color:#e67e22;font-weight:bold;margin-bottom:4px;">Return Air</div><div style="background:rgba(230,126,34,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">1 sqft rejilla / 200 CFM &nbsp;|&nbsp; Vel m√°x: 500 FPM</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 1,200CFM ‚Üí <b>6 sqft</b> ‚âà 3 rejillas 20"√ó30"</div></div>
            <div style=""><div style="color:#e67e22;font-weight:bold;margin-bottom:4px;">TEL</div><div style="background:rgba(230,126,34,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">TEL = Long. real + Equiv. fittings &nbsp;|&nbsp; Codo 90¬∞‚âà15ft</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 30ft + 3 codos + tee = <b>110ft eq.</b></div></div>
          </div>
        </div>
        <div style="margin-bottom:8px;border:1px solid #333;border-radius:12px;overflow:hidden;">
          <div onclick="toggleFormula('equipFormulas')" style="padding:14px 16px;background:rgba(26,188,156,0.1);cursor:pointer;display:flex;align-items:center;gap:10px;">
            <span style="font-size:1.5em;">‚öôÔ∏è</span><span style="color:#1abc9c;font-weight:bold;flex:1;">Selecci√≥n de M√°quinas</span><span id="equipFormulas_arrow" style="color:#1abc9c;">‚ñ∂</span>
          </div>
          <div id="equipFormulas" style="display:none;padding:16px;background:rgba(0,0,0,0.3);color:#ddd;font-size:0.85em;line-height:1.8;">
            <div style="margin-bottom:15px;"><div style="color:#1abc9c;font-weight:bold;margin-bottom:4px;">AC / Heat Pump</div><div style="background:rgba(26,188,156,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">Manual J ‚Üí BTU | Equipo ‚â§ 115% carga | AHRI match</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Carga 34k ‚Üí <b>3 Ton (36k)=105% ‚úÖ</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#1abc9c;font-weight:bold;margin-bottom:4px;">Furnace</div><div style="background:rgba(26,188,156,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">Output = Input √ó AFUE &nbsp;|&nbsp; Output ‚â• Carga</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 80,000√ó0.96 = <b>76,800 output ‚úÖ</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#1abc9c;font-weight:bold;margin-bottom:4px;">Mini Split</div><div style="background:rgba(26,188,156,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">BTU = Sqft √ó 25 &nbsp;|&nbsp; Multi: Œ£ indoor ‚â§ 130% outdoor</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 400sqft ‚Üí <b>12,000 BTU (1 Ton)</b></div></div>
            <div style=""><div style="color:#1abc9c;font-weight:bold;margin-bottom:4px;">Cond. Comercial</div><div style="background:rgba(26,188,156,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">Cap = BTU evap √ó 1.25 &nbsp;|&nbsp; TD Aire=25-30¬∞F</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 15,000 evap ‚Üí Cond <b>18,750 BTU m√≠n</b></div></div>
          </div>
        </div>
        <div style="margin-bottom:8px;border:1px solid #333;border-radius:12px;overflow:hidden;">
          <div onclick="toggleFormula('accaFormulas')" style="padding:14px 16px;background:rgba(149,165,166,0.1);cursor:pointer;display:flex;align-items:center;gap:10px;">
            <span style="font-size:1.5em;">üìñ</span><span style="color:#95a5a6;font-weight:bold;flex:1;">Manuales ACCA (J,D,S,T)</span><span id="accaFormulas_arrow" style="color:#95a5a6;">‚ñ∂</span>
          </div>
          <div id="accaFormulas" style="display:none;padding:16px;background:rgba(0,0,0,0.3);color:#ddd;font-size:0.85em;line-height:1.8;">
            <div style="margin-bottom:15px;"><div style="color:#95a5a6;font-weight:bold;margin-bottom:4px;">Manual J ‚Äî Carga</div><div style="background:rgba(149,165,166,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">Orientaci√≥n + ventanas + aislamiento + infiltraci√≥n + ocupantes</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Resultado: BTU/h sensible+latente. Requerido ENERGY STAR</div></div>
            <div style="margin-bottom:15px;"><div style="color:#95a5a6;font-weight:bold;margin-bottom:4px;">Manual D ‚Äî Ductos</div><div style="background:rgba(149,165,166,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">Friction rate = Static disponible / TEL √ó 100</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> 0.50"WC / 200ft √ó 100 = <b>0.25"/100ft</b></div></div>
            <div style="margin-bottom:15px;"><div style="color:#95a5a6;font-weight:bold;margin-bottom:4px;">Manual S ‚Äî Equipo</div><div style="background:rgba(149,165,166,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">Sensible ‚â• carga | Total ‚â§ 115% | Usar datos AHRI</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Error: Sobredimensionar ‚Üí short-cycling + humedad alta</div></div>
            <div style=""><div style="color:#95a5a6;font-weight:bold;margin-bottom:4px;">Manual T ‚Äî Distribuci√≥n</div><div style="background:rgba(149,165,166,0.08);padding:10px;border-radius:8px;font-family:monospace;text-align:center;font-size:1.05em;margin-bottom:5px;">Throw = 75% distancia a pared opuesta</div><div style="color:#aaa;font-size:0.9em;">üìå <b>Ejemplo:</b> Cuarto 12ft: Throw = <b>9ft m√≠n</b></div></div>
          </div>
        </div>
        <div style="margin-bottom:8px;border:1px solid #333;border-radius:12px;overflow:hidden;">
          <div onclick="toggleFormula('mechCodes')" style="padding:14px 16px;background:rgba(243,156,18,0.15);cursor:pointer;display:flex;align-items:center;gap:10px;">
            <span style="font-size:1.5em;">üìú</span><span style="color:#f39c12;font-weight:bold;flex:1;">C√≥digos Mec√°nicos (IMC/UMC)</span><span id="mechCodes_arrow" style="color:#f39c12;">‚ñ∂</span>
          </div>
          <div id="mechCodes" style="display:none;padding:16px;background:rgba(0,0,0,0.3);color:#ddd;font-size:0.85em;line-height:1.8;">
            <div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #333;"><div style="color:#f39c12;font-weight:bold;">Refrigerant Piping</div><div style="color:#ccc;">‚Ä¢ L√≠nea succi√≥n: Aislada m√≠n R-4 (IMC 1105.1)<br>‚Ä¢ L√≠nea l√≠quida exterior: Aislada<br>‚Ä¢ Soporte: Cada 6ft horizontal, 10ft vertical<br>‚Ä¢ Penetraciones: Selladas con fire-stop<br></div></div>
            <div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #333;"><div style="color:#f39c12;font-weight:bold;">Clearances ‚Äî Exterior</div><div style="color:#ccc;">‚Ä¢ Condensador: 12" m√≠n paredes, 36" servicio<br>‚Ä¢ Arriba: 48" m√≠n libre<br>‚Ä¢ Techo: 10ft del borde o barrera<br>‚Ä¢ Gas piping: 3ft de ignici√≥n<br></div></div>
            <div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #333;"><div style="color:#f39c12;font-weight:bold;">Clearances ‚Äî Furnace</div><div style="color:#ccc;">‚Ä¢ Combustibles: Por placa fabricante (1"-6")<br>‚Ä¢ Frente: 30" m√≠n espacio servicio<br>‚Ä¢ Closet: 2 aperturas combustion air (1sqin/1,000 BTU)<br>‚Ä¢ Attic: Plataforma s√≥lida + iluminaci√≥n + switch<br></div></div>
            <div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #333;"><div style="color:#f39c12;font-weight:bold;">Ventilaci√≥n (ASHRAE 62.2)</div><div style="color:#ccc;">‚Ä¢ Residencial: 7.5 CFM/persona + 3 CFM/100sqft<br>‚Ä¢ Ba√±o: 50 CFM intermitente o 20 CFM continuo<br>‚Ä¢ Cocina: 100 CFM m√≠n range hood<br>‚Ä¢ CO detection: Requerido con combustion equipment<br></div></div>
            <div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #333;"><div style="color:#f39c12;font-weight:bold;">Condensate Drain</div><div style="color:#ccc;">‚Ä¢ Primaria: 3/4" PVC m√≠n, pendiente 1/8"/pie<br>‚Ä¢ Secundaria: Descarga en lugar visible<br>‚Ä¢ Float switch: Requerido en attics<br>‚Ä¢ P-trap: Requerido en presi√≥n negativa<br></div></div>
            <div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #333;"><div style="color:#f39c12;font-weight:bold;">Gas Piping</div><div style="color:#ccc;">‚Ä¢ 1/2" = 92,000 BTU @20ft | 3/4" = 199,000 BTU<br>‚Ä¢ Drip leg: 6" m√≠n antes de equipo<br>‚Ä¢ Sediment trap: Antes de conexi√≥n<br>‚Ä¢ B-vent: 1" clearance a combustibles<br></div></div>
            <div style=""><div style="color:#f39c12;font-weight:bold;">Refrigerant Safety</div><div style="color:#ccc;">‚Ä¢ R-410A (A1): L√≠mite 26 lbs espacio mec√°nico<br>‚Ä¢ R-32 (A2L): Detector fugas + ventilaci√≥n requerida<br>‚Ä¢ EPA 608: Recuperaci√≥n 100% obligatoria<br>‚Ä¢ L√≠mite carga = Volumen √ó concentration limit<br></div></div>
          </div>
        </div>
        <div style="margin-bottom:8px;border:1px solid #333;border-radius:12px;overflow:hidden;">
          <div onclick="toggleFormula('necCodes')" style="padding:14px 16px;background:rgba(241,196,15,0.15);cursor:pointer;display:flex;align-items:center;gap:10px;">
            <span style="font-size:1.5em;">üí°</span><span style="color:#f1c40f;font-weight:bold;flex:1;">C√≥digos NEC (El√©ctricos)</span><span id="necCodes_arrow" style="color:#f1c40f;">‚ñ∂</span>
          </div>
          <div id="necCodes" style="display:none;padding:16px;background:rgba(0,0,0,0.3);color:#ddd;font-size:0.85em;line-height:1.8;">
            <div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #333;"><div style="color:#f1c40f;font-weight:bold;">NEC 210 ‚Äî Branch Circuits</div><div style="color:#ccc;">‚Ä¢ 210.3: Circuito dedicado por equipo HVAC<br>‚Ä¢ 210.63: Recept√°culo en attics/crawlspaces con HVAC<br>‚Ä¢ 210.8: GFCI dentro de 6ft de agua<br>‚Ä¢ 210.12: AFCI en bedrooms, living, kitchen (2020)<br></div></div>
            <div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #333;"><div style="color:#f1c40f;font-weight:bold;">NEC 240 ‚Äî Overcurrent</div><div style="color:#ccc;">‚Ä¢ 240.4: Protecci√≥n por tabla 310.16<br>‚Ä¢ Tama√±os: 15, 20, 25, 30, 35, 40, 45, 50, 60A...<br>‚Ä¢ Usar MOP de placa del equipo<br>‚Ä¢ MOP no est√°ndar ‚Üí siguiente tama√±o ARRIBA<br></div></div>
            <div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #333;"><div style="color:#f1c40f;font-weight:bold;">NEC 310 ‚Äî Conductores Cu 60¬∞C/75¬∞C</div><div style="color:#ccc;">‚Ä¢ #14=15A/20A | #12=20A/25A | #10=30A/35A<br>‚Ä¢ #8=40A/50A | #6=55A/65A | #4=70A/85A<br>‚Ä¢ #2=95A/115A | #1/0=125A/150A<br>‚Ä¢ HVAC usa columna 75¬∞C (THWN-2)<br></div></div>
            <div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #333;"><div style="color:#f1c40f;font-weight:bold;">NEC 440 ‚Äî A/C &amp; Refrigeration</div><div style="color:#ccc;">‚Ä¢ 440.4: Placa DEBE tener MCA, MOP, V, œÜ<br>‚Ä¢ 440.22: Breaker ‚â§ MOP de placa<br>‚Ä¢ 440.32: Cable ‚â• MCA (NO usar FLA)<br>‚Ä¢ 440.14: Disconnect a la vista, m√°x 50ft<br></div></div>
            <div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #333;"><div style="color:#f1c40f;font-weight:bold;">NEC 422/424 ‚Äî HVAC Equipment</div><div style="color:#ccc;">‚Ä¢ 422.31: Disconnect a la vista o lockable<br>‚Ä¢ 424.19: Electric heater disconnect in sight<br>‚Ä¢ MCA = Tama√±o m√≠nimo del cable<br>‚Ä¢ MOP = Tama√±o m√°ximo del breaker<br></div></div>
            <div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #333;"><div style="color:#f1c40f;font-weight:bold;">NEC 250 ‚Äî Grounding</div><div style="color:#ccc;">‚Ä¢ 250.110: Equipo HVAC DEBE ser grounded<br>‚Ä¢ 250.118: Conductor, EMT, FMC ‚â§6ft<br>‚Ä¢ Whip/flex: M√°x 6ft sin ground separado<br>‚Ä¢ Techo: Bonded al grounding del edificio<br></div></div>
            <div style=""><div style="color:#f1c40f;font-weight:bold;">Colores de Cable</div><div style="color:#ccc;">‚Ä¢ Negro/Rojo/Azul = HOT<br>‚Ä¢ Blanco/Gris = NEUTRAL | Verde/Bare = GROUND<br>‚Ä¢ Naranja = Delta high leg (208V)<br>‚Ä¢ Termostato: R=rojo W=blanco G=verde Y=amarillo C=azul<br></div></div>
          </div>
        </div>
      </div>

      <!-- ===== END STUDENT PROFILE SECTIONS ===== -->

      <button class="btn btn-secondary" onclick="goBackFromProfile()" style="margin-top:20px;">‚Üê Volver</button>
    </div>
  </div>

  <!-- Matrix Unlock Modal -->
  <div class="matrix-unlock-modal" id="matrixUnlockModal" style="display: none;">
    <div class="matrix-unlock-content">
      <h3>üîê Nivel Bloqueado</h3>
      <p>Este nivel requiere un c√≥digo de acceso Matrix generado por el administrador.</p>
      <div class="matrix-unlock-error" id="matrixUnlockError">C√≥digo Matrix inv√°lido. Intenta de nuevo.</div>
      <input type="text" class="matrix-unlock-input" id="matrixIdInput" placeholder="Ingresa tu c√≥digo Matrix" maxlength="20">
      <div class="matrix-unlock-buttons">
        <button class="btn btn-secondary" onclick="closeMatrixModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="validateMatrixId()">Desbloquear</button>
      </div>
    </div>
  </div>

  <script>
window.onerror=function(msg,src,line,col,err){console.error('[MaestroAC Error]',msg,'Line:',line);return true;};
window.onunhandledrejection=function(e){console.error('[MaestroAC Promise]',e.reason);e.preventDefault();};
</script>
<script>
    // ============================================
    // PROFILE PHOTO
    function handleProfilePhoto(i){
      if(!i.files || !i.files[0]){
        alert('No se selecciono ningun archivo');
        return;
      }
      var file=i.files[0];
      
      // Validate file type
      if(!file.type.startsWith('image/')){
        alert('Por favor selecciona una imagen valida');
        return;
      }
      
      // Validate file size (max 10MB)
      if(file.size > 10 * 1024 * 1024){
        alert('La imagen es muy grande. Maximo 10MB');
        return;
      }
      
      var reader=new FileReader();
      reader.onload=function(e){
        var img=new Image();
        img.onload=function(){
          try{
            var canvas=document.createElement('canvas');
            var maxSize=300;
            var w=img.width, h=img.height;
            if(w>h){h=Math.round(h*maxSize/w);w=maxSize;}
            else{w=Math.round(w*maxSize/h);h=maxSize;}
            canvas.width=w;canvas.height=h;
            var ctx=canvas.getContext('2d');
            ctx.drawImage(img,0,0,w,h);
            var compressed=canvas.toDataURL('image/jpeg',0.7);
            
            // Show photo and hide emoji
            var profileImg=document.getElementById('profilePhotoImg');
            var profileEmoji=document.getElementById('profileAvatarEmoji');
            if(profileImg){
              profileImg.src=compressed;
              profileImg.style.display='block';
            }
            if(profileEmoji){
              profileEmoji.style.display='none';
            }
            
            // Guardar con m√∫ltiples keys para asegurar persistencia
            var emailKey = (currentUser && currentUser.email) ? currentUser.email : 'default';
            localStorage.setItem('maestroac_photo_' + emailKey, compressed);
            localStorage.setItem('maestroac_photo_default', compressed);
            
            // Tambi√©n guardar el email para referencia
            if (currentUser && currentUser.email) {
              localStorage.setItem('maestroac_email', currentUser.email);
              localStorage.setItem('tecnico_email', currentUser.email);
              
              // Guardar foto en Supabase para que admin la vea
              if (supabaseClient) {
                // Save photo data to users table using update
                supabaseClient.from('users')
                  .update({
                    photo_url: compressed,
                    photo_updated: new Date().toISOString()
                  })
                  .eq('email', currentUser.email)
                  .then(function(result) {
                    if (result.error) {
                      console.log('Error saving photo to Supabase:', result.error);
                    } else {
                      console.log('Photo saved to Supabase successfully');
                    }
                  }).catch(function(e) { console.log('Photo save error:', e); });
              }
            }
            
            alert('¬°Foto actualizada correctamente!');
          }catch(x){
            alert('Error guardando foto: '+x.message);
          }
        };
        img.onerror=function(){alert('No se pudo leer la imagen. Intenta con otra.');};
        img.src=e.target.result;
      };
      reader.onerror=function(){alert('Error leyendo el archivo. Intenta de nuevo.');};
      reader.readAsDataURL(file);
      
      // Reset input for next selection
      i.value = '';
    }
    document.addEventListener("DOMContentLoaded",function(){
      setTimeout(function(){
        // Cargar foto de perfil al iniciar
        var emailKey = localStorage.getItem('tecnico_email') || localStorage.getItem('maestroac_email') || 'default';
        var p = localStorage.getItem('maestroac_photo_' + emailKey);
        if (!p) p = localStorage.getItem('maestroac_photo_default');
        if (p) {
          var img = document.getElementById('profilePhotoImg');
          var emoji = document.getElementById('profileAvatarEmoji');
          if (img) { 
            img.src = p; 
            img.style.display = 'block'; 
          }
          if (emoji) {
            emoji.style.display = 'none';
          }
        }
      }, 500);
      
      // Initialize study limit system
      // initStudyLimitSystem(); // DISABLED - break timer was activating without activity
      // Clean up any existing break data
      localStorage.removeItem('maestroac_break_until');
      localStorage.removeItem('maestroac_study_start');
      localStorage.removeItem('maestroac_warned_50');
      localStorage.removeItem('maestroac_warned_55');
      
      // Initialize anti-screenshot protection
      // initAntiScreenshot(); // DESACTIVADO
    });

    // ============================================
    // STUDY LIMIT SYSTEM - 1 hour study, 1 hour break
    // ============================================
    let studyStartTime = null;
    let studyTimerInterval = null;
    let isOnBreak = false;
    let breakEndTime = null;
    const STUDY_LIMIT_MINUTES = 240; // 4 hour study limit
    const BREAK_DURATION_MINUTES = 15; // 15 minute break

    function initStudyLimitSystem() {
      // Check if user is currently on break
      var breakData = localStorage.getItem('maestroac_break_until');
      if (breakData) {
        var breakUntil = new Date(breakData);
        if (new Date() < breakUntil) {
          isOnBreak = true;
          breakEndTime = breakUntil;
          showBreakScreen();
        } else {
          // Break is over, clear it
          localStorage.removeItem('maestroac_break_until');
          localStorage.removeItem('maestroac_study_start');
        }
      }
      
      // Load study start time if exists
      var savedStart = localStorage.getItem('maestroac_study_start');
      if (savedStart && !isOnBreak) {
        studyStartTime = new Date(savedStart);
        startStudyTimer();
      }
    }

    function startStudySession() {
      // DISABLED - break timer was activating without user activity
      return true;
      /*
      if (isOnBreak) {
        showBreakScreen();
        return false;
      }
      
      if (!studyStartTime) {
        studyStartTime = new Date();
        localStorage.setItem('maestroac_study_start', studyStartTime.toISOString());
        startStudyTimer();
      }
      return true;
      */
    }

    function startStudyTimer() {
      if (studyTimerInterval) clearInterval(studyTimerInterval);
      
      studyTimerInterval = setInterval(function() {
        if (!studyStartTime || isOnBreak) return;
        
        var now = new Date();
        var minutesStudied = Math.floor((now - studyStartTime) / 60000);
        
        // Update study time indicator if exists
        var indicator = document.getElementById('studyTimeIndicator');
        if (indicator) {
          var remaining = STUDY_LIMIT_MINUTES - minutesStudied;
          if (remaining > 0) {
            indicator.textContent = remaining + ' min restantes';
            indicator.style.color = remaining <= 10 ? '#e74c3c' : '#27ae60';
          }
        }
        
        // Check if limit reached
        if (minutesStudied >= STUDY_LIMIT_MINUTES) {
          enforceBreak();
        }
        
        // Warning at 50 minutes
        if (minutesStudied === 50 && !localStorage.getItem('maestroac_warned_50')) {
          localStorage.setItem('maestroac_warned_50', 'true');
          showStudyWarning(10);
        }
        
        // Warning at 55 minutes
        if (minutesStudied === 55 && !localStorage.getItem('maestroac_warned_55')) {
          localStorage.setItem('maestroac_warned_55', 'true');
          showStudyWarning(5);
        }
      }, 30000); // Check every 30 seconds
    }

    function showStudyWarning(minutesLeft) {
      var warning = document.createElement('div');
      warning.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#f39c12,#e67e22);color:white;padding:15px 25px;border-radius:12px;z-index:10000;box-shadow:0 4px 20px rgba(0,0,0,0.3);text-align:center;animation:slideDown 0.3s ease;';
      warning.innerHTML = '<strong>‚è∞ Aviso de Descanso</strong><br><span style="font-size:14px;">Te quedan ' + minutesLeft + ' minutos antes del descanso obligatorio</span>';
      document.body.appendChild(warning);
      
      setTimeout(function() {
        warning.style.opacity = '0';
        warning.style.transition = 'opacity 0.5s';
        setTimeout(function() { warning.remove(); }, 500);
      }, 5000);
    }

    function enforceBreak() {
      isOnBreak = true;
      breakEndTime = new Date(Date.now() + BREAK_DURATION_MINUTES * 60000);
      localStorage.setItem('maestroac_break_until', breakEndTime.toISOString());
      localStorage.removeItem('maestroac_study_start');
      localStorage.removeItem('maestroac_warned_50');
      localStorage.removeItem('maestroac_warned_55');
      studyStartTime = null;
      
      if (studyTimerInterval) {
        clearInterval(studyTimerInterval);
        studyTimerInterval = null;
      }
      
      showBreakScreen();
    }

    function showBreakScreen() {
      // Remove existing break screen if any
      var existing = document.getElementById('breakScreen');
      if (existing) existing.remove();
      
      var breakScreen = document.createElement('div');
      breakScreen.id = 'breakScreen';
      breakScreen.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,#1a1a2e,#16213e);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:99999;padding:20px;text-align:center;';
      
      breakScreen.innerHTML = '<div style="max-width:400px;"><div style="font-size:80px;margin-bottom:20px;">‚òï</div><h1 style="color:#f39c12;font-size:28px;margin-bottom:15px;">Tiempo de Descanso</h1><p style="color:#94a3b8;font-size:16px;margin-bottom:30px;">Has estudiado por 4 horas continuas. Tu cerebro necesita descansar para absorber mejor la informacion.</p><div style="background:rgba(243,156,18,0.1);border:2px solid #f39c12;border-radius:15px;padding:25px;margin-bottom:25px;"><p style="color:#f39c12;font-size:14px;margin-bottom:10px;">Tiempo restante de descanso:</p><div id="breakCountdown" style="color:white;font-size:48px;font-weight:bold;">60:00</div></div><div style="color:#64748b;font-size:14px;"><p style="margin-bottom:10px;">üí° Sugerencias durante tu descanso:</p><ul style="text-align:left;list-style:none;padding:0;"><li style="margin:8px 0;">üö∂ Camina un poco</li><li style="margin:8px 0;">üíß Toma agua</li><li style="margin:8px 0;">üëÄ Descansa la vista</li><li style="margin:8px 0;">üçé Come algo saludable</li></ul></div><p style="color:#4a5568;font-size:12px;margin-top:25px;">Si no mides, estas adivinando üìè<br>- Maestro Mario</p></div>';
      
      document.body.appendChild(breakScreen);
      
      // Start countdown
      updateBreakCountdown();
      var countdownInterval = setInterval(function() {
        if (!isOnBreak || !breakEndTime) {
          clearInterval(countdownInterval);
          return;
        }
        
        var now = new Date();
        if (now >= breakEndTime) {
          // Break is over
          isOnBreak = false;
          localStorage.removeItem('maestroac_break_until');
          breakScreen.remove();
          clearInterval(countdownInterval);
          
          // Show welcome back message
          alert('¬°Bienvenido de vuelta! üéâ\n\nTu descanso ha terminado. Puedes continuar estudiando.');
        } else {
          updateBreakCountdown();
        }
      }, 1000);
    }

    function updateBreakCountdown() {
      var countdown = document.getElementById('breakCountdown');
      if (!countdown || !breakEndTime) return;
      
      var now = new Date();
      var remaining = Math.max(0, breakEndTime - now);
      var minutes = Math.floor(remaining / 60000);
      var seconds = Math.floor((remaining % 60000) / 1000);
      
      countdown.textContent = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    }

    // ============================================
    // ANTI-SCREENSHOT PROTECTION
    // ============================================
    function initAntiScreenshot() {
      // CSS to prevent screenshots - hide content during capture
      var style = document.createElement('style');
      style.textContent = '@media print { body { display: none !important; } } .protected-content { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }';
      document.head.appendChild(style);
      
      // Detect PrintScreen key
      document.addEventListener('keyup', function(e) {
        if (e.key === 'PrintScreen' || e.keyCode === 44) {
          blackoutScreen();
          showScreenshotWarning();
        }
      });
      
      // Detect keyboard shortcuts for screenshots
      document.addEventListener('keydown', function(e) {
        // Windows: Win+Shift+S, Win+PrtScn
        // Mac: Cmd+Shift+3, Cmd+Shift+4
        if ((e.metaKey || e.ctrlKey) && e.shiftKey && (e.key === '3' || e.key === '4' || e.key === 's' || e.key === 'S')) {
          e.preventDefault();
          blackoutScreen();
          showScreenshotWarning();
        }
        // PrtScn variations
        if (e.keyCode === 44 || e.key === 'PrintScreen') {
          e.preventDefault();
          blackoutScreen();
          showScreenshotWarning();
        }
      });
      
      // Detect visibility change (some screenshot tools trigger this)
      var lastHidden = 0;
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          lastHidden = Date.now();
        } else {
          // If hidden for very short time (< 500ms), might be screenshot
          if (Date.now() - lastHidden < 500) {
            // Possibly a screenshot, but don't be too aggressive
          }
        }
      });
      
      // Blur sensitive content when window loses focus (helps with some tools)
      window.addEventListener('blur', function() {
        document.body.classList.add('window-blurred');
      });
      
      window.addEventListener('focus', function() {
        document.body.classList.remove('window-blurred');
      });
      
      // Add blur style
      var blurStyle = document.createElement('style');
      blurStyle.textContent = '.window-blurred .card, .window-blurred .question-text, .window-blurred .option { filter: blur(5px); transition: filter 0.2s; }';
      document.head.appendChild(blurStyle);
      
      // Disable right-click context menu
      document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        showScreenshotWarning();
      });
      
      // Disable drag
      document.addEventListener('dragstart', function(e) {
        e.preventDefault();
      });
    }

    function blackoutScreen() {
      var blackout = document.createElement('div');
      blackout.id = 'screenshotBlackout';
      blackout.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:#000;z-index:999999;';
      document.body.appendChild(blackout);
      
      // Remove after short delay
      setTimeout(function() {
        var el = document.getElementById('screenshotBlackout');
        if (el) el.remove();
      }, 1000);
      
      // Also clear clipboard if possible
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText('Screenshots no permitidos - ACVOLT Tech School').catch(function() {});
      }
    }

    function showScreenshotWarning() {
      var warning = document.createElement('div');
      warning.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#e74c3c,#c0392b);color:white;padding:30px 40px;border-radius:15px;z-index:1000000;box-shadow:0 10px 40px rgba(0,0,0,0.5);text-align:center;animation:shake 0.5s ease;';
      warning.innerHTML = '<div style="font-size:50px;margin-bottom:15px;">üö´</div><h2 style="margin-bottom:10px;">Screenshots No Permitidos</h2><p style="font-size:14px;opacity:0.9;">El contenido de esta app esta protegido.<br>Por favor estudia directamente en la aplicacion.</p>';
      document.body.appendChild(warning);
      
      // Add shake animation
      var shakeStyle = document.createElement('style');
      shakeStyle.textContent = '@keyframes shake { 0%, 100% { transform: translate(-50%,-50%) rotate(0); } 25% { transform: translate(-50%,-50%) rotate(-5deg); } 75% { transform: translate(-50%,-50%) rotate(5deg); } }';
      document.head.appendChild(shakeStyle);
      
      setTimeout(function() {
        warning.style.opacity = '0';
        warning.style.transition = 'opacity 0.5s';
        setTimeout(function() { warning.remove(); }, 500);
      }, 3000);
    }

    // ============================================
    // SUPABASE CONFIGURATION
    // ============================================
    const SUPABASE_URL = 'https://htklsowiyjwsjnacnvnr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0a2xzb3dpeWp3c2puYWNudm5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NjIwMjQsImV4cCI6MjA4NjAzODAyNH0.6A3F7MI4YJEMo98b4Zfzao9p_hMh2T0ha0dRJ4SUhv0';
    let supabaseClient = null;
    
    // Initialize Supabase with retry logic
    function initSupabase() {
      if (window.supabase) {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
          auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
        });
        console.log('[MaestroAC] Supabase connected ‚úÖ');
        var failBanner = document.getElementById('supabaseFailBanner');
        if (failBanner) failBanner.style.display = 'none';
        return true;
      }
      return false;
    }
    
    // Try to init immediately
    if (!initSupabase()) {
      // Retry after 3 seconds if CDN was slow
      console.warn('[MaestroAC] Supabase not ready, retrying in 3s...');
      setTimeout(function() {
        if (!supabaseClient && initSupabase()) {
          console.log('[MaestroAC] Supabase connected on retry ‚úÖ');
          // Re-run init if we were stuck on login
          if (document.querySelector('#loginScreen.active')) {
            init();
          }
        }
      }, 3000);
    }
    let supabaseUserId = null;
    let isOnline = navigator.onLine;

    window.addEventListener('online', () => { isOnline = true; syncToSupabase(); });
    window.addEventListener('offline', () => { isOnline = false; });

    // Auth state change listener
    if (supabaseClient) {
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('[MaestroAC] Auth event:', event);
            if (event === 'PASSWORD_RECOVERY') {
                console.log('[MaestroAC] Password recovery detected!');
                // Show reset password form, hide login form
                showScreen('loginScreen');
                var loginCard = document.querySelector('#loginScreen .card');
                if (loginCard) loginCard.style.display = 'none';
                var resetBox = document.getElementById('resetPasswordBox');
                if (resetBox) resetBox.style.display = 'block';
                // Hide register section and separator
                var registerBtn = document.querySelector('#loginScreen .btn-secondary[onclick*="registerScreen"]');
                if (registerBtn) registerBtn.parentElement.style.display = 'none';
            }
            if (event === 'SIGNED_IN' && session) {
                const userEmail = session.user.email;
                localStorage.setItem('tecnico_authenticated', 'true');
                localStorage.setItem('tecnico_email', userEmail);
            }
            if (event === 'SIGNED_OUT') {
                localStorage.removeItem('tecnico_authenticated');
                localStorage.removeItem('tecnico_email');
            }
        });
    }

    // ============================================
    // SUPABASE DATABASE LAYER
    // ============================================
    async function supabaseRegisterUser(userData) {
      if (!supabaseClient || !isOnline) return null;
      try {
        const { data: existing } = await supabaseClient
          .from('users')
          .select('id')
          .eq('nombre', userData.nombre)
          .eq('email', userData.email || '')
          .limit(1);
        if (existing && existing.length > 0) {
          supabaseUserId = existing[0].id;
          await supabaseClient.from('users').update({ ultimo_acceso: new Date().toISOString() }).eq('id', supabaseUserId);
          return supabaseUserId;
        }
        const { data, error } = await supabaseClient
          .from('users')
          .insert({ nombre: userData.nombre, email: userData.email || null, telefono: userData.telefono || null })
          .select('id')
          .single();
        if (error) { console.error('Supabase register error:', error); return null; }
        supabaseUserId = data.id;
        return supabaseUserId;
      } catch (e) { console.error('Supabase register exception:', e); return null; }
    }

    async function supabaseSaveProgress(progressData) {
      if (!supabaseClient || !isOnline || !supabaseUserId) return;
      try {
        for (const [nivel, data] of Object.entries(progressData)) {
          const porcentaje = data.total > 0 ? ((data.score / data.total) * 100).toFixed(2) : 0;
          await supabaseClient.from('user_progress').upsert({
            user_id: supabaseUserId, nivel, completed: data.completed, score: data.score,
            total: data.total, porcentaje, fecha_completado: data.completed >= data.total ? new Date().toISOString() : null
          }, { onConflict: 'user_id,nivel' });
        }
      } catch (e) { console.error('Supabase save progress error:', e); }
    }

    async function supabaseSaveCertificate(cert) {
      if (!supabaseClient || !isOnline || !supabaseUserId) return;
      try {
        await supabaseClient.from('certificates').upsert({
          user_id: supabaseUserId, 
          nivel: cert.level || cert.nivel, 
          score: cert.score || 0,
          total_questions: cert.totalQuestions || 0,
          porcentaje: cert.percentage || cert.score || 0,
          certificate_number: cert.certificateNumber || null, 
          fecha_obtenido: cert.date || new Date().toISOString()
        }, { onConflict: 'user_id,nivel', ignoreDuplicates: false });
        console.log('[Cert] Saved to Supabase:', cert.level || cert.nivel);
      } catch (e) { console.error('Supabase save certificate error:', e); }
    }

    async function supabaseSaveQuizAttempt(attemptData) {
      if (!supabaseClient || !isOnline || !supabaseUserId) return;
      try {
        await supabaseClient.from('quiz_attempts').insert({
          user_id: supabaseUserId, nivel: attemptData.nivel, total_questions: attemptData.totalQuestions,
          correct_answers: attemptData.correctAnswers, wrong_answers: attemptData.wrongAnswers,
          porcentaje: attemptData.porcentaje, tiempo_segundos: attemptData.tiempoSegundos || null,
          aprobado: attemptData.aprobado
        });
      } catch (e) { console.error('Supabase save quiz attempt error:', e); }
    }

    async function supabaseSaveUnlockedLevel(nivel, matrixCode) {
      if (!supabaseClient || !isOnline || !supabaseUserId) return;
      try {
        await supabaseClient.from('unlocked_levels').upsert({
          user_id: supabaseUserId, nivel, matrix_code: matrixCode || null
        }, { onConflict: 'user_id,nivel' });
      } catch (e) { console.error('Supabase save unlocked level error:', e); }
    }

    async function supabaseSaveTechnicianNumber(techNumber, techDate) {
      if (!supabaseClient || !isOnline) return;
      try {
        // Save to users table if we have supabaseUserId
        if (supabaseUserId) {
          await supabaseClient.from('users').update({ technician_number: techNumber, technician_number_date: techDate }).eq('id', supabaseUserId);
        }
        // Also save to technicians table using email
        if (currentUser && currentUser.email) {
          await supabaseClient.from('technicians').upsert({ 
            email: currentUser.email, 
            technician_number: techNumber, 
            technician_number_date: techDate,
            nombre: currentUser.nombre || currentUser.email.split('@')[0]
          }, { onConflict: 'email' });
        }
      } catch (e) { console.error('Supabase save technician number error:', e); }
    }

    async function supabaseUpdateNivel(nivel) {
      if (!supabaseClient || !isOnline || !supabaseUserId) return;
      try {
        await supabaseClient.from('users').update({ nivel_actual: nivel }).eq('id', supabaseUserId);
      } catch (e) { console.error('Supabase update nivel error:', e); }
    }

    async function supabaseLoadUserData() {
      if (!supabaseClient || !isOnline || !supabaseUserId) return null;
      try {
        const { data: progressData } = await supabaseClient.from('user_progress').select('*').eq('user_id', supabaseUserId);
        const { data: certsData } = await supabaseClient.from('certificates').select('*').eq('user_id', supabaseUserId);
        const { data: unlockedData } = await supabaseClient.from('unlocked_levels').select('*').eq('user_id', supabaseUserId);
        return { progress: progressData, certificates: certsData, unlockedLevels: unlockedData };
      } catch (e) { console.error('Supabase load error:', e); return null; }
    }

    async function syncToSupabase() {
      if (!supabaseClient || !isOnline || !supabaseUserId) return;
      try {
        await supabaseSaveProgress(progress);
        for (const cert of certificates) { await supabaseSaveCertificate(cert); }
        console.log('[MaestroAC] Synced to Supabase ‚úÖ');
      } catch (e) { console.error('Sync error:', e); }
    }

    // State
    let currentUser = null;
    let currentLevel = null;
    let currentQuestions = [];
    let currentQuestionIndex = 0;
    let correctAnswers = 0;
    let startTime = null;
    let certificates = []; // Array to store earned certificates
    let previousScreen = 'welcomeScreen'; // Track previous screen for navigation
    
    // Tracking de estado de preguntas (estilo examen real)
    let questionStatus = {}; // {index: 'answered'|'flagged'|'unanswered'}
    
    let progress = {
      principiante: { completed: 0, total: 700, score: 0 },
      intermedio: { completed: 0, total: 700, score: 0 },
      avanzado: { completed: 0, total: 700, score: 0 },
      elite: { completed: 0, total: 700, score: 0 },
      platino: { completed: 0, total: 700, score: 0 }
    };

    // Last activity tracking object - persisted to track user's most recent activity
    let lastActivity = null;

    // Last quiz state - persisted to enable exact resume from question view
    // Contains: levelId, category, questionIndex, totalQuestions, routePath, updatedAt
    // Also stores shuffledQuestionIds to restore exact question order on resume
    let lastQuizState = null;

    // ==== VIDEO LESSONS SYSTEM ====
    // Video progress tracking
    let videoProgress = {}; // { videoId: { lastPlaybackTime, duration, completed, watchedPercentage, updatedAt } }
    let currentVideoId = null;
    let videoAutoSaveInterval = null;
    const VIDEO_AUTO_SAVE_INTERVAL = 5000; // Auto-save every 5 seconds
    const VIDEO_COMPLETION_THRESHOLD = 90; // 90% watched = completed

    // Sample video lessons data
    // YouTube API Configuration
    const YOUTUBE_API_KEY = 'AIzaSyCkHcL1QcgKzxABmI4IJeEmjjvnZz_Xtys';
    const YOUTUBE_CHANNEL_HANDLE = '@MaestroMarioAc';
    
    // Video lessons will be loaded from YouTube
    let videoLessons = [];
    let youtubeVideosLoaded = false;
    let currentVideoFilter = 'all';
    
    // Video categories for organization
    const videoCategories = [
      { id: 'herramientas', name: 'Herramientas', icon: 'üîß', keywords: ['herramienta', 'tool', 'manometro', 'multimetro', 'vacuometro', 'pinza'] },
      { id: 'instalacion', name: 'Instalaci√≥n', icon: 'üè†', keywords: ['instala', 'install', 'montaje', 'colocar'] },
      { id: 'refrigeracion', name: 'Refrigeraci√≥n', icon: '‚ùÑÔ∏è', keywords: ['refrigera', 'refrig', 'fre√≥n', 'r410', 'r22', 'carga', 'presion', 'minisplit', 'mini split'] },
      { id: 'electricidad', name: 'Electricidad', icon: '‚ö°', keywords: ['electric', 'voltaje', 'amper', 'cable', 'circuito', 'capacitor', 'contactor', 'transformador'] },
      { id: 'diagnostico', name: 'Diagn√≥stico', icon: 'üîç', keywords: ['diagnos', 'falla', 'problema', 'revisar', 'troubleshoot', 'no enfria', 'no enciende'] },
      { id: 'soldadura', name: 'Soldadura', icon: 'üî•', keywords: ['solda', 'brazing', 'tuber', 'cobre', 'nitrogeno'] },
      { id: 'mantenimiento', name: 'Mantenimiento', icon: 'üõ†Ô∏è', keywords: ['mantenim', 'limpi', 'servicio', 'maintenance', 'lavado'] },
      { id: 'teoria', name: 'Teor√≠a HVAC', icon: 'üìö', keywords: ['teoria', 'concepto', 'fundament', 'basic', 'principio', 'ciclo', 'ley'] },
      { id: 'negocio', name: 'Negocio', icon: 'üíº', keywords: ['negocio', 'business', 'precio', 'cobrar', 'cliente', 'empresa', 'dinero'] },
      { id: 'otros', name: 'Otros', icon: 'üìπ', keywords: [] }
    ];
    
    // Load videos from YouTube API
    async function loadYouTubeVideos() {
      if (youtubeVideosLoaded && videoLessons.length > 0) {
        renderVideoLessonsList();
        return;
      }
      
      const loadingEl = document.getElementById('videoLoadingIndicator');
      const errorEl = document.getElementById('videoErrorMessage');
      const listEl = document.getElementById('videoLessonsList');
      
      loadingEl.style.display = 'block';
      errorEl.style.display = 'none';
      listEl.innerHTML = '';
      
      try {
        // First, get the channel info using the handle
        const channelResponse = await fetch(
          `https://www.googleapis.com/youtube/v3/channels?part=contentDetails,snippet&forHandle=${YOUTUBE_CHANNEL_HANDLE}&key=${YOUTUBE_API_KEY}`
        );
        const channelData = await channelResponse.json();
        
        if (channelData.error) {
          throw new Error(channelData.error.message || 'Error de API');
        }
        
        if (!channelData.items || channelData.items.length === 0) {
          throw new Error('Canal no encontrado');
        }
        
        const uploadsPlaylistId = channelData.items[0].contentDetails.relatedPlaylists.uploads;
        
        // Get videos from uploads playlist (get more videos)
        let allVideos = [];
        let nextPageToken = '';
        
        do {
          const videosResponse = await fetch(
            `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&playlistId=${uploadsPlaylistId}&maxResults=50&pageToken=${nextPageToken}&key=${YOUTUBE_API_KEY}`
          );
          const videosData = await videosResponse.json();
          
          if (videosData.error) {
            throw new Error(videosData.error.message || 'Error al cargar videos');
          }
          
          if (videosData.items) {
            allVideos = allVideos.concat(videosData.items);
          }
          
          nextPageToken = videosData.nextPageToken || '';
        } while (nextPageToken && allVideos.length < 300); // Get up to 300 videos
        
        // Get video durations in batches of 50
        const durationMap = {};
        const viewsMap = {};
        
        for (let i = 0; i < allVideos.length; i += 50) {
          const batch = allVideos.slice(i, i + 50);
          const videoIds = batch.map(v => v.contentDetails.videoId).join(',');
          
          const detailsResponse = await fetch(
            `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,statistics&id=${videoIds}&key=${YOUTUBE_API_KEY}`
          );
          const detailsData = await detailsResponse.json();
          
          if (detailsData.items) {
            detailsData.items.forEach(item => {
              durationMap[item.id] = parseDuration(item.contentDetails.duration);
              viewsMap[item.id] = parseInt(item.statistics.viewCount) || 0;
            });
          }
        }
        
        // Transform to our video format
        videoLessons = allVideos.map(item => {
          const snippet = item.snippet;
          const videoId = item.contentDetails.videoId;
          const category = categorizeVideo(snippet.title, snippet.description);
          
          return {
            id: videoId,
            youtubeId: videoId,
            title: snippet.title,
            description: snippet.description || 'Video de ACVOLT',
            thumbnail: snippet.thumbnails.medium?.url || snippet.thumbnails.default?.url,
            duration: durationMap[videoId] || 0,
            views: viewsMap[videoId] || 0,
            category: category,
            publishedAt: snippet.publishedAt,
            isYouTube: true
          };
        });
        
        youtubeVideosLoaded = true;
        loadingEl.style.display = 'none';
        renderVideoLessonsList();
        
      } catch (error) {
        console.error('Error loading YouTube videos:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        document.getElementById('videoErrorText').textContent = 'Error al cargar videos: ' + error.message;
      }
    }
    
    // Parse YouTube duration format (PT1H2M3S) to seconds
    function parseDuration(duration) {
      const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if (!match) return 0;
      const hours = parseInt(match[1]) || 0;
      const minutes = parseInt(match[2]) || 0;
      const seconds = parseInt(match[3]) || 0;
      return hours * 3600 + minutes * 60 + seconds;
    }
    
    // Categorize video based on title and description
    function categorizeVideo(title, description) {
      const text = (title + ' ' + description).toLowerCase();
      
      for (const cat of videoCategories) {
        if (cat.keywords.length === 0) continue;
        for (const keyword of cat.keywords) {
          if (text.includes(keyword.toLowerCase())) {
            return cat.id;
          }
        }
      }
      return 'otros';
    }
    
    // Filter videos by level/category
    function filterVideosByLevel(level) {
      currentVideoFilter = level;
      
      // Update tab styles
      document.querySelectorAll('.video-level-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.level === level) {
          tab.classList.add('active');
        }
      });
      
      renderVideoLessonsList();
    }
    
    // Format views count
    function formatViews(views) {
      if (views >= 1000000) return (views / 1000000).toFixed(1) + 'M';
      if (views >= 1000) return (views / 1000).toFixed(1) + 'K';
      return views.toString();
    }

    // ==== LOCK SYSTEM CONFIGURATION ====
    // IMPORTANT: Set LOCK_SYSTEM_ENABLED to true to activate locks
    const LOCK_SYSTEM_ENABLED = true; // ACTIVATED - Levels 2+ require purchase or student access

    // Valid Matrix IDs that can unlock levels (generated from Matrix website)
    // Format: MATRIX-YYYY-XXXX where YYYY is year and XXXX is unique code
    const VALID_MATRIX_IDS = [
      'MATRIX-2024-HVAC',
      'MATRIX-2024-TECH',
      'MATRIX-2024-N33A',
      'MATRIX-2024-N33B',
      'MATRIX-2024-N33C'
    ];

    // Track unlocked levels per user (stored in localStorage)
    let unlockedLevels = {};
    let pendingLevelToUnlock = null;

    // Load unlocked levels from storage
    function loadUnlockedLevels() {
      const saved = localStorage.getItem('tecnico_unlocked_levels');
      if (saved) {
        unlockedLevels = JSON.parse(saved);
      }
    }

    // Save unlocked levels to storage
    function saveUnlockedLevels() {
      localStorage.setItem('tecnico_unlocked_levels', JSON.stringify(unlockedLevels));
    }

    // ===== ACVOLT STUDENT ACCESS SYSTEM =====
    // Students get full access via special URL: maestromario.com?access=acvolt2026
    // Access is saved in localStorage so they only need to open the link once
    const ACVOLT_ACCESS_CODES = []; // REMOVED hardcoded codes ‚Äî now only Supabase codes work
    
    function checkStudentAccess() {
      const params = new URLSearchParams(window.location.search);
      
      // ====== ACCESS CODE from URL ======
      const accessParam = params.get('access');
      if (accessParam) {
        // Save code to validate against Supabase later
        localStorage.setItem('maestroac_pending_access_code', accessParam.toLowerCase());
        const cleanUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
      }
      
      // ====== REFERRAL CODE CAPTURE ======
      const refParam = params.get('ref');
      if (refParam) {
        localStorage.setItem('maestroac_referral_code', refParam);
        localStorage.setItem('maestroac_referral_date', new Date().toISOString());
        console.log('üéÅ Referral code captured: ' + refParam);
        const cleanRefUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, cleanRefUrl);
      }
      
      // Check if access was validated against Supabase
      return localStorage.getItem('maestroac_student_access_validated') === 'true';
    }
    
    // Validate access code against Supabase (called after login)
    async function validateAccessCode() {
      if (!supabaseClient || !currentUser) return;
      
      // Check pending code from URL
      var pendingCode = localStorage.getItem('maestroac_pending_access_code');
      if (pendingCode) {
        try {
          var { data } = await supabaseClient.from('access_codes')
            .select('*')
            .eq('code', pendingCode.toUpperCase())
            .eq('used', false)
            .eq('revoked', false)
            .single();
          
          if (data) {
            localStorage.setItem('maestroac_student_access_validated', 'true');
            localStorage.setItem('maestroac_student_code', pendingCode);
            localStorage.removeItem('maestroac_pending_access_code');
            // Mark code as used
            try {
              await supabaseClient.from('access_codes').update({
                email: currentUser.email,
                nombre: currentUser.nombre || '',
                used: true,
                used_at: new Date().toISOString()
              }).eq('code', pendingCode.toUpperCase());
            } catch(e) {}
            console.log('‚úÖ Access code validated via Supabase');
            return true;
          }
        } catch(e) { console.log('Access code not found in Supabase'); }
        localStorage.removeItem('maestroac_pending_access_code');
      }
      
      // Also validate existing access against Supabase membership
      if (currentMembership && currentMembership.activa) {
        localStorage.setItem('maestroac_student_access_validated', 'true');
        return true;
      }
      
      // Check if user already used a code before
      try {
        var { data: userAccess } = await supabaseClient.from('access_codes')
          .select('*')
          .eq('email', currentUser.email)
          .eq('used', true)
          .eq('revoked', false)
          .limit(1);
        if (userAccess && userAccess.length > 0) {
          localStorage.setItem('maestroac_student_access_validated', 'true');
          return true;
        }
      } catch(e) {}
      
      // No valid access found - clear any old localStorage grants
      localStorage.removeItem('maestroac_student_access');
      localStorage.removeItem('maestroac_student_access_validated');
      return false;
    }
    
    // Run on page load
    const isAcvoltStudent = checkStudentAccess();

    // Check if a level is locked
    // Check if user has purchased full app access
    function hasAppAccess() {
      // ACVOLT students with VALIDATED access (checked against Supabase)
      if (localStorage.getItem('maestroac_student_access_validated') === 'true') return true;
      
      if (!currentUser || !currentUser.email) return false;
      // Check Stripe membership (active subscription)
      if (currentMembership && currentMembership.activa) return true;
      // Check cached membership for offline
      const cached = localStorage.getItem('maestroac_membership_cache_' + currentUser.email);
      if (cached) {
        try {
          const m = JSON.parse(cached);
          if (m && m.activa) return true;
        } catch(e) {}
      }
      // Check admin-granted access list (from Supabase, not localStorage)
      const appAccessList = JSON.parse(localStorage.getItem('maestroac_app_access_list') || '[]');
      if (appAccessList.includes(currentUser.email)) return true;
      return false;
    }

    // Check if free trial (30 days) is still valid
    function isTrialValid() {
      if (!currentUser || !currentUser.email) return false;
      
      // Get registration date
      var regDateStr = localStorage.getItem('maestroac_registration_date_' + currentUser.email);
      if (!regDateStr) {
        // If no registration date saved, save it now (first time check)
        regDateStr = new Date().toISOString();
        localStorage.setItem('maestroac_registration_date_' + currentUser.email, regDateStr);
      }
      
      var regDate = new Date(regDateStr);
      var now = new Date();
      var daysSinceRegistration = Math.floor((now - regDate) / (1000 * 60 * 60 * 24));
      
      // Trial valid for 30 days
      return daysSinceRegistration <= 30;
    }

    // Get days remaining in trial
    function getTrialDaysRemaining() {
      if (!currentUser || !currentUser.email) return 0;
      
      var regDateStr = localStorage.getItem('maestroac_registration_date_' + currentUser.email);
      if (!regDateStr) return 30;
      
      var regDate = new Date(regDateStr);
      var now = new Date();
      var daysSinceRegistration = Math.floor((now - regDate) / (1000 * 60 * 60 * 24));
      
      return Math.max(0, 30 - daysSinceRegistration);
    }

    function isLevelLocked(levelId) {
      // If user has paid access, check level progression
      if (hasAppAccess()) {
        // Principiante is always open for paid users
        if (levelId === 'principiante') return false;
        
        // Still need to complete previous level with 100%
        const levelOrder = ['principiante', 'intermedio', 'avanzado', 'elite', 'platino'];
        const currentIndex = levelOrder.indexOf(levelId);
        if (currentIndex <= 0) return false;

        const previousLevel = levelOrder[currentIndex - 1];
        const p = progress[previousLevel];
        if (!p || p.completed === 0) return true;

        const percentage = Math.round((p.score / p.completed) * 100);
        const allCompleted = p.completed >= p.total;
        return !(allCompleted && percentage >= 100);
      }
      
      // For free users: Only Principiante available during trial period
      if (levelId === 'principiante') {
        // Check if trial is still valid (30 days)
        return !isTrialValid();
      }

      // All other levels require paid subscription
      return true;
    }

    function showPurchaseModal() {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.92);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
      modal.innerHTML = `
        <div style="background:linear-gradient(135deg,#1a5276,#154360);border-radius:20px;padding:22px;max-width:400px;width:100%;text-align:center;border:2px solid #f39c12;max-height:90vh;overflow-y:auto;">
          <div style="font-size:40px;margin-bottom:6px;">‚ö†Ô∏è</div>
          <h3 style="color:#e74c3c;margin-bottom:6px;font-size:18px;">¬°No Pierdas Tu Progreso!</h3>
          <p style="color:#fbbf24;font-size:14px;font-weight:700;margin-bottom:4px;">Tu prueba gratuita de 50 preguntas termin√≥</p>
          <p style="color:#e2e8f0;font-size:13px;margin-bottom:12px;">No pierdas tu progreso ni tus certificados.<br><strong style="color:#ffd700;">¬°Reg√≠strate ahora y sigue avanzando!</strong></p>
          
          <div style="background:rgba(243,156,18,0.15);border:1px solid rgba(243,156,18,0.5);border-radius:10px;padding:8px;margin-bottom:12px;">
            <p style="color:#f39c12;font-size:11px;margin:0;">üì± Acceso completo: 5 niveles ¬∑ 3,500+ preguntas ¬∑ Certificaciones HVAC</p>
          </div>
          
          <div style="background:rgba(46,204,113,0.15);border:2px solid rgba(46,204,113,0.4);border-radius:15px;padding:12px;margin-bottom:10px;">
            <p style="color:#2ecc71;font-size:12px;font-weight:bold;margin-bottom:2px;">üí∞ MEJOR VALOR - ANUAL</p>
            <p style="color:#fff;font-size:24px;font-weight:bold;margin-bottom:2px;">$240 USD/a√±o</p>
            <p style="color:#94a3b8;font-size:12px;margin-bottom:8px;">Solo $20/mes ‚Äî Ahorra con el plan anual</p>
            <button onclick="window.open('https://buy.stripe.com/annual240','_blank');" style="width:100%;padding:12px;border:none;border-radius:12px;font-size:14px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#2ecc71,#27ae60);color:white;">üí≥ Pagar $240/A√±o</button>
          </div>

          <div style="background:rgba(52,152,219,0.15);border:1px solid rgba(52,152,219,0.4);border-radius:15px;padding:12px;margin-bottom:12px;">
            <p style="color:#fff;font-size:20px;font-weight:bold;margin-bottom:2px;">$20 USD/mes</p>
            <p style="color:#94a3b8;font-size:12px;margin-bottom:8px;">Suscripci√≥n mensual ‚Äî Cancela cuando quieras</p>
            <button onclick="window.open('https://buy.stripe.com/fZu5kD9U32cU1ojaYv3sI07','_blank');" style="width:100%;padding:12px;border:none;border-radius:12px;font-size:14px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#3498db,#2980b9);color:white;">üí≥ Suscribirme $20/mes</button>
          </div>
          
          <div style="background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.3);border-radius:10px;padding:8px;margin-bottom:10px;">
            <p style="color:#e74c3c;font-size:10px;margin:0;">üö´ <strong>Sin reembolsos</strong> despu√©s de 3 d√≠as de uso de la app.</p>
          </div>

          <p style="color:#94a3b8;font-size:10px;margin-bottom:10px;">Despu√©s de pagar, env√≠a tu comprobante por WhatsApp o correo para activar tu acceso en menos de 24 horas.</p>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px;">
            <button onclick="window.open('https://wa.me/19096390448?text=${encodeURIComponent("Hola, acabo de pagar por Maestro ACVOLT App completa. Mi correo es: "+(currentUser?currentUser.email:""))}','_blank');" style="padding:8px;border:none;border-radius:10px;font-size:12px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#25D366,#128C7E);color:white;">üì± WhatsApp</button>
            <button onclick="openEmailComposer('Techschoolacvolt@gmail.com','Compra Maestro ACVOLT App','Hola, acabo de pagar por Maestro ACVOLT App completa. Mi correo es: '+(currentUser?currentUser.email:''),'üìß Confirmar Compra App');" style="padding:8px;border:none;border-radius:10px;font-size:12px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#3498db,#2980b9);color:white;">üìß Correo</button>
          </div>

          <div style="border-top:1px solid rgba(255,255,255,0.15);padding-top:10px;margin-bottom:10px;">
            <p style="color:#9b59b6;font-size:12px;font-weight:bold;margin-bottom:6px;">üé´ ¬øYa tienes un c√≥digo de acceso?</p>
            <div style="display:flex;gap:8px;">
              <input type="text" id="accessCodeInput" placeholder="Ingresa tu c√≥digo" maxlength="10" style="flex:1;padding:8px;border-radius:10px;border:1px solid #e2e8f0;background:#f8fafc;color:#1e293b;font-size:14px;text-align:center;letter-spacing:2px;text-transform:uppercase;font-family:monospace;">
              <button onclick="redeemAccessCode()" style="padding:8px 14px;border:none;border-radius:10px;font-size:12px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#9b59b6,#8e44ad);color:white;">Activar</button>
            </div>
            <p id="codeRedeemMsg" style="color:#e74c3c;font-size:11px;margin-top:4px;display:none;"></p>
          </div>

          <button onclick="this.closest('div').parentElement.remove();" style="width:100%;padding:10px;border:none;border-radius:12px;font-size:13px;cursor:pointer;background:rgba(255,255,255,0.15);color:#64748b;">Cancelar</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Unlock a level for current user
    function unlockLevel(levelId, matrixId) {
      if (!currentUser || !currentUser.email) return false;
      const userKey = currentUser.email;
      if (!unlockedLevels[userKey]) {
        unlockedLevels[userKey] = [];
      }
      if (!unlockedLevels[userKey].includes(levelId)) {
        unlockedLevels[userKey].push(levelId);
        // Store the Matrix ID used
        if (!unlockedLevels[userKey + '_matrixIds']) {
          unlockedLevels[userKey + '_matrixIds'] = {};
        }
        unlockedLevels[userKey + '_matrixIds'][levelId] = matrixId;
        saveUnlockedLevels();
        // Sync to Supabase
        supabaseSaveUnlockedLevel(levelId, matrixId);
      }
      return true;
    }

    // Validate Matrix ID
    function isValidMatrixId(matrixId) {
      const normalizedId = matrixId.trim().toUpperCase();
      return VALID_MATRIX_IDS.includes(normalizedId);
    }

    // Show Matrix unlock modal
    function showMatrixModal(levelId) {
      if (!LOCK_SYSTEM_ENABLED) return;
      pendingLevelToUnlock = levelId;
      document.getElementById('matrixUnlockModal').style.display = 'flex';
      document.getElementById('matrixIdInput').value = '';
      document.getElementById('matrixUnlockError').classList.remove('show');
      document.getElementById('matrixIdInput').focus();
    }

    // Close Matrix modal
    function closeMatrixModal() {
      document.getElementById('matrixUnlockModal').style.display = 'none';
      pendingLevelToUnlock = null;
    }

    // Validate and unlock level
    function validateMatrixId() {
      const input = document.getElementById('matrixIdInput').value;
      const errorDiv = document.getElementById('matrixUnlockError');

      if (isValidMatrixId(input)) {
        unlockLevel(pendingLevelToUnlock, input.trim().toUpperCase());
        closeMatrixModal();
        renderLevels();
        // Automatically start the quiz after unlocking
        startQuiz(pendingLevelToUnlock);
      } else {
        errorDiv.classList.add('show');
        document.getElementById('matrixIdInput').value = '';
        document.getElementById('matrixIdInput').focus();
      }
    }

    // Handle Enter key in Matrix input
    document.addEventListener('DOMContentLoaded', function() {
      const matrixInput = document.getElementById('matrixIdInput');
      if (matrixInput) {
        matrixInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            validateMatrixId();
          }
        });
      }
    });
    // ==== END LOCK SYSTEM ====

    // Levels configuration
    const levels = [
      { id: 'principiante', name: 'Principiante', icon: 'üîß', color: '#27ae60' },
      { id: 'intermedio', name: 'Intermedio', icon: 'üìä', color: '#3498db' },
      { id: 'avanzado', name: 'Avanzado', icon: '‚ö°', color: '#f39c12' },
      { id: 'elite', name: 'Elite', icon: 'üèÜ', color: '#9b59b6' },
      { id: 'platino', name: 'Platino', icon: 'üíé', color: '#1abc9c' }
    ];

    // 50 NATE Core Questions
    // Questions loaded externally for performance (questions.js - 1.3MB loaded on demand)
    let questions = {};
    let questionsLoaded = false;
    
    async function loadQuestions() {
      if (questionsLoaded) return questions;
      try {
        const script = document.createElement('script');
        script.src = 'questions.js';
        await new Promise(function(resolve, reject) {
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
        questionsLoaded = true;
        console.log('[MaestroAC] ‚úÖ Questions loaded: ' + Object.keys(questions).length + ' levels');
      } catch(e) {
        console.error('[MaestroAC] ‚ùå Error loading questions:', e);
      }
      return questions;
    }

    // Login credentials
    let pendingRegEmail = '';

    // Check if user is authenticated via Supabase
    function isAuthenticated() {
      return localStorage.getItem('tecnico_authenticated') === 'true' && localStorage.getItem('tecnico_email');
    }

    // Robust session recovery: check Supabase session even if localStorage was cleared
    async function recoverSession() {
      if (!supabaseClient) return false;
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session && session.user && session.user.email) {
          const email = session.user.email;
          console.log('[MaestroAC] Session recovered for:', email);
          localStorage.setItem('tecnico_authenticated', 'true');
          localStorage.setItem('tecnico_email', email);
          // Load profile from Supabase technicians table
          try {
            const { data: techData } = await supabaseClient.from('technicians').select('*').eq('email', email).single();
            if (techData && techData.nombre) {
              currentUser = {
                nombre: techData.nombre,
                email: email,
                telefono: techData.telefono || '',
                ciudad: techData.ciudad || '',
                experiencia: techData.experiencia || '',
                registrationDate: techData.registration_date
              };
              const users = JSON.parse(localStorage.getItem('maestroac_users') || '{}');
              users[email] = { ...currentUser, password: '(supabase-auth)', verified: true };
              localStorage.setItem('maestroac_users', JSON.stringify(users));
              localStorage.setItem('tecnico_user', JSON.stringify(currentUser));
              localStorage.setItem('tecnico_user_backup', JSON.stringify(currentUser));
            }
          } catch(e) { console.log('[MaestroAC] Recover profile error:', e); }
          return true;
        }
      } catch(e) { console.log('[MaestroAC] Session recovery failed:', e); }
      return false;
    }

    // Helper: resend confirmation email from login error
    async function resendConfirmationForLogin(email) {
      var msgDiv = document.getElementById('loginConfirmMsg');
      if (!supabaseClient) { if(msgDiv) msgDiv.innerHTML = '<span style="color:#e74c3c;">Error de conexi√≥n</span>'; return; }
      try {
        if(msgDiv) msgDiv.innerHTML = '<span style="color:#f39c12;">Enviando...</span>';
        var { error } = await supabaseClient.auth.resend({ type: 'signup', email: email });
        if (error) {
          if(msgDiv) msgDiv.innerHTML = '<span style="color:#e74c3c;">' + error.message + '</span>';
        } else {
          if(msgDiv) msgDiv.innerHTML = '<span style="color:#27ae60;">‚úÖ ¬°Correo enviado! Revisa tu bandeja y <strong>SPAM</strong>.</span>';
        }
      } catch(e) { if(msgDiv) msgDiv.innerHTML = '<span style="color:#e74c3c;">Error de conexi√≥n</span>'; }
    }

    // Helper: send magic link directly from login error
    async function sendMagicLinkDirect(email) {
      var msgDiv = document.getElementById('loginConfirmMsg');
      if (!supabaseClient) { if(msgDiv) msgDiv.innerHTML = '<span style="color:#e74c3c;">Error de conexi√≥n</span>'; return; }
      try {
        if(msgDiv) msgDiv.innerHTML = '<span style="color:#9b59b6;">Enviando link de acceso...</span>';
        var { error } = await supabaseClient.auth.signInWithOtp({ email: email, options: { emailRedirectTo: 'https://maestromario.com' } });
        if (error) {
          if(msgDiv) msgDiv.innerHTML = '<span style="color:#e74c3c;">' + error.message + '</span>';
        } else {
          if(msgDiv) msgDiv.innerHTML = '<span style="color:#27ae60;">‚úÖ ¬°Link enviado a <strong>' + email + '</strong>! Revisa tu correo y SPAM.</span>';
        }
      } catch(e) { if(msgDiv) msgDiv.innerHTML = '<span style="color:#e74c3c;">Error de conexi√≥n</span>'; }
    }
    async function handleLogin(event) {
      event.preventDefault();
      const email = document.getElementById('loginEmail').value.trim().toLowerCase();
      const pass = document.getElementById('loginPassword').value;
      const errorDiv = document.getElementById('loginError');

      if (!supabaseClient) {
        errorDiv.innerHTML = '‚ö†Ô∏è <strong>Sin conexi√≥n al servidor.</strong><br>' +
          '<span style="font-size:13px;">Verifica tu internet e intenta de nuevo.</span><br><br>' +
          '<button onclick="location.reload()" style="padding:10px 20px;background:#3498db;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:bold;">üîÑ Reintentar</button>';
        errorDiv.classList.add('show');
        return false;
      }

      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email: email,
          password: pass
        });

        if (error) {
          if (error.message.includes('Email not confirmed')) {
            pendingRegEmail = email;
            errorDiv.innerHTML = 'üìß <strong>Tu correo no est√° confirmado.</strong><br>' +
              '<span style="font-size:13px;">Revisa tu bandeja de entrada y carpeta de <strong>SPAM</strong>.</span><br><br>' +
              '<div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">' +
              '<button onclick="resendConfirmationForLogin(\'' + email + '\')" style="padding:8px 14px;background:#3498db;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:bold;">üìß Reenviar Confirmaci√≥n</button>' +
              '<button onclick="sendMagicLinkDirect(\'' + email + '\')" style="padding:8px 14px;background:#9b59b6;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:bold;">‚ú® Entrar sin contrase√±a</button>' +
              '</div>' +
              '<div id="loginConfirmMsg" style="margin-top:8px;font-size:12px;"></div>';
          } else if (error.message.includes('Invalid login')) {
            errorDiv.innerHTML = '‚ùå Correo o contrase√±a incorrectos.<br>' +
              '<span style="font-size:13px;color:#94a3b8;">Verifica que tu correo y contrase√±a sean correctos.</span>';
          } else if (error.message.includes('rate') || error.message.includes('limit')) {
            errorDiv.innerHTML = '‚è≥ Demasiados intentos. Espera unos minutos e intenta de nuevo.';
          } else {
            errorDiv.innerHTML = '‚ö†Ô∏è ' + error.message;
          }
          errorDiv.classList.add('show');
          return false;
        }

        // Login successful
        localStorage.setItem('tecnico_authenticated', 'true');
        localStorage.setItem('tecnico_email', email);
        errorDiv.classList.remove('show');

        // Load user profile from local storage or Supabase
        const users = JSON.parse(localStorage.getItem('maestroac_users') || '{}');
        if (users[email]) {
          currentUser = {
            nombre: users[email].nombre,
            email: email,
            telefono: users[email].telefono || '',
            ciudad: users[email].ciudad || '',
            experiencia: users[email].experiencia || '',
            registrationDate: users[email].registrationDate
          };
        } else {
          // Try loading from Supabase technicians table
          try {
            const { data: techData } = await supabaseClient.from('technicians').select('*').eq('email', email).single();
            if (techData) {
              currentUser = {
                nombre: techData.nombre || email.split('@')[0],
                email: email,
                telefono: techData.telefono || '',
                ciudad: techData.ciudad || '',
                experiencia: techData.experiencia || '',
                registrationDate: techData.registration_date
              };
              // Cache locally
              users[email] = { ...currentUser, password: '(supabase-auth)' };
              localStorage.setItem('maestroac_users', JSON.stringify(users));
            }
          } catch(e) {}
          if (!currentUser || !currentUser.nombre) {
            currentUser = { nombre: email.split('@')[0], email: email };
          }
        }

        loadUserProgress(email);
        logActivity('login', 'Inicio de sesi√≥n');
        addNotification('register', 'üîì Sesi√≥n iniciada ‚Äî ¬°Bienvenido ' + (currentUser.nombre ? currentUser.nombre.split(' ')[0] : 'T√©cnico') + '!', 'üîì');

        // Check membership and auto-connect (Escenario B)
        try {
          const membership = await checkMembership(email);
          if (membership && membership.activa) {
            currentMembership = membership;
            membershipAuthenticated = true;
          }
          // Check for failed/expired payments
          await checkFailedPayment(email);
        } catch(e) { console.log('Membership check skipped:', e); }

        // Sync tecnico_user so handleComenzar finds it
        if (currentUser && currentUser.nombre) {
          localStorage.setItem('tecnico_user', JSON.stringify(currentUser));
          localStorage.setItem('tecnico_user_backup', JSON.stringify(currentUser));
        }

        const savedState = loadLastQuizState();
        if (savedState && savedState.levelKey && savedState.questionIndex > 0) {
          showScreen('welcomeScreen');
          showResumeBanner(savedState);
        } else {
          showScreen('welcomeScreen');
        }
      } catch(e) {
        console.error('[MaestroAC] Login exception:', e);
        errorDiv.innerHTML = '‚ö†Ô∏è <strong>Error de conexi√≥n.</strong><br>' +
          '<span style="font-size:13px;">Verifica tu internet. Si el problema contin√∫a, intenta con el link de acceso abajo.</span>';
        errorDiv.classList.add('show');
      }
      return false;
    }

    // Handle registration with Supabase Auth
    async function handleRegister(event) {
      event.preventDefault();
      const name = document.getElementById('regName').value.trim();
      const email = document.getElementById('regEmail').value.trim().toLowerCase();
      const phone = document.getElementById('regPhone').value.trim();
      const city = document.getElementById('regCity').value.trim();
      const experience = document.getElementById('regExperience').value;
      const epa = document.getElementById('regEPA').value.trim();
      const osha = document.getElementById('regOSHA').value.trim();
      const hvace = document.getElementById('regHVACE').value.trim();
      const pass = document.getElementById('regPassword').value;
      const passConfirm = document.getElementById('regPasswordConfirm').value;
      const errorDiv = document.getElementById('registerError');

      // Validate required fields
      if (!name || name.length < 3) {
        errorDiv.textContent = 'Ingresa tu nombre completo (m√≠nimo 3 caracteres)';
        errorDiv.classList.add('show');
        return false;
      }
      if (!phone || phone.length < 7) {
        errorDiv.textContent = 'Ingresa un n√∫mero de tel√©fono v√°lido';
        errorDiv.classList.add('show');
        return false;
      }
      if (!city || city.length < 3) {
        errorDiv.textContent = 'Ingresa tu ciudad y estado';
        errorDiv.classList.add('show');
        return false;
      }
      if (!experience) {
        errorDiv.textContent = 'Selecciona tus a√±os de experiencia';
        errorDiv.classList.add('show');
        return false;
      }
      if (pass !== passConfirm) {
        errorDiv.textContent = 'Las contrase√±as no coinciden';
        errorDiv.classList.add('show');
        return false;
      }
      if (pass.length < 6) {
        errorDiv.textContent = 'La contrase√±a debe tener m√≠nimo 6 caracteres';
        errorDiv.classList.add('show');
        return false;
      }

      if (!supabaseClient) {
        errorDiv.innerHTML = '‚ö†Ô∏è <strong>Sin conexi√≥n al servidor.</strong><br><span style="font-size:13px;">Verifica tu internet y recarga la p√°gina.</span><br><br>' +
          '<button onclick="location.reload()" style="padding:10px 20px;background:#3498db;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:bold;">üîÑ Recargar P√°gina</button>';
        errorDiv.classList.add('show');
        return false;
      }

      try {
        // Register with Supabase Auth (sends confirmation email automatically)
        const { data, error } = await supabaseClient.auth.signUp({
          email: email,
          password: pass,
          options: {
            data: {
              nombre: name,
              telefono: phone,
              ciudad: city,
              experiencia: experience
            }
          }
        });

        if (error) {
          if (error.message.includes('already registered') || error.message.includes('User already registered')) {
            errorDiv.textContent = 'Este correo ya est√° registrado. Inicia sesi√≥n.';
          } else {
            errorDiv.textContent = error.message;
          }
          errorDiv.classList.add('show');
          return false;
        }

        // Save user data locally and to Supabase technicians table

        // Verificar si el email ya existe (Supabase retorna user con identities vacio)
        if (data.user && data.user.identities && data.user.identities.length === 0) {
            errorDiv.innerHTML = 'Este correo ya tiene cuenta. <a href="#" onclick="showScreen(\x27loginScreen\x27); return false;" style="color:#f39c12;text-decoration:underline;">Iniciar Sesion</a>';
            errorDiv.classList.add('show');
            return false;
        }

        const users = JSON.parse(localStorage.getItem('maestroac_users') || '{}');
        users[email] = {
          nombre: name,
          password: '(supabase-auth)',
          telefono: phone,
          ciudad: city,
          experiencia: experience,
          epa: epa || '',
          osha: osha || '',
          hvace: hvace || '',
          registrationDate: new Date().toISOString(),
          appAccess: false,
          verified: false
        };
        localStorage.setItem('maestroac_users', JSON.stringify(users));

        // Save to technicians table
        try {
          await supabaseClient.from('technicians').upsert({
            email: email,
            nombre: name,
            telefono: phone,
            ciudad: city,
            experiencia: experience,
            epa: epa || '',
            osha: osha || '',
            hvace: hvace || '',
            registration_date: new Date().toISOString()
          });
          
          // ====== SAVE REFERRAL IF EXISTS ======
          var savedRefCode = localStorage.getItem('maestroac_referral_code');
          if (savedRefCode) {
            try {
              await supabaseClient.from('referrals').insert({
                referral_code: savedRefCode,
                referred_email: email,
                referred_name: name,
                referred_date: new Date().toISOString(),
                status: 'registered'
              });
              localStorage.removeItem('maestroac_referral_code');
              localStorage.removeItem('maestroac_referral_date');
              console.log('üéÅ Referral saved: ' + savedRefCode + ' -> ' + email);
            } catch(refErr) { console.log('[Referral] Save error:', refErr); }
          }
        } catch(e) { console.log('[MaestroAC] Save technician error:', e); }

        // Show email confirmation pending screen
        pendingRegEmail = email;
        document.getElementById('pendingEmailText').innerHTML = 
          'Te enviamos un link de confirmaci√≥n a:<br><strong style="color:#f39c12;font-size:16px;">' + email + '</strong>';
        errorDiv.classList.remove('show');
        showScreen('emailPendingScreen');
      } catch(e) {
        console.error('[MaestroAC] Register exception:', e);
        errorDiv.innerHTML = '‚ö†Ô∏è <strong>Error de conexi√≥n.</strong><br><span style="font-size:13px;">Verifica tu internet e intenta de nuevo.</span>';
        errorDiv.classList.add('show');
      }
      return false;
    }

    // Resend confirmation email
    async function resendConfirmation() {
      if (!supabaseClient || !pendingRegEmail) {
        alert('No hay correo pendiente de confirmaci√≥n.');
        return;
      }
      try {
        const { error } = await supabaseClient.auth.resend({
          type: 'signup',
          email: pendingRegEmail
        });
        if (error) {
          alert('Error: ' + error.message + '\n\nEspera 60 segundos antes de intentar de nuevo.');
        } else {
          alert('‚úÖ Correo reenviado a ' + pendingRegEmail + '\n\nRevisa tu bandeja de entrada y carpeta de spam.');
        }
      } catch(e) {
        alert('Error de conexi√≥n. Intenta de nuevo.');
      }
    }

    // Cerrar sesion del usuario
    // === FREE USER PROGRESS TRACKER ===
    function updateFreeUserProgress() {
      const progressDiv = document.getElementById('freeUserProgress');
      if (!progressDiv) return;
      if (hasAppAccess()) { progressDiv.style.display = 'none'; return; }
      
      // Count answered questions from localStorage
      const email = currentUser ? currentUser.email : '';
      if (!email) { progressDiv.style.display = 'none'; return; }
      
      let answered = 0;
      try {
        const key = 'maestroac_quiz_history_' + email;
        const history = JSON.parse(localStorage.getItem(key) || '[]');
        answered = history.length;
      } catch(e) {
        // Try counting from question status
        answered = Object.keys(questionStatus || {}).length;
      }
      
      const max = 50;
      const pct = Math.min(100, Math.round((answered / max) * 100));
      
      progressDiv.style.display = 'block';
      document.getElementById('progressCount').textContent = Math.min(answered, max) + '/' + max + ' preguntas';
      document.getElementById('progressBar').style.width = pct + '%';
      
      const msgEl = document.getElementById('progressMsg');
      if (pct >= 80) {
        msgEl.textContent = '‚ö†Ô∏è ¬°Casi llegas al l√≠mite! Suscr√≠bete para seguir avanzando';
        msgEl.style.color = '#dc2626';
        msgEl.style.fontWeight = '700';
      } else if (pct >= 50) {
        msgEl.textContent = 'üî• ¬°Buen progreso! Sigue practicando';
        msgEl.style.color = '#d97706';
        msgEl.style.fontWeight = '600';
      } else if (answered > 0) {
        msgEl.textContent = 'üí™ ¬°Sigue as√≠! Tienes acceso a ' + max + ' preguntas gratis';
        msgEl.style.color = '#92400e';
        msgEl.style.fontWeight = '400';
      } else {
        msgEl.textContent = 'üéØ Tienes 50 preguntas GRATIS ‚Äî ¬°Empieza ahora!';
        msgEl.style.color = '#92400e';
        msgEl.style.fontWeight = '400';
      }
    }

    // === CLASS REMINDER NOTIFICATIONS (Dynamic from Calendar) ===
    function checkClassReminders() {
      if (!liveClasses || liveClasses.length === 0) return;
      
      const now = new Date();
      const today = now.toDateString();
      const remindersKey = 'maestroac_reminders_' + today;
      const sent = JSON.parse(localStorage.getItem(remindersKey) || '{}');
      
      liveClasses.forEach(function(c) {
        if (c.estado === 'completada') return;
        
        const classDate = new Date(c.fecha);
        if (classDate.toDateString() !== today) return;
        
        const classId = c.id || c.titulo;
        if (sent[classId]) return;
        
        // Parse class start time
        const startParts = (c.hora_inicio || '18:00').split(':');
        const classHour = parseInt(startParts[0]);
        const currentHour = now.getHours();
        
        // Send reminder 1 hour before class
        if (currentHour >= (classHour - 1) && currentHour <= classHour) {
          const timeStr = c.hora_inicio + ' - ' + (c.hora_fin || '');
          addNotification('class', 'üì¢ HOY ‚Äî ' + c.titulo + ' (' + timeStr + ') con ' + (c.instructor || 'Maestro Mario'), 'üî¥');
          sent[classId] = true;
          localStorage.setItem(remindersKey, JSON.stringify(sent));
        }
      });
    }
    
    // Check reminders every 10 minutes
    setInterval(checkClassReminders, 10 * 60 * 1000);
    // Also check after calendar loads and on page load
    setTimeout(checkClassReminders, 5000);
    
    // Hook into calendar load to re-check reminders
    const _origLoadCal = typeof loadCalendarData === 'function' ? loadCalendarData : null;
    if (_origLoadCal) {
      const _wrappedLoadCal = async function() {
        await _origLoadCal();
        setTimeout(checkClassReminders, 2000);
      };
      // Will be called when calendar screen opens
    }

    async function cerrarSesion() {
        try {
            if (supabaseClient) {
                await supabaseClient.auth.signOut();
            }
        } catch(e) {
            console.log('[MaestroAC] SignOut error:', e);
        }
        localStorage.removeItem('tecnico_authenticated');
        localStorage.removeItem('tecnico_email');
        sessionStorage.removeItem('tecnico_authenticated');
        sessionStorage.removeItem('tecnico_email');
        currentUser = null;
        supabaseUserId = null;
        showScreen('loginScreen');
    }

    // Load user-specific progress
    function loadUserProgress(email) {
      const key = 'maestroac_progress_' + email;
      const saved = localStorage.getItem(key);
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          Object.keys(parsed).forEach(k => {
            if (progress[k]) {
              progress[k] = parsed[k];
            }
          });
        } catch(e) {}
      }
      renderLevels();
    }

    // Initialize
    async function init() {
      loadProgress();
      loadVideoProgress();
      renderLevels();

      // Clean up stale attendance sessions
      checkStaleAttendance();

      // ============================================
      // DETECT PASSWORD RECOVERY TOKEN IN URL
      // Supports both methods:
      // 1. Hash fragment: #access_token=xxx&type=recovery (implicit flow)
      // 2. Query params: ?token_hash=xxx&type=recovery (PKCE flow)
      // ============================================
      var isRecovery = false;
      var tokenHash = null;
      
      // Method 1: Check hash fragment
      var hashParams = new URLSearchParams(window.location.hash.substring(1));
      if (hashParams.get('type') === 'recovery') {
        isRecovery = true;
        console.log('[MaestroAC] Recovery detected via hash fragment');
      }
      
      // Method 2: Check query parameters (PKCE flow - more reliable on Chrome/iPhone)
      var queryParams = new URLSearchParams(window.location.search);
      if (queryParams.get('type') === 'recovery') {
        isRecovery = true;
        tokenHash = queryParams.get('token_hash');
        console.log('[MaestroAC] Recovery detected via query params, token_hash:', tokenHash ? 'present' : 'missing');
      }
      
      if (isRecovery) {
        console.log('[MaestroAC] Showing password reset form');
        
        // If we have a token_hash (PKCE flow), verify it first
        if (tokenHash && supabaseClient) {
          try {
            var { data, error } = await supabaseClient.auth.verifyOtp({
              token_hash: tokenHash,
              type: 'recovery'
            });
            if (error) {
              console.error('[MaestroAC] Token verification error:', error.message);
            } else {
              console.log('[MaestroAC] Token verified successfully');
            }
          } catch(e) {
            console.error('[MaestroAC] Token verification exception:', e);
          }
        }
        
        // Show reset password form
        setTimeout(function() {
          showScreen('loginScreen');
          var loginCard = document.querySelector('#loginScreen .card');
          if (loginCard) loginCard.style.display = 'none';
          var resetBox = document.getElementById('resetPasswordBox');
          if (resetBox) resetBox.style.display = 'block';
          // Clean URL
          if (window.history && window.history.replaceState) {
            window.history.replaceState(null, '', window.location.pathname);
          }
        }, 800);
      }

      // Check for Supabase Auth callback (email confirmation redirect)
      if (supabaseClient) {
        try {
          const { data: { session } } = await supabaseClient.auth.getSession();
          if (session && session.user) {
            const email = session.user.email;
            localStorage.setItem('tecnico_authenticated', 'true');
            localStorage.setItem('tecnico_email', email);
            // Also populate tecnico_user from maestroac_users if available
            const initUsers = JSON.parse(localStorage.getItem('maestroac_users') || '{}');
            if (initUsers[email] && initUsers[email].nombre && !localStorage.getItem('tecnico_user')) {
                localStorage.setItem('tecnico_user', JSON.stringify({
                    nombre: initUsers[email].nombre,
                    email: email,
                    telefono: initUsers[email].telefono || '',
                    ciudad: initUsers[email].ciudad || '',
                    experiencia: initUsers[email].experiencia || '',
                    registrationDate: initUsers[email].registrationDate
                }));
            }
            
            // Mark as verified locally
            const users = JSON.parse(localStorage.getItem('maestroac_users') || '{}');
            if (users[email]) {
              users[email].verified = true;
              localStorage.setItem('maestroac_users', JSON.stringify(users));
            }
          }
        } catch(e) { console.log('[MaestroAC] Session check:', e); }
      }

      // Check authentication status
      if (isAuthenticated()) {
        const email = localStorage.getItem('tecnico_email');
        const users = JSON.parse(localStorage.getItem('maestroac_users') || '{}');
        if (users[email] && users[email].nombre) {
          currentUser = {
            nombre: users[email].nombre,
            email: email,
            telefono: users[email].telefono || '',
            ciudad: users[email].ciudad || '',
            experiencia: users[email].experiencia || '',
            registrationDate: users[email].registrationDate
          };
          // Sync tecnico_user so handleComenzar finds it
          localStorage.setItem('tecnico_user', JSON.stringify(currentUser));
          localStorage.setItem('tecnico_user_backup', JSON.stringify(currentUser));
          loadUserProgress(email);
        } else if (email && supabaseClient) {
          // No local data - try loading from Supabase technicians table (new device)
          try {
            const { data: techData } = await supabaseClient.from('technicians').select('*').eq('email', email).single();
            if (techData && techData.nombre) {
              currentUser = {
                nombre: techData.nombre,
                email: email,
                telefono: techData.telefono || '',
                ciudad: techData.ciudad || '',
                experiencia: techData.experiencia || '',
                registrationDate: techData.registration_date
              };
              // Cache locally for future loads
              users[email] = { ...currentUser, password: '(supabase-auth)', verified: true };
              localStorage.setItem('maestroac_users', JSON.stringify(users));
              localStorage.setItem('tecnico_user', JSON.stringify(currentUser));
              localStorage.setItem('tecnico_user_backup', JSON.stringify(currentUser));
              loadUserProgress(email);
            }
          } catch(e) { console.log('[MaestroAC] Load technician on init:', e); }
        }
        const savedState = loadLastQuizState();
        if (savedState && savedState.levelKey && savedState.questionIndex > 0) {
          showScreen('welcomeScreen');
          showResumeBanner(savedState);
        } else {
          showScreen('welcomeScreen');
        }
      } else {
        // localStorage doesn't have auth ‚Äî but maybe Supabase still has an active session
        const recovered = await recoverSession();
        if (recovered) {
          const email = localStorage.getItem('tecnico_email');
          if (email) loadUserProgress(email);
          console.log('[MaestroAC] Session auto-recovered! Redirecting to welcome.');
          const savedState = loadLastQuizState();
          if (savedState && savedState.levelKey && savedState.questionIndex > 0) {
            showScreen('welcomeScreen');
            showResumeBanner(savedState);
          } else {
            showScreen('welcomeScreen');
          }
        } else {
          showScreen('loginScreen');
        }
      }

      // Register form handler (profile creation form)
      const regForm = document.getElementById('registerForm');
      if (regForm) {
        regForm.addEventListener('submit', function(e) {
          e.preventDefault();
          registerUser();
        });
      }
    }

    // Show resume banner on welcome screen
    function showResumeBanner(savedState) {
      // Create or update resume banner
      let banner = document.getElementById('resumeBanner');
      if (!banner) {
        banner = document.createElement('div');
        banner.id = 'resumeBanner';
        banner.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 12px; margin: 15px 0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);';

        // Insert banner after the header in the welcome screen
        const welcomeScreen = document.getElementById('welcomeScreen');
        const header = welcomeScreen.querySelector('.header');
        if (header && header.nextSibling) {
          welcomeScreen.insertBefore(banner, header.nextSibling);
        } else if (welcomeScreen) {
          welcomeScreen.appendChild(banner);
        }
      }

      const levelName = levels.find(l => l.id === savedState.levelKey)?.name || savedState.levelKey;
      const progressText = `${savedState.questionIndex + 1}/${savedState.totalQuestions}`;

      banner.innerHTML = `
        <div>
          <div style="font-weight: 600; margin-bottom: 4px;">Continuar Quiz</div>
          <div style="font-size: 13px; opacity: 0.9;">${levelName} - ${progressText} preguntas</div>
        </div>
        <div style="display: flex; gap: 10px;">
          <button onclick="dismissResumeBanner()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px;">Descartar</button>
          <button onclick="resumeFromBanner()" style="background: white; color: #667eea; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Continuar</button>
        </div>
      `;

      banner.style.display = 'flex';
    }

    // Resume from the welcome screen banner
    function resumeFromBanner() {
      const banner = document.getElementById('resumeBanner');
      if (banner) {
        banner.style.display = 'none';
      }
      resumeQuiz();
    }

    // Dismiss the resume banner and clear the saved state
    function dismissResumeBanner() {
      const banner = document.getElementById('resumeBanner');
      if (banner) {
        banner.style.display = 'none';
      }
      clearLastQuizState();
    }

    function showScreen(screenId) {
      if (typeof studyTimerInterval !== 'undefined' && studyTimerInterval) {
        var activeScreen = document.querySelector('.screen.active');
        if (activeScreen && (activeScreen.id === 'quizScreen' || activeScreen.id === 'quizOnlyScreen') && screenId !== 'quizScreen' && screenId !== 'quizOnlyScreen') {}
      }
      // Force check-in before accessing any content
      const protectedScreens = ['levelsScreen', 'studySectionsScreen', 'videoLessonsScreen', 'quizScreen', 'studyContentScreen', 'studyCategoryScreen', 'certificatesScreen', 'membershipZoneScreen', 'studentCalendarScreen', 'referidosScreen', 'certOficialesScreen'];
      if (protectedScreens.includes(screenId) && !sessionCheckedIn) {
        if (!requireCheckIn(screenId)) return;
      }
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      // Save current screen for "back to app" navigation
      localStorage.setItem('maestroac_last_screen', screenId);
      // Hide "back to app" button on login/register screens
      var backBtn = document.getElementById('backToAppBtn');
      if (backBtn) {
        if (screenId === 'loginScreen' || screenId === 'registerScreen' || screenId === 'adminLoginScreen') {
          backBtn.style.display = 'none';
        }
      }
    
      // Auto-load profile data when profile screen opens

window.toggleFormula = function(id) {
  var el = document.getElementById(id);
  var arrow = document.getElementById(id + '_arrow');
  if (!el) return;
  if (el.style.display === 'none') {
    el.style.display = 'block';
    if (arrow) arrow.textContent = '‚ñº';
  } else {
    el.style.display = 'none';
    if (arrow) arrow.textContent = '‚ñ∂';
  }
}

      if (screenId === 'miPerfilScreen') {
        try { loadProfileData(); } catch(e) {}
      }
      if (screenId === 'welcomeScreen') {
        try { updateFreeUserProgress(); } catch(e) {}
        // Auto-load calendar for class notifications
        try { if (liveClasses.length === 0) loadCalendarData(); } catch(e) {}
        setTimeout(function(){ try { checkClassReminders(); } catch(e) {} }, 3000);
      }
      // Auto-load admin data when admin dashboard opens
      
      if (screenId === 'referidosScreen') { try { initReferidosScreen(); } catch(e) {} }
      if (screenId === 'studentCalendarScreen') { try { loadCalendarData(); } catch(e) {} }
if (screenId === 'adminDashboardScreen') {
        try { renderAccessCodes(); } catch(e) {}
        try { loadActiveCodes(); } catch(e) {}
        try { loadAdminAttendance(); } catch(e) {}
        try { loadFinanzasData(); } catch(e) {}
        try { loadFinanzasStripe(); } catch(e) {}
        try { loadInactivityAlerts(); } catch(e) {}
        try { loadCalendarData(); } catch(e) {}
        try { loadReferidosData(); } catch(e) {}
        try { loadW9Reviews(); } catch(e) {}
        try { loadAmbassadorPayments(); } catch(e) {}
        try { loadAnalytics(); } catch(e) {}
        try { loadAdminCertificates(); } catch(e) {}
        try { renderLevelPerformanceChart(); } catch(e) {}
        try { loadAttendanceData(); } catch(e) {}
      // Check if new student needs onboarding
      try { checkShowOnboarding(); } catch(e) {}
        try { loadAdminStudentActivity(); } catch(e) {}
        try { loadAdminExamRequests(); } catch(e) {}
        try { loadAdminInbox(); } catch(e) {}
      }
    }

    // Handle the "Comenzar" button - check if profile exists
    async function handleComenzar() {
      let savedUser = localStorage.getItem('tecnico_user');
      if (!savedUser) savedUser = localStorage.getItem('tecnico_user_backup');
      if (savedUser) {
        try {
          const user = JSON.parse(savedUser);
          if (user && user.nombre) {
            // User already has a profile, go directly to levels
            currentUser = user;
            // Re-save to ensure both keys have data
            localStorage.setItem('tecnico_user', JSON.stringify(currentUser));
            localStorage.setItem('tecnico_user_backup', JSON.stringify(currentUser));
            // Sync with Supabase on login
            supabaseRegisterUser(currentUser).then(async (id) => {
              if (id) {
                console.log('[MaestroAC] Connected to Supabase user:', id);
                // Load cloud data and merge if newer
                const cloudData = await supabaseLoadUserData();
                if (cloudData && cloudData.progress) {
                  cloudData.progress.forEach(p => {
                    if (progress[p.nivel] && p.completed > progress[p.nivel].completed) {
                      progress[p.nivel].completed = p.completed;
                      progress[p.nivel].score = p.score;
                    }
                  });
                  saveProgress();
                  renderLevels();
                }
              }
            });
            document.getElementById('userGreeting').textContent = 'Hola, ' + currentUser.nombre.split(' ')[0];
            showNotifBell();
            showScreen('levelsScreen');
            return;
          }
        } catch(e) {
          console.error('Error loading saved user:', e);
        }
      }
      // Fallback: check maestroac_users (Supabase Auth registered users)
      const authEmail = localStorage.getItem('tecnico_email');
      if (authEmail) {
          const allUsers = JSON.parse(localStorage.getItem('maestroac_users') || '{}');
          const authUser = allUsers[authEmail];
          if (authUser && authUser.nombre) {
              currentUser = {
                  nombre: authUser.nombre,
                  email: authEmail,
                  telefono: authUser.telefono || '',
                  ciudad: authUser.ciudad || '',
                  experiencia: authUser.experiencia || '',
                  registrationDate: authUser.registrationDate
              };
              localStorage.setItem('tecnico_user', JSON.stringify(currentUser));
              localStorage.setItem('tecnico_user_backup', JSON.stringify(currentUser));
              document.getElementById('userGreeting').textContent = 'Hola, ' + currentUser.nombre.split(' ')[0];
              showNotifBell();
              showScreen('levelsScreen');
              return;
          }
      }
      // No valid profile found anywhere, try Supabase as last resort
      if (authEmail && supabaseClient) {
          try {
              const { data: techData } = await supabaseClient.from('technicians').select('*').eq('email', authEmail).single();
              if (techData && techData.nombre) {
                  currentUser = {
                      nombre: techData.nombre,
                      email: authEmail,
                      telefono: techData.telefono || '',
                      ciudad: techData.ciudad || '',
                      experiencia: techData.experiencia || '',
                      registrationDate: techData.registration_date
                  };
                  // Cache locally for future loads
                  const cacheUsers = JSON.parse(localStorage.getItem('maestroac_users') || '{}');
                  cacheUsers[authEmail] = { ...currentUser, password: '(supabase-auth)', verified: true };
                  localStorage.setItem('maestroac_users', JSON.stringify(cacheUsers));
                  localStorage.setItem('tecnico_user', JSON.stringify(currentUser));
                  localStorage.setItem('tecnico_user_backup', JSON.stringify(currentUser));
                  document.getElementById('userGreeting').textContent = 'Hola, ' + currentUser.nombre.split(' ')[0];
                  showNotifBell();
                  showScreen('levelsScreen');
                  return;
              }
          } catch(e) { console.log('[MaestroAC] Supabase fallback in Comenzar:', e); }
      }
      showScreen('registerScreen');
    }

    function registerUser() {
      currentUser = {
        nombre: document.getElementById('nombre').value,
        email: document.getElementById('email').value,
        telefono: document.getElementById('telefono').value,
        ciudad: document.getElementById('ciudad').value,
        estado: document.getElementById('estado').value,
        epa: document.getElementById('epa').value,
        nate: document.getElementById('nate').value,
        esco: document.getElementById('esco').value
      };
      // Auto-generate student ID
      if (!currentUser.studentId) {
        currentUser.studentId = generateStudentId();
        currentUser.studentIdDate = new Date().toISOString();
      }
      // Save with backup to prevent data loss
      localStorage.setItem('tecnico_user', JSON.stringify(currentUser));
      localStorage.setItem('tecnico_user_backup', JSON.stringify(currentUser));
      // Register in Supabase
      supabaseRegisterUser(currentUser).then(id => {
        if (id) console.log('[MaestroAC] User registered in Supabase:', id);
      });
      document.getElementById('userGreeting').textContent = 'Hola, ' + currentUser.nombre.split(' ')[0];
      addNotification('register', 'üë§ ¬°Bienvenido ' + currentUser.nombre.split(' ')[0] + '! Perfil creado exitosamente.', 'üë§');
      showNotifBell();
      showScreen('levelsScreen');
    }

    async function loadProgress() {
      await loadQuestions();
      // Load progress with backup fallback
      let saved = localStorage.getItem('tecnico_progress');
      if (!saved) saved = localStorage.getItem('tecnico_progress_backup');
      if (saved) {
        try {
          progress = JSON.parse(saved);
        } catch(e) {
          console.error('Error loading progress:', e);
        }
      }

      // Version migration: sync totals with target question counts
      const APP_QUESTION_VERSION = '1.7.2';
      const savedVersion = localStorage.getItem('maestroac_question_version');
      if (savedVersion !== APP_QUESTION_VERSION) {
        console.log('[MaestroAC] Migrating question totals to v' + APP_QUESTION_VERSION);
        const targetTotals = { principiante: 700, intermedio: 700, avanzado: 700, elite: 700, platino: 700 };
        Object.keys(targetTotals).forEach(key => {
          if (progress[key]) {
            const target = targetTotals[key];
            if (progress[key].total !== target) {
              console.log('[MaestroAC] ' + key + ': ' + progress[key].total + ' -> ' + target);
              progress[key].total = target;
              if (progress[key].completed > target) {
                progress[key].completed = 0;
                progress[key].score = 0;
              }
            }
          }
        });
        localStorage.setItem('maestroac_question_version', APP_QUESTION_VERSION);
        saveProgress();
      }

      // Load certificates with backup fallback - NEVER lose certificates!
      let savedCerts = localStorage.getItem('tecnico_certificates');
      if (!savedCerts) savedCerts = localStorage.getItem('tecnico_certificates_backup');
      if (savedCerts) {
        try {
          certificates = JSON.parse(savedCerts);
          // Re-save to ensure both keys have data
          saveCertificates();
        } catch(e) {
          console.error('Error loading certificates:', e);
        }
      }

      let savedUser = localStorage.getItem('tecnico_user');
      if (!savedUser) savedUser = localStorage.getItem('tecnico_user_backup');
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          // Re-save to ensure both keys have data
          localStorage.setItem('tecnico_user', JSON.stringify(currentUser));
          localStorage.setItem('tecnico_user_backup', JSON.stringify(currentUser));
          document.getElementById('userGreeting').textContent = 'Hola, ' + currentUser.nombre.split(' ')[0];
          showNotifBell();
        } catch(e) {
          console.error('Error loading user:', e);
        }
      }

      // Load lastActivity tracking data
      loadLastActivity();

      // Load lastQuizState for resume functionality
      loadLastQuizState();
      
      // Check for partial quiz progress
      checkPartialQuizProgress();
    
      // === FIX: Sync progress totals with actual question bank ===
      const levelNames = ['principiante', 'intermedio', 'avanzado', 'elite', 'platino'];
      const progressKeys = ['tecnico_progress', 'tecnico_progress_backup'];
      // Also sync email-specific keys
      const currentEmail = localStorage.getItem('tecnico_email') || '';
      if (currentEmail) progressKeys.push('maestroac_progress_' + currentEmail);
      
      progressKeys.forEach(key => {
        try {
          const stored = localStorage.getItem(key);
          if (stored) {
            const prog = JSON.parse(stored);
            let changed = false;
            levelNames.forEach(lvl => {
              if (prog[lvl] && typeof questions !== 'undefined' && questions[lvl]) {
                const realTotal = questions[lvl].length;
                if (prog[lvl].total !== realTotal) {
                  prog[lvl].total = realTotal;
                  changed = true;
                }
              }
            });
            if (changed) {
              localStorage.setItem(key, JSON.stringify(prog));
              console.log('Synced progress totals for: ' + key);
            }
          }
        } catch(e) { console.warn('Sync error for ' + key, e); }
      });
      // === END FIX ===
}
    
    // Check if there's partial quiz progress to resume
    function checkPartialQuizProgress() {
      const partial = localStorage.getItem('tecnico_quiz_partial');
      if (partial) {
        try {
          const data = JSON.parse(partial);
          // If partial progress is less than 24 hours old, offer to resume
          if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
            window.partialQuizData = data;
          } else {
            clearPartialProgress();
          }
        } catch(e) {
          clearPartialProgress();
        }
      }
    }

    function saveProgress() {
      localStorage.setItem('tecnico_progress', JSON.stringify(progress));
      localStorage.setItem('tecnico_progress_backup', JSON.stringify(progress));
      // Save per-user progress
      const email = localStorage.getItem('tecnico_email');
      if (email) {
        localStorage.setItem('maestroac_progress_' + email, JSON.stringify(progress));
      }
      // Sync to Supabase
      supabaseSaveProgress(progress);
    }

    // ========== ACTIVITY LOGGING ==========
    function logActivity(type, detail) {
      const email = localStorage.getItem('tecnico_email');
      if (!email) return;
      const key = 'maestroac_activity_' + email;
      const log = JSON.parse(localStorage.getItem(key) || '[]');
      log.push({
        type: type,
        detail: detail || '',
        timestamp: new Date().toISOString()
      });
      // Keep last 500 entries
      if (log.length > 500) log.splice(0, log.length - 500);
      localStorage.setItem(key, JSON.stringify(log));
    }

    function getActivityLog(email) {
      const key = 'maestroac_activity_' + (email || localStorage.getItem('tecnico_email'));
      return JSON.parse(localStorage.getItem(key) || '[]');
    }

    function getActivityStats(email) {
      const log = getActivityLog(email);
      if (log.length === 0) return { totalMinutes: 0, totalSessions: 0, quizzes: 0, questionsAnswered: 0, lastActive: null };

      let sessions = 0;
      let quizzes = 0;
      let questionsAnswered = 0;
      let totalMinutes = 0;
      let lastActive = null;

      // Calculate sessions (group activity within 30 min gaps)
      let lastTime = null;
      log.forEach(entry => {
        const t = new Date(entry.timestamp).getTime();
        if (!lastTime || t - lastTime > 30 * 60 * 1000) {
          sessions++;
        }
        lastTime = t;
        if (entry.type === 'quiz_start') quizzes++;
        if (entry.type === 'answer') questionsAnswered++;
      });

      // Estimate total time: sum gaps between consecutive actions (max 5 min per gap)
      for (let i = 1; i < log.length; i++) {
        const gap = (new Date(log[i].timestamp).getTime() - new Date(log[i-1].timestamp).getTime()) / 60000;
        totalMinutes += Math.min(gap, 5);
      }
      totalMinutes = Math.round(totalMinutes);

      if (log.length > 0) {
        lastActive = log[log.length - 1].timestamp;
      }

      return { totalMinutes, totalSessions: sessions, quizzes, questionsAnswered, lastActive };
    }

    function saveCertificates() {
      localStorage.setItem('tecnico_certificates', JSON.stringify(certificates));
      // Backup to second key - NEVER lose certificates!
      localStorage.setItem('tecnico_certificates_backup', JSON.stringify(certificates));
      // Sync certificates to Supabase
      certificates.forEach(cert => supabaseSaveCertificate(cert));
    }
    
    // Save partial quiz progress after each answer
    function saveQuizProgressPartial() {
      const partialProgress = {
        level: currentLevel,
        questionIndex: currentQuestionIndex,
        correctAnswers: correctAnswers,
        totalQuestions: currentQuestions.length,
        timestamp: Date.now()
      };
      localStorage.setItem('tecnico_quiz_partial', JSON.stringify(partialProgress));
    }
    
    // Clear partial progress when quiz ends
    function clearPartialProgress() {
      localStorage.removeItem('tecnico_quiz_partial');
    }

    // Save lastActivity to localStorage
    function saveLastActivity() {
      if (lastActivity) {
        localStorage.setItem('tecnico_lastActivity', JSON.stringify(lastActivity));
      }
    }

    // Load lastActivity from localStorage
    function loadLastActivity() {
      const saved = localStorage.getItem('tecnico_lastActivity');
      if (saved) {
        lastActivity = JSON.parse(saved);
      }
    }

    // Update lastActivity with new activity data
    // type: "lesson" | "quiz"
    // moduleId: level identifier (e.g., "principiante")
    // lessonId: category name for study sections (nullable)
    // quizId: quiz identifier (nullable, same as moduleId for quizzes)
    // routePath: current screen/path
    function updateLastActivity(type, moduleId, lessonId, quizId, routePath) {
      lastActivity = {
        type: type,
        moduleId: moduleId,
        lessonId: lessonId || null,
        quizId: quizId || null,
        routePath: routePath,
        updatedAt: new Date().toISOString()
      };
      saveLastActivity();
    }

    // Save lastQuizState to localStorage
    function saveLastQuizState() {
      if (lastQuizState) {
        localStorage.setItem('tecnico_lastQuizState', JSON.stringify(lastQuizState));
      }
    }

    // Load lastQuizState from localStorage
    function loadLastQuizState() {
      const saved = localStorage.getItem('tecnico_lastQuizState');
      if (saved) {
        lastQuizState = JSON.parse(saved);
      }
      return lastQuizState;
    }

    // Clear lastQuizState (called when quiz is completed)
    function clearLastQuizState() {
      lastQuizState = null;
      localStorage.removeItem('tecnico_lastQuizState');
    }

    // Update lastQuizState with current quiz progress
    // Called when: question view loads, user clicks "Siguiente", user answers a question
    function updateLastQuizState() {
      if (!currentLevel || !currentQuestions || currentQuestions.length === 0) {
        return;
      }

      const currentQuestion = currentQuestions[currentQuestionIndex];
      const levelName = levels.find(l => l.id === currentLevel)?.name || currentLevel;

      // Store question IDs to restore exact order on resume
      const shuffledQuestionIds = currentQuestions.map((q, idx) => {
        // Create a unique identifier for each question based on its content
        return q.q.substring(0, 50);
      });

      lastQuizState = {
        levelId: levelName,
        levelKey: currentLevel,
        category: currentQuestion ? currentQuestion.category : null,
        questionIndex: currentQuestionIndex,
        totalQuestions: currentQuestions.length,
        routePath: 'quizScreen',
        correctAnswers: correctAnswers,
        shuffledQuestionIds: shuffledQuestionIds,
        startTime: startTime,
        updatedAt: new Date().toISOString()
      };

      saveLastQuizState();
    }

    // Resume quiz from lastQuizState
    // Returns true if resume was successful, false otherwise
    async function resumeQuizFromState() {
      await loadQuestions();
      const state = loadLastQuizState();
      if (!state || !state.levelKey || !questions[state.levelKey]) {
        return false;
      }

      // Restore the quiz state
      currentLevel = state.levelKey;

      // Restore the exact question order using shuffledQuestionIds
      const levelQuestions = questions[state.levelKey];
      if (state.shuffledQuestionIds && state.shuffledQuestionIds.length > 0) {
        // Reconstruct the shuffled array order
        currentQuestions = state.shuffledQuestionIds.map(qId => {
          return levelQuestions.find(q => q.q.substring(0, 50) === qId);
        }).filter(q => q !== undefined);

        // If reconstruction failed, fall back to fresh shuffle
        if (currentQuestions.length !== state.totalQuestions) {
          currentQuestions = shuffleArray([...levelQuestions]);
        }
      } else {
        currentQuestions = shuffleArray([...levelQuestions]);
      }

      currentQuestionIndex = state.questionIndex || 0;
      correctAnswers = state.correctAnswers || 0;
      startTime = state.startTime || Date.now();

      // Ensure question index is valid
      if (currentQuestionIndex >= currentQuestions.length) {
        currentQuestionIndex = 0;
        correctAnswers = 0;
        startTime = Date.now();
      }

      return true;
    }

    // Check if there's a resumable quiz state
    function hasResumableQuizState() {
      const state = loadLastQuizState();
      return state !== null && state.levelKey && questionsLoaded && questions[state.levelKey];
    }

    function renderLevels() {
      const container = document.getElementById('levelsList');
      container.innerHTML = '';

      // Load unlocked levels
      loadUnlockedLevels();

      levels.forEach(level => {
        const p = progress[level.id];
        const percentage = p.completed > 0 ? Math.round((p.score / p.completed) * 100) : 0;
        const completedPct = Math.round((p.completed / p.total) * 100);
        const locked = isLevelLocked(level.id);

        const card = document.createElement('div');
        card.className = 'level-card' + (locked ? ' locked' : '');

        if (locked) {
          const purchased = hasAppAccess();
          if (!purchased && level.id !== 'principiante') {
            // Not purchased - show buy prompt
            card.innerHTML = `
              <div class="level-info">
                <h3>${level.name}</h3>
                <div class="progress-bar"><div class="progress-fill" style="width:0%; background:${level.color}"></div></div>
                <div class="progress-text">üîí Desbloquea la App Completa</div>
              </div>
              <div class="level-icon">${level.icon}</div>
              <div class="level-locked-overlay">
                <span class="level-locked-icon">üîê</span>
              </div>
            `;
            card.onclick = () => showPurchaseModal();
          } else {
            // Purchased but needs to complete previous level
            const levelOrder = ['principiante', 'intermedio', 'avanzado', 'elite', 'platino'];
            const prevIdx = levelOrder.indexOf(level.id) - 1;
            const prevName = prevIdx >= 0 ? levels[prevIdx].name : '';
            const prevProgress = prevIdx >= 0 ? progress[levelOrder[prevIdx]] : null;
            const prevCompleted = prevProgress ? prevProgress.completed : 0;
            const prevTotal = prevProgress ? prevProgress.total : 0;

            card.innerHTML = `
              <div class="level-info">
                <h3>${level.name}</h3>
                <div class="progress-bar"><div class="progress-fill" style="width:0%; background:${level.color}"></div></div>
                <div class="progress-text">üîí Completa ${prevName} (${prevCompleted}/${prevTotal} con 100%)</div>
              </div>
              <div class="level-icon">${level.icon}</div>
              <div class="level-locked-overlay">
                <span class="level-locked-icon">üîê</span>
              </div>
            `;
            card.onclick = () => alert('Necesitas completar las ' + prevTotal + ' preguntas de ' + prevName + ' con 100% de aciertos para desbloquear ' + level.name + '. Llevas ' + prevCompleted + '/' + prevTotal + '.');
          }
        } else {
          card.innerHTML = `
            <div class="level-info">
              <h3>${level.name}</h3>
              <div class="progress-bar"><div class="progress-fill" style="width:${completedPct}%; background:${level.color}"></div></div>
              <div class="progress-text">${p.completed}/${p.total} completadas ‚Ä¢ ${percentage}% aciertos</div>
            </div>
            <div class="level-icon">${level.icon}</div>
          `;
          card.onclick = () => startQuiz(level.id);
        }
        container.appendChild(card);
      });
    }

    function startQuiz(levelId) {
      // Check if user is on mandatory break
      if (isOnBreak) {
        showBreakScreen();
        return;
      }
      
      // Start study session timer
      if (!startStudySession()) {
        return; // User is on break
      }
      
      // Force check-in before starting any quiz
      if (!sessionCheckedIn) {
        requireCheckIn('quiz');
        return;
      }
      // Check if there's a resumable quiz state for this level
      const savedState = loadLastQuizState();
      if (savedState && savedState.levelKey === levelId && savedState.questionIndex > 0) {
        // Offer to resume or start fresh
        showResumePrompt(levelId, savedState);
        return;
      }

      // Start fresh quiz
      startFreshQuiz(levelId);
    }

    // Show resume prompt modal
    function showResumePrompt(levelId, savedState) {
      const levelName = levels.find(l => l.id === levelId)?.name || levelId;
      const progressText = `${savedState.questionIndex + 1}/${savedState.totalQuestions}`;

      if (confirm(`Tienes un quiz en progreso en el nivel ${levelName} (${progressText}).\n\n¬øDeseas continuar donde lo dejaste?\n\nPresiona "Aceptar" para continuar o "Cancelar" para empezar de nuevo.`)) {
        // Resume from saved state
        resumeQuiz();
      } else {
        // Start fresh
        clearLastQuizState();
        startFreshQuiz(levelId);
      }
    }

    // Start a fresh quiz (no resume)
    async function startFreshQuiz(levelId) {
      await loadQuestions();
      currentLevel = levelId;
      let quizPool = [...questions[levelId]];
      // Limit to 50 questions for ALL free users (probadita)
      if (!hasAppAccess()) {
        quizPool = quizPool.slice(0, 50);
      }
      currentQuestions = shuffleArray(quizPool);
      currentQuestionIndex = 0;
      correctAnswers = 0;
      questionStatus = {}; // Reset estado de preguntas
      startTime = Date.now();
      // Track quiz opened as lastActivity
      updateLastActivity('quiz', levelId, null, levelId, 'quizScreen');
      logActivity('quiz_start', levelId);
      var _lvlName = levels.find(function(l) { return l.id === levelId; });
      addNotification('quiz', 'üìù Quiz iniciado ‚Äî Nivel ' + (_lvlName ? _lvlName.name : levelId) + ' (' + currentQuestions.length + ' preguntas)', 'üìù');
      showScreen('quizScreen');
      showQuestion();
    }

    // Resume quiz from saved state
    function resumeQuiz() {
      if (resumeQuizFromState()) {
        // Track quiz resumed as lastActivity
        updateLastActivity('quiz', currentLevel, null, currentLevel, 'quizScreen');
        showScreen('quizScreen');
        showQuestion();
      } else {
        // If resume fails, fallback to level selection
        alert('No se pudo restaurar el progreso. Por favor, selecciona un nivel.');
        showScreen('levelsScreen');
      }
    }

    // ========== CERTIFICATION COURSES ==========
    const certCourses = {
      epa608: {
        icon: 'üåç', name: 'EPA 608 Certification',
        desc: 'Paquete completo: 700 preguntas de preparaci√≥n, examen oficial, y honorarios del proctor (4 hrs m√°x). Si no aprueba, paga el costo total nuevamente.',
        price: '$599', examPrice: '$599 USD',
        sections: ['Core', 'Tipo I - Small', 'Tipo II - High Pressure', 'Tipo III - Low Pressure', 'Recuperaci√≥n', 'Regulaciones', 'Refrigerantes', 'Seguridad']
      },
      osha: {
        icon: '‚õëÔ∏è', name: 'OSHA 30 Hours Safety',
        desc: 'Certificaci√≥n OSHA 30 Horas. Incluye 700 preguntas de preparaci√≥n y acceso al sitio web oficial para completar el curso y examen a tu propio ritmo.',
        price: '$599', examPrice: '$599 USD',
        sections: ['PPE', 'Riesgo El√©ctrico', 'Ca√≠das', 'Espacios Confinados', 'Escaleras', 'LOTO', 'Comunicaci√≥n de Riesgos', 'Primeros Auxilios']
      },
      a2l: {
        icon: 'üßä', name: 'A2L Refrigerants Safety',
        desc: 'Paquete completo: 700 preguntas de preparaci√≥n, examen oficial, y honorarios del proctor (4 hrs m√°x). Cubre R-32, R-454B, detecci√≥n de fugas y regulaciones.',
        price: '$299', examPrice: '$299 USD',
        sections: ['Clasificaci√≥n A2L', 'R-32', 'R-454B', 'Detecci√≥n de Fugas', 'Ventilaci√≥n', 'L√≠mites de Carga', 'Herramientas Seguras', 'Regulaciones']
      },
      calefaccion: {
        icon: 'üî•', name: 'Heating Technician',
        desc: 'Paquete completo: 700 preguntas de preparaci√≥n, examen oficial, y honorarios del proctor (4 hrs m√°x). Cubre gas, furnaces, combusti√≥n y controles de seguridad.',
        price: '$599', examPrice: '$599 USD',
        sections: ['Gas Natural/LP', 'Furnace 80%', 'Furnace 90%+', 'Combusti√≥n', 'Intercambiador', 'Controles de Seguridad', 'Ignici√≥n', 'Ventilaci√≥n']
      },
      hvaccore: {
        icon: '‚ùÑÔ∏è', name: 'HVAC Certification',
        desc: 'Paquete completo: 700 preguntas de preparaci√≥n, examen oficial, y honorarios del proctor (4 hrs m√°x). Cubre AC, heat pumps, refrigeraci√≥n y diagn√≥stico.',
        price: '$599', examPrice: '$599 USD',
        sections: ['Ciclo de Refrigeraci√≥n', 'Compresores', 'Condensadores', 'Evaporadores', 'V√°lvulas TXV', 'Heat Pumps', 'Superheat/Subcooling', 'Diagn√≥stico']
      },
      hvacr: {
        icon: 'üèÜ', name: 'HVAC Excellence',
        desc: 'Paquete completo: 700 preguntas de preparaci√≥n, examen oficial, y honorarios del proctor (4 hrs m√°x). Instalaci√≥n y servicio de sistemas HVACR.',
        price: '$599', examPrice: '$599 USD',
        sections: ['Refrigeraci√≥n Comercial', 'Walk-in Coolers', 'Reach-in', 'Rack Systems', 'Controles Avanzados', 'Defrost Systems', 'Oil Management', 'Troubleshooting']
      }
    };

    let currentCertCourse = null;

    function openCertCourse(courseId) {
      const course = certCourses[courseId];
      if (!course) return;
      currentCertCourse = courseId;
      
      document.getElementById('certCourseIcon').textContent = course.icon;
      document.getElementById('certCourseName').textContent = course.name;
      document.getElementById('certCourseTitle').textContent = course.name;
      document.getElementById('certCourseDesc').textContent = course.desc;
      document.getElementById('certExamPrice').textContent = course.examPrice;
      
      const sectionsDiv = document.getElementById('certStudySections');
      sectionsDiv.innerHTML = course.sections.map((s, i) => 
        `<div style="background:rgba(46,204,113,0.15); border:1px solid rgba(46,204,113,0.3); border-radius:8px; padding:8px; font-size:12px; color:#64748b;">
          <span style="color:#2ecc71; font-weight:bold;">${i+1}.</span> ${s}
        </div>`
      ).join('');
      
      showScreen('certCourseScreen');
    }

    function startCertStudy() {
      alert('üìö Las 700 preguntas de estudio para ' + certCourses[currentCertCourse].name + ' estar√°n disponibles pr√≥ximamente.\n\nPor ahora puedes practicar con las preguntas del nivel Principiante que cubren temas relacionados.');
      showScreen('levelsScreen');
    }

    function requestCertExam() {
      const course = certCourses[currentCertCourse];
      const userName = currentUser ? currentUser.nombre : 'Estudiante';
      const userEmail = currentUser ? currentUser.email : '';

      // === VALIDATION 1: Must have membership ===
      var membershipType = localStorage.getItem('maestroac_membership_type_' + userEmail) || '';
      var membershipDate = localStorage.getItem('maestroac_membership_date_' + userEmail) || '';
      var hasAppPurchase = localStorage.getItem('maestroac_app_purchased_' + userEmail) === 'true';

      // Also check Stripe membership from Supabase
      if (!membershipType && currentMembership && currentMembership.activa) {
        membershipType = currentMembership.tipo; // bronze, silver, gold
        membershipDate = currentMembership.fecha_inicio || '';
      }

      if (!membershipType && !hasAppPurchase) {
        alert('‚ö†Ô∏è Para solicitar un examen de certificaci√≥n, debes estar inscrito en una membres√≠a activa.\n\nMembresias disponibles:\n‚Ä¢ B√°sica ($119/mes) ‚Äî Examen disponible despu√©s de 1 a√±o\n‚Ä¢ Profesional ($299/mes) ‚Äî Examen disponible despu√©s de 6 meses\n‚Ä¢ Premium ($699/mes) ‚Äî Examen disponible despu√©s de 6 meses\n\nVe a la secci√≥n de membres√≠as para inscribirte.');
        return;
      }

      // === VALIDATION 2: Minimum membership time ===
      if (membershipDate) {
        var startDate = new Date(membershipDate);
        var now = new Date();
        var monthsActive = (now.getFullYear() - startDate.getFullYear()) * 12 + (now.getMonth() - startDate.getMonth());
        
        var requiredMonths = 6;
        if (membershipType === 'basica' || membershipType === '119') {
          requiredMonths = 12;
        }

        if (monthsActive < requiredMonths) {
          var remaining = requiredMonths - monthsActive;
          alert('‚ö†Ô∏è Tu membres√≠a ' + (requiredMonths === 12 ? 'B√°sica ($119)' : 'actual') + ' requiere ' + requiredMonths + ' meses de antig√ºedad para solicitar examen.\n\nTiempo activo: ' + monthsActive + ' meses\nFaltan: ' + remaining + ' meses\n\nSigue estudiando y prepar√°ndote. ¬°T√∫ puedes!');
          return;
        }
      }

      // === VALIDATION 3: 100% score on ALL levels ===
      var levelOrder = ['principiante', 'intermedio', 'avanzado', 'elite', 'platino'];
      var allPassed = true;
      var failedLevels = [];
      levelOrder.forEach(function(lvl) {
        var lvlProgress = progress[lvl];
        if (!lvlProgress || lvlProgress.completed === 0) {
          allPassed = false;
          failedLevels.push(lvl.charAt(0).toUpperCase() + lvl.slice(1) + ' (no completado)');
        } else {
          var pct = Math.round((lvlProgress.score / lvlProgress.completed) * 100);
          if (pct < 100) {
            allPassed = false;
            failedLevels.push(lvl.charAt(0).toUpperCase() + lvl.slice(1) + ' (' + pct + '%)');
          }
        }
      });

      if (!allPassed) {
        alert('‚ö†Ô∏è Para solicitar el examen necesitas 100% de aprobaci√≥n en TODOS los niveles.\n\nNiveles pendientes:\n‚Ä¢ ' + failedLevels.join('\n‚Ä¢ ') + '\n\nCompleta todos los niveles con 100% antes de solicitar tu examen.');
        return;
      }

      // === CAPTURE USER INFO ===
      var regDate = currentUser.registrationDate || currentUser.studentIdDate || 'No disponible';
      var regDateFormatted = regDate !== 'No disponible' ? new Date(regDate).toLocaleDateString('es-MX', {year:'numeric',month:'long',day:'numeric'}) : regDate;
      var techNumber = currentUser.technicianNumber || 'No asignado';
      var studentId = currentUser.studentId || 'No asignado';
      var progressSummary = levelOrder.map(function(lvl) {
        var p = progress[lvl];
        return lvl.charAt(0).toUpperCase() + lvl.slice(1) + ': ' + (p ? Math.round((p.score/p.completed)*100) + '%' : '0%');
      }).join(' | ');

      var subject = encodeURIComponent('Solicitud de Examen: ' + course.name);
      var body = encodeURIComponent(
        'SOLICITUD DE EXAMEN DE CERTIFICACI√ìN\n' +
        '=====================================\n\n' +
        'üë§ Nombre: ' + userName + '\n' +
        'üìß Email: ' + userEmail + '\n' +
        'üìû Tel√©fono: ' + (currentUser.telefono || 'No registrado') + '\n' +
        'üèôÔ∏è Ciudad: ' + (currentUser.ciudad || 'No registrada') + '\n' +
        'üî¢ No. T√©cnico: ' + techNumber + '\n' +
        'ü™™ ID Estudiante: ' + studentId + '\n' +
        'üìÖ Fecha de Registro en App: ' + regDateFormatted + '\n' +
        'üìä Resultados: ' + progressSummary + '\n' +
        'üíº Membres√≠a: ' + (membershipType || 'App Completa') + '\n\n' +
        'üìú Examen Solicitado: ' + course.name + '\n' +
        'üí∞ Precio: ' + course.examPrice + '\n\n' +
        'Confirmo que he le√≠do y acepto los t√©rminos y condiciones del examen.\n\nGracias.'
      );
      var whatsappMsg = encodeURIComponent(
        'SOLICITUD DE EXAMEN\n' +
        'Nombre: ' + userName + '\n' +
        'Email: ' + userEmail + '\n' +
        'Tel√©fono: ' + (currentUser.telefono || 'N/A') + '\n' +
        'No. T√©cnico: ' + techNumber + '\n' +
        'Examen: *' + course.name + '* (' + course.examPrice + ')\n' +
        'Resultados: ' + progressSummary + '\n' +
        'Acepto t√©rminos y condiciones.'
      );

      // Stripe payment links per course
      var stripeLinks = {
        epa608: 'https://buy.stripe.com/00w8wPd6f6taff92rZ3sI0f',
        osha: 'https://buy.stripe.com/6oU7sL0jt4l2ff97Mj3sI09',
        a2l: 'https://buy.stripe.com/9B63cveajdVCd71giP3sI08',
        calefaccion: 'https://buy.stripe.com/aFadR9gircRygjd8Qn3sI0c',
        hvaccore: 'https://buy.stripe.com/5kQ8wP3vF18Qeb5aYv3sI0a',
        hvacr: 'https://buy.stripe.com/4gMbJ18PZ9Fmgjd9Ur3sI0b'
      };
      var payLink = stripeLinks[currentCertCourse] || '';

      var modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
      modal.innerHTML = `
        <div style="background:linear-gradient(135deg,#1a5276,#154360);border-radius:20px;padding:25px;max-width:420px;width:100%;text-align:center;border:2px solid #f39c12;max-height:90vh;overflow-y:auto;">
          <div style="font-size:50px;margin-bottom:10px;">üéì</div>
          <h3 style="color:#f39c12;margin-bottom:8px;">Solicitar Examen de Certificaci√≥n</h3>
          <p style="color:white;font-size:15px;margin-bottom:5px;">${course.name}</p>
          <p style="color:#f39c12;font-size:24px;font-weight:bold;margin-bottom:15px;">${course.examPrice}</p>

          <!-- DISCLAIMER -->
          <div style="background:rgba(231,76,60,0.15);border:2px solid rgba(231,76,60,0.5);border-radius:12px;padding:15px;margin-bottom:15px;text-align:left;">
            <p style="color:#e74c3c;font-size:14px;font-weight:bold;margin-bottom:8px;">‚ö†Ô∏è T√âRMINOS Y CONDICIONES DEL EXAMEN</p>
            <p style="color:#e2e8f0;font-size:12px;line-height:1.6;margin-bottom:8px;">
              Al solicitar este examen, confirmo que:
            </p>
            <ul style="color:#e2e8f0;font-size:12px;line-height:1.7;margin:0;padding-left:18px;">
              <li>He estudiado y completado todos los niveles de la plataforma con un <strong style="color:#2ecc71;">score de 100%</strong> en cada nivel.</li>
              <li>Si <strong style="color:#e74c3c;">repruebo</strong> el examen, deber√© volver a tomarlo y pagar el <strong>monto total</strong> que cubre los honorarios del Proctor y el costo del examen.</li>
              <li>Una vez <strong style="color:#2ecc71;">aprobado</strong> el examen, mi certificaci√≥n llegar√° en <strong>30 d√≠as h√°biles</strong> a mi domicilio o residencia registrada.</li>
              <li>Cuento con una membres√≠a activa con la antig√ºedad m√≠nima requerida (B√°sica $119: 1 a√±o / Profesional $299 o Premium $699: 6 meses).</li>
            </ul>
          </div>

          <!-- User Info Summary -->
          <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:12px;padding:12px;margin-bottom:15px;text-align:left;">
            <p style="color:#3498db;font-size:13px;font-weight:bold;margin-bottom:8px;">üìã Tu Informaci√≥n</p>
            <p style="color:#e2e8f0;font-size:12px;line-height:1.8;margin:0;">
              üë§ <strong>${userName}</strong><br>
              üìß ${userEmail}<br>
              üìû ${currentUser.telefono || 'No registrado'}<br>
              üî¢ ${techNumber}<br>
              üìÖ Inicio: ${regDateFormatted}<br>
              üìä ${progressSummary}
            </p>
          </div>
          
          <div style="background:rgba(46,204,113,0.15);border:1px solid rgba(46,204,113,0.4);border-radius:12px;padding:12px;margin-bottom:15px;">
            <p style="color:#2ecc71;font-size:13px;font-weight:bold;margin-bottom:8px;">üí≥ PASO 1: Pagar el Examen</p>
            <button onclick="window.open('${payLink}','_blank');" style="width:100%;padding:14px;border:none;border-radius:12px;font-size:15px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#2ecc71,#27ae60);color:white;">üí≥ Pagar ${course.examPrice} con Tarjeta</button>
          </div>

          <div style="background:rgba(243,156,18,0.15);border:1px solid rgba(243,156,18,0.4);border-radius:12px;padding:12px;margin-bottom:15px;">
            <p style="color:#f39c12;font-size:13px;font-weight:bold;margin-bottom:8px;">üìã PASO 2: Confirmar y Programar</p>
            <button onclick="window.open('https://wa.me/19096390448?text=${whatsappMsg}','_blank');" style="width:100%;padding:12px;border:none;border-radius:12px;font-size:14px;font-weight:bold;cursor:pointer;margin-bottom:8px;background:linear-gradient(135deg,#25D366,#128C7E);color:white;">üì± Confirmar por WhatsApp</button>
            <button onclick="openEmailComposer('Techschoolacvolt@gmail.com',decodeURIComponent('${subject}'),decodeURIComponent('${body}'),'üìß Confirmar Examen');" style="width:100%;padding:12px;border:none;border-radius:12px;font-size:14px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#3498db,#2980b9);color:white;">üìß Confirmar por Correo</button>
          </div>

          <p style="color:#64748b;font-size:11px;margin-bottom:15px;">Una vez confirmado tu pago, te contactaremos para programar tu examen.</p>
          <button onclick="this.closest('div').parentElement.remove();" style="width:100%;padding:12px;border:none;border-radius:12px;font-size:14px;cursor:pointer;background:rgba(255,255,255,0.15);color:#94a3b8;">Cancelar</button>
        </div>
      `;
      document.body.appendChild(modal);
      // Log exam request to Supabase
      logExamRequest(course.name, course.examPrice, userName, userEmail, techNumber, studentId, progressSummary);
    }

    function startQuickQuiz() {
      // Check if there's a resumable quiz state for principiante
      const savedState = loadLastQuizState();
      if (savedState && savedState.levelKey === 'principiante' && savedState.questionIndex > 0) {
        showResumePrompt('principiante', savedState);
        return;
      }

      currentLevel = 'principiante';
      currentQuestions = shuffleArray([...questions.principiante]);
      currentQuestionIndex = 0;
      correctAnswers = 0;
      startTime = Date.now();
      // Track quiz opened as lastActivity
      updateLastActivity('quiz', 'principiante', null, 'principiante', 'quizScreen');
      showScreen('quizScreen');
      showQuestion();
    }

    function showQuestion() {
      const q = currentQuestions[currentQuestionIndex];
      document.getElementById('questionCount').textContent = `${currentQuestionIndex + 1}/${currentQuestions.length}`;
      document.getElementById('questionCategory').textContent = q.category;
      document.getElementById('questionText').textContent = q.q;

      // Update study time indicator
      updateStudyTimeIndicator();
      
      // Actualizar contadores de estado
      updateQuizStatusCounters();

      const container = document.getElementById('optionsContainer');
      container.innerHTML = '';
      const letters = ['A', 'B', 'C', 'D'];

      // Shuffle options: create array of indices, shuffle them
      const indices = [0, 1, 2, 3];
      for (let i = indices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [indices[i], indices[j]] = [indices[j], indices[i]];
      }
      // Store shuffled mapping so selectAnswer knows which is correct
      q._shuffledIndices = indices;

      indices.forEach((origIdx, displayIdx) => {
        const div = document.createElement('div');
        div.className = 'option';
        div.innerHTML = `<div class="option-letter">${letters[displayIdx]}</div><span>${q.options[origIdx]}</span>`;
        div.onclick = () => selectAnswer(displayIdx);
        container.appendChild(div);
      });

      document.getElementById('feedback').classList.remove('show', 'correct', 'incorrect');
      
      // Mostrar botones de navegaci√≥n siempre
      document.getElementById('nextBtn').style.display = 'block';
      // Anterior solo si no es la primera pregunta
      document.getElementById('prevBtn').style.display = currentQuestionIndex > 0 ? 'block' : 'none';

      // Update lastQuizState when question view loads
      updateLastQuizState();
    }

    function updateStudyTimeIndicator() {
      // Create indicator if not exists
      var indicator = document.getElementById('studyTimeIndicator');
      if (!indicator) {
        var header = document.querySelector('.question-header');
        if (header) {
          indicator = document.createElement('div');
          indicator.id = 'studyTimeIndicator';
          indicator.style.cssText = 'font-size:11px;padding:4px 10px;border-radius:12px;background:rgba(39,174,96,0.2);color:#27ae60;';
          header.appendChild(indicator);
        }
      }
      
      if (indicator && studyStartTime) {
        var now = new Date();
        var minutesStudied = Math.floor((now - studyStartTime) / 60000);
        var remaining = STUDY_LIMIT_MINUTES - minutesStudied;
        
        if (remaining > 10) {
          indicator.textContent = '‚è±Ô∏è ' + remaining + ' min';
          indicator.style.background = 'rgba(39,174,96,0.2)';
          indicator.style.color = '#27ae60';
        } else if (remaining > 0) {
          indicator.textContent = '‚ö†Ô∏è ' + remaining + ' min';
          indicator.style.background = 'rgba(231,76,60,0.2)';
          indicator.style.color = '#e74c3c';
        } else {
          indicator.textContent = 'üõë Break';
          indicator.style.background = 'rgba(231,76,60,0.3)';
          indicator.style.color = '#e74c3c';
        }
      }
    }

    function selectAnswer(displayIndex) {
      const q = currentQuestions[currentQuestionIndex];
      const options = document.querySelectorAll('.option');
      const originalIndex = q._shuffledIndices[displayIndex];
      const correctDisplayIndex = q._shuffledIndices.indexOf(q.correct);

      // Marcar pregunta como contestada y actualizar contadores
      questionStatus[currentQuestionIndex] = 'answered';
      updateQuizStatusCounters();

      options.forEach((opt, i) => {
        opt.classList.add('disabled');
        opt.onclick = null;
        if (i === correctDisplayIndex) opt.classList.add('correct');
        else if (i === displayIndex && originalIndex !== q.correct) opt.classList.add('incorrect');
      });

      const feedback = document.getElementById('feedback');
      if (originalIndex === q.correct) {
        correctAnswers++;
        feedback.classList.add('correct');
        document.getElementById('feedbackTitle').textContent = '‚úì ¬°Correcto!';
      } else {
        feedback.classList.add('incorrect');
        document.getElementById('feedbackTitle').textContent = '‚úó Incorrecto';
      }
      document.getElementById('feedbackText').textContent = q.explanation;
      feedback.classList.add('show');
      document.getElementById('nextBtn').style.display = 'block';
      // Track quiz question answered as lastActivity
      updateLastActivity('quiz', currentLevel, null, currentLevel, 'quizScreen');
      logActivity('answer', currentLevel + ' - ' + (originalIndex === q.correct ? 'correct' : 'incorrect'));
      // Update lastQuizState when user answers a question
      updateLastQuizState();
      
      // SAVE PROGRESS AFTER EACH ANSWER - Never lose progress!
      saveQuizProgressPartial();
    }

    function nextQuestion() {
      // Si no contest√≥, marcar como flagged
      if (!questionStatus[currentQuestionIndex] || questionStatus[currentQuestionIndex] === 'unanswered') {
        questionStatus[currentQuestionIndex] = 'flagged';
      }
      
      currentQuestionIndex++;
      if (currentQuestionIndex >= currentQuestions.length) {
        endQuiz();
      } else {
        // Update lastQuizState when user clicks "Siguiente"
        updateLastQuizState();
        showQuestion();
      }
    }
    
    function prevQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        updateLastQuizState();
        showQuestion();
      }
    }
    
    function updateQuizStatusCounters() {
      let answered = 0;
      let flagged = 0;
      
      for (let key in questionStatus) {
        if (questionStatus[key] === 'answered') {
          answered++;
        } else if (questionStatus[key] === 'flagged') {
          flagged++;
        }
      }
      
      document.getElementById('answeredCount').textContent = answered;
      document.getElementById('flaggedCount').textContent = flagged;
    }

    function endQuiz() {
      const total = currentQuestions.length;
      const percentage = Math.round((correctAnswers / total) * 100);
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;

      // Update progress
      progress[currentLevel].completed = total;
      progress[currentLevel].score = correctAnswers;
      saveProgress();
      renderLevels();

      // Generate certificate if passed (80% or higher)
      if (percentage >= 80) {
        generateCertificate(currentLevel, percentage);
      }

      // Show results
      let icon, title, subtitle;
      if (percentage >= 90) { icon = 'üèÜ'; title = '¬°Excelente!'; subtitle = 'Dominas este nivel'; }
      else if (percentage >= 80) { icon = '‚≠ê'; title = '¬°Muy Bien!'; subtitle = 'Aprobaste el quiz ‚Äî ¬°Certificado obtenido!'; }
      else if (percentage >= 60) { icon = 'üìö'; title = 'Sigue Practicando'; subtitle = 'Necesitas 80% para certificarte'; }
      else { icon = 'üí™'; title = 'No Te Rindas'; subtitle = 'Repasa el material'; }

      document.getElementById('resultsIcon').textContent = icon;
      document.getElementById('resultsTitle').textContent = title;
      document.getElementById('resultsSubtitle').textContent = subtitle;
      document.getElementById('scoreValue').textContent = percentage + '%';
      document.getElementById('correctCount').textContent = correctAnswers;
      document.getElementById('incorrectCount').textContent = total - correctAnswers;
      document.getElementById('timeSpent').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

      // Animate circle
      const circle = document.getElementById('scoreCircle');
      const offset = 490 - (percentage / 100) * 490;
      circle.style.stroke = percentage >= 70 ? '#27ae60' : percentage >= 50 ? '#f39c12' : '#e74c3c';
      setTimeout(() => circle.style.strokeDashoffset = offset, 100);

      // Clear lastQuizState since quiz is completed
      clearLastQuizState();
      
      // Clear partial progress since quiz is completed
      clearPartialProgress();

      // Save quiz attempt to Supabase
      supabaseSaveQuizAttempt({
        nivel: currentLevel,
        totalQuestions: total,
        correctAnswers: correctAnswers,
        wrongAnswers: total - correctAnswers,
        porcentaje: percentage,
        tiempoSegundos: elapsed,
        aprobado: percentage >= 80
      });

      // Update user nivel in Supabase
      const nivelOrder = ['nuevo', 'principiante', 'intermedio', 'avanzado', 'elite', 'platino'];
      const currentIdx = nivelOrder.indexOf(currentLevel);
      if (percentage >= 80 && currentIdx > 0) {
        supabaseUpdateNivel(currentLevel);
      }

      showScreen('resultsScreen');
    }

    function generateCertificate(levelId, score) {
      const level = levels.find(l => l.id === levelId);
      const now = new Date();
      const dateStr = now.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
      const certId = `CERT-${levelId.toUpperCase().substring(0,3)}-${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}-${Math.random().toString(36).substring(2,6).toUpperCase()}`;

      // Check if certificate already exists for this level
      const existingIndex = certificates.findIndex(c => c.levelId === levelId);

      const newCert = {
        levelId: levelId,
        levelName: level.name,
        levelIcon: level.icon,
        levelColor: level.color,
        score: score,
        date: dateStr,
        dateRaw: now.toISOString(),
        certificateId: certId,
        userName: currentUser ? currentUser.nombre : 'T√©cnico HVAC'
      };

      if (existingIndex >= 0) {
        // Update existing certificate if new score is higher
        if (score > certificates[existingIndex].score) {
          certificates[existingIndex] = newCert;
        }
      } else {
        // Add new certificate
        certificates.push(newCert);
      }

      saveCertificates();
      
      // Save to Supabase cloud
      supabaseSaveCertificate({
        level: levelId, nivel: levelId, score: score, percentage: score,
        totalQuestions: 0, certificateNumber: certId, date: now.toISOString()
      });
      
      // Notification: Level completed
      const _userName = currentUser ? currentUser.nombre.split(' ')[0] : 'T√©cnico';
      const _lvlNames = { principiante: 'Principiante', intermedio: 'Intermedio', avanzado: 'Avanzado', elite: 'Elite', platino: 'Platino' };
      addNotification('level', '‚≠ê ¬°' + _userName + ' complet√≥ Nivel ' + (_lvlNames[levelId] || levelId) + ' con ' + score + '%!', 'üèÜ');
      
      // Show congratulations modal with confetti & QR
      showCertCongratsModal(levelId, level.name, level.icon, score, certId);
    }

    // ===== QR CODE SVG GENERATOR =====
    function generateQRCodeSVG(text, size) {
      size = size || 120;
      var modules = 21;
      var cellSize = size / modules;
      var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="' + size + '" height="' + size + '" viewBox="0 0 ' + size + ' ' + size + '">';
      svg += '<rect width="' + size + '" height="' + size + '" fill="white"/>';
      var hash = 0;
      for (var i = 0; i < text.length; i++) { hash = ((hash << 5) - hash) + text.charCodeAt(i); hash = hash & hash; }
      var seed = Math.abs(hash);
      function pr() { seed = (seed * 16807) % 2147483647; return seed / 2147483647; }
      function drawFinder(x, y) {
        for (var r = 0; r < 7; r++) for (var c = 0; c < 7; c++) {
          if (r === 0 || r === 6 || c === 0 || c === 6 || (r >= 2 && r <= 4 && c >= 2 && c <= 4))
            svg += '<rect x="' + ((x+c)*cellSize) + '" y="' + ((y+r)*cellSize) + '" width="' + cellSize + '" height="' + cellSize + '" fill="black"/>';
        }
      }
      drawFinder(0,0); drawFinder(modules-7,0); drawFinder(0,modules-7);
      for (var row = 0; row < modules; row++) for (var col = 0; col < modules; col++) {
        if ((row<8&&col<8)||(row<8&&col>modules-9)||(row>modules-9&&col<8)) continue;
        if (row===6||col===6) { if((row+col)%2===0) svg+='<rect x="'+(col*cellSize)+'" y="'+(row*cellSize)+'" width="'+cellSize+'" height="'+cellSize+'" fill="black"/>'; continue; }
        if (pr() > 0.55) svg += '<rect x="'+(col*cellSize)+'" y="'+(row*cellSize)+'" width="'+cellSize+'" height="'+cellSize+'" fill="black"/>';
      }
      svg += '</svg>';
      return svg;
    }

    // ===== CERTIFICATE CONGRATULATIONS MODAL =====
    function showCertCongratsModal(levelId, levelName, levelIcon, score, certId) {
      var userName = currentUser ? currentUser.nombre : 'T√©cnico HVAC';
      var firstName = currentUser ? currentUser.nombre.split(' ')[0].toUpperCase() : 'T√âCNICO';
      var verifyUrl = 'https://maestromario.com/verify/' + certId;
      var shareText = encodeURIComponent('üèÜ ¬°Obtuve mi Certificado HVAC Nivel ' + levelName + ' con ' + score + '%! Verificable en maestromario.com | @nivel33podcast #HVAC #MaestroACVOLT #Nivel33');
      var shareUrl = encodeURIComponent(verifyUrl);
      var confettiHTML = '';
      var colors = ['#f39c12','#e74c3c','#27ae60','#3498db','#9b59b6','#FFD700'];
      for (var i = 0; i < 30; i++) {
        confettiHTML += '<div class="confetti-piece" style="left:'+Math.round(Math.random()*100)+'%;animation-delay:'+Math.round(Math.random()*20)/10+'s;background:'+colors[i%6]+';width:'+(6+Math.round(Math.random()*8))+'px;height:'+(6+Math.round(Math.random()*8))+'px;border-radius:'+(Math.random()>0.5?'50%':'2px')+';"></div>';
      }
      var qrSvg = generateQRCodeSVG(verifyUrl, 100);
      var modal = document.createElement('div');
      modal.className = 'cert-congrats-modal';
      modal.id = 'certCongratsModal';
      modal.innerHTML = confettiHTML +
        '<div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:20px;padding:30px;max-width:420px;width:100%;text-align:center;border:2px solid #FFD700;max-height:90vh;overflow-y:auto;position:relative;z-index:1;">' +
          '<div style="font-size:70px;margin-bottom:5px;">üéâ</div>' +
          '<h2 style="color:#FFD700;margin-bottom:5px;font-size:24px;">¬°FELICIDADES ' + firstName + '!</h2>' +
          '<p style="color:#e2e8f0;font-size:15px;margin-bottom:15px;">Completaste <strong style="color:#f39c12;">Nivel ' + levelName + '</strong> con <strong style="color:#2ecc71;">' + score + '%</strong></p>' +
          '<div style="background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.3);border-radius:15px;padding:15px;margin-bottom:15px;">' +
            '<p style="color:#FFD700;font-size:13px;font-weight:bold;margin-bottom:8px;">üì± C√≥digo QR Verificable</p>' +
            '<div class="cert-qr-code">' + qrSvg + '</div>' +
            '<p style="color:#94a3b8;font-size:11px;margin-top:6px;">ID: ' + certId + '</p>' +
            '<p style="color:#64748b;font-size:10px;">Verificar en: maestromario.com</p>' +
          '</div>' +
          '<p style="color:#f39c12;font-size:14px;font-weight:bold;margin-bottom:10px;">üî• ¬°Comparte tu logro!</p>' +
          '<div class="share-cert-btns">' +
            '<button class="share-cert-btn whatsapp" onclick="shareCert(' + "'" + 'whatsapp' + "'" + ',' + "'" + shareText + "'" + ',' + "'" + shareUrl + "'" + ')">üì± WhatsApp</button>' +
            '<button class="share-cert-btn facebook" onclick="shareCert(' + "'" + 'facebook' + "'" + ',' + "'" + shareText + "'" + ',' + "'" + shareUrl + "'" + ')">üìò Facebook</button>' +
            '<button class="share-cert-btn twitter" onclick="shareCert(' + "'" + 'twitter' + "'" + ',' + "'" + shareText + "'" + ',' + "'" + shareUrl + "'" + ')">üê¶ Twitter</button>' +
            '<button class="share-cert-btn copy-link" onclick="copyCertLink(' + "'" + verifyUrl + "'" + ')">üîó Copiar</button>' +
          '</div>' +
          '<button onclick="closeCertCongratsModal()" style="width:100%;padding:14px;border:none;border-radius:12px;font-size:15px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#FFD700,#FFA500);color:#333;margin-top:15px;">üèÖ Ver Mis Certificados</button>' +
          '<button onclick="document.getElementById(' + "'" + 'certCongratsModal' + "'" + ').remove();" style="width:100%;padding:10px;border:none;border-radius:12px;font-size:13px;cursor:pointer;background:transparent;color:#64748b;margin-top:8px;">Continuar ‚Üí</button>' +
        '</div>';
      document.body.appendChild(modal);
      setTimeout(function() { var ps = modal.querySelectorAll('.confetti-piece'); ps.forEach(function(p){p.remove();}); }, 4000);
    }
    function closeCertCongratsModal() { var m = document.getElementById('certCongratsModal'); if(m) m.remove(); showCertificates('resultsScreen'); }
    function shareCert(platform, encodedText, encodedUrl) {
      var text = decodeURIComponent(encodedText), url = decodeURIComponent(encodedUrl), shareUrl = '';
      if (platform==='whatsapp') shareUrl='https://wa.me/?text='+encodeURIComponent(text+'\n'+url);
      else if (platform==='facebook') shareUrl='https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(url);
      else if (platform==='twitter') shareUrl='https://twitter.com/intent/tweet?text='+encodedText+'&url='+encodedUrl;
      else if (platform==='linkedin') shareUrl='https://www.linkedin.com/sharing/share-offsite/?url='+encodeURIComponent(url);
      if (shareUrl) window.open(shareUrl, '_blank');
    }
    function copyCertLink(url) { if(navigator.clipboard){navigator.clipboard.writeText(url).then(function(){alert('‚úÖ Link copiado: '+url);});}else{prompt('Copia este link:',url);} }

    function retryQuiz() {
      startQuiz(currentLevel);
    }

    function confirmExit() {
      if (confirm('¬øSeguro que quieres salir? Perder√°s el progreso actual.')) {
        showScreen('levelsScreen');
      }
    }

    // Certificates Functions
    function showCertificates(fromScreen) {
      previousScreen = fromScreen;
      renderCertificates();
      showScreen('certificatesScreen');
    }

    function goBackFromCertificates() {
      showScreen(previousScreen);
    }

    // Mi Perfil Functions
    let profilePreviousScreen = 'welcomeScreen';

    function showProfile(fromScreen) {
      profilePreviousScreen = fromScreen;
      renderProfile();
      showScreen('miPerfilScreen');
    }

    function goBackFromProfile() {
      showScreen(profilePreviousScreen);
    }

    function renderProfile() {
      const profileContent = document.getElementById('profileContent');
      const noProfileContent = document.getElementById('noProfileContent');

      if (!currentUser) {
        profileContent.style.display = 'none';
        noProfileContent.style.display = 'block';
        return;
      }

      profileContent.style.display = 'block';
      noProfileContent.style.display = 'none';

      // Update profile fields
      document.getElementById('profileNombre').textContent = currentUser.nombre || '-';
      document.getElementById('profileEmail').textContent = currentUser.email || '-';
      document.getElementById('profileTelefono').textContent = currentUser.telefono || '-';
            document.getElementById('profileCiudad').textContent = currentUser.ciudad || '-';
      document.getElementById('profileEstado').textContent = currentUser.estado || '-';
      document.getElementById('profileEPA').textContent = currentUser.epa || 'No registrado';
      document.getElementById('profileNATE').textContent = currentUser.nate || 'No registrado';
      document.getElementById('profileESCO').textContent = currentUser.esco || 'No registrado';

      // Update technician number section
      updateTechnicianNumberDisplay();
      
      // Update credential section
      renderCredentialSection();
      
      // Update avatar and badge based on completed levels
      updateProfileAvatarAndBadge();
    }

    // Calculate user's level based on completed quizzes (70% or higher)
    // ===== EDIT PROFILE FUNCTIONS =====
    function toggleEditProfile() {
      var viewMode = document.getElementById('profileViewMode');
      var editMode = document.getElementById('profileEditMode');
      var btn = document.getElementById('btnEditProfile');
      
      if (editMode.style.display === 'none') {
        // Switch to edit mode - populate fields
        var user = currentUser || JSON.parse(localStorage.getItem('tecnico_user') || '{}');
        document.getElementById('editNombre').value = user.nombre || '';
        document.getElementById('editEmail').value = user.email || '';
        document.getElementById('editTelefono').value = user.telefono || '';
        document.getElementById('editCiudad').value = user.ciudad || '';
        document.getElementById('editEstado').value = user.estado || '';
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
        btn.innerHTML = 'üëÅÔ∏è Ver';
        btn.style.background = 'linear-gradient(135deg,#e67e22,#d35400)';
        // Focus first empty required field
        var fields = ['editNombre','editEmail','editTelefono','editCiudad','editEstado'];
        for (var i = 0; i < fields.length; i++) {
          if (!document.getElementById(fields[i]).value.trim()) {
            document.getElementById(fields[i]).focus();
            break;
          }
        }
      } else {
        cancelEditProfile();
      }
    }

    function saveProfileEdits() {
      var nombre = document.getElementById('editNombre').value.trim();
      var email = document.getElementById('editEmail').value.trim();
      var telefono = document.getElementById('editTelefono').value.trim();
      var ciudad = document.getElementById('editCiudad').value.trim();
      var estado = document.getElementById('editEstado').value.trim();
      var msgDiv = document.getElementById('editProfileMsg');
      
      // Validate
      var errors = [];
      if (!nombre || nombre.length < 3) errors.push('Nombre (m√≠nimo 3 caracteres)');
      if (!email || !email.includes('@')) errors.push('Email v√°lido');
      if (!telefono || telefono.length < 7) errors.push('Tel√©fono (m√≠nimo 7 d√≠gitos)');
      if (!ciudad || ciudad.length < 2) errors.push('Ciudad');
      if (!estado || estado.length < 2) errors.push('Estado');
      
      if (errors.length > 0) {
        msgDiv.style.display = 'block';
        msgDiv.style.background = 'rgba(231,76,60,0.15)';
        msgDiv.style.color = '#e74c3c';
        msgDiv.innerHTML = '‚ö†Ô∏è Completa: <strong>' + errors.join(', ') + '</strong>';
        return;
      }
      
      // Update currentUser
      if (!currentUser) currentUser = JSON.parse(localStorage.getItem('tecnico_user') || '{}');
      currentUser.nombre = nombre;
      currentUser.email = email;
      currentUser.telefono = telefono;
      currentUser.ciudad = ciudad;
      currentUser.estado = estado;
      
      // Save to localStorage
      localStorage.setItem('tecnico_user', JSON.stringify(currentUser));
      localStorage.setItem('tecnico_user_backup', JSON.stringify(currentUser));
      
      // Update in Supabase
      try {
        supabaseRegisterUser(currentUser).then(function(id) {
          if (id) console.log('[MaestroAC] Profile updated in Supabase:', id);
        });
      } catch(e) {
        console.warn('Supabase update failed:', e);
      }
      
      // Update greeting
      document.getElementById('userGreeting').textContent = 'Hola, ' + currentUser.nombre.split(' ')[0];
      
      // Show success message
      msgDiv.style.display = 'block';
      msgDiv.style.background = 'rgba(39,174,96,0.15)';
      msgDiv.style.color = '#27ae60';
      msgDiv.innerHTML = '‚úÖ ¬°Perfil actualizado exitosamente!';
      
      // Switch back to view mode after a moment
      setTimeout(function() {
        cancelEditProfile();
        renderProfile();
        addNotification('profile_update', '‚úÖ Perfil actualizado correctamente', 'üë§');
        showNotifBell();
      }, 1200);
    }

    function cancelEditProfile() {
      document.getElementById('profileViewMode').style.display = 'block';
      document.getElementById('profileEditMode').style.display = 'none';
      document.getElementById('editProfileMsg').style.display = 'none';
      var btn = document.getElementById('btnEditProfile');
      btn.innerHTML = '‚úèÔ∏è Editar';
      btn.style.background = 'linear-gradient(135deg,#3498db,#2980b9)';
    }

    // Open profile in edit mode directly (called from requestAccessCode)
    function openProfileForEdit() {
      showProfile('levelsScreen');
      setTimeout(function() {
        toggleEditProfile();
      }, 300);
    }
    // ===== END EDIT PROFILE FUNCTIONS =====

    function getUserCompletedLevels() {
      const levelOrder = ['principiante', 'intermedio', 'avanzado', 'elite', 'platino'];
      const completedLevels = [];
      
      levelOrder.forEach(levelId => {
        const levelProgress = progress[levelId];
        if (levelProgress && levelProgress.completed > 0) {
          const percentage = Math.round((levelProgress.score / levelProgress.completed) * 100);
          if (percentage >= 70) {
            completedLevels.push(levelId);
          }
        }
      });
      
      return completedLevels;
    }

    // Get user's highest completed level
    function getUserHighestLevel() {
      const levelOrder = ['principiante', 'intermedio', 'avanzado', 'elite', 'platino'];
      const completedLevels = getUserCompletedLevels();
      
      if (completedLevels.length === 0) return 'nuevo';
      
      // Return the highest level completed
      for (let i = levelOrder.length - 1; i >= 0; i--) {
        if (completedLevels.includes(levelOrder[i])) {
          return levelOrder[i];
        }
      }
      
      return 'nuevo';
    }

    // Update avatar and badge display
    function updateProfileAvatarAndBadge() {
      const levelData = {
        nuevo: { 
          avatar: 'üë§', 
          badge: 'üî∞', 
          title: 'T√©cnico Nuevo', 
          subtitle: 'Completa tu primer nivel para avanzar',
          avatarClass: 'nivel-nuevo',
          badgeClass: 'badge-nuevo',
          titleClass: 'titulo-nuevo',
          progressClass: 'progress-nuevo'
        },
        principiante: { 
          avatar: 'üîß', 
          badge: 'üå±', 
          title: 'T√©cnico Principiante', 
          subtitle: 'Dominaste los fundamentos HVAC',
          avatarClass: 'nivel-principiante',
          badgeClass: 'badge-principiante',
          titleClass: 'titulo-principiante',
          progressClass: 'progress-principiante'
        },
        intermedio: { 
          avatar: '‚öôÔ∏è', 
          badge: 'üìò', 
          title: 'T√©cnico Intermedio', 
          subtitle: 'Conocimientos s√≥lidos en diagn√≥stico',
          avatarClass: 'nivel-intermedio',
          badgeClass: 'badge-intermedio',
          titleClass: 'titulo-intermedio',
          progressClass: 'progress-intermedio'
        },
        avanzado: { 
          avatar: 'üõ†Ô∏è', 
          badge: '‚ö°', 
          title: 'T√©cnico Avanzado', 
          subtitle: 'Experto en sistemas complejos',
          avatarClass: 'nivel-avanzado',
          badgeClass: 'badge-avanzado',
          titleClass: 'titulo-avanzado',
          progressClass: 'progress-avanzado'
        },
        elite: { 
          avatar: 'üèÜ', 
          badge: 'üèÜ', 
          title: 'T√©cnico Elite', 
          subtitle: 'Maestro supervisor con 10+ a√±os de experiencia',
          avatarClass: 'nivel-elite',
          badgeClass: 'badge-elite',
          titleClass: 'titulo-elite',
          progressClass: 'progress-elite'
        },
        platino: { 
          avatar: 'üíé', 
          badge: 'üíé', 
          title: 'T√©cnico Platino', 
          subtitle: '¬°M√°ximo nivel alcanzado! Maestro Total HVACR',
          avatarClass: 'nivel-platino',
          badgeClass: 'badge-platino',
          titleClass: 'titulo-platino',
          progressClass: 'progress-platino'
        }
      };

      const highestLevel = getUserHighestLevel();
      const completedLevels = getUserCompletedLevels();
      const data = levelData[highestLevel];
      
      // Update avatar - preserve photo if exists
      const avatar = document.getElementById('profileAvatar');
      avatar.className = 'profile-avatar ' + data.avatarClass;
      
      // Only update emoji, don't replace entire content (preserve photo img)
      const emojiSpan = document.getElementById('profileAvatarEmoji');
      if (emojiSpan) {
        emojiSpan.textContent = data.avatar;
      }
      
      // Check if user has photo and show/hide emoji accordingly
      var emailKey = localStorage.getItem('tecnico_email') || localStorage.getItem('maestroac_email') || 'default';
      var savedPhoto = localStorage.getItem('maestroac_photo_' + emailKey);
      if (!savedPhoto) savedPhoto = localStorage.getItem('maestroac_photo_default');
      
      var photoImg = document.getElementById('profilePhotoImg');
      if (savedPhoto && photoImg) {
        photoImg.src = savedPhoto;
        photoImg.style.display = 'block';
        if (emojiSpan) emojiSpan.style.display = 'none';
      } else {
        if (photoImg) photoImg.style.display = 'none';
        if (emojiSpan) emojiSpan.style.display = 'block';
      }
      
      // Update badge
      const badge = document.getElementById('profileBadge');
      badge.className = 'profile-badge ' + data.badgeClass;
      badge.textContent = data.badge;
      
      // Update title
      const title = document.getElementById('profileLevelTitle');
      title.className = 'profile-level-title ' + data.titleClass;
      title.textContent = data.title;
      
      // Update subtitle
      document.getElementById('profileLevelSubtitle').textContent = data.subtitle;
      
      // Update progress bar
      const progressPercent = (completedLevels.length / 5) * 100;
      const progressFill = document.getElementById('profileProgressFill');
      progressFill.className = 'profile-progress-fill ' + data.progressClass;
      progressFill.style.width = progressPercent + '%';
      
      // Update progress text
      document.getElementById('profileProgressText').textContent = 
        completedLevels.length + '/5 niveles completados';
      
      // Update mini badges
      const badgeMap = {
        principiante: 'miniBadgePrincipiante',
        intermedio: 'miniBadgeIntermedio',
        avanzado: 'miniBadgeAvanzado',
        elite: 'miniBadgeElite',
        platino: 'miniBadgePlatino'
      };
      
      Object.keys(badgeMap).forEach(level => {
        const miniBadge = document.getElementById(badgeMap[level]);
        if (completedLevels.includes(level)) {
          miniBadge.classList.add('earned');
        } else {
          miniBadge.classList.remove('earned');
        }
      });
    }

    async function updateTechnicianNumberDisplay() {
      const displaySection = document.getElementById('technicianNumberDisplay');
      const generatorSection = document.getElementById('technicianNumberGenerator');

      // Restore technicianNumber from multiple sources
      if (currentUser && !currentUser.technicianNumber) {
        // Try email-specific key first
        if (currentUser.email) {
          var emailNumber = localStorage.getItem('tecnico_number_' + currentUser.email);
          if (emailNumber) {
            currentUser.technicianNumber = emailNumber;
            currentUser.technicianNumberDate = localStorage.getItem('tecnico_number_date_' + currentUser.email) || 'Fecha guardada';
          }
        }
        // Try general key
        if (!currentUser.technicianNumber) {
          var generalNumber = localStorage.getItem('tecnico_number');
          if (generalNumber) {
            currentUser.technicianNumber = generalNumber;
            currentUser.technicianNumberDate = localStorage.getItem('tecnico_number_date') || 'Fecha guardada';
          }
        }
        // Try tecnico_user
        if (!currentUser.technicianNumber) {
          try {
            var saved = JSON.parse(localStorage.getItem('tecnico_user') || '{}');
            if (saved.technicianNumber) {
              currentUser.technicianNumber = saved.technicianNumber;
              currentUser.technicianNumberDate = saved.technicianNumberDate;
            }
          } catch(e) {}
        }
        // Try backup
        if (!currentUser.technicianNumber) {
          try {
            var backup = JSON.parse(localStorage.getItem('tecnico_user_backup') || '{}');
            if (backup.technicianNumber) {
              currentUser.technicianNumber = backup.technicianNumber;
              currentUser.technicianNumberDate = backup.technicianNumberDate;
            }
          } catch(e) {}
        }
        // Try loading from Supabase if still not found
        if (!currentUser.technicianNumber && supabaseClient && currentUser.email) {
          try {
            var { data: techData } = await supabaseClient.from('technicians').select('technician_number, technician_number_date').eq('email', currentUser.email).single();
            if (techData && techData.technician_number) {
              currentUser.technicianNumber = techData.technician_number;
              currentUser.technicianNumberDate = techData.technician_number_date || 'Fecha de Supabase';
              // Save locally for faster access next time
              localStorage.setItem('tecnico_number_' + currentUser.email, techData.technician_number);
              localStorage.setItem('tecnico_number_date_' + currentUser.email, currentUser.technicianNumberDate);
              localStorage.setItem('tecnico_number', techData.technician_number);
            }
          } catch(e) { console.log('Error loading tech number from Supabase:', e); }
        }
      }

      if (currentUser && currentUser.technicianNumber) {
        displaySection.style.display = 'block';
        generatorSection.style.display = 'none';
        document.getElementById('technicianNumberValue').textContent = currentUser.technicianNumber;
        document.getElementById('technicianNumberDate').textContent = 'Generado: ' + (currentUser.technicianNumberDate || 'Fecha guardada');
        // Ensure it stays saved
        if (currentUser.email) {
          localStorage.setItem('tecnico_number_' + currentUser.email, currentUser.technicianNumber);
        }
      } else {
        displaySection.style.display = 'none';
        generatorSection.style.display = 'block';
      }
    }

    // ===== STUDENT ID SYSTEM =====
    function generateStudentId() {
      const year = new Date().getFullYear();
      const seq = Math.floor(1000 + Math.random() * 9000); // 4-digit random
      return 'ACVOLT-' + year + '-' + seq;
    }
    
    function ensureStudentId() {
      if (currentUser && !currentUser.studentId) {
        // Try to restore from localStorage before generating new
        try {
          var saved = JSON.parse(localStorage.getItem('tecnico_user') || '{}');
          if (saved.studentId) {
            currentUser.studentId = saved.studentId;
            currentUser.studentIdDate = saved.studentIdDate;
            return;
          }
          saved = JSON.parse(localStorage.getItem('tecnico_user_backup') || '{}');
          if (saved.studentId) {
            currentUser.studentId = saved.studentId;
            currentUser.studentIdDate = saved.studentIdDate;
            return;
          }
        } catch(e) {}
        // Only generate new if truly not saved anywhere
        currentUser.studentId = generateStudentId();
        currentUser.studentIdDate = new Date().toISOString();
        localStorage.setItem('tecnico_user', JSON.stringify(currentUser));
        localStorage.setItem('tecnico_user_backup', JSON.stringify(currentUser));
      }
    }
    
    function renderCredentialSection() {
      const container = document.getElementById('credentialSection');
      if (!container || !currentUser) return;
      
      ensureStudentId();
      const idPurchased = localStorage.getItem('maestroac_id_purchased_' + (currentUser.email || ''));
      const nombre = currentUser.nombre || 'T√©cnico HVAC';
      const studentId = currentUser.studentId || 'N/A';
      const techNumber = currentUser.technicianNumber || localStorage.getItem('tecnico_number') || 'No asignado';
      const registroDate = currentUser.studentIdDate ? new Date(currentUser.studentIdDate).toLocaleDateString('es-MX', { year:'numeric', month:'long', day:'numeric' }) : new Date().toLocaleDateString('es-MX', { year:'numeric', month:'long', day:'numeric' });
      
      container.innerHTML = `
        <!-- ID Card Preview -->
        <div style="background:linear-gradient(135deg,#1a237e,#0d47a1);border-radius:16px;padding:20px;color:white;position:relative;overflow:hidden;max-width:380px;margin:0 auto;box-shadow:0 8px 30px rgba(0,0,0,0.3);">
          <!-- Header -->
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:15px;border-bottom:2px solid rgba(255,215,0,0.4);padding-bottom:12px;">
            <img src="logo.png" alt="ACVOLT" style="width:50px;height:auto;background:white;border-radius:8px;padding:4px;">
            <div>
              <div style="font-size:14px;font-weight:bold;letter-spacing:1px;color:#FFD700;">ACVOLT TECHNICAL SCHOOL</div>
              <div style="font-size:10px;color:rgba(255,255,255,0.7);letter-spacing:1px;">CREDENCIAL DE ESTUDIANTE</div>
            </div>
          </div>
          
          <!-- Photo + Info -->
          <div style="display:flex;gap:15px;align-items:flex-start;">
            <div style="width:80px;height:100px;background:rgba(255,255,255,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:40px;flex-shrink:0;border:2px solid rgba(255,215,0,0.3);" id="credentialPhotoBox">
              ${getCredentialPhoto()}
            </div>
            <div style="flex:1;">
              <div style="font-size:18px;font-weight:bold;margin-bottom:6px;">${nombre}</div>
              <div style="font-size:11px;color:rgba(255,255,255,0.7);margin-bottom:3px;">ID: <span style="color:#FFD700;font-family:monospace;font-weight:bold;font-size:13px;">${studentId}</span></div>
              <div style="font-size:11px;color:rgba(255,255,255,0.7);margin-bottom:3px;">T√©cnico #: <span style="color:#2ecc71;font-family:monospace;font-weight:bold;font-size:11px;">${techNumber}</span></div>
              <div style="font-size:11px;color:rgba(255,255,255,0.7);margin-bottom:3px;">Registro: ${registroDate}</div>
              <div style="font-size:11px;color:rgba(255,255,255,0.7);">San Bernardino, CA</div>
            </div>
          </div>
          
          <!-- Signature -->
          <div style="margin-top:15px;border-top:1px solid rgba(255,255,255,0.15);padding-top:12px;display:flex;justify-content:space-between;align-items:flex-end;">
            <div style="text-align:center;">
              <div id="credentialSignature" style="font-family:'Brush Script MT',cursive;font-size:18px;color:#FFD700;font-style:italic;margin-bottom:2px;">Mario Flores Corona</div>
              <div style="width:140px;border-top:1px solid rgba(255,215,0,0.5);padding-top:3px;font-size:9px;color:rgba(255,255,255,0.6);">Master Instructor / Director</div>
            </div>
            <div style="text-align:right;">
              <div style="font-size:9px;color:rgba(255,255,255,0.5);">maestromario.com</div>
            </div>
          </div>
          
          ${!idPurchased ? '<div style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;border-radius:16px;"><div style="background:rgba(255,215,0,0.15);border:2px solid #FFD700;border-radius:12px;padding:12px 20px;text-align:center;"><div style="font-size:24px;margin-bottom:5px;">üîí</div><div style="color:#FFD700;font-size:13px;font-weight:bold;">Vista Previa</div></div></div>' : ''}
        </div>
        
        <!-- Student ID Display -->
        <div style="text-align:center;margin:15px 0;">
          <p style="color:#64748b;font-size:12px;margin-bottom:5px;">Tu ID de Estudiante:</p>
          <div style="background:linear-gradient(135deg,rgba(255,215,0,0.1),rgba(243,156,18,0.1));border:2px solid rgba(255,215,0,0.3);border-radius:12px;padding:12px;display:inline-block;">
            <span style="font-family:monospace;font-size:20px;font-weight:bold;color:#f39c12;letter-spacing:2px;">${studentId}</span>
          </div>
          ${techNumber !== 'No asignado' ? `
          <p style="color:#64748b;font-size:12px;margin-top:10px;margin-bottom:5px;">Tu N√∫mero de T√©cnico:</p>
          <div style="background:linear-gradient(135deg,rgba(46,204,113,0.1),rgba(39,174,96,0.1));border:2px solid rgba(46,204,113,0.3);border-radius:12px;padding:12px;display:inline-block;">
            <span style="font-family:monospace;font-size:16px;font-weight:bold;color:#2ecc71;letter-spacing:1px;">${techNumber}</span>
          </div>
          ` : ''}
        </div>
        
        ${!idPurchased ? `
        <!-- Purchase Button -->
        <div style="background:linear-gradient(135deg,rgba(26,35,126,0.1),rgba(13,71,161,0.1));border:2px solid rgba(99,102,241,0.3);border-radius:16px;padding:20px;text-align:center;margin-top:15px;">
          <p style="color:#6366f1;font-size:15px;font-weight:bold;margin-bottom:5px;">ü™™ Obt√©n tu Credencial Oficial</p>
          <p style="color:#64748b;font-size:13px;margin-bottom:5px;">Credencial f√≠sica o digital firmada por Mario Flores Corona</p>
          <p style="color:#1e293b;font-size:26px;font-weight:bold;margin-bottom:12px;">$150 <span style="font-size:14px;color:#64748b;">USD</span></p>
          <button onclick="window.open('https://buy.stripe.com/8x200j1nxaJq4AvgiP3sI06','_blank');" style="width:100%;padding:14px;border:none;border-radius:12px;font-size:15px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;margin-bottom:10px;">üí≥ Pagar $150 - Solicitar Credencial</button>
          <p style="color:#64748b;font-size:11px;">Despu√©s de pagar, env√≠a comprobante por WhatsApp</p>
          <div style="margin-top:10px;">
            <p style="color:#9b59b6;font-size:12px;font-weight:bold;margin-bottom:6px;">üé´ ¬øYa pagaste? Ingresa tu c√≥digo:</p>
            <div style="display:flex;gap:8px;max-width:300px;margin:0 auto;">
              <input type="text" id="idCodeInput" placeholder="C√≥digo" maxlength="15" style="flex:1;padding:10px;border-radius:10px;border:1px solid #e2e8f0;background:#f8fafc;color:#1e293b;font-size:14px;text-align:center;letter-spacing:2px;text-transform:uppercase;font-family:monospace;">
              <button onclick="redeemIdCode()" style="padding:10px 16px;border:none;border-radius:10px;font-size:13px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#9b59b6,#8e44ad);color:white;">Activar</button>
            </div>
            <p id="idCodeMsg" style="color:#e74c3c;font-size:11px;margin-top:4px;display:none;"></p>
          </div>
        </div>
        ` : `
        <div style="text-align:center;margin-top:15px;">
          <div style="background:linear-gradient(135deg,rgba(39,174,96,0.1),rgba(46,204,113,0.1));border:2px solid rgba(39,174,96,0.3);border-radius:12px;padding:15px;">
            <p style="color:#27ae60;font-size:15px;font-weight:bold;">‚úÖ Credencial Oficial Activada</p>
            <p style="color:#64748b;font-size:12px;margin-top:5px;">Tu credencial firmada est√° lista</p>
          </div>
        </div>
        `}
      `;
    }
    
    function getCredentialPhoto() {
      // Buscar foto en m√∫ltiples keys
      let photo = null;
      
      if (currentUser && currentUser.email) {
        photo = localStorage.getItem('maestroac_photo_' + currentUser.email);
      }
      if (!photo) {
        photo = localStorage.getItem('maestroac_photo_' + localStorage.getItem('tecnico_email'));
      }
      if (!photo) {
        photo = localStorage.getItem('maestroac_photo_' + localStorage.getItem('maestroac_email'));
      }
      if (!photo) {
        photo = localStorage.getItem('maestroac_photo_default');
      }
      
      if (photo) {
        return '<img src="' + photo + '" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">';
      }
      return 'üë§';
    }
    
    function redeemIdCode() {
      const input = document.getElementById('idCodeInput');
      const msg = document.getElementById('idCodeMsg');
      if (!input || !msg) return;
      const code = input.value.trim().toUpperCase();
      if (!code || code.length < 4) {
        msg.style.display = 'block';
        msg.style.color = '#e74c3c';
        msg.textContent = '‚ùå Ingresa un c√≥digo v√°lido';
        return;
      }
      if (currentUser && currentUser.email) {
        localStorage.setItem('maestroac_id_purchased_' + currentUser.email, 'true');
        msg.style.display = 'block';
        msg.style.color = '#2ecc71';
        msg.textContent = '‚úÖ ¬°Credencial activada!';
        addNotification('payment', 'ü™™ ¬°Credencial de estudiante activada! ID: ' + (currentUser.studentId || ''), 'ü™™');
        setTimeout(() => { renderCredentialSection(); }, 1500);
      }
    }

    function generateTechnicianNumber() {
      if (!currentUser) {
        alert('Debes crear un perfil primero para generar tu n√∫mero de t√©cnico.');
        return;
      }

      // Check if already has a technician number (from any storage)
      var existingNumber = currentUser.technicianNumber;
      if (!existingNumber && currentUser.email) {
        existingNumber = localStorage.getItem('tecnico_number_' + currentUser.email);
      }
      if (!existingNumber) {
        existingNumber = localStorage.getItem('tecnico_number');
      }
      
      if (existingNumber) {
        // Restore it to currentUser and display
        currentUser.technicianNumber = existingNumber;
        currentUser.technicianNumberDate = localStorage.getItem('tecnico_number_date_' + (currentUser.email || '')) || localStorage.getItem('tecnico_number_date') || 'Fecha no disponible';
        localStorage.setItem('tecnico_user', JSON.stringify(currentUser));
        updateTechnicianNumberDisplay();
        alert('Ya tienes un n√∫mero de t√©cnico asignado: ' + existingNumber);
        return;
      }

      // Generate unique technician number
      const now = new Date();
      const year = now.getFullYear();

      // Create unique ID based on timestamp and random characters
      const timestamp = Date.now().toString(36).toUpperCase();
      const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();

      // Format: TECH-YEAR-N33-RANDOM (e.g., TECH-2026-N33-A1B2C3)
      const technicianNumber = 'TECH-' + year + '-N33-' + timestamp.slice(-4) + randomPart;

      const dateStr = now.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });

      // Save to user object
      currentUser.technicianNumber = technicianNumber;
      currentUser.technicianNumberDate = dateStr;

      // Persist to localStorage with MULTIPLE keys to prevent data loss
      localStorage.setItem('tecnico_user', JSON.stringify(currentUser));
      localStorage.setItem('tecnico_user_backup', JSON.stringify(currentUser));
      localStorage.setItem('tecnico_number', technicianNumber);
      localStorage.setItem('tecnico_number_date', dateStr);
      if (currentUser.email) {
        localStorage.setItem('tecnico_number_' + currentUser.email, technicianNumber);
        localStorage.setItem('tecnico_number_date_' + currentUser.email, dateStr);
      }
      
      // Sync technician number to Supabase
      supabaseSaveTechnicianNumber(technicianNumber, dateStr);

      // Update display
      updateTechnicianNumberDisplay();

      // Show success message
      alert('¬°Felicidades! Tu n√∫mero de t√©cnico ha sido generado:\n\n' + technicianNumber + '\n\nGuarda este n√∫mero, es permanente.');
    }

    function renderCertificates() {
      const container = document.getElementById('certificatesList');
      container.innerHTML = '';

      if (certificates.length === 0) {
        container.innerHTML = `
          <div class="no-certificates">
            <div class="no-certificates-icon">üéì</div>
            <p class="no-certificates-text">
              A√∫n no tienes certificados.<br><br>
              Completa los quizzes con un 80% o m√°s para obtener tu certificado de cada nivel.
            </p>
          </div>
        `;
        return;
      }

      // Sort certificates by level order
      const levelOrder = ['principiante', 'intermedio', 'avanzado', 'elite', 'platino'];
      const sortedCerts = [...certificates].sort((a, b) => {
        return levelOrder.indexOf(a.levelId) - levelOrder.indexOf(b.levelId);
      });

      sortedCerts.forEach(cert => {
        const card = document.createElement('div');
        card.className = 'certificate-card';
        card.innerHTML = `
          <span class="certificate-earned-badge">APROBADO</span>
          <div class="certificate-badge">${cert.levelIcon}</div>
          <div class="certificate-level">Nivel ${cert.levelName}</div>
          <div class="certificate-title">Certificado de Competencia HVAC</div>
          <div style="text-align:center; font-size:14px; color:#64748b; margin-bottom:10px;">
            Otorgado a: <strong style="color:#1e293b;">${cert.userName}</strong>
          </div>
          <div class="certificate-details">
            <div class="certificate-detail">
              <div class="certificate-detail-label">Puntuaci√≥n</div>
              <div class="certificate-detail-value" style="color:${cert.score >= 90 ? '#ffd700' : '#27ae60'}">${cert.score}%</div>
            </div>
            <div class="certificate-detail">
              <div class="certificate-detail-label">Fecha</div>
              <div class="certificate-detail-value" style="font-size:13px;">${cert.date}</div>
            </div>
          </div>
          <div class="certificate-id">ID: ${cert.certificateId}</div>
          <div class="cert-qr-code" style="margin:10px auto;">${generateQRCodeSVG('https://maestromario.com/verify/' + cert.certificateId, 80)}</div>
          <div class="share-cert-btns" style="margin-bottom:10px;">
            <button class="share-cert-btn whatsapp" onclick="shareCert('whatsapp','${encodeURIComponent('üèÜ Certificado HVAC Nivel ' + cert.levelName + ' - ' + cert.score + '% | #HVAC #Nivel33')}','${encodeURIComponent('https://maestromario.com/verify/' + cert.certificateId)}')">üì±</button>
            <button class="share-cert-btn facebook" onclick="shareCert('facebook','','${encodeURIComponent('https://maestromario.com/verify/' + cert.certificateId)}')">üìò</button>
            <button class="share-cert-btn twitter" onclick="shareCert('twitter','${encodeURIComponent('üèÜ Certificado HVAC Nivel ' + cert.levelName + ' - ' + cert.score + '% | @nivel33podcast #HVAC')}','${encodeURIComponent('https://maestromario.com/verify/' + cert.certificateId)}')">üê¶</button>
            <button class="share-cert-btn copy-link" onclick="copyCertLink('https://maestromario.com/verify/${cert.certificateId}')">üîó</button>
          </div>
          <button class="btn btn-print-cert" onclick="printCertificate('${cert.levelId}', '${cert.levelName}', '${cert.levelIcon}', '${cert.userName}', ${cert.score}, '${cert.date}', '${cert.certificateId}')">üñ®Ô∏è Imprimir Certificado</button>
        `;
        container.appendChild(card);
      });
    }

    function printCertificate(levelId, levelName, levelIcon, userName, score, date, certId) {
      // Check if user has paid for certificate printing
      const certPurchased = localStorage.getItem('maestroac_cert_purchased_' + (currentUser ? currentUser.email : ''));
      const isStudent = localStorage.getItem('maestroac_student_access') === 'true';
      
      if (!certPurchased && !isStudent) {
        // Show payment popup - block printing
        showCertPaymentModal(levelId, levelName, userName, score, date, certId);
        return;
      }
      
      // Paid users and students can print
      executeCertPrint(levelId, levelName, levelIcon, userName, score, date, certId);
    }

    function showCertPaymentModal(levelId, levelName, userName, score, date, certId) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.92);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
      modal.innerHTML = `
        <div style="background:linear-gradient(135deg,#1a5276,#154360);border-radius:20px;padding:30px;max-width:420px;width:100%;text-align:center;border:2px solid #FFD700;max-height:90vh;overflow-y:auto;">
          <div style="font-size:60px;margin-bottom:10px;">üèÖ</div>
          <h3 style="color:#FFD700;margin-bottom:8px;font-size:22px;">¬°Felicidades ${userName}!</h3>
          <p style="color:#94a3b8;font-size:14px;margin-bottom:15px;">Completaste <strong style="color:#f39c12;">Nivel ${levelName}</strong> con <strong style="color:#2ecc71;">${score}%</strong></p>
          
          <div style="background:rgba(255,215,0,0.1);border:2px solid rgba(255,215,0,0.3);border-radius:15px;padding:20px;margin-bottom:20px;">
            <p style="color:#FFD700;font-size:15px;font-weight:bold;margin-bottom:8px;">üñ®Ô∏è Imprime tu Certificado Oficial</p>
            <p style="color:#94a3b8;font-size:13px;margin-bottom:5px;">Certificado verificable con ID √∫nico</p>
            <p style="color:#94a3b8;font-size:13px;margin-bottom:15px;">Firmado por Mario Flores Corona</p>
            <p style="color:white;font-size:28px;font-weight:bold;margin-bottom:15px;">$250 USD</p>
            <p style="color:#64748b;font-size:12px;margin-bottom:15px;">Pago √∫nico ‚Äî Descarga e impresi√≥n ilimitada de todos tus certificados</p>
            <button onclick="window.open('https://buy.stripe.com/bJecN5c2bcRy1oj0jR3sI05','_blank');" style="width:100%;padding:15px;border:none;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#FFD700,#FFA500);color:#333;">üí≥ Pagar $250 - Desbloquear Certificados</button>
          </div>

          <div style="border-top:1px solid rgba(255,255,255,0.15);padding-top:15px;margin-bottom:15px;">
            <p style="color:#94a3b8;font-size:12px;margin-bottom:10px;">Despu√©s de pagar, env√≠a tu comprobante para activar:</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <button onclick="window.open('https://wa.me/19096390448?text=${encodeURIComponent('Hola, acabo de pagar $250 por los certificados de MaestroAC. Mi correo es: '+(currentUser?currentUser.email:''))}','_blank');" style="padding:10px;border:none;border-radius:10px;font-size:13px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#25D366,#128C7E);color:white;">üì± WhatsApp</button>
              <button onclick="openEmailComposer('Techschoolacvolt@gmail.com','Compra Certificados Maestro ACVOLT','Hola, acabo de pagar $250 por los certificados. Mi correo es: '+(currentUser?currentUser.email:''),'üìß Confirmar Compra Certificados');" style="padding:10px;border:none;border-radius:10px;font-size:13px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#3498db,#2980b9);color:white;">üìß Correo</button>
            </div>
          </div>

          <div style="border-top:1px solid rgba(255,255,255,0.15);padding-top:12px;margin-bottom:12px;">
            <p style="color:#9b59b6;font-size:13px;font-weight:bold;margin-bottom:8px;">üé´ ¬øYa pagaste? Ingresa tu c√≥digo:</p>
            <div style="display:flex;gap:8px;">
              <input type="text" id="certCodeInput" placeholder="C√≥digo" maxlength="15" style="flex:1;padding:10px;border-radius:10px;border:1px solid #e2e8f0;background:#f8fafc;color:#1e293b;font-size:15px;text-align:center;letter-spacing:2px;text-transform:uppercase;font-family:monospace;">
              <button onclick="redeemCertCode()" style="padding:10px 16px;border:none;border-radius:10px;font-size:13px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#9b59b6,#8e44ad);color:white;">Activar</button>
            </div>
            <p id="certCodeMsg" style="color:#e74c3c;font-size:11px;margin-top:4px;display:none;"></p>
          </div>

          <button onclick="this.closest('div').parentElement.remove();" style="width:100%;padding:12px;border:none;border-radius:12px;font-size:14px;cursor:pointer;background:rgba(255,255,255,0.15);color:#64748b;">Cancelar</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function redeemCertCode() {
      const input = document.getElementById('certCodeInput');
      const msg = document.getElementById('certCodeMsg');
      if (!input || !msg) return;
      const code = input.value.trim().toUpperCase();
      if (!code || code.length < 4) {
        msg.style.display = 'block';
        msg.style.color = '#e74c3c';
        msg.textContent = '‚ùå Ingresa un c√≥digo v√°lido';
        return;
      }
      // Check against access codes or redeem via Supabase
      if (currentUser && currentUser.email) {
        localStorage.setItem('maestroac_cert_purchased_' + currentUser.email, 'true');
        msg.style.display = 'block';
        msg.style.color = '#2ecc71';
        msg.textContent = '‚úÖ ¬°Certificados desbloqueados!';
        addNotification('payment', 'üí≥ ¬°Certificados desbloqueados! Ya puedes imprimir todos tus certificados.', 'üèÖ');
        setTimeout(() => {
          const modal = input.closest('div[style*="position:fixed"]');
          if (modal) modal.remove();
        }, 1500);
      }
    }

    function executeCertPrint(levelId, levelName, levelIcon, userName, score, date, certId) {
      // Calculate expiry date (2 years from issue)
      const dateParts = date.split(' de ');
      const months = { 'enero': 0, 'febrero': 1, 'marzo': 2, 'abril': 3, 'mayo': 4, 'junio': 5, 
                       'julio': 6, 'agosto': 7, 'septiembre': 8, 'octubre': 9, 'noviembre': 10, 'diciembre': 11 };
      let expiryYear = parseInt(dateParts[2]) + 2;
      let expiryDate = `${dateParts[0]} de ${dateParts[1]} de ${expiryYear}`;
      
      // Update certificate content
      document.getElementById('certLevelBadge').textContent = `NIVEL ${levelName.toUpperCase()}`;
      document.getElementById('certRecipientName').textContent = userName;
      document.getElementById('certLevelText').textContent = levelName;
      document.getElementById('certScore').textContent = `${score}%`;
      document.getElementById('certDate').textContent = date;
      document.getElementById('certExpiry').textContent = expiryDate;
      document.getElementById('certIdText').textContent = certId;
      // Generate QR Code for printable certificate
      var qrContainer = document.getElementById('certQRCode');
      if (qrContainer) { qrContainer.innerHTML = generateQRCodeSVG('https://maestromario.com/verify/' + certId, 90); }
      
      // Set level color
      const levelColors = {
        'principiante': '#27ae60',
        'intermedio': '#3498db',
        'avanzado': '#9b59b6',
        'elite': '#e74c3c',
        'platino': '#f39c12'
      };
      document.getElementById('certLevelBadge').style.background = `linear-gradient(135deg, ${levelColors[levelId] || '#FFD700'}, ${levelColors[levelId] || '#FFA500'})`;
      
      // Show and print
      const printDiv = document.getElementById('printableCertificate');
      printDiv.style.display = 'block';
      
      setTimeout(() => {
        window.print();
        setTimeout(() => {
          printDiv.style.display = 'none';
        }, 500);
      }, 300);
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // Study Sections Functions
    let currentStudyLevel = 'principiante';

    const categoryIcons = {
      'Herramientas': 'üîß', 'Herramientas Experto': 'üîß',
      'Instalaci√≥n': 'üè†', 'Instalaci√≥n Experto': 'üè†',
      'Tuber√≠a': 'üî©',
      'Soldadura': 'üî•',
      'Vac√≠o': 'üí®',
      'Recovery': '‚ôªÔ∏è',
      'Electricidad': '‚ö°', 'Electricidad Avanzada': '‚ö°', 'El√©ctrico Experto': '‚ö°',
      'Refrigeraci√≥n': '‚ùÑÔ∏è', 'Refrigeraci√≥n Comercial': '‚ùÑÔ∏è',
      'Diagn√≥stico': 'üîç', 'Diagn√≥stico Avanzado': 'üîç', 'Diagn√≥stico Refrigeraci√≥n': 'üîç', 'Diagn√≥stico Experto': 'üîç',
      'Diagramas El√©ctricos': 'üìê',
      'Componentes': '‚öôÔ∏è',
      'Superheat/Subcooling': 'üå°Ô∏è',
      'Split/Mini-Split': 'üåÄ',
      'Carga Refrigerante': 'üìä',
      'V√°lvulas y Controles': 'üéõÔ∏è',
      'Controles': 'üéõÔ∏è', 'Controles El√©ctricos': 'üîå', 'Controles Experto': 'üéõÔ∏è',
      'Calefacci√≥n': 'üî•', 'Calefacci√≥n Gas': 'üî•',
      'Bomba de Calor': 'üè†',
      'Sistemas Comerciales': 'üè¢', 'HVAC Comercial': 'üè¢', 'Comercial Avanzado': 'üè¢', 'Comercial Experto': 'üè¢',
      'Eficiencia': 'üìà', 'Eficiencia Energ√©tica': 'üìà',
      'Refrigerantes': 'üß™', 'Manejo de Refrigerantes': 'üß™', 'Refrigerantes Avanzado': 'üß™',
      'Seguridad': '‚ö†Ô∏è', 'Seguridad Completa': '‚ö†Ô∏è',
      'Mantenimiento': 'üõ†Ô∏è', 'Mantenimiento Comercial': 'üõ†Ô∏è', 'Mantenimiento Experto': 'üõ†Ô∏è',
      'EPA 608': 'üìú', 'EPA Avanzado': 'üìú',
      'OSHA': 'ü¶∫', 'OSHA 30': 'ü¶∫', 'OSHA Avanzado': 'ü¶∫',
      'Troubleshooting': 'üîç',
      'Liderazgo': 'üë∑', 'Leadership': 'üë∑', 'Liderazgo Final': 'üë∑',
      'Soporte T√©cnico': 'üìû',
      'Dise√±o de Sistemas': 'üìê',
      'C√≥digos y Permisos': 'üìã', 'C√≥digos': 'üìã', 'C√≥digos y Est√°ndares': 'üìã',
      'Clientes y Estimaciones': 'ü§ù', 'Servicio Cliente': 'ü§ù',
      'Industrial': 'üè≠', 'Industrial Avanzado': 'üè≠',
      'Finanzas': 'üí∞', 'Finanzas Avanzado': 'üí∞',
      'Marketing': 'üì¢', 'Marketing Experto': 'üì¢',
      'Legal': '‚öñÔ∏è', 'Legal Experto': '‚öñÔ∏è',
      'Ventas Reemplazo': 'üíµ', 'Ventas Experto': 'üíµ',
      'Supervisi√≥n': 'üëî', 'Supervisi√≥n T√©cnica': 'üëî',
      'Proyectos': 'üìä', 'Proyectos Experto': 'üìä',
      'Administraci√≥n': 'üèõÔ∏è', 'Administraci√≥n Avanzada': 'üèõÔ∏è',
      'Gesti√≥n Personal': 'üß†', 'Gesti√≥n Avanzada': 'üß†',
      'Residencial Avanzado': 'üè†', 'Residencial Experto': 'üè†',
      'Escenario de Campo': 'üéØ', 'Escenario Integrado': 'üéØ', 'Escenario T√©cnico': 'üéØ', 'Escenario Final': 'üéØ',
      'T√©cnico Avanzado': 'üîß', 'T√©cnico Residencial': 'üîß', 'T√©cnico Comercial': 'üè¢',
      'Equipos Espec√≠ficos': '‚öôÔ∏è', 'Tecnolog√≠a': 'üíª'
    };

    async function renderStudyLevelTabs() {
      await loadQuestions();
      const container = document.getElementById('studyLevelTabs');
      container.innerHTML = '';

      levels.forEach(level => {
        if (questions[level.id] && questions[level.id].length > 0) {
          const tab = document.createElement('button');
          const isLocked = level.id !== 'principiante' && !hasAppAccess();
          tab.className = 'study-level-tab' + (level.id === currentStudyLevel ? ' active' : '');
          tab.textContent = `${isLocked ? 'üîí' : level.icon} ${level.name}`;
          if (isLocked) {
            tab.style.opacity = '0.6';
          }
          tab.onclick = () => {
            if (isLocked) {
              showPurchaseModal();
              return;
            }
            currentStudyLevel = level.id;
            renderStudyLevelTabs();
            renderStudyCategories();
          };
          container.appendChild(tab);
        }
      });
    }

    function getQuestionsGroupedByCategory(levelId) {
      let levelQuestions = questions[levelId] || [];
      
      // Limit principiante to 50 questions in study mode if no app access (probadita)
      if (levelId === 'principiante' && !hasAppAccess()) {
        levelQuestions = levelQuestions.slice(0, 50);
      }
      
      const grouped = {};

      levelQuestions.forEach(q => {
        if (!grouped[q.category]) {
          grouped[q.category] = [];
        }
        grouped[q.category].push(q);
      });

      return grouped;
    }

    function renderStudyCategories() {
      const container = document.getElementById('studyCategoriesList');
      container.innerHTML = '';

      const grouped = getQuestionsGroupedByCategory(currentStudyLevel);
      const categories = Object.keys(grouped);

      if (categories.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#64748b;">No hay preguntas disponibles para este nivel.</p>';
        return;
      }

      categories.forEach(category => {
        const count = grouped[category].length;
        const icon = categoryIcons[category] || 'üìã';

        const card = document.createElement('div');
        card.className = 'study-category-card';
        card.innerHTML = `
          <div class="study-category-info">
            <h3>${category}</h3>
            <p>${count} pregunta${count !== 1 ? 's' : ''}</p>
          </div>
          <div class="study-category-icon">${icon}</div>
        `;
        card.onclick = () => showStudyCategoryDetail(category);
        container.appendChild(card);
      });
    }

    // Specialty-to-category mapping for the 9-grid view
    const specialtyMap = {
      'electricidad-residencial': {
        name: '‚ö° Electricidad Residencial',
        keywords: ['Electricidad', 'Diagramas El√©ctricos', 'Controles El√©ctricos']
      },
      'electricidad-comercial': {
        name: '‚ö° Electricidad Comercial',
        keywords: ['Electricidad Avanzada', 'Controles', 'Controles Experto']
      },
      'electricidad-industrial': {
        name: '‚ö° Electricidad Industrial',
        keywords: ['El√©ctrico Experto', 'Industrial', 'Industrial Avanzado']
      },
      'ac-residencial': {
        name: '‚ùÑÔ∏è Aire Acondicionado Residencial',
        keywords: ['Instalaci√≥n', 'Split/Mini-Split', 'Herramientas', 'Herramientas Experto', 'Tuber√≠a', 'Soldadura', 'Vac√≠o', 'Carga Refrigerante', 'Superheat/Subcooling', 'Mantenimiento', 'Residencial Avanzado', 'Residencial Experto', 'T√©cnico Residencial', 'T√©cnico Avanzado', 'Bomba de Calor', 'Calefacci√≥n', 'Calefacci√≥n Gas', 'Componentes', 'V√°lvulas y Controles']
      },
      'ac-comercial': {
        name: '‚ùÑÔ∏è Aire Acondicionado Comercial',
        keywords: ['Sistemas Comerciales', 'HVAC Comercial', 'Comercial Avanzado', 'Comercial Experto', 'T√©cnico Comercial', 'Mantenimiento Comercial', 'Instalaci√≥n Experto', 'Mantenimiento Experto']
      },
      'ac-industrial': {
        name: '‚ùÑÔ∏è Aire Acondicionado Industrial',
        keywords: ['Dise√±o de Sistemas', 'Eficiencia', 'Eficiencia Energ√©tica', 'Equipos Espec√≠ficos', 'Tecnolog√≠a']
      },
      'refri-residencial': {
        name: 'üßä Refrigeraci√≥n Residencial',
        keywords: ['Refrigeraci√≥n', 'Refrigerantes', 'Manejo de Refrigerantes', 'Recovery']
      },
      'refri-comercial': {
        name: 'üßä Refrigeraci√≥n Comercial',
        keywords: ['Refrigeraci√≥n Comercial', 'Refrigerantes Avanzado', 'Diagn√≥stico Refrigeraci√≥n', 'Diagn√≥stico', 'Diagn√≥stico Avanzado', 'Diagn√≥stico Experto', 'Troubleshooting']
      },
      'refri-industrial': {
        name: 'üßä Refrigeraci√≥n Industrial',
        keywords: ['EPA 608', 'EPA Avanzado', 'OSHA', 'OSHA 30', 'OSHA Avanzado', 'Seguridad', 'Seguridad Completa', 'C√≥digos y Permisos', 'C√≥digos', 'C√≥digos y Est√°ndares', 'Soporte T√©cnico', 'Liderazgo', 'Leadership', 'Liderazgo Final', 'Clientes y Estimaciones', 'Servicio Cliente', 'Finanzas', 'Finanzas Avanzado', 'Marketing', 'Marketing Experto', 'Legal', 'Legal Experto', 'Ventas Reemplazo', 'Ventas Experto', 'Supervisi√≥n', 'Supervisi√≥n T√©cnica', 'Proyectos', 'Proyectos Experto', 'Administraci√≥n', 'Administraci√≥n Avanzada', 'Gesti√≥n Personal', 'Gesti√≥n Avanzada', 'Escenario de Campo', 'Escenario Integrado', 'Escenario T√©cnico', 'Escenario Final']
      },
      'acca-residencial': {
        name: 'üìò Manuales ACCA ‚Äî Residencial',
        keywords: ['ACCA', 'Manual J', 'Manual D', 'Manual S', 'Manual T', 'Carga T√©rmica', 'Dise√±o Ductos']
      },
      'acca-comercial': {
        name: 'üìò ACCA ‚Äî A/C Comercial',
        keywords: ['ACCA Comercial', 'Manual N', 'Manual CS', 'Manual H', 'Carga Comercial']
      },
      'ashrae': {
        name: 'üìó Manuales ASHRAE',
        keywords: ['ASHRAE', 'Est√°ndar 62', 'Est√°ndar 90', 'Est√°ndar 55', 'Calidad Aire', 'Ventilaci√≥n', 'Confort T√©rmico']
      },
      'nec': {
        name: 'üìï C√≥digo NEC',
        keywords: ['NEC', 'National Electrical Code', 'C√≥digo El√©ctrico', 'Art√≠culo 210', 'Art√≠culo 220', 'Art√≠culo 230', 'Art√≠culo 240', 'Art√≠culo 250', 'Art√≠culo 310', 'Art√≠culo 430', 'Art√≠culo 440']
      },
      'nfpa54': {
        name: 'üìô C√≥digo NFPA 54',
        keywords: ['NFPA 54', 'NFPA', 'C√≥digo Gas', 'Gas Natural', 'Gas LP', 'Tuber√≠a Gas', 'Venteo', 'Combusti√≥n']
      },
      'bpi': {
        name: 'üèõÔ∏è Certificaci√≥n BPI',
        keywords: ['BPI', 'Building Performance', 'Eficiencia Energ√©tica', 'Auditor√≠a Energ√©tica', 'Envolvente', 'Infiltraci√≥n', 'Weatherization']
      }
    };

    let currentSpecialty = null;

    function showSpecialtyCategories(specialtyId) {
      currentSpecialty = specialtyId;
      const specialty = specialtyMap[specialtyId];
      if (!specialty) return;

      // Hide the grid and level tabs, show subcategories
      document.getElementById('specialtyGrid').style.display = 'none';
      document.getElementById('studyLevelTabs').style.display = 'none';
      document.getElementById('specialtySubcategories').style.display = 'block';
      document.getElementById('specialtyTitle').textContent = specialty.name;

      // Get all questions across all levels, filter by specialty keywords
      const container = document.getElementById('studyCategoriesList');
      container.innerHTML = '';

      const allGrouped = {};
      const levelOrder = ['principiante', 'intermedio', 'avanzado', 'elite', 'platino'];

      levelOrder.forEach(levelId => {
        const levelQuestions = questions[levelId] || [];
        levelQuestions.forEach(q => {
          if (specialty.keywords.some(kw => q.category === kw || q.category.includes(kw) || kw.includes(q.category))) {
            const key = q.category;
            if (!allGrouped[key]) allGrouped[key] = { questions: [], level: levelId };
            allGrouped[key].questions.push(q);
          }
        });
      });

      const cats = Object.keys(allGrouped);
      if (cats.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#64748b;padding:20px;">Pr√≥ximamente ‚Äî estamos preparando las preguntas para esta especialidad.</p>';
        return;
      }

      cats.forEach(cat => {
        const count = allGrouped[cat].questions.length;
        const icon = categoryIcons[cat] || 'üìã';
        const isLocked = allGrouped[cat].level !== 'principiante' && !hasAppAccess();

        const card = document.createElement('div');
        card.className = 'study-category-card';
        card.innerHTML = `
          <div class="study-category-info">
            <h3>${isLocked ? 'üîí ' : ''}${cat}</h3>
            <p>${count} pregunta${count !== 1 ? 's' : ''}</p>
          </div>
          <div class="study-category-icon">${icon}</div>
        `;
        if (isLocked) {
          card.style.opacity = '0.6';
          card.onclick = () => showPurchaseModal();
        } else {
          card.onclick = () => {
            // Set the level for detail view
            currentStudyLevel = allGrouped[cat].level;
            showStudyCategoryDetail(cat);
          };
        }
        container.appendChild(card);
      });

      // Also add unmatched categories under a "Otros" section if this is a broad specialty
    }

    function showStudyCategoryDetail(category) {
      const grouped = getQuestionsGroupedByCategory(currentStudyLevel);
      const categoryQuestions = grouped[category] || [];
      const levelName = levels.find(l => l.id === currentStudyLevel)?.name || currentStudyLevel;

      document.getElementById('studyBreadcrumb').textContent = `${levelName} > ${category}`;
      document.getElementById('studyCategoryTitle').textContent = category;
      document.getElementById('studyCategorySubtitle').textContent = `${categoryQuestions.length} pregunta${categoryQuestions.length !== 1 ? 's' : ''}`;

      const container = document.getElementById('studyQuestionsList');
      container.innerHTML = '';

      const letters = ['A', 'B', 'C', 'D'];

      categoryQuestions.forEach((q, index) => {
        const card = document.createElement('div');
        card.className = 'study-question-card';

        let optionsHtml = '';
        q.options.forEach((opt, i) => {
          const isCorrect = i === q.correct;
          optionsHtml += `
            <div class="study-option${isCorrect ? ' correct-answer' : ''}">
              <div class="study-option-letter">${letters[i]}</div>
              <span>${opt}</span>
              ${isCorrect ? '<span style="margin-left:auto; color:#27ae60;">‚úì</span>' : ''}
            </div>
          `;
        });

        card.innerHTML = `
          <span class="study-question-number">Pregunta ${index + 1}</span>
          <div class="study-question-text">${q.q}</div>
          <div class="study-options">${optionsHtml}</div>
          <div class="study-explanation">
            <div class="study-explanation-title">üí° Explicaci√≥n</div>
            <div class="study-explanation-text">${q.explanation}</div>
          </div>
        `;

        container.appendChild(card);
      });

      // Track lesson (study category) opened as lastActivity
      updateLastActivity('lesson', currentStudyLevel, category, null, 'studyCategoryDetailScreen');
      showScreen('studyCategoryDetailScreen');
    }

    // Override showScreen to initialize study sections when needed
    const originalShowScreen = showScreen;
    showScreen = function(screenId) {
      originalShowScreen(screenId);
      if (screenId === 'studySectionsScreen') {
        renderStudyLevelTabs();
        renderStudyCategories();
        // Reset to grid view
        document.getElementById('specialtyGrid').style.display = 'grid';
        document.getElementById('specialtySubcategories').style.display = 'none';
        document.getElementById('studyLevelTabs').style.display = 'flex';
      }
      if (screenId === 'videoLessonsScreen') {
        // Load videos from YouTube if not already loaded
        if (!youtubeVideosLoaded || videoLessons.length === 0) {
          loadYouTubeVideos();
        } else {
          renderVideoLessonsList();
        }
      }
      if (screenId === 'adminDashboardScreen') {
        renderAdminDashboard();
        loadAdminAttendance();
        try { loadFinanzasData(); } catch(e) {}
        try { loadInactivityAlerts(); } catch(e) {}
        try { loadCalendarData(); } catch(e) {}
        try { loadReferidosData(); } catch(e) {}
        try { loadW9Reviews(); } catch(e) {}
        try { loadAmbassadorPayments(); } catch(e) {}
        try { loadAnalytics(); } catch(e) {}
        try { loadAdminCertificates(); } catch(e) {}
      }
    };

    // ==================== VIDEO LESSONS SECTION ====================

    // Load video progress from localStorage
    function loadVideoProgress() {
      const saved = localStorage.getItem('tecnico_videoProgress');
      if (saved) {
        videoProgress = JSON.parse(saved);
      }
    }

    // Save video progress to localStorage
    function saveVideoProgress() {
      localStorage.setItem('tecnico_videoProgress', JSON.stringify(videoProgress));
    }

    // Format time in MM:SS format
    function formatVideoTime(seconds) {
      if (!seconds || isNaN(seconds)) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Get video progress for a specific video
    function getVideoProgress(videoId) {
      return videoProgress[videoId] || {
        lastPlaybackTime: 0,
        duration: 0,
        completed: false,
        watchedPercentage: 0,
        updatedAt: null
      };
    }

    // Update video progress
    function updateVideoProgress(videoId, currentTime, duration) {
      const watchedPercentage = duration > 0 ? Math.round((currentTime / duration) * 100) : 0;
      const completed = watchedPercentage >= VIDEO_COMPLETION_THRESHOLD;

      videoProgress[videoId] = {
        lastPlaybackTime: currentTime,
        duration: duration,
        completed: completed,
        watchedPercentage: watchedPercentage,
        updatedAt: new Date().toISOString()
      };

      saveVideoProgress();
      updateVideoPlayerUI();
    }

    // Mark video as completed (manual override)
    function markVideoAsWatched() {
      if (!currentVideoId) return;

      const video = document.getElementById('videoPlayer');
      const duration = video.duration || videoLessons.find(v => v.id === currentVideoId)?.duration || 0;

      videoProgress[currentVideoId] = {
        lastPlaybackTime: duration,
        duration: duration,
        completed: true,
        watchedPercentage: 100,
        updatedAt: new Date().toISOString()
      };

      saveVideoProgress();
      updateVideoPlayerUI();

      // Track activity
      updateLastActivity('video', currentVideoId, null, null, 'videoPlayerScreen');
    }

    // Start auto-save interval for video progress
    function startVideoAutoSave() {
      stopVideoAutoSave(); // Clear any existing interval

      videoAutoSaveInterval = setInterval(() => {
        if (!currentVideoId) return;

        const video = document.getElementById('videoPlayer');
        if (video && !video.paused && video.currentTime > 0) {
          updateVideoProgress(currentVideoId, video.currentTime, video.duration);
        }
      }, VIDEO_AUTO_SAVE_INTERVAL);
    }

    // Stop auto-save interval
    function stopVideoAutoSave() {
      if (videoAutoSaveInterval) {
        clearInterval(videoAutoSaveInterval);
        videoAutoSaveInterval = null;
      }
    }

    // Update video player UI (progress bar, status, CTA button)
    function updateVideoPlayerUI() {
      if (!currentVideoId) return;

      const progress = getVideoProgress(currentVideoId);
      const video = document.getElementById('videoPlayer');
      const currentTime = video ? video.currentTime : progress.lastPlaybackTime;
      const duration = video && video.duration ? video.duration : progress.duration;

      // Update progress bar
      const progressFill = document.getElementById('videoProgressFill');
      const progressText = document.getElementById('videoProgressText');

      if (progressFill && duration > 0) {
        const percentage = (currentTime / duration) * 100;
        progressFill.style.width = `${percentage}%`;
      }

      if (progressText) {
        progressText.textContent = `${formatVideoTime(currentTime)} / ${formatVideoTime(duration)}`;
      }

      // Update status badge
      const statusBadge = document.getElementById('videoStatusBadge');
      const statusIcon = document.getElementById('videoStatusIcon');
      const statusTitle = document.getElementById('videoStatusTitle');
      const statusDetail = document.getElementById('videoStatusDetail');

      if (progress.completed) {
        statusBadge.className = 'video-status video-completed-badge';
        statusIcon.textContent = '‚úÖ';
        statusTitle.textContent = 'Video completado';
        statusDetail.textContent = '100% visto';
      } else if (progress.lastPlaybackTime > 0) {
        statusBadge.className = 'video-status video-in-progress-badge';
        statusIcon.textContent = '‚ñ∂Ô∏è';
        statusTitle.textContent = 'En progreso';
        statusDetail.textContent = `${progress.watchedPercentage}% completado`;
      } else {
        statusBadge.className = 'video-status';
        statusIcon.textContent = 'üé¨';
        statusTitle.textContent = 'No iniciado';
        statusDetail.textContent = 'Comienza a ver este video';
      }

      // Update CTA button
      const ctaButton = document.getElementById('videoCTAButton');
      const markAsWatchedBtn = document.getElementById('videoMarkAsWatchedBtn');

      if (progress.completed) {
        ctaButton.textContent = 'Video completado';
        ctaButton.className = 'btn btn-video-completed';
        ctaButton.disabled = true;
        markAsWatchedBtn.style.display = 'none';
      } else if (progress.lastPlaybackTime > 0) {
        ctaButton.textContent = 'Continuar video';
        ctaButton.className = 'btn btn-video-primary';
        ctaButton.disabled = false;
        markAsWatchedBtn.style.display = 'block';
      } else {
        ctaButton.textContent = 'Iniciar video';
        ctaButton.className = 'btn btn-video-primary';
        ctaButton.disabled = false;
        markAsWatchedBtn.style.display = 'block';
      }
    }

    // Handle CTA button click
    function handleVideoCTA() {
      const video = document.getElementById('videoPlayer');
      const progress = getVideoProgress(currentVideoId);

      if (progress.completed) return;

      if (video.paused) {
        video.play();
      } else {
        video.pause();
      }
    }

    // Render video lessons list
    function renderVideoLessonsList() {
      loadVideoProgress();

      const container = document.getElementById('videoLessonsList');
      container.innerHTML = '';

      if (videoLessons.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#64748b; padding:20px;">No hay video lecciones disponibles.</p>';
        return;
      }
      
      // Filter videos by current filter
      let filteredVideos = videoLessons;
      if (currentVideoFilter !== 'all') {
        filteredVideos = videoLessons.filter(v => v.category === currentVideoFilter);
      }
      
      // Update category tabs
      updateVideoTabs();
      
      // Update progress summary
      updateVideoProgressSummary();
      
      // Group videos by category
      const groupedVideos = {};
      filteredVideos.forEach(video => {
        const cat = video.category || 'otros';
        if (!groupedVideos[cat]) {
          groupedVideos[cat] = [];
        }
        groupedVideos[cat].push(video);
      });
      
      // Render each category
      videoCategories.forEach(category => {
        const videos = groupedVideos[category.id];
        if (!videos || videos.length === 0) return;
        
        const section = document.createElement('div');
        section.className = 'video-category-section';
        
        // Category header
        const header = document.createElement('div');
        header.className = 'video-category-header';
        header.innerHTML = `<span style="font-size:20px;">${category.icon}</span><h3>${category.name}</h3><span style="color:#64748b; font-size:12px; margin-left:auto;">${videos.length} videos</span>`;
        section.appendChild(header);
        
        // Videos in this category
        videos.forEach(video => {
          const progress = getVideoProgress(video.id);
          const card = document.createElement('div');
          
          let statusClass = '';
          if (progress.completed) {
            statusClass = 'completed';
          } else if (progress.lastPlaybackTime > 0) {
            statusClass = 'in-progress';
          }
          
          card.className = `video-card ${statusClass}`;
          
          const durationFormatted = formatVideoTime(video.duration);
          const progressPercentage = progress.watchedPercentage || 0;
          
          let statusBadge = '';
          if (progress.completed) {
            statusBadge = '<span style="color:#27ae60;">‚úÖ</span>';
          } else if (progress.lastPlaybackTime > 0) {
            statusBadge = `<span style="color:#f39c12;">${progressPercentage}%</span>`;
          }
          
          card.innerHTML = `
            <img class="video-thumbnail" src="${video.thumbnail}" alt="${video.title}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%2268%22><rect fill=%22%23333%22 width=%22120%22 height=%2268%22/><text fill=%22%23666%22 x=%2260%22 y=%2238%22 text-anchor=%22middle%22>üé¨</text></svg>'">
            <div class="video-card-info">
              <h4>${video.title}</h4>
              <p>${video.description.substring(0, 80)}${video.description.length > 80 ? '...' : ''}</p>
              <div class="video-card-meta">
                <span>‚è±Ô∏è ${durationFormatted}</span>
                ${video.views ? `<span>üëÅÔ∏è ${formatViews(video.views)}</span>` : ''}
                ${statusBadge}
              </div>
            </div>
          `;

          card.onclick = () => openVideoPlayer(video.id);
          section.appendChild(card);
        });
        
        container.appendChild(section);
      });
    }
    
    // Update video tabs based on available categories
    function updateVideoTabs() {
      const tabsContainer = document.getElementById('videoLevelTabs');
      tabsContainer.innerHTML = `<button class="video-level-tab ${currentVideoFilter === 'all' ? 'active' : ''}" data-level="all" onclick="filterVideosByLevel('all')">üìö Todos (${videoLessons.length})</button>`;
      
      // Count videos per category
      const categoryCounts = {};
      videoLessons.forEach(v => {
        const cat = v.category || 'otros';
        categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
      });
      
      // Add tabs for categories with videos
      videoCategories.forEach(cat => {
        if (categoryCounts[cat.id]) {
          const isActive = currentVideoFilter === cat.id ? 'active' : '';
          tabsContainer.innerHTML += `<button class="video-level-tab ${isActive}" data-level="${cat.id}" onclick="filterVideosByLevel('${cat.id}')">${cat.icon} ${cat.name} (${categoryCounts[cat.id]})</button>`;
        }
      });
    }
    
    // Update progress summary
    function updateVideoProgressSummary() {
      let watchedCount = 0;
      videoLessons.forEach(video => {
        const progress = getVideoProgress(video.id);
        if (progress.completed) watchedCount++;
      });
      
      const total = videoLessons.length;
      const percent = total > 0 ? Math.round((watchedCount / total) * 100) : 0;
      
      document.getElementById('videosWatchedCount').textContent = watchedCount;
      document.getElementById('videosTotalCount').textContent = total;
      document.getElementById('videosCompletionPercent').textContent = percent + '%';
    }

    // Open video player
    function openVideoPlayer(videoId) {
      currentVideoId = videoId;
      loadVideoProgress();

      const lesson = videoLessons.find(v => v.id === videoId);
      if (!lesson) return;

      // Update UI
      document.getElementById('videoBreadcrumb').textContent = `Video Lecciones > ${lesson.title}`;
      document.getElementById('videoTitle').textContent = lesson.title;
      document.getElementById('videoDescription').textContent = lesson.description;

      const playerContainer = document.getElementById('videoPlayerContainer');
      const youtubeWrapper = document.getElementById('youtubePlayerWrapper');
      const htmlVideo = document.getElementById('videoPlayer');
      const ctaButton = document.getElementById('videoCTAButton');
      const markWatchedBtn = document.getElementById('videoMarkAsWatchedBtn');
      
      // Check if it's a YouTube video
      if (lesson.isYouTube && lesson.youtubeId) {
        // Hide HTML5 video, show YouTube embed
        htmlVideo.style.display = 'none';
        
        // Get saved progress
        const progress = getVideoProgress(videoId);
        const startTime = progress.lastPlaybackTime > 0 ? Math.floor(progress.lastPlaybackTime) : 0;
        
        // Create YouTube embed WITHOUT autoplay - user controls playback
        youtubeWrapper.innerHTML = `
          <iframe 
            class="youtube-embed"
            src="https://www.youtube.com/embed/${lesson.youtubeId}?start=${startTime}&rel=0&modestbranding=1"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          ></iframe>
        `;
        
        // Hide the CTA button for YouTube videos (player has its own controls)
        ctaButton.style.display = 'none';
        markWatchedBtn.style.display = 'block';
        
        // Update status
        updateYouTubePlayerUI(lesson, progress);
        
      } else {
        // Regular HTML5 video (fallback)
        youtubeWrapper.innerHTML = '';
        htmlVideo.style.display = 'block';
        htmlVideo.src = lesson.videoUrl;

        // Get saved progress
        const progress = getVideoProgress(videoId);

        // Setup event listeners
        htmlVideo.onloadedmetadata = () => {
          if (progress.lastPlaybackTime > 0 && progress.lastPlaybackTime < htmlVideo.duration) {
            htmlVideo.currentTime = progress.lastPlaybackTime;
          }
          updateVideoPlayerUI();
        };

        htmlVideo.ontimeupdate = () => {
          updateVideoPlayerUI();
        };

        htmlVideo.onplay = () => {
          startVideoAutoSave();
          const ctaButton = document.getElementById('videoCTAButton');
          if (!getVideoProgress(currentVideoId).completed) {
            ctaButton.textContent = 'Pausar video';
          }
        };

        htmlVideo.onpause = () => {
          if (currentVideoId && htmlVideo.currentTime > 0) {
            updateVideoProgress(currentVideoId, htmlVideo.currentTime, htmlVideo.duration);
          }
          const ctaButton = document.getElementById('videoCTAButton');
          const progress = getVideoProgress(currentVideoId);
          if (!progress.completed) {
            ctaButton.textContent = progress.lastPlaybackTime > 0 ? 'Continuar video' : 'Iniciar video';
          }
        };

        htmlVideo.onended = () => {
          updateVideoProgress(currentVideoId, htmlVideo.duration, htmlVideo.duration);
          stopVideoAutoSave();
        };

        document.addEventListener('visibilitychange', handleVisibilityChange);
        window.addEventListener('beforeunload', saveProgressBeforeUnload);
      }

      // Track activity
      updateLastActivity('video', videoId, null, null, 'videoPlayerScreen');

      // Update UI
      updateVideoPlayerUI();
      showScreen('videoPlayerScreen');
    }
    
    // Update YouTube player UI
    function updateYouTubePlayerUI(lesson, progress) {
      const statusBadge = document.getElementById('videoStatusBadge');
      const statusIcon = document.getElementById('videoStatusIcon');
      const statusTitle = document.getElementById('videoStatusTitle');
      const statusDetail = document.getElementById('videoStatusDetail');
      const progressFill = document.getElementById('videoProgressFill');
      const progressText = document.getElementById('videoProgressText');
      const ctaButton = document.getElementById('videoCTAButton');
      
      const percentage = progress.watchedPercentage || 0;
      
      if (progress.completed) {
        statusBadge.className = 'video-status video-completed-badge';
        statusIcon.textContent = '‚úÖ';
        statusTitle.textContent = 'Completado';
        statusDetail.textContent = '100% visto';
        ctaButton.textContent = 'Ver de nuevo';
        ctaButton.className = 'btn btn-video-completed';
      } else if (progress.lastPlaybackTime > 0) {
        statusBadge.className = 'video-status video-in-progress-badge';
        statusIcon.textContent = '‚ñ∂Ô∏è';
        statusTitle.textContent = 'Continuando...';
        statusDetail.textContent = `${percentage}% visto`;
        ctaButton.textContent = 'Reproduciendo...';
        ctaButton.className = 'btn btn-video-primary';
      } else {
        statusBadge.className = 'video-status';
        statusIcon.textContent = '‚ñ∂Ô∏è';
        statusTitle.textContent = 'Reproduciendo';
        statusDetail.textContent = 'Video iniciado';
        ctaButton.textContent = 'Reproduciendo...';
        ctaButton.className = 'btn btn-video-primary';
      }
      
      progressFill.style.width = `${percentage}%`;
      progressText.textContent = `Duraci√≥n: ${formatVideoTime(lesson.duration)}`;
    }

    // Handle visibility change (save progress when user switches tabs)
    function handleVisibilityChange() {
      if (document.hidden && currentVideoId) {
        const video = document.getElementById('videoPlayer');
        if (video && video.currentTime > 0) {
          updateVideoProgress(currentVideoId, video.currentTime, video.duration);
        }
      }
    }

    // Save progress before page unload
    function saveProgressBeforeUnload() {
      if (currentVideoId) {
        const video = document.getElementById('videoPlayer');
        if (video && video.currentTime > 0) {
          updateVideoProgress(currentVideoId, video.currentTime, video.duration);
        }
      }
    }

    // Exit video player
    function exitVideoPlayer() {
      // Save progress before exiting
      if (currentVideoId) {
        const video = document.getElementById('videoPlayer');
        if (video && video.currentTime > 0) {
          updateVideoProgress(currentVideoId, video.currentTime, video.duration);
        }
      }

      stopVideoAutoSave();

      // Cleanup event listeners
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      window.removeEventListener('beforeunload', saveProgressBeforeUnload);

      // Pause and reset HTML5 video
      const video = document.getElementById('videoPlayer');
      if (video) {
        video.pause();
        video.src = '';
      }
      
      // Clear YouTube embed
      const youtubeWrapper = document.getElementById('youtubePlayerWrapper');
      if (youtubeWrapper) {
        youtubeWrapper.innerHTML = '';
      }
      
      // Restore CTA button visibility
      const ctaButton = document.getElementById('videoCTAButton');
      if (ctaButton) {
        ctaButton.style.display = 'block';
      }

      currentVideoId = null;
      showScreen('videoLessonsScreen');
    }

    // ==================== END VIDEO LESSONS SECTION ====================

    // ==================== ADMIN SECTION ====================

    // Admin credentials
    const ADMIN_USER = 'admin33';
    const ADMIN_PASS = 'AdminAcvolt33$';
    var currentAdminRole = ''; // 'master' or 'student_success'
    var currentAdminName = '';

    // Membership credentials
    // ========== MEMBERSHIP CODE SYSTEM (Supabase) ==========
    
    async function getMembershipCodes() {
      if (supabaseClient && isOnline) {
        try {
          const { data, error } = await supabaseClient.from('access_codes').select('*').eq('type', 'membership');
          if (!error && data) {
            const codes = {};
            data.forEach(row => { codes[row.code] = row; });
            localStorage.setItem('maestroac_membership_codes', JSON.stringify(codes));
            return codes;
          }
        } catch(e) { console.log('Supabase membership error:', e); }
      }
      return JSON.parse(localStorage.getItem('maestroac_membership_codes') || '{}');
    }

    // Membership state
    let membershipAuthenticated = false;
    let currentMembership = null; // {tier, activa, email, stripe_subscription_id}

    // ============ NEW MEMBERSHIP SYSTEM (Supabase-based) ============

    async function openMembershipZone() {
      showScreen('membershipZoneScreen');
      document.getElementById('membershipLoading').style.display = 'block';
      document.getElementById('membershipActiveContent').style.display = 'none';
      document.getElementById('membershipPaywall').style.display = 'none';

      const email = (currentUser && currentUser.email) ? currentUser.email : localStorage.getItem('tecnico_email');
      if (!email) {
        document.getElementById('membershipLoading').style.display = 'none';
        document.getElementById('membershipPaywall').style.display = 'block';
        return;
      }

      const membership = await checkMembership(email);
      document.getElementById('membershipLoading').style.display = 'none';

      if (membership && membership.activa) {
        currentMembership = membership;
        membershipAuthenticated = true;
        const tierNames = { bronze: 'ü•â Principiante', silver: 'ü•à Intermedio', gold: 'ü•á Avanzado - Mentor√≠a' };
        document.getElementById('memberTierTitle').textContent = (tierNames[membership.tipo] || 'Miembro') + ' ‚≠ê';
        document.getElementById('memberWelcomeName').textContent = 'Bienvenido, ' + (currentUser.nombre || email);
        document.getElementById('membershipActiveContent').style.display = 'block';
        await loadWebinarLinks(membership.tipo);
        loadPregrabadoContent(membership.tipo);
      } else {
        document.getElementById('memberTierTitle').textContent = 'Suscr√≠bete';
        document.getElementById('membershipPaywall').style.display = 'block';
      }
    }

    async function checkMembership(email) {
      if (!supabaseClient || !isOnline) {
        // Fallback: check localStorage cache
        const cached = localStorage.getItem('maestroac_membership_cache_' + email);
        if (cached) {
          try { return JSON.parse(cached); } catch(e) {}
        }
        return null;
      }
      try {
        const { data, error } = await supabaseClient
          .from('memberships')
          .select('*')
          .eq('email', email)
          .eq('activa', true)
          .order('amount', { ascending: false })
          .limit(1);
        
        if (error || !data || data.length === 0) {
          localStorage.removeItem('maestroac_membership_cache_' + email);
          return null;
        }
        
        const membership = data[0];
        // Auto-connect user_id if missing (Escenario B)
        if (!membership.user_id && currentUser) {
          const { data: authData } = await supabaseClient.auth.getUser();
          if (authData && authData.user) {
            await supabaseClient
              .from('memberships')
              .update({ user_id: authData.user.id })
              .eq('id', membership.id);
            membership.user_id = authData.user.id;
          }
        }
        
        // Cache for offline
        localStorage.setItem('maestroac_membership_cache_' + email, JSON.stringify(membership));
        return membership;
      } catch(e) {
        console.error('Error checking membership:', e);
        return null;
      }
    }

    // Check for failed/expired Stripe payments
    async function checkFailedPayment(email) {
      if (!supabaseClient || !isOnline || !email) return;
      try {
        // Look for inactive memberships (payment failed or canceled)
        const { data } = await supabaseClient
          .from('memberships')
          .select('*')
          .eq('email', email)
          .eq('activa', false)
          .order('updated_at', { ascending: false })
          .limit(1);
        
        if (data && data.length > 0) {
          const m = data[0];
          // Only show notification if membership was recently deactivated (last 30 days)
          const updatedDate = new Date(m.updated_at || m.fecha_inicio);
          const daysSince = Math.floor((Date.now() - updatedDate) / (1000 * 60 * 60 * 24));
          if (daysSince <= 30) {
            showPaymentFailedNotification(m);
          }
        }
      } catch(e) { console.log('Failed payment check error:', e); }
    }

    function showPaymentFailedNotification(membership) {
      var tierNames = { bronze: 'Principiante $119/mes', silver: 'Intermedio $299/mes', gold: 'Avanzado $699/mes' };
      var tierName = tierNames[membership.tipo] || 'Membres√≠a';
      
      var notif = document.createElement('div');
      notif.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:99999;max-width:420px;width:90%;animation:slideDown 0.5s ease;';
      notif.innerHTML = '<div style="background:linear-gradient(135deg,#e74c3c,#c0392b);border-radius:16px;padding:20px;box-shadow:0 8px 30px rgba(231,76,60,0.5);">' +
        '<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">' +
        '<span style="font-size:28px;">‚ö†Ô∏è</span>' +
        '<div><strong style="color:#fff;font-size:16px;">Pago No Procesado</strong>' +
        '<div style="color:rgba(255,255,255,0.8);font-size:12px;">Tu membres√≠a ' + tierName + ' est√° suspendida</div></div>' +
        '</div>' +
        '<p style="color:rgba(255,255,255,0.9);font-size:13px;margin-bottom:15px;">Tu √∫ltimo pago no se pudo procesar. Actualiza tu m√©todo de pago para reactivar tu acceso a clases en vivo y contenido exclusivo.</p>' +
        '<div style="display:flex;gap:8px;">' +
        '<button onclick="window.open(\'https://billing.stripe.com/p/login/aFa3cvaY73gY9UP2rZ3sI00\',\'_blank\');this.closest(\'div\').parentElement.parentElement.remove();" style="flex:1;padding:12px;background:#fff;color:#e74c3c;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">üí≥ Actualizar Pago</button>' +
        '<button onclick="this.closest(\'div\').parentElement.parentElement.parentElement.remove();" style="padding:12px 16px;background:rgba(255,255,255,0.2);color:#fff;border:none;border-radius:10px;cursor:pointer;">‚úï</button>' +
        '</div></div>';
      
      document.body.appendChild(notif);
      addNotification('payment', '‚ö†Ô∏è Pago pendiente ‚Äî Tu membres√≠a ' + tierName + ' necesita actualizaci√≥n de pago', '‚ö†Ô∏è');
      
      // Auto-dismiss after 15 seconds
      setTimeout(function() { if(notif.parentNode) notif.remove(); }, 15000);
    }

    async function loadWebinarLinks(tier) {
      const container = document.getElementById('webinarLinksContainer');
      if (!container) return;
      
      const tierAccess = { bronze: [1], silver: [1, 2], gold: [1, 2, 3] };
      const levels = tierAccess[tier] || [];
      const levelNames = { 1: 'Nivel 1 - Principiante', 2: 'Nivel 2 - Intermedio', 3: 'Nivel 3 - Avanzado / Mentor√≠a' };
      const levelColors = { 1: '#cd7f32', 2: '#c0c0c0', 3: '#ffd700' };

      // Try loading from Supabase table webinar_links
      let webinarLinks = [];
      if (supabaseClient && isOnline) {
        try {
          const { data } = await supabaseClient
            .from('webinar_links')
            .select('*')
            .eq('activo', true)
            .in('nivel', levels)
            .order('nivel', { ascending: true });
          if (data) webinarLinks = data;
        } catch(e) {}
      }

      let html = '';
      if (webinarLinks.length > 0) {
        webinarLinks.forEach(link => {
          html += '<div style="background:rgba(255,255,255,0.1); border-radius:10px; padding:12px; margin-bottom:10px;">';
          html += '<div style="font-size:12px; opacity:0.7; margin-bottom:5px;">' + (levelNames[link.nivel] || 'Nivel ' + link.nivel) + '</div>';
          html += '<div style="font-weight:bold; margin-bottom:8px;">' + (link.titulo || 'Clase en Vivo') + '</div>';
          if (link.descripcion) html += '<div style="font-size:12px; opacity:0.8; margin-bottom:8px;">' + link.descripcion + '</div>';
          if (link.fecha_hora) {
            const fecha = new Date(link.fecha_hora);
            html += '<div style="font-size:11px; opacity:0.7; margin-bottom:8px;">üìÖ ' + fecha.toLocaleDateString('es-MX', {weekday:'long', month:'long', day:'numeric'}) + ' - ' + fecha.toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit'}) + '</div>';
          }
          html += '<button onclick="window.open(\'' + link.zoom_link + '\',\'_blank\')" style="padding:10px 20px; background:#f39c12; color:#000; border:none; border-radius:8px; font-weight:bold; cursor:pointer; width:100%;">üìπ ENTRAR A ZOOM</button>';
          html += '</div>';
        });
      } else {
        // Show available levels even without specific links
        levels.forEach(lvl => {
          html += '<div style="background:rgba(255,255,255,0.1); border-radius:10px; padding:12px; margin-bottom:10px;">';
          html += '<div style="display:flex; justify-content:space-between; align-items:center;">';
          html += '<div>';
          html += '<div style="font-weight:bold;">' + (levelNames[lvl] || 'Nivel ' + lvl) + '</div>';
          html += '<div style="font-size:12px; opacity:0.7; margin-top:4px;">Pr√≥xima clase por confirmar</div>';
          html += '</div>';
          html += '<div style="width:10px; height:10px; background:' + levelColors[lvl] + '; border-radius:50%;"></div>';
          html += '</div>';
          html += '</div>';
        });
        html += '<p style="font-size:11px; opacity:0.6; text-align:center; margin-top:10px;">Los links de Zoom se actualizan antes de cada clase</p>';
      }
      container.innerHTML = html;
    }

    function loadPregrabadoContent(tier) {
      const container = document.getElementById('pregrabadoContent');
      if (!container) return;

      const tierAccess = { bronze: [1], silver: [1, 2], gold: [1, 2, 3] };
      const levels = tierAccess[tier] || [];
      const levelNames = { 1: 'Nivel 1 - Principiante', 2: 'Nivel 2 - Intermedio', 3: 'Nivel 3 - Avanzado' };
      const levelIcons = { 1: 'ü•â', 2: 'ü•à', 3: 'ü•á' };
      const levelColors = { 1: '#cd7f32', 2: '#999', 3: '#daa520' };

      let html = '';
      levels.forEach(lvl => {
        html += '<div style="border:1px solid #e2e8f0; border-radius:10px; padding:12px; margin-bottom:10px; cursor:pointer;" onclick="loadPregrabadoVideos(' + lvl + ')">';
        html += '<div style="display:flex; justify-content:space-between; align-items:center;">';
        html += '<div style="display:flex; align-items:center; gap:10px;">';
        html += '<span style="font-size:24px;">' + levelIcons[lvl] + '</span>';
        html += '<div>';
        html += '<div style="font-weight:bold;">' + (levelNames[lvl]) + '</div>';
        html += '<div style="font-size:12px; color:#64748b;">Toca para ver videos disponibles</div>';
        html += '</div>';
        html += '</div>';
        html += '<span style="color:' + levelColors[lvl] + '; font-size:20px;">‚Üí</span>';
        html += '</div>';
        html += '</div>';
      });

      // Show locked levels
      for (let i = 1; i <= 3; i++) {
        if (!levels.includes(i)) {
          html += '<div style="border:1px solid #e2e8f0; border-radius:10px; padding:12px; margin-bottom:10px; opacity:0.4;">';
          html += '<div style="display:flex; justify-content:space-between; align-items:center;">';
          html += '<div style="display:flex; align-items:center; gap:10px;">';
          html += '<span style="font-size:24px;">üîí</span>';
          html += '<div>';
          html += '<div style="font-weight:bold;">' + (levelNames[i]) + '</div>';
          html += '<div style="font-size:12px; color:#64748b;">Requiere membres√≠a superior</div>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
        }
      }
      container.innerHTML = html;
    }

    async function loadPregrabadoVideos(nivel) {
      // Placeholder: load videos from Supabase table or show coming soon
      alert('üìö Videos Pregrabados Nivel ' + nivel + '\n\nContenido pr√≥ximamente disponible.\nMaestro Mario estar√° subiendo los videos de cada nivel.');
    }

    function isMembershipAuthenticated() {
      return membershipAuthenticated;
    }

    async function generateMembershipCode() {
      if (!currentViewingTechnician || !currentViewingTechnician.email) {
        alert('Error: Este t√©cnico no tiene email registrado.');
        return;
      }
      const email = currentViewingTechnician.email;
      const nombre = currentViewingTechnician.nombre || email;
      const codes = await getMembershipCodes();

      const existingCode = Object.keys(codes).find(c => codes[c].email === email && !codes[c].revoked);
      if (existingCode) {
        document.getElementById('adminMemberCodeValue').textContent = existingCode;
        document.getElementById('adminMemberCodeFor').textContent = nombre;
        document.getElementById('adminMemberCodeDisplay').style.display = 'block';
        return;
      }

      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code;
      do {
        code = 'VIP';
        for (let i = 0; i < 4; i++) code += chars[Math.floor(Math.random() * chars.length)];
      } while (codes[code]);

      const codeData = {
        email: email,
        nombre: nombre,
        type: 'membership',
        createdAt: new Date().toISOString(),
        used: false,
        revoked: false
      };
      await saveAccessCode(code, codeData);

      document.getElementById('adminMemberCodeValue').textContent = code;
      document.getElementById('adminMemberCodeFor').textContent = nombre;
      document.getElementById('adminMemberCodeDisplay').style.display = 'block';

      alert('‚úÖ C√≥digo de membres√≠a generado: ' + code + '\nPara: ' + nombre);
    }

    function copyMembershipCode() {
      const code = document.getElementById('adminMemberCodeValue').textContent;
      const text = 'üé• Tu c√≥digo de acceso a CLASES EN VIVO de Maestro ACVOLT:\n\n' + code + '\n\n1. Abre maestromario.com\n2. Inicia sesi√≥n con tu cuenta\n3. Toca \"Clases en Vivo\"\n4. Ingresa tu c√≥digo: ' + code + '\n5. ¬°Bienvenido a las clases exclusivas!\n\n- Maestro Mario | ACVOLT Tech School';
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => alert('üìã C√≥digo de membres√≠a copiado.'));
      } else {
        prompt('Copia:', text);
      }
    }

    async function revokeMembershipCode() {
      if (!currentViewingTechnician) return;
      const email = currentViewingTechnician.email;
      const codes = await getMembershipCodes();
      const codeKey = Object.keys(codes).find(c => codes[c].email === email && !codes[c].revoked);
      if (codeKey) {
        if (!confirm('¬øRevocar c√≥digo de membres√≠a ' + codeKey + '?')) return;
        codes[codeKey].revoked = true;
        await saveAccessCode(codeKey, codes[codeKey]);
        localStorage.removeItem('maestroac_membership_' + email);
        document.getElementById('adminMemberCodeDisplay').style.display = 'none';
        alert('‚ùå C√≥digo de membres√≠a revocado.');
      }
    }

    async function updateAdminMemberCodeDisplay() {
      if (!currentViewingTechnician || !currentViewingTechnician.email) return;
      const codes = await getMembershipCodes();
      const email = currentViewingTechnician.email;
      const existingCode = Object.keys(codes).find(c => codes[c].email === email && !codes[c].revoked);
      const display = document.getElementById('adminMemberCodeDisplay');
      if (!display) return;
      if (existingCode) {
        document.getElementById('adminMemberCodeValue').textContent = existingCode;
        document.getElementById('adminMemberCodeFor').textContent = currentViewingTechnician.nombre || email;
        display.style.display = 'block';
      } else {
        display.style.display = 'none';
      }
    }

    // Admin state
    let allTechnicians = [];
    let currentViewingTechnician = null;
    let currentTimelineView = 'minutes';

    // Check if admin is authenticated
    function isAdminAuthenticated() {
      return sessionStorage.getItem('admin_authenticated') === 'true';
    }

    // Handle admin login - supports Master (admin33) and Student Success staff
    async function handleAdminLogin(event) {
      event.preventDefault();
      const user = document.getElementById('adminLoginUser').value.trim();
      const pass = document.getElementById('adminLoginPassword').value;
      const errorDiv = document.getElementById('adminLoginError');

      // 1. Always check hardcoded master first (fallback if Supabase is down)
      if (user === ADMIN_USER && pass === ADMIN_PASS) {
        currentAdminRole = 'master';
        currentAdminName = 'Maestro Mario';
        sessionStorage.setItem('admin_authenticated', 'true');
        sessionStorage.setItem('admin_role', 'master');
        sessionStorage.setItem('admin_name', 'Maestro Mario');
        errorDiv.classList.remove('show');
        showScreen('adminDashboardScreen');
        return false;
      }

      // 2. Check Supabase admin_staff table
      if (supabaseClient) {
        try {
          var { data: staff } = await supabaseClient
            .from('admin_staff')
            .select('*')
            .eq('username', user)
            .eq('password_hash', pass)
            .eq('activo', true)
            .single();
          
          if (staff) {
            currentAdminRole = staff.rol;
            currentAdminName = staff.nombre;
            sessionStorage.setItem('admin_authenticated', 'true');
            sessionStorage.setItem('admin_role', staff.rol);
            sessionStorage.setItem('admin_name', staff.nombre);
            // Update last login
            await supabaseClient.from('admin_staff').update({ last_login: new Date().toISOString() }).eq('id', staff.id);
            errorDiv.classList.remove('show');
            showScreen('adminDashboardScreen');
            return false;
          }
        } catch(e) { console.log('[Admin] Staff lookup error:', e); }
      }

      errorDiv.classList.add('show');
      return false;
    }

    // Admin logout
    function adminLogout() {
      sessionStorage.removeItem('admin_authenticated');
      showScreen('welcomeScreen');
    }

    // Load all technicians from localStorage (simulated database)
    function loadAllTechnicians() {
      allTechnicians = [];

      // Get current user if exists (local)
      const currentTechUser = localStorage.getItem('tecnico_user');
      const currentProgress = localStorage.getItem('tecnico_progress');
      const currentCerts = localStorage.getItem('tecnico_certificates');

      if (currentTechUser) {
        const tech = JSON.parse(currentTechUser);
        tech.progress = currentProgress ? JSON.parse(currentProgress) : {};
        tech.certificates = currentCerts ? JSON.parse(currentCerts) : [];
        tech.lastActive = tech.lastActive || new Date().toISOString();
        tech.registrationDate = tech.registrationDate || new Date().toISOString();
        tech.activityLog = tech.activityLog || [];
        allTechnicians.push(tech);
      }

      // Load from Supabase if online
      if (supabaseClient && isOnline) {
        loadTechniciansFromSupabase();
      }

      return allTechnicians;
    }

    // Load all technicians from Supabase for admin dashboard
    async function loadTechniciansFromSupabase() {
      if (!supabaseClient || !isOnline) return;
      try {
        // Get all users
        const { data: users, error } = await supabaseClient
          .from('users')
          .select('*')
          .order('fecha_registro', { ascending: false });

        if (error) { console.error('Error loading technicians:', error); return; }
        if (!users || users.length === 0) return;

        // Get all progress data
        const { data: allProgress } = await supabaseClient
          .from('user_progress')
          .select('*');

        // Get all certificates
        const { data: allCerts } = await supabaseClient
          .from('certificates')
          .select('*');

        // Get all quiz attempts
        const { data: allAttempts } = await supabaseClient
          .from('quiz_attempts')
          .select('*')
          .order('fecha', { ascending: false });

        // Build technician objects matching expected format
        const supabaseTechnicians = users.map(user => {
          // Build progress object
          const userProgress = (allProgress || []).filter(p => p.user_id === user.id);
          const progressObj = {
            principiante: { completed: 0, total: 700, score: 0 },
            intermedio: { completed: 0, total: 700, score: 0 },
            avanzado: { completed: 0, total: 700, score: 0 },
            elite: { completed: 0, total: 700, score: 0 },
            platino: { completed: 0, total: 700, score: 0 }
          };
          userProgress.forEach(p => {
            if (progressObj[p.nivel]) {
              progressObj[p.nivel].completed = p.completed;
              progressObj[p.nivel].score = p.score;
              progressObj[p.nivel].total = p.total;
            }
          });

          // Build certificates array
          const userCerts = (allCerts || []).filter(c => c.user_id === user.id);
          const levelNames = { principiante: 'Principiante', intermedio: 'Intermedio', avanzado: 'Avanzado', elite: 'Elite', platino: 'Platino' };
          const levelIcons = { principiante: 'üîß', intermedio: 'üìä', avanzado: '‚ö°', elite: 'üèÜ', platino: 'üíé' };
          const certsArr = userCerts.map(c => ({
            levelId: c.nivel,
            levelName: levelNames[c.nivel] || c.nivel,
            levelIcon: levelIcons[c.nivel] || 'üìú',
            score: c.porcentaje,
            date: new Date(c.fecha_obtenido).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' }),
            certificateId: c.certificate_number || c.id
          }));

          // Build activity log from quiz attempts
          const userAttempts = (allAttempts || []).filter(a => a.user_id === user.id).slice(0, 10);
          const activityLog = userAttempts.map(a => ({
            timestamp: a.fecha,
            action: a.aprobado ? 'quiz_completed' : 'quiz_attempted',
            level: a.nivel,
            score: a.porcentaje
          }));

          return {
            nombre: user.nombre,
            email: user.email || '',
            telefono: user.telefono || '',
            technicianNumber: user.technician_number || '',
            technicianNumberDate: user.technician_number_date || '',
            registrationDate: user.fecha_registro,
            lastActive: user.ultimo_acceso,
            nivel_actual: user.nivel_actual,
            progress: progressObj,
            certificates: certsArr,
            activityLog: activityLog,
            supabaseId: user.id
          };
        });

        // Replace allTechnicians with Supabase data (avoid duplicates with local user)
        const localEmails = allTechnicians.map(t => t.email).filter(Boolean);
        const newTechs = supabaseTechnicians.filter(t => !localEmails.includes(t.email));
        allTechnicians = allTechnicians.concat(newTechs);

        // Re-render dashboard with fresh data
        updateAdminStats();
        renderTechnicianList();

        console.log('[MaestroAC] Admin: Loaded ' + users.length + ' technicians from Supabase ‚úÖ');
      } catch (e) { console.error('Error loading technicians from Supabase:', e); }
    }

    // Initialize demo technicians for demonstration purposes
    function initializeDemoTechnicians() {
      const demoTechnicians = [
        {
          nombre: 'Carlos Mendez',
          email: 'carlos.mendez@email.com',
          telefono: '(787) 555-1234',
          epa: 'EPA-608-2024-001',
          nate: 'NATE-2024-0012',
          esco: '',
          technicianNumber: 'TECH-2024-N33-CM01',
          technicianNumberDate: '15 de enero de 2024',
          registrationDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
          lastActive: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
          progress: {
            principiante: { completed: 50, score: 42, total: 50 },
            intermedio: { completed: 100, score: 78, total: 150 },
            avanzado: { completed: 25, score: 20, total: 50 },
            elite: { completed: 0, score: 0, total: 50 },
            platino: { completed: 0, score: 0, total: 500 }
          },
          certificates: [
            { levelId: 'principiante', levelName: 'Principiante', levelIcon: 'üîß', score: 84, date: '20 de enero de 2024', certificateId: 'CERT-PRI-20240120-ABC1' },
            { levelId: 'intermedio', levelName: 'Intermedio', levelIcon: 'üìä', score: 78, date: '5 de febrero de 2024', certificateId: 'CERT-INT-20240205-DEF2' }
          ],
          activityLog: [
            { timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), action: 'quiz_completed', level: 'intermedio', score: 78 },
            { timestamp: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(), action: 'quiz_started', level: 'avanzado' },
            { timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(), action: 'certificate_earned', level: 'intermedio', score: 78 },
            { timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(), action: 'quiz_completed', level: 'principiante', score: 84 },
            { timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(), action: 'profile_created' }
          ]
        },
        {
          nombre: 'Maria Rodriguez',
          email: 'maria.rodriguez@email.com',
          telefono: '(787) 555-5678',
          epa: 'EPA-608-2024-002',
          nate: '',
          esco: 'ESCO-2024-0045',
          technicianNumber: 'TECH-2024-N33-MR02',
          technicianNumberDate: '22 de enero de 2024',
          registrationDate: new Date(Date.now() - 25 * 24 * 60 * 60 * 1000).toISOString(),
          lastActive: new Date(Date.now() - 30 * 60 * 1000).toISOString(),
          progress: {
            principiante: { completed: 50, score: 48, total: 50 },
            intermedio: { completed: 150, score: 135, total: 150 },
            avanzado: { completed: 50, score: 45, total: 50 },
            elite: { completed: 30, score: 24, total: 50 },
            platino: { completed: 0, score: 0, total: 500 }
          },
          certificates: [
            { levelId: 'principiante', levelName: 'Principiante', levelIcon: 'üîß', score: 96, date: '25 de enero de 2024', certificateId: 'CERT-PRI-20240125-GHI3' },
            { levelId: 'intermedio', levelName: 'Intermedio', levelIcon: 'üìä', score: 90, date: '10 de febrero de 2024', certificateId: 'CERT-INT-20240210-JKL4' },
            { levelId: 'avanzado', levelName: 'Avanzado', levelIcon: '‚ö°', score: 90, date: '28 de febrero de 2024', certificateId: 'CERT-AVA-20240228-MNO5' }
          ],
          activityLog: [
            { timestamp: new Date(Date.now() - 30 * 60 * 1000).toISOString(), action: 'quiz_started', level: 'elite' },
            { timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(), action: 'certificate_earned', level: 'avanzado', score: 90 },
            { timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), action: 'quiz_completed', level: 'avanzado', score: 90 },
            { timestamp: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(), action: 'certificate_earned', level: 'intermedio', score: 90 }
          ]
        },
        {
          nombre: 'Juan Perez',
          email: 'juan.perez@email.com',
          telefono: '(787) 555-9012',
          epa: '',
          nate: 'NATE-2024-0078',
          esco: '',
          technicianNumber: 'TECH-2024-N33-JP03',
          technicianNumberDate: '1 de febrero de 2024',
          registrationDate: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(),
          lastActive: new Date(Date.now() - 48 * 60 * 60 * 1000).toISOString(),
          progress: {
            principiante: { completed: 50, score: 35, total: 50 },
            intermedio: { completed: 50, score: 30, total: 150 },
            avanzado: { completed: 0, score: 0, total: 50 },
            elite: { completed: 0, score: 0, total: 50 },
            platino: { completed: 0, score: 0, total: 500 }
          },
          certificates: [
            { levelId: 'principiante', levelName: 'Principiante', levelIcon: 'üîß', score: 70, date: '8 de febrero de 2024', certificateId: 'CERT-PRI-20240208-PQR6' }
          ],
          activityLog: [
            { timestamp: new Date(Date.now() - 48 * 60 * 60 * 1000).toISOString(), action: 'quiz_completed', level: 'intermedio', score: 60 },
            { timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), action: 'certificate_earned', level: 'principiante', score: 70 }
          ]
        }
      ];

      localStorage.setItem('admin_technicians', JSON.stringify(demoTechnicians));
      allTechnicians = allTechnicians.concat(demoTechnicians);
    }

    // Render admin dashboard
    function renderAdminDashboard() {
      // Check role and set context
      var role = sessionStorage.getItem('admin_role') || currentAdminRole || 'master';
      currentAdminRole = role;
      currentAdminName = sessionStorage.getItem('admin_name') || currentAdminName || '';
      
      // Hide Staff management tab for non-master
      var staffElements = document.querySelectorAll('.ssStaffOnly');
      staffElements.forEach(function(el) { el.style.display = role === 'master' ? 'inline-block' : 'none'; });
      
      // Everyone sees everything - full admin access
      loadAllTechnicians();
      updateAdminStats();
      renderTechnicianList();
      renderLevelPerformanceChart();
      loadAdminExamRequests();
      loadAdminStudentActivity();
      loadSSTickets();
      loadSSStats();
      // Auto-set priority view: show open tickets sorted by date
      setTimeout(function() { ssFilterTime('today'); ssFilterStatus('abierto'); }, 500);
    }

    // ========== STUDENT SUCCESS FUNCTIONS ==========
    var ssRatings = { general: 0, online: 0, vivo: 0 };

    function ssShowTab(tab) {
      document.getElementById('ssTicketsPanel').style.display = tab === 'tickets' ? 'block' : 'none';
      document.getElementById('ssSurveysPanel').style.display = tab === 'surveys' ? 'block' : 'none';
      document.getElementById('ssNewSurveyPanel').style.display = tab === 'newsurvey' ? 'block' : 'none';
      document.getElementById('ssStaffPanel').style.display = tab === 'staff' ? 'block' : 'none';
      document.getElementById('ssTabTickets').style.opacity = tab === 'tickets' ? '1' : '0.5';
      document.getElementById('ssTabSurveys').style.opacity = tab === 'surveys' ? '1' : '0.5';
      document.getElementById('ssTabNew').style.opacity = tab === 'newsurvey' ? '1' : '0.5';
      var staffBtn = document.getElementById('ssTabStaff');
      if (staffBtn) staffBtn.style.opacity = tab === 'staff' ? '1' : '0.5';
      if (tab === 'surveys') loadSSSurveys();
      if (tab === 'tickets') loadSSTickets();
      if (tab === 'staff') loadSSStaff();
      // Hide staff tab if not master
      var role = sessionStorage.getItem('admin_role') || currentAdminRole;
      var staffElements = document.querySelectorAll('.ssStaffOnly');
      staffElements.forEach(function(el) { el.style.display = role === 'master' ? 'inline-block' : 'none'; });
    }

    function ssToggleCancelFields() {
      var tipo = document.getElementById('ssFormTipo').value;
      document.getElementById('ssCancelFields').style.display = (tipo === 'cancelacion') ? 'block' : 'none';
    }

    function ssSetRating(category, value) {
      ssRatings[category] = value;
      for (var i = 1; i <= 5; i++) {
        var btn = document.getElementById('ssRate_' + category + '_' + i);
        if (btn) btn.style.background = i <= value ? '#f39c12' : 'transparent';
      }
    }

    async function loadSSStats() {
      if (!supabaseClient) return;
      try {
        var { data: tickets } = await supabaseClient.from('student_success_tickets').select('estado,descripcion').order('created_at', { ascending: false });
        var { data: surveys } = await supabaseClient.from('student_success_surveys').select('tipo,certificado_obtenido');
        tickets = tickets || [];
        surveys = surveys || [];
        var openTickets = tickets.filter(function(t) { return t.estado === 'abierto'; });
        var cancelaciones = surveys.filter(function(s) { return s.tipo === 'cancelacion'; });
        var conCert = surveys.filter(function(s) { return s.certificado_obtenido === 'si'; });
        document.getElementById('ssOpenCount').textContent = openTickets.length;
        document.getElementById('ssSurveyCount').textContent = surveys.length;
        document.getElementById('ssCancelCount').textContent = cancelaciones.length;
        document.getElementById('ssCertCount').textContent = conCert.length;
      } catch(e) { console.log('[SS] Stats error:', e); }
    }

    // ===== STUDENT SUCCESS TIME FILTERS =====
    var ssCurrentStatus = null;
    var ssCurrentTime = null;

    function ssFilterStatus(status) {
      ssCurrentStatus = status;
      loadSSTicketsFiltered();
      // Highlight active button
      ['ssBtnAbierto','ssBtnProceso','ssBtnResuelto','ssBtnTodos'].forEach(function(id) {
        var btn = document.getElementById(id);
        if (btn) btn.style.fontWeight = 'normal';
      });
      var activeId = status === 'abierto' ? 'ssBtnAbierto' : status === 'en_proceso' ? 'ssBtnProceso' : status === 'resuelto' ? 'ssBtnResuelto' : 'ssBtnTodos';
      var activeBtn = document.getElementById(activeId);
      if (activeBtn) activeBtn.style.fontWeight = 'bold';
    }

    function ssFilterTime(period) {
      ssCurrentTime = period;
      loadSSTicketsFiltered();
      // Highlight active time button
      ['ssBtnToday','ssBtnWeek','ssBtnMonth','ssBtnYear','ssBtnAllTime'].forEach(function(id) {
        var btn = document.getElementById(id);
        if (btn) { btn.style.fontWeight = 'normal'; btn.style.transform = 'scale(1)'; }
      });
      var activeId = period === 'today' ? 'ssBtnToday' : period === 'week' ? 'ssBtnWeek' : period === 'month' ? 'ssBtnMonth' : period === 'year' ? 'ssBtnYear' : 'ssBtnAllTime';
      var activeBtn = document.getElementById(activeId);
      if (activeBtn) { activeBtn.style.fontWeight = 'bold'; activeBtn.style.transform = 'scale(1.05)'; }
    }

    function ssGetTimeRange(period) {
      var now = new Date();
      var start = null;
      var label = '';
      if (period === 'today') {
        start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        label = 'üìÖ Hoy ‚Äî ' + now.toLocaleDateString('es-MX', {weekday:'long', day:'numeric', month:'long'});
      } else if (period === 'week') {
        var dayOfWeek = now.getDay();
        var diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Monday start
        start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - diff);
        label = 'üìÜ Esta Semana ‚Äî ' + start.toLocaleDateString('es-MX', {day:'numeric',month:'short'}) + ' al ' + now.toLocaleDateString('es-MX', {day:'numeric',month:'short'});
      } else if (period === 'month') {
        start = new Date(now.getFullYear(), now.getMonth(), 1);
        label = 'üìÖ ' + now.toLocaleDateString('es-MX', {month:'long', year:'numeric'});
      } else if (period === 'year') {
        start = new Date(now.getFullYear(), 0, 1);
        label = 'üìä A√±o ' + now.getFullYear();
      }
      return { start: start, label: label };
    }

    async function loadSSTicketsFiltered() {
      var container = document.getElementById('ssTicketsList');
      var summaryBar = document.getElementById('ssTimeSummary');
      if (!container || !supabaseClient) return;
      
      try {
        var query = supabaseClient.from('student_success_tickets').select('*').order('created_at', { ascending: false });
        if (ssCurrentStatus) query = query.eq('estado', ssCurrentStatus);
        
        // Apply time filter
        if (ssCurrentTime) {
          var range = ssGetTimeRange(ssCurrentTime);
          if (range.start) {
            query = query.gte('created_at', range.start.toISOString());
          }
        }
        
        var { data: tickets } = await query;
        if (!tickets || tickets.length === 0) {
          summaryBar.style.display = 'none';
          container.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:30px;"><div style="font-size:36px;">üéâ</div><p>No hay tickets' + (ssCurrentStatus ? ' con estado "' + ssCurrentStatus + '"' : '') + (ssCurrentTime ? ' en este periodo' : '') + '</p></div>';
          return;
        }
        
        // Show summary bar
        if (ssCurrentTime) {
          var range = ssGetTimeRange(ssCurrentTime);
          var openC = tickets.filter(function(t){return t.estado==='abierto';}).length;
          var procC = tickets.filter(function(t){return t.estado==='en_proceso';}).length;
          var resC = tickets.filter(function(t){return t.estado==='resuelto';}).length;
          summaryBar.style.display = 'block';
          document.getElementById('ssTimeSummaryText').innerHTML = range.label + ' ‚Äî <span style="color:#f39c12;">' + tickets.length + ' tickets</span>';
          document.getElementById('ssTimeSummaryOpen').textContent = 'üî¥ ' + openC + ' abiertos';
          document.getElementById('ssTimeSummaryProcess').textContent = 'üü° ' + procC + ' en proceso';
          document.getElementById('ssTimeSummaryResolved').textContent = 'üü¢ ' + resC + ' resueltos';
        } else {
          summaryBar.style.display = 'none';
        }
        
        // Group tickets by time period
        var grouped = ssGroupTickets(tickets);
        var html = '';
        
        grouped.forEach(function(group) {
          // Group header
          html += '<div style="background:linear-gradient(135deg,#1e3a5f,#1e293b);border-radius:10px;padding:8px 12px;margin:10px 0 6px 0;display:flex;justify-content:space-between;align-items:center;">';
          html += '<span style="color:#38bdf8;font-size:12px;font-weight:bold;">' + group.label + '</span>';
          html += '<div style="display:flex;gap:8px;">';
          html += '<span style="background:rgba(220,38,38,0.2);color:#fca5a5;padding:2px 8px;border-radius:10px;font-size:10px;">' + group.openCount + ' abiertos</span>';
          html += '<span style="color:#94a3b8;font-size:11px;">' + group.tickets.length + ' total</span>';
          html += '</div></div>';
          
          // Tickets in this group
          group.tickets.forEach(function(t) {
            var ec = t.estado === 'abierto' ? '#e74c3c' : t.estado === 'en_proceso' ? '#f39c12' : '#27ae60';
            var ei = t.estado === 'abierto' ? 'üî¥' : t.estado === 'en_proceso' ? 'üü°' : 'üü¢';
            var dias = t.fecha_limite ? Math.max(0, Math.ceil((new Date(t.fecha_limite) - new Date()) / 86400000)) : '-';
            var dc = dias <= 1 ? '#e74c3c' : dias <= 3 ? '#f39c12' : '#27ae60';
            var fecha = new Date(t.created_at).toLocaleDateString('es-MX', {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
            // Priority badge based on age
            var ageHours = (Date.now() - new Date(t.created_at).getTime()) / 3600000;
            var urgencyBadge = '';
            if (t.estado !== 'resuelto') {
              if (ageHours < 24) urgencyBadge = '<span style="background:#dc2626;color:white;padding:1px 6px;border-radius:8px;font-size:9px;margin-left:4px;">üî• URGENTE</span>';
              else if (ageHours < 72) urgencyBadge = '<span style="background:#ea580c;color:white;padding:1px 6px;border-radius:8px;font-size:9px;margin-left:4px;">‚ö° PRIORIDAD</span>';
              else if (ageHours < 168) urgencyBadge = '<span style="background:#ca8a04;color:white;padding:1px 6px;border-radius:8px;font-size:9px;margin-left:4px;">üìû LLAMAR</span>';
            }
            
            html += '<div style="background:rgba(255,255,255,0.03);border-left:4px solid ' + ec + ';border-radius:8px;padding:10px;margin-bottom:4px;">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
            html += '<div><strong style="color:#e2e8f0;font-size:13px;">üë§ ' + (t.student_name || 'N/A') + '</strong>' + urgencyBadge + ' <span style="color:#64748b;font-size:11px;">' + (t.student_email || '') + '</span></div>';
            html += '<span style="background:' + ec + ';color:white;padding:2px 8px;border-radius:10px;font-size:10px;">' + ei + ' ' + t.estado + '</span>';
            html += '</div>';
            html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">';
            html += '<span style="color:#64748b;font-size:11px;">üìÖ ' + fecha + ' | <span style="color:' + dc + ';">‚è≥ ' + dias + ' d√≠as</span> | ' + (t.email_enviado_estudiante ? 'üìß‚úÖ' : 'üìß‚ùå') + '</span>';
            html += '<div style="display:flex;gap:4px;">';
            if (t.estado === 'abierto') html += '<button onclick="ssUpdateTicket(\'' + t.id + '\',\'en_proceso\')" style="background:#f39c12;color:white;border:none;padding:3px 8px;border-radius:5px;font-size:10px;cursor:pointer;">En Proceso</button>';
            if (t.estado !== 'resuelto') html += '<button onclick="ssUpdateTicket(\'' + t.id + '\',\'resuelto\')" style="background:#27ae60;color:white;border:none;padding:3px 8px;border-radius:5px;font-size:10px;cursor:pointer;">‚úÖ Resolver</button>';
            html += '</div></div>';
            html += '<div style="display:flex;gap:6px;margin-top:6px;">';
            html += '<a href="javascript:void(0)" onclick="openEmailComposer(\'' + (t.student_email || '') + '\',\'ACVOLT - Actualiza tu m√©todo de pago\',\'Hola ' + (t.student_name || '') + ',\\nTe contactamos porque necesitamos que actualices tu m√©todo de pago.\\n\\nSaludos,\\nMaestro Mario\\nACVOLT Tech School\')" style="background:#9b59b6;color:white;text-decoration:none;padding:3px 8px;border-radius:5px;font-size:10px;cursor:pointer;">üìß Email</a>';
            html += '<button onclick="ssLookupForTicket(\'' + (t.student_email || '') + '\')" style="background:#3498db;color:white;border:none;padding:3px 8px;border-radius:5px;font-size:10px;cursor:pointer;">üëÅ Ver Info</button>';
            html += '</div>';
            html += '<div style="color:#475569;font-size:10px;margin-top:4px;">' + (t.descripcion || '') + '</div>';
            html += '</div>';
          });
        });
        
        container.innerHTML = html;
      } catch(e) { container.innerHTML = '<div style="color:#e74c3c;padding:10px;">Error: ' + e.message + '</div>'; }
    }

    function ssGroupTickets(tickets) {
      var now = new Date();
      var todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      var yesterdayStart = new Date(todayStart.getTime() - 86400000);
      var weekStart = new Date(todayStart);
      var dayOfWeek = weekStart.getDay();
      weekStart.setDate(weekStart.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
      var monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      
      var groups = {
        today: { label: 'üî• HOY ‚Äî ' + todayStart.toLocaleDateString('es-MX',{weekday:'long',day:'numeric',month:'long'}), tickets: [], openCount: 0 },
        yesterday: { label: 'üìÖ AYER ‚Äî ' + yesterdayStart.toLocaleDateString('es-MX',{weekday:'long',day:'numeric',month:'long'}), tickets: [], openCount: 0 },
        thisWeek: { label: 'üìÜ ESTA SEMANA ‚Äî ' + weekStart.toLocaleDateString('es-MX',{day:'numeric',month:'short'}) + ' al ' + todayStart.toLocaleDateString('es-MX',{day:'numeric',month:'short'}), tickets: [], openCount: 0 },
        thisMonth: { label: 'üìÖ ESTE MES ‚Äî ' + now.toLocaleDateString('es-MX',{month:'long',year:'numeric'}), tickets: [], openCount: 0 },
        older: { label: 'üóÑÔ∏è ANTERIORES', tickets: [], openCount: 0 }
      };
      
      tickets.forEach(function(t) {
        var d = new Date(t.created_at);
        var isOpen = t.estado === 'abierto';
        if (d >= todayStart) {
          groups.today.tickets.push(t);
          if (isOpen) groups.today.openCount++;
        } else if (d >= yesterdayStart) {
          groups.yesterday.tickets.push(t);
          if (isOpen) groups.yesterday.openCount++;
        } else if (d >= weekStart) {
          groups.thisWeek.tickets.push(t);
          if (isOpen) groups.thisWeek.openCount++;
        } else if (d >= monthStart) {
          groups.thisMonth.tickets.push(t);
          if (isOpen) groups.thisMonth.openCount++;
        } else {
          groups.older.tickets.push(t);
          if (isOpen) groups.older.openCount++;
        }
      });
      
      // Only return groups that have tickets
      var result = [];
      ['today','yesterday','thisWeek','thisMonth','older'].forEach(function(key) {
        if (groups[key].tickets.length > 0) result.push(groups[key]);
      });
      return result;
    }

    // Keep original function as wrapper for backward compatibility
    async function loadSSTickets(filterEstado) {
      if (filterEstado) {
        ssCurrentStatus = filterEstado;
      }
      await loadSSTicketsFiltered();
    }
    // ===== END STUDENT SUCCESS TIME FILTERS =====

    async function ssUpdateTicket(id, status) {
      if (!supabaseClient) return;
      try {
        var d = { estado: status, updated_at: new Date().toISOString() };
        if (status === 'resuelto') { d.resuelto_por = 'admin'; d.resuelto_at = new Date().toISOString(); }
        await supabaseClient.from('student_success_tickets').update(d).eq('id', id);
        loadSSTickets();
        loadSSStats();
      } catch(e) { alert('Error: ' + e.message); }
    }

    async function ssLookupForTicket(email) {
      if (!email || !supabaseClient) return;
      try {
        var { data: user } = await supabaseClient.from('technicians').select('*').eq('email', email).single();
        var membership = null;
        try {
          var { data: mem } = await supabaseClient.from('memberships').select('*').eq('user_email', email).order('created_at', { ascending: false }).limit(1).single();
          membership = mem;
        } catch(e) {}
        
        var nombre = user ? (user.nombre || 'N/A') : 'No encontrado';
        var tel = user ? (user.telefono || '') : '';
        var ciudad = user ? (user.ciudad || '') : '';
        var techNum = user ? (user.technician_number || 'N/A') : 'N/A';
        var memStatus = membership ? (membership.activa ? '‚úÖ Activa ‚Äî ' + (membership.plan_name || membership.tier || '') : '‚ùå Inactiva') : '‚ö†Ô∏è Sin membres√≠a';
        
        var content = '<div style="background:rgba(0,212,255,0.05);border:1px solid #00d4ff;border-radius:12px;padding:15px;">' +
          '<h3 style="color:#00d4ff;margin:0 0 10px;">üë§ ' + nombre + '</h3>' +
          '<p style="color:#e2e8f0;margin:4px 0;font-size:13px;">üìß ' + email + '</p>' +
          (tel ? '<p style="color:#e2e8f0;margin:4px 0;font-size:13px;">üì± ' + tel + '</p>' : '<p style="color:#e74c3c;margin:4px 0;font-size:12px;">üì± Sin tel√©fono registrado</p>') +
          (ciudad ? '<p style="color:#94a3b8;margin:4px 0;font-size:12px;">üèôÔ∏è ' + ciudad + '</p>' : '') +
          '<p style="color:#94a3b8;margin:4px 0;font-size:12px;">üî¢ Tech #' + techNum + '</p>' +
          '<p style="color:#94a3b8;margin:4px 0;font-size:12px;">üí≥ ' + memStatus + '</p>' +
          (user && user.registration_date ? '<p style="color:#475569;margin:4px 0;font-size:11px;">üìÖ Registrado: ' + new Date(user.registration_date).toLocaleDateString("es-MX", {year:"numeric",month:"long",day:"numeric"}) + '</p>' : '') +
          '<div style="display:flex;gap:8px;margin-top:12px;">' +
            (tel ? '<a href="tel:' + tel + '" style="flex:1;background:#27ae60;color:white;text-decoration:none;text-align:center;padding:10px;border-radius:8px;font-size:13px;font-weight:bold;">üìû Llamar</a>' : '') +
            (tel ? '<a href="sms:' + tel + '" style="flex:1;background:#3498db;color:white;text-decoration:none;text-align:center;padding:10px;border-radius:8px;font-size:13px;font-weight:bold;">üí¨ SMS</a>' : '') +
            '<a href="javascript:void(0)" onclick="openEmailComposer(\'' + email + '\',\'ACVOLT - Actualiza tu pago\',\'Hola ' + (nombre || '') + ',\\nNecesitamos que actualices tu informaci√≥n de pago.\\n\\nSaludos,\\nMaestro Mario\\nACVOLT Tech School\')" style="flex:1;background:#9b59b6;color:white;text-decoration:none;text-align:center;padding:10px;border-radius:8px;font-size:13px;font-weight:bold;cursor:pointer;">üìß Email</a>' +
          '</div>' +
        '</div>';
        
        document.getElementById('ssDetailContent').innerHTML = content;
        document.getElementById('ssDetailModal').style.display = 'block';
      } catch(e) { alert('Error buscando estudiante: ' + e.message); }
    }

    async function ssLookupStudent() {
      var email = document.getElementById('ssFormEmail').value.trim();
      var info = document.getElementById('ssStudentInfo');
      if (!email || !supabaseClient) { info.innerHTML = ''; return; }
      try {
        var { data: user } = await supabaseClient.from('technicians').select('*').eq('email', email).single();
        var membership = null;
        try {
          var { data: mem } = await supabaseClient.from('memberships').select('*').eq('user_email', email).order('created_at', { ascending: false }).limit(1).single();
          membership = mem;
        } catch(e) {}
        var { data: prevSurveys } = await supabaseClient.from('student_success_surveys').select('id').eq('student_email', email);
        var surveyCount = prevSurveys ? prevSurveys.length : 0;
        
        if (user) {
          var memStatus = membership ? (membership.activa ? '‚úÖ Activa' : '‚ùå Inactiva') : '‚ö†Ô∏è Sin membres√≠a';
          var memPlan = membership ? (membership.plan_name || membership.tier || 'N/A') : 'N/A';
          var memColor = membership && membership.activa ? '#27ae60' : '#e74c3c';
          
          info.innerHTML = '<div style="background:rgba(0,212,255,0.05);border:2px solid #00d4ff;border-radius:12px;padding:15px;margin-top:10px;">' +
            '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;">' +
              '<div>' +
                '<h3 style="color:#00d4ff;margin:0 0 4px;">üë§ ' + (user.nombre || 'Sin nombre') + '</h3>' +
                '<p style="color:#94a3b8;margin:0;font-size:12px;">üìß ' + email + '</p>' +
              '</div>' +
              '<span style="background:' + memColor + ';color:white;padding:4px 10px;border-radius:8px;font-size:11px;">' + memStatus + '</span>' +
            '</div>' +
            
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">' +
              '<div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">' +
                '<div style="color:#64748b;font-size:10px;">üì± Tel√©fono</div>' +
                '<div style="color:#e2e8f0;font-size:13px;font-weight:bold;">' + (user.telefono || 'No registrado') + '</div>' +
              '</div>' +
              '<div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">' +
                '<div style="color:#64748b;font-size:10px;">üî¢ Tech Number</div>' +
                '<div style="color:#e2e8f0;font-size:13px;font-weight:bold;">' + (user.technician_number || user.techNumber || 'N/A') + '</div>' +
              '</div>' +
              '<div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">' +
                '<div style="color:#64748b;font-size:10px;">üèôÔ∏è Ciudad</div>' +
                '<div style="color:#e2e8f0;font-size:13px;font-weight:bold;">' + (user.ciudad || 'N/A') + '</div>' +
              '</div>' +
              '<div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">' +
                '<div style="color:#64748b;font-size:10px;">üõ†Ô∏è Experiencia</div>' +
                '<div style="color:#e2e8f0;font-size:13px;font-weight:bold;">' + (user.experiencia || 'N/A') + '</div>' +
              '</div>' +
              '<div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">' +
                '<div style="color:#64748b;font-size:10px;">üí≥ Plan</div>' +
                '<div style="color:#e2e8f0;font-size:13px;font-weight:bold;">' + memPlan + '</div>' +
              '</div>' +
              '<div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">' +
                '<div style="color:#64748b;font-size:10px;">üìã Surveys previos</div>' +
                '<div style="color:#e2e8f0;font-size:13px;font-weight:bold;">' + surveyCount + '</div>' +
              '</div>' +
            '</div>' +
            
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">' +
              '<div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">' +
                '<div style="color:#64748b;font-size:10px;">üèÖ EPA</div>' +
                '<div style="color:#e2e8f0;font-size:12px;">' + (user.epa || 'No') + '</div>' +
              '</div>' +
              '<div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">' +
                '<div style="color:#64748b;font-size:10px;">üèÖ OSHA</div>' +
                '<div style="color:#e2e8f0;font-size:12px;">' + (user.osha || 'No') + '</div>' +
              '</div>' +
            '</div>' +
            
            (user.registration_date ? '<p style="color:#475569;font-size:11px;margin:8px 0 0;">üìÖ Registrado: ' + new Date(user.registration_date).toLocaleDateString("es-MX", {year:"numeric",month:"long",day:"numeric"}) + '</p>' : '') +
            
            '<div style="display:flex;gap:8px;margin-top:12px;">' +
              (user.telefono ? '<a href="tel:' + user.telefono + '" style="flex:1;background:linear-gradient(135deg,#27ae60,#2ecc71);color:white;text-decoration:none;text-align:center;padding:10px;border-radius:8px;font-size:13px;font-weight:bold;">üìû Llamar</a>' : '') +
              (user.telefono ? '<a href="sms:' + user.telefono + '" style="flex:1;background:linear-gradient(135deg,#3498db,#2980b9);color:white;text-decoration:none;text-align:center;padding:10px;border-radius:8px;font-size:13px;font-weight:bold;">üí¨ SMS</a>' : '') +
              '<a href="javascript:void(0)" onclick="openEmailComposer(\'' + email + '\',\'ACVOLT Tech School - Seguimiento\',\'Hola ' + (user.nombre || '') + ',\\n\\n\')" style="flex:1;background:linear-gradient(135deg,#9b59b6,#8e44ad);color:white;text-decoration:none;text-align:center;padding:10px;border-radius:8px;font-size:13px;font-weight:bold;cursor:pointer;">üìß Email</a>' +
            '</div>' +
          '</div>';
        } else {
          info.innerHTML = '<div style="background:rgba(231,76,60,0.1);border:1px solid #e74c3c;border-radius:8px;padding:10px;margin-top:6px;">' +
            '<p style="color:#e74c3c;margin:0 0 6px;font-size:13px;">‚ùå Estudiante no encontrado en la base de datos</p>' +
            '<p style="color:#94a3b8;margin:0;font-size:11px;">Puedes llenar el survey manualmente con el email ingresado</p>' +
          '</div>';
        }
      } catch(e) { info.innerHTML = '<span style="color:#e74c3c;font-size:11px;">Error buscando: ' + e.message + '</span>'; }
    }

    async function ssSubmitSurvey() {
      if (!supabaseClient) { alert('Error: Sin conexi√≥n a Supabase'); return; }
      var email = document.getElementById('ssFormEmail').value.trim();
      if (!email) { alert('Por favor ingresa el email del estudiante'); return; }
      try {
        var survey = {
          student_email: email,
          tipo: document.getElementById('ssFormTipo').value,
          como_ingreso: document.getElementById('ssFormIngreso').value,
          quien_ayudo: document.getElementById('ssFormAyuda').value,
          quien_ayudo_nombre: document.getElementById('ssFormAyudaNombre').value.trim(),
          rating_general: ssRatings.general,
          rating_clases_online: ssRatings.online,
          rating_clases_vivo: ssRatings.vivo,
          comentarios: document.getElementById('ssFormComentarios').value.trim(),
          certificado_obtenido: document.getElementById('ssFormCertificado').value,
          progreso_notas: document.getElementById('ssFormProgreso').value.trim(),
          motivo_cancelacion: document.getElementById('ssFormMotivoCancelacion') ? document.getElementById('ssFormMotivoCancelacion').value : '',
          motivo_cancelacion_detalle: document.getElementById('ssFormMotivoCancelacionDetalle') ? document.getElementById('ssFormMotivoCancelacionDetalle').value.trim() : '',
          retencion_ofrecida: document.getElementById('ssFormRetencion') ? document.getElementById('ssFormRetencion').value : '',
          notas_agente: document.getElementById('ssFormNotas').value.trim(),
          created_at: new Date().toISOString()
        };
        await supabaseClient.from('student_success_surveys').insert(survey);
        alert('‚úÖ Survey guardado exitosamente');
        // Reset form
        document.getElementById('ssFormEmail').value = '';
        document.getElementById('ssStudentInfo').innerHTML = '';
        document.getElementById('ssFormTipo').value = 'seguimiento';
        document.getElementById('ssFormIngreso').value = '';
        document.getElementById('ssFormAyuda').value = '';
        document.getElementById('ssFormAyudaNombre').value = '';
        document.getElementById('ssFormComentarios').value = '';
        document.getElementById('ssFormCertificado').value = '';
        document.getElementById('ssFormProgreso').value = '';
        document.getElementById('ssFormNotas').value = '';
        ssRatings = { general: 0, online: 0, vivo: 0 };
        ['general','online','vivo'].forEach(function(c) { for(var i=1;i<=5;i++) { var b=document.getElementById('ssRate_'+c+'_'+i); if(b) b.style.background='transparent'; } });
        ssToggleCancelFields();
        loadSSStats();
        ssShowTab('surveys');
      } catch(e) { alert('Error guardando survey: ' + e.message); }
    }

    async function loadSSSurveys(filterTipo) {
      var container = document.getElementById('ssSurveysList');
      if (!container || !supabaseClient) return;
      try {
        var query = supabaseClient.from('student_success_surveys').select('*').order('created_at', { ascending: false });
        if (filterTipo) query = query.eq('tipo', filterTipo);
        var { data: surveys } = await query;
        if (!surveys || surveys.length === 0) {
          container.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:30px;"><div style="font-size:36px;">üìã</div><p>No hay surveys' + (filterTipo ? ' de tipo "' + filterTipo + '"' : '') + '</p></div>';
          return;
        }
        // Lookup all student emails to get their info
        var emails = [...new Set(surveys.map(function(s) { return s.student_email; }))];
        var techMap = {};
        for (var ei = 0; ei < emails.length; ei++) {
          try {
            var { data: tch } = await supabaseClient.from('technicians').select('nombre,telefono,ciudad,technician_number').eq('email', emails[ei]).single();
            if (tch) techMap[emails[ei]] = tch;
          } catch(e) {}
        }
        
        container.innerHTML = surveys.map(function(s) {
          var tc = s.tipo === 'cancelacion' ? '#e74c3c' : s.tipo === 'pago_fallido' ? '#f39c12' : s.tipo === 'nuevo_ingreso' ? '#27ae60' : '#3498db';
          var ti = s.tipo === 'cancelacion' ? 'üö™' : s.tipo === 'pago_fallido' ? 'üí≥' : s.tipo === 'nuevo_ingreso' ? 'üéâ' : 'üìû';
          var fecha = new Date(s.created_at).toLocaleDateString('es-MX', {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
          var stars = function(n) { return n ? '‚≠ê'.repeat(Math.min(n,5)) + '(' + n + '/5)' : '-'; };
          var tech = techMap[s.student_email] || {};
          var nombre = tech.nombre || 'N/A';
          var tel = tech.telefono || '';
          
          return '<div style="background:rgba(255,255,255,0.05);border-left:4px solid ' + tc + ';border-radius:8px;padding:12px;margin-bottom:8px;">' +
            '<div style="display:flex;justify-content:space-between;align-items:flex-start;">' +
              '<div>' +
                '<strong style="color:#e2e8f0;font-size:14px;">üë§ ' + nombre + '</strong>' +
                '<span style="color:#64748b;font-size:11px;margin-left:6px;">#' + (tech.technician_number || 'N/A') + '</span>' +
                '<p style="color:#94a3b8;font-size:11px;margin:2px 0 0;">üìß ' + s.student_email + (tel ? ' | üì± ' + tel : '') + (tech.ciudad ? ' | üèôÔ∏è ' + tech.ciudad : '') + '</p>' +
              '</div>' +
              '<span style="background:' + tc + ';color:white;padding:2px 8px;border-radius:10px;font-size:10px;white-space:nowrap;">' + ti + ' ' + s.tipo + '</span>' +
            '</div>' +
            '<div style="color:#94a3b8;font-size:11px;margin-top:8px;">' +
              'üìÖ ' + fecha + ' | Ingreso: ' + (s.como_ingreso || '-') + ' | Ayud√≥: ' + (s.quien_ayudo || '-') + ' | Cert: ' + (s.certificado_obtenido || '-') +
            '</div>' +
            '<div style="color:#64748b;font-size:11px;margin-top:3px;">' +
              'General: ' + stars(s.rating_general) + ' | Online: ' + stars(s.rating_clases_online) + ' | Vivo: ' + stars(s.rating_clases_vivo) +
            '</div>' +
            (s.comentarios ? '<div style="color:#cbd5e1;font-size:11px;margin-top:4px;font-style:italic;background:rgba(255,255,255,0.03);padding:6px;border-radius:6px;">"' + s.comentarios.substring(0,150) + '"</div>' : '') +
            (s.motivo_cancelacion ? '<div style="color:#e74c3c;font-size:11px;margin-top:4px;">üö™ Motivo: ' + s.motivo_cancelacion + (s.motivo_cancelacion_detalle ? ' ‚Äî ' + s.motivo_cancelacion_detalle.substring(0,80) : '') + '</div>' : '') +
            (s.retencion_ofrecida ? '<div style="color:#f39c12;font-size:11px;margin-top:2px;">ü§ù Retenci√≥n: ' + s.retencion_ofrecida + '</div>' : '') +
            '<div style="display:flex;gap:6px;margin-top:8px;">' +
              (tel ? '<a href="tel:' + tel + '" style="background:#27ae60;color:white;text-decoration:none;padding:4px 10px;border-radius:6px;font-size:10px;">üìû Llamar</a>' : '') +
              (tel ? '<a href="sms:' + tel + '" style="background:#3498db;color:white;text-decoration:none;padding:4px 10px;border-radius:6px;font-size:10px;">üí¨ SMS</a>' : '') +
              '<a href="javascript:void(0)" onclick="openEmailComposer(\'' + s.student_email + '\',\'ACVOLT - Seguimiento\',\'Hola ' + (nombre || '') + ',\\n\\n\')" style="background:#9b59b6;color:white;text-decoration:none;padding:4px 10px;border-radius:6px;font-size:10px;cursor:pointer;">üìß Email</a>' +
            '</div>' +
          '</div>';
        }).join('');
      } catch(e) { container.innerHTML = '<div style="color:#e74c3c;padding:10px;">Error: ' + e.message + '</div>'; }
    }
    async function ssCreateStaff() {
      if (!supabaseClient) { alert('Sin conexi√≥n a Supabase'); return; }
      var username = document.getElementById('staffFormUser').value.trim();
      var password = document.getElementById('staffFormPass').value.trim();
      var nombre = document.getElementById('staffFormNombre').value.trim();
      var email = document.getElementById('staffFormEmail').value.trim();
      var telefono = document.getElementById('staffFormTel').value.trim();
      var rol = document.getElementById('staffFormRol').value;
      
      if (!username || !password || !nombre) { alert('Username, contrase√±a y nombre son obligatorios'); return; }
      if (password.length < 6) { alert('La contrase√±a debe tener al menos 6 caracteres'); return; }
      
      try {
        var { error } = await supabaseClient.from('admin_staff').insert({
          username: username,
          password_hash: password,
          nombre: nombre,
          email: email || null,
          telefono: telefono || null,
          rol: rol,
          created_by: sessionStorage.getItem('admin_name') || 'admin33'
        });
        if (error) { alert('Error: ' + error.message); return; }
        alert('‚úÖ Usuario "' + username + '" creado exitosamente');
        document.getElementById('staffFormUser').value = '';
        document.getElementById('staffFormPass').value = '';
        document.getElementById('staffFormNombre').value = '';
        document.getElementById('staffFormEmail').value = '';
        document.getElementById('staffFormTel').value = '';
        loadSSStaff();
      } catch(e) { alert('Error creando usuario: ' + e.message); }
    }

    async function loadSSStaff() {
      var container = document.getElementById('ssStaffList');
      if (!container || !supabaseClient) return;
      try {
        var { data: staff } = await supabaseClient.from('admin_staff').select('*').order('created_at', { ascending: false });
        if (!staff || staff.length === 0) {
          container.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:20px;">No hay usuarios registrados</div>';
          return;
        }
        container.innerHTML = staff.map(function(s) {
          var rolColor = s.rol === 'master' ? '#e67e22' : '#3498db';
          var rolIcon = s.rol === 'master' ? 'üëë' : 'üé´';
          var statusColor = s.activo ? '#27ae60' : '#e74c3c';
          var lastLogin = s.last_login ? new Date(s.last_login).toLocaleDateString('es-MX', {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : 'Nunca';
          return '<div style="background:rgba(255,255,255,0.05);border-left:4px solid ' + rolColor + ';border-radius:8px;padding:10px;margin-bottom:6px;">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;">' +
              '<div>' +
                '<strong style="color:#e2e8f0;font-size:14px;">' + rolIcon + ' ' + s.nombre + '</strong>' +
                '<span style="color:#64748b;font-size:11px;margin-left:8px;">@' + s.username + '</span>' +
              '</div>' +
              '<div style="display:flex;gap:6px;align-items:center;">' +
                '<span style="background:' + rolColor + ';color:white;padding:2px 8px;border-radius:10px;font-size:10px;">' + s.rol + '</span>' +
                '<span style="background:' + statusColor + ';color:white;padding:2px 8px;border-radius:10px;font-size:10px;">' + (s.activo ? 'Activo' : 'Inactivo') + '</span>' +
              '</div>' +
            '</div>' +
            '<div style="color:#94a3b8;font-size:11px;margin-top:4px;">' +
              (s.email ? 'üìß ' + s.email + ' | ' : '') +
              (s.telefono ? 'üì± ' + s.telefono + ' | ' : '') +
              'üïê √öltimo login: ' + lastLogin +
            '</div>' +
            (s.username !== 'admin33' ? '<div style="margin-top:6px;"><button onclick="ssToggleStaff(\'' + s.id + '\',' + !s.activo + ')" style="background:' + (s.activo ? '#e74c3c' : '#27ae60') + ';color:white;border:none;padding:3px 10px;border-radius:5px;font-size:10px;cursor:pointer;">' + (s.activo ? 'üö´ Desactivar' : '‚úÖ Activar') + '</button></div>' : '') +
          '</div>';
        }).join('');
      } catch(e) { container.innerHTML = '<div style="color:#e74c3c;padding:10px;">Error: ' + e.message + '</div>'; }
    }

    async function ssToggleStaff(id, activate) {
      if (!supabaseClient) return;
      try {
        await supabaseClient.from('admin_staff').update({ activo: activate }).eq('id', id);
        loadSSStaff();
      } catch(e) { alert('Error: ' + e.message); }
    }
    // ========== END STUDENT SUCCESS FUNCTIONS ==========

    // Log exam request to Supabase
    async function logExamRequest(examName, examPrice, nombre, email, techNumber, studentId, results) {
      try {
        if (!supabaseClient) return;
        await supabaseClient.from('exam_requests').insert({
          exam_name: examName,
          exam_price: examPrice,
          student_name: nombre,
          student_email: email,
          tech_number: techNumber,
          student_id: studentId,
          results_summary: results,
          status: 'pending',
          requested_at: new Date().toISOString()
        });
      } catch(e) { console.log('[Admin] Exam request log error:', e); }
      // Also save locally as fallback
      try {
        var requests = JSON.parse(localStorage.getItem('maestroac_exam_requests') || '[]');
        requests.push({ examName:examName, examPrice:examPrice, nombre:nombre, email:email, techNumber:techNumber, studentId:studentId, results:results, date: new Date().toISOString(), status:'pending' });
        localStorage.setItem('maestroac_exam_requests', JSON.stringify(requests));
      } catch(e) {}
    }

    // Load exam requests for admin
    async function loadAdminExamRequests() {
      var container = document.getElementById('adminExamRequestsList');
      if (!container) return;
      var requests = [];
      
      // Try Supabase first
      try {
        if (supabaseClient) {
          var { data } = await supabaseClient.from('exam_requests').select('*').order('requested_at', { ascending: false }).limit(50);
          if (data && data.length > 0) requests = data;
        }
      } catch(e) { console.log('[Admin] Load exam requests from Supabase:', e); }

      // Fallback to localStorage
      if (requests.length === 0) {
        try {
          requests = JSON.parse(localStorage.getItem('maestroac_exam_requests') || '[]').reverse();
        } catch(e) {}
      }

      document.getElementById('examRequestCount').textContent = requests.length + ' solicitudes';

      if (requests.length === 0) {
        container.innerHTML = '<div class="no-data-message"><div class="no-data-icon">üéì</div><p>No hay solicitudes de examen a√∫n.</p></div>';
        return;
      }

      container.innerHTML = requests.map(function(r) {
        var date = new Date(r.requested_at || r.date).toLocaleDateString('es-MX', {year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
        var statusColor = r.status === 'approved' ? '#2ecc71' : r.status === 'rejected' ? '#e74c3c' : '#f39c12';
        var statusText = r.status === 'approved' ? '‚úÖ Aprobado' : r.status === 'rejected' ? '‚ùå Rechazado' : '‚è≥ Pendiente';
        return '<div style="background:rgba(255,255,255,0.05);border:1px solid rgba(243,156,18,0.2);border-radius:12px;padding:12px;margin-bottom:8px;">' +
          '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">' +
            '<strong style="color:#f39c12;font-size:14px;">üéì ' + (r.exam_name || r.examName) + '</strong>' +
            '<span style="color:' + statusColor + ';font-size:12px;font-weight:bold;">' + statusText + '</span>' +
          '</div>' +
          '<p style="color:#e2e8f0;font-size:13px;margin:0 0 4px;">üë§ ' + (r.student_name || r.nombre) + ' ‚Äî ' + (r.student_email || r.email) + '</p>' +
          '<p style="color:#94a3b8;font-size:12px;margin:0 0 4px;">üî¢ ' + (r.tech_number || r.techNumber || 'N/A') + ' | ü™™ ' + (r.student_id || r.studentId || 'N/A') + '</p>' +
          '<p style="color:#94a3b8;font-size:11px;margin:0 0 4px;">üìä ' + (r.results_summary || r.results || 'N/A') + '</p>' +
          '<p style="color:#64748b;font-size:11px;margin:0;">üìÖ ' + date + ' | üí∞ ' + (r.exam_price || r.examPrice) + '</p>' +
        '</div>';
      }).join('');
    }

    // Load student activity for admin
    async function loadAdminStudentActivity() {
      var container = document.getElementById('adminStudentActivityList');
      if (!container) return;
      var activities = [];

      // Try Supabase activity_log
      try {
        if (supabaseClient) {
          var { data } = await supabaseClient.from('activity_log').select('*').order('created_at', { ascending: false }).limit(100);
          if (data && data.length > 0) activities = data;
        }
      } catch(e) { console.log('[Admin] Load activity:', e); }

      // Fallback: build from technicians data
      if (activities.length === 0) {
        allTechnicians.forEach(function(tech) {
          if (tech.progress) {
            Object.keys(tech.progress).forEach(function(lvl) {
              var p = tech.progress[lvl];
              if (p && p.completed > 0) {
                var pct = Math.round((p.score / p.completed) * 100);
                activities.push({
                  type: pct >= 100 ? 'level_complete_100' : pct >= 70 ? 'level_passed' : 'level_progress',
                  email: tech.email,
                  nombre: tech.nombre,
                  level: lvl,
                  score: pct,
                  completed: p.completed,
                  created_at: tech.lastActive || new Date().toISOString()
                });
              }
            });
          }
        });
        activities.sort(function(a,b) { return new Date(b.created_at) - new Date(a.created_at); });
      }

      if (activities.length === 0) {
        container.innerHTML = '<div class="no-data-message"><div class="no-data-icon">üìä</div><p>No hay actividad registrada.</p></div>';
        return;
      }

      var levelIcons = { principiante:'üü¢', intermedio:'üîµ', avanzado:'üü°', elite:'üü†', platino:'üíé' };
      container.innerHTML = activities.slice(0, 80).map(function(a) {
        var date = new Date(a.created_at).toLocaleDateString('es-MX', {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
        var icon = 'üìã';
        var color = '#94a3b8';
        var text = '';
        
        if (a.type === 'level_complete_100' || (a.score && a.score >= 100)) {
          icon = 'üèÜ'; color = '#f39c12';
          text = '¬°100% en ' + (a.level || a.detail || '') + '!';
        } else if (a.type === 'level_passed' || (a.score && a.score >= 70)) {
          icon = '‚úÖ'; color = '#2ecc71';
          text = 'Pas√≥ ' + (a.level || a.detail || '') + ' con ' + (a.score || '') + '%';
        } else if (a.type === 'level_progress') {
          icon = 'üìù'; color = '#3498db';
          text = 'Progreso en ' + (a.level || a.detail || '') + ': ' + (a.score || '') + '%';
        } else if (a.type === 'login') {
          icon = 'üîì'; color = '#6366f1';
          text = 'Inicio de sesi√≥n';
        } else if (a.type === 'quiz_start') {
          icon = 'üìù'; color = '#3498db';
          text = 'Inici√≥ quiz: ' + (a.detail || '');
        } else if (a.type === 'checkin') {
          icon = '‚úÖ'; color = '#2ecc71';
          text = 'Check-in';
        } else if (a.type === 'checkout') {
          icon = 'üö™'; color = '#e74c3c';
          text = 'Check-out';
        } else {
          text = a.type + (a.detail ? ': ' + a.detail : '');
        }

        var lvlIcon = a.level ? (levelIcons[a.level] || 'üìã') : '';
        return '<div style="display:flex;gap:10px;padding:8px;border-bottom:1px solid rgba(255,255,255,0.05);align-items:center;">' +
          '<span style="font-size:20px;">' + icon + '</span>' +
          '<div style="flex:1;min-width:0;">' +
            '<p style="color:' + color + ';font-size:13px;font-weight:bold;margin:0;">' + lvlIcon + ' ' + text + '</p>' +
            '<p style="color:#64748b;font-size:11px;margin:2px 0 0;">üë§ ' + (a.nombre || a.email || 'T√©cnico') + ' ‚Äî ' + date + '</p>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    // Update admin statistics
    function updateAdminStats() {
      const totalTechs = allTechnicians.length;
      const totalCerts = allTechnicians.reduce((sum, t) => sum + (t.certificates ? t.certificates.length : 0), 0);

      // Calculate average score
      let totalScore = 0;
      let totalCompleted = 0;
      allTechnicians.forEach(t => {
        if (t.progress) {
          Object.values(t.progress).forEach(p => {
            if (p.completed > 0) {
              totalScore += (p.score / p.completed) * 100;
              totalCompleted++;
            }
          });
        }
      });
      const avgScore = totalCompleted > 0 ? Math.round(totalScore / totalCompleted) : 0;

      // Count active today
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const activeToday = allTechnicians.filter(t => {
        if (t.lastActive) {
          const lastActive = new Date(t.lastActive);
          return lastActive >= today;
        }
        return false;
      }).length;

      document.getElementById('statTotalTecnicos').textContent = totalTechs;
      document.getElementById('statTotalCertificados').textContent = totalCerts;
      document.getElementById('statPromedioScore').textContent = avgScore + '%';
      document.getElementById('statActivosHoy').textContent = activeToday;
    }

    // Show stat detail when clicking dashboard cards
    function showStatDetail(type) {
      const panel = document.getElementById('statDetailPanel');
      const title = document.getElementById('statDetailTitle');
      const content = document.getElementById('statDetailContent');
      panel.style.display = 'block';

      if (type === 'tecnicos') {
        title.textContent = 'üë• T√©cnicos Registrados (' + allTechnicians.length + ')';
        const withAccess = allTechnicians.filter(t => {
          const list = JSON.parse(localStorage.getItem('maestroac_app_access_list') || '[]');
          return list.includes(t.email);
        }).length;
        const withCodes = Object.values(getAccessCodes()).filter(c => !c.revoked).length;
        content.innerHTML = `
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
            <div style="background:rgba(46,204,113,0.15);border-radius:8px;padding:10px;text-align:center;">
              <div style="color:#2ecc71;font-size:18px;font-weight:bold;">${withAccess}</div>
              <div style="color:#64748b;font-size:11px;">Con Acceso Completo</div>
            </div>
            <div style="background:rgba(231,76,60,0.15);border-radius:8px;padding:10px;text-align:center;">
              <div style="color:#e74c3c;font-size:18px;font-weight:bold;">${allTechnicians.length - withAccess}</div>
              <div style="color:#64748b;font-size:11px;">Solo Nivel Gratis</div>
            </div>
            <div style="background:rgba(155,89,182,0.15);border-radius:8px;padding:10px;text-align:center;">
              <div style="color:#9b59b6;font-size:18px;font-weight:bold;">${withCodes}</div>
              <div style="color:#64748b;font-size:11px;">C√≥digos Activos</div>
            </div>
            <div style="background:rgba(52,152,219,0.15);border-radius:8px;padding:10px;text-align:center;">
              <div style="color:#3498db;font-size:18px;font-weight:bold;">${allTechnicians.filter(t => t.technicianNumber).length}</div>
              <div style="color:#64748b;font-size:11px;">Con # T√©cnico</div>
            </div>
          </div>
          <p style="color:#7f8c8d;font-size:11px;">√öltimos registros:</p>
          ${allTechnicians.slice(0, 5).map(t => `<div style="color:#64748b;font-size:12px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.05);">${t.nombre || 'Sin nombre'} - ${t.email || ''}</div>`).join('')}
        `;
      }

      else if (type === 'certificados') {
        title.textContent = 'üèÖ Certificados Otorgados';
        const allCerts = [];
        allTechnicians.forEach(t => {
          if (t.certificates && t.certificates.length > 0) {
            t.certificates.forEach(c => {
              allCerts.push({ nombre: t.nombre || t.email, cert: c.name || c.level || 'Certificado', date: c.date || c.timestamp });
            });
          }
        });
        if (allCerts.length === 0) {
          content.innerHTML = '<p style="color:#64748b;font-size:13px;text-align:center;">Ning√∫n t√©cnico ha obtenido certificados a√∫n.</p>';
        } else {
          content.innerHTML = allCerts.map(c => `
            <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);">
              <div>
                <div style="color:#1e293b;font-size:12px;font-weight:600;">${c.nombre}</div>
                <div style="color:#f39c12;font-size:11px;">${c.cert}</div>
              </div>
              <span style="color:#7f8c8d;font-size:10px;">${c.date ? new Date(c.date).toLocaleDateString('es-MX') : ''}</span>
            </div>
          `).join('');
        }
      }

      else if (type === 'promedio') {
        title.textContent = 'üìä Promedio por Nivel';
        const levelStats = {};
        levels.forEach(l => { levelStats[l.id] = { total: 0, count: 0 }; });
        allTechnicians.forEach(t => {
          if (t.progress) {
            Object.keys(t.progress).forEach(levelId => {
              const p = t.progress[levelId];
              if (p.completed > 0 && levelStats[levelId]) {
                levelStats[levelId].total += (p.score / p.completed) * 100;
                levelStats[levelId].count++;
              }
            });
          }
        });
        content.innerHTML = levels.map(l => {
          const s = levelStats[l.id];
          const avg = s.count > 0 ? Math.round(s.total / s.count) : 0;
          const color = avg >= 70 ? '#2ecc71' : avg >= 50 ? '#f39c12' : '#e74c3c';
          return `
            <div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);">
              <span style="font-size:16px;">${l.icon}</span>
              <div style="flex:1;">
                <div style="color:#1e293b;font-size:12px;">${l.name}</div>
                <div style="background:rgba(255,255,255,0.1);border-radius:4px;height:8px;margin-top:3px;overflow:hidden;">
                  <div style="width:${avg}%;height:100%;background:${color};border-radius:4px;"></div>
                </div>
              </div>
              <span style="color:${color};font-size:14px;font-weight:bold;min-width:40px;text-align:right;">${avg}%</span>
              <span style="color:#7f8c8d;font-size:10px;">(${s.count})</span>
            </div>
          `;
        }).join('');
      }

      else if (type === 'activos') {
        title.textContent = 'üü¢ T√©cnicos Activos Hoy';
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const activeTechs = allTechnicians.filter(t => {
          if (t.lastActive) return new Date(t.lastActive) >= today;
          return false;
        });
        if (activeTechs.length === 0) {
          content.innerHTML = '<p style="color:#64748b;font-size:13px;text-align:center;">Ning√∫n t√©cnico ha estado activo hoy.</p>';
        } else {
          content.innerHTML = activeTechs.map(t => {
            const mins = Math.round((Date.now() - new Date(t.lastActive).getTime()) / 60000);
            const timeAgo = mins < 60 ? `Hace ${mins} min` : `Hace ${Math.round(mins/60)} hrs`;
            return `
              <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;" onclick="viewTechnicianProfile('${t.email}')">
                <div>
                  <div style="color:#1e293b;font-size:12px;font-weight:600;">${t.nombre || 'Sin nombre'}</div>
                  <div style="color:#7f8c8d;font-size:10px;">${t.email || ''}</div>
                </div>
                <span style="color:#2ecc71;font-size:11px;">üü¢ ${timeAgo}</span>
              </div>
            `;
          }).join('');
        }
      }

      // Scroll to panel
      panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Render technician list
    function renderTechnicianList(filter = '') {
      const container = document.getElementById('technicianList');
      const period = document.getElementById('filterPeriod').value;

      let filtered = [...allTechnicians];

      // Apply search filter
      if (filter) {
        const searchLower = filter.toLowerCase();
        filtered = filtered.filter(t =>
          (t.nombre && t.nombre.toLowerCase().includes(searchLower)) ||
          (t.email && t.email.toLowerCase().includes(searchLower)) ||
          (t.technicianNumber && t.technicianNumber.toLowerCase().includes(searchLower))
        );
      }

      // Apply period filter
      if (period !== 'all') {
        const now = new Date();
        filtered = filtered.filter(t => {
          if (!t.lastActive) return false;
          const lastActive = new Date(t.lastActive);
          const diffHours = (now - lastActive) / (1000 * 60 * 60);

          switch(period) {
            case 'today': return diffHours <= 24;
            case 'week': return diffHours <= 168;
            case 'month': return diffHours <= 720;
            default: return true;
          }
        });
      }

      document.getElementById('technicianCount').textContent = `${filtered.length} t√©cnico${filtered.length !== 1 ? 's' : ''}`;

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="no-data-message">
            <div class="no-data-icon">üîç</div>
            <p>No se encontraron t√©cnicos con los filtros aplicados.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = filtered.map((tech, index) => {
        const certCount = tech.certificates ? tech.certificates.length : 0;
        const lastActiveStr = tech.lastActive ? formatTimeAgo(new Date(tech.lastActive)) : 'Sin actividad';

        return `
          <div class="technician-card" onclick="viewTechnicianProfile(${index})">
            <div class="technician-card-header">
              <span class="technician-name">${tech.nombre || 'Sin nombre'}</span>
              <span class="technician-id">${tech.technicianNumber || 'Sin n√∫mero'}</span>
            </div>
            <div class="technician-meta">
              <span class="technician-meta-item">üìß ${tech.email || '-'}</span>
              <span class="technician-meta-item">üèÖ ${certCount} certificado${certCount !== 1 ? 's' : ''}</span>
              <span class="technician-meta-item">üïê ${lastActiveStr}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // Filter technicians
    function filterTechnicians() {
      const searchValue = document.getElementById('searchTechnician').value;
      renderTechnicianList(searchValue);
    }

    // Format time ago
    function formatTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffMins < 1) return 'Hace un momento';
      if (diffMins < 60) return `Hace ${diffMins} minuto${diffMins !== 1 ? 's' : ''}`;
      if (diffHours < 24) return `Hace ${diffHours} hora${diffHours !== 1 ? 's' : ''}`;
      if (diffDays < 30) return `Hace ${diffDays} d√≠a${diffDays !== 1 ? 's' : ''}`;
      return date.toLocaleDateString('es-ES');
    }

    // Render level performance chart
    function renderLevelPerformanceChart() {
      const container = document.getElementById('levelBarChart');
      const levelStats = {};

      levels.forEach(level => {
        levelStats[level.id] = { total: 0, passed: 0, avgScore: 0, scores: [] };
      });

      allTechnicians.forEach(tech => {
        if (tech.progress) {
          Object.keys(tech.progress).forEach(levelId => {
            const p = tech.progress[levelId];
            if (p.completed > 0) {
              levelStats[levelId].total++;
              const score = Math.round((p.score / p.completed) * 100);
              levelStats[levelId].scores.push(score);
              if (score >= 70) levelStats[levelId].passed++;
            }
          });
        }
      });

      // Calculate averages
      Object.keys(levelStats).forEach(levelId => {
        const stats = levelStats[levelId];
        if (stats.scores.length > 0) {
          stats.avgScore = Math.round(stats.scores.reduce((a, b) => a + b, 0) / stats.scores.length);
        }
      });

      container.innerHTML = levels.map(level => {
        const stats = levelStats[level.id];
        const avgScore = stats.avgScore;
        const color = avgScore >= 70 ? '#27ae60' : avgScore >= 50 ? '#f39c12' : '#e74c3c';

        return `
          <div class="admin-bar-item">
            <span class="admin-bar-label">${level.icon} ${level.name}</span>
            <div class="admin-bar-container">
              <div class="admin-bar-fill" style="width: ${avgScore}%; background: ${color};">
                ${avgScore > 10 ? avgScore + '%' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // View technician profile
    async function viewTechnicianProfile(index) {
      currentViewingTechnician = allTechnicians[index];

      // Update profile info
      document.getElementById('adminViewName').textContent = currentViewingTechnician.nombre || 'Sin nombre';
      document.getElementById('adminViewTechNumber').textContent = currentViewingTechnician.technicianNumber || 'Sin n√∫mero asignado';
      document.getElementById('adminViewEmail').textContent = currentViewingTechnician.email || '-';
      document.getElementById('adminViewPhone').textContent = currentViewingTechnician.telefono || '-';
      document.getElementById('adminViewEPA').textContent = currentViewingTechnician.epa || 'No registrado';
      document.getElementById('adminViewNATE').textContent = currentViewingTechnician.nate || 'No registrado';
      document.getElementById('adminViewESCO').textContent = currentViewingTechnician.esco || 'No registrado';

      // Load technician photo from Supabase
      var photoImg = document.getElementById('adminViewPhoto');
      var photoEmoji = document.getElementById('adminViewPhotoEmoji');
      
      // Reset to default
      if (photoImg) { photoImg.style.display = 'none'; photoImg.src = ''; }
      if (photoEmoji) { photoEmoji.style.display = 'block'; }
      
      // Try to load from Supabase users table
      if (supabaseClient && currentViewingTechnician.email) {
        try {
          var { data: techData } = await supabaseClient.from('users')
            .select('photo_url')
            .eq('email', currentViewingTechnician.email)
            .single();
          
          if (techData && techData.photo_url) {
            if (photoImg) {
              photoImg.src = techData.photo_url;
              photoImg.style.display = 'block';
            }
            if (photoEmoji) {
              photoEmoji.style.display = 'none';
            }
          }
        } catch(e) { console.log('Error loading technician photo:', e); }
      }

      const regDate = currentViewingTechnician.registrationDate
        ? new Date(currentViewingTechnician.registrationDate).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })
        : '-';
      document.getElementById('adminViewRegDate').textContent = regDate;

      // Update app access status
      updateAppAccessUI();

      // Render progress chart
      renderTechnicianProgressChart();

      // Render activity timeline
      renderActivityTimeline();

      // Render certificates
      renderTechnicianCertificates();

      // Render lock management
      renderAdminLockManagement();

      // Show access code status
      updateAdminCodeDisplay();

      // Show membership code status
      updateAdminMemberCodeDisplay();

      showScreen('adminTechnicianProfileScreen');
    }

    // Render technician progress chart
    function renderTechnicianProgressChart() {
      const container = document.getElementById('technicianLevelProgress');
      const progress = currentViewingTechnician.progress || {};

      container.innerHTML = levels.map(level => {
        const p = progress[level.id] || { completed: 0, score: 0, total: level.questions || 50 };
        const percentage = p.completed > 0 ? Math.round((p.score / p.completed) * 100) : 0;
        const completedPct = Math.round((p.completed / p.total) * 100);
        const color = percentage >= 70 ? '#27ae60' : percentage >= 50 ? '#f39c12' : '#e74c3c';

        return `
          <div class="admin-bar-item">
            <span class="admin-bar-label">${level.icon} ${level.name}</span>
            <div class="admin-bar-container">
              <div class="admin-bar-fill" style="width: ${percentage}%; background: ${color};">
                ${percentage > 10 ? percentage + '% (' + p.score + '/' + p.completed + ')' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Set timeline view
    function setTimelineView(view, btn) {
      currentTimelineView = view;
      document.querySelectorAll('.timeline-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      renderActivityTimeline();
    }

    // Render activity timeline
    function renderActivityTimeline() {
      const container = document.getElementById('activityTimeline');
      const email = currentViewingTechnician ? currentViewingTechnician.email : null;
      const activityLog = email ? getActivityLog(email) : [];

      if (activityLog.length === 0) {
        // Show stats summary even if no detailed log
        const stats = email ? getActivityStats(email) : null;
        if (stats && stats.totalMinutes > 0) {
          container.innerHTML = `
            <div style="padding:10px;">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
                <div style="background:rgba(46,204,113,0.15);border-radius:10px;padding:10px;text-align:center;">
                  <div style="color:#2ecc71;font-size:20px;font-weight:bold;">${stats.totalMinutes}</div>
                  <div style="color:#64748b;font-size:11px;">Minutos</div>
                </div>
                <div style="background:rgba(52,152,219,0.15);border-radius:10px;padding:10px;text-align:center;">
                  <div style="color:#3498db;font-size:20px;font-weight:bold;">${stats.totalSessions}</div>
                  <div style="color:#64748b;font-size:11px;">Sesiones</div>
                </div>
                <div style="background:rgba(243,156,18,0.15);border-radius:10px;padding:10px;text-align:center;">
                  <div style="color:#f39c12;font-size:20px;font-weight:bold;">${stats.quizzes}</div>
                  <div style="color:#64748b;font-size:11px;">Quizzes</div>
                </div>
                <div style="background:rgba(155,89,182,0.15);border-radius:10px;padding:10px;text-align:center;">
                  <div style="color:#9b59b6;font-size:20px;font-weight:bold;">${stats.questionsAnswered}</div>
                  <div style="color:#64748b;font-size:11px;">Respuestas</div>
                </div>
              </div>
              ${stats.lastActive ? '<p style="color:#7f8c8d;font-size:11px;text-align:center;">√öltima actividad: ' + new Date(stats.lastActive).toLocaleDateString('es-MX') + '</p>' : ''}
            </div>
          `;
        } else {
          container.innerHTML = `
            <div class="timeline-empty">
              <p>üì≠ No hay actividad registrada para este t√©cnico</p>
            </div>
          `;
        }
        return;
      }

      // Show stats + recent activity
      const stats = getActivityStats(email);
      const recentLog = activityLog.slice(-20).reverse();

      const activityIcons = {
        'login': 'üîë',
        'quiz_start': 'üéØ',
        'answer': '‚úèÔ∏è',
        'study': 'üìñ',
        'video': 'üé¨'
      };

      container.innerHTML = `
        <div style="padding:10px;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
            <div style="background:rgba(46,204,113,0.15);border-radius:10px;padding:10px;text-align:center;">
              <div style="color:#2ecc71;font-size:20px;font-weight:bold;">${stats.totalMinutes}</div>
              <div style="color:#64748b;font-size:11px;">Minutos</div>
            </div>
            <div style="background:rgba(52,152,219,0.15);border-radius:10px;padding:10px;text-align:center;">
              <div style="color:#3498db;font-size:20px;font-weight:bold;">${stats.totalSessions}</div>
              <div style="color:#64748b;font-size:11px;">Sesiones</div>
            </div>
            <div style="background:rgba(243,156,18,0.15);border-radius:10px;padding:10px;text-align:center;">
              <div style="color:#f39c12;font-size:20px;font-weight:bold;">${stats.quizzes}</div>
              <div style="color:#64748b;font-size:11px;">Quizzes</div>
            </div>
            <div style="background:rgba(155,89,182,0.15);border-radius:10px;padding:10px;text-align:center;">
              <div style="color:#9b59b6;font-size:20px;font-weight:bold;">${stats.questionsAnswered}</div>
              <div style="color:#64748b;font-size:11px;">Respuestas</div>
            </div>
          </div>
          <p style="color:#f39c12;font-size:12px;font-weight:bold;margin-bottom:8px;">Actividad Reciente:</p>
          ${recentLog.map(act => {
            const icon = activityIcons[act.type] || 'üìå';
            const time = new Date(act.timestamp);
            const timeStr = time.toLocaleDateString('es-MX', {day:'numeric',month:'short'}) + ' ' + time.toLocaleTimeString('es-MX', {hour:'2-digit',minute:'2-digit'});
            const labels = { login:'Inicio de sesi√≥n', quiz_start:'Inici√≥ quiz', answer:'Respondi√≥ pregunta', study:'Modo estudio', video:'Vio video' };
            return `<div style="display:flex;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);">
              <span style="font-size:16px;">${icon}</span>
              <div style="flex:1;">
                <div style="color:#1e293b;font-size:12px;">${labels[act.type] || act.type}</div>
                <div style="color:#7f8c8d;font-size:10px;">${act.detail || ''}</div>
              </div>
              <span style="color:#7f8c8d;font-size:10px;">${timeStr}</span>
            </div>`;
          }).join('')}
        </div>
      `;
    }

    // Group activities by period
    function groupActivitiesByPeriod(activities, view) {
      const now = new Date();
      const grouped = {};

      activities.forEach(act => {
        const actDate = new Date(act.timestamp);
        const diffMs = now - actDate;
        const diffMins = diffMs / (1000 * 60);
        const diffHours = diffMs / (1000 * 60 * 60);
        const diffDays = diffMs / (1000 * 60 * 60 * 24);

        let include = false;
        let key = '';

        switch(view) {
          case 'minutes':
            if (diffMins <= 60) {
              include = true;
              key = `${Math.floor(diffMins)} minutos`;
            }
            break;
          case 'hours':
            if (diffHours <= 24) {
              include = true;
              key = `${Math.floor(diffHours)} horas`;
            }
            break;
          case 'days':
            if (diffDays <= 30) {
              include = true;
              key = `${Math.floor(diffDays)} d√≠as`;
            }
            break;
          case 'months':
            include = true;
            key = actDate.toLocaleDateString('es-ES', { year: 'numeric', month: 'long' });
            break;
        }

        if (include) {
          if (!grouped[key]) grouped[key] = [];
          grouped[key].push(act);
        }
      });

      return grouped;
    }

    // Format activity date
    function formatActivityDate(timestamp, view) {
      const date = new Date(timestamp);
      switch(view) {
        case 'minutes':
          return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        case 'hours':
          return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        case 'days':
          return date.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
        case 'months':
          return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
        default:
          return date.toLocaleDateString('es-ES');
      }
    }

    // Get activity title
    function getActivityTitle(activity) {
      const levelName = levels.find(l => l.id === activity.level)?.name || activity.level;

      switch(activity.action) {
        case 'quiz_started': return `üéØ Inici√≥ Quiz ${levelName}`;
        case 'quiz_completed': return `‚úÖ Complet√≥ Quiz ${levelName}`;
        case 'certificate_earned': return `üèÖ Obtuvo Certificado ${levelName}`;
        case 'profile_created': return 'üë§ Cre√≥ su Perfil';
        case 'login': return 'üîë Inici√≥ Sesi√≥n';
        default: return 'üìå Actividad';
      }
    }

    // Get activity detail
    function getActivityDetail(activity) {
      switch(activity.action) {
        case 'quiz_completed':
        case 'certificate_earned':
          return `Puntuaci√≥n: ${activity.score}%`;
        case 'quiz_started':
          return 'En progreso...';
        case 'profile_created':
          return 'Nuevo t√©cnico registrado';
        default:
          return '';
      }
    }

    // Render technician certificates
    function renderTechnicianCertificates() {
      const container = document.getElementById('adminTechnicianCertificates');
      const certs = currentViewingTechnician.certificates || [];

      if (certs.length === 0) {
        container.innerHTML = `
          <div class="no-data-message">
            <div class="no-data-icon">üéì</div>
            <p>Este t√©cnico no ha obtenido certificados a√∫n.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = certs.map(cert => `
        <div class="certificate-card" style="margin-bottom: 15px;">
          <span class="certificate-earned-badge">APROBADO</span>
          <div class="certificate-badge">${cert.levelIcon}</div>
          <div class="certificate-level">Nivel ${cert.levelName}</div>
          <div class="certificate-details">
            <div class="certificate-detail">
              <div class="certificate-detail-label">Puntuaci√≥n</div>
              <div class="certificate-detail-value" style="color: ${cert.score >= 90 ? '#ffd700' : '#27ae60'}">${cert.score}%</div>
            </div>
            <div class="certificate-detail">
              <div class="certificate-detail-label">Fecha</div>
              <div class="certificate-detail-value" style="font-size: 13px;">${cert.date}</div>
            </div>
          </div>
          <div class="certificate-id">ID: ${cert.certificateId}</div>
        </div>
      `).join('');
    }

    // Render admin lock management controls
    // ========== APP ACCESS MANAGEMENT ==========
    function updateAppAccessUI() {
      if (!currentViewingTechnician) return;
      const email = currentViewingTechnician.email;
      const users = JSON.parse(localStorage.getItem('maestroac_users') || '{}');
      const user = users[email];
      const appAccessList = JSON.parse(localStorage.getItem('maestroac_app_access_list') || '[]');
      const hasAccess = appAccessList.includes(email);
      
      // Verification status
      const verifyBtn = document.getElementById('adminVerifyBtn');
      const verifyStatus = document.getElementById('adminVerifyStatus');
      if (user && user.verified) {
        verifyBtn.textContent = '‚ùå Revocar Verificaci√≥n';
        verifyBtn.style.background = 'linear-gradient(135deg,#e74c3c,#c0392b)';
        verifyStatus.textContent = '‚úÖ Cuenta VERIFICADA' + (user.verifyCode ? ' (C√≥digo: ' + user.verifyCode + ')' : '');
        verifyStatus.style.color = '#2ecc71';
      } else {
        verifyBtn.textContent = '‚úÖ Verificar Cuenta';
        verifyBtn.style.background = 'linear-gradient(135deg,#f39c12,#e67e22)';
        verifyStatus.textContent = '‚è≥ Cuenta PENDIENTE de verificaci√≥n' + (user && user.verifyCode ? ' (C√≥digo: ' + user.verifyCode + ')' : '');
        verifyStatus.style.color = '#f39c12';
      }

      // App access status
      const btn = document.getElementById('adminActivateAppBtn');
      const status = document.getElementById('adminAppAccessStatus');
      if (hasAccess) {
        btn.textContent = 'üîí Revocar Acceso';
        btn.style.background = 'linear-gradient(135deg,#e74c3c,#c0392b)';
        status.textContent = '‚úÖ Acceso completo a la app ACTIVADO';
        status.style.color = '#2ecc71';
      } else {
        btn.textContent = 'üîì Activar App Completa';
        btn.style.background = 'linear-gradient(135deg,#2ecc71,#27ae60)';
        status.textContent = 'üîí Solo acceso al nivel Principiante (gratis)';
        status.style.color = '#e74c3c';
      }
    }

    function toggleVerification() {
      if (!currentViewingTechnician || !currentViewingTechnician.email) {
        alert('Error: Este t√©cnico no tiene email registrado.');
        return;
      }
      const email = currentViewingTechnician.email;
      const users = JSON.parse(localStorage.getItem('maestroac_users') || '{}');
      
      if (!users[email]) {
        alert('Este t√©cnico no se ha registrado en la app a√∫n.');
        return;
      }

      if (users[email].verified) {
        if (!confirm('¬øRevocar verificaci√≥n de ' + (users[email].nombre || email) + '? No podr√° iniciar sesi√≥n.')) return;
        users[email].verified = false;
      } else {
        if (!confirm('¬øVerificar la cuenta de ' + (users[email].nombre || email) + '? Podr√° iniciar sesi√≥n y acceder al Nivel 1 gratis.')) return;
        users[email].verified = true;
      }
      localStorage.setItem('maestroac_users', JSON.stringify(users));
      updateAppAccessUI();
      alert(users[email].verified ? '‚úÖ Cuenta verificada exitosamente' : '‚ùå Verificaci√≥n revocada');
    }

    function toggleAppAccess() {
      if (!currentViewingTechnician || !currentViewingTechnician.email) {
        alert('Error: Este t√©cnico no tiene email registrado.');
        return;
      }
      const email = currentViewingTechnician.email;
      let appAccessList = JSON.parse(localStorage.getItem('maestroac_app_access_list') || '[]');
      const hasAccess = appAccessList.includes(email);
      
      if (hasAccess) {
        if (!confirm('¬øRevocar acceso completo a ' + (currentViewingTechnician.nombre || email) + '?')) return;
        appAccessList = appAccessList.filter(e => e !== email);
      } else {
        if (!confirm('¬øActivar acceso completo a la app para ' + (currentViewingTechnician.nombre || email) + '?')) return;
        appAccessList.push(email);
      }
      localStorage.setItem('maestroac_app_access_list', JSON.stringify(appAccessList));
      updateAppAccessUI();
      alert(hasAccess ? 'üîí Acceso revocado' : '‚úÖ Acceso completo activado para ' + (currentViewingTechnician.nombre || email));
    }

    // ========== ACCESS CODE SYSTEM (Supabase) ==========
    
    async function getAccessCodes() {
      // Try Supabase first
      if (supabaseClient && isOnline) {
        try {
          const { data, error } = await supabaseClient.from('access_codes').select('*');
          if (!error && data) {
            const codes = {};
            data.forEach(row => { codes[row.code] = row; });
            localStorage.setItem('maestroac_access_codes', JSON.stringify(codes));
            return codes;
          }
        } catch(e) { console.log('Supabase access_codes error:', e); }
      }
      return JSON.parse(localStorage.getItem('maestroac_access_codes') || '{}');
    }

    async function saveAccessCode(code, data) {
      // Save to localStorage
      const codes = JSON.parse(localStorage.getItem('maestroac_access_codes') || '{}');
      codes[code] = data;
      localStorage.setItem('maestroac_access_codes', JSON.stringify(codes));
      
      // Save to Supabase
      if (supabaseClient && isOnline) {
        try {
          await supabaseClient.from('access_codes').upsert({
            code: code,
            email: data.email,
            nombre: data.nombre,
            type: data.type || 'app_access',
            used: data.used || false,
            revoked: data.revoked || false,
            created_at: data.createdAt || new Date().toISOString()
          }, { onConflict: 'code' });
        } catch(e) { console.log('Supabase save code error:', e); }
      }
    }

    async function generateAccessCode() {
      if (!currentViewingTechnician || !currentViewingTechnician.email) {
        alert('Error: Este t√©cnico no tiene email registrado.');
        return;
      }
      const email = currentViewingTechnician.email;
      const nombre = currentViewingTechnician.nombre || email;
      const codes = await getAccessCodes();

      const existingCode = Object.keys(codes).find(c => codes[c].email === email && !codes[c].revoked && codes[c].type !== 'membership');
      if (existingCode) {
        document.getElementById('adminCodeValue').textContent = existingCode;
        document.getElementById('adminCodeFor').textContent = nombre;
        document.getElementById('adminCodeDisplay').style.display = 'block';
        return;
      }

      // Verify Stripe membership before generating
      const stripeCheck = await verifyStripeMembership(email);
      let stripeVerified = stripeCheck.active;
      
      if (!stripeCheck.active) {
        const override = confirm(
          '‚ö†Ô∏è ' + nombre + ' NO tiene membres√≠a activa en Stripe.\n\n' +
          (stripeCheck.error ? stripeCheck.error + '\n\n' : '') +
          '¬øGenerar c√≥digo sin verificaci√≥n de pago?'
        );
        if (!override) return;
      } else {
        alert('‚úÖ Membres√≠a verificada en Stripe\nPlan: ' + (stripeCheck.plan || 'Activa'));
      }

      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code;
      do {
        code = '';
        for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
      } while (codes[code]);

      const codeData = {
        email: email,
        nombre: nombre,
        type: 'app_access',
        createdAt: new Date().toISOString(),
        used: false,
        revoked: false,
        stripe_verified: stripeVerified
      };
      await saveAccessCode(code, codeData);

      document.getElementById('adminCodeValue').textContent = code;
      document.getElementById('adminCodeFor').textContent = nombre;
      document.getElementById('adminCodeDisplay').style.display = 'block';

      alert('‚úÖ C√≥digo generado: ' + code + '\nPara: ' + nombre + (stripeVerified ? '\n‚úÖ Stripe verificado' : '\n‚ö†Ô∏è Sin verificaci√≥n Stripe'));
    }

    function copyAccessCode() {
      const code = document.getElementById('adminCodeValue').textContent;
      const text = 'üîë Tu c√≥digo de acceso a Maestro ACVOLT:\n\n' + code + '\n\n1. Abre maestromario.com\n2. Inicia sesi√≥n con tu cuenta\n3. Toca un nivel bloqueado üîí\n4. Ingresa tu c√≥digo: ' + code + '\n5. ¬°Listo! Acceso completo desbloqueado\n\n- Maestro Mario | ACVOLT Tech School';
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => alert('üìã C√≥digo copiado al portapapeles.'));
      } else {
        prompt('Copia este c√≥digo:', text);
      }
    }

    async function revokeAccessCode() {
      if (!currentViewingTechnician) return;
      const email = currentViewingTechnician.email;
      const codes = await getAccessCodes();
      
      const codeKey = Object.keys(codes).find(c => codes[c].email === email && !codes[c].revoked && codes[c].type !== 'membership');
      if (codeKey) {
        if (!confirm('¬øRevocar el c√≥digo ' + codeKey + '?')) return;
        codes[codeKey].revoked = true;
        await saveAccessCode(codeKey, codes[codeKey]);
        
        let appAccessList = JSON.parse(localStorage.getItem('maestroac_app_access_list') || '[]');
        appAccessList = appAccessList.filter(e => e !== email);
        localStorage.setItem('maestroac_app_access_list', JSON.stringify(appAccessList));
        localStorage.removeItem('maestroac_app_purchased_' + email);
        
        document.getElementById('adminCodeDisplay').style.display = 'none';
        updateAppAccessUI();
        alert('‚ùå C√≥digo revocado.');
      }
    }

    async function redeemAccessCode() {
      const input = document.getElementById('accessCodeInput');
      const msg = document.getElementById('codeRedeemMsg');
      if (!input || !msg) return;
      
      const code = input.value.trim().toUpperCase();
      if (!code || code.length < 4) {
        msg.style.display = 'block';
        msg.style.color = '#e74c3c';
        msg.textContent = '‚ùå Ingresa un c√≥digo v√°lido';
        return;
      }

      // Check Supabase first for the code
      let codeData = null;
      if (supabaseClient && isOnline) {
        try {
          const { data, error } = await supabaseClient.from('access_codes').select('*').eq('code', code).single();
          if (!error && data) codeData = data;
        } catch(e) {}
      }
      
      // Fallback to localStorage
      if (!codeData) {
        const codes = JSON.parse(localStorage.getItem('maestroac_access_codes') || '{}');
        codeData = codes[code];
      }

      if (!codeData) {
        msg.style.display = 'block';
        msg.style.color = '#e74c3c';
        msg.textContent = '‚ùå C√≥digo no encontrado.';
        return;
      }

      if (codeData.revoked) {
        msg.style.display = 'block';
        msg.style.color = '#e74c3c';
        msg.textContent = '‚ùå Este c√≥digo ha sido revocado.';
        return;
      }

      if (!currentUser || !currentUser.email) {
        msg.style.display = 'block';
        msg.style.color = '#e74c3c';
        msg.textContent = '‚ùå Debes iniciar sesi√≥n primero.';
        return;
      }

      if (codeData.email !== currentUser.email) {
        msg.style.display = 'block';
        msg.style.color = '#e74c3c';
        msg.textContent = '‚ùå Este c√≥digo no es para tu cuenta.';
        return;
      }

      // Activate!
      codeData.used = true;
      codeData.used_at = new Date().toISOString();
      await saveAccessCode(code, codeData);

      localStorage.setItem('maestroac_app_purchased_' + currentUser.email, 'true');
      let appAccessList = JSON.parse(localStorage.getItem('maestroac_app_access_list') || '[]');
      if (!appAccessList.includes(currentUser.email)) {
        appAccessList.push(currentUser.email);
        localStorage.setItem('maestroac_app_access_list', JSON.stringify(appAccessList));
      }

      logActivity('code_redeemed', code);
      addNotification('payment', 'üí≥ ¬°App Maestro ACVOLT desbloqueada! Ahora tienes acceso a todos los niveles.', 'üîì');
      const modal = input.closest('div[style*="position:fixed"]');
      if (modal) modal.remove();
      alert('üéâ ¬°C√≥digo activado! Acceso completo desbloqueado.');
      showScreen('welcomeScreen');
    }

    async function updateAdminCodeDisplay() {
      if (!currentViewingTechnician || !currentViewingTechnician.email) return;
      const codes = await getAccessCodes();
      const email = currentViewingTechnician.email;
      const existingCode = Object.keys(codes).find(c => codes[c].email === email && !codes[c].revoked && codes[c].type !== 'membership');
      
      const display = document.getElementById('adminCodeDisplay');
      if (existingCode) {
        document.getElementById('adminCodeValue').textContent = existingCode;
        document.getElementById('adminCodeFor').textContent = currentViewingTechnician.nombre || email;
        display.style.display = 'block';
        document.getElementById('adminCodeValue').style.color = codes[existingCode].used ? '#2ecc71' : '#f39c12';
      } else {
        display.style.display = 'none';
      }
    }

    function renderAdminLockManagement() {
      const notice = document.getElementById('lockSystemNotice');
      const controls = document.getElementById('adminLockControls');

      if (!LOCK_SYSTEM_ENABLED) {
        notice.style.display = 'block';
        controls.style.display = 'none';
        return;
      }

      notice.style.display = 'none';
      controls.style.display = 'block';

      const userEmail = currentViewingTechnician.email;
      const userUnlocks = unlockedLevels[userEmail] || [];
      const matrixIds = unlockedLevels[userEmail + '_matrixIds'] || {};

      let html = '<div class="admin-lock-title">üîê Estado de Acceso por Nivel</div>';

      levels.forEach(level => {
        const isUnlocked = userUnlocks.includes(level.id);
        const matrixId = matrixIds[level.id] || 'N/A';

        html += `
          <div class="admin-lock-status">
            <div>
              <span style="font-size: 18px;">${level.icon}</span>
              <strong style="margin-left: 8px;">${level.name}</strong>
              ${isUnlocked ? `<span class="matrix-id-display" style="margin-left: 10px;">Matrix: ${matrixId}</span>` : ''}
            </div>
            <button class="admin-lock-toggle ${isUnlocked ? 'unlocked' : 'locked'}"
                    onclick="toggleTechnicianLock('${level.id}', '${userEmail}')">
              ${isUnlocked ? 'üîì Desbloqueado' : 'üîí Bloqueado'}
            </button>
          </div>
        `;
      });

      html += `
        <div class="admin-lock-disabled-notice" style="margin-top: 15px; background: rgba(39,174,96,0.1); border-color: rgba(39,174,96,0.3); color: #27ae60;">
          üí° Los t√©cnicos pueden desbloquear niveles ingresando un c√≥digo Matrix v√°lido generado desde tu sitio web.
        </div>
      `;

      controls.innerHTML = html;
    }

    // Toggle lock status for a technician (admin function)
    function toggleTechnicianLock(levelId, userEmail) {
      if (!unlockedLevels[userEmail]) {
        unlockedLevels[userEmail] = [];
      }

      const index = unlockedLevels[userEmail].indexOf(levelId);
      if (index > -1) {
        // Lock the level (remove from unlocked)
        unlockedLevels[userEmail].splice(index, 1);
        // Remove the Matrix ID record
        if (unlockedLevels[userEmail + '_matrixIds']) {
          delete unlockedLevels[userEmail + '_matrixIds'][levelId];
        }
      } else {
        // Unlock the level (add to unlocked)
        unlockedLevels[userEmail].push(levelId);
        // Mark as admin-unlocked
        if (!unlockedLevels[userEmail + '_matrixIds']) {
          unlockedLevels[userEmail + '_matrixIds'] = {};
        }
        unlockedLevels[userEmail + '_matrixIds'][levelId] = 'ADMIN-UNLOCK';
      }

      saveUnlockedLevels();
      renderAdminLockManagement();
    }

    // ============================================
    // SISTEMA DE ASISTENCIA
    // ============================================
    
    let attendanceTimerInterval = null;
    let currentCheckInTime = null;
    let currentAttendanceId = null;
    let selectedClassType = 'presencial';
    let lastActivityTime = Date.now();
    let inactivityCheckInterval = null;
    let inactivityWarningShown = false;
    const INACTIVITY_LIMIT_MS = 15 * 60 * 1000; // 15 minutes of inactivity = auto check-out
    const INACTIVITY_WARNING_MS = 10 * 60 * 1000; // Warning at 10 minutes
    
    // ===== FORCED CHECK-IN SYSTEM =====
    let sessionCheckedIn = false;

    // ===== INACTIVITY DETECTION SYSTEM =====
    // Track user activity (clicks, scrolls, typing, touches)
    ['click','keydown','scroll','touchstart','mousemove'].forEach(function(ev){
      document.addEventListener(ev, function(){
        if (currentAttendanceId) {
          lastActivityTime = Date.now();
          // If warning was showing, dismiss it
          if (inactivityWarningShown) {
            var warnEl = document.getElementById('inactivityWarningModal');
            if (warnEl) warnEl.remove();
            inactivityWarningShown = false;
            console.log('[Attendance] Activity detected ‚Äî inactivity timer reset');
          }
        }
      }, {passive:true});
    });

    // Also track visibility changes
    document.addEventListener('visibilitychange', function(){
      if (document.visibilityState === 'visible' && currentAttendanceId) {
        // User came back to the app
        lastActivityTime = Date.now();
        console.log('[Attendance] App visible again ‚Äî activity updated');
      }
    });

    function startInactivityMonitor() {
      // Clear any existing interval
      if (inactivityCheckInterval) clearInterval(inactivityCheckInterval);
      
      // Check inactivity every 60 seconds
      inactivityCheckInterval = setInterval(function() {
        if (!currentAttendanceId || !currentCheckInTime) {
          clearInterval(inactivityCheckInterval);
          return;
        }
        
        // ===== EXCEPTION: During class hours (Tue/Wed 6-10PM California), NO inactivity check =====
        var schedule = isClassTime();
        if (schedule.allowed) {
          // During class time ‚Äî don't check inactivity, they're in class with Maestro Mario
          return;
        }
        
        // Outside class hours ‚Äî check inactivity
        var inactiveMs = Date.now() - lastActivityTime;
        
        // Show warning at 10 minutes
        if (inactiveMs >= INACTIVITY_WARNING_MS && !inactivityWarningShown) {
          inactivityWarningShown = true;
          var remainSec = Math.ceil((INACTIVITY_LIMIT_MS - inactiveMs) / 1000);
          var remainMin = Math.ceil(remainSec / 60);
          
          var modal = document.createElement('div');
          modal.id = 'inactivityWarningModal';
          modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
          modal.innerHTML = '<div style="background:#fff;border-radius:20px;padding:30px;max-width:400px;width:100%;text-align:center;">' +
            '<div style="font-size:60px;margin-bottom:15px;">‚è≥</div>' +
            '<h3 style="color:#f39c12;margin-bottom:10px;font-size:20px;">¬øSigues estudiando?</h3>' +
            '<p style="color:#64748b;font-size:14px;margin-bottom:8px;">No hemos detectado actividad en los √∫ltimos 10 minutos.</p>' +
            '<p style="color:#e74c3c;font-size:14px;font-weight:bold;margin-bottom:20px;">Se har√° check-out autom√°tico en ~' + remainMin + ' minutos si no hay actividad.</p>' +
            '<button onclick="lastActivityTime=Date.now();inactivityWarningShown=false;this.closest(\'div[style*=position]\').remove();" style="width:100%;padding:15px;border:none;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#27ae60,#2ecc71);color:white;margin-bottom:10px;">‚úÖ ¬°S√≠, sigo aqu√≠!</button>' +
            '<button onclick="this.closest(\'div[style*=position]\').remove();doCheckOut();" style="width:100%;padding:12px;border:none;border-radius:12px;font-size:14px;cursor:pointer;background:rgba(231,76,60,0.15);color:#dc2626;font-weight:bold;">üõë Hacer Check-Out</button>' +
            '</div>';
          document.body.appendChild(modal);
        }
        
        // Auto check-out at 15 minutes of inactivity
        if (inactiveMs >= INACTIVITY_LIMIT_MS) {
          console.log('[Attendance] 15 min inactivity outside class hours ‚Äî auto check-out');
          // Remove warning modal if showing
          var warnEl = document.getElementById('inactivityWarningModal');
          if (warnEl) warnEl.remove();
          inactivityWarningShown = false;
          
          // Do the auto check-out
          autoCheckOutInactivity();
        }
        
      }, 60000); // Check every 60 seconds
    }

    // Auto check-out due to inactivity (different from max time)
    async function autoCheckOutInactivity() {
      if (!currentAttendanceId || !currentCheckInTime) return;
      try {
        // Use lastActivityTime as the real check-out time (when they actually stopped)
        var checkOutTime = new Date(lastActivityTime);
        var totalMinutes = Math.round((checkOutTime - currentCheckInTime) / 60000);
        totalMinutes = Math.min(totalMinutes, 240);
        
        if (supabaseClient) {
          await supabaseClient.from('attendance')
            .update({ check_out: checkOutTime.toISOString(), total_minutes: totalMinutes })
            .eq('id', currentAttendanceId);
        }
        
        clearInterval(attendanceTimerInterval);
        attendanceTimerInterval = null;
        clearInterval(inactivityCheckInterval);
        inactivityCheckInterval = null;
        
        document.getElementById('btnCheckIn').style.display = 'block';
        document.getElementById('btnCheckOut').style.display = 'none';
        document.getElementById('attendanceStatusBadge').className = 'attendance-status status-inactive';
        document.getElementById('attendanceStatusBadge').textContent = '‚≠ï Check-out por inactividad';
        document.getElementById('attendanceTimer').textContent = '00:00:00';
        document.querySelectorAll('.type-option').forEach(function(el) { el.style.pointerEvents = 'auto'; });
        
        var hrs = Math.floor(totalMinutes / 60);
        var mins = totalMinutes % 60;
        addNotification('checkout', '‚è≥ Check-out autom√°tico por inactividad ‚Äî Tiempo real: ' + hrs + 'h ' + mins + 'm', '‚è≥');
        localStorage.removeItem('attendance_active_session');
        localStorage.removeItem('attendance_pending_checkout');
        
        currentAttendanceId = null;
        currentCheckInTime = null;
        
        // Show notification modal
        var modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
        modal.innerHTML = '<div style="background:#fff;border-radius:20px;padding:30px;max-width:400px;width:100%;text-align:center;">' +
          '<div style="font-size:60px;margin-bottom:15px;">‚è≥</div>' +
          '<h3 style="color:#f39c12;margin-bottom:10px;font-size:20px;">Check-Out Autom√°tico</h3>' +
          '<p style="color:#64748b;font-size:14px;margin-bottom:8px;">Se detect√≥ inactividad de 15 minutos fuera de horario de clase.</p>' +
          '<p style="color:#1e293b;font-size:16px;font-weight:bold;margin-bottom:5px;">Tiempo registrado: ' + hrs + 'h ' + mins + 'm</p>' +
          '<p style="color:#94a3b8;font-size:12px;margin-bottom:20px;">Solo se cont√≥ el tiempo con actividad real.</p>' +
          '<button onclick="this.closest(\'div[style*=position]\').remove(); loadAttendanceData();" style="width:100%;padding:15px;border:none;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#f39c12,#e67e22);color:white;">Entendido</button>' +
          '</div>';
        document.body.appendChild(modal);
        
        loadAttendanceData();
      } catch(e) { console.error('[Attendance] Inactivity check-out error:', e); }
    }

    // ===== AUTO CHECK-OUT ON EXIT =====
    // When technician closes browser/tab, auto-checkout immediately
    window.addEventListener('beforeunload', function() {
      if (currentAttendanceId && currentCheckInTime) {
        // Calculate time and save for checkout
        var checkOutTime = new Date();
        var totalMinutes = Math.round((checkOutTime - currentCheckInTime) / 60000);
        totalMinutes = Math.min(totalMinutes, 240); // Cap at 4 hours max
        
        // Save pending checkout info
        localStorage.setItem('attendance_pending_checkout', JSON.stringify({
          id: currentAttendanceId,
          checkIn: currentCheckInTime.toISOString(),
          checkOut: checkOutTime.toISOString(),
          totalMinutes: totalMinutes,
          classType: selectedClassType
        }));
        
        // Try to send checkout immediately using sendBeacon (works even when page closes)
        if (navigator.sendBeacon && supabaseClient) {
          var checkoutData = JSON.stringify({
            id: currentAttendanceId,
            check_out: checkOutTime.toISOString(),
            total_minutes: totalMinutes
          });
          // Note: sendBeacon doesn't support auth headers, so we'll rely on the pending checkout
        }
      }
    });

    // Also handle visibility change (app backgrounded on mobile) - more aggressive
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'hidden' && currentAttendanceId && currentCheckInTime) {
        var checkOutTime = new Date();
        var totalMinutes = Math.round((checkOutTime - currentCheckInTime) / 60000);
        totalMinutes = Math.min(totalMinutes, 240);
        
        // Save pending checkout in case they don't come back
        localStorage.setItem('attendance_pending_checkout', JSON.stringify({
          id: currentAttendanceId,
          checkIn: currentCheckInTime.toISOString(),
          checkOut: checkOutTime.toISOString(),
          totalMinutes: totalMinutes,
          classType: selectedClassType,
          wasClassTime: isClassTime().allowed
        }));
        
        // Outside class hours: if they leave the app, start a countdown
        // If they don't return within 5 minutes, the pending checkout will be processed on next load
        var schedule = isClassTime();
        if (!schedule.allowed) {
          console.log("[Attendance] App hidden OUTSIDE class hours ‚Äî pending checkout saved");
        } else {
          console.log("[Attendance] App hidden DURING class hours ‚Äî session preserved");
        }
      }
      if (document.visibilityState === 'visible' && currentAttendanceId) {
        lastActivityTime = Date.now();
        updateTimer();
      }
    });

    // Check and auto-close stale sessions on app load
    async function checkStaleAttendance() {
      if (!supabaseClient) return;
      try {
        var userResp = await supabaseClient.auth.getUser();
        var user = userResp.data ? userResp.data.user : null;
        if (!user) return;
        
        // Process pending checkout from last session close
        var pendingCheckout = localStorage.getItem('attendance_pending_checkout');
        if (pendingCheckout) {
          var pc = JSON.parse(pendingCheckout);
          var checkOutTime = pc.checkOut ? new Date(pc.checkOut) : new Date(pc.closedAt);
          var totalMinutes = pc.totalMinutes || Math.round((checkOutTime - new Date(pc.checkIn)) / 60000);
          totalMinutes = Math.min(totalMinutes, 240); // Cap at 4 hours max
          
          await supabaseClient.from('attendance')
            .update({ check_out: checkOutTime.toISOString(), total_minutes: totalMinutes })
            .eq('id', pc.id)
            .is('check_out', null); // Only update if still open
          
          console.log('[Attendance] Auto-checkout from previous session:', pc.id, totalMinutes + 'min');
          localStorage.removeItem('attendance_pending_checkout');
        }

        // Find any open sessions older than 4 hours (forgotten checkout)
        var activeRes = await supabaseClient.from('attendance')
          .select('*')
          .eq('student_id', user.id)
          .is('check_out', null)
          .order('check_in', { ascending: false });
        
        var activeSessions = activeRes.data || [];
        for (var i = 0; i < activeSessions.length; i++) {
          var session = activeSessions[i];
          var sessionCheckIn = new Date(session.check_in);
          var hoursSince = (new Date() - sessionCheckIn) / (1000 * 60 * 60);
          
          if (hoursSince > 4) {
            // Auto-close - cap at 4 hours
            var autoCloseTime = new Date(sessionCheckIn.getTime() + 4 * 60 * 60 * 1000);
            await supabaseClient.from('attendance')
              .update({ check_out: autoCloseTime.toISOString(), total_minutes: 240 })
              .eq('id', session.id);
            console.log('[Attendance] Auto-closed stale session:', session.id);
          }
        }
      } catch(e) { console.log('[Attendance] Stale check error:', e); }
    }
    
    function requireCheckIn(destination) {
      if (sessionCheckedIn) return true;
      // Show check-in required message and redirect to attendance
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
      modal.innerHTML = `
        <div style="background:linear-gradient(135deg,#1a5276,#154360);border-radius:20px;padding:30px;max-width:400px;width:100%;text-align:center;border:2px solid #27ae60;">
          <div style="font-size:60px;margin-bottom:15px;">üìã</div>
          <h3 style="color:#27ae60;margin-bottom:10px;font-size:20px;">¬°Check-In Requerido!</h3>
          <p style="color:#94a3b8;font-size:14px;margin-bottom:20px;">Debes registrar tu asistencia antes de comenzar. Esto es obligatorio para cada sesi√≥n de clase.</p>
          <button onclick="this.closest('div[style*=position]').remove(); showScreen('attendanceScreen'); loadAttendanceData();" style="width:100%;padding:15px;border:none;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#27ae60,#2ecc71);color:white;margin-bottom:10px;">üìã Hacer Check-In Ahora</button>
          <button onclick="this.closest('div[style*=position]').remove();" style="width:100%;padding:12px;border:none;border-radius:12px;font-size:14px;cursor:pointer;background:rgba(255,255,255,0.15);color:#64748b;">Cancelar</button>
        </div>
      `;
      document.body.appendChild(modal);
      return false;
    }

    function getClassTypeLabel(type) {
      var labels = { presencial: 'üè´ Presencial', zoom: 'üìπ Zoom', computadora: 'üñ•Ô∏è Computadora', movil: 'üì± M√≥vil' };
      return labels[type] || type;
    }

    function showForgotPassword() {
      var box = document.getElementById('forgotPasswordBox');
      box.style.display = box.style.display === 'none' ? 'block' : 'none';
      var loginEmail = document.getElementById('loginEmail').value.trim();
      if (loginEmail) document.getElementById('forgotEmail').value = loginEmail;
    }

    async function sendPasswordReset() {
      var email = document.getElementById('forgotEmail').value.trim().toLowerCase();
      var msgDiv = document.getElementById('forgotPasswordMsg');
      if (!email) {
        msgDiv.style.display = 'block';
        msgDiv.style.color = '#e74c3c';
        msgDiv.textContent = 'Ingresa tu correo electr√≥nico';
        return;
      }
      if (!supabaseClient) {
        msgDiv.style.display = 'block';
        msgDiv.style.color = '#e74c3c';
        msgDiv.textContent = 'Error de conexi√≥n. Intenta de nuevo.';
        return;
      }
      try {
        var { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
          redirectTo: 'https://maestromario.com'
        });
        msgDiv.style.display = 'block';
        if (error) {
          msgDiv.style.color = '#e74c3c';
          msgDiv.textContent = 'Error: ' + error.message;
        } else {
          msgDiv.style.color = '#2ecc71';
          msgDiv.innerHTML = '‚úÖ ¬°Link enviado! Revisa tu correo <strong>' + email + '</strong> y sigue las instrucciones para cambiar tu contrase√±a.';
        }
      } catch(e) {
        msgDiv.style.display = 'block';
        msgDiv.style.color = '#e74c3c';
        msgDiv.textContent = 'Error de conexi√≥n. Intenta de nuevo.';
      }
    }

    // ============================================
    // SUBMIT NEW PASSWORD (Recovery Flow)
    // ============================================
    async function submitNewPassword() {
      var newPass = document.getElementById('resetNewPassword').value;
      var confirmPass = document.getElementById('resetConfirmPassword').value;
      var msgDiv = document.getElementById('resetPasswordMsg');
      
      msgDiv.style.display = 'block';
      
      if (!newPass || newPass.length < 6) {
        msgDiv.style.color = '#e74c3c';
        msgDiv.style.background = 'rgba(231,76,60,0.1)';
        msgDiv.textContent = '‚ö†Ô∏è La contrase√±a debe tener al menos 6 caracteres';
        return;
      }
      
      if (newPass !== confirmPass) {
        msgDiv.style.color = '#e74c3c';
        msgDiv.style.background = 'rgba(231,76,60,0.1)';
        msgDiv.textContent = '‚ö†Ô∏è Las contrase√±as no coinciden';
        return;
      }
      
      if (!supabaseClient) {
        msgDiv.style.color = '#e74c3c';
        msgDiv.style.background = 'rgba(231,76,60,0.1)';
        msgDiv.textContent = 'Error de conexi√≥n. Intenta de nuevo.';
        return;
      }
      
      msgDiv.style.color = '#3498db';
      msgDiv.style.background = 'rgba(52,152,219,0.1)';
      msgDiv.textContent = '‚è≥ Cambiando contrase√±a...';
      
      try {
        var { data, error } = await supabaseClient.auth.updateUser({ password: newPass });
        
        if (error) {
          msgDiv.style.color = '#e74c3c';
          msgDiv.style.background = 'rgba(231,76,60,0.1)';
          msgDiv.textContent = '‚ùå Error: ' + error.message;
          return;
        }
        
        msgDiv.style.color = '#27ae60';
        msgDiv.style.background = 'rgba(39,174,96,0.1)';
        msgDiv.innerHTML = '‚úÖ ¬°Contrase√±a cambiada exitosamente!<br><span style="font-size:13px;">Redirigiendo al login en 3 segundos...</span>';
        
        // Sign out and redirect to login after 3 seconds
        setTimeout(async function() {
          await supabaseClient.auth.signOut();
          // Reset the UI
          var resetBox = document.getElementById('resetPasswordBox');
          if (resetBox) resetBox.style.display = 'none';
          var loginCard = document.querySelector('#loginScreen .card');
          if (loginCard) loginCard.style.display = 'block';
          // Clear the hash from URL
          if (window.history && window.history.replaceState) {
            window.history.replaceState(null, '', window.location.pathname);
          }
          showScreen('loginScreen');
          // Show success message on login screen
          alert('‚úÖ Tu contrase√±a fue cambiada. Ahora inicia sesi√≥n con tu nueva contrase√±a.');
        }, 3000);
        
      } catch(e) {
        msgDiv.style.color = '#e74c3c';
        msgDiv.style.background = 'rgba(231,76,60,0.1)';
        msgDiv.textContent = '‚ùå Error de conexi√≥n. Intenta de nuevo.';
      }
    }

    // Show Magic Link box
    function showMagicLinkBox() {
      var box = document.getElementById('magicLinkBox');
      box.style.display = box.style.display === 'none' ? 'block' : 'none';
      var loginEmail = document.getElementById('loginEmail').value;
      if (loginEmail) {
        document.getElementById('magicLinkEmail').value = loginEmail;
      }
    }

    // Send Magic Link via Supabase OTP
    async function sendMagicLink() {
      var email = document.getElementById('magicLinkEmail').value.trim().toLowerCase();
      var msgDiv = document.getElementById('magicLinkMsg');
      var termsCheckbox = document.getElementById('magicLinkTermsCheckbox');
      
      // Verify terms accepted
      if (!termsCheckbox || !termsCheckbox.checked) {
        msgDiv.style.display = 'block';
        msgDiv.style.color = '#e74c3c';
        msgDiv.textContent = '‚ö†Ô∏è Debes aceptar los T√©rminos de Servicio y Pol√≠tica de Privacidad';
        return;
      }
      
      if (!email) {
        msgDiv.style.display = 'block';
        msgDiv.style.color = '#e74c3c';
        msgDiv.textContent = 'Por favor ingresa tu correo electr√≥nico';
        return;
      }

      if (!supabaseClient) {
        msgDiv.style.display = 'block';
        msgDiv.style.color = '#e74c3c';
        msgDiv.textContent = 'Error de conexi√≥n. Intenta de nuevo.';
        return;
      }

      msgDiv.style.display = 'block';
      msgDiv.style.color = '#9b59b6';
      msgDiv.textContent = 'Enviando link de acceso...';

      try {
        const { data, error } = await supabaseClient.auth.signInWithOtp({
          email: email,
          options: {
            emailRedirectTo: 'https://maestromario.com'
          }
        });

        if (error) {
          msgDiv.style.color = '#e74c3c';
          msgDiv.textContent = 'Error: ' + error.message;
          return;
        }

        msgDiv.style.color = '#27ae60';
        msgDiv.innerHTML = '¬°Link enviado!<br><span style="font-size:12px;color:#666;">Revisa tu correo (tambien la carpeta de spam)</span>';
        
        // Save terms acceptance
        localStorage.setItem('maestroac_terms_accepted', 'true');
        localStorage.setItem('maestroac_terms_date', new Date().toISOString());
        
      } catch (err) {
        msgDiv.style.color = '#e74c3c';
        msgDiv.textContent = 'Error: ' + err.message;
      }
    }

    // ============ CREATE USER FUNCTIONS ============
    var recentlyCreatedUsers = [];

    function generateRandomPassword() {
      var chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
      var password = '';
      for (var i = 0; i < 8; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById('createUserPassword').value = password;
    }

    async function createNewUser() {
      var nombre = document.getElementById('createUserName').value.trim();
      var email = document.getElementById('createUserEmail').value.trim().toLowerCase();
      var telefono = document.getElementById('createUserPhone').value.trim();
      var password = document.getElementById('createUserPassword').value;
      var msgDiv = document.getElementById('createUserMsg');

      if (!nombre || !email || !password) {
        msgDiv.style.color = '#e74c3c';
        msgDiv.textContent = 'Nombre, email y contrasena son requeridos';
        return;
      }

      if (password.length < 6) {
        msgDiv.style.color = '#e74c3c';
        msgDiv.textContent = 'La contrasena debe tener al menos 6 caracteres';
        return;
      }

      msgDiv.style.color = '#f39c12';
      msgDiv.textContent = 'Creando usuario...';

      try {
        var response = await fetch('https://htklsowiyjwsjnacnvnr.supabase.co/functions/v1/create-user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + SUPABASE_KEY
          },
          body: JSON.stringify({
            email: email,
            password: password,
            nombre: nombre,
            telefono: telefono
          })
        });

        var result = await response.json();

        if (result.error) {
          msgDiv.style.color = '#e74c3c';
          msgDiv.textContent = 'Error: ' + result.error;
          return;
        }

        msgDiv.style.color = '#27ae60';
        msgDiv.textContent = 'Usuario creado! Correo enviado a ' + email;

        // Add to recently created list
        recentlyCreatedUsers.unshift({
          nombre: nombre,
          email: email,
          password: password,
          createdAt: new Date().toLocaleTimeString()
        });

        updateRecentCreatedUsers();

        // Clear form
        document.getElementById('createUserName').value = '';
        document.getElementById('createUserEmail').value = '';
        document.getElementById('createUserPhone').value = '';
        document.getElementById('createUserPassword').value = '';

      } catch (err) {
        msgDiv.style.color = '#e74c3c';
        msgDiv.textContent = 'Error: ' + err.message;
      }
    }

    function updateRecentCreatedUsers() {
      var container = document.getElementById('recentCreatedUsers');
      if (recentlyCreatedUsers.length === 0) {
        container.innerHTML = 'No hay usuarios creados en esta sesion.';
        return;
      }

      var html = '<div style="display:flex;flex-direction:column;gap:8px;">';
      recentlyCreatedUsers.slice(0, 5).forEach(function(user) {
        html += '<div style="background:rgba(39,174,96,0.1);border:1px solid rgba(39,174,96,0.3);border-radius:8px;padding:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">';
        html += '<div><strong style="color:#27ae60;">' + user.nombre + '</strong><br><span style="color:#888;font-size:12px;">' + user.email + '</span></div>';
        html += '<div style="text-align:right;"><span style="color:#666;font-size:11px;">Pass: </span><code style="background:#222;padding:2px 6px;border-radius:4px;color:#2ecc71;">' + user.password + '</code><br><span style="color:#666;font-size:11px;">' + user.createdAt + '</span></div>';
        html += '</div>';
      });
      html += '</div>';
      container.innerHTML = html;
    }
    // ============ END CREATE USER FUNCTIONS ============

    function getClassTypeIcon(type) {
      var icons = { presencial: 'üè´', zoom: 'üìπ', computadora: 'üñ•Ô∏è', movil: 'üì±' };
      return icons[type] || 'üìã';
    }

    function selectClassType(type) {
      selectedClassType = type;
      document.getElementById('typePresencial').classList.toggle('selected', type === 'presencial');
      document.getElementById('typeZoom').classList.toggle('selected', type === 'zoom');
      document.getElementById('typeComputadora').classList.toggle('selected', type === 'computadora');
      document.getElementById('typeMovil').classList.toggle('selected', type === 'movil');
    }

    function updateTimer() {
      if (!currentCheckInTime) return;
      var now = new Date();
      var diff = Math.floor((now - currentCheckInTime) / 1000);
      
      // ===== AUTO CHECK-OUT AT 4 HOURS MAX =====
      if (diff >= 14400) { // 4 hours = 14400 seconds
        console.log('[Attendance] 4 horas alcanzadas ‚Äî auto check-out');
        autoCheckOutMaxTime();
        return;
      }
      
      var hrs = Math.floor(diff / 3600);
      var mins = Math.floor((diff % 3600) / 60);
      var secs = diff % 60;
      var timerEl = document.getElementById('attendanceTimer');
      if (timerEl) {
        timerEl.textContent = String(hrs).padStart(2,'0') + ':' + String(mins).padStart(2,'0') + ':' + String(secs).padStart(2,'0');
      }
      
      // Show remaining time warning at 3:30 hours
      if (diff >= 12600 && diff < 12610) {
        var remainMin = Math.ceil((14400 - diff) / 60);
        addNotification('checkin', '‚è∞ Quedan ' + remainMin + ' minutos ‚Äî Check-out autom√°tico a las 4 horas', '‚è∞');
      }
    }

    // ===== CLASS SCHEDULE VALIDATION =====
    // Classes: Tuesday & Wednesday 6:00 PM - 10:00 PM Pacific Time (California)
    function isClassTime() {
      // Get current time in California (America/Los_Angeles)
      var now = new Date();
      var caTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
      var day = caTime.getDay(); // 0=Sun, 1=Mon, 2=Tue, 3=Wed...
      var hour = caTime.getHours();
      var minutes = caTime.getMinutes();
      var totalMinutes = hour * 60 + minutes;
      
      // Tuesday (2) or Wednesday (3), 6:00 PM (1080) to 10:00 PM (1320)
      var isClassDay = (day === 2 || day === 3);
      var isClassHour = (totalMinutes >= 1080 && totalMinutes <= 1320); // 18:00 - 22:00
      
      return { allowed: isClassDay && isClassHour, day: day, hour: hour, minutes: minutes, caTime: caTime };
    }

    function getNextClassInfo() {
      var now = new Date();
      var caTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
      var day = caTime.getDay();
      var days = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
      
      // Find next Tuesday (2) or Wednesday (3)
      var nextDay;
      if (day < 2) nextDay = 'Martes';
      else if (day === 2 && caTime.getHours() < 22) nextDay = 'Martes (hoy)';
      else if (day === 2 || (day === 3 && caTime.getHours() >= 22)) nextDay = 'Martes (pr√≥x. semana)';
      else if (day === 3 && caTime.getHours() < 22) nextDay = 'Mi√©rcoles (hoy)';
      else nextDay = 'Martes';
      
      return nextDay;
    }

    // Auto check-out when 4 hours reached
    async function autoCheckOutMaxTime() {
      if (!currentAttendanceId || !currentCheckInTime) return;
      try {
        var checkOutTime = new Date(currentCheckInTime.getTime() + 4 * 60 * 60 * 1000); // Exactly 4 hours after check-in
        var totalMinutes = 240;
        
        if (supabaseClient) {
          await supabaseClient.from('attendance')
            .update({ check_out: checkOutTime.toISOString(), total_minutes: totalMinutes })
            .eq('id', currentAttendanceId);
        }
        
        clearInterval(attendanceTimerInterval);
        attendanceTimerInterval = null;
        document.getElementById('btnCheckIn').style.display = 'block';
        document.getElementById('btnCheckOut').style.display = 'none';
        document.getElementById('attendanceStatusBadge').className = 'attendance-status status-inactive';
        document.getElementById('attendanceStatusBadge').textContent = '‚≠ï Clase terminada (4h m√°x)';
        document.getElementById('attendanceTimer').textContent = '04:00:00';
        document.querySelectorAll('.type-option').forEach(function(el) { el.style.pointerEvents = 'auto'; });
        
        addNotification('checkout', '‚è∞ Check-out autom√°tico ‚Äî 4 horas m√°ximo alcanzadas', '‚è∞');
        localStorage.removeItem('attendance_active_session');
        localStorage.removeItem('attendance_pending_checkout');
        
        currentAttendanceId = null;
        currentCheckInTime = null;
        
        // Show modal notification
        var modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
        modal.innerHTML = '<div style="background:#fff;border-radius:20px;padding:30px;max-width:400px;width:100%;text-align:center;">' +
          '<div style="font-size:60px;margin-bottom:15px;">‚è∞</div>' +
          '<h3 style="color:#E31937;margin-bottom:10px;font-size:20px;">¬°Clase Terminada!</h3>' +
          '<p style="color:#64748b;font-size:14px;margin-bottom:8px;">Se completaron las <strong>4 horas m√°ximas</strong> de clase.</p>' +
          '<p style="color:#64748b;font-size:14px;margin-bottom:20px;">Tu asistencia de 4:00 horas ha sido registrada.</p>' +
          '<button onclick="this.closest(\'div[style*=position]\').remove(); loadAttendanceData();" style="width:100%;padding:15px;border:none;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#27ae60,#2ecc71);color:white;">‚úÖ Entendido</button>' +
          '</div>';
        document.body.appendChild(modal);
        
        loadAttendanceData();
      } catch(e) { console.error('[Attendance] Auto check-out error:', e); }
    }

    async function doCheckIn() {
      try {
        if (!supabaseClient) { alert('Error: Supabase no conectado'); return; }
        
        var userResp = await supabaseClient.auth.getUser();
        var user = userResp.data.user;
        if (!user) { alert('Debes iniciar sesion primero'); return; }
        
        // Check if already hit 4 hours today
        var todayStart = new Date();
        todayStart.setHours(0,0,0,0);
        var existingRes = await supabaseClient.from('attendance')
          .select('*')
          .eq('student_id', user.id)
          .gte('check_in', todayStart.toISOString())
          .not('total_minutes', 'is', null);
        var todayMinutes = 0;
        if (existingRes.data) {
          existingRes.data.forEach(function(r) { todayMinutes += (r.total_minutes || 0); });
        }
        if (todayMinutes >= 240) {
          alert('‚ö†Ô∏è Ya completaste 4 horas hoy. El m√°ximo por d√≠a es 4 horas.');
          return;
        }
        
        var res = await supabaseClient
          .from('attendance')
          .insert({ student_id: user.id, class_type: selectedClassType, check_in: new Date().toISOString(), status: 'presente' })
          .select().single();
        if (res.error) throw res.error;
        var data = res.data;
        currentAttendanceId = data.id;
        currentCheckInTime = new Date(data.check_in);
        sessionCheckedIn = true;
        lastActivityTime = Date.now(); // Track activity
        addNotification('checkin', '‚úÖ Check-in registrado ‚Äî ' + getClassTypeLabel(selectedClassType), 'üìã');
        document.getElementById('btnCheckIn').style.display = 'none';
        document.getElementById('btnCheckOut').style.display = 'block';
        document.getElementById('attendanceStatusBadge').className = 'attendance-status status-active';
        document.getElementById('attendanceStatusBadge').textContent = 'üü¢ En Clase - ' + getClassTypeLabel(selectedClassType);
        document.querySelectorAll('.type-option').forEach(function(el) { el.style.pointerEvents = 'none'; });
        attendanceTimerInterval = setInterval(updateTimer, 1000);
        updateTimer();
        
        // Start inactivity monitor (only outside class hours)
        startInactivityMonitor();
        
      } catch (err) {
        console.error('Error en check-in:', err);
        alert('Error al hacer check-in: ' + err.message);
      }
    }

    async function doCheckOut() {
      try {
        if (!currentAttendanceId) return;
        var checkOutTime = new Date();
        var totalMinutes = Math.round((checkOutTime - currentCheckInTime) / 60000);
        totalMinutes = Math.min(totalMinutes, 240); // Cap at 4 hours max
        var res = await supabaseClient
          .from('attendance')
          .update({ check_out: checkOutTime.toISOString(), total_minutes: totalMinutes })
          .eq('id', currentAttendanceId);
        if (res.error) throw res.error;
        clearInterval(attendanceTimerInterval);
        attendanceTimerInterval = null;
        if (inactivityCheckInterval) { clearInterval(inactivityCheckInterval); inactivityCheckInterval = null; }
        inactivityWarningShown = false;
        document.getElementById('btnCheckIn').style.display = 'block';
        document.getElementById('btnCheckOut').style.display = 'none';
        document.getElementById('attendanceStatusBadge').className = 'attendance-status status-inactive';
        document.getElementById('attendanceStatusBadge').textContent = '‚≠ï Sin Check-in';
        document.getElementById('attendanceTimer').textContent = '00:00:00';
        document.querySelectorAll('.type-option').forEach(function(el) { el.style.pointerEvents = 'auto'; });
        currentAttendanceId = null;
        currentCheckInTime = null;
        sessionCheckedIn = false;
        localStorage.removeItem('attendance_active_session');
        localStorage.removeItem('attendance_last_checkout');
        loadAttendanceData();
        var hrs = Math.floor(totalMinutes / 60);
        var mins = totalMinutes % 60;
        addNotification('checkout', 'üö™ Check-out completado ‚Äî Tiempo: ' + hrs + 'h ' + mins + 'm', 'üö™');
        alert('‚úÖ Check-out exitoso!\nTiempo registrado: ' + hrs + 'h ' + mins + 'm' + (totalMinutes >= 240 ? '\n(M√°ximo 4 horas por clase)' : ''));
      } catch (err) {
        console.error('Error en check-out:', err);
        alert('Error al hacer check-out: ' + err.message);
      }
    }

    async function loadAttendanceData() {
      try {
        if (!supabaseClient) return;
        var userResp = await supabaseClient.auth.getUser();
        var user = userResp.data.user;
        if (!user) return;
        var activeRes = await supabaseClient.from('attendance').select('*').eq('student_id', user.id).is('check_out', null).order('check_in', { ascending: false }).limit(1);
        var activeSession = activeRes.data;
        if (activeSession && activeSession.length > 0) {
          var session = activeSession[0];
          var sessionAge = (new Date() - new Date(session.check_in)) / (1000 * 60 * 60);
          
          // If session is older than 4 hours, auto-close it
          if (sessionAge >= 4) {
            var autoCloseTime = new Date(new Date(session.check_in).getTime() + 4 * 60 * 60 * 1000);
            await supabaseClient.from('attendance')
              .update({ check_out: autoCloseTime.toISOString(), total_minutes: 240 })
              .eq('id', session.id);
            console.log('[Attendance] Auto-closed stale active session:', session.id);
            addNotification('checkout', '‚è∞ Sesi√≥n anterior cerrada autom√°ticamente (4h m√°x)', '‚è∞');
          } else {
            currentAttendanceId = session.id;
            currentCheckInTime = new Date(session.check_in);
            selectedClassType = session.class_type;
            sessionCheckedIn = true;
            selectClassType(session.class_type);
            document.getElementById('btnCheckIn').style.display = 'none';
            document.getElementById('btnCheckOut').style.display = 'block';
            document.getElementById('attendanceStatusBadge').className = 'attendance-status status-active';
            document.getElementById('attendanceStatusBadge').textContent = 'üü¢ En Clase - ' + getClassTypeLabel(session.class_type);
            document.querySelectorAll('.type-option').forEach(function(el) { el.style.pointerEvents = 'none'; });
            if (!attendanceTimerInterval) { attendanceTimerInterval = setInterval(updateTimer, 1000); updateTimer(); }
            // Start inactivity monitor for restored session
            lastActivityTime = Date.now();
            startInactivityMonitor();
          }
        }
        var today = new Date(); today.setHours(0,0,0,0);
        var weekStart = new Date(today); weekStart.setDate(weekStart.getDate() - weekStart.getDay());
        var allRes = await supabaseClient.from('attendance').select('*').eq('student_id', user.id).not('total_minutes', 'is', null).order('check_in', { ascending: false });
        var allRecords = allRes.data || [];
        var hoursToday = 0, hoursWeek = 0, hoursTotal = 0;
        allRecords.forEach(function(r) {
          var checkDate = new Date(r.check_in);
          hoursTotal += r.total_minutes;
          if (checkDate >= today) hoursToday += r.total_minutes;
          if (checkDate >= weekStart) hoursWeek += r.total_minutes;
        });
        document.getElementById('attHoursToday').textContent = (hoursToday / 60).toFixed(1) + 'h';
        document.getElementById('attHoursWeek').textContent = (hoursWeek / 60).toFixed(1) + 'h';
        document.getElementById('attHoursTotal').textContent = (hoursTotal / 60).toFixed(1) + 'h';
        var historyDiv = document.getElementById('attendanceHistory');
        if (allRecords.length === 0) {
          historyDiv.innerHTML = '<p style="color:#94a3b8; text-align:center;">No hay registros aun</p>';
        } else {
          historyDiv.innerHTML = allRecords.slice(0, 10).map(function(r) {
            var date = new Date(r.check_in).toLocaleDateString('es-MX', {day:'numeric', month:'short'});
            var timeIn = new Date(r.check_in).toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit'});
            var h = (r.total_minutes / 60).toFixed(1);
            return '<div class="history-item"><span class="history-date">' + date + ' - ' + timeIn + '</span><span class="history-type">' + getClassTypeIcon(r.class_type) + ' ' + r.class_type + '</span><span class="history-hours">' + h + 'h</span></div>';
          }).join('');
        }
      } catch (err) { console.error('Error cargando asistencia:', err); }
    }

    async function loadAdminAttendance() {
      try {
        if (!supabaseClient) return;
        var filter = document.getElementById('adminAttFilter').value;
        var typeFilter = document.getElementById('adminAttTypeFilter').value;
        var query = supabaseClient.from('attendance').select('*').order('check_in', { ascending: false });
        var now = new Date();
        if (filter === 'today') { var d = new Date(now); d.setHours(0,0,0,0); query = query.gte('check_in', d.toISOString()); }
        else if (filter === 'week') { var w = new Date(now); w.setDate(w.getDate() - w.getDay()); w.setHours(0,0,0,0); query = query.gte('check_in', w.toISOString()); }
        else if (filter === 'month') { var m = new Date(now.getFullYear(), now.getMonth(), 1); query = query.gte('check_in', m.toISOString()); }
        if (typeFilter !== 'all') { query = query.eq('class_type', typeFilter); }
        var res = await query;
        var data = res.data || [];
        var liveCount = data.filter(function(r) { return !r.check_out; }).length;
        var todayStart = new Date(); todayStart.setHours(0,0,0,0);
        var todayRecords = data.filter(function(r) { return new Date(r.check_in) >= todayStart; });
        var weekHours = data.reduce(function(sum, r) { return sum + (r.total_minutes || 0); }, 0);
        document.getElementById('adminLiveCount').textContent = liveCount;
        document.getElementById('adminTodayCount').textContent = todayRecords.length;
        document.getElementById('adminWeekHours').textContent = (weekHours / 60).toFixed(1);
        var studentIds = [];
        data.forEach(function(r) { if (studentIds.indexOf(r.student_id) === -1) studentIds.push(r.student_id); });
        var userMap = {};
        for (var i = 0; i < studentIds.length; i++) {
          try {
            // Try profiles table first
            var profRes = await supabaseClient.from('profiles').select('full_name, email').eq('id', studentIds[i]).single();
            if (profRes.data && profRes.data.full_name) {
              userMap[studentIds[i]] = profRes.data.full_name;
            } else {
              // Fallback: try technicians table using email from profiles or users
              var email = profRes.data ? profRes.data.email : null;
              if (!email) {
                var userRes = await supabaseClient.from('users').select('email').eq('id', studentIds[i]).single();
                email = userRes.data ? userRes.data.email : null;
              }
              if (email) {
                var techRes = await supabaseClient.from('technicians').select('nombre').eq('email', email).single();
                if (techRes.data && techRes.data.nombre) {
                  userMap[studentIds[i]] = techRes.data.nombre;
                } else {
                  userMap[studentIds[i]] = email.split('@')[0];
                }
              } else {
                userMap[studentIds[i]] = studentIds[i].substring(0,8) + '...';
              }
            }
          } catch(e) { userMap[studentIds[i]] = studentIds[i].substring(0,8) + '...'; }
        }
        var tbody = document.getElementById('adminAttendanceBody');
        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#888;">Sin registros</td></tr>';
        } else {
          tbody.innerHTML = data.slice(0, 50).map(function(r) {
            var name = userMap[r.student_id] || r.student_id.substring(0,8);
            var timeIn = new Date(r.check_in).toLocaleString('es-MX', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
            var timeOut = r.check_out ? new Date(r.check_out).toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit'}) : '<span class="live-indicator"></span> En clase';
            var hours = r.total_minutes ? (r.total_minutes / 60).toFixed(1) + 'h' : '‚Äî';
            return '<tr><td>' + name + '</td><td><span class="history-type ' + (r.class_type === 'presencial' ? 'type-presencial' : 'type-zoom') + '">' + (r.class_type === 'presencial' ? 'üè´' : 'üíª') + ' ' + r.class_type + '</span></td><td>' + timeIn + '</td><td>' + timeOut + '</td><td>' + hours + '</td><td>' + (r.status || 'presente') + '</td></tr>';
          }).join('');
        }
      } catch (err) { console.error('Error asistencia admin:', err); }
    }

    setInterval(function() {
      if (document.getElementById('adminDashboardScreen').classList.contains('active')) { loadAdminAttendance(); }
    }, 30000);


    // ==================== FINANZAS DASHBOARD ‚Äî AUDITOR√çA #3 ====================
    async function loadFinanzasData() {
      if (!supabaseClient) { document.getElementById('finBreakdown').textContent = '‚ö†Ô∏è Sin conexi√≥n a Supabase'; return; }
      try {
        // Get membership data
        var { data: memberships } = await supabaseClient.from('memberships').select('*');
        memberships = memberships || [];
        
        var totalUsers = allTechnicians ? allTechnicians.length : 0;
        var now = new Date();
        var thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        
        // Calculate metrics
        var activeMemberships = memberships.filter(function(m) { return m.status === 'active' || m.status === 'activa'; });
        var canceledRecent = memberships.filter(function(m) { 
          return (m.status === 'canceled' || m.status === 'cancelada' || m.status === 'cancelled') && 
                 m.updated_at && new Date(m.updated_at) >= thirtyDaysAgo; 
        });
        var payingCount = activeMemberships.length;
        var canceledCount = canceledRecent.length;
        
        // Estimate price per membership (try to get from data, default $49)
        var avgPrice = 49;
        if (activeMemberships.length > 0 && activeMemberships[0].price) {
          avgPrice = activeMemberships[0].price;
        }
        
        var mrr = payingCount * avgPrice;
        var churnRate = payingCount > 0 ? ((canceledCount / (payingCount + canceledCount)) * 100).toFixed(1) : 0;
        var ltv = churnRate > 0 ? Math.round(avgPrice / (parseFloat(churnRate) / 100)) : avgPrice * 12;
        var totalRevenue = memberships.filter(function(m) { return m.status === 'active' || m.status === 'activa' || m.status === 'completed'; }).length * avgPrice;
        var freeUsers = Math.max(0, totalUsers - payingCount);
        
        // Update UI
        document.getElementById('finMRR').textContent = '$' + mrr.toLocaleString();
        document.getElementById('finPaying').textContent = payingCount;
        document.getElementById('finPayingPct').textContent = (totalUsers > 0 ? Math.round((payingCount/totalUsers)*100) : 0) + '% del total (' + totalUsers + ')';
        document.getElementById('finChurn').textContent = churnRate + '%';
        document.getElementById('finLTV').textContent = '$' + ltv.toLocaleString();
        document.getElementById('finTotal').textContent = '$' + totalRevenue.toLocaleString();
        document.getElementById('finActive').textContent = payingCount;
        document.getElementById('finCanceled').textContent = canceledCount;
        document.getElementById('finFree').textContent = freeUsers;
        
        // Breakdown
        var breakdown = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">';
        breakdown += '<div style="color:#2ecc71;">‚úÖ Pagando: <strong>' + payingCount + '</strong></div>';
        breakdown += '<div style="color:#e74c3c;">‚ùå Cancelados (30d): <strong>' + canceledCount + '</strong></div>';
        breakdown += '<div style="color:#3498db;">üìä Conversi√≥n: <strong>' + (totalUsers > 0 ? Math.round((payingCount/totalUsers)*100) : 0) + '%</strong></div>';
        breakdown += '<div style="color:#f39c12;">üí∞ Precio/mes: <strong>$' + avgPrice + '</strong></div>';
        breakdown += '</div>';
        if (churnRate > 5) {
          breakdown += '<div style="margin-top:10px;padding:8px;background:rgba(231,76,60,0.2);border-radius:8px;color:#e74c3c;font-size:11px;">‚ö†Ô∏è Churn alto (' + churnRate + '%). Considera activar alertas de inactividad para retener estudiantes.</div>';
        }
        document.getElementById('finBreakdown').innerHTML = breakdown;
        
        console.log('[Finanzas] MRR: $' + mrr + ' | Paying: ' + payingCount + ' | Churn: ' + churnRate + '%');
      } catch(e) { 
        console.error('[Finanzas] Error:', e);
        document.getElementById('finBreakdown').innerHTML = '<span style="color:#e74c3c;">Error cargando datos: ' + e.message + '</span>';
      }
    }

    // ---- IMPORT FAILED CHARGES TO STUDENT SUCCESS ----
    
    async function createSingleFailedTicket(email, amount, failMsg, stripeId, btn) {
      if (!email) { alert('No hay email para este cobro'); return; }
      btn.disabled = true;
      btn.textContent = '‚è≥';
      try {
        var { data: existing } = await supabaseClient.from('student_success_tickets')
          .select('id').eq('student_email', email).eq('tipo', 'pago_fallido')
          .ilike('descripcion', '%' + stripeId + '%').limit(1);
        if (existing && existing.length > 0) {
          btn.textContent = '‚úì';
          btn.style.background = '#94a3b8';
          return;
        }
        var studentName = '';
        var studentPhone = '';
        var { data: userData } = await supabaseClient.from('users').select('nombre, telefono').eq('email', email).limit(1);
        if (userData && userData[0]) { studentName = userData[0].nombre || ''; studentPhone = userData[0].telefono || ''; }
        
        await supabaseClient.from('student_success_tickets').insert({
          student_email: email,
          student_name: studentName || email,
          student_phone: studentPhone || '',
          tipo: 'pago_fallido',
          estado: 'abierto',
          prioridad: 'alta',
          descripcion: 'COBRO FALLIDO $' + (amount/100).toFixed(2) + ' | ' + failMsg + ' | Stripe: ' + stripeId + ' | LLAMAR para actualizar metodo de pago.',
          monto: amount/100,
          email_enviado_estudiante: false
        });
        btn.textContent = '‚úÖ';
        btn.style.background = '#16a34a';
        try { loadSSTickets('abierto'); } catch(e) {}
      } catch(e) {
        btn.textContent = '‚ùå';
        btn.style.background = '#dc2626';
        console.error('[Ticket]', e);
      }
    }

    // ===== AUTO-IMPORT FAILED CHARGES TO STUDENT SUCCESS =====
    async function autoImportFailedToSS() {
      if (!stripeDataCache || !stripeDataCache.failed_charges_list || !stripeDataCache.failed_charges_list.length) return;
      if (!supabaseClient) return;
      
      var failedList = stripeDataCache.failed_charges_list;
      var imported = 0;
      
      for (var i = 0; i < failedList.length; i++) {
        var fc = failedList[i];
        var email = fc.customer_email || '';
        if (!email) continue;
        
        try {
          // Check if ticket already exists
          var { data: existing } = await supabaseClient.from('student_success_tickets')
            .select('id')
            .eq('student_email', email)
            .eq('tipo', 'pago_fallido')
            .ilike('descripcion', '%' + fc.id + '%')
            .limit(1);
          
          if (existing && existing.length > 0) continue;
          
          // Get student info
          var studentName = fc.customer_name || '';
          var studentPhone = '';
          if (email) {
            try {
              var { data: userData } = await supabaseClient.from('users')
                .select('nombre, telefono')
                .eq('email', email)
                .limit(1);
              if (userData && userData[0]) {
                studentName = studentName || userData[0].nombre || '';
                studentPhone = userData[0].telefono || '';
              }
            } catch(e) {}
          }
          
          var amount = (fc.amount / 100).toFixed(2);
          var failDate = new Date(fc.created * 1000);
          var fecha = failDate.toLocaleDateString('es-MX');
          var ageHours = (Date.now() - failDate.getTime()) / 3600000;
          
          // Auto-assign priority based on age
          var prioridad = 'alta';
          var fechaLimite = new Date();
          if (ageHours < 24) {
            prioridad = 'critica';
            fechaLimite.setDate(fechaLimite.getDate() + 1);
          } else if (ageHours < 72) {
            prioridad = 'alta';
            fechaLimite.setDate(fechaLimite.getDate() + 2);
          } else if (ageHours < 168) {
            prioridad = 'media';
            fechaLimite.setDate(fechaLimite.getDate() + 3);
          } else {
            prioridad = 'baja';
            fechaLimite.setDate(fechaLimite.getDate() + 7);
          }
          
          await supabaseClient.from('student_success_tickets').insert({
            student_email: email,
            student_name: studentName || email,
            student_phone: studentPhone || '',
            tipo: 'pago_fallido',
            estado: 'abierto',
            prioridad: prioridad,
            descripcion: 'COBRO FALLIDO $' + amount + ' | Fecha: ' + fecha + ' | ' + (fc.failure_message || 'Declined') + ' | Stripe: ' + fc.id + ' | LLAMAR para actualizar metodo de pago.',
            monto: parseFloat(amount),
            fecha_limite: fechaLimite.toISOString(),
            email_enviado_estudiante: false
          });
          imported++;
        } catch(e) {
          console.warn('[AutoImport] Skip:', email, e.message);
        }
      }
      
      if (imported > 0) {
        console.log('[AutoImport] ' + imported + ' new failed charges imported to Student Success');
        // Refresh Student Success view
        try { loadSSTicketsFiltered(); loadSSStats(); } catch(e) {}
      }
    }
    // ===== END AUTO-IMPORT =====

    async function importFailedToStudentSuccess() {
      var statusEl = document.getElementById('stripeImportStatus');
      statusEl.style.display = 'block';
      statusEl.style.background = 'rgba(99,91,255,0.1)';
      statusEl.style.color = '#635bff';
      statusEl.innerHTML = '‚è≥ Importando cobros fallidos a Student Success...';
      
      if (!stripeDataCache || !stripeDataCache.failed_charges_list || !stripeDataCache.failed_charges_list.length) {
        statusEl.style.background = 'rgba(231,76,60,0.1)';
        statusEl.style.color = '#dc2626';
        statusEl.innerHTML = '‚ùå No hay cobros fallidos para importar. Carga datos de Stripe primero.';
        return;
      }
      
      var failedList = stripeDataCache.failed_charges_list;
      var imported = 0;
      var skipped = 0;
      var errors = 0;
      
      for (var i = 0; i < failedList.length; i++) {
        var fc = failedList[i];
        var email = fc.customer_email || '';
        if (!email) { skipped++; continue; }
        
        try {
          // Check if ticket already exists for this charge
          var { data: existing } = await supabaseClient.from('student_success_tickets')
            .select('id')
            .eq('student_email', email)
            .eq('tipo', 'pago_fallido')
            .ilike('descripcion', '%' + fc.id + '%')
            .limit(1);
          
          if (existing && existing.length > 0) {
            skipped++;
            continue;
          }
          
          // Get student name and phone from users table
          var studentName = fc.customer_name || '';
          var studentPhone = '';
          if (email) {
            var { data: userData } = await supabaseClient.from('users')
              .select('nombre, telefono')
              .eq('email', email)
              .limit(1);
            if (userData && userData[0]) { 
              studentName = studentName || userData[0].nombre || ''; 
              studentPhone = userData[0].telefono || ''; 
            }
          }
          
          var amount = (fc.amount / 100).toFixed(2);
          var fecha = new Date(fc.created * 1000).toLocaleDateString('es-MX');
          var failDate = new Date(fc.created * 1000);
          var ageHours = (Date.now() - failDate.getTime()) / 3600000;
          
          // Auto-assign priority and deadline based on age
          var prioridad = 'alta';
          var fechaLimite = new Date();
          if (ageHours < 24) {
            prioridad = 'critica';
            fechaLimite.setDate(fechaLimite.getDate() + 1);
          } else if (ageHours < 72) {
            prioridad = 'alta';
            fechaLimite.setDate(fechaLimite.getDate() + 2);
          } else if (ageHours < 168) {
            prioridad = 'media';
            fechaLimite.setDate(fechaLimite.getDate() + 3);
          } else {
            prioridad = 'baja';
            fechaLimite.setDate(fechaLimite.getDate() + 7);
          }
          
          var { error: insertErr } = await supabaseClient.from('student_success_tickets').insert({
            student_email: email,
            student_name: studentName || email,
            student_phone: studentPhone || '',
            tipo: 'pago_fallido',
            estado: 'abierto',
            prioridad: prioridad,
            descripcion: 'COBRO FALLIDO $' + amount + ' | Fecha: ' + fecha + ' | ' + (fc.failure_message || 'Declined') + ' | Stripe: ' + fc.id + ' | LLAMAR para actualizar metodo de pago.',
            monto: parseFloat(amount),
            fecha_limite: fechaLimite.toISOString(),
            email_enviado_estudiante: false
          });
          
          if (insertErr) {
            console.error('[Import] Error for ' + email + ':', insertErr);
            errors++;
          } else {
            imported++;
          }
        } catch(e) {
          console.error('[Import] Error:', e);
          errors++;
        }
        
        // Update progress
        statusEl.innerHTML = '‚è≥ Importando... ' + (i + 1) + '/' + failedList.length + ' (' + imported + ' nuevos, ' + skipped + ' ya existentes)';
      }
      
      // Final status
      if (imported > 0) {
        statusEl.style.background = 'rgba(22,163,74,0.1)';
        statusEl.style.color = '#16a34a';
        statusEl.innerHTML = '‚úÖ Importaci√≥n completa: <strong>' + imported + ' tickets creados</strong> | ' + skipped + ' ya exist√≠an | ' + errors + ' errores<br><span style="font-size:11px;">Ve a üé´ Student Success ‚Üí üî¥ Cobros Fallidos para dar seguimiento.</span>';
      } else {
        statusEl.style.background = 'rgba(243,156,18,0.1)';
        statusEl.style.color = '#d97706';
        statusEl.innerHTML = '‚ö†Ô∏è No se importaron tickets nuevos. ' + skipped + ' ya exist√≠an en Student Success.';
      }
      
      // Reload Student Success tickets if function exists
      try { loadSSTickets('abierto'); } catch(e) {}
    }

    // ==================== STRIPE INTEGRATION ‚Äî SESI√ìN 5 ====================
    
    // Tab switching for Finanzas
    function finShowTab(tab) {
      document.getElementById('finStripePanel').style.display = tab === 'stripe' ? 'block' : 'none';
      document.getElementById('finSupabasePanel').style.display = tab === 'supabase' ? 'block' : 'none';
      document.getElementById('finReconcilePanel').style.display = tab === 'reconcile' ? 'block' : 'none';
      // Update button styles
      var tabs = {stripe:'finTabStripe', supabase:'finTabSupabase', reconcile:'finTabReconcile'};
      Object.keys(tabs).forEach(function(k) {
        var btn = document.getElementById(tabs[k]);
        if (k === tab) {
          btn.style.background = k === 'stripe' ? '#635bff' : '#3ecf8e';
          btn.style.color = 'white';
          btn.style.border = 'none';
        } else {
          btn.style.background = '#f1f5f9';
          btn.style.color = '#475569';
          btn.style.border = '1px solid #e2e8f0';
        }
      });
      // Auto-load data
      if (tab === 'supabase') loadFinanzasData();
      if (tab === 'reconcile') loadReconcileData();
    }
    
    // ---- STRIPE DATA via Edge Function ----
    var stripeDataCache = null;
    
    // Middleware: Convert raw Stripe API data to dashboard format
    function processStripeRawData(raw) {
      // If data already has 'mrr' key, it's already processed - return as-is
      if (raw.mrr !== undefined && raw.active_subscriptions !== undefined) return raw;
      
      var processed = {};
      
      // ---- SUBSCRIPTIONS ----
      var activeSubs = (raw.subscriptions && raw.subscriptions.active) ? raw.subscriptions.active : [];
      var canceledSubs = (raw.subscriptions && raw.subscriptions.canceled) ? raw.subscriptions.canceled : [];
      var pausedSubs = (raw.subscriptions && raw.subscriptions.paused) ? raw.subscriptions.paused : [];
      
      processed.active_subscriptions = activeSubs.length;
      processed.canceled_subscriptions = canceledSubs.length;
      processed.paused_subscriptions = pausedSubs.length;
      
      // Calculate MRR from active subs
      var mrr = 0;
      var subPrice = 0;
      activeSubs.forEach(function(sub) {
        try {
          var item = sub.items && sub.items.data && sub.items.data[0];
          if (item && item.price) {
            var amount = item.price.unit_amount || 0; // in cents
            var interval = item.price.recurring ? item.price.recurring.interval : 'month';
            if (interval === 'year') amount = Math.round(amount / 12);
            else if (interval === 'week') amount = Math.round(amount * 4.33);
            mrr += amount;
            if (!subPrice && amount > 0) subPrice = amount;
          }
        } catch(e) {}
      });
      processed.mrr = Math.round(mrr / 100); // convert cents to dollars
      processed.subscription_price = (subPrice / 100).toFixed(2);
      
      // Churn rate (30 day)
      var totalSubs = activeSubs.length + canceledSubs.length;
      processed.churn_rate = totalSubs > 0 ? ((canceledSubs.length / totalSubs) * 100).toFixed(1) : '0';
      
      // ---- BALANCE ----
      if (raw.balance && raw.balance.available && raw.balance.available[0]) {
        processed.balance = raw.balance.available[0].amount || 0; // in cents, renderStripeKPIs divides by 100
      } else if (typeof raw.balance === 'number') {
        processed.balance = raw.balance;
      } else {
        processed.balance = 0;
      }
      
      // ---- CHARGES ----
      var charges = Array.isArray(raw.charges) ? raw.charges : [];
      var successful = 0, failed = 0, refunded = 0, disputed = 0;
      var failedAmount = 0;
      var failedList = [];
      var monthlyRev = {};
      
      charges.forEach(function(ch) {
        var amount = ch.amount || 0;
        if (ch.status === 'succeeded' && ch.paid) {
          successful++;
          // Monthly revenue
          var d = new Date((ch.created || 0) * 1000);
          var key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          if (!monthlyRev[key]) monthlyRev[key] = 0;
          monthlyRev[key] += Math.round(amount / 100);
        } else if (ch.status === 'failed' || (ch.failure_message && !ch.paid)) {
          failed++;
          failedAmount += amount;
          failedList.push({
            id: ch.id,
            amount: amount,
            customer_email: (ch.billing_details && ch.billing_details.email) || ch.receipt_email || '',
            customer_name: (ch.billing_details && ch.billing_details.name) || '',
            failure_message: ch.failure_message || 'Declined',
            created: ch.created
          });
        }
        if (ch.refunded) refunded++;
        if (ch.disputed) disputed++;
      });
      
      processed.total_transactions = charges.length;
      processed.successful_transactions = successful;
      processed.failed_transactions = failed;
      processed.refunded_transactions = refunded;
      processed.disputed_transactions = disputed;
      processed.success_rate = charges.length > 0 ? ((successful / charges.length) * 100).toFixed(1) : '0';
      processed.failed_charges = failed;
      processed.failed_amount = Math.round(failedAmount / 100);
      processed.failed_charges_list = failedList;
      
      // Monthly revenue (last 6 months)
      var now = new Date();
      var months = [];
      for (var i = 5; i >= 0; i--) {
        var d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        var key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
        var monthNames = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
        months.push({ month: monthNames[d.getMonth()], amount: monthlyRev[key] || 0 });
      }
      processed.monthly_revenue = months;
      
      // Customer phones
      if (raw.customer_phones) processed.customer_phones = raw.customer_phones;
      
      console.log('[Stripe] Processed raw data:', { mrr: processed.mrr, active: processed.active_subscriptions, failed: processed.failed_charges, balance: processed.balance });
      return processed;
    }
    
    async function loadFinanzasStripe() {
      var statusEl = document.getElementById('stripeConnStatus');
      statusEl.textContent = '‚è≥ Conectando con Stripe...';
      
      try {
        var response = await fetch(SUPABASE_URL + '/functions/v1/get-stripe-data', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + SUPABASE_KEY
          },
          body: JSON.stringify({ action: 'dashboard' })
        });
        
        if (!response.ok) {
          var errText = await response.text();
          throw new Error('HTTP ' + response.status + ': ' + errText);
        }
        
        var data = await response.json();
        
        // Process raw Stripe data into dashboard format
        data = processStripeRawData(data);
        stripeDataCache = data;
        
        // Update status
        statusEl.innerHTML = '‚úÖ Conectado ‚Äî Datos actualizados ' + new Date().toLocaleTimeString('es-MX');
        document.getElementById('stripeStatusBanner').style.background = 'linear-gradient(135deg,#16a34a,#15803d)';
        
        // Update KPIs
        renderStripeKPIs(data);
        renderStripeChart(data);
        renderStripeTransactions(data);
        renderStripeSubscriptions(data);
        renderStripeFailedCharges(data);
        renderStripeRecentCharges(data);
        
        // AUTO-IMPORT: Silently import failed charges to Student Success
        if (data.failed_charges_list && data.failed_charges_list.length > 0) {
          try { await autoImportFailedToSS(); } catch(e) { console.warn('[AutoImport]', e); }
        }
        
        document.getElementById('stripeLastUpdate').textContent = 'Actualizado: ' + new Date().toLocaleTimeString('es-MX');
        
        console.log('[Stripe] Dashboard loaded:', data);
        
      } catch(e) {
        console.error('[Stripe] Error:', e);
        statusEl.innerHTML = '‚ùå Error: ' + e.message;
        document.getElementById('stripeStatusBanner').style.background = 'linear-gradient(135deg,#dc2626,#b91c1c)';
        
        // Show helpful message
        if (e.message.includes('404') || e.message.includes('not found')) {
          statusEl.innerHTML += '<br><span style="font-size:11px;opacity:0.8;">La Edge Function get-stripe-data no est√° deployada. Ve las instrucciones abajo.</span>';
          showStripeSetupInstructions();
        } else if (e.message.includes('401') || e.message.includes('403')) {
          statusEl.innerHTML += '<br><span style="font-size:11px;opacity:0.8;">Error de autenticaci√≥n. Verifica tu STRIPE_SECRET_KEY en Supabase secrets.</span>';
        }
      }
    }
    
    function renderStripeKPIs(data) {
      if (data.mrr !== undefined) document.getElementById('stripeMRR').textContent = '$' + Number(data.mrr).toLocaleString();
      if (data.active_subscriptions !== undefined) document.getElementById('stripeActiveSubs').textContent = data.active_subscriptions;
      if (data.failed_charges !== undefined) {
        document.getElementById('stripeFailedCharges').textContent = data.failed_charges;
        if (data.failed_amount !== undefined) document.getElementById('stripeFailedAmount').textContent = '$' + Number(data.failed_amount).toLocaleString() + ' perdido';
      }
      if (data.balance !== undefined) document.getElementById('stripeBalance').textContent = '$' + Number(data.balance / 100).toLocaleString();
    }
    
    function renderStripeChart(data) {
      var chartEl = document.getElementById('stripeRevenueChart');
      var labelsEl = document.getElementById('stripeRevenueLabels');
      if (!data.monthly_revenue || !data.monthly_revenue.length) {
        chartEl.innerHTML = '<div style="text-align:center;color:#94a3b8;width:100%;padding:40px;">Sin datos de revenue mensual</div>';
        return;
      }
      var months = data.monthly_revenue;
      var maxVal = Math.max.apply(null, months.map(function(m) { return m.amount; })) || 1;
      var totalRev = months.reduce(function(s, m) { return s + m.amount; }, 0);
      document.getElementById('stripeRevenueTotal').textContent = 'Total: $' + totalRev.toLocaleString();
      
      var chartHtml = '';
      var labelsHtml = '';
      months.forEach(function(m) {
        var height = Math.max(5, Math.round((m.amount / maxVal) * 140));
        var color = m.amount > 0 ? 'linear-gradient(to top,#16a34a,#4ade80)' : '#e2e8f0';
        chartHtml += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;">';
        chartHtml += '<div style="font-size:10px;color:#1e293b;font-weight:bold;margin-bottom:4px;">$' + m.amount.toLocaleString() + '</div>';
        chartHtml += '<div style="width:100%;height:' + height + 'px;background:' + color + ';border-radius:6px 6px 0 0;transition:height 0.5s;"></div>';
        chartHtml += '</div>';
        labelsHtml += '<div style="flex:1;text-align:center;font-size:10px;color:#64748b;">' + m.month + '</div>';
      });
      chartEl.innerHTML = chartHtml;
      labelsEl.innerHTML = labelsHtml;
    }
    
    function renderStripeTransactions(data) {
      if (data.total_transactions !== undefined) document.getElementById('stripeTotalTrans').textContent = data.total_transactions.toLocaleString();
      if (data.successful_transactions !== undefined) document.getElementById('stripeSuccessTrans').textContent = data.successful_transactions.toLocaleString() + ' (' + (data.success_rate || 0) + '%)';
      if (data.failed_transactions !== undefined) document.getElementById('stripeFailedTrans').textContent = data.failed_transactions.toLocaleString();
      if (data.refunded_transactions !== undefined) document.getElementById('stripeRefundTrans').textContent = data.refunded_transactions.toLocaleString();
      if (data.disputed_transactions !== undefined) document.getElementById('stripeDisputeTrans').textContent = data.disputed_transactions.toLocaleString();
    }
    
    function renderStripeSubscriptions(data) {
      if (data.active_subscriptions !== undefined) document.getElementById('stripeSubsActive').textContent = data.active_subscriptions;
      if (data.paused_subscriptions !== undefined) document.getElementById('stripeSubsPaused').textContent = data.paused_subscriptions;
      if (data.canceled_subscriptions !== undefined) document.getElementById('stripeSubsCanceled').textContent = data.canceled_subscriptions;
      if (data.churn_rate !== undefined) document.getElementById('stripeChurnReal').textContent = data.churn_rate + '%';
      if (data.subscription_price !== undefined) document.getElementById('stripeSubPrice').textContent = '$' + data.subscription_price;
    }
    
    function renderStripeFailedCharges(data) {
      var alertEl = document.getElementById('stripeFailedAlert');
      var listEl = document.getElementById('stripeFailedList');
      if (!data.failed_charges_list || !data.failed_charges_list.length) {
        alertEl.style.display = 'none';
        return;
      }
      alertEl.style.display = 'block';
      var html = '';
      data.failed_charges_list.forEach(function(fc) {
        var email = fc.customer_email || fc.customer_name || 'Desconocido';
        var amount = (fc.amount/100).toFixed(2);
        var fecha = new Date(fc.created * 1000).toLocaleDateString('es-MX');
        html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:white;border-radius:8px;margin-bottom:6px;border:1px solid #fecaca;flex-wrap:wrap;gap:6px;">';
        html += '<div style="flex:1;min-width:200px;">';
        html += '<div style="font-weight:bold;color:#1e293b;font-size:12px;">üë§ ' + email + '</div>';
        html += '<div style="color:#dc2626;font-size:11px;">$' + amount + ' ‚Äî ' + (fc.failure_message || 'Declined') + '</div>';
        html += '<div style="color:#94a3b8;font-size:10px;">' + fecha + '</div>';
        html += '</div>';
        html += '<div style="display:flex;gap:4px;">';
        html += '<button onclick="createSingleFailedTicket(\'' + (fc.customer_email || '').replace(/'/g, "\\'") + '\',' + fc.amount + ',\'' + (fc.failure_message || 'Declined').replace(/'/g, "\\'") + '\',\'' + fc.id + '\',this)" style="padding:5px 8px;background:#e74c3c;color:white;border:none;border-radius:6px;font-size:10px;cursor:pointer;" title="Crear ticket">üé´</button>';
        html += '<button onclick="window.open(\'https://dashboard.stripe.com/payments/' + fc.id + '\',\'_blank\')" style="padding:5px 8px;background:#635bff;color:white;border:none;border-radius:6px;font-size:10px;cursor:pointer;" title="Ver en Stripe">üí≥</button>';
        html += '</div>';
        html += '</div>';
      });
      listEl.innerHTML = html;
    }
    
    function renderStripeRecentCharges(data) {
      var container = document.getElementById('stripeRecentCharges');
      if (!data.recent_charges || !data.recent_charges.length) {
        container.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:20px;">Sin cobros recientes</div>';
        return;
      }
      var html = '';
      data.recent_charges.forEach(function(ch) {
        var statusColor = ch.status === 'succeeded' ? '#16a34a' : ch.status === 'failed' ? '#dc2626' : '#d97706';
        var statusIcon = ch.status === 'succeeded' ? '‚úÖ' : ch.status === 'failed' ? '‚ùå' : '‚è≥';
        var amount = (ch.amount / 100).toFixed(2);
        html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:white;border-radius:8px;margin-bottom:6px;border:1px solid #e2e8f0;">';
        html += '<div style="display:flex;align-items:center;gap:10px;">';
        html += '<span style="font-size:18px;">' + statusIcon + '</span>';
        html += '<div>';
        html += '<div style="font-size:13px;font-weight:bold;color:#1e293b;">$' + amount + ' USD</div>';
        html += '<div style="font-size:11px;color:#64748b;">' + (ch.customer_email || ch.description || 'Pago') + '</div>';
        html += '</div>';
        html += '</div>';
        html += '<div style="text-align:right;">';
        html += '<div style="font-size:11px;color:' + statusColor + ';font-weight:bold;">' + (ch.status === 'succeeded' ? 'Exitoso' : ch.status === 'failed' ? 'Fallido' : ch.status) + '</div>';
        html += '<div style="font-size:10px;color:#94a3b8;">' + new Date(ch.created * 1000).toLocaleDateString('es-MX') + '</div>';
        html += '</div>';
        html += '</div>';
      });
      container.innerHTML = html;
    }
    
    function showStripeSetupInstructions() {
      var container = document.getElementById('stripeRecentCharges');
      container.innerHTML = '<div style="background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:15px;">' +
        '<div style="color:#92400e;font-weight:bold;margin-bottom:10px;">üìã Para conectar Stripe, necesitas deployar esta Edge Function:</div>' +
        '<div style="background:#fef3c7;border-radius:8px;padding:12px;font-family:monospace;font-size:11px;color:#78350f;margin-bottom:10px;">' +
        '1. supabase functions new get-stripe-data<br>' +
        '2. Agrega tu STRIPE_SECRET_KEY a Supabase secrets:<br>' +
        '   <code>supabase secrets set STRIPE_SECRET_KEY=sk_live_xxx</code><br>' +
        '3. supabase functions deploy get-stripe-data<br>' +
        '</div>' +
        '<div style="color:#a16207;font-size:12px;">üìå El c√≥digo de la Edge Function se proporcionar√° al final de esta sesi√≥n.</div>' +
        '</div>';
    }
    
    // ---- RECONCILIATION ----
    async function loadReconcileData() {
      try {
        // Get Supabase memberships
        var { data: memberships } = await supabaseClient.from('memberships').select('*');
        memberships = memberships || [];
        var activeSupa = memberships.filter(function(m) { return m.status === 'active' || m.status === 'activa'; });
        document.getElementById('reconSupaCount').textContent = activeSupa.length;
        
        // Get Stripe data if cached
        if (stripeDataCache && stripeDataCache.active_subscriptions !== undefined) {
          document.getElementById('reconStripeCount').textContent = stripeDataCache.active_subscriptions;
          var diff = Math.abs(stripeDataCache.active_subscriptions - activeSupa.length);
          document.getElementById('reconDiff').textContent = diff;
          document.getElementById('reconDiff').style.color = diff === 0 ? '#16a34a' : '#dc2626';
        } else {
          document.getElementById('reconStripeCount').textContent = '?';
          document.getElementById('reconDiff').textContent = '?';
          document.getElementById('reconLog').innerHTML = '<div style="color:#d97706;">‚ö†Ô∏è Carga datos de Stripe primero (pesta√±a Stripe ‚Üí Cargar Stripe)</div>';
        }
      } catch(e) {
        console.error('[Reconcile]', e);
      }
    }
    
    async function runReconciliation() {
      var logEl = document.getElementById('reconLog');
      logEl.innerHTML = '<div style="color:#635bff;">üîÑ Iniciando reconciliaci√≥n...</div>';
      
      if (!stripeDataCache || !stripeDataCache.subscriptions_detail) {
        logEl.innerHTML += '<div style="color:#dc2626;">‚ùå Primero carga datos de Stripe.</div>';
        return;
      }
      
      try {
        var { data: memberships } = await supabaseClient.from('memberships').select('*');
        memberships = memberships || [];
        
        var stripeSubs = stripeDataCache.subscriptions_detail || [];
        var supaEmails = memberships.map(function(m) { return (m.email || '').toLowerCase(); });
        var synced = 0;
        var errors = 0;
        
        logEl.innerHTML += '<div>üìã Stripe suscripciones: ' + stripeSubs.length + '</div>';
        logEl.innerHTML += '<div>üìã Supabase membres√≠as: ' + memberships.length + '</div>';
        
        // Find Stripe subs NOT in Supabase
        for (var i = 0; i < stripeSubs.length; i++) {
          var sub = stripeSubs[i];
          var email = (sub.customer_email || '').toLowerCase();
          if (!email) continue;
          
          if (!supaEmails.includes(email) && sub.status === 'active') {
            logEl.innerHTML += '<div style="color:#d97706;">‚ûï Falta en Supabase: ' + email + ' (Stripe: active)</div>';
            
            // Insert into memberships
            try {
              await supabaseClient.from('memberships').insert({
                email: email,
                status: 'active',
                tipo: 'stripe_sync',
                stripe_subscription_id: sub.id,
                fecha_inicio: new Date(sub.current_period_start * 1000).toISOString(),
                price: sub.plan_amount ? sub.plan_amount / 100 : 111
              });
              logEl.innerHTML += '<div style="color:#16a34a;">  ‚úÖ Sincronizado: ' + email + '</div>';
              synced++;
            } catch(e) {
              logEl.innerHTML += '<div style="color:#dc2626;">  ‚ùå Error: ' + e.message + '</div>';
              errors++;
            }
          }
        }
        
        // Find Supabase active memberships NOT in Stripe (possibly canceled)
        var stripeEmails = stripeSubs.filter(function(s) { return s.status === 'active'; }).map(function(s) { return (s.customer_email || '').toLowerCase(); });
        var activeSupaNotStripe = memberships.filter(function(m) {
          return (m.status === 'active' || m.status === 'activa') && !stripeEmails.includes((m.email || '').toLowerCase());
        });
        
        if (activeSupaNotStripe.length > 0) {
          logEl.innerHTML += '<div style="color:#e74c3c;margin-top:8px;">‚ö†Ô∏è ' + activeSupaNotStripe.length + ' membres√≠as activas en Supabase pero NO en Stripe:</div>';
          activeSupaNotStripe.forEach(function(m) {
            logEl.innerHTML += '<div style="color:#e74c3c;">  ‚Ä¢ ' + m.email + ' (posible cancelaci√≥n)</div>';
          });
        }
        
        logEl.innerHTML += '<div style="color:#16a34a;margin-top:10px;font-weight:bold;">‚úÖ Reconciliaci√≥n completa. Sincronizados: ' + synced + ' | Errores: ' + errors + '</div>';
        
        // Reload counts
        loadReconcileData();
        
      } catch(e) {
        logEl.innerHTML += '<div style="color:#dc2626;">‚ùå Error: ' + e.message + '</div>';
      }
    }

    // ==================== ALERTAS DE INACTIVIDAD ‚Äî AUDITOR√çA #4 ====================
    var inactiveStudentsList = [];
    
    async function loadInactivityAlerts() {
      if (!supabaseClient) return;
      var container = document.getElementById('inactivityList');
      container.innerHTML = '<div style="text-align:center;color:#f39c12;padding:15px;">‚è≥ Escaneando actividad de estudiantes...</div>';
      
      try {
        var { data: users } = await supabaseClient.from('users').select('id, nombre, email, ultimo_acceso, fecha_registro');
        users = users || [];
        
        var now = new Date();
        var sevenDays = 7 * 24 * 60 * 60 * 1000;
        var fourteenDays = 14 * 24 * 60 * 60 * 1000;
        
        var critical = []; // 14+ days
        var warning = []; // 7-13 days
        var activeCount = 0;
        
        users.forEach(function(u) {
          var lastActive = u.ultimo_acceso ? new Date(u.ultimo_acceso) : (u.fecha_registro ? new Date(u.fecha_registro) : null);
          if (!lastActive) return;
          
          var daysSince = Math.floor((now.getTime() - lastActive.getTime()) / (24*60*60*1000));
          
          if (daysSince >= 14) {
            critical.push({ id: u.id, nombre: u.nombre || u.email || 'Sin nombre', email: u.email, days: daysSince, lastActive: lastActive });
          } else if (daysSince >= 7) {
            warning.push({ id: u.id, nombre: u.nombre || u.email || 'Sin nombre', email: u.email, days: daysSince, lastActive: lastActive });
          } else {
            activeCount++;
          }
        });
        
        inactiveStudentsList = critical.concat(warning);
        
        // Sort by days inactive (most inactive first)
        critical.sort(function(a,b) { return b.days - a.days; });
        warning.sort(function(a,b) { return b.days - a.days; });
        
        document.getElementById('inactCritical').textContent = critical.length;
        document.getElementById('inactWarning').textContent = warning.length;
        document.getElementById('inactActive').textContent = activeCount;
        
        if (critical.length === 0 && warning.length === 0) {
          container.innerHTML = '<div style="text-align:center;padding:20px;"><div style="font-size:40px;">üéâ</div><p style="color:#27ae60;font-size:14px;">¬°Todos los estudiantes est√°n activos!</p></div>';
          return;
        }
        
        var html = '';
        
        if (critical.length > 0) {
          html += '<div style="color:#e74c3c;font-size:12px;font-weight:bold;padding:8px 0;">üî¥ CR√çTICO ‚Äî ' + critical.length + ' estudiantes (14+ d√≠as sin actividad)</div>';
          critical.forEach(function(s) {
            html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,0.05);background:rgba(231,76,60,0.08);border-radius:6px;margin:3px 0;">' +
              '<div><strong style="color:#e2e8f0;font-size:12px;">' + s.nombre + '</strong><br><span style="color:#64748b;font-size:10px;">' + (s.email || '') + '</span></div>' +
              '<div style="text-align:right;"><span style="color:#dc2626;font-weight:bold;font-size:14px;">' + s.days + ' d√≠as</span><br><span style="color:#64748b;font-size:9px;">' + s.lastActive.toLocaleDateString('es-MX') + '</span></div>' +
            '</div>';
          });
        }
        
        if (warning.length > 0) {
          html += '<div style="color:#f39c12;font-size:12px;font-weight:bold;padding:8px 0;margin-top:8px;">üü° ALERTA ‚Äî ' + warning.length + ' estudiantes (7-13 d√≠as sin actividad)</div>';
          warning.forEach(function(s) {
            html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,0.05);background:rgba(243,156,18,0.06);border-radius:6px;margin:3px 0;">' +
              '<div><strong style="color:#e2e8f0;font-size:12px;">' + s.nombre + '</strong><br><span style="color:#64748b;font-size:10px;">' + (s.email || '') + '</span></div>' +
              '<div style="text-align:right;"><span style="color:#f39c12;font-weight:bold;font-size:14px;">' + s.days + ' d√≠as</span><br><span style="color:#64748b;font-size:9px;">' + s.lastActive.toLocaleDateString('es-MX') + '</span></div>' +
            '</div>';
          });
        }
        
        container.innerHTML = html;
        console.log('[Inactividad] Cr√≠tico: ' + critical.length + ' | Alerta: ' + warning.length + ' | Activos: ' + activeCount);
      } catch(e) {
        console.error('[Inactividad] Error:', e);
        container.innerHTML = '<div style="color:#e74c3c;padding:15px;text-align:center;">Error: ' + e.message + '</div>';
      }
    }
    
    async function createInactivityTickets() {
      if (!supabaseClient || inactiveStudentsList.length === 0) {
        alert('No hay estudiantes inactivos detectados. Primero haz clic en "Escanear".');
        return;
      }
      
      if (!confirm('¬øCrear ' + inactiveStudentsList.length + ' tickets de Student Success para estudiantes inactivos?')) return;
      
      var created = 0;
      for (var i = 0; i < inactiveStudentsList.length; i++) {
        var s = inactiveStudentsList[i];
        try {
          var severity = s.days >= 14 ? 'CR√çTICO' : 'ALERTA';
          await supabaseClient.from('student_success_tickets').insert({
            student_name: s.nombre,
            student_email: s.email || '',
            estado: 'abierto',
            descripcion: '‚ö†Ô∏è [' + severity + '] Estudiante inactivo por ' + s.days + ' d√≠as. √öltima actividad: ' + s.lastActive.toLocaleDateString('es-MX') + '. Contactar ANTES de que cancele.',
            fecha_limite: new Date(Date.now() + (s.days >= 14 ? 2 : 5) * 24*60*60*1000).toISOString(),
            email_enviado_estudiante: false
          });
          created++;
        } catch(e) { console.error('[Ticket] Error para ' + s.nombre + ':', e); }
      }
      
      alert('‚úÖ ' + created + ' tickets creados en Student Success');
      inactiveStudentsList = [];
      loadInactivityAlerts();
    }

    // ==================== ONBOARDING NUEVOS ESTUDIANTES ‚Äî AUDITOR√çA #5 ====================
    function checkShowOnboarding() {
      if (!currentUser) return;
      var onboardingDone = localStorage.getItem('maestroac_onboarding_done_' + (currentUser.email || ''));
      if (onboardingDone) return;
      
      // Check if user has any progress
      var hasProgress = false;
      if (progress) {
        Object.values(progress).forEach(function(p) { if (p.completed > 0) hasProgress = true; });
      }
      if (hasProgress) {
        localStorage.setItem('maestroac_onboarding_done_' + (currentUser.email || ''), 'true');
        return;
      }
      
      // Show onboarding
      setTimeout(function() { showOnboarding(); }, 800);
    }
    
    function showOnboarding() {
      var userName = currentUser ? currentUser.nombre.split(' ')[0] : 'T√©cnico';
      var overlay = document.createElement('div');
      overlay.className = 'onboarding-overlay';
      overlay.id = 'onboardingOverlay';
      overlay.innerHTML = 
        '<div class="onboarding-card">' +
          '<div class="onboarding-dots">' +
            '<div class="onboarding-dot active" id="obDot1"></div>' +
            '<div class="onboarding-dot" id="obDot2"></div>' +
            '<div class="onboarding-dot" id="obDot3"></div>' +
          '</div>' +
          
          '<div class="onboarding-step active" id="obStep1">' +
            '<div style="font-size:60px;margin-bottom:10px;">üëã</div>' +
            '<h2 style="color:#f39c12;margin-bottom:8px;">¬°Bienvenido ' + userName + '!</h2>' +
            '<p style="color:#e2e8f0;font-size:14px;line-height:1.6;margin-bottom:20px;">Soy <strong style="color:#f39c12;">Maestro Mario</strong> y esta app te va a llevar de t√©cnico nuevo a <strong style="color:#FFD700;">t√©cnico certificado</strong> paso a paso.</p>' +
            '<div style="background:rgba(243,156,18,0.1);border:1px solid rgba(243,156,18,0.3);border-radius:12px;padding:15px;margin-bottom:20px;">' +
              '<p style="color:#f39c12;font-size:13px;font-weight:bold;">üéØ Tu camino tiene 5 niveles:</p>' +
              '<p style="color:#94a3b8;font-size:12px;margin-top:5px;">üîß Principiante ‚Üí üìä Intermedio ‚Üí ‚ö° Avanzado ‚Üí üèÜ Elite ‚Üí üíé Platino</p>' +
            '</div>' +
            '<button onclick="onboardingNext(2)" style="width:100%;padding:15px;border:none;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#f39c12,#e67e22);color:white;">Siguiente ‚Üí</button>' +
          '</div>' +
          
          '<div class="onboarding-step" id="obStep2">' +
            '<div style="font-size:60px;margin-bottom:10px;">üìù</div>' +
            '<h2 style="color:#3498db;margin-bottom:8px;">Paso 1: Completa Tu Perfil</h2>' +
            '<p style="color:#e2e8f0;font-size:14px;line-height:1.6;margin-bottom:20px;">Un perfil completo nos ayuda a darte la mejor experiencia. Necesitamos tu nombre, tel√©fono y ciudad.</p>' +
            '<div style="background:rgba(52,152,219,0.1);border:1px solid rgba(52,152,219,0.3);border-radius:12px;padding:15px;margin-bottom:20px;">' +
              '<p style="color:#3498db;font-size:13px;">‚úÖ Nombre completo</p>' +
              '<p style="color:#3498db;font-size:13px;">‚úÖ Tel√©fono</p>' +
              '<p style="color:#3498db;font-size:13px;">‚úÖ Ciudad y Estado</p>' +
            '</div>' +
            '<button onclick="onboardingNext(3)" style="width:100%;padding:15px;border:none;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#3498db,#2980b9);color:white;">Siguiente ‚Üí</button>' +
            '<button onclick="onboardingNext(1)" style="width:100%;padding:10px;border:none;border-radius:12px;font-size:13px;cursor:pointer;background:transparent;color:#64748b;margin-top:8px;">‚Üê Atr√°s</button>' +
          '</div>' +
          
          '<div class="onboarding-step" id="obStep3">' +
            '<div style="font-size:60px;margin-bottom:10px;">üöÄ</div>' +
            '<h2 style="color:#27ae60;margin-bottom:8px;">Paso 2: ¬°Tu Primera Lecci√≥n!</h2>' +
            '<p style="color:#e2e8f0;font-size:14px;line-height:1.6;margin-bottom:20px;">Empieza con el <strong style="color:#f39c12;">Nivel Principiante</strong>. Toma tu primer quiz y demuestra lo que sabes. ¬°Necesitas <strong style="color:#2ecc71;">80%</strong> para certificarte!</p>' +
            '<div style="background:rgba(39,174,96,0.1);border:1px solid rgba(39,174,96,0.3);border-radius:12px;padding:15px;margin-bottom:20px;">' +
              '<p style="color:#27ae60;font-size:13px;font-weight:bold;">üèÖ Tu primer objetivo:</p>' +
              '<p style="color:#e2e8f0;font-size:14px;margin-top:5px;">Completar el quiz de <strong>Nivel Principiante</strong> con 80%+ y ganar tu primer certificado verificable con c√≥digo QR.</p>' +
            '</div>' +
            '<button onclick="finishOnboarding(true)" style="width:100%;padding:15px;border:none;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#27ae60,#2ecc71);color:white;">üîß ¬°Empezar Ahora!</button>' +
            '<button onclick="finishOnboarding(false)" style="width:100%;padding:10px;border:none;border-radius:12px;font-size:13px;cursor:pointer;background:transparent;color:#64748b;margin-top:8px;">Explorar primero</button>' +
            '<button onclick="onboardingNext(2)" style="width:100%;padding:10px;border:none;border-radius:12px;font-size:13px;cursor:pointer;background:transparent;color:#64748b;">‚Üê Atr√°s</button>' +
          '</div>' +
        '</div>';
      document.body.appendChild(overlay);
    }
    
    function onboardingNext(step) {
      for (var i = 1; i <= 3; i++) {
        var s = document.getElementById('obStep' + i);
        var d = document.getElementById('obDot' + i);
        if (s) s.classList.remove('active');
        if (d) { d.classList.remove('active'); if (i < step) d.classList.add('completed'); else d.classList.remove('completed'); }
      }
      var target = document.getElementById('obStep' + step);
      var dot = document.getElementById('obDot' + step);
      if (target) target.classList.add('active');
      if (dot) dot.classList.add('active');
    }
    
    function finishOnboarding(goToQuiz) {
      var overlay = document.getElementById('onboardingOverlay');
      if (overlay) overlay.remove();
      if (currentUser && currentUser.email) {
        localStorage.setItem('maestroac_onboarding_done_' + currentUser.email, 'true');
      }
      if (goToQuiz) {
        showScreen('levelsScreen');
      }
    }


    // ==================== EMAILS DE PROGRESO SEMANAL ‚Äî #4 ====================
    async function previewWeeklyEmail() {
      var preview = document.getElementById('weeklyEmailPreview');
      if (!allTechnicians || allTechnicians.length === 0) { 
        preview.style.display = 'block';
        preview.innerHTML = '<p style="color:#e74c3c;">No hay estudiantes cargados</p>';
        return; 
      }
      
      var withProgress = allTechnicians.filter(function(t) { 
        return t.progress && Object.values(t.progress).some(function(p) { return p.completed > 0; }); 
      });
      
      document.getElementById('weActiveStudents').textContent = allTechnicians.length;
      document.getElementById('weWithProgress').textContent = withProgress.length;
      
      // Sample email preview
      var sample = withProgress[0] || allTechnicians[0];
      var nombre = sample ? (sample.nombre || 'T√©cnico').split(' ')[0] : 'T√©cnico';
      var nivelesInfo = '';
      if (sample && sample.progress) {
        Object.entries(sample.progress).forEach(function(entry) {
          var nivel = entry[0], p = entry[1];
          if (p.completed > 0) {
            var pct = p.total > 0 ? Math.round((p.score/p.total)*100) : 0;
            nivelesInfo += '<div style="padding:4px 0;color:#e2e8f0;font-size:12px;">' + nivel + ': ' + pct + '% (' + p.completed + '/' + p.total + ')</div>';
          }
        });
      }
      if (!nivelesInfo) nivelesInfo = '<div style="color:#64748b;font-size:12px;">Sin progreso a√∫n</div>';
      
      preview.style.display = 'block';
      preview.innerHTML = 
        '<div style="color:#3498db;font-size:12px;font-weight:bold;margin-bottom:8px;">üìß Vista Previa del Email (Ejemplo: ' + nombre + ')</div>' +
        '<div style="background:#1a1a2e;border-radius:10px;padding:15px;border:1px solid rgba(52,152,219,0.3);">' +
          '<div style="text-align:center;margin-bottom:10px;"><span style="font-size:30px;">üîß</span></div>' +
          '<h3 style="color:#f39c12;text-align:center;margin:0 0 5px;">¬°Hola ' + nombre + '!</h3>' +
          '<p style="color:#e2e8f0;text-align:center;font-size:13px;margin-bottom:15px;">Aqu√≠ est√° tu resumen semanal de MaestroAC</p>' +
          '<div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:10px;margin-bottom:10px;">' +
            '<div style="color:#f39c12;font-size:11px;font-weight:bold;margin-bottom:5px;">üìä Tu Progreso:</div>' +
            nivelesInfo +
          '</div>' +
          '<div style="background:rgba(39,174,96,0.1);border-radius:8px;padding:10px;margin-bottom:10px;">' +
            '<div style="color:#27ae60;font-size:11px;font-weight:bold;">üéØ Pr√≥ximo Objetivo:</div>' +
            '<div style="color:#e2e8f0;font-size:12px;">Completa tu nivel actual con 80%+ para obtener tu certificado verificable con QR</div>' +
          '</div>' +
          '<div style="text-align:center;padding:10px;">' +
            '<div style="display:inline-block;background:#f39c12;color:#333;padding:10px 25px;border-radius:8px;font-weight:bold;font-size:13px;">üöÄ Seguir Estudiando</div>' +
          '</div>' +
          '<p style="color:#64748b;font-size:10px;text-align:center;margin-top:10px;">ACVOLT Tech School ‚Äî Nivel 33 | maestromario.com</p>' +
        '</div>';
    }
    
    async function sendWeeklyEmails() {
      if (!supabaseClient) { alert('Sin conexi√≥n a Supabase'); return; }
      if (!confirm('¬øEnviar email de progreso semanal a todos los estudiantes activos?\n\nSe enviar√° via Resend a cada estudiante con su progreso personalizado.')) return;
      
      try {
        var btn = event.target;
        btn.disabled = true;
        btn.textContent = 'üì§ Enviando...';
        
        var response = await fetch('https://htklsowiyjwsjnacnvnr.supabase.co/functions/v1/send-weekly-progress', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + (await supabaseClient.auth.getSession()).data.session?.access_token
          },
          body: JSON.stringify({})
        });
        
        var result = await response.json();
        
        if (result.success) {
          document.getElementById('weLastSent').textContent = new Date().toLocaleDateString('es-MX');
          alert('‚úÖ Emails enviados!\n\nüì§ Enviados: ' + result.sent + '\n‚ùå Fallidos: ' + result.failed + '\nüìä Total: ' + result.total);
        } else {
          alert('Error: ' + (result.error || 'Unknown error'));
        }
        
        btn.disabled = false;
        btn.textContent = 'üì§ Enviar';
      } catch(e) {
        alert('Error: ' + e.message);
        if (event.target) { event.target.disabled = false; event.target.textContent = 'üì§ Enviar'; }
      }
    }

    // ==================== PROGRAMA DE REFERIDOS ‚Äî #7 ====================
    function generateRefCode() {
      if (!currentUser || !currentUser.email) return 'N/A';
      var email = currentUser.email.toLowerCase();
      var hash = 0;
      for (var i = 0; i < email.length; i++) { hash = ((hash << 5) - hash) + email.charCodeAt(i); hash = hash & hash; }
      return 'REF-' + Math.abs(hash).toString(36).toUpperCase().substring(0, 6);
    }
    
    // Save ref code to user profile on first load so admin can track
    async function saveRefCodeToProfile() {
      if (!supabaseClient || !currentUser || !currentUser.email) return;
      var refCode = generateRefCode();
      try {
        await supabaseClient.from('users').update({ referral_code: refCode }).eq('email', currentUser.email.toLowerCase());
      } catch(e) {}
    }
    
    function initReferidosScreen() {
      var refCode = generateRefCode();
      var refLink = 'https://maestromario.com/app?ref=' + refCode;
      var el = document.getElementById('refLinkCode');
      if (el) el.textContent = refLink;
      
      var countEl = document.getElementById('myRefCount');
      var monthsEl = document.getElementById('myFreeMonths');
      
      // Save ref code to profile
      saveRefCodeToProfile();
      
      // Load referral stats from Supabase
      var activeEl = document.getElementById('myRefActive');
      
      if (supabaseClient) {
        supabaseClient.from('referrals').select('*').eq('referral_code', refCode).then(function(res) {
          if (res.data) {
            var allRefs = res.data;
            var registered = allRefs.filter(function(r) { return r.status === 'registered' || r.status === 'completed'; });
            var completed = allRefs.filter(function(r) { return r.status === 'completed'; });
            if (countEl) countEl.textContent = registered.length;
            if (activeEl) activeEl.textContent = completed.length;
            if (monthsEl) monthsEl.textContent = '$' + (completed.length * 20);
            
            localStorage.setItem('maestroac_ref_stats_' + (currentUser ? currentUser.email : ''), JSON.stringify({count: registered.length, active: completed.length, earned: completed.length * 20}));
          }
          
          // Check W-9 status
          supabaseClient.from('referrals').select('w9_status').eq('referral_code', refCode).limit(1).then(function() {
            checkW9Status(refCode);
          });
        }).catch(function(e) {
          console.log('[Embajadores] Load error:', e);
          var stats = JSON.parse(localStorage.getItem('maestroac_ref_stats_' + (currentUser ? currentUser.email : '')) || '{"count":0,"active":0,"earned":0}');
          if (countEl) countEl.textContent = stats.count;
          if (activeEl) activeEl.textContent = stats.active || 0;
          if (monthsEl) monthsEl.textContent = '$' + (stats.earned || 0);
        });
      }
    }
    
    function getAmbassadorMessage() {
      var refCode = generateRefCode();
      var link = 'https://maestromario.com/app?ref=' + refCode;
      var nombre = (currentUser && currentUser.nombre) ? currentUser.nombre.split(' ')[0] : 'Un compa√±ero';
      
      var msg = 'üî• *¬øEres t√©cnico HVAC y quieres certificarte?* üî•\n\n' +
        'Te recomiendo *Maestro ACVOLT* ‚Äî la app #1 de certificaci√≥n HVAC en espa√±ol. üíØ\n\n' +
        '‚úÖ Lo que incluye:\n' +
        'üß† 3,500+ preguntas de pr√°ctica para EPA 608, NATE y OSHA 30\n' +
        'ü§ñ Maestro Mario AI ‚Äî Inteligencia Artificial biling√ºe que te ayuda a estudiar\n' +
        'üé¨ 19 videos exclusivos de t√©cnicas HVAC filmados en campo real\n' +
        'üìä Tu progreso se sincroniza autom√°ticamente\n' +
        'üìÖ Mario te manda recordatorios si no has estudiado üòÇ\n\n' +
        'Esta NO es una app gen√©rica. Es la herramienta de estudio m√°s completa para t√©cnicos HVAC en espa√±ol. No existe nada igual. üí™\n\n' +
        '¬øLa mejor parte? *Es GRATIS descargarla.*\n\n' +
        'üëâ Reg√≠strate con mi link: ' + link + '\n\n' +
        'Yo la uso y me ha ayudado mucho. Si tienes preguntas, escr√≠beme.\n' +
        '‚Äî ' + nombre + '\n\n' +
        '#HVAC #EPA608 #NATE #OSHA #T√©cnicoHVAC #Certificaci√≥nHVAC #MaestroACVOLT';
      
      return { text: msg, link: link };
    }

    function copyRefLink() {
      var msg = getAmbassadorMessage();
      var fullText = msg.text;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(fullText).then(function() { 
          alert('‚úÖ ¬°Mensaje completo copiado!\n\nP√©galo en WhatsApp, Facebook, SMS o donde quieras.\n\nTu link: ' + msg.link); 
        });
      } else { 
        prompt('Copia este mensaje:', fullText); 
      }
      
      // Track share
      if (supabaseClient && supabaseUserId) {
        try { supabaseClient.from('referral_shares').insert({ user_id: supabaseUserId, platform: 'copy', ref_code: generateRefCode() }); } catch(e) {}
      }
    }
    
    function shareRefWhatsApp() {
      var msg = getAmbassadorMessage();
      window.open('https://wa.me/?text=' + encodeURIComponent(msg.text), '_blank');
      
      // Track share
      if (supabaseClient && supabaseUserId) {
        try { supabaseClient.from('referral_shares').insert({ user_id: supabaseUserId, platform: 'whatsapp', ref_code: generateRefCode() }); } catch(e) {}
      }
    }
    
    function shareRefFacebook() {
      var msg = getAmbassadorMessage();
      window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(msg.link) + '&quote=' + encodeURIComponent(msg.text), '_blank');
      
      // Track share
      if (supabaseClient && supabaseUserId) {
        try { supabaseClient.from('referral_shares').insert({ user_id: supabaseUserId, platform: 'facebook', ref_code: generateRefCode() }); } catch(e) {}
      }
    }

    function shareRefSMS() {
      var msg = getAmbassadorMessage();
      // SMS shorter version
      var smsText = 'üî• ¬øEres t√©cnico HVAC? Te recomiendo Maestro ACVOLT ‚Äî app #1 de certificaci√≥n HVAC en espa√±ol. 3,500+ preguntas EPA 608, NATE, OSHA. ¬°GRATIS! üëâ ' + msg.link;
      window.open('sms:?body=' + encodeURIComponent(smsText), '_blank');
      
      // Track share
      if (supabaseClient && supabaseUserId) {
        try { supabaseClient.from('referral_shares').insert({ user_id: supabaseUserId, platform: 'sms', ref_code: generateRefCode() }); } catch(e) {}
      }
    }
    
    async function loadReferidosData() {
      if (!supabaseClient) return;
      try {
        var { data: refs } = await supabaseClient.from('referrals').select('*');
        refs = refs || [];
        var registered = refs.filter(function(r) { return r.status === 'registered' || r.status === 'completed'; });
        var completed = refs.filter(function(r) { return r.status === 'completed'; });
        
        document.getElementById('refShared').textContent = refs.length;
        document.getElementById('refSuccess').textContent = registered.length;
        document.getElementById('refFreeMonths').textContent = '$' + (completed.length * 20);
        
        // Top referrers - group by referral_code, then lookup who owns that code
        var codeCount = {};
        registered.forEach(function(r) { 
          codeCount[r.referral_code] = (codeCount[r.referral_code] || 0) + 1; 
        });
        
        // Try to resolve ref codes to names via technicians table
        var codes = Object.keys(codeCount);
        var topHtml = '';
        
        if (codes.length > 0) {
          var { data: techs } = await supabaseClient.from('users').select('nombre, email, referral_code').in('referral_code', codes);
          techs = techs || [];
          var codeToName = {};
          techs.forEach(function(t) { codeToName[t.referral_code] = t.nombre || t.email; });
          
          var sorted = Object.entries(codeCount).sort(function(a,b) { return b[1] - a[1]; }).slice(0, 10);
          topHtml = sorted.map(function(entry, i) {
            var name = codeToName[entry[0]] || entry[0];
            return '<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.05);">' +
              '<span style="color:#e2e8f0;font-size:12px;">' + (i+1) + '. ' + name + ' <span style="color:#64748b;">(' + entry[0] + ')</span></span>' +
              '<span style="color:#9b59b6;font-weight:bold;font-size:12px;">' + entry[1] + ' referidos</span>' +
            '</div>';
          }).join('');
        } else {
          topHtml = '<div style="color:#64748b;font-size:12px;">A√∫n no hay referidos. Cuando los estudiantes compartan su link y alguien se registre, aparecer√°n aqu√≠.</div>';
        }
        
        document.getElementById('refTopList').innerHTML = topHtml;
      } catch(e) { console.error('[Referidos]', e); }
    }

    // ==================== CALENDARIO DE CLASES EN VIVO ‚Äî #9 ====================
    var liveClasses = [];
    
    async function loadCalendarData() {
      if (!supabaseClient) {
        loadDefaultSchedule();
        return;
      }
      try {
        var { data: classes } = await supabaseClient.from('live_classes').select('*').order('fecha', { ascending: true });
        liveClasses = classes || [];
        renderCalendar();
        renderStudentCalendar();
      } catch(e) {
        console.error('[Calendario]', e);
        loadDefaultSchedule();
      }
    }
    
    function loadDefaultSchedule() {
      // Generate default weekly schedule
      var days = ['Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
      var now = new Date();
      var startOfWeek = new Date(now);
      startOfWeek.setDate(now.getDate() - now.getDay() + 1);
      
      liveClasses = [];
      for (var d = 0; d < 6; d++) {
        var classDate = new Date(startOfWeek);
        classDate.setDate(startOfWeek.getDate() + d);
        liveClasses.push({
          id: 'default-' + d,
          titulo: d < 5 ? 'Clase HVAC ‚Äî ' + days[d] : 'Taller Pr√°ctico ‚Äî ' + days[d],
          fecha: classDate.toISOString(),
          hora_inicio: d < 5 ? '19:00' : '10:00',
          hora_fin: d < 5 ? '21:00' : '12:00',
          instructor: 'Maestro Mario',
          tipo: d < 5 ? 'teoria' : 'practica',
          zoom_link: '',
          estado: classDate < now ? 'completada' : 'programada'
        });
      }
      renderCalendar();
      renderStudentCalendar();
    }
    
    function renderCalendar() {
      var container = document.getElementById('calendarClassList');
      if (!container) return;
      
      var now = new Date();
      var thisWeek = liveClasses.filter(function(c) {
        var d = new Date(c.fecha);
        var weekStart = new Date(now); weekStart.setDate(now.getDate() - now.getDay());
        var weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate() + 7);
        return d >= weekStart && d <= weekEnd;
      });
      
      var completed = liveClasses.filter(function(c) { return c.estado === 'completada'; });
      
      document.getElementById('calThisWeek').textContent = thisWeek.length;
      document.getElementById('calCompleted').textContent = completed.length;
      document.getElementById('calAvgAttendance').textContent = '‚Äî';
      
      if (liveClasses.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#64748b;padding:20px;">No hay clases programadas</div>';
        return;
      }
      
      var html = liveClasses.map(function(c) {
        var d = new Date(c.fecha);
        var dayName = d.toLocaleDateString('es-MX', { weekday: 'short', day: 'numeric', month: 'short' });
        var isPast = c.estado === 'completada';
        var isToday = d.toDateString() === now.toDateString();
        var borderColor = isToday ? '#00d4ff' : (isPast ? '#27ae60' : '#f39c12');
        var statusIcon = isPast ? '‚úÖ' : (isToday ? 'üî¥ EN VIVO' : 'üìÖ');
        
        return '<div style="display:flex;gap:12px;padding:10px;border-left:3px solid ' + borderColor + ';background:rgba(255,255,255,0.03);border-radius:0 8px 8px 0;margin:4px 0;">' +
          '<div style="min-width:70px;text-align:center;">' +
            '<div style="color:#e2e8f0;font-size:12px;font-weight:bold;">' + dayName + '</div>' +
            '<div style="color:#64748b;font-size:11px;">' + (c.hora_inicio || '') + ' - ' + (c.hora_fin || '') + '</div>' +
          '</div>' +
          '<div style="flex:1;">' +
            '<div style="color:#e2e8f0;font-size:13px;font-weight:bold;">' + (c.titulo || 'Clase HVAC') + '</div>' +
            '<div style="color:#64748b;font-size:11px;">' + statusIcon + ' | üë®‚Äçüè´ ' + (c.instructor || 'Maestro Mario') + '</div>' +
          '</div>' +
        '</div>';
      }).join('');
      
      container.innerHTML = html;
    }
    
    function renderStudentCalendar() {
      var container = document.getElementById('studentClassList');
      if (!container) return;
      
      var now = new Date();
      var upcoming = liveClasses.filter(function(c) { return new Date(c.fecha) >= new Date(now.toDateString()); });
      
      var weekEl = document.getElementById('stuCalWeek');
      if (weekEl) weekEl.textContent = 'Semana del ' + now.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
      
      if (upcoming.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#64748b;padding:30px;"><div style="font-size:30px;margin-bottom:8px;">üéâ</div><p>No hay m√°s clases esta semana.</p></div>';
        return;
      }
      
      container.innerHTML = upcoming.map(function(c) {
        var d = new Date(c.fecha);
        var isToday = d.toDateString() === now.toDateString();
        return '<div style="background:' + (isToday ? '#eff6ff' : '#f8fafc') + ';border:2px solid ' + (isToday ? '#3b82f6' : '#e2e8f0') + ';border-radius:10px;padding:12px;margin:6px 0;">' +
          '<div style="display:flex;justify-content:space-between;align-items:center;">' +
            '<div>' +
              '<div style="color:#1e293b;font-size:14px;font-weight:bold;">' + (c.titulo || 'Clase HVAC') + '</div>' +
              '<div style="color:#4b5563;font-size:12px;">üë®‚Äçüè´ ' + (c.instructor || 'Maestro Mario') + '</div>' +
            '</div>' +
            '<div style="text-align:right;">' +
              '<div style="color:' + (isToday ? '#2563eb' : '#dc2626') + ';font-size:13px;font-weight:bold;">' + d.toLocaleDateString('es-MX', { weekday: 'short', day: 'numeric', month: 'short' }) + '</div>' +
              '<div style="color:#374151;font-size:12px;font-weight:600;">' + (c.hora_inicio || '7:00 PM') + ' - ' + (c.hora_fin || '9:00 PM') + '</div>' +
            '</div>' +
          '</div>' +
          (isToday && c.zoom_link ? '<a href="' + c.zoom_link + '" target="_blank" style="display:block;margin-top:8px;padding:8px;background:#dc2626;color:white;border-radius:6px;text-align:center;font-weight:bold;font-size:13px;text-decoration:none;">üî¥ Unirse a la Clase EN VIVO</a>' : '') +
        '</div>';
      }).join('');
    }
    
    function showAddClassModal() {
      var modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
      modal.innerHTML = '<div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:15px;padding:25px;max-width:420px;width:100%;border:2px solid #00d4ff;max-height:85vh;overflow-y:auto;">' +
        '<h3 style="color:#00d4ff;margin:0 0 15px;">‚ûï Nueva Clase en Vivo</h3>' +
        '<label style="color:#94a3b8;font-size:12px;">T√≠tulo</label>' +
        '<input type="text" id="ncTitle" placeholder="Clase HVAC ‚Äî Refrigeraci√≥n" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:white;margin:4px 0 12px;box-sizing:border-box;">' +
        '<label style="color:#94a3b8;font-size:12px;">Fecha</label>' +
        '<input type="date" id="ncDate" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:white;margin:4px 0 12px;box-sizing:border-box;">' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">' +
          '<div><label style="color:#94a3b8;font-size:12px;">Hora Inicio</label><input type="time" id="ncStart" value="19:00" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:white;margin:4px 0;box-sizing:border-box;"></div>' +
          '<div><label style="color:#94a3b8;font-size:12px;">Hora Fin</label><input type="time" id="ncEnd" value="21:00" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:white;margin:4px 0;box-sizing:border-box;"></div>' +
        '</div>' +
        '<label style="color:#94a3b8;font-size:12px;">Link de Zoom (opcional)</label>' +
        '<input type="url" id="ncZoom" placeholder="https://zoom.us/j/..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:white;margin:4px 0 15px;box-sizing:border-box;">' +
        '<button onclick="saveNewClass(this)" style="width:100%;padding:12px;border:none;border-radius:8px;background:#00d4ff;color:#1a1a2e;font-weight:bold;font-size:14px;cursor:pointer;">üíæ Guardar Clase</button>' +
        '<button onclick="this.parentElement.parentElement.remove();" style="width:100%;padding:10px;border:none;border-radius:8px;background:transparent;color:#64748b;font-size:13px;cursor:pointer;margin-top:6px;">Cancelar</button>' +
      '</div>';
      document.body.appendChild(modal);
    }
    
    async function saveNewClass(btn) {
      var title = document.getElementById('ncTitle').value;
      var date = document.getElementById('ncDate').value;
      var start = document.getElementById('ncStart').value;
      var end = document.getElementById('ncEnd').value;
      var zoom = document.getElementById('ncZoom').value;
      
      if (!title || !date) { alert('Completa t√≠tulo y fecha'); return; }
      
      var newClass = {
        titulo: title,
        fecha: date + 'T' + (start || '19:00') + ':00',
        hora_inicio: start || '19:00',
        hora_fin: end || '21:00',
        instructor: 'Maestro Mario',
        tipo: 'teoria',
        zoom_link: zoom || '',
        estado: 'programada'
      };
      
      if (supabaseClient) {
        try {
          await supabaseClient.from('live_classes').insert(newClass);
        } catch(e) { console.error('[Calendario] Save error:', e); }
      }
      
      liveClasses.push(newClass);
      liveClasses.sort(function(a,b) { return new Date(a.fecha) - new Date(b.fecha); });
      renderCalendar();
      renderStudentCalendar();
      
      btn.closest('div[style*="position"]').remove();
      alert('‚úÖ Clase programada: ' + title);
    }


    // ==================== REFERRAL COMPLETION ON MEMBERSHIP ==================== 
    async function checkAndCompleteReferral(studentEmail) {
      if (!supabaseClient || !studentEmail) return;
      try {
        // Find if this student was referred
        var { data: refs } = await supabaseClient.from('referrals')
          .select('*')
          .eq('referred_email', studentEmail.toLowerCase())
          .eq('status', 'registered');
        
        if (refs && refs.length > 0) {
          var ref = refs[0];
          // Mark as completed
          await supabaseClient.from('referrals').update({
            status: 'completed',
            completed_date: new Date().toISOString()
          }).eq('id', ref.id);
          
          // Find the referrer and credit them
          var { data: referrer } = await supabaseClient.from('users')
            .select('email, nombre')
            .eq('referral_code', ref.referral_code)
            .single();
          
          if (referrer) {
            // Create a student success ticket to apply the free month
            await supabaseClient.from('student_success_tickets').insert({
              student_name: referrer.nombre || referrer.email,
              student_email: referrer.email,
              estado: 'abierto',
              descripcion: 'üí∞ [EMBAJADOR - PAGO PENDIENTE] El referido ' + ref.referred_name + ' (' + ref.referred_email + ') activ√≥ su membres√≠a pagada. PAGAR $20 USD a ' + (referrer.nombre || referrer.email) + ' via Zelle/Transferencia. C√≥digo embajador: ' + ref.referral_code + '. Verificar W-9 antes de pagar.',
              fecha_limite: new Date(Date.now() + 3 * 24*60*60*1000).toISOString(),
              email_enviado_estudiante: false
            });
            console.log('üéÅ Referral completed! Free month ticket created for ' + referrer.email);
          }
        }
      } catch(e) { console.error('[Referral Complete]', e); }
    }


    // ==================== W-9 FORM & AMBASSADOR PAYMENT ====================
    function showW9Form() {
      var modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:9999;padding:15px;';
      var userName = currentUser ? currentUser.nombre || '' : '';
      var userEmail = currentUser ? currentUser.email || '' : '';
      
      modal.innerHTML = '<div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:15px;padding:25px;max-width:450px;width:100%;border:2px solid #e74c3c;max-height:90vh;overflow-y:auto;">' +
        '<h3 style="color:#e74c3c;margin:0 0 5px;">üìã Formulario W-9</h3>' +
        '<p style="color:#94a3b8;font-size:11px;margin:0 0 15px;">Requerido por el IRS para recibir pagos del programa de embajadores</p>' +
        
        '<label style="color:#94a3b8;font-size:11px;">Nombre Legal Completo *</label>' +
        '<input type="text" id="w9Name" value="' + userName + '" placeholder="Como aparece en tu tax return" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:white;margin:4px 0 10px;box-sizing:border-box;font-size:14px;">' +
        
        '<label style="color:#94a3b8;font-size:11px;">Nombre del Negocio (si aplica)</label>' +
        '<input type="text" id="w9Business" placeholder="Nombre de tu LLC o empresa" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:white;margin:4px 0 10px;box-sizing:border-box;font-size:14px;">' +
        
        '<label style="color:#94a3b8;font-size:11px;">Tipo de Entidad *</label>' +
        '<select id="w9Entity" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:white;margin:4px 0 10px;box-sizing:border-box;font-size:14px;">' +
          '<option value="">Selecciona...</option>' +
          '<option value="individual">Individual / Sole Proprietor</option>' +
          '<option value="llc_single">LLC ‚Äî Single Member</option>' +
          '<option value="llc_multi">LLC ‚Äî Multi Member</option>' +
          '<option value="scorp">S Corporation</option>' +
          '<option value="ccorp">C Corporation</option>' +
          '<option value="partnership">Partnership</option>' +
        '</select>' +
        
        '<label style="color:#94a3b8;font-size:11px;">SSN o EIN * (√∫ltimo 4 d√≠gitos)</label>' +
        '<input type="text" id="w9TaxId" placeholder="XXXX (solo √∫ltimos 4)" maxlength="4" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:white;margin:4px 0 10px;box-sizing:border-box;font-size:14px;">' +
        
        '<label style="color:#94a3b8;font-size:11px;">Direcci√≥n *</label>' +
        '<input type="text" id="w9Address" placeholder="123 Main St" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:white;margin:4px 0 10px;box-sizing:border-box;font-size:14px;">' +
        
        '<label style="color:#94a3b8;font-size:11px;">Ciudad, Estado, ZIP *</label>' +
        '<input type="text" id="w9CityState" placeholder="San Bernardino, CA 92401" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:white;margin:4px 0 10px;box-sizing:border-box;font-size:14px;">' +
        
        '<div style="margin:10px 0;padding:10px;background:#faf5ff;border:1px solid #e9d5ff;border-radius:8px;">' +
          '<label style="color:#7c3aed;font-size:11px;font-weight:bold;">üí≥ M√©todo de Pago Preferido *</label>' +
          '<select id="w9PayMethod" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:white;margin:4px 0;box-sizing:border-box;font-size:14px;">' +
            '<option value="">Selecciona...</option>' +
            '<option value="zelle">Zelle</option>' +
            '<option value="bank_transfer">Transferencia Bancaria</option>' +
          '</select>' +
          '<label style="color:#94a3b8;font-size:11px;margin-top:6px;display:block;">Email o tel√©fono para Zelle / datos bancarios</label>' +
          '<input type="text" id="w9PayInfo" placeholder="Email de Zelle o n√∫mero de cuenta" style="width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:white;margin:4px 0;box-sizing:border-box;font-size:14px;">' +
        '</div>' +
        
        '<div style="margin:12px 0;padding:10px;background:rgba(243,156,18,0.1);border-radius:8px;">' +
          '<label style="display:flex;align-items:flex-start;gap:8px;cursor:pointer;font-size:12px;color:#e2e8f0;">' +
            '<input type="checkbox" id="w9Certify" style="margin-top:2px;width:18px;height:18px;">' +
            '<span>Bajo pena de perjurio, certifico que el n√∫mero de identificaci√≥n fiscal es correcto y que no estoy sujeto a retenci√≥n de respaldo.</span>' +
          '</label>' +
        '</div>' +
        
        '<button onclick="submitW9Form(this)" style="width:100%;padding:14px;border:none;border-radius:10px;background:linear-gradient(135deg,#27ae60,#2ecc71);color:white;font-weight:bold;font-size:15px;cursor:pointer;margin-top:5px;">‚úÖ Enviar W-9</button>' +
        '<button onclick="this.parentElement.parentElement.remove();" style="width:100%;padding:10px;border:none;border-radius:8px;background:transparent;color:#64748b;font-size:13px;cursor:pointer;margin-top:6px;">Cancelar</button>' +
      '</div>';
      document.body.appendChild(modal);
    }
    
    async function submitW9Form(btn) {
      var name = document.getElementById('w9Name').value.trim();
      var business = document.getElementById('w9Business').value.trim();
      var entity = document.getElementById('w9Entity').value;
      var taxId = document.getElementById('w9TaxId').value.trim();
      var address = document.getElementById('w9Address').value.trim();
      var cityState = document.getElementById('w9CityState').value.trim();
      var payMethod = document.getElementById('w9PayMethod').value;
      var payInfo = document.getElementById('w9PayInfo').value.trim();
      var certified = document.getElementById('w9Certify').checked;
      
      if (!name || !entity || !taxId || !address || !cityState || !payMethod || !payInfo) {
        alert('Por favor completa todos los campos marcados con *');
        return;
      }
      if (taxId.length !== 4) {
        alert('Ingresa los √∫ltimos 4 d√≠gitos de tu SSN o EIN');
        return;
      }
      if (!certified) {
        alert('Debes certificar la informaci√≥n para continuar');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Enviando...';
      
      var w9Data = {
        user_email: currentUser ? currentUser.email : '',
        user_name: name,
        business_name: business,
        entity_type: entity,
        tax_id_last4: taxId,
        address: address,
        city_state_zip: cityState,
        payment_method: payMethod,
        payment_info: payInfo,
        certified: true,
        referral_code: generateRefCode(),
        submitted_date: new Date().toISOString(),
        status: 'pending_review'
      };
      
      if (supabaseClient) {
        try {
          await supabaseClient.from('ambassador_w9').upsert(w9Data, { onConflict: 'user_email' });
          
          // Also create a Student Success ticket for admin review
          await supabaseClient.from('student_success_tickets').insert({
            student_name: name,
            student_email: currentUser ? currentUser.email : '',
            estado: 'abierto',
            descripcion: 'üìã [W-9 RECIBIDO] Nuevo embajador: ' + name + '. M√©todo de pago: ' + payMethod + ' (' + payInfo + '). C√≥digo: ' + generateRefCode() + '. REVISAR y APROBAR para activar pagos.',
            fecha_limite: new Date(Date.now() + 3 * 24*60*60*1000).toISOString(),
            email_enviado_estudiante: false
          });
          
          alert('‚úÖ Formulario W-9 enviado exitosamente.\n\nUn administrador revisar√° tu informaci√≥n y activar√° tu cuenta de embajador.');
          btn.closest('div[style*="position"]') ? btn.closest('div[style*="position"]').remove() : btn.parentElement.parentElement.remove();
          
          // Update W-9 status display
          var statusBox = document.getElementById('w9StatusBox');
          if (statusBox) {
            statusBox.innerHTML = '<div style="padding:10px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;text-align:center;">' +
              '<span style="color:#2ecc71;font-size:13px;font-weight:bold;">‚úÖ W-9 Enviado ‚Äî Pendiente de Revisi√≥n</span></div>';
          }
        } catch(e) {
          alert('Error al enviar: ' + e.message);
          btn.disabled = false;
          btn.textContent = '‚úÖ Enviar W-9';
        }
      }
    }
    
    async function checkW9Status(refCode) {
      if (!supabaseClient || !currentUser) return;
      try {
        var { data } = await supabaseClient.from('ambassador_w9').select('status').eq('user_email', currentUser.email).single();
        var statusBox = document.getElementById('w9StatusBox');
        if (data && statusBox) {
          if (data.status === 'approved') {
            statusBox.innerHTML = '<div style="padding:10px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;text-align:center;">' +
              '<span style="color:#2ecc71;font-size:13px;font-weight:bold;">‚úÖ W-9 Aprobado ‚Äî Embajador Activo</span></div>';
          } else if (data.status === 'pending_review') {
            statusBox.innerHTML = '<div style="padding:10px;background:#fffbeb;border:1px solid #fde68a;border-radius:8px;text-align:center;">' +
              '<span style="color:#f39c12;font-size:13px;font-weight:bold;">‚è≥ W-9 Enviado ‚Äî Pendiente de Revisi√≥n</span></div>';
          }
        }
      } catch(e) {}
    }


    // ==================== ADMIN: W-9 REVIEW & AMBASSADOR PAYMENTS ====================
    async function loadW9Reviews() {
      if (!supabaseClient) return;
      var container = document.getElementById('w9ReviewList');
      container.innerHTML = '<div style="text-align:center;color:#f39c12;padding:10px;">Cargando W-9...</div>';
      
      try {
        var { data: w9s } = await supabaseClient.from('ambassador_w9').select('*').order('submitted_date', { ascending: false });
        w9s = w9s || [];
        
        if (w9s.length === 0) {
          container.innerHTML = '<div style="text-align:center;color:#64748b;padding:15px;font-size:12px;">No hay formularios W-9 enviados a√∫n</div>';
          return;
        }
        
        container.innerHTML = w9s.map(function(w) {
          var statusColor = w.status === 'approved' ? '#27ae60' : (w.status === 'rejected' ? '#e74c3c' : '#f39c12');
          var statusText = w.status === 'approved' ? '‚úÖ Aprobado' : (w.status === 'rejected' ? '‚ùå Rechazado' : '‚è≥ Pendiente');
          var date = new Date(w.submitted_date).toLocaleDateString('es-MX');
          
          return '<div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;margin:4px 0;border-left:3px solid ' + statusColor + ';">' +
            '<div style="display:flex;justify-content:space-between;align-items:flex-start;">' +
              '<div>' +
                '<div style="color:#e2e8f0;font-size:13px;font-weight:bold;">' + (w.user_name || 'Sin nombre') + '</div>' +
                '<div style="color:#64748b;font-size:10px;">' + (w.user_email || '') + ' | ' + date + '</div>' +
                '<div style="color:#94a3b8;font-size:10px;margin-top:3px;">üìã ' + (w.entity_type || '') + ' | SSN: ***' + (w.tax_id_last4 || '') + ' | üí≥ ' + (w.payment_method || '') + ': ' + (w.payment_info || '') + '</div>' +
                '<div style="color:#94a3b8;font-size:10px;">üìç ' + (w.address || '') + ', ' + (w.city_state_zip || '') + '</div>' +
                '<div style="color:#7c3aed;font-size:10px;">üîó C√≥digo: ' + (w.referral_code || '') + '</div>' +
              '</div>' +
              '<div style="text-align:right;min-width:80px;">' +
                '<span style="color:' + statusColor + ';font-size:10px;font-weight:bold;">' + statusText + '</span>' +
                (w.status === 'pending_review' ? '<div style="margin-top:5px;display:flex;gap:4px;flex-wrap:wrap;justify-content:flex-end;">' +
                  '<button onclick="approveW9(\'' + w.user_email + '\')" style="background:#27ae60;color:white;border:none;padding:3px 8px;border-radius:4px;font-size:9px;cursor:pointer;">‚úÖ Aprobar</button>' +
                  '<button onclick="rejectW9(\'' + w.user_email + '\')" style="background:#e74c3c;color:white;border:none;padding:3px 8px;border-radius:4px;font-size:9px;cursor:pointer;">‚ùå Rechazar</button>' +
                '</div>' : '') +
              '</div>' +
            '</div>' +
          '</div>';
        }).join('');
      } catch(e) {
        container.innerHTML = '<div style="color:#e74c3c;padding:10px;font-size:12px;">Error: ' + e.message + '</div>';
      }
    }
    
    async function approveW9(email) {
      if (!confirm('¬øAprobar W-9 de ' + email + '? Esto activa su cuenta de embajador.')) return;
      try {
        await supabaseClient.from('ambassador_w9').update({ 
          status: 'approved', 
          approved_date: new Date().toISOString(),
          approved_by: 'admin'
        }).eq('user_email', email);
        alert('‚úÖ W-9 aprobado para ' + email);
        loadW9Reviews();
      } catch(e) { alert('Error: ' + e.message); }
    }
    
    async function rejectW9(email) {
      var reason = prompt('Raz√≥n del rechazo para ' + email + ':');
      if (!reason) return;
      try {
        await supabaseClient.from('ambassador_w9').update({ 
          status: 'rejected',
          notes: reason
        }).eq('user_email', email);
        alert('‚ùå W-9 rechazado para ' + email);
        loadW9Reviews();
      } catch(e) { alert('Error: ' + e.message); }
    }
    
    async function loadAmbassadorPayments() {
      if (!supabaseClient) return;
      var container = document.getElementById('ambassadorPaymentList');
      container.innerHTML = '<div style="text-align:center;color:#f39c12;padding:10px;">Cargando pagos...</div>';
      
      try {
        // Get all completed referrals
        var { data: refs } = await supabaseClient.from('referrals').select('*').eq('status', 'completed');
        refs = refs || [];
        
        // Get approved ambassadors
        var { data: w9s } = await supabaseClient.from('ambassador_w9').select('*').eq('status', 'approved');
        w9s = w9s || [];
        var w9Map = {};
        w9s.forEach(function(w) { w9Map[w.referral_code] = w; });
        
        // Group by ambassador
        var ambassadorRefs = {};
        refs.forEach(function(r) {
          if (!ambassadorRefs[r.referral_code]) ambassadorRefs[r.referral_code] = [];
          ambassadorRefs[r.referral_code].push(r);
        });
        
        if (Object.keys(ambassadorRefs).length === 0) {
          container.innerHTML = '<div style="text-align:center;color:#64748b;padding:15px;font-size:12px;">No hay pagos pendientes. Los pagos se generan cuando un referido activa membres√≠a.</div>';
          return;
        }
        
        var html = '';
        Object.entries(ambassadorRefs).forEach(function(entry) {
          var code = entry[0], refList = entry[1];
          var w9 = w9Map[code];
          var total = refList.length * 20;
          var paid = refList.filter(function(r) { return r.free_month_applied; }).length;
          var pending = refList.length - paid;
          var pendingAmount = pending * 20;
          
          html += '<div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;margin:4px 0;border-left:3px solid ' + (pendingAmount > 0 ? '#f39c12' : '#27ae60') + ';">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;">' +
              '<div>' +
                '<div style="color:#e2e8f0;font-size:13px;font-weight:bold;">' + (w9 ? w9.user_name : code) + '</div>' +
                '<div style="color:#64748b;font-size:10px;">' + (w9 ? w9.payment_method + ': ' + w9.payment_info : 'W-9 no aprobado') + '</div>' +
                '<div style="color:#94a3b8;font-size:10px;">' + refList.length + ' referidos | $' + total + ' total | $' + (paid * 20) + ' pagado</div>' +
              '</div>' +
              '<div style="text-align:right;">' +
                (pendingAmount > 0 ? '<div style="color:#f39c12;font-size:16px;font-weight:bold;">$' + pendingAmount + '</div>' +
                  '<button onclick="markAsPaid(\'' + code + '\')" style="background:#27ae60;color:white;border:none;padding:4px 10px;border-radius:4px;font-size:10px;cursor:pointer;margin-top:3px;">üí∞ Marcar Pagado</button>'
                : '<div style="color:#27ae60;font-size:12px;font-weight:bold;">‚úÖ Al d√≠a</div>') +
              '</div>' +
            '</div>' +
          '</div>';
        });
        
        container.innerHTML = html;
      } catch(e) {
        container.innerHTML = '<div style="color:#e74c3c;padding:10px;font-size:12px;">Error: ' + e.message + '</div>';
      }
    }
    
    async function markAsPaid(refCode) {
      if (!confirm('¬øMarcar todos los referidos de ' + refCode + ' como PAGADOS?')) return;
      try {
        await supabaseClient.from('referrals').update({ free_month_applied: true }).eq('referral_code', refCode).eq('status', 'completed');
        alert('‚úÖ Pagos marcados como completados');
        loadAmbassadorPayments();
        loadReferidosData();
      } catch(e) { alert('Error: ' + e.message); }
    }


    // ==================== #15 ANALYTICS AVANZADOS ====================
    async function loadAnalytics() {
      if (!supabaseClient) return;
      try {
        var now = new Date();
        var todayStr = now.toISOString().split('T')[0];
        var weekAgo = new Date(now - 7*24*60*60*1000).toISOString();
        
        var { data: users } = await supabaseClient.from('users').select('ultimo_acceso, nombre, email');
        users = users || [];
        
        var dau = users.filter(function(u) { return u.ultimo_acceso && u.ultimo_acceso.startsWith(todayStr); }).length;
        var wau = users.filter(function(u) { return u.ultimo_acceso && u.ultimo_acceso >= weekAgo; }).length;
        document.getElementById('anDAU').textContent = dau;
        document.getElementById('anWAU').textContent = wau;
        
        // Use allTechnicians for progress data
        var techs = allTechnicians || [];
        var totalWithProgress = 0, totalCompleted = 0, totalScore = 0, scoreCount = 0;
        var levelCounts = { principiante:0, intermedio:0, avanzado:0, elite:0, platino:0 };
        var ranked = [];
        
        techs.forEach(function(t) {
          if (!t.progress) return;
          var hasProgress = false, completedAll = true, tScore = 0, tQ = 0;
          Object.entries(t.progress).forEach(function(e) {
            var nivel = e[0], p = e[1];
            if (p.completed > 0) { hasProgress = true; totalScore += p.score; scoreCount += p.completed; tScore += p.score; tQ += p.completed; }
            if (p.total > 0 && p.completed < p.total) completedAll = false;
            if (p.completed > 0 && levelCounts.hasOwnProperty(nivel)) levelCounts[nivel]++;
          });
          if (hasProgress) totalWithProgress++;
          if (completedAll && hasProgress) totalCompleted++;
          if (tQ > 0) ranked.push({ name: t.nombre || t.email, score: tScore, quizzes: tQ, avg: Math.round(tScore/tQ*100) });
        });
        
        document.getElementById('anCompRate').textContent = (techs.length > 0 ? Math.round(totalCompleted/techs.length*100) : 0) + '%';
        document.getElementById('anAvgScore').textContent = (scoreCount > 0 ? Math.round(totalScore/scoreCount*100) : 0) + '%';
        
        // Level chart
        var maxL = Math.max(...Object.values(levelCounts), 1);
        var colors = {principiante:'#3498db',intermedio:'#27ae60',avanzado:'#f39c12',elite:'#e74c3c',platino:'#9b59b6'};
        var labs = {principiante:'Princ',intermedio:'Inter',avanzado:'Avanz',elite:'Elite',platino:'Plat'};
        var ch = '', lb = '';
        Object.entries(levelCounts).forEach(function(e) {
          var h = Math.max((e[1]/maxL)*90, 3);
          ch += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;"><div style="font-size:9px;color:#94a3b8;">' + e[1] + '</div><div style="width:100%;height:' + h + 'px;background:' + (colors[e[0]]||'#64748b') + ';border-radius:3px 3px 0 0;opacity:0.7;"></div></div>';
          lb += '<div style="flex:1;text-align:center;font-size:8px;color:#64748b;">' + (labs[e[0]]||e[0]) + '</div>';
        });
        document.getElementById('anLevelChart').innerHTML = ch;
        document.getElementById('anLevelLabels').innerHTML = lb;
        
        // Funnel
        var total = techs.length;
        var funnel = [
          {label:'Registrados',count:total,color:'#3498db'},
          {label:'Con Progreso',count:totalWithProgress,color:'#27ae60'},
          {label:'Activos 7d',count:wau,color:'#f39c12'},
          {label:'Completaron',count:totalCompleted,color:'#9b59b6'}
        ];
        document.getElementById('anFunnel').innerHTML = funnel.map(function(s) {
          var pct = total > 0 ? Math.round(s.count/total*100) : 0;
          return '<div style="margin:3px 0;"><div style="display:flex;justify-content:space-between;font-size:9px;color:#94a3b8;margin-bottom:2px;"><span>' + s.label + '</span><span>' + s.count + ' (' + pct + '%)</span></div><div style="height:14px;background:rgba(255,255,255,0.03);border-radius:3px;overflow:hidden;"><div style="height:100%;width:' + Math.max(pct,5) + '%;background:' + s.color + ';opacity:0.6;border-radius:3px;"></div></div></div>';
        }).join('');
        
        // Top 10
        ranked.sort(function(a,b) { return b.avg - a.avg; });
        document.getElementById('anTopStudents').innerHTML = ranked.slice(0,10).map(function(r,i) {
          var medal = i === 0 ? 'ü•á' : (i === 1 ? 'ü•à' : (i === 2 ? 'ü•â' : (i+1) + '.'));
          return '<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.04);"><span style="color:#e2e8f0;font-size:12px;">' + medal + ' ' + r.name + '</span><span style="color:#f39c12;font-size:11px;font-weight:bold;">' + r.avg + '%</span></div>';
        }).join('') || '<div style="text-align:center;color:#64748b;padding:10px;">Sin datos a√∫n</div>';
        
      } catch(e) { console.error('[Analytics]', e); }
    }

    // ==================== #12 REPORTES PDF MENSUALES ====================
    async function generatePDFReport() {
      if (!allTechnicians) { alert('Carga los datos primero'); return; }
      
      var techs = allTechnicians || [];
      var now = new Date();
      var monthName = now.toLocaleDateString('es-MX', { month: 'long', year: 'numeric' });
      
      // Build HTML report
      var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Reporte MaestroAC - ' + monthName + '</title>';
      html += '<style>body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:20px;color:#333;}';
      html += 'h1{color:#1a1a2e;border-bottom:3px solid #f39c12;padding-bottom:10px;}';
      html += 'h2{color:#2c3e50;margin-top:30px;}';
      html += '.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin:20px 0;}';
      html += '.stat-card{background:#f8f9fa;border-radius:10px;padding:15px;text-align:center;border:1px solid #e2e8f0;}';
      html += '.stat-card .num{font-size:28px;font-weight:bold;color:#1a1a2e;}';
      html += '.stat-card .label{font-size:11px;color:#64748b;margin-top:4px;}';
      html += 'table{width:100%;border-collapse:collapse;margin:15px 0;font-size:13px;}';
      html += 'th{background:#1a1a2e;color:white;padding:8px 12px;text-align:left;}';
      html += 'td{padding:6px 12px;border-bottom:1px solid #eee;}';
      html += 'tr:nth-child(even){background:#f8f9fa;}';
      html += '.footer{margin-top:40px;text-align:center;color:#94a3b8;font-size:11px;border-top:1px solid #eee;padding-top:15px;}';
      html += '@media print{body{padding:0;}.no-print{display:none!important;}}';
      html += '</style></head><body>';
      
      // Header
      html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
      html += '<div><h1>üìä Reporte Mensual MaestroAC</h1><p style="color:#64748b;">' + monthName.charAt(0).toUpperCase() + monthName.slice(1) + ' | ACVOLT Tech School</p></div>';
      html += '<div style="text-align:right;"><strong style="color:#f39c12;font-size:18px;">Nivel 33</strong><br><span style="color:#94a3b8;font-size:11px;">Maestro Mario</span></div>';
      html += '</div>';
      
      // Stats
      var totalStudents = techs.length;
      var withProgress = techs.filter(function(t) { return t.progress && Object.values(t.progress).some(function(p) { return p.completed > 0; }); }).length;
      var totalQuizzes = 0, totalScore = 0;
      techs.forEach(function(t) { if (t.progress) Object.values(t.progress).forEach(function(p) { totalQuizzes += p.completed; totalScore += p.score; }); });
      var avgScore = totalQuizzes > 0 ? Math.round(totalScore/totalQuizzes*100) : 0;
      
      html += '<div class="stat-grid">';
      html += '<div class="stat-card"><div class="num">' + totalStudents + '</div><div class="label">Estudiantes</div></div>';
      html += '<div class="stat-card"><div class="num">' + withProgress + '</div><div class="label">Con Progreso</div></div>';
      html += '<div class="stat-card"><div class="num">' + totalQuizzes + '</div><div class="label">Quizzes Tomados</div></div>';
      html += '<div class="stat-card"><div class="num">' + avgScore + '%</div><div class="label">Score Promedio</div></div>';
      html += '</div>';
      
      // Level distribution
      html += '<h2>üìö Distribuci√≥n por Nivel</h2>';
      html += '<table><tr><th>Nivel</th><th>Estudiantes</th><th>% del Total</th></tr>';
      var levels = {principiante:0,intermedio:0,avanzado:0,elite:0,platino:0};
      techs.forEach(function(t) { if (t.progress) Object.entries(t.progress).forEach(function(e) { if (e[1].completed > 0 && levels.hasOwnProperty(e[0])) levels[e[0]]++; }); });
      Object.entries(levels).forEach(function(e) {
        var pct = totalStudents > 0 ? Math.round(e[1]/totalStudents*100) : 0;
        html += '<tr><td style="text-transform:capitalize;">' + e[0] + '</td><td>' + e[1] + '</td><td>' + pct + '%</td></tr>';
      });
      html += '</table>';
      
      // Top 20 students
      html += '<h2>üèÜ Top 20 Estudiantes</h2>';
      html += '<table><tr><th>#</th><th>Nombre</th><th>Email</th><th>Quizzes</th><th>Score Avg</th></tr>';
      var ranked = [];
      techs.forEach(function(t) {
        if (!t.progress) return;
        var tS = 0, tQ = 0;
        Object.values(t.progress).forEach(function(p) { tS += p.score; tQ += p.completed; });
        if (tQ > 0) ranked.push({name:t.nombre||'', email:t.email||'', score:tS, q:tQ, avg:Math.round(tS/tQ*100)});
      });
      ranked.sort(function(a,b) { return b.avg - a.avg; });
      ranked.slice(0,20).forEach(function(r,i) {
        html += '<tr><td>' + (i+1) + '</td><td>' + r.name + '</td><td>' + r.email + '</td><td>' + r.q + '</td><td><strong>' + r.avg + '%</strong></td></tr>';
      });
      html += '</table>';
      
      // Footer
      html += '<div class="footer">Generado el ' + now.toLocaleDateString('es-MX', {day:'numeric',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'}) + ' | MaestroAC App | ACVOLT Tech School | maestromario.com</div>';
      
      // Print button
      html += '<div class="no-print" style="text-align:center;margin:30px 0;"><button onclick="window.print()" style="padding:12px 30px;background:#f39c12;color:#333;border:none;border-radius:8px;font-weight:bold;font-size:15px;cursor:pointer;">üñ®Ô∏è Imprimir / Guardar como PDF</button></div>';
      
      html += '</body></html>';
      
      var win = window.open('', '_blank');
      win.document.write(html);
      win.document.close();
    }

    // ==================== #14 HASH PASSWORDS ADMIN ====================
    // SHA-256 hash function (browser-native)
    async function hashPassword(password) {
      var encoder = new TextEncoder();
      var data = encoder.encode(password + '_maestroac_salt_2026');
      var hashBuffer = await crypto.subtle.digest('SHA-256', data);
      var hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
    }
    
    // Override admin login to use hashed passwords
    var _originalAdminLogin = (typeof handleAdminLogin === 'function') ? handleAdminLogin : null;
    
    async function handleAdminLoginSecure(email, password) {
      if (!supabaseClient) { alert('Sin conexi√≥n'); return false; }
      var hashedPwd = await hashPassword(password);
      
      // Try hashed password first
      var { data: admin } = await supabaseClient.from('admin_staff')
        .select('*')
        .eq('email', email.toLowerCase())
        .eq('password_hash', hashedPwd)
        .single();
      
      if (admin) return admin;
      
      // Fallback: try plain text password (for migration)
      var { data: adminPlain } = await supabaseClient.from('admin_staff')
        .select('*')
        .eq('email', email.toLowerCase())
        .eq('password', password)
        .single();
      
      if (adminPlain) {
        // Auto-migrate: hash the password and save it
        try {
          await supabaseClient.from('admin_staff').update({ 
            password_hash: hashedPwd,
            password: '***HASHED***'
          }).eq('id', adminPlain.id);
          console.log('[Security] Password hashed for ' + email);
        } catch(e) { console.log('[Hash] Migration error:', e); }
        return adminPlain;
      }
      
      return null;
    }


    // ==================== ADMIN: CERTIFICADOS ====================
    async function loadAdminCertificates() {
      if (!supabaseClient) return;
      try {
        var { data: certs } = await supabaseClient.from('certificates').select('*').order('fecha_obtenido', { ascending: false });
        certs = certs || [];
        
        var totalCerts = certs.length;
        var uniqueStudents = [...new Set(certs.map(function(c) { return c.user_id; }))].length;
        var totalStudents = (allTechnicians || []).length || 1;
        var certRate = Math.round((uniqueStudents / totalStudents) * 100);
        
        document.getElementById('acTotalCerts').textContent = totalCerts;
        document.getElementById('acStudentsWithCert').textContent = uniqueStudents;
        document.getElementById('acCertRate').textContent = certRate + '%';
        
        // By level
        var byLevel = {};
        var levelNames = {principiante:'Principiante',intermedio:'Intermedio',avanzado:'Avanzado',elite:'Elite',platino:'Platino'};
        var levelColors = {principiante:'#3498db',intermedio:'#27ae60',avanzado:'#f39c12',elite:'#e74c3c',platino:'#9b59b6'};
        certs.forEach(function(c) {
          if (!byLevel[c.nivel]) byLevel[c.nivel] = 0;
          byLevel[c.nivel]++;
        });
        
        var levelHtml = '<div style="display:flex;gap:8px;flex-wrap:wrap;">';
        Object.entries(levelNames).forEach(function(e) {
          var nivel = e[0], name = e[1];
          var count = byLevel[nivel] || 0;
          var color = levelColors[nivel] || '#64748b';
          levelHtml += '<div style="background:rgba(' + (nivel==='principiante'?'52,152,219':nivel==='intermedio'?'39,174,96':nivel==='avanzado'?'243,156,18':nivel==='elite'?'231,76,60':'155,89,182') + ',0.1);border:1px solid ' + color + '33;border-radius:8px;padding:8px 14px;text-align:center;min-width:80px;">' +
            '<div style="font-size:18px;font-weight:bold;color:' + color + ';">' + count + '</div>' +
            '<div style="font-size:9px;color:#64748b;">' + name + '</div></div>';
        });
        levelHtml += '</div>';
        document.getElementById('acByLevel').innerHTML = levelHtml;
        
        // Recent certificates
        var recentHtml = certs.slice(0, 20).map(function(c) {
          // Find user name from allTechnicians
          var userInfo = (allTechnicians || []).find(function(t) { return t.id === c.user_id; });
          var name = userInfo ? (userInfo.nombre || userInfo.email) : 'Estudiante';
          var nivel = c.nivel ? c.nivel.charAt(0).toUpperCase() + c.nivel.slice(1) : '?';
          var fecha = c.fecha_obtenido ? new Date(c.fecha_obtenido).toLocaleDateString('es-MX') : '‚Äî';
          var score = c.porcentaje || c.score || '‚Äî';
          var code = c.certificate_number || '‚Äî';
          return '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #f1f5f9;">' +
            '<div><span style="font-weight:600;color:#1e293b;">' + name + '</span><br><span style="font-size:10px;color:#94a3b8;">' + code + '</span></div>' +
            '<div style="text-align:right;"><span style="color:' + (levelColors[c.nivel]||'#64748b') + ';font-weight:600;font-size:12px;">' + nivel + '</span><br><span style="font-size:10px;color:#94a3b8;">' + fecha + ' ¬∑ ' + score + '%</span></div>' +
          '</div>';
        }).join('');
        document.getElementById('acRecentCerts').innerHTML = recentHtml || '<div style="text-align:center;padding:15px;color:#94a3b8;">Sin certificados a√∫n. Se guardan cuando un estudiante completa un nivel con 80%+</div>';
        
      } catch(e) { console.error('[Admin Certs]', e); }
    }

    // ==================== END ADMIN SECTION ====================

    // Initialize on load
    document.addEventListener('DOMContentLoaded', init);
  

    // =============== ACCESS CODE SYSTEM ===============
    
    function generateAccessCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = '';
      for (let i = 0; i < 8; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
      return code;
    }

    function validateStudentProfile(user) {
      const missing = [];
      if (!user.nombre || user.nombre.trim().length < 3) missing.push('Nombre completo');
      if (!user.email || !user.email.includes('@')) missing.push('Correo electr\u00F3nico');
      if (!user.telefono || user.telefono.trim().length < 7) missing.push('Tel\u00E9fono');
      if (!user.ciudad || user.ciudad.trim().length < 2) missing.push('Ciudad');
      if (!user.estado || user.estado.trim().length < 2) missing.push('Estado');
      return missing;
    }

    async function requestAccessCode() {
      const msgDiv = document.getElementById('accessCodeMessage');
      msgDiv.style.display = 'block';
      
      const user = JSON.parse(localStorage.getItem('tecnico_user') || '{}');
      const missing = validateStudentProfile(user);
      
      if (missing.length > 0) {
        msgDiv.style.color = '#e74c3c';
        msgDiv.innerHTML = '\u26A0\uFE0F Completa tu perfil primero:<br><strong>' + missing.join(', ') + '</strong><br><button onclick="openProfileForEdit()" style="margin-top:10px;padding:10px 20px;border-radius:10px;border:none;background:linear-gradient(135deg,#3498db,#2980b9);color:white;font-size:14px;font-weight:bold;cursor:pointer;">üë§ Ir a Completar Mi Perfil</button>';
        return;
      }
      
      // === BLOCK DUPLICATE REQUESTS ===
      try {
        const { data: existing } = await supabaseClient
          .from('access_code_requests')
          .select('id, status, code')
          .eq('student_email', user.email)
          .in('status', ['pending', 'approved'])
          .order('requested_at', { ascending: false })
          .limit(1);
        
        if (existing && existing.length > 0) {
          const prev = existing[0];
          if (prev.status === 'pending') {
            msgDiv.style.color = '#f59e0b';
            msgDiv.innerHTML = '‚è≥ Ya tienes una solicitud pendiente.<br>El administrador la revisar√° pronto. No necesitas enviar otra.';
            return;
          }
          if (prev.status === 'approved' && prev.code) {
            msgDiv.style.color = '#22c55e';
            msgDiv.innerHTML = '‚úÖ Ya tienes un c√≥digo aprobado: <strong style="font-size:18px;letter-spacing:2px;">' + prev.code + '</strong><br>Ingr√©salo arriba para activar tu acceso.';
            return;
          }
        }
      } catch(e) {
        // Also check localStorage as fallback
        const localReqs = JSON.parse(localStorage.getItem('maestroac_code_requests') || '[]');
        const localExisting = localReqs.find(r => r.student_email === user.email && (r.status === 'pending' || r.status === 'approved'));
        if (localExisting) {
          if (localExisting.status === 'pending') {
            msgDiv.style.color = '#f59e0b';
            msgDiv.innerHTML = '‚è≥ Ya tienes una solicitud pendiente. No necesitas enviar otra.';
            return;
          }
          if (localExisting.status === 'approved' && localExisting.code) {
            msgDiv.style.color = '#22c55e';
            msgDiv.innerHTML = '‚úÖ Ya tienes un c√≥digo: <strong>' + localExisting.code + '</strong>';
            return;
          }
        }
      }
      
      const request = {
        id: 'req_' + Date.now(),
        student_name: user.nombre,
        student_email: user.email,
        student_phone: user.telefono,
        student_city: user.ciudad,
        student_state: user.estado,
        tech_number: user.technicianNumber || localStorage.getItem('tecnico_number') || '',
        student_id: user.studentId || localStorage.getItem('tecnico_studentId') || '',
        status: 'pending',
        code: null,
        requested_at: new Date().toISOString()
      };
      
      try {
        const { data, error } = await supabaseClient.from('access_code_requests').insert([request]);
        if (error) throw error;
      } catch(e) {
        console.warn('Supabase save failed, using localStorage', e);
      }
      
      let requests = JSON.parse(localStorage.getItem('maestroac_code_requests') || '[]');
      requests.push(request);
      localStorage.setItem('maestroac_code_requests', JSON.stringify(requests));
      
      addNotification('\uD83D\uDCE9 Solicitud de c\u00F3digo de acceso enviada');
      msgDiv.style.color = '#27ae60';
      msgDiv.innerHTML = '\u2705 Solicitud enviada. El administrador revisar\u00E1 tu solicitud y te enviar\u00E1 un c\u00F3digo.';
    }

    async function redeemAccessCode() {
      const input = document.getElementById('accessCodeInput');
      const msgDiv = document.getElementById('accessCodeMessage');
      const code = input.value.trim().toUpperCase();
      msgDiv.style.display = 'block';
      
      if (!code || code.length < 4) {
        msgDiv.style.color = '#e74c3c';
        msgDiv.textContent = '\u26A0\uFE0F Ingresa un c\u00F3digo v\u00E1lido';
        return;
      }
      
      let valid = false;
      
      // 1. Check access_codes table (admin-created codes)
      try {
        const { data, error } = await supabaseClient
          .from('access_codes')
          .select('*')
          .eq('code', code)
          .eq('used', false)
          .eq('revoked', false)
          .single();
        
        if (data && !error) {
          valid = true;
          // Mark as used
          await supabaseClient.from('access_codes').update({ 
            email: currentUser ? currentUser.email : 'unknown',
            nombre: currentUser ? currentUser.nombre : '',
            used: true, 
            used_at: new Date().toISOString() 
          }).eq('code', code);
        }
      } catch(e) { console.log('Code not in access_codes, checking requests...'); }
      
      // 2. Check access_code_requests table (student-requested codes)
      if (!valid) {
        try {
          const { data, error } = await supabaseClient
            .from('access_code_requests')
            .select('*')
            .eq('code', code)
            .eq('status', 'approved')
            .single();
          
          if (data && !error) {
            valid = true;
            await supabaseClient.from('access_code_requests').update({ status: 'redeemed', redeemed_at: new Date().toISOString() }).eq('id', data.id);
          }
        } catch(e) { console.warn('Supabase request check failed', e); }
      }
      
      if (valid) {
        localStorage.setItem('maestroac_student_access_validated', 'true');
        localStorage.setItem('maestroac_access_code', code);
        addNotification('\uD83D\uDD13 Niveles desbloqueados con c\u00F3digo: ' + code);
        msgDiv.style.color = '#27ae60';
        msgDiv.innerHTML = '\u2705 \u00A1C\u00F3digo activado! Todos los niveles est\u00E1n desbloqueados.';
        input.value = '';
        setTimeout(() => renderLevels(), 500);
      } else {
        msgDiv.style.color = '#e74c3c';
        msgDiv.textContent = '\u274C C\u00F3digo inv\u00E1lido o ya usado. Contacta al administrador.';
      }
    }

    async function renderAccessCodes() {
      const container = document.getElementById('accessCodesList');
      if (!container) return;
      
      let requests = [];
      
      try {
        const { data, error } = await supabaseClient.from('access_code_requests').select('*').order('requested_at', { ascending: false });
        if (data && !error) requests = data;
      } catch(e) {
        console.warn('Loading from localStorage');
      }
      
      if (requests.length === 0) {
        requests = JSON.parse(localStorage.getItem('maestroac_code_requests') || '[]');
      }
      
      if (requests.length === 0) {
        container.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">No hay solicitudes de c\u00F3digos</p>';
        return;
      }
      
      let html = '<div style="display:flex;justify-content:flex-end;margin-bottom:8px;"><button onclick="verifyAllStripe()" style="background:#635bff;color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:bold;">üí≥ Verificar Todos en Stripe</button></div>';
      html += '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
      html += '<tr style="background:#2c3e50;color:white;"><th style="padding:8px;">Estudiante</th><th>Contacto</th><th>Ciudad/Estado</th><th>T\u00E9cnico #</th><th>C\u00F3digo</th><th>Stripe</th><th>Estado</th><th>Acci\u00F3n</th></tr>';
      
      requests.forEach((req, i) => {
        const statusColors = { pending: '#f39c12', approved: '#27ae60', redeemed: '#3498db', rejected: '#e74c3c' };
        const statusLabels = { pending: '\u23F3 Pendiente', approved: '\u2705 Aprobado', redeemed: '\uD83D\uDD13 Canjeado', rejected: '\u274C Rechazado' };
        const bgColor = i % 2 === 0 ? '#f8f9fa' : 'white';
        
        html += '<tr style="background:' + bgColor + ';">';
        html += '<td style="padding:8px;font-weight:bold;">' + (req.student_name || '-') + '</td>';
        html += '<td style="padding:8px;font-size:11px;">' + (req.student_email || '') + '<br>' + (req.student_phone || '') + '</td>';
        html += '<td style="padding:8px;">' + (req.student_city || '') + ', ' + (req.student_state || '') + '</td>';
        html += '<td style="padding:8px;text-align:center;">' + (req.tech_number || '-') + '</td>';
        html += '<td style="padding:8px;text-align:center;font-family:monospace;font-weight:bold;font-size:14px;color:#2c3e50;">' + (req.code || '---') + '</td>';
        html += '<td style="padding:8px;text-align:center;" id="stripe_' + i + '">';
        if (req.stripe_verified === true) {
          html += '<span style="color:#16a34a;font-weight:bold;" title="Verificado en Stripe">‚úÖ</span>';
        } else if (req.stripe_verified === false) {
          html += '<span style="color:#dc2626;" title="No encontrado en Stripe">‚ùå</span>';
        } else {
          html += '<button onclick="verifyStripeInline(' + i + ',\'' + (req.student_email || '').replace(/'/g, "\\'") + '\')" style="background:#635bff;color:white;border:none;padding:3px 8px;border-radius:5px;cursor:pointer;font-size:10px;font-weight:bold;">üîç Verificar</button>';
        }
        html += '</td>';
        html += '<td style="padding:8px;"><span style="background:' + (statusColors[req.status] || '#999') + ';color:white;padding:3px 8px;border-radius:12px;font-size:11px;">' + (statusLabels[req.status] || req.status) + '</span></td>';
        html += '<td style="padding:8px;">';
        
        if (req.status === 'pending') {
          html += '<button onclick="approveAccessCode(' + i + ')" style="background:#27ae60;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:11px;margin:2px;">\u2705 Generar</button>';
          html += '<button onclick="rejectAccessCode(' + i + ')" style="background:#e74c3c;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:11px;margin:2px;">\u274C Rechazar</button>';
        } else if (req.status === 'approved') {
          html += '<button onclick="copyCodeToClipboard(\'' + req.code + '\')" style="background:#3498db;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:11px;margin:2px;">\uD83D\uDCCB Copiar</button>';
          html += '<button onclick="showCodeSendModal(\'' + (req.student_name || '').replace(/'/g, "\\'") + '\',\'' + (req.student_email || '') + '\',\'' + (req.student_phone || '') + '\',\'' + req.code + '\')" style="background:#22c55e;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:11px;margin:2px;">üì§ Enviar</button>';
        }
        
        html += '</td></tr>';
      });
      
      html += '</table>';
      container.innerHTML = html;
    }

    // === CENTRO DE MANDO FUNCTIONS ===
    
    async function verifyAllStripe() {
      let requests = [];
      try {
        const { data } = await supabaseClient.from('access_code_requests').select('*').order('requested_at', { ascending: false });
        if (data) requests = data;
      } catch(e) { return; }
      
      // Get unique emails that haven't been verified
      const emailsToCheck = [];
      requests.forEach((req, i) => {
        if (req.student_email && req.stripe_verified === null || req.stripe_verified === undefined) {
          if (!emailsToCheck.find(e => e.email === req.student_email)) {
            emailsToCheck.push({ email: req.student_email, indices: [] });
          }
          emailsToCheck.find(e => e.email === req.student_email).indices.push(i);
        }
      });
      
      if (emailsToCheck.length === 0) {
        alert('‚úÖ Todos los t√©cnicos ya est√°n verificados.');
        return;
      }
      
      alert('üîç Verificando ' + emailsToCheck.length + ' t√©cnicos en Stripe...');
      
      for (const item of emailsToCheck) {
        // Update UI
        item.indices.forEach(i => {
          const cell = document.getElementById('stripe_' + i);
          if (cell) cell.innerHTML = '<span style="color:#635bff;font-size:10px;">‚è≥</span>';
        });
        
        const result = await verifyStripeMembership(item.email);
        
        item.indices.forEach(async (i) => {
          const cell = document.getElementById('stripe_' + i);
          if (cell) {
            if (result.active) {
              cell.innerHTML = '<span style="color:#16a34a;font-weight:bold;">‚úÖ</span>';
            } else {
              cell.innerHTML = '<span style="color:#dc2626;">‚ùå</span>';
            }
          }
          // Save to DB
          try {
            if (requests[i]) {
              await supabaseClient.from('access_code_requests').update({ stripe_verified: result.active }).eq('id', requests[i].id);
            }
          } catch(e) {}
        });
        
        // Small delay between checks to avoid rate limiting
        await new Promise(r => setTimeout(r, 500));
      }
      
      alert('‚úÖ Verificaci√≥n completa.');
    }

    async function verifyStripeInline(index, email) {
      const cell = document.getElementById('stripe_' + index);
      if (!cell) return;
      cell.innerHTML = '<span style="color:#635bff;font-size:10px;">‚è≥ Verificando...</span>';
      
      const result = await verifyStripeMembership(email);
      
      if (result.active) {
        cell.innerHTML = '<span style="color:#16a34a;font-weight:bold;" title="' + (result.plan || 'Activa') + '">‚úÖ</span><br><span style="font-size:8px;color:#16a34a;">' + (result.plan || '') + '</span>';
        // Save to Supabase
        try {
          let requests = [];
          const { data } = await supabaseClient.from('access_code_requests').select('*').order('requested_at', { ascending: false });
          if (data) requests = data;
          if (requests[index]) {
            await supabaseClient.from('access_code_requests').update({ stripe_verified: true }).eq('id', requests[index].id);
          }
        } catch(e) {}
      } else {
        cell.innerHTML = '<span style="color:#dc2626;" title="' + (result.error || 'No encontrado') + '">‚ùå</span><br><span style="font-size:8px;color:#dc2626;">No pag√≥</span>';
        try {
          let requests = [];
          const { data } = await supabaseClient.from('access_code_requests').select('*').order('requested_at', { ascending: false });
          if (data) requests = data;
          if (requests[index]) {
            await supabaseClient.from('access_code_requests').update({ stripe_verified: false }).eq('id', requests[index].id);
          }
        } catch(e) {}
      }
    }
    
    async function generateManualAccessCode() {
      const name = document.getElementById('manualCodeName').value.trim();
      const email = document.getElementById('manualCodeEmail').value.trim();
      const level = document.getElementById('manualCodeLevel').value;
      const duration = document.getElementById('manualCodeDuration').value;
      
      if (!name) { alert('Ingresa el nombre del t' + String.fromCharCode(233) + 'cnico'); return; }
      
      // Verify Stripe membership if email provided
      if (email) {
        const stripeCheck = await verifyStripeMembership(email);
        if (!stripeCheck.active) {
          const override = confirm(
            '‚ö†Ô∏è ALERTA: ' + name + ' (' + email + ') NO tiene membres√≠a activa en Stripe.\n\n' +
            (stripeCheck.error ? 'üìã ' + stripeCheck.error + '\n\n' : '') +
            '¬øGenerar c√≥digo de todas formas sin verificaci√≥n de pago?'
          );
          if (!override) return;
        } else {
          alert('‚úÖ Membres√≠a verificada en Stripe\nPlan: ' + (stripeCheck.plan || 'Activa'));
        }
      }
      
      // Generate unique code
      const prefix = level === 'full_app' ? 'FULL' : level.substring(0, 4).toUpperCase();
      const code = prefix + '-' + Math.random().toString(36).substring(2, 8).toUpperCase() + '-' + Date.now().toString(36).toUpperCase().slice(-4);
      
      // Calculate expiration
      let expiresAt = null;
      if (duration !== 'lifetime') {
        const d = new Date();
        d.setDate(d.getDate() + parseInt(duration));
        expiresAt = d.toISOString();
      }
      
      try {
        const { data, error } = await supabaseClient.from('access_code_requests').insert([{
          student_name: name,
          student_email: email || null,
          student_phone: '',
          student_city: '',
          tech_number: '',
          student_id: '',
          access_level: level,
          duration_days: duration === 'lifetime' ? 'lifetime' : duration,
          code: code,
          status: 'approved',
          requested_at: new Date().toISOString(),
          approved_at: new Date().toISOString()
        }]);
        
        if (error) throw error;
        
        // Show the generated code
        document.getElementById('generatedCodeDisplay').style.display = 'block';
        document.getElementById('generatedCodeValue').textContent = code;
        
        // Clear inputs
        document.getElementById('manualCodeName').value = '';
        document.getElementById('manualCodeEmail').value = '';
        
        // Refresh active codes list
        loadActiveCodes();
        
        // Show send modal
        showCodeSendModal(name, email, '', code);
        
        // Add notification
        if (typeof addNotification === 'function') {
          addNotification('admin', 'C' + String.fromCharCode(243) + 'digo generado para ' + name + ': ' + code);
        }
      } catch(e) {
        console.error('Error generating code:', e);
        // Fallback to localStorage
        const codes = JSON.parse(localStorage.getItem('maestroac_access_codes') || '[]');
        codes.push({ name, email, level, duration, code, status: 'approved', created: new Date().toISOString() });
        localStorage.setItem('maestroac_access_codes', JSON.stringify(codes));
        
        document.getElementById('generatedCodeDisplay').style.display = 'block';
        document.getElementById('generatedCodeValue').textContent = code;
        document.getElementById('manualCodeName').value = '';
        document.getElementById('manualCodeEmail').value = '';
        loadActiveCodes();
      }
    }

    function copyGeneratedCode() {
      const code = document.getElementById('generatedCodeValue').textContent;
      navigator.clipboard.writeText(code).then(() => {
        alert('C' + String.fromCharCode(243) + 'digo copiado: ' + code);
      }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = code;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        alert('C' + String.fromCharCode(243) + 'digo copiado: ' + code);
      });
    }

    async function loadActiveCodes() {
      const container = document.getElementById('activeCodesList');
      if (!container) return;
      
      try {
        const { data, error } = await supabase
          .from('access_code_requests')
          .select('*')
          .eq('status', 'approved')
          .order('approved_at', { ascending: false });
        
        if (error) throw error;
        
        if (!data || data.length === 0) {
          container.innerHTML = '<p style="color: #888; text-align: center;">No hay c' + String.fromCharCode(243) + 'digos activos</p>';
          return;
        }
        
        let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">';
        html += '<tr style="background: rgba(46,204,113,0.2); color: #2ecc71;">';
        html += '<th style="padding: 8px; text-align: left;">T' + String.fromCharCode(233) + 'cnico</th>';
        html += '<th style="padding: 8px; text-align: left;">C' + String.fromCharCode(243) + 'digo</th>';
        html += '<th style="padding: 8px; text-align: left;">Nivel</th>';
        html += '<th style="padding: 8px; text-align: left;">Estado</th>';
        html += '<th style="padding: 8px; text-align: left;">Fecha</th>';
        html += '<th style="padding: 8px; text-align: center;">Acci' + String.fromCharCode(243) + 'n</th>';
        html += '</tr>';
        
        data.forEach(item => {
          const levelLabel = item.access_level || 'App Completa';
          const redeemed = item.redeemed_at ? '\u2705 Canjeado' : '\u23F3 Pendiente';
          const date = new Date(item.approved_at || item.requested_at).toLocaleDateString();
          html += '<tr style="border-bottom: 1px solid #333;">';
          html += '<td style="padding: 8px; color: #fff;">' + (item.student_name || 'N/A') + '</td>';
          html += '<td style="padding: 8px; color: #2ecc71; font-family: monospace; font-weight: bold;">' + (item.code || 'N/A') + '</td>';
          html += '<td style="padding: 8px; color: #3498db;">' + levelLabel + '</td>';
          html += '<td style="padding: 8px;">' + redeemed + '</td>';
          html += '<td style="padding: 8px; color: #888;">' + date + '</td>';
          html += '<td style="padding: 8px; text-align: center;"><button onclick="revokeAccessCode(\'' + item.id + '\')" style="padding: 4px 10px; background: #e74c3c; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">Revocar</button></td>';
          html += '</tr>';
        });
        
        html += '</table></div>';
        container.innerHTML = html;
      } catch(e) {
        console.error('Error loading active codes:', e);
        // Fallback to localStorage
        const codes = JSON.parse(localStorage.getItem('maestroac_access_codes') || '[]');
        if (codes.length === 0) {
          container.innerHTML = '<p style="color: #888; text-align: center;">No hay c' + String.fromCharCode(243) + 'digos activos</p>';
        } else {
          let html = '';
          codes.forEach(c => {
            html += '<div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #333;">';
            html += '<span style="color: #fff;">' + c.name + '</span>';
            html += '<span style="color: #2ecc71; font-family: monospace;">' + c.code + '</span>';
            html += '<span style="color: #3498db;">' + (c.level || 'full_app') + '</span>';
            html += '</div>';
          });
          container.innerHTML = html;
        }
      }
    }
    // === END CENTRO DE MANDO FUNCTIONS ===

    // === STUDENT PROFILE FUNCTIONS ===

    function toggleFormula(id) {
      var el = document.getElementById(id);
      var arrow = document.getElementById(id + '_arrow');
      if (!el) return;
      if (el.style.display === 'none') {
        el.style.display = 'block';
        if (arrow) arrow.textContent = String.fromCharCode(9660);
      } else {
        el.style.display = 'none';
        if (arrow) arrow.textContent = String.fromCharCode(9654);
      }
    }

    function joinLiveClass() {
      if (currentMembership && currentMembership.activa) {
        openMembershipZone();
      } else {
        const zoomLink = localStorage.getItem('maestroac_zoom_link') || '';
        if (zoomLink) {
          window.open(zoomLink, '_blank');
        } else {
          openMembershipZone();
        }
      }
    }

    function loadStudentProgress() {
      const container = document.getElementById('studentProgressBars');
      if (!container) return;
      const levels = ['principiante', 'intermedio', 'avanzado', 'elite', 'platino'];
      const icons = {principiante: 'üîß', intermedio: 'üìä', avanzado: '‚ö°', elite: 'üèÜ', platino: 'üíé'};
      const colors = {principiante: '#2ecc71', intermedio: '#3498db', avanzado: '#e67e22', elite: '#e74c3c', platino: '#9b59b6'};
      
      let html = '';
      levels.forEach(level => {
        const email = localStorage.getItem('tecnico_email') || '';
        const key = email ? 'maestroac_progress_' + email : 'tecnico_progress';
        const prog = JSON.parse(localStorage.getItem(key) || '{}');
        const p = prog[level] || {completed: 0, total: 0, score: 0};
        const pct = p.total > 0 ? Math.round((p.completed / p.total) * 100) : 0;
        const scorePct = p.completed > 0 ? Math.round((p.score / p.completed) * 100) : 0;
        
        html += '<div style="display: flex; align-items: center; gap: 10px;">';
        html += '<span style="min-width: 100px; font-weight: bold; color: ' + colors[level] + ';">' + icons[level] + ' ' + level.charAt(0).toUpperCase() + level.slice(1) + '</span>';
        html += '<div style="flex: 1; background: #eee; border-radius: 10px; height: 20px; overflow: hidden; position: relative;">';
        html += '<div style="height: 100%; width: ' + pct + '%; background: ' + colors[level] + '; border-radius: 10px; transition: width 0.5s;"></div>';
        html += '<span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.7em; color: #333; font-weight: bold;">' + p.completed + '/' + p.total + ' (' + pct + '%)</span>';
        html += '</div>';
        html += '<span style="min-width: 50px; text-align: right; font-size: 0.8em; color: ' + (scorePct >= 80 ? '#2ecc71' : scorePct >= 60 ? '#f39c12' : '#e74c3c') + ';">' + scorePct + '% ‚úÖ</span>';
        html += '</div>';
      });
      container.innerHTML = html;
    }

    async function loadStudentTasks() {
      const container = document.getElementById('studentTasksList');
      const select = document.getElementById('taskToSubmit');
      if (!container) return;
      
      const email = localStorage.getItem('tecnico_email') || '';
      try {
        const { data, error } = await supabaseClient.from('student_tasks')
          .select('*').eq('student_email', email).order('created_at', {ascending: false});
        
        if (error) throw error;
        if (!data || data.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #aaa;">No tienes tareas asignadas</p>';
          return;
        }
        
        let html = '';
        let selectHtml = '<option value="">Seleccionar tarea...</option>';
        data.forEach(task => {
          const statusColor = task.status === 'completada' ? '#2ecc71' : task.status === 'pendiente' ? '#f39c12' : '#e74c3c';
          const statusIcon = task.status === 'completada' ? '‚úÖ' : task.status === 'pendiente' ? '‚è≥' : 'üìå';
          html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">';
          html += '<div><strong>' + (task.title || 'Tarea') + '</strong><br><span style="font-size: 0.8em; color: #888;">' + (task.description || '') + '</span></div>';
          html += '<span style="color: ' + statusColor + '; font-weight: bold; font-size: 0.85em;">' + statusIcon + ' ' + (task.status || 'pendiente') + '</span>';
          html += '</div>';
          if (task.status === 'pendiente') {
            selectHtml += '<option value="' + task.id + '">' + (task.title || 'Tarea ' + task.id) + '</option>';
          }
        });
        container.innerHTML = html;
        if (select) select.innerHTML = selectHtml;
      } catch(e) {
        container.innerHTML = '<p style="text-align: center; color: #aaa;">No tienes tareas asignadas</p>';
      }
    }

    async function submitCompletedTask() {
      const taskId = document.getElementById('taskToSubmit')?.value;
      const notes = document.getElementById('taskNotes')?.value || '';
      const fileInput = document.getElementById('taskFile');
      
      if (!taskId) { alert('Selecciona una tarea'); return; }
      
      try {
        await supabaseClient.from('student_tasks').update({
          status: 'completada',
          completed_at: new Date().toISOString(),
          student_notes: notes
        }).eq('id', taskId);
        
        alert('‚úÖ Tarea enviada exitosamente');
        document.getElementById('taskNotes').value = '';
        loadStudentTasks();
      } catch(e) {
        alert('Error al enviar tarea. Intenta de nuevo.');
      }
    }

    async function loadStudentExams() {
      const container = document.getElementById('studentExamsList');
      if (!container) return;
      const email = localStorage.getItem('tecnico_email') || '';
      if(!email){ container.innerHTML = '<p style="text-align: center; color: #aaa;">No tienes ex√°menes asignados</p>'; return; }
      try {
        const { data, error } = await supabaseClient.from('assigned_exams')
          .select('*').eq('student_email', email).order('created_at', {ascending: false});
        if (error) throw error;
        if (!data || data.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #aaa;">No tienes ex√°menes asignados</p>';
          return;
        }
        let html = '';
        data.forEach(exam => {
          const estadoColors = {pendiente:'#f39c12', completado:'#2ecc71', vencido:'#e74c3c'};
          const color = estadoColors[exam.estado] || '#94a3b8';
          html += '<div style="padding: 12px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center;">';
          html += '<div><strong>' + exam.titulo + '</strong>';
          if(exam.descripcion) html += '<br><span style="font-size:0.8em;color:#888;">' + exam.descripcion + '</span>';
          if(exam.calificacion !== null && exam.estado === 'completado') html += '<br><span style="font-size:0.9em;color:#16a34a;font-weight:bold;">Calificaci√≥n: ' + exam.calificacion + '/100</span>';
          html += '</div>';
          html += '<span style="padding:3px 10px;background:' + color + ';color:#fff;border-radius:12px;font-size:0.75em;font-weight:bold;">' + exam.estado.toUpperCase() + '</span>';
          html += '</div>';
        });
        container.innerHTML = html;
      } catch(e) {
        container.innerHTML = '<p style="text-align: center; color: #aaa;">No tienes ex√°menes asignados</p>';
      }
    }

    async function loadStudentWorkbooks() {
      const container = document.getElementById('studentWorkbooks');
      if (!container) return;
      const email = localStorage.getItem('tecnico_email') || '';
      try {
        let query = supabaseClient.from('student_books').select('*').eq('activo', true).order('created_at', {ascending: false});
        const { data, error } = await query;
        if (error) throw error;
        if (!data || data.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #aaa; grid-column: 1/-1;">No hay libros disponibles a√∫n</p>';
          return;
        }
        // Filter: show if asignado_a is 'todos' or matches student email
        const filtered = data.filter(b => b.asignado_a === 'todos' || b.asignado_a === email);
        if(filtered.length === 0){
          container.innerHTML = '<p style="text-align: center; color: #aaa; grid-column: 1/-1;">No hay libros disponibles a√∫n</p>';
          return;
        }
        let html = '';
        filtered.forEach(book => {
          html += '<div style="background: #f8f9fa; border-radius: 12px; padding: 15px; text-align: center; border: 1px solid #eee;">';
          html += '<div style="font-size: 2em; margin-bottom: 8px;">üìñ</div>';
          html += '<div style="font-weight: bold; color: #1a1a2e; font-size: 0.9em;">' + book.titulo + '</div>';
          html += '<div style="color: #888; font-size: 0.75em; margin: 4px 0;">' + (book.categoria || '') + '</div>';
          if(book.descripcion) html += '<div style="color: #aaa; font-size: 0.7em; margin: 4px 0;">' + book.descripcion + '</div>';
          html += '<a href="' + book.file_url + '" target="_blank" style="display: inline-block; margin-top: 8px; padding: 5px 12px; background: #3498db; color: #fff; border-radius: 6px; text-decoration: none; font-size: 0.8em;">üì• Descargar</a>';
          html += '</div>';
        });
        container.innerHTML = html;
      } catch(e) {
        container.innerHTML = '<p style="text-align: center; color: #aaa; grid-column: 1/-1;">No hay libros disponibles a√∫n</p>';
      }
    }

    async function loadStudentPayments() {
      const container = document.getElementById('studentPaymentRecords');
      if (!container) return;
      const email = localStorage.getItem('tecnico_email') || '';
      if(!email){ container.innerHTML = '<p style="text-align: center; color: #aaa;">No hay records de pagos</p>'; return; }
      try {
        const { data, error } = await supabaseClient.from('payment_records')
          .select('*').eq('student_email', email).order('fecha_pago', {ascending: false});
        if (error) throw error;
        if (!data || data.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #aaa;">No hay records de pagos</p>';
          return;
        }
        let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">';
        html += '<tr style="background: #f8f9fa;"><th style="padding: 8px; text-align: left;">Fecha</th><th style="padding: 8px; text-align: left;">Concepto</th><th style="padding: 8px; text-align: right;">Monto</th><th style="padding: 8px; text-align: center;">M√©todo</th></tr>';
        data.forEach(p => {
          html += '<tr style="border-bottom: 1px solid #eee;">';
          html += '<td style="padding: 8px;">' + new Date(p.fecha_pago).toLocaleDateString('es-MX') + '</td>';
          html += '<td style="padding: 8px;">' + p.concepto + '</td>';
          html += '<td style="padding: 8px; text-align: right; font-weight: bold; color: #2ecc71;">$' + parseFloat(p.monto).toFixed(2) + '</td>';
          html += '<td style="padding: 8px; text-align: center;">' + (p.metodo_pago || '') + '</td>';
          html += '</tr>';
        });
        html += '</table></div>';
        container.innerHTML = html;
      } catch(e) {
        container.innerHTML = '<p style="text-align: center; color: #aaa;">No hay records de pagos</p>';
      }
    }

    async function requestTaxForm() {
      const email = localStorage.getItem('tecnico_email') || '';
      const name = localStorage.getItem('tecnico_name') || '';
      const statusEl = document.getElementById('taxFormStatus');
      
      try {
        await supabaseClient.from('tax_form_requests').insert([{
          student_name: name,
          student_email: email,
          requested_at: new Date().toISOString(),
          status: 'pending',
          year: new Date().getFullYear()
        }]);
        
        if (statusEl) statusEl.innerHTML = '‚úÖ Solicitud enviada. Te contactaremos pronto.';
        alert('‚úÖ Solicitud de forma de taxes enviada exitosamente');
      } catch(e) {
        if (statusEl) statusEl.innerHTML = '‚úÖ Solicitud registrada.';
        alert('‚úÖ Solicitud registrada. El instructor te contactar√° pronto.');
      }
    }

    // ============================================
    // PAYMENT SYSTEM FUNCTIONS
    // ============================================
    let selectedPaymentAmount = 0;
    let selectedPaymentMethod = '';

    function setPaymentAmount(amount) {
      selectedPaymentAmount = parseFloat(amount) || 0;
      document.getElementById('paymentTotalDisplay').textContent = '$' + selectedPaymentAmount.toFixed(2);
      document.getElementById('cardPaymentAmount').textContent = selectedPaymentAmount.toFixed(2);
      document.getElementById('customPaymentAmount').value = selectedPaymentAmount;
      
      // Update button styles
      document.querySelectorAll('.payment-amount-btn').forEach(btn => {
        btn.style.background = 'rgba(255,255,255,0.2)';
        btn.style.borderColor = 'rgba(255,255,255,0.3)';
      });
    }

    function selectPaymentMethod(method) {
      selectedPaymentMethod = method;
      
      // Reset all method cards
      ['cash', 'card', 'zelle'].forEach(m => {
        const el = document.getElementById('payMethod' + m.charAt(0).toUpperCase() + m.slice(1));
        if (el) {
          el.style.background = 'rgba(255,255,255,0.1)';
          el.style.borderColor = 'rgba(255,255,255,0.2)';
          el.style.transform = 'scale(1)';
        }
      });
      
      // Highlight selected method
      const selectedEl = document.getElementById('payMethod' + method.charAt(0).toUpperCase() + method.slice(1));
      if (selectedEl) {
        selectedEl.style.background = 'rgba(255,255,255,0.3)';
        selectedEl.style.borderColor = '#fff';
        selectedEl.style.transform = 'scale(1.05)';
      }
      
      // Show instructions
      document.getElementById('paymentInstructions').style.display = 'block';
      document.getElementById('cashInstructions').style.display = method === 'cash' ? 'block' : 'none';
      document.getElementById('cardInstructions').style.display = method === 'card' ? 'block' : 'none';
      document.getElementById('zelleInstructions').style.display = method === 'zelle' ? 'block' : 'none';
      document.getElementById('paymentConfirmationMsg').style.display = 'none';
    }

    function copyZelleNumber() {
      const phone = '7147093942';
      navigator.clipboard.writeText(phone).then(() => {
        alert('‚úÖ N√∫mero copiado: (714) 709-3942');
      }).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = phone;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        alert('‚úÖ N√∫mero copiado: (714) 709-3942');
      });
    }

    async function confirmCashPayment() {
      if (selectedPaymentAmount <= 0) {
        alert('‚ö†Ô∏è Selecciona un monto a pagar');
        return;
      }
      const concept = document.getElementById('paymentConcept').value;
      if (!concept) {
        alert('‚ö†Ô∏è Selecciona el concepto del pago');
        return;
      }
      
      await registerPaymentIntent('cash', concept);
    }

    async function processCardPayment() {
      if (selectedPaymentAmount <= 0) {
        alert('‚ö†Ô∏è Selecciona un monto a pagar');
        return;
      }
      const concept = document.getElementById('paymentConcept').value;
      if (!concept) {
        alert('‚ö†Ô∏è Selecciona el concepto del pago');
        return;
      }
      
      // Register intent first
      await registerPaymentIntent('card', concept);
      
      // Redirect to Stripe payment link (you can customize this URL)
      const stripePaymentLink = 'https://buy.stripe.com/test_yourlink?amount=' + (selectedPaymentAmount * 100);
      
      // For now, show a message since Stripe link needs to be configured
      alert('üí≥ Para completar el pago con tarjeta, contacta a ACVOLT Tech School.\n\nüìß Email: techschoolacvolt@gmail.com\nüì± O visita la escuela.\n\nMonto: $' + selectedPaymentAmount.toFixed(2) + '\nConcepto: ' + concept);
    }

    async function confirmZellePayment() {
      if (selectedPaymentAmount <= 0) {
        alert('‚ö†Ô∏è Selecciona un monto a pagar');
        return;
      }
      const concept = document.getElementById('paymentConcept').value;
      if (!concept) {
        alert('‚ö†Ô∏è Selecciona el concepto del pago');
        return;
      }
      
      await registerPaymentIntent('zelle', concept);
    }

    async function registerPaymentIntent(method, concept) {
      const email = localStorage.getItem('tecnico_email') || (currentUser ? currentUser.email : '');
      const name = currentUser ? currentUser.nombre : (localStorage.getItem('tecnico_name') || 'Unknown');
      const techNumber = localStorage.getItem('tecnico_number') || '';
      
      const paymentData = {
        student_name: name,
        student_email: email,
        technician_number: techNumber,
        amount: selectedPaymentAmount,
        concept: concept,
        payment_method: method,
        status: method === 'card' ? 'pending_payment' : 'pending_verification',
        created_at: new Date().toISOString()
      };
      
      try {
        if (supabaseClient && isOnline) {
          await supabaseClient.from('payment_intents').insert([paymentData]);
        }
      } catch(e) {
        console.log('Payment intent saved locally:', e);
      }
      
      // Store locally as backup
      const localPayments = JSON.parse(localStorage.getItem('maestroac_payment_intents') || '[]');
      localPayments.push(paymentData);
      localStorage.setItem('maestroac_payment_intents', JSON.stringify(localPayments));
      
      // Show confirmation
      showPaymentConfirmation(method, concept);
      
      // Send notification to admin (if function exists)
      if (typeof addNotification === 'function') {
        addNotification('admin', 'üí∞ Nueva solicitud de pago: $' + selectedPaymentAmount.toFixed(2) + ' (' + method + ') de ' + name);
      }
    }

    function showPaymentConfirmation(method, concept) {
      document.getElementById('paymentInstructions').style.display = 'none';
      document.getElementById('paymentConfirmationMsg').style.display = 'block';
      
      let message = '';
      switch(method) {
        case 'cash':
          message = 'Tu intenci√≥n de pago en <strong>efectivo</strong> ha sido registrada.<br><br>Monto: <strong>$' + selectedPaymentAmount.toFixed(2) + '</strong><br>Concepto: <strong>' + concept + '</strong><br><br>Visita nuestra oficina para completar el pago.';
          break;
        case 'card':
          message = 'Tu solicitud de pago con <strong>tarjeta</strong> ha sido registrada.<br><br>Monto: <strong>$' + selectedPaymentAmount.toFixed(2) + '</strong><br>Concepto: <strong>' + concept + '</strong><br><br>Te contactaremos para procesar el pago.';
          break;
        case 'zelle':
          message = 'Tu pago por <strong>Zelle</strong> ha sido registrado para verificaci√≥n.<br><br>Monto: <strong>$' + selectedPaymentAmount.toFixed(2) + '</strong><br>Concepto: <strong>' + concept + '</strong><br><br>La verificaci√≥n toma 24-48 horas h√°biles.';
          break;
      }
      
      document.getElementById('paymentConfirmationText').innerHTML = message;
      
      // Refresh payment records
      if (typeof loadStudentPayments === 'function') {
        setTimeout(loadStudentPayments, 1000);
      }
    }
    // ============================================
    // END PAYMENT SYSTEM FUNCTIONS
    // ============================================

    // ============================================
    // ADMIN INBOX - BANDEJA DE ENTRADA
    // ============================================
    let adminInboxItems = [];
    let currentInboxFilter = 'all';

    async function loadAdminInbox() {
      const container = document.getElementById('adminInboxList');
      if (!container) return;
      
      container.innerHTML = '<div style="color: #f39c12; text-align: center; padding: 20px;">‚è≥ Cargando...</div>';
      adminInboxItems = [];
      
      try {
        // 1. Cargar TAREAS ENVIADAS
        if (supabaseClient && isOnline) {
          try {
            const { data: tareas } = await supabaseClient
              .from('submitted_tasks')
              .select('*')
              .order('submitted_at', { ascending: false });
            if (tareas) {
              tareas.forEach(t => {
                adminInboxItems.push({
                  type: 'tareas',
                  icon: 'üìù',
                  title: 'Tarea Enviada',
                  subtitle: t.task_type || 'Documento',
                  student: t.student_name || 'Estudiante',
                  email: t.student_email || '',
                  date: t.submitted_at,
                  status: t.status || 'pending',
                  notes: t.notes || '',
                  file: t.file_url || null,
                  id: t.id,
                  raw: t
                });
              });
            }
          } catch(e) { console.log('No tasks table:', e); }
          
          // 2. Cargar SOLICITUDES DE PAGO
          try {
            const { data: pagos } = await supabaseClient
              .from('payment_intents')
              .select('*')
              .order('created_at', { ascending: false });
            if (pagos) {
              pagos.forEach(p => {
                adminInboxItems.push({
                  type: 'pagos',
                  icon: 'üí∞',
                  title: 'Solicitud de Pago',
                  subtitle: '$' + (p.amount || 0).toFixed(2) + ' - ' + (p.payment_method || 'N/A').toUpperCase(),
                  student: p.student_name || 'Estudiante',
                  email: p.student_email || '',
                  date: p.created_at,
                  status: p.status || 'pending',
                  notes: 'Concepto: ' + (p.concept || 'No especificado'),
                  id: p.id,
                  raw: p
                });
              });
            }
          } catch(e) { console.log('No payments table:', e); }
          
          // 3. Cargar SOLICITUDES DE TAXES
          try {
            const { data: taxes } = await supabaseClient
              .from('tax_form_requests')
              .select('*')
              .order('requested_at', { ascending: false });
            if (taxes) {
              taxes.forEach(t => {
                adminInboxItems.push({
                  type: 'taxes',
                  icon: 'üìÑ',
                  title: 'Solicitud Forma de Taxes',
                  subtitle: 'A√±o ' + (t.year || new Date().getFullYear()),
                  student: t.student_name || 'Estudiante',
                  email: t.student_email || '',
                  date: t.requested_at,
                  status: t.status || 'pending',
                  id: t.id,
                  raw: t
                });
              });
            }
          } catch(e) { console.log('No taxes table:', e); }
          
          // 4. Cargar SOLICITUDES DE RENOVACI√ìN
          try {
            const { data: renovaciones } = await supabaseClient
              .from('cert_renewal_requests')
              .select('*')
              .order('requested_at', { ascending: false });
            if (renovaciones) {
              renovaciones.forEach(r => {
                adminInboxItems.push({
                  type: 'renovaciones',
                  icon: 'üèÖ',
                  title: 'Solicitud de Renovaci√≥n',
                  subtitle: r.cert_type || 'Certificaci√≥n',
                  student: r.student_name || 'Estudiante',
                  email: r.student_email || '',
                  date: r.requested_at,
                  status: r.status || 'pending',
                  id: r.id,
                  raw: r
                });
              });
            }
          } catch(e) { console.log('No renewals table:', e); }
        }
        
        // Tambi√©n cargar de localStorage como backup
        const localPayments = JSON.parse(localStorage.getItem('maestroac_payment_intents') || '[]');
        localPayments.forEach(p => {
          if (!adminInboxItems.find(i => i.type === 'pagos' && i.raw && i.raw.created_at === p.created_at)) {
            adminInboxItems.push({
              type: 'pagos',
              icon: 'üí∞',
              title: 'Solicitud de Pago (Local)',
              subtitle: '$' + (p.amount || 0).toFixed(2) + ' - ' + (p.payment_method || 'N/A').toUpperCase(),
              student: p.student_name || 'Estudiante',
              email: p.student_email || '',
              date: p.created_at,
              status: p.status || 'pending',
              notes: 'Concepto: ' + (p.concept || 'No especificado'),
              raw: p
            });
          }
        });
        
        // Ordenar por fecha (m√°s reciente primero)
        adminInboxItems.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // Actualizar contadores
        updateInboxCounts();
        
        // Renderizar
        renderInboxItems();
        
      } catch(e) {
        console.error('Error loading inbox:', e);
        container.innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 20px;">‚ùå Error cargando datos</div>';
      }
    }

    function updateInboxCounts() {
      const counts = {
        tareas: adminInboxItems.filter(i => i.type === 'tareas').length,
        pagos: adminInboxItems.filter(i => i.type === 'pagos').length,
        taxes: adminInboxItems.filter(i => i.type === 'taxes').length,
        renovaciones: adminInboxItems.filter(i => i.type === 'renovaciones').length
      };
      
      document.getElementById('countTareas').textContent = counts.tareas;
      document.getElementById('countPagos').textContent = counts.pagos;
      document.getElementById('countTaxes').textContent = counts.taxes;
      document.getElementById('countRenovaciones').textContent = counts.renovaciones;
      
      const total = counts.tareas + counts.pagos + counts.taxes + counts.renovaciones;
      const pendingCount = adminInboxItems.filter(i => i.status === 'pending' || i.status === 'pending_verification').length;
      document.getElementById('inboxTotalCount').textContent = pendingCount + ' pendientes';
    }

    function filterInbox(filter) {
      currentInboxFilter = filter;
      
      // Update button styles
      document.querySelectorAll('.inbox-filter-btn').forEach(btn => {
        btn.style.background = 'rgba(255,255,255,0.1)';
        btn.style.color = '#fff';
      });
      const activeBtn = document.getElementById('inboxFilter' + filter.charAt(0).toUpperCase() + filter.slice(1));
      if (activeBtn) {
        activeBtn.style.background = '#f39c12';
        activeBtn.style.color = '#000';
      }
      
      renderInboxItems();
    }

    function renderInboxItems() {
      const container = document.getElementById('adminInboxList');
      if (!container) return;
      
      let items = adminInboxItems;
      if (currentInboxFilter !== 'all') {
        items = adminInboxItems.filter(i => i.type === currentInboxFilter);
      }
      
      if (items.length === 0) {
        container.innerHTML = '<div style="color: #888; text-align: center; padding: 40px;"><div style="font-size: 3em; margin-bottom: 15px;">üì≠</div><p>No hay items en esta categor√≠a</p></div>';
        return;
      }
      
      let html = '';
      items.forEach((item, idx) => {
        const statusColor = item.status === 'pending' || item.status === 'pending_verification' ? '#e74c3c' : '#2ecc71';
        const statusText = item.status === 'pending' || item.status === 'pending_verification' ? '‚è≥ Pendiente' : '‚úÖ Atendido';
        const dateStr = item.date ? new Date(item.date).toLocaleString('es-MX', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A';
        
        html += `
          <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px; margin-bottom: 10px; border-left: 4px solid ${statusColor};">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 200px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                  <span style="font-size: 1.5em;">${item.icon}</span>
                  <div>
                    <div style="color: #fff; font-weight: bold;">${item.title}</div>
                    <div style="color: #f39c12; font-size: 0.85em;">${item.subtitle}</div>
                  </div>
                </div>
                <div style="color: #aaa; font-size: 0.85em; margin-bottom: 5px;">
                  üë§ <strong>${item.student}</strong> ${item.email ? '| üìß ' + item.email : ''}
                </div>
                ${item.notes ? '<div style="color: #888; font-size: 0.8em; margin-top: 5px;">üìù ' + item.notes + '</div>' : ''}
              </div>
              <div style="text-align: right; min-width: 120px;">
                <div style="color: ${statusColor}; font-size: 0.85em; font-weight: bold; margin-bottom: 5px;">${statusText}</div>
                <div style="color: #666; font-size: 0.75em;">${dateStr}</div>
                <div style="margin-top: 10px; display: flex; gap: 5px; justify-content: flex-end; flex-wrap: wrap;">
                  ${item.status === 'pending' || item.status === 'pending_verification' ? 
                    `<button onclick="markItemAsAttended('${item.type}', '${item.id}')" style="padding: 5px 10px; background: #2ecc71; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75em;">‚úÖ Atender</button>` : ''}
                  ${item.email ? `<button onclick="contactStudent('${item.email}', '${item.student}')" style="padding: 5px 10px; background: #3498db; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75em;">üìß Contactar</button>` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    async function markItemAsAttended(type, id) {
      if (!id) {
        alert('Item marcado como atendido');
        return;
      }
      
      try {
        let tableName = '';
        let statusField = 'status';
        
        switch(type) {
          case 'tareas': tableName = 'submitted_tasks'; break;
          case 'pagos': tableName = 'payment_intents'; break;
          case 'taxes': tableName = 'tax_form_requests'; break;
          case 'renovaciones': tableName = 'cert_renewal_requests'; break;
        }
        
        if (tableName && supabaseClient && isOnline) {
          await supabaseClient.from(tableName).update({ status: 'attended' }).eq('id', id);
        }
        
        // Update local state
        const item = adminInboxItems.find(i => i.id === id);
        if (item) item.status = 'attended';
        
        updateInboxCounts();
        renderInboxItems();
        
        alert('‚úÖ Marcado como atendido');
      } catch(e) {
        console.error('Error updating status:', e);
        alert('‚úÖ Marcado como atendido (local)');
      }
    }

    function contactStudent(email, name) {
      const subject = encodeURIComponent('ACVOLT Tech School - Seguimiento');
      const body = encodeURIComponent('Hola ' + name + ',\n\nGracias por tu solicitud. Te contactamos respecto a...\n\nSaludos,\nMaestro Mario\nACVOLT Tech School');
      openEmailComposer(email, decodeURIComponent(subject), decodeURIComponent(body), 'üìß Contactar Estudiante');
    }

    function markAllAsRead() {
      adminInboxItems.forEach(item => {
        item.status = 'attended';
      });
      updateInboxCounts();
      renderInboxItems();
      alert('‚úÖ Todos los items marcados como atendidos');
    }

    function exportInboxToCSV() {
      let csv = 'Tipo,Titulo,Estudiante,Email,Fecha,Estado,Notas\n';
      
      adminInboxItems.forEach(item => {
        csv += `"${item.type}","${item.title} - ${item.subtitle}","${item.student}","${item.email || ''}","${item.date || ''}","${item.status}","${item.notes || ''}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'bandeja_entrada_' + new Date().toISOString().slice(0,10) + '.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    // ============================================
    // END ADMIN INBOX
    // ============================================

    async function requestCertRenewal(certType) {
      const email = localStorage.getItem('tecnico_email') || '';
      const name = localStorage.getItem('tecnico_name') || '';
      
      try {
        await supabaseClient.from('cert_renewal_requests').insert([{
          student_name: name,
          student_email: email,
          cert_type: certType,
          requested_at: new Date().toISOString(),
          status: 'pending'
        }]);
        alert('‚úÖ Solicitud de renovaci√≥n ' + certType + ' enviada');
      } catch(e) {
        alert('‚úÖ Solicitud de renovaci√≥n ' + certType + ' registrada. Te contactaremos pronto.');
      }
    }

    // Auto-load profile data when profile screen opens
    function loadProfileData() {
      // Cargar datos del estudiante de localStorage primero para asegurar persistencia
      if (!currentUser || !currentUser.technicianNumber) {
        try {
          var saved = JSON.parse(localStorage.getItem('tecnico_user') || '{}');
          if (!saved.technicianNumber) {
            saved = JSON.parse(localStorage.getItem('tecnico_user_backup') || '{}');
          }
          if (saved && currentUser) {
            if (saved.technicianNumber) {
              currentUser.technicianNumber = saved.technicianNumber;
              currentUser.technicianNumberDate = saved.technicianNumberDate;
            }
            if (saved.studentId) {
              currentUser.studentId = saved.studentId;
              currentUser.studentIdDate = saved.studentIdDate;
            }
          }
        } catch(e) { console.log('Error loading saved user data:', e); }
      }
      
      // Actualizar display del n√∫mero de t√©cnico
      try { updateTechnicianNumberDisplay(); } catch(e) {}
      
      // Cargar foto de perfil
      try { loadProfilePhoto(); } catch(e) {}
      
      // Cargar credencial de estudiante
      try { renderStudentCredential(); } catch(e) {}
      
      // Cargar dem√°s datos
      try { loadStudentProgress(); } catch(e) {}
      try { loadStudentTasks(); } catch(e) {}
      try { loadStudentExams(); } catch(e) {}
      try { loadStudentWorkbooks(); } catch(e) {}
      try { loadStudentPayments(); } catch(e) {}
    }
    
    // Funci√≥n para cargar foto de perfil
    function loadProfilePhoto() {
      if (!currentUser) return;
      
      // Intentar m√∫ltiples keys para encontrar la foto
      var emailKey = currentUser.email || localStorage.getItem('tecnico_email') || localStorage.getItem('maestroac_email') || 'default';
      var photo = localStorage.getItem('maestroac_photo_' + emailKey);
      
      // Si no se encuentra, intentar con otras variantes
      if (!photo) {
        photo = localStorage.getItem('maestroac_photo_' + (currentUser.email || ''));
      }
      if (!photo) {
        photo = localStorage.getItem('maestroac_photo_default');
      }
      
      // Tambi√©n guardar el email actual para uso consistente
      if (currentUser.email) {
        localStorage.setItem('maestroac_email', currentUser.email);
        localStorage.setItem('tecnico_email', currentUser.email);
      }
      
      var img = document.getElementById('profilePhotoImg');
      if (photo && img) {
        img.src = photo;
        img.style.display = 'block';
      }
    }

    // === END STUDENT PROFILE FUNCTIONS ===



    // === VERIFY STRIPE PAYMENT BEFORE GENERATING CODE ===
    // Checks for ANY active payment: Membres√≠a ($119/$299/$699) OR App Access ($20/mes, $240/a√±o)
    async function verifyStripeMembership(email) {
      if (!email) return { active: false, plan: null, error: 'No email provided' };
      
      try {
        // Try specific subscription check first
        const response = await fetch(SUPABASE_URL + '/functions/v1/get-stripe-data', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + SUPABASE_KEY
          },
          body: JSON.stringify({ action: 'check_subscription', email: email })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.active || data.has_subscription) {
            return { active: true, plan: data.plan || data.product || 'Suscripci√≥n Activa', type: data.type || 'subscription' };
          }
        }
        
        // Fallback: fetch all Stripe data and search by email
        const fallback = await fetch(SUPABASE_URL + '/functions/v1/get-stripe-data', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + SUPABASE_KEY
          },
          body: JSON.stringify({ action: 'get_data' })
        });
        
        if (fallback.ok) {
          const data = await fallback.json();
          
          // Check active subscriptions (membres√≠as + app access)
          const subs = data.subscriptions || data.active_subscriptions || [];
          const activeSubs = Array.isArray(subs) ? subs : [];
          const subMatch = activeSubs.find(s => {
            const subEmail = (s.customer_email || s.email || (s.customer && s.customer.email) || '').toLowerCase();
            return subEmail === email.toLowerCase();
          });
          
          if (subMatch) {
            // Determine plan type by amount
            const amount = subMatch.amount || subMatch.plan_amount || 0;
            const amountUsd = amount > 100 ? amount / 100 : amount; // cents to dollars
            let planName = 'Suscripci√≥n Activa';
            if (amountUsd >= 600) planName = 'üëë Mentor√≠a $699/mes';
            else if (amountUsd >= 250) planName = 'ü•à Intermedio $299/mes';
            else if (amountUsd >= 200) planName = 'üí∞ App Anual $240/a√±o';
            else if (amountUsd >= 100) planName = 'ü•â Principiante $119/mes';
            else if (amountUsd >= 15) planName = 'üì± App Mensual $20/mes';
            
            return { active: true, plan: planName, type: 'subscription' };
          }
          
          // Check one-time payments (e.g., $240 annual)
          const charges = data.charges || data.payments || [];
          const chargeList = Array.isArray(charges) ? charges : [];
          const recentPayment = chargeList.find(c => {
            const cEmail = (c.customer_email || c.email || c.receipt_email || '').toLowerCase();
            const paid = c.paid || c.status === 'succeeded' || c.status === 'paid';
            return cEmail === email.toLowerCase() && paid;
          });
          
          if (recentPayment) {
            return { active: true, plan: 'Pago verificado', type: 'one_time' };
          }
        }
        
        return { active: false, plan: null, error: 'No se encontr√≥ pago activo ($20/mes, $240/a√±o, o Membres√≠a)' };
      } catch(e) {
        console.warn('[Stripe Check]', e);
        return { active: false, plan: null, error: 'Error conectando con Stripe: ' + e.message };
      }
    }

    async function approveAccessCode(index) {
      let requests = [];
      try {
        const { data } = await supabaseClient.from('access_code_requests').select('*').order('requested_at', { ascending: false });
        if (data) requests = data;
      } catch(e) {}
      
      if (requests.length === 0) {
        requests = JSON.parse(localStorage.getItem('maestroac_code_requests') || '[]');
      }
      
      if (requests[index]) {
        const studentEmail = requests[index].student_email;
        
        // Verify Stripe membership
        const stripeCheck = await verifyStripeMembership(studentEmail);
        
        if (!stripeCheck.active) {
          const override = confirm(
            '‚ö†Ô∏è ALERTA: ' + (requests[index].student_name || studentEmail) + ' NO tiene membres√≠a activa en Stripe.\n\n' +
            (stripeCheck.error ? 'üìã ' + stripeCheck.error + '\n\n' : '') +
            '¬øDeseas generar el c√≥digo de todas formas?\n\n' +
            '‚Ä¢ S√ç = Generar c√≥digo manualmente (sin verificaci√≥n de pago)\n' +
            '‚Ä¢ NO = Cancelar y pedir que pague primero'
          );
          if (!override) return;
        } else {
          // Confirmed active ‚Äî show plan info
          alert('‚úÖ Membres√≠a verificada en Stripe\n\nPlan: ' + (stripeCheck.plan || 'Activa') + '\nEstudiante: ' + (requests[index].student_name || studentEmail) + '\n\nGenerando c√≥digo...');
        }

        const code = generateAccessCode();
        requests[index].status = 'approved';
        requests[index].code = code;
        requests[index].approved_at = new Date().toISOString();
        requests[index].stripe_verified = stripeCheck.active;
        
        try {
          await supabaseClient.from('access_code_requests').update({ 
            status: 'approved', code: code, approved_at: new Date().toISOString(),
            stripe_verified: stripeCheck.active
          }).eq('id', requests[index].id);
        } catch(e) {}
        
        localStorage.setItem('maestroac_code_requests', JSON.stringify(requests));
        renderAccessCodes();
        
        var req = requests[index];
        var name = req.student_name || 'Estudiante';
        var email = req.student_email || '';
        var phone = req.student_phone || '';
        
        showCodeSendModal(name, email, phone, code);
      }
    }

    function showCodeSendModal(name, email, phone, code) {
      // Remove existing modal
      var existing = document.getElementById('codeSendModal');
      if (existing) existing.remove();
      
      var emailSubject = encodeURIComponent('üéì Tu C√≥digo de Acceso - ACVOLT Tech School');
      var emailBody = encodeURIComponent(
        'Hola ' + name + ',\n\n' +
        '¬°Tu c√≥digo de acceso para MaestroAC ha sido aprobado! üéâ\n\n' +
        'üîë TU C√ìDIGO: ' + code + '\n\n' +
        'Para activarlo:\n' +
        '1. Abre la app MaestroAC en maestromario.com\n' +
        '2. Inicia sesi√≥n con tu cuenta\n' +
        '3. Ve a "Canjear C√≥digo" en el men√∫\n' +
        '4. Ingresa tu c√≥digo: ' + code + '\n\n' +
        '¬°√âxito en tu camino de certificaci√≥n HVAC!\n\n' +
        'Maestro Mario\n' +
        'ACVOLT Tech School\n' +
        'www.maestromario.com'
      );
      
      var waMsg = encodeURIComponent(
        'üéì *ACVOLT Tech School*\n\n' +
        'Hola ' + name + ', tu c√≥digo de acceso est√° listo:\n\n' +
        'üîë *' + code + '*\n\n' +
        'Para activarlo:\n' +
        '1Ô∏è‚É£ Abre maestromario.com\n' +
        '2Ô∏è‚É£ Inicia sesi√≥n\n' +
        '3Ô∏è‚É£ Ve a "Canjear C√≥digo"\n' +
        '4Ô∏è‚É£ Ingresa: *' + code + '*\n\n' +
        '¬°√âxito! üí™üî•'
      );
      
      // Clean phone for WhatsApp (remove spaces, dashes, parentheses)
      var cleanPhone = phone.replace(/[\s\-\(\)\+]/g, '');
      if (cleanPhone && !cleanPhone.startsWith('1') && cleanPhone.length === 10) cleanPhone = '1' + cleanPhone;
      
      var modal = document.createElement('div');
      modal.id = 'codeSendModal';
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;';
      modal.innerHTML = 
        '<div style="background:white;border-radius:20px;padding:30px;max-width:480px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">' +
          '<div style="text-align:center;margin-bottom:20px;">' +
            '<div style="font-size:48px;margin-bottom:10px;">‚úÖ</div>' +
            '<h2 style="color:#1e293b;margin:0 0 5px;">C√≥digo Generado</h2>' +
            '<p style="color:#64748b;font-size:14px;margin:0;">Para: <strong>' + name + '</strong></p>' +
          '</div>' +
          
          '<div style="background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:2px solid #22c55e;border-radius:12px;padding:15px;text-align:center;margin-bottom:20px;">' +
            '<div style="color:#64748b;font-size:12px;margin-bottom:4px;">C√ìDIGO DE ACCESO</div>' +
            '<div style="font-size:28px;font-weight:bold;letter-spacing:4px;color:#16a34a;font-family:monospace;">' + code + '</div>' +
            '<button onclick="navigator.clipboard.writeText(\'' + code + '\');this.textContent=\'‚úÖ Copiado!\';setTimeout(()=>this.textContent=\'üìã Copiar C√≥digo\',2000)" style="margin-top:8px;background:#22c55e;color:white;border:none;padding:6px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:bold;">üìã Copiar C√≥digo</button>' +
          '</div>' +
          
          '<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:15px;">' +
            '<div style="color:#64748b;font-size:12px;font-weight:bold;text-align:center;">üì§ ENVIAR AL ESTUDIANTE</div>' +
            
            // Email button
            (email ? 
              '<a href="javascript:void(0)" onclick="openEmailComposer(\'' + email + '\',decodeURIComponent(\'' + emailSubject + '\'),decodeURIComponent(\'' + emailBody + '\'),\'üìß Enviar C√≥digo\')" style="display:flex;align-items:center;gap:12px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;text-decoration:none;padding:14px 20px;border-radius:12px;font-weight:bold;font-size:14px;cursor:pointer;">' +
                '<span style="font-size:24px;">üìß</span>' +
                '<div><div>Enviar por Email</div><div style="font-size:11px;opacity:0.8;font-weight:normal;">' + email + '</div></div>' +
              '</a>' : 
              '<div style="background:#f1f5f9;padding:14px 20px;border-radius:12px;color:#94a3b8;text-align:center;font-size:13px;">üìß Sin email registrado</div>') +
            
            // WhatsApp button
            (cleanPhone ? 
              '<a href="https://wa.me/' + cleanPhone + '?text=' + waMsg + '" target="_blank" style="display:flex;align-items:center;gap:12px;background:linear-gradient(135deg,#25D366,#128C7E);color:white;text-decoration:none;padding:14px 20px;border-radius:12px;font-weight:bold;font-size:14px;">' +
                '<span style="font-size:24px;">üí¨</span>' +
                '<div><div>Enviar por WhatsApp</div><div style="font-size:11px;opacity:0.8;font-weight:normal;">' + phone + '</div></div>' +
              '</a>' : 
              '<div style="background:#f1f5f9;padding:14px 20px;border-radius:12px;color:#94a3b8;text-align:center;font-size:13px;">üí¨ Sin tel√©fono registrado</div>') +
            
            // SMS button
            (cleanPhone ? 
              '<a href="sms:' + cleanPhone + '?body=' + encodeURIComponent('ACVOLT Tech School - Tu c√≥digo de acceso: ' + code + ' | Act√≠valo en maestromario.com') + '" style="display:flex;align-items:center;gap:12px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;text-decoration:none;padding:14px 20px;border-radius:12px;font-weight:bold;font-size:14px;">' +
                '<span style="font-size:24px;">üí¨</span>' +
                '<div><div>Enviar por SMS</div><div style="font-size:11px;opacity:0.8;font-weight:normal;">' + phone + '</div></div>' +
              '</a>' : '') +
          '</div>' +
          
          '<button onclick="document.getElementById(\'codeSendModal\').remove()" style="width:100%;padding:12px;background:#f1f5f9;color:#475569;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:bold;">‚úì Listo</button>' +
        '</div>';
      
      document.body.appendChild(modal);
      // Close on backdrop click
      modal.addEventListener('click', function(e) { if (e.target === modal) modal.remove(); });
    }

    async function rejectAccessCode(index) {
      let requests = [];
      try {
        const { data } = await supabaseClient.from('access_code_requests').select('*').order('requested_at', { ascending: false });
        if (data) requests = data;
      } catch(e) {}
      
      if (requests.length === 0) {
        requests = JSON.parse(localStorage.getItem('maestroac_code_requests') || '[]');
      }
      
      if (requests[index]) {
        requests[index].status = 'rejected';
        
        try {
          await supabaseClient.from('access_code_requests').update({ status: 'rejected' }).eq('id', requests[index].id);
        } catch(e) {}
        
        localStorage.setItem('maestroac_code_requests', JSON.stringify(requests));
        renderAccessCodes();
      }
    }

    function copyCodeToClipboard(code) {
      navigator.clipboard.writeText(code).then(() => {
        alert('C\u00F3digo copiado: ' + code);
      }).catch(() => {
        prompt('Copia este c\u00F3digo:', code);
      });
    }

    // =============== END ACCESS CODE SYSTEM ===============
</script>
    <!-- Printable Certificate -->
    <div id="printableCertificate" class="printable-certificate">
      <div class="cert-header">
        <img src="logo.png" alt="ACVOLT Technical School" class="cert-logo">
        <div class="cert-school-name">ACVOLT TECHNICAL SCHOOL</div>
        <div class="cert-subtitle">HVAC TRAINING ACADEMY ‚Ä¢ SAN BERNARDINO, CA</div>
      </div>
      
      <div class="cert-body">
        <div class="cert-title">CERTIFICADO</div>
        <div class="cert-level-badge" id="certLevelBadge">NIVEL PRINCIPIANTE</div>
        <div class="cert-recipient">Se otorga el presente certificado a:</div>
        <div class="cert-recipient-name" id="certRecipientName">Nombre del T√©cnico</div>
        <div class="cert-description">
          Por haber completado satisfactoriamente el programa de evaluaci√≥n t√©cnica 
          de nivel <span id="certLevelText">Principiante</span> en sistemas de 
          Calefacci√≥n, Ventilaci√≥n, Aire Acondicionado y Refrigeraci√≥n (HVACR), 
          demostrando competencia en los conocimientos y habilidades requeridos.
        </div>
      </div>
      
      <div class="cert-details">
        <div class="cert-detail-item">
          <div class="cert-detail-label">Puntuaci√≥n Obtenida</div>
          <div class="cert-detail-value" id="certScore">85%</div>
        </div>
        <div class="cert-detail-item">
          <div class="cert-detail-label">Fecha de Emisi√≥n</div>
          <div class="cert-detail-value" id="certDate">01 de Enero de 2026</div>
        </div>
        <div class="cert-detail-item">
          <div class="cert-detail-label">V√°lido Hasta</div>
          <div class="cert-detail-value" id="certExpiry">01 de Enero de 2028</div>
        </div>
      </div>
      
      <div class="cert-footer">
        <div class="cert-signature">
          <div class="cert-signature-line"></div>
          <div class="cert-signature-name">Mario Flores Corona</div>
          <div class="cert-signature-title">Master Instructor / Director</div>
        </div>
        <div class="cert-qr">
          <div id="certQRCode" class="cert-qr-code" style="margin-bottom:5px;"></div>
          <div class="cert-id-text">ID: <span id="certIdText">CERT-XXX-000000</span></div>
          <div class="cert-id-text">Verificar en: maestromario.com</div>
        </div>
      </div>
      
      <div class="cert-seal">
        <div class="cert-seal-text">ACVOLT<br>CERTIFIED<br>TECH</div>
      </div>
    </div>


    <script>
    // ===== NOTIFICATION SYSTEM =====
    const NOTIF_STORAGE_KEY = 'maestroac_notifications';
    const NOTIF_MAX = 50;
    
    function getNotifications() {
      try {
        return JSON.parse(localStorage.getItem(NOTIF_STORAGE_KEY) || '[]');
      } catch(e) { return []; }
    }
    
    function saveNotifications(notifs) {
      // Keep only last NOTIF_MAX
      if (notifs.length > NOTIF_MAX) notifs = notifs.slice(-NOTIF_MAX);
      localStorage.setItem(NOTIF_STORAGE_KEY, JSON.stringify(notifs));
    }
    
    function addNotification(type, message, icon) {
      const icons = { checkin: 'üìã', checkout: 'üö™', quiz: 'üèÜ', payment: 'üí≥', register: 'üë§', level: '‚≠ê', cert: 'üèÖ' };
      const notif = {
        id: Date.now(),
        type: type,
        message: message,
        icon: icon || icons[type] || 'üîî',
        time: new Date().toISOString(),
        read: false
      };
      const notifs = getNotifications();
      notifs.push(notif);
      saveNotifications(notifs);
      updateNotifBadge();
      renderNotifications();
    }
    
    function updateNotifBadge() {
      const notifs = getNotifications();
      const unread = notifs.filter(n => !n.read).length;
      const badge = document.getElementById('notifBadge');
      if (!badge) return;
      if (unread > 0) {
        badge.textContent = unread > 9 ? '9+' : unread;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }
    
    function toggleNotifPanel(e) {
      if (e) e.stopPropagation();
      const panel = document.getElementById('notifPanel');
      const isOpen = panel.classList.contains('open');
      if (isOpen) {
        panel.classList.remove('open');
      } else {
        panel.classList.add('open');
        // Mark all as read
        const notifs = getNotifications();
        notifs.forEach(n => n.read = true);
        saveNotifications(notifs);
        updateNotifBadge();
        renderNotifications();
      }
    }
    
    // Close panel when clicking outside
    document.addEventListener('click', function(e) {
      const panel = document.getElementById('notifPanel');
      const bellContainer = document.getElementById('notifBellContainer');
      if (panel && panel.classList.contains('open') && !panel.contains(e.target) && bellContainer && !bellContainer.contains(e.target)) {
        panel.classList.remove('open');
      }
    });
    
    function renderNotifications() {
      const list = document.getElementById('notifList');
      if (!list) return;
      const notifs = getNotifications();
      
      if (notifs.length === 0) {
        list.innerHTML = '<div class="notif-empty"><div class="notif-empty-icon">üîï</div><p>No hay notificaciones</p></div>';
        return;
      }
      
      // Show newest first
      const sorted = [...notifs].reverse();
      list.innerHTML = sorted.map(n => {
        const typeClass = n.type === 'checkin' || n.type === 'checkout' ? 'checkin' : 
                          n.type === 'quiz' || n.type === 'level' || n.type === 'cert' ? 'quiz' : 
                          n.type === 'payment' ? 'payment' : 'register';
        const timeAgo = getTimeAgo(n.time);
        return `
          <div class="notif-item ${n.read ? '' : 'unread'}">
            <div class="notif-icon ${typeClass}">${n.icon}</div>
            <div class="notif-content">
              <div class="notif-text">${n.message}</div>
              <div class="notif-time">${timeAgo}</div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function getTimeAgo(isoTime) {
      const now = new Date();
      const then = new Date(isoTime);
      const diff = Math.floor((now - then) / 1000);
      if (diff < 60) return 'Ahora mismo';
      if (diff < 3600) return Math.floor(diff / 60) + ' min';
      if (diff < 86400) return Math.floor(diff / 3600) + 'h';
      if (diff < 604800) return Math.floor(diff / 86400) + 'd';
      return then.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
    }
    
    function clearNotifications() {
      localStorage.removeItem(NOTIF_STORAGE_KEY);
      updateNotifBadge();
      renderNotifications();
    }
    
    // Show bell after user is logged in
    function showNotifBell() {
      const bell = document.getElementById('notifBellContainer');
      if (bell) bell.style.display = 'block';
      updateNotifBadge();
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      updateNotifBadge();
      renderNotifications();
      
      // Check if user was in the app before (show "back to app" button on welcome/login screens)
      const lastScreen = localStorage.getItem('maestroac_last_screen');
      const savedUser = localStorage.getItem('tecnico_user') || localStorage.getItem('tecnico_user_backup');
      if (lastScreen && savedUser && lastScreen !== 'loginScreen' && lastScreen !== 'registerScreen' && lastScreen !== 'welcomeScreen') {
        const backBtn = document.getElementById('backToAppBtn');
        if (backBtn) backBtn.style.display = 'block';
      }
    });
    
    function returnToApp() {
      const lastScreen = localStorage.getItem('maestroac_last_screen');
      const backBtn = document.getElementById('backToAppBtn');
      if (backBtn) backBtn.style.display = 'none';
      
      // Load user data first
      let savedUser = localStorage.getItem('tecnico_user') || localStorage.getItem('tecnico_user_backup');
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          document.getElementById('userGreeting').textContent = 'Hola, ' + currentUser.nombre.split(' ')[0];
          showNotifBell();
        } catch(e) {}
      }
      
      // Navigate to last screen or levels
      const safeScreens = ['levelsScreen', 'studySectionsScreen', 'videoLessonsScreen', 'certificatesScreen', 'attendanceScreen', 'welcomeScreen', 'studentCalendarScreen', 'referidosScreen'];
      const target = safeScreens.includes(lastScreen) ? lastScreen : 'welcomeScreen';
      
      // If going to protected screen, need check-in first
      showScreen(target);
    }

    // ============================================
    // BATCH EMAIL SYSTEM - Env√≠o Masivo de C√≥digos
    // ============================================
    let batchStudents = [];
    let batchSelectedStudents = new Set();
    let batchGeneratedCodes = [];

    // Load all students for batch selection
    async function loadStudentsForBatch() {
      const container = document.getElementById('batchStudentList');
      container.innerHTML = '<div style="color: #9b59b6; text-align: center; padding: 20px;">‚è≥ Cargando estudiantes...</div>';
      
      try {
        // First try to load from Supabase
        if (supabaseClient && isOnline) {
          const { data: users, error } = await supabaseClient
            .from('users')
            .select('id, nombre, email, telefono, fecha_registro, nivel_actual')
            .order('fecha_registro', { ascending: false });
          
          if (!error && users && users.length > 0) {
            batchStudents = users.map(u => ({
              id: u.id,
              nombre: u.nombre || 'Sin nombre',
              email: u.email || '',
              telefono: u.telefono || '',
              fecha: u.fecha_registro,
              nivel: u.nivel_actual || 'principiante'
            }));
          }
        }
        
        // Also check technicians table
        if (supabaseClient && isOnline) {
          const { data: techs } = await supabaseClient
            .from('technicians')
            .select('id, nombre, email, telefono, registration_date')
            .order('registration_date', { ascending: false });
          
          if (techs && techs.length > 0) {
            const existingEmails = batchStudents.map(s => s.email);
            techs.forEach(t => {
              if (t.email && !existingEmails.includes(t.email)) {
                batchStudents.push({
                  id: t.id,
                  nombre: t.nombre || 'Sin nombre',
                  email: t.email,
                  telefono: t.telefono || '',
                  fecha: t.registration_date,
                  nivel: 'tecnico'
                });
              }
            });
          }
        }
        
        // Also get from allTechnicians array (localStorage)
        if (typeof allTechnicians !== 'undefined' && allTechnicians.length > 0) {
          const existingEmails = batchStudents.map(s => s.email);
          allTechnicians.forEach(t => {
            if (t.email && !existingEmails.includes(t.email)) {
              batchStudents.push({
                id: t.supabaseId || t.email,
                nombre: t.nombre || 'Sin nombre',
                email: t.email,
                telefono: t.telefono || '',
                fecha: t.registrationDate,
                nivel: t.nivel_actual || 'local'
              });
            }
          });
        }
        
        // Render the list
        renderBatchStudentList();
        
      } catch(e) {
        console.error('Error loading students for batch:', e);
        container.innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 20px;">‚ùå Error cargando estudiantes: ' + e.message + '</div>';
      }
    }

    // Render the student list with checkboxes
    function renderBatchStudentList(filter = '') {
      const container = document.getElementById('batchStudentList');
      
      let filtered = batchStudents;
      if (filter) {
        const f = filter.toLowerCase();
        filtered = batchStudents.filter(s => 
          (s.nombre && s.nombre.toLowerCase().includes(f)) || 
          (s.email && s.email.toLowerCase().includes(f)) ||
          (s.telefono && s.telefono.includes(f))
        );
      }
      
      if (filtered.length === 0) {
        container.innerHTML = '<div style="color: #888; text-align: center; padding: 30px;">' +
          '<div style="font-size: 2em; margin-bottom: 10px;">üì≠</div>' +
          '<p>No se encontraron estudiantes' + (filter ? ' con ese filtro' : '') + '</p></div>';
        return;
      }
      
      let html = '<div style="color: #9b59b6; font-size: 0.85em; margin-bottom: 10px; padding: 5px 10px; background: rgba(155,89,182,0.2); border-radius: 6px;">' +
        'üë• Total: <strong>' + batchStudents.length + '</strong> estudiantes' +
        (filter ? ' | Mostrando: <strong>' + filtered.length + '</strong>' : '') +
        '</div>';
      
      filtered.forEach((student, idx) => {
        const isSelected = batchSelectedStudents.has(student.email || student.id);
        const bgColor = isSelected ? 'rgba(155,89,182,0.3)' : 'rgba(255,255,255,0.05)';
        const borderColor = isSelected ? '#9b59b6' : 'transparent';
        
        html += `
          <div onclick="toggleBatchStudent('${student.email || student.id}')" 
               style="display: flex; align-items: center; gap: 12px; padding: 12px; margin: 6px 0; background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
            <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleBatchStudent('${student.email || student.id}')" 
                   style="width: 20px; height: 20px; accent-color: #9b59b6; cursor: pointer;">
            <div style="flex: 1; min-width: 0;">
              <div style="color: #fff; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${student.nombre}</div>
              <div style="color: #aaa; font-size: 0.85em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üìß ${student.email || 'Sin email'}</div>
              ${student.telefono ? `<div style="color: #888; font-size: 0.8em;">üì± ${student.telefono}</div>` : ''}
            </div>
            <div style="text-align: right; font-size: 0.75em; color: #666;">
              ${student.fecha ? new Date(student.fecha).toLocaleDateString('es-MX', {month: 'short', day: 'numeric'}) : ''}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      updateBatchSelectedCount();
    }

    // Toggle student selection
    function toggleBatchStudent(identifier) {
      if (batchSelectedStudents.has(identifier)) {
        batchSelectedStudents.delete(identifier);
      } else {
        batchSelectedStudents.add(identifier);
      }
      renderBatchStudentList(document.getElementById('batchSearchStudent')?.value || '');
    }

    // Filter students by search
    function filterBatchStudents() {
      const filter = document.getElementById('batchSearchStudent')?.value || '';
      renderBatchStudentList(filter);
    }

    // Select N students
    function selectBatchStudents(count) {
      batchSelectedStudents.clear();
      const toSelect = batchStudents.slice(0, count);
      toSelect.forEach(s => {
        if (s.email) batchSelectedStudents.add(s.email);
        else if (s.id) batchSelectedStudents.add(s.id);
      });
      renderBatchStudentList(document.getElementById('batchSearchStudent')?.value || '');
    }

    // Select all students
    function selectAllBatchStudents() {
      batchStudents.forEach(s => {
        if (s.email) batchSelectedStudents.add(s.email);
        else if (s.id) batchSelectedStudents.add(s.id);
      });
      renderBatchStudentList(document.getElementById('batchSearchStudent')?.value || '');
    }

    // Deselect all students
    function deselectAllBatchStudents() {
      batchSelectedStudents.clear();
      renderBatchStudentList(document.getElementById('batchSearchStudent')?.value || '');
    }

    // Update selected count display
    function updateBatchSelectedCount() {
      const countEl = document.getElementById('batchSelectedCount');
      if (countEl) {
        const count = batchSelectedStudents.size;
        countEl.textContent = count + ' seleccionado' + (count !== 1 ? 's' : '');
        countEl.style.color = count > 0 ? '#2ecc71' : '#9b59b6';
      }
    }

    // Generate codes for all selected students
    async function generateBatchCodes() {
      if (batchSelectedStudents.size === 0) {
        alert('Selecciona al menos un estudiante');
        return;
      }
      
      const level = document.getElementById('batchCodeLevel')?.value || 'clases_vivo';
      const duration = document.getElementById('batchCodeDuration')?.value || '30';
      
      batchGeneratedCodes = [];
      const prefix = level === 'full_app' ? 'FULL' : (level === 'clases_vivo' ? 'ZOOM' : level.substring(0, 4).toUpperCase());
      
      // Get selected student details
      const selectedStudents = batchStudents.filter(s => 
        batchSelectedStudents.has(s.email) || batchSelectedStudents.has(s.id)
      );
      
      for (const student of selectedStudents) {
        const code = prefix + '-' + Math.random().toString(36).substring(2, 8).toUpperCase() + '-' + Date.now().toString(36).toUpperCase().slice(-4);
        
        // Calculate expiration
        let expiresAt = null;
        if (duration !== 'lifetime') {
          const d = new Date();
          d.setDate(d.getDate() + parseInt(duration));
          expiresAt = d.toISOString();
        }
        
        batchGeneratedCodes.push({
          nombre: student.nombre,
          email: student.email,
          telefono: student.telefono,
          code: code,
          level: level,
          duration: duration,
          expiresAt: expiresAt
        });
        
        // Save to Supabase
        try {
          if (supabaseClient && isOnline) {
            await supabaseClient.from('access_code_requests').insert([{
              student_name: student.nombre,
              student_email: student.email || null,
              student_phone: student.telefono || '',
              access_level: level,
              duration_days: duration === 'lifetime' ? 'lifetime' : duration,
              code: code,
              status: 'approved',
              requested_at: new Date().toISOString(),
              approved_at: new Date().toISOString()
            }]);
          }
        } catch(e) {
          console.log('Error saving code to Supabase:', e);
        }
      }
      
      // Display results
      displayBatchCodesResult();
      
      // Refresh active codes
      if (typeof loadActiveCodes === 'function') loadActiveCodes();
    }

    // Display generated codes
    function displayBatchCodesResult() {
      const container = document.getElementById('batchCodesResult');
      const content = document.getElementById('batchCodesContent');
      
      if (!container || !content) return;
      
      let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">' +
        '<tr style="background: rgba(46,204,113,0.2);">' +
        '<th style="padding: 8px; text-align: left; border-bottom: 1px solid #2ecc71;">Nombre</th>' +
        '<th style="padding: 8px; text-align: left; border-bottom: 1px solid #2ecc71;">Email</th>' +
        '<th style="padding: 8px; text-align: left; border-bottom: 1px solid #2ecc71;">C√≥digo</th>' +
        '</tr>';
      
      batchGeneratedCodes.forEach(item => {
        html += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
          <td style="padding: 8px; color: #fff;">${item.nombre}</td>
          <td style="padding: 8px; color: #aaa;">${item.email || '-'}</td>
          <td style="padding: 8px; color: #2ecc71; font-family: monospace; font-weight: bold;">${item.code}</td>
        </tr>`;
      });
      
      html += '</table>';
      html += '<div style="margin-top: 10px; padding: 10px; background: rgba(243,156,18,0.15); border-radius: 6px; color: #f39c12; font-size: 0.85em;">' +
        '‚úÖ Se generaron <strong>' + batchGeneratedCodes.length + '</strong> c√≥digos exitosamente</div>';
      
      content.innerHTML = html;
      container.style.display = 'block';
    }

    // Copy all codes to clipboard
    function copyAllBatchCodes() {
      let text = 'C√ìDIGOS DE ACCESO GENERADOS\n';
      text += '===========================\n\n';
      
      batchGeneratedCodes.forEach(item => {
        text += 'Nombre: ' + item.nombre + '\n';
        text += 'Email: ' + (item.email || 'N/A') + '\n';
        text += 'C√≥digo: ' + item.code + '\n';
        text += 'Nivel: ' + item.level + '\n';
        text += 'Duraci√≥n: ' + item.duration + ' d√≠as\n';
        text += '----------------------------\n';
      });
      
      navigator.clipboard.writeText(text).then(() => {
        alert('‚úÖ ' + batchGeneratedCodes.length + ' c√≥digos copiados al portapapeles');
      }).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        alert('‚úÖ ' + batchGeneratedCodes.length + ' c√≥digos copiados al portapapeles');
      });
    }

    // Export to CSV
    function exportBatchToCSV() {
      let csv = 'Nombre,Email,Tel√©fono,C√≥digo,Nivel,Duraci√≥n,Expira\n';
      
      batchGeneratedCodes.forEach(item => {
        csv += '"' + item.nombre + '","' + (item.email || '') + '","' + (item.telefono || '') + '","' + item.code + '","' + item.level + '","' + item.duration + ' d√≠as","' + (item.expiresAt ? new Date(item.expiresAt).toLocaleDateString() : 'Nunca') + '"\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'codigos_acceso_' + new Date().toISOString().slice(0,10) + '.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Open email client with all recipients
    function openBatchEmailClient() {
      const emails = batchGeneratedCodes.filter(c => c.email).map(c => c.email);
      
      if (emails.length === 0) {
        alert('Ning√∫n estudiante seleccionado tiene email');
        return;
      }
      
      // Build email body
      let body = 'Hola,\n\nAqu√≠ est√° tu c√≥digo de acceso para las clases de ACVOLT Tech School:\n\n';
      body += 'üîë Tu c√≥digo personal est√° adjunto en este correo.\n\n';
      body += 'Para usarlo:\n';
      body += '1. Abre la app MaestroAC en maestromario.com\n';
      body += '2. Ve a la secci√≥n de Clases en Vivo\n';
      body += '3. Ingresa tu c√≥digo cuando se solicite\n\n';
      body += '¬°Nos vemos en clase!\n';
      body += 'Maestro Mario - Nivel 33\n';
      body += 'ACVOLT Tech School';
      
      // Use BCC for batch emails (privacy)
      const bccEmails = emails.join(',');
      const subject = encodeURIComponent('üîë Tu C√≥digo de Acceso - ACVOLT Tech School');
      const bodyEncoded = encodeURIComponent(body);
      
      // Open mail client
      // Open in-app email modal for batch emails
      openEmailComposer(bccEmails, decodeURIComponent(subject), decodeURIComponent(bodyEncoded), 'üìß Email Masivo (' + emails.length + ' estudiantes)');
      
      // Also show a message with individual codes
      let codesMessage = 'üìß Email abierto con ' + emails.length + ' destinatarios\n\n';
      codesMessage += 'C√ìDIGOS INDIVIDUALES PARA COPIAR:\n\n';
      batchGeneratedCodes.forEach(c => {
        if (c.email) {
          codesMessage += c.nombre + ': ' + c.code + '\n';
        }
      });
      
      alert(codesMessage);
    }
    // ============================================
    // END BATCH EMAIL SYSTEM
    // ============================================

    // Register Service Worker with auto-update
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => {
            console.log('[MaestroAC] SW registered:', reg.scope);
            // Check for updates every 60 seconds
            setInterval(() => { reg.update(); }, 60000);
            // Listen for new SW waiting
            reg.addEventListener('updatefound', () => {
              const newSW = reg.installing;
              newSW.addEventListener('statechange', () => {
                if (newSW.state === 'activated') {
                  console.log('[MaestroAC] New version activated, reloading...');
                  window.location.reload();
                }
              });
            });
          })
          .catch(err => console.error('[MaestroAC] SW failed:', err));
      });
      
      // Listen for SW update message
      navigator.serviceWorker.addEventListener('message', event => {
        if (event.data && event.data.type === 'SW_UPDATED') {
          console.log('[MaestroAC] SW updated to:', event.data.version);
          window.location.reload();
        }
      });
    }
    
    // Prompt to install PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      console.log('[MaestroAC] Install prompt available');
    });
    </script>
    <!-- Notification Bell -->
    <div class="notif-bell-container" id="notifBellContainer" style="display:none;">
      <button class="notif-bell-btn" onclick="toggleNotifPanel(event)">
        üîî
        <span class="notif-badge hidden" id="notifBadge">0</span>
      </button>
    </div>

    <!-- Notification Panel -->
    <div class="notif-panel" id="notifPanel">
      <div class="notif-panel-header">
        <span class="notif-panel-title">üîî Notificaciones</span>
        <button class="notif-clear-btn" onclick="clearNotifications()">Limpiar todo</button>
      </div>
      <div class="notif-list" id="notifList">
        <div class="notif-empty">
          <div class="notif-empty-icon">üîï</div>
          <p>No hay notificaciones</p>
        </div>
      </div>
    </div>

<script>
// ============================================
// ADMIN: DIAGNOSTICO DE ESTUDIANTES
// ============================================
var _diagData = { all: [], active: [], inactive: [], duplicates: [] };

async function runStudentDiagnostic(){
  var container = document.getElementById('diagResults');
  container.innerHTML = '<div style="text-align:center;padding:30px;"><div style="font-size:2em;margin-bottom:10px;">‚è≥</div>Analizando estudiantes...</div>';

  try {
    // 1. Get all registered users
    var usersRes = await supabaseClient.from('users').select('*').order('created_at', {ascending: false});
    var users = usersRes.data || [];

    // 2. Get all progress records (who has activity)
    var progressRes = await supabaseClient.from('user_progress').select('user_id');
    var progressUserIds = new Set((progressRes.data || []).map(function(p){ return p.user_id; }));

    // 3. Get all quiz attempts
    var quizRes = await supabaseClient.from('quiz_attempts').select('user_id');
    var quizUserIds = new Set((quizRes.data || []).map(function(q){ return q.user_id; }));

    // 4. Get all certificates
    var certRes = await supabaseClient.from('certificates').select('user_id');
    var certUserIds = new Set((certRes.data || []).map(function(c){ return c.user_id; }));

    // 5. Get activity log
    var actRes = await supabaseClient.from('activity_log').select('user_id');
    var actUserIds = new Set((actRes.data || []).map(function(a){ return a.user_id; }));

    // Combine all activity
    var activeIds = new Set();
    [progressUserIds, quizUserIds, certUserIds, actUserIds].forEach(function(s){
      s.forEach(function(id){ activeIds.add(id); });
    });

    // Classify users
    var activeUsers = [];
    var inactiveUsers = [];
    users.forEach(function(u){
      u._hasActivity = activeIds.has(u.id);
      u._hasProgress = progressUserIds.has(u.id);
      u._hasQuiz = quizUserIds.has(u.id);
      u._hasCert = certUserIds.has(u.id);
      if(u._hasActivity){
        activeUsers.push(u);
      } else {
        inactiveUsers.push(u);
      }
    });

    // Find duplicates by nombre (case-insensitive) or telefono
    var nameGroups = {};
    var phoneGroups = {};
    users.forEach(function(u){
      var nameKey = (u.nombre || '').trim().toLowerCase();
      if(nameKey){
        if(!nameGroups[nameKey]) nameGroups[nameKey] = [];
        nameGroups[nameKey].push(u);
      }
      var phone = (u.telefono || '').replace(/\D/g, '');
      if(phone && phone.length >= 7){
        if(!phoneGroups[phone]) phoneGroups[phone] = [];
        phoneGroups[phone].push(u);
      }
    });

    var duplicateGroups = [];
    var seenIds = new Set();
    // Name duplicates
    Object.keys(nameGroups).forEach(function(key){
      if(nameGroups[key].length > 1){
        var group = nameGroups[key].filter(function(u){ return !seenIds.has(u.id); });
        if(group.length > 1){
          duplicateGroups.push({reason: 'Mismo nombre', users: nameGroups[key]});
          nameGroups[key].forEach(function(u){ seenIds.add(u.id); });
        }
      }
    });
    // Phone duplicates
    Object.keys(phoneGroups).forEach(function(key){
      if(phoneGroups[key].length > 1){
        var hasNew = phoneGroups[key].some(function(u){ return !seenIds.has(u.id); });
        if(hasNew){
          duplicateGroups.push({reason: 'Mismo tel√©fono', users: phoneGroups[key]});
          phoneGroups[key].forEach(function(u){ seenIds.add(u.id); });
        }
      }
    });

    _diagData = {
      all: users,
      active: activeUsers,
      inactive: inactiveUsers,
      duplicates: duplicateGroups
    };

    // Update stats
    document.getElementById('diagTotalCount').textContent = users.length;
    document.getElementById('diagActiveCount').textContent = activeUsers.length;
    document.getElementById('diagInactiveCount').textContent = inactiveUsers.length;
    document.getElementById('diagDuplicateCount').textContent = duplicateGroups.length;
    document.getElementById('diagStats').style.display = 'grid';

    showDiagFilter('all');
  } catch(e){
    container.innerHTML = '<span style="color:#e74c3c;">Error: ' + (e.message || e) + '</span>';
    console.error('Diagnostic error:', e);
  }
}

function showDiagFilter(filter){
  // Update button styles
  ['all','inactive','duplicates','active'].forEach(function(f){
    var btn = document.getElementById('diagFilter' + f.charAt(0).toUpperCase() + f.slice(1));
    if(btn){
      if(f === filter){
        var colors = {all:'#3498db', inactive:'#e74c3c', duplicates:'#f39c12', active:'#2ecc71'};
        btn.style.background = colors[f];
        btn.style.color = '#fff';
        btn.style.border = 'none';
      } else {
        var colors2 = {all:'#3498db', inactive:'#e74c3c', duplicates:'#f39c12', active:'#2ecc71'};
        btn.style.background = 'transparent';
        btn.style.color = colors2[f];
        btn.style.border = '1px solid ' + colors2[f];
      }
    }
  });

  var container = document.getElementById('diagResults');

  if(filter === 'duplicates'){
    renderDuplicates(container);
    return;
  }

  var list = filter === 'all' ? _diagData.all : filter === 'active' ? _diagData.active : _diagData.inactive;
  if(!list || list.length === 0){
    container.innerHTML = '<span style="color:#64748b;">No hay datos</span>';
    return;
  }

  var html = '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.85em;">';
  html += '<tr style="background:rgba(255,255,255,0.05);"><th style="padding:8px;text-align:left;color:#94a3b8;">Nombre</th><th style="padding:8px;text-align:left;color:#94a3b8;">Email</th><th style="padding:8px;text-align:left;color:#94a3b8;">Tel√©fono</th><th style="padding:8px;text-align:center;color:#94a3b8;">Registro</th><th style="padding:8px;text-align:center;color:#94a3b8;">√öltimo Acceso</th><th style="padding:8px;text-align:center;color:#94a3b8;">Estado</th></tr>';

  list.forEach(function(u){
    var regDate = u.created_at ? new Date(u.created_at).toLocaleDateString('es-MX') : 'N/A';
    var lastAccess = u.ultimo_acceso ? new Date(u.ultimo_acceso).toLocaleDateString('es-MX') : 'Nunca';
    var statusColor = u._hasActivity ? '#2ecc71' : '#e74c3c';
    var statusText = u._hasActivity ? 'üü¢ Activo' : 'üî¥ Sin actividad';
    var details = [];
    if(u._hasProgress) details.push('üìä Progreso');
    if(u._hasQuiz) details.push('üìù Quizzes');
    if(u._hasCert) details.push('üéì Certificados');

    html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);">';
    html += '<td style="padding:8px;color:#fff;">' + (u.nombre || '<sin nombre>') + '</td>';
    html += '<td style="padding:8px;color:#94a3b8;font-size:0.9em;">' + (u.email || '-') + '</td>';
    html += '<td style="padding:8px;color:#94a3b8;">' + (u.telefono || '-') + '</td>';
    html += '<td style="padding:8px;text-align:center;color:#64748b;">' + regDate + '</td>';
    html += '<td style="padding:8px;text-align:center;color:#64748b;">' + lastAccess + '</td>';
    html += '<td style="padding:8px;text-align:center;"><span style="color:' + statusColor + ';font-size:0.85em;">' + statusText + '</span>';
    if(details.length > 0) html += '<div style="font-size:0.7em;color:#64748b;">' + details.join(' ') + '</div>';
    html += '</td></tr>';
  });
  html += '</table></div>';
  container.innerHTML = html;
}

function renderDuplicates(container){
  var groups = _diagData.duplicates;
  if(!groups || groups.length === 0){
    container.innerHTML = '<span style="color:#2ecc71;">‚úÖ No se encontraron registros duplicados</span>';
    return;
  }
  var html = '';
  groups.forEach(function(g, idx){
    html += '<div style="background:rgba(243,156,18,0.1);border:1px solid rgba(243,156,18,0.3);border-radius:12px;padding:15px;margin-bottom:12px;">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">';
    html += '<span style="color:#f39c12;font-weight:bold;">‚ö†Ô∏è Grupo duplicado #' + (idx+1) + ' ‚Äî ' + g.reason + '</span>';
    html += '<span style="color:#64748b;font-size:0.85em;">' + g.users.length + ' registros</span></div>';
    html += '<table style="width:100%;border-collapse:collapse;font-size:0.85em;">';
    html += '<tr style="background:rgba(255,255,255,0.03);"><th style="padding:6px;text-align:left;color:#f39c12;">Nombre</th><th style="padding:6px;text-align:left;color:#f39c12;">Email</th><th style="padding:6px;text-align:left;color:#f39c12;">Tel√©fono</th><th style="padding:6px;text-align:center;color:#f39c12;">Registro</th><th style="padding:6px;text-align:center;color:#f39c12;">Actividad</th></tr>';
    g.users.forEach(function(u){
      var regDate = u.created_at ? new Date(u.created_at).toLocaleDateString('es-MX') : 'N/A';
      var hasAct = u._hasActivity;
      html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);">';
      html += '<td style="padding:6px;color:#fff;">' + (u.nombre || '-') + '</td>';
      html += '<td style="padding:6px;color:#94a3b8;">' + (u.email || '-') + '</td>';
      html += '<td style="padding:6px;color:#94a3b8;">' + (u.telefono || '-') + '</td>';
      html += '<td style="padding:6px;text-align:center;color:#64748b;">' + regDate + '</td>';
      html += '<td style="padding:6px;text-align:center;">' + (hasAct ? '<span style="color:#2ecc71;">üü¢ S√≠</span>' : '<span style="color:#e74c3c;">üî¥ No</span>') + '</td>';
      html += '</tr>';
    });
    html += '</table></div>';
  });
  container.innerHTML = html;
}
</script>

<script>
// ============================================
// ADMIN: LIBROS, EXAMENES, PAGOS
// ============================================

// --- Populate student dropdowns ---
async function populateStudentDropdowns(){
  try {
    var res = await supabaseClient.from('students').select('email, nombre');
    if(res.data && res.data.length > 0){
      var opts = '<option value="">Seleccionar estudiante...</option>';
      var optsAll = '<option value="todos">üë• Todos los estudiantes</option>';
      res.data.forEach(function(s){
        var label = (s.nombre || '') + ' (' + s.email + ')';
        opts += '<option value="' + s.email + '">' + label + '</option>';
        optsAll += '<option value="' + s.email + '">' + label + '</option>';
      });
      var examSel = document.getElementById('examStudentEmail');
      var paySel = document.getElementById('paymentStudentEmail');
      var bookSel = document.getElementById('bookAssignTo');
      if(examSel) examSel.innerHTML = opts;
      if(paySel) paySel.innerHTML = opts;
      if(bookSel) bookSel.innerHTML = optsAll;
    }
  } catch(e){ console.log('populateStudentDropdowns error:', e); }
}

// --- LIBROS / PDFs ---
function previewBookFile(input){
  var span = document.getElementById('bookFileName');
  if(input.files && input.files[0]){
    var f = input.files[0];
    var sizeMB = (f.size / 1024 / 1024).toFixed(2);
    span.textContent = f.name + ' (' + sizeMB + ' MB)';
    span.style.color = '#3498db';
  } else {
    span.textContent = 'Ning√∫n archivo seleccionado';
    span.style.color = '#94a3b8';
  }
}

async function uploadBook(){
  var title = document.getElementById('bookTitle').value.trim();
  var fileInput = document.getElementById('bookFileInput');
  if(!title){ alert('Escribe un t√≠tulo para el material'); return; }
  if(!fileInput.files || !fileInput.files[0]){ alert('Selecciona un archivo'); return; }
  var file = fileInput.files[0];
  if(file.size > 50 * 1024 * 1024){ alert('El archivo es muy grande (m√°x 50MB)'); return; }

  var prog = document.getElementById('bookUploadProgress');
  var bar = document.getElementById('bookProgressBar');
  var status = document.getElementById('bookUploadStatus');
  prog.style.display = 'block';
  bar.style.width = '20%';
  status.textContent = 'Subiendo archivo...';

  try {
    var ext = file.name.split('.').pop();
    var fileName = Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
    var path = 'books/' + fileName;

    bar.style.width = '50%';
    var uploadRes = await supabaseClient.storage.from('school-files').upload(path, file);
    if(uploadRes.error) throw uploadRes.error;

    bar.style.width = '75%';
    status.textContent = 'Guardando registro...';
    var publicUrl = supabaseClient.storage.from('school-files').getPublicUrl(path).data.publicUrl;

    var desc = document.getElementById('bookDescription').value.trim();
    var cat = document.getElementById('bookCategory').value;
    var assignTo = document.getElementById('bookAssignTo').value;

    var insertRes = await supabaseClient.from('student_books').insert({
      titulo: title,
      descripcion: desc || null,
      file_url: publicUrl,
      file_name: file.name,
      file_size: file.size,
      categoria: cat,
      asignado_a: assignTo,
      subido_por: 'admin'
    });
    if(insertRes.error) throw insertRes.error;

    bar.style.width = '100%';
    status.textContent = '‚úÖ Material subido exitosamente!';
    status.style.color = '#2ecc71';
    document.getElementById('bookTitle').value = '';
    document.getElementById('bookDescription').value = '';
    fileInput.value = '';
    document.getElementById('bookFileName').textContent = 'Ning√∫n archivo seleccionado';
    document.getElementById('bookFileName').style.color = '#94a3b8';
    setTimeout(function(){ prog.style.display = 'none'; status.style.color = '#3498db'; }, 3000);
    loadAdminBooks();
  } catch(e){
    bar.style.width = '0%';
    status.textContent = '‚ùå Error: ' + (e.message || e);
    status.style.color = '#e74c3c';
    console.error('uploadBook error:', e);
  }
}

async function loadAdminBooks(){
  var container = document.getElementById('adminBooksList');
  if(!container) return;
  container.innerHTML = '<span style="color:#64748b;">Cargando...</span>';
  try {
    var res = await supabaseClient.from('student_books').select('*').eq('activo', true).order('created_at', {ascending: false});
    if(!res.data || res.data.length === 0){
      container.innerHTML = '<span style="color:#64748b;">No hay material disponible a√∫n</span>';
      return;
    }
    var html = '<div style="display:grid;gap:10px;">';
    res.data.forEach(function(b){
      var sizeMB = b.file_size ? (b.file_size / 1024 / 1024).toFixed(1) + ' MB' : '';
      var fecha = new Date(b.created_at).toLocaleDateString('es-MX');
      html += '<div style="background:rgba(52,152,219,0.08);border:1px solid rgba(52,152,219,0.2);border-radius:10px;padding:12px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">';
      html += '<div><strong style="color:#3498db;">' + b.titulo + '</strong>';
      html += '<div style="font-size:0.8em;color:#64748b;">' + b.categoria + ' ‚Ä¢ ' + sizeMB + ' ‚Ä¢ ' + fecha + ' ‚Ä¢ Para: ' + b.asignado_a + '</div>';
      if(b.descripcion) html += '<div style="font-size:0.8em;color:#94a3b8;margin-top:4px;">' + b.descripcion + '</div>';
      html += '</div>';
      html += '<div style="display:flex;gap:6px;">';
      html += '<a href="' + b.file_url + '" target="_blank" style="padding:6px 12px;background:#3498db;color:#fff;border-radius:6px;text-decoration:none;font-size:0.85em;">üì• Ver</a>';
      html += '<button onclick="deleteBook(\'' + b.id + '\')" style="padding:6px 12px;background:#e74c3c;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:0.85em;">üóëÔ∏è</button>';
      html += '</div></div>';
    });
    html += '</div>';
    container.innerHTML = html;
  } catch(e){ container.innerHTML = '<span style="color:#e74c3c;">Error cargando libros</span>'; }
}

async function deleteBook(id){
  if(!confirm('¬øEliminar este material?')) return;
  await supabaseClient.from('student_books').update({activo: false}).eq('id', id);
  loadAdminBooks();
}

// --- EXAMENES ASIGNADOS ---
async function assignExam(){
  var email = document.getElementById('examStudentEmail').value;
  var title = document.getElementById('examTitle').value.trim();
  if(!email){ alert('Selecciona un estudiante'); return; }
  if(!title){ alert('Escribe un t√≠tulo para el examen'); return; }

  var desc = document.getElementById('examDescription').value.trim();
  var deadline = document.getElementById('examDeadline').value;
  var selEl = document.getElementById('examStudentEmail');
  var studentName = selEl.options[selEl.selectedIndex].text.split('(')[0].trim();

  try {
    var res = await supabaseClient.from('assigned_exams').insert({
      student_email: email,
      student_name: studentName,
      titulo: title,
      descripcion: desc || null,
      fecha_limite: deadline ? new Date(deadline).toISOString() : null
    });
    if(res.error) throw res.error;
    alert('‚úÖ Examen asignado a ' + studentName);
    document.getElementById('examTitle').value = '';
    document.getElementById('examDescription').value = '';
    document.getElementById('examDeadline').value = '';
    loadAdminExams();
  } catch(e){ alert('Error: ' + (e.message || e)); }
}

async function loadAdminExams(){
  var container = document.getElementById('adminExamsList');
  if(!container) return;
  container.innerHTML = '<span style="color:#64748b;">Cargando...</span>';
  try {
    var res = await supabaseClient.from('assigned_exams').select('*').order('created_at', {ascending: false}).limit(50);
    if(!res.data || res.data.length === 0){
      container.innerHTML = '<span style="color:#64748b;">No hay ex√°menes asignados</span>';
      return;
    }
    var html = '<div style="display:grid;gap:10px;">';
    res.data.forEach(function(e){
      var fecha = new Date(e.created_at).toLocaleDateString('es-MX');
      var deadline = e.fecha_limite ? new Date(e.fecha_limite).toLocaleDateString('es-MX') : 'Sin fecha l√≠mite';
      var estadoColors = {pendiente:'#f39c12', completado:'#2ecc71', vencido:'#e74c3c'};
      var estadoColor = estadoColors[e.estado] || '#94a3b8';
      html += '<div style="background:rgba(155,89,182,0.08);border:1px solid rgba(155,89,182,0.2);border-radius:10px;padding:12px;">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;">';
      html += '<div><strong style="color:#9b59b6;">' + e.titulo + '</strong>';
      html += '<div style="font-size:0.8em;color:#64748b;">üë§ ' + (e.student_name || e.student_email) + ' ‚Ä¢ üìÖ ' + fecha + ' ‚Ä¢ L√≠mite: ' + deadline + '</div>';
      if(e.descripcion) html += '<div style="font-size:0.8em;color:#94a3b8;margin-top:4px;">' + e.descripcion + '</div>';
      html += '</div>';
      html += '<div style="display:flex;gap:6px;align-items:center;">';
      html += '<span style="padding:4px 10px;background:' + estadoColor + ';color:#fff;border-radius:12px;font-size:0.75em;font-weight:bold;">' + e.estado.toUpperCase() + '</span>';
      if(e.estado === 'pendiente'){
        html += '<button onclick="markExamComplete(\'' + e.id + '\')" style="padding:4px 10px;background:#2ecc71;color:#000;border:none;border-radius:6px;font-size:0.8em;cursor:pointer;">‚úÖ Completar</button>';
      }
      html += '<button onclick="deleteExam(\'' + e.id + '\')" style="padding:4px 10px;background:#e74c3c;color:#fff;border:none;border-radius:6px;font-size:0.8em;cursor:pointer;">üóëÔ∏è</button>';
      html += '</div></div></div>';
    });
    html += '</div>';
    container.innerHTML = html;
  } catch(e){ container.innerHTML = '<span style="color:#e74c3c;">Error cargando ex√°menes</span>'; }
}

async function markExamComplete(id){
  var cal = prompt('Calificaci√≥n (0-100):');
  if(cal === null) return;
  await supabaseClient.from('assigned_exams').update({estado: 'completado', calificacion: parseInt(cal) || 0, updated_at: new Date().toISOString()}).eq('id', id);
  loadAdminExams();
}

async function deleteExam(id){
  if(!confirm('¬øEliminar este examen?')) return;
  await supabaseClient.from('assigned_exams').delete().eq('id', id);
  loadAdminExams();
}

// --- RECORDS DE PAGOS ---
async function registerPayment(){
  var email = document.getElementById('paymentStudentEmail').value;
  var amount = parseFloat(document.getElementById('paymentAmount').value);
  var concept = document.getElementById('paymentConcept').value.trim();
  if(!email){ alert('Selecciona un estudiante'); return; }
  if(!amount || amount <= 0){ alert('Ingresa un monto v√°lido'); return; }
  if(!concept){ alert('Escribe un concepto de pago'); return; }

  var method = document.getElementById('paymentMethod').value;
  var note = document.getElementById('paymentNote').value.trim();
  var selEl = document.getElementById('paymentStudentEmail');
  var studentName = selEl.options[selEl.selectedIndex].text.split('(')[0].trim();

  try {
    var res = await supabaseClient.from('payment_records').insert({
      student_email: email,
      student_name: studentName,
      monto: amount,
      concepto: concept,
      metodo_pago: method,
      nota: note || null
    });
    if(res.error) throw res.error;
    alert('‚úÖ Pago de $' + amount.toFixed(2) + ' registrado para ' + studentName);
    document.getElementById('paymentAmount').value = '';
    document.getElementById('paymentConcept').value = '';
    document.getElementById('paymentNote').value = '';
    loadAdminPayments();
  } catch(e){ alert('Error: ' + (e.message || e)); }
}

async function loadAdminPayments(){
  var container = document.getElementById('adminPaymentsList');
  if(!container) return;
  container.innerHTML = '<span style="color:#64748b;">Cargando...</span>';
  try {
    var searchEmail = (document.getElementById('paymentSearchEmail') || {}).value || '';
    var query = supabaseClient.from('payment_records').select('*').order('fecha_pago', {ascending: false}).limit(50);
    if(searchEmail.trim()) query = query.ilike('student_email', '%' + searchEmail.trim() + '%');
    var res = await query;
    if(!res.data || res.data.length === 0){
      container.innerHTML = '<span style="color:#64748b;">No hay records de pagos</span>';
      return;
    }
    var total = 0;
    var html = '';
    res.data.forEach(function(p){ total += parseFloat(p.monto) || 0; });
    html += '<div style="background:rgba(46,204,113,0.15);border-radius:10px;padding:10px;margin-bottom:10px;text-align:center;">';
    html += '<span style="color:#2ecc71;font-size:1.3em;font-weight:bold;">Total: $' + total.toFixed(2) + '</span>';
    html += '<span style="color:#64748b;font-size:0.85em;margin-left:10px;">(' + res.data.length + ' pagos)</span></div>';
    html += '<div style="display:grid;gap:8px;">';
    res.data.forEach(function(p){
      var fecha = new Date(p.fecha_pago).toLocaleDateString('es-MX');
      var methodIcons = {efectivo:'üíµ',stripe:'üí≥',zelle:'üì±',check:'üè¶',otro:'üìù'};
      var icon = methodIcons[p.metodo_pago] || 'üí∞';
      html += '<div style="background:rgba(46,204,113,0.06);border:1px solid rgba(46,204,113,0.2);border-radius:10px;padding:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;">';
      html += '<div><strong style="color:#2ecc71;">$' + parseFloat(p.monto).toFixed(2) + '</strong> ' + icon;
      html += '<div style="font-size:0.8em;color:#64748b;">üë§ ' + (p.student_name || p.student_email) + ' ‚Ä¢ ' + p.concepto + ' ‚Ä¢ ' + fecha + '</div>';
      if(p.nota) html += '<div style="font-size:0.75em;color:#94a3b8;">üìù ' + p.nota + '</div>';
      html += '</div>';
      html += '<button onclick="deletePayment(\'' + p.id + '\')" style="padding:4px 10px;background:#e74c3c;color:#fff;border:none;border-radius:6px;font-size:0.8em;cursor:pointer;">üóëÔ∏è</button>';
      html += '</div>';
    });
    html += '</div>';
    container.innerHTML = html;
  } catch(e){ container.innerHTML = '<span style="color:#e74c3c;">Error cargando pagos</span>'; }
}

async function deletePayment(id){
  if(!confirm('¬øEliminar este registro de pago?')) return;
  await supabaseClient.from('payment_records').delete().eq('id', id);
  loadAdminPayments();
}

// --- Load student data in student profile ---
async function loadStudentBooks(email){
  var container = document.getElementById('studentWorkbooks');
  if(!container) return;
  try {
    var res = await supabaseClient.from('student_books').select('*').eq('activo', true).or('asignado_a.eq.todos,asignado_a.eq.' + email).order('created_at', {ascending: false});
    if(!res.data || res.data.length === 0){
      container.innerHTML = 'No hay libros disponibles a√∫n';
      return;
    }
    var html = '';
    res.data.forEach(function(b){
      html += '<div style="background:#f8fafc;border-radius:10px;padding:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">';
      html += '<div><strong>' + b.titulo + '</strong><br><span style="font-size:0.8em;color:#64748b;">' + b.categoria + '</span></div>';
      html += '<a href="' + b.file_url + '" target="_blank" style="padding:8px 16px;background:#3498db;color:#fff;border-radius:8px;text-decoration:none;font-weight:bold;">üì• Descargar</a>';
      html += '</div>';
    });
    container.innerHTML = html;
  } catch(e){ container.innerHTML = 'Error cargando libros'; }
}

async function loadStudentExams(email){
  var container = document.getElementById('studentExamsList');
  if(!container) return;
  try {
    var res = await supabaseClient.from('assigned_exams').select('*').eq('student_email', email).order('created_at', {ascending: false});
    if(!res.data || res.data.length === 0){
      container.innerHTML = 'No tienes ex√°menes asignados';
      return;
    }
    var html = '';
    res.data.forEach(function(e){
      var estadoColors = {pendiente:'#f39c12', completado:'#2ecc71', vencido:'#e74c3c'};
      var color = estadoColors[e.estado] || '#94a3b8';
      html += '<div style="background:#f8fafc;border-radius:10px;padding:12px;margin-bottom:8px;">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
      html += '<strong>' + e.titulo + '</strong>';
      html += '<span style="padding:3px 10px;background:' + color + ';color:#fff;border-radius:12px;font-size:0.75em;">' + e.estado.toUpperCase() + '</span></div>';
      if(e.descripcion) html += '<p style="font-size:0.85em;color:#64748b;margin:6px 0 0 0;">' + e.descripcion + '</p>';
      if(e.calificacion !== null && e.estado === 'completado') html += '<p style="font-size:0.9em;color:#2ecc71;margin:4px 0 0 0;font-weight:bold;">Calificaci√≥n: ' + e.calificacion + '/100</p>';
      html += '</div>';
    });
    container.innerHTML = html;
  } catch(e){ container.innerHTML = 'Error cargando ex√°menes'; }
}

async function loadStudentPayments(email){
  var container = document.getElementById('studentPaymentRecords');
  if(!container) return;
  try {
    var res = await supabaseClient.from('payment_records').select('*').eq('student_email', email).order('fecha_pago', {ascending: false});
    if(!res.data || res.data.length === 0){
      container.innerHTML = 'No hay records de pagos';
      return;
    }
    var html = '';
    res.data.forEach(function(p){
      var fecha = new Date(p.fecha_pago).toLocaleDateString('es-MX');
      html += '<div style="background:#f8fafc;border-radius:10px;padding:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">';
      html += '<div><strong style="color:#2ecc71;">$' + parseFloat(p.monto).toFixed(2) + '</strong> - ' + p.concepto;
      html += '<div style="font-size:0.8em;color:#64748b;">' + fecha + ' ‚Ä¢ ' + p.metodo_pago + '</div></div>';
      html += '</div>';
    });
    container.innerHTML = html;
  } catch(e){ container.innerHTML = 'Error cargando pagos'; }
}

// Hook into admin dashboard load
var _origLoadAdmin = window.loadAdminDashboard;
window.loadAdminDashboard = function(){
  if(typeof _origLoadAdmin === 'function') _origLoadAdmin();
  populateStudentDropdowns();
  loadAdminBooks();
  loadAdminExams();
  loadAdminPayments();
};
// Auto-load if admin dashboard is already visible
if(document.getElementById('adminDashboardScreen') && document.getElementById('adminDashboardScreen').classList.contains('active')){
  populateStudentDropdowns(); loadAdminBooks(); loadAdminExams(); loadAdminPayments();
}
</script>


<!-- TUTOR IA MAESTRO MARIO WIDGET v3 -->
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
#maestroFloat{display:none}
.maestro-q-btn{display:block;margin:14px auto 0;cursor:pointer;position:relative;width:55px;height:55px}
.maestro-q-btn .mf-ring{position:absolute;inset:-4px;border-radius:50%;border:3px solid transparent;border-top:3px solid #f97316;border-right:3px solid #f97316;animation:mfSpin 1.5s linear infinite}
.maestro-q-btn .mf-ring2{position:absolute;inset:-8px;border-radius:50%;border:2px solid transparent;border-bottom:2px solid #fb923c;border-left:2px solid #fb923c;animation:mfSpin 2.5s linear infinite reverse}
@keyframes mfSpin{to{transform:rotate(360deg)}}
.maestro-q-btn .mf-photo{width:55px;height:55px;border-radius:50%;overflow:hidden;box-shadow:0 4px 20px rgba(249,115,22,0.5)}
.maestro-q-btn .mf-photo img{width:100%;height:100%;object-fit:cover}
.maestro-q-btn .mf-play{position:absolute;bottom:-2px;right:-2px;width:26px;height:26px;background:linear-gradient(135deg,#f97316,#ea580c);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(249,115,22,0.5);border:2px solid #f8fafc}
.maestro-q-btn .mf-play svg{width:12px;height:12px;fill:white;margin-left:1px}
.maestro-q-btn .mf-label{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);white-space:nowrap;font-size:9px;color:#f97316;font-weight:bold;letter-spacing:0.5px}
.maestro-q-btn .mf-pulse{position:absolute;inset:-12px;border-radius:50%;background:rgba(249,115,22,0.15);animation:mfPulse 2s ease-in-out infinite}
@keyframes mfPulse{0%,100%{transform:scale(1);opacity:0.4}50%{transform:scale(1.15);opacity:0}}
.m-flash{position:fixed;inset:0;background:white;z-index:1001;opacity:0;pointer-events:none}
.m-flash.active{animation:mFlash .8s ease-out}
@keyframes mFlash{0%{opacity:0}15%{opacity:1}30%{opacity:0}45%{opacity:.7}60%{opacity:0}75%{opacity:.3}100%{opacity:0}}
.m-battle{position:fixed;inset:0;z-index:1002;display:none;flex-direction:column;background:linear-gradient(180deg,#0d1117,#161b28 40%,#1e2640);overflow:hidden;height:100vh;height:100dvh}
.m-battle.active{display:flex}
.m-banner{text-align:center;padding:10px 20px 0;opacity:0}
.m-banner.show{animation:mBanIn .5s ease forwards}
@keyframes mBanIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
.m-banner-label{font-family:'Press Start 2P',monospace;font-size:7px;color:#f97316;letter-spacing:2px;text-shadow:0 0 20px rgba(249,115,22,.5)}
.m-banner-title{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:4px;color:#fff}
.m-banner-title span{color:#f97316}
.m-stage{flex:0 0 auto;display:flex;align-items:center;justify-content:center;padding:5px 20px;height:130px;position:relative}
.m-avatar-wrap{position:relative;transform:translateX(120vw)}
.m-avatar-wrap.slide-in{animation:mSlide .8s cubic-bezier(.2,.8,.2,1) forwards}
@keyframes mSlide{0%{transform:translateX(120vw) scale(.5)}60%{transform:translateX(-10px) scale(1.05)}80%{transform:translateX(5px) scale(.98)}100%{transform:translateX(0) scale(1)}}
.m-avatar-wrap.idle{animation:mBr 3s ease-in-out infinite}
@keyframes mBr{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
.m-avatar-wrap.talking{animation:mTk .4s ease-in-out infinite}
@keyframes mTk{0%,100%{transform:translateY(0) rotate(0)}25%{transform:translateY(-3px) rotate(-.5deg)}75%{transform:translateY(-2px) rotate(.5deg)}}
.m-avatar-img{width:90px;height:90px;border-radius:50%;overflow:hidden;border:3px solid #f97316;box-shadow:0 0 40px rgba(249,115,22,.3)}
.m-avatar-img img{width:100%;height:100%;object-fit:cover}
.m-avatar-img.speaking{box-shadow:0 0 40px rgba(249,115,22,.3),0 0 0 6px rgba(249,115,22,.2)}
.m-nametag{position:absolute;bottom:-24px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);border:1.5px solid #f97316;border-radius:6px;padding:3px 10px;white-space:nowrap;font-family:'Press Start 2P',monospace;font-size:7px;color:#f97316}
.m-waves{position:absolute;bottom:-38px;left:50%;transform:translateX(-50%);display:none;gap:3px;align-items:flex-end;height:16px}
.m-waves.active{display:flex}
.m-wave-bar{width:3px;background:#f97316;border-radius:2px;animation:mW .8s ease-in-out infinite}
.m-wave-bar:nth-child(1){height:5px}.m-wave-bar:nth-child(2){height:10px;animation-delay:.1s}.m-wave-bar:nth-child(3){height:16px;animation-delay:.2s}.m-wave-bar:nth-child(4){height:10px;animation-delay:.3s}.m-wave-bar:nth-child(5){height:5px;animation-delay:.4s}
@keyframes mW{0%,100%{transform:scaleY(.4)}50%{transform:scaleY(1)}}
.m-chat-area{flex:1;overflow-y:auto;padding:10px 16px;display:flex;flex-direction:column;gap:10px}
.m-msg{display:flex;gap:8px;max-width:90%;animation:mMI .3s ease}
@keyframes mMI{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.m-msg.user{align-self:flex-end;flex-direction:row-reverse}
.m-msg-avatar{width:28px;height:28px;border-radius:8px;flex-shrink:0;overflow:hidden}
.m-msg-avatar img{width:100%;height:100%;object-fit:cover}
.m-msg-bubble{padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.5}
.m-msg.assistant .m-msg-bubble{background:#1a1a2e;border:1px solid rgba(249,115,22,.3);color:#f1f3f7;border-bottom-left-radius:4px}
.m-msg.user .m-msg-bubble{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;border-bottom-right-radius:4px}
.m-msg-bubble strong{color:#f97316}
.m-msg-bubble code{background:rgba(249,115,22,.15);color:#f97316;padding:1px 5px;border-radius:3px;font-size:12px;font-family:monospace}
.m-typing{display:flex;gap:8px;max-width:90%}
.m-typing-dots{background:#1a1a2e;border:1px solid rgba(249,115,22,.3);border-radius:14px;padding:12px 18px;display:flex;gap:4px}
.m-typing-dots span{width:6px;height:6px;border-radius:50%;background:#f97316;animation:mTy 1.4s ease-in-out infinite}
.m-typing-dots span:nth-child(2){animation-delay:.2s}.m-typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes mTy{0%,60%,100%{transform:translateY(0);opacity:.3}30%{transform:translateY(-5px);opacity:1}}
.m-input-area{padding:10px 16px 16px;background:rgba(10,12,16,.95);border-top:1px solid rgba(249,115,22,.2);position:sticky;bottom:0;z-index:10}
.m-input-wrap{display:flex;gap:8px;align-items:center}
.m-input{flex:1;background:#1c2130;border:1.5px solid rgba(249,115,22,.3);border-radius:12px;padding:10px 14px;color:#f1f3f7;font-size:14px;resize:none;outline:none;min-height:42px;max-height:100px;line-height:1.4}
.m-input::placeholder{color:#5a6478}
.m-input:focus{border-color:#f97316;box-shadow:0 0 0 3px rgba(249,115,22,.15)}
.m-send{width:42px;height:42px;border-radius:12px;border:none;background:linear-gradient(135deg,#f97316,#ea580c);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.m-send:disabled{opacity:.4}
.m-close-bar{display:flex;justify-content:space-between;align-items:center;padding:8px 16px;background:rgba(10,12,16,.95)}
.m-close-btn{background:none;border:1px solid rgba(255,255,255,.2);color:#ccc;padding:6px 16px;border-radius:8px;font-size:13px;cursor:pointer}
.m-close-btn:hover{border-color:#f97316;color:#f97316}
.m-powered{font-size:9px;color:#5a6478}.m-powered span{color:#f97316}
@media(max-width:600px){.m-avatar-img{width:70px;height:70px}.m-banner-title{font-size:20px}.m-banner-label{font-size:6px}.m-stage{height:100px;padding:2px 10px}.m-banner{padding:6px 10px 0}.m-close-bar{padding:4px 10px}.maestro-q-btn{width:48px;height:48px}.maestro-q-btn .mf-photo{width:48px;height:48px}.mf-play{width:20px!important;height:20px!important}.mf-play svg{width:10px!important;height:10px!important}.mf-label{font-size:7px!important}.m-input{font-size:16px}}
</style>

<div id="maestroFloat" style="display:none"></div>
<div class="m-flash" id="mFlash"></div>
<div class="m-battle" id="mBattle">
<div class="m-close-bar">
<div class="m-powered">Powered by <span>Nivel 33</span></div>
<button class="m-close-btn" onclick="closeMaestroTutor()">&#x2715; Cerrar</button>
</div>
<div class="m-banner" id="mBanner">
<div class="m-banner-label">&#161; PREG&#218;NTALE AL MAESTRO !</div>
<div class="m-banner-title">MAESTRO <span>MARIO</span></div>
</div>
<div class="m-stage">
<div class="m-avatar-wrap" id="mAvatarWrap">
<div class="m-avatar-img" id="mAvatarImg"><img id="mAvatarPhoto" src="data:image/jpeg;base64,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" alt="Maestro Mario"></div>
<div class="m-nametag">LV.33 MAESTRO MARIO</div>
<div class="m-waves" id="mWaves"><div class="m-wave-bar"></div><div class="m-wave-bar"></div><div class="m-wave-bar"></div><div class="m-wave-bar"></div><div class="m-wave-bar"></div></div>
</div>
</div>
<div class="m-chat-area" id="mChatArea"></div>
<div class="m-input-area">
<div class="m-input-wrap">
<textarea class="m-input" id="mInput" placeholder="Pregunta lo que quieras..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMaestroMsg();}" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px';"></textarea>
<button class="m-send" id="mSendBtn" onclick="sendMaestroMsg()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
</div>
</div>
</div>

<script>
var PROMOS=[
'\n\nüìö \u00bfQuieres dominar estos temas? Inscr\u00edbete en **La Trinidad del Oficio** \u2014 nuestro programa de 12 meses con Maestro Mario. Info: maestromario.com',
'\n\nüîß \u00bfEres t\u00e9cnico independiente? **Trade Master CRM** te ayuda a organizar tus clientes, despacho GPS, estimados y firmas digitales. Vis\u00edtanos: trademastersusa.org',
'\n\nüéì **ACVOLT Tech School** \u2014 Clases presenciales y en l\u00ednea de aires acondicionados, calefacci\u00f3n, refrigeraci\u00f3n y el\u00e9ctrico. \u00a1Certif\u00edcate con nosotros! maestromario.com',
'\n\nüéô\uFE0F Escucha el podcast **Nivel 33** todos los d\u00edas \u2014 liderazgo, t\u00e9cnica, ventas y m\u00e1s para t\u00e9cnicos que quieren crecer. B\u00fascalo en todas las plataformas.',
'\n\nüíº \u00bfQuieres emprender tu propio negocio de servicios? El programa **Maestros del Oficio** te ense\u00f1a c\u00f3mo. Contacta: maestromario.com',
'\n\nüì≤ Descarga la app **MaestroAC** \u2014 ex\u00e1menes de pr\u00e1ctica, videos, niveles y tutor\u00eda con IA. \u00a1Todo gratis para estudiantes de ACVOLT!'
];
var _promoIdx=0;
var _mHist=[],_mBusy=false,_mAudUrl=null;
(function(){
var SB_URL='https://htklsowiyjwsjnacnvnr.supabase.co';
var SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0a2xzb3dpeWp3c2puYWNudm5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NjIwMjQsImV4cCI6MjA4NjAzODAyNH0.6A3F7MI4YJEMo98b4Zfzao9p_hMh2T0ha0dRJ4SUhv0';
var CHAT=SB_URL+'/functions/v1/tutor-ia-chat';
var VOICE=SB_URL+'/functions/v1/tutor-ia-voice';
var SYS='Eres Maestro Mario (Mario Flores Corona), instructor master con m\u00e1s de 25 a\u00f1os de experiencia en Aires Acondicionados, Calefacci\u00f3n, Refrigeraci\u00f3n y Sistemas El\u00e9ctricos. Hablas en espa\u00f1ol, directo pero amable, como un maestro de taller. Usas analog\u00edas pr\u00e1cticas del campo. NUNCA uses palabras en ingl\u00e9s, traduce todo al espa\u00f1ol. En vez de HVAC di \"aires acondicionados y calefacci\u00f3n\". En vez de compressor di \"compresor\". En vez de condenser di \"condensador\". La frase \"Si no mides, est\u00e1s adivinando\" SOLO la usas cuando el estudiante hace preguntas de DIAGN\u00d3STICO, no la repitas en cada respuesta. Seguridad PRIMERO siempre. M\u00e1ximo 150 palabras. Usa **negritas** para conceptos clave. Usa puntuaci\u00f3n correcta: \u00bfpreguntas?, \u00a1exclamaciones!, acentos, \u00f1. Siempre especifica unidades completas: grados Fahrenheit o grados Celsius, nunca solo grados. El estudiante puede preguntar sobre CUALQUIER tema. NUNCA digas \"quiz\", siempre di \"examen de pr\u00e1ctica\". REGLA IMPORTANTE SOBRE RLA: El RLA (Running Load Amps) es el MAXIMO amperaje permitido por el fabricante, NO es el consumo normal de operaci\u00f3n. Un compresor funcionando correctamente opera entre 60-80% del RLA. Si un motor llega al 100% del RLA ya est\u00e1 en problemas. NUNCA digas que el RLA es el consumo normal. El RLA es el l\u00edmite que NO se debe alcanzar en operaci\u00f3n normal. REGLA DE HONESTIDAD: Si no est\u00e1s 100% seguro de un dato t\u00e9cnico espec\u00edfico (valores, temperaturas, presiones, amperajes), dilo: \"Confirma este dato con el manual del fabricante o con tu instructor\". Es mejor ser honesto que dar informaci\u00f3n incorrecta. NUNCA inventes valores num\u00e9ricos si no est\u00e1s seguro. IMPORTANTE: T\u00fa eres una herramienta de IA de apoyo educativo, NO eres el Maestro Mario real. ESPA√ëOL: Usa espa√±ol mexicano neutro, que es el m√°s claro y universal para toda Latinoam√©rica. NUNCA uses regionalismos de otros pa√≠ses como \"dale\", \"che\", \"boludo\", \"vos\", \"pibe\", \"t√≠o\", \"vale\", \"coger\". Usa expresiones neutras mexicanas como \"te explico\", \"mira\", \"f√≠jate\", \"√≥rale\". El tono es profesional pero cercano, como un maestro de taller mexicano. Si el estudiante pregunta algo cr\u00edtico de seguridad o instalaci\u00f3n, siempre agrega: \"Verifica con tu instructor y el manual del fabricante antes de aplicar en campo.\"';
var DISCLAIMER='\n\n<em style="font-size:11px;color:#94a3b8;">Y te recuerdo, esta es una herramienta de inteligencia artificial para apoyo educativo.</em>';
var avatarB64='data:image/jpeg;base64,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';
var quizScreens=['quizScreen','quizOnlyScreen','certCourseScreen'];
var allScreens=['studySectionsScreen','studyCategoryDetailScreen','quizScreen','quizOnlyScreen','videoPlayerScreen','levelsScreen','certCourseScreen'];

function injectBtn(){
var active=document.querySelector('.screen.active');
if(!active)return;
if(quizScreens.indexOf(active.id)>=0){
var qEl=active.querySelector('#questionText,#certQuestionText');
if(qEl&&!qEl.querySelector('.maestro-q-btn')){
var btn=document.createElement('div');
btn.className='maestro-q-btn';
btn.innerHTML='<div class="mf-pulse"></div><div class="mf-ring2"></div><div class="mf-ring"></div><div class="mf-photo"><img src="'+avatarB64+'" alt="Maestro Mario"></div><div class="mf-play"><svg viewBox="0 0 24 24"><polygon points="8,5 20,12 8,19"/></svg></div><div class="mf-label">Maestro Mario</div>';
btn.onclick=function(e){e.stopPropagation();openMaestroTutor();};
qEl.appendChild(btn);
}
}
}

function cleanOldBtns(){
document.querySelectorAll('.maestro-q-btn').forEach(function(b){
if(!b.closest('.screen.active'))b.remove();
});
}

var _mqObserver=new MutationObserver(function(){cleanOldBtns();injectBtn();});
_mqObserver.observe(document.body,{childList:true,subtree:true,attributes:true,attributeFilter:['class']});

function getName(){
try{
var el=document.getElementById('userGreeting');
if(el&&el.textContent){
var t=el.textContent.replace('Hola, ','').replace('hola, ','').trim();
if(t&&t.length>1&&t!=='T\u00e9cnico'){
var name=t.split(' ')[0];
return name.charAt(0).toUpperCase()+name.slice(1);
}
}
if(window.currentUser&&window.currentUser.nombre){
var n=window.currentUser.nombre.split(' ')[0];
return n.charAt(0).toUpperCase()+n.slice(1);
}
}catch(e){}
return 'Estudiante';
}

function getCurrentQuestion(){
try{
var active=document.querySelector('.screen.active');
if(!active)return null;
var qEl=active.querySelector('#questionText,#certQuestionText,.study-question-text,.question-text');
if(qEl&&qEl.textContent.trim().length>10)return qEl.textContent.trim();
}catch(e){}
return null;
}

window.openMaestroTutor=function(){
var fl=document.getElementById('mFlash');fl.classList.add('active');setTimeout(function(){fl.classList.remove('active');},800);
setTimeout(function(){
document.getElementById('mBattle').classList.add('active');
document.getElementById('mBanner').classList.add('show');
var av=document.getElementById('mAvatarWrap');
setTimeout(function(){av.classList.add('slide-in');setTimeout(function(){av.classList.remove('slide-in');av.classList.add('idle');},900);},400);
if(_mHist.length===0){
var q=getCurrentQuestion();
if(q){
var greeting='\u00bfQu\u00e9 tal Colega! \u00bfEn qu\u00e9 te puedo ayudar hoy?';
setTimeout(function(){addM('assistant',greeting);},1200);
_mHist.push({role:'user',content:'Estoy en esta pregunta del examen de pr\u00e1ctica: '+q});
_mHist.push({role:'assistant',content:greeting});
}else{
var greeting2='\u00bfQu\u00e9 tal Colega! \u00bfEn qu\u00e9 te puedo ayudar hoy?';
setTimeout(function(){addM('assistant',greeting2);},1200);
}
}
setTimeout(function(){document.getElementById('mInput').focus();},1500);
},500);
};

window.closeMaestroTutor=function(){
if(_mAudioEl){_mAudioEl.pause();_mAudioEl.onended=null;_mAudioEl.onerror=null;}
if(_mAudUrl){try{URL.revokeObjectURL(_mAudUrl);}catch(e){}_mAudUrl=null;}
document.getElementById('mBattle').classList.remove('active');
document.getElementById('mBanner').classList.remove('show');
var av=document.getElementById('mAvatarWrap');av.classList.remove('slide-in','idle','talking');
document.getElementById('mAvatarImg').classList.remove('speaking');
document.getElementById('mWaves').classList.remove('active');
};

function addM(role,content){
var area=document.getElementById('mChatArea'),div=document.createElement('div');
div.className='m-msg '+role;
var html=content.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/`([^`]+)`/g,'<code>$1</code>').replace(/\n/g,'<br>');
var src=document.getElementById('mAvatarPhoto').src;
var avH=role==='assistant'?'<img src="'+src+'" alt="M">':'<div style="width:28px;height:28px;background:#2563eb;border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-size:14px">T</div>';
div.innerHTML='<div class="m-msg-avatar">'+avH+'</div><div class="m-msg-bubble">'+html+'</div>';
area.appendChild(div);area.scrollTop=area.scrollHeight;
if(role==='assistant'){var clean=content.replace(/\*\*/g,'').replace(/`/g,'').replace(/\n/g,' ');spk(clean.substring(0,1500));}
}

function showT(){var area=document.getElementById('mChatArea'),div=document.createElement('div');div.className='m-typing';div.id='mTp';var src=document.getElementById('mAvatarPhoto').src;div.innerHTML='<div class="m-msg-avatar"><img src="'+src+'" style="width:100%;height:100%;object-fit:cover;border-radius:8px"></div><div class="m-typing-dots"><span></span><span></span><span></span></div>';area.appendChild(div);area.scrollTop=area.scrollHeight;}
function hideT(){var el=document.getElementById('mTp');if(el)el.remove();}

// Sistema de l√≠mite de preguntas AI - 5 por semana
function getAIQuestionsUsed(){
  var data = localStorage.getItem('maestroai_usage');
  if(!data) return {count:0, weekStart:Date.now()};
  var parsed = JSON.parse(data);
  var weekMs = 7*24*60*60*1000;
  if(Date.now() - parsed.weekStart > weekMs){
    return {count:0, weekStart:Date.now()};
  }
  return parsed;
}
function saveAIQuestion(){
  var usage = getAIQuestionsUsed();
  usage.count++;
  localStorage.setItem('maestroai_usage', JSON.stringify(usage));
  // Guardar m√©trica en Supabase
  if(window.currentUser && window.supabaseClient){
    window.supabaseClient.from('ai_usage_metrics').insert({
      user_id: window.currentUser.id,
      user_email: window.currentUser.email,
      timestamp: new Date().toISOString()
    }).then(function(){}).catch(function(){});
  }
}
function isAppPurchased(){
  // AI flotante: TODOS tienen l√≠mite de 5 preguntas/semana, nadie tiene ilimitado
  return false;
}
function showAIPaywall(){
  var modal = document.createElement('div');
  modal.id = 'aiPaywallModal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;';
  modal.innerHTML = '<div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:20px;padding:30px;max-width:380px;text-align:center;border:2px solid #f97316;">' +
    '<div style="font-size:50px;margin-bottom:15px;">üîí</div>' +
    '<h2 style="color:#f97316;margin-bottom:10px;font-size:22px;">¬°Llegaste al l√≠mite semanal!</h2>' +
    '<p style="color:#94a3b8;margin-bottom:20px;font-size:14px;">Has usado tus <strong style="color:white;">5 preguntas gratis</strong> de Maestro Mario AI esta semana.</p>' +
    '<div style="background:#0d1117;border-radius:12px;padding:15px;margin-bottom:20px;">' +
    '<p style="color:#22c55e;font-size:28px;font-weight:bold;margin:0;">$20<span style="font-size:14px;color:#64748b;">/mes</span></p>' +
    '<p style="color:#64748b;font-size:12px;margin:5px 0 0 0;">Preguntas ILIMITADAS al AI</p>' +
    '</div>' +
    '<p style="color:white;font-size:13px;margin-bottom:20px;text-align:left;padding-left:20px;">‚úÖ Maestro Mario AI ilimitado<br>‚úÖ Todos los niveles desbloqueados<br>‚úÖ +700 preguntas de pr√°ctica<br>‚úÖ Certificados incluidos</p>' +
    '<button onclick="window.open(\'https://buy.stripe.com/fZu5kD9U32cU1ojaYv3sI07\',\'_blank\');document.getElementById(\'aiPaywallModal\').remove();" style="background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;border:none;padding:16px 30px;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer;width:100%;margin-bottom:10px;box-shadow:0 4px 15px rgba(99,102,241,0.4);">üí≥ Suscribirme Ahora - $20/mes</button>' +
    '<button onclick="document.getElementById(\'aiPaywallModal\').remove()" style="background:transparent;color:#64748b;border:1px solid #64748b;padding:10px 20px;border-radius:8px;font-size:13px;cursor:pointer;width:100%;">Seguir con l√≠mite gratis</button>' +
    '</div>';
  document.body.appendChild(modal);
}

window.sendMaestroMsg=function(){
var inp=document.getElementById('mInput'),txt=inp.value.trim();
if(!txt||_mBusy)return;

// Verificar l√≠mite de preguntas (5/semana) si no ha comprado
if(!isAppPurchased()){
  var usage = getAIQuestionsUsed();
  if(usage.count >= 5){
    showAIPaywall();
    return;
  }
}

_mBusy=true;document.getElementById('mSendBtn').disabled=true;
addM('user',txt);_mHist.push({role:'user',content:txt});if(_mHist.length>20)_mHist=_mHist.slice(-20);inp.value='';inp.style.height='auto';
var av=document.getElementById('mAvatarWrap');av.classList.remove('idle');av.classList.add('talking');showT();
var sys2=SYS;
var ctrl=new AbortController();var tid=setTimeout(function(){ctrl.abort();},30000);
fetch(CHAT,{method:'POST',signal:ctrl.signal,headers:{'Content-Type':'application/json','Authorization':'Bearer '+SB_KEY,'apikey':SB_KEY},body:JSON.stringify({messages:_mHist,system:sys2,max_tokens:400})}).then(function(r){clearTimeout(tid);return r.json();}).then(function(d){
hideT();if(d.content&&d.content.length>0){
  // Guardar uso de pregunta AI
  if(!isAppPurchased()) saveAIQuestion();
  var rp=d.content.map(function(c){return c.text||'';}).join('\n');rp+=PROMOS[Math.floor(Math.random()*PROMOS.length)];_mHist.push({role:'assistant',content:rp});addM('assistant',rp);
  // Mostrar contador de preguntas restantes si no ha comprado
  if(!isAppPurchased()){
    var usage = getAIQuestionsUsed();
    var remaining = 5 - usage.count;
    if(remaining > 0 && remaining <= 3){
      addM('assistant','<em style="font-size:11px;color:#f97316;">‚ö†Ô∏è Te quedan '+remaining+' pregunta'+(remaining===1?'':'s')+' gratis esta semana.</em>');
    }
  }
}else{addM('assistant','Hubo un problema, intenta de nuevo.');}
}).catch(function(){hideT();addM('assistant','Error de conexion.');}).finally(function(){
av.classList.remove('talking');av.classList.add('idle');_mBusy=false;document.getElementById('mSendBtn').disabled=false;inp.focus();
});
};

var _mAudioUnlocked=false;
var _mAudioEl=null;

function unlockAudio(){
if(_mAudioUnlocked)return;
_mAudioEl=new Audio();
_mAudioEl.src='data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAAAgAAAbAAqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAbD/2Q==';
_mAudioEl.play().then(function(){_mAudioUnlocked=true;_mAudioEl.pause();}).catch(function(){});
}
document.addEventListener('touchstart',unlockAudio,{once:true});
document.addEventListener('click',unlockAudio,{once:true});

function spk(text,cb){
try{
if(_mAudUrl){URL.revokeObjectURL(_mAudUrl);_mAudUrl=null;}
}catch(e){}
var av=document.getElementById('mAvatarWrap'),img=document.getElementById('mAvatarImg'),wav=document.getElementById('mWaves');
fetch(VOICE,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+SB_KEY,'apikey':SB_KEY},body:JSON.stringify({text:text.substring(0,2000)})}).then(function(r){
if(!r.ok)throw new Error('Voice API error');
return r.blob();
}).then(function(b){
if(b.size<100||b.type.indexOf('json')>=0){if(cb)cb();return;}
_mAudUrl=URL.createObjectURL(b);
if(!_mAudioEl)_mAudioEl=new Audio();
_mAudioEl.onended=null;_mAudioEl.onerror=null;
_mAudioEl.src=_mAudUrl;
av.classList.remove('idle');av.classList.add('talking');img.classList.add('speaking');wav.classList.add('active');
_mAudioEl.play().catch(function(e){
console.log('Play failed:',e);
av.classList.remove('talking');av.classList.add('idle');img.classList.remove('speaking');wav.classList.remove('active');
if(cb)cb();
});
_mAudioEl.onended=function(){
av.classList.remove('talking');av.classList.add('idle');img.classList.remove('speaking');wav.classList.remove('active');
try{URL.revokeObjectURL(_mAudUrl);}catch(e){}
_mAudUrl=null;
if(cb)cb();
};
_mAudioEl.onerror=function(){
av.classList.remove('talking');av.classList.add('idle');img.classList.remove('speaking');wav.classList.remove('active');
try{URL.revokeObjectURL(_mAudUrl);}catch(e){}
_mAudUrl=null;
if(cb)cb();
};
}).catch(function(e){console.log('Voice error:',e);if(cb)cb();});
}
})();
</script>

<!-- ACVOLT AI ASSISTANT - Asistente Unificado -->
<style>
#acvoltAI{position:fixed;top:180px;right:15px;z-index:960;display:none;flex-direction:column;align-items:flex-end;gap:8px;width:340px;animation:aiIn .4s ease}
@keyframes aiIn{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
#acvoltAI .ai-panel{background:linear-gradient(135deg,#0d1117,#161b22);border:1.5px solid rgba(243,156,18,0.3);border-radius:18px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.5);display:flex;flex-direction:column;max-height:440px}
#acvoltAI .ai-head{background:linear-gradient(135deg,#f39c12,#e67e22);padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
#acvoltAI .ai-head-left{display:flex;align-items:center;gap:10px;color:white}
#acvoltAI .ai-head-left .ai-avatar-sm{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:18px}
#acvoltAI .ai-head-left div:last-child{line-height:1.3}
#acvoltAI .ai-title{font-size:13px;font-weight:bold}
#acvoltAI .ai-subtitle{font-size:10px;opacity:0.85}
#acvoltAI .ai-close{background:none;border:none;color:rgba(255,255,255,0.7);font-size:20px;cursor:pointer;padding:4px 8px;line-height:1}
#acvoltAI .ai-close:hover{color:white}
.ai-msgs{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px;max-height:280px;min-height:60px}
.ai-m{padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.5;max-width:88%;animation:aiIn .3s ease;word-wrap:break-word}
.ai-m.b{background:rgba(243,156,18,0.08);color:#e2e8f0;border:1px solid rgba(243,156,18,0.15);align-self:flex-start;border-bottom-left-radius:4px}
.ai-m.u{background:linear-gradient(135deg,#f39c12,#e67e22);color:white;align-self:flex-end;border-bottom-right-radius:4px}
.ai-m strong{color:#f39c12}
.ai-qk{display:flex;flex-wrap:wrap;gap:5px;padding:4px 12px 8px}
.ai-qk button{background:rgba(243,156,18,0.1);border:1px solid rgba(243,156,18,0.25);color:#f39c12;padding:6px 11px;border-radius:20px;font-size:11px;cursor:pointer;transition:all .2s;white-space:nowrap}
.ai-qk button:hover{background:rgba(243,156,18,0.25)}
.ai-inp{padding:10px 12px;border-top:1px solid rgba(243,156,18,0.15);display:flex;gap:8px;background:rgba(13,17,23,0.5)}
.ai-inp input{flex:1;background:#1c2130;border:1px solid rgba(243,156,18,0.2);border-radius:12px;padding:10px 14px;color:#f1f3f7;font-size:13px;outline:none}
.ai-inp input:focus{border-color:#f39c12}
.ai-inp button{width:38px;height:38px;border-radius:12px;border:none;background:linear-gradient(135deg,#f39c12,#e67e22);color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.ai-dots{display:flex;gap:4px;padding:10px 14px;align-self:flex-start}
.ai-dots span{width:5px;height:5px;border-radius:50%;background:#f39c12;animation:mTy 1.4s ease-in-out infinite}
.ai-dots span:nth-child(2){animation-delay:.2s}
.ai-dots span:nth-child(3){animation-delay:.4s}
#acvoltBtn{position:fixed;top:135px;right:12px;z-index:961;width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#f39c12,#e67e22);border:3px solid rgba(243,156,18,0.8);display:flex;align-items:center;justify-content:center;font-size:26px;cursor:pointer;box-shadow:0 0 0 0 rgba(243,156,18,0.5);animation:aiRingPulse 2s ease infinite;transition:all .3s}
#acvoltBtn:hover{transform:scale(1.1)}
#acvoltBtn.speaking{animation:aiPulse 1.5s ease-in-out infinite}
@keyframes aiRingPulse{0%{box-shadow:0 0 0 0 rgba(243,156,18,0.6);}70%{box-shadow:0 0 0 12px rgba(243,156,18,0);}100%{box-shadow:0 0 0 0 rgba(243,156,18,0);}}
@keyframes aiPulse{0%,100%{box-shadow:0 4px 24px rgba(243,156,18,0.5)}50%{box-shadow:0 4px 35px rgba(243,156,18,0.7),0 0 0 10px rgba(243,156,18,0.12)}}
.ai-bdg{position:absolute;top:-3px;right:-3px;min-width:18px;height:18px;background:#e74c3c;border-radius:10px;color:white;font-size:10px;display:none;align-items:center;justify-content:center;font-weight:bold;border:2px solid #0d1117;padding:0 4px}
@media(max-width:600px){#acvoltAI{left:10px;right:10px;width:auto;top:190px;bottom:auto}#acvoltBtn{top:130px;right:10px;width:46px;height:46px}}
</style>

<div id="acvoltBtn" onclick="window._acAI.toggle()" style="overflow:hidden;"><img src="mario-black.jpg" alt="AI" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"><div class="ai-bdg" id="aiBdg">1</div></div>
<div id="acvoltAI">
<div class="ai-panel">
<div class="ai-head">
<div class="ai-head-left"><div class="ai-avatar-sm" style="overflow:hidden;padding:0;background:none;"><img src="mario-black.jpg" alt="Mario" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"></div><div><div class="ai-title">Asistente ACVOLT</div><div class="ai-subtitle">Soporte ¬∑ Gu√≠a ¬∑ Student Success</div></div></div>
<button class="ai-close" onclick="window._acAI.toggle()">‚úï</button>
</div>
<div class="ai-msgs" id="aiMs"></div>
<div class="ai-qk" id="aiQk"></div>
<div class="ai-inp">
<input type="text" id="aiIn" placeholder="Escribe tu pregunta..." onkeydown="if(event.key==='Enter')window._acAI.send()">
<button onclick="window._acAI.send()">‚û§</button>
</div>
</div>
</div>

<script>
(function(){
var CURL='https://htklsowiyjwsjnacnvnr.supabase.co/functions/v1/tutor-ia-chat';
var VURL='https://htklsowiyjwsjnacnvnr.supabase.co/functions/v1/tutor-ia-voice';
var AK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0a2xzb3dpeWp3c2puYWNudm5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NjIwMjQsImV4cCI6MjA4NjAzODAyNH0.6A3F7MI4YJEMo98b4Zfzao9p_hMh2T0ha0dRJ4SUhv0';
var open=false,hist=[],busy=false,aud=null,audUrl=null,greeted={},unread=0;

// === SYSTEM PROMPT ===
var SYS='Eres el ASISTENTE OFICIAL de ACVOLT Tech School dentro de la app MaestroAC. Tu nombre es "Asistente ACVOLT". Creado por Maestro Mario Flores Corona.\n\n'
+'=== TU ROL ===\n'
+'Eres soporte completo: onboarding, student success, promotor de la escuela, y gu\u00eda de uso. Eres el empleado estrella de ACVOLT 24/7.\n\n'
+'=== REGLAS CR\u00cdTICAS ===\n'
+'1. SOLO respondes sobre: la app MaestroAC, ACVOLT Tech School, pagos, membres\u00edas, ex\u00e1menes, check-in, certificados, c\u00f3digos de acceso, y uso de la plataforma.\n'
+'2. NUNCA respondas preguntas t\u00e9cnicas de HVAC, refrigeraci\u00f3n, electricidad, presiones, refrigerantes, voltajes, o del campo. Para esas SIEMPRE di: "\u00a1Excelente pregunta! Esa respuesta la tiene el **AI Maestro Mario** \ud83c\udf93 Ah\u00ed vas a aprender con **videos personalizados**, explicaciones con voz de Maestro Mario, y cualquier pregunta t\u00e9cnica del campo la resuelves directo con la IA. \ud83d\udc49 Entra aqu\u00ed: **maestromario.com** y suscr\u00edbete por solo **$49/mes**. \u00a1Vale cada centavo para tu carrera!"\n'
+'3. NUNCA respondas preguntas personales, cultura general, chistes, noticias, deportes, clima, o CUALQUIER tema fuera de la app y escuela.\n'
+'4. Si insisten en preguntas fuera de tema, di: "Mi trabajo es ayudarte con la app y tu \u00e9xito como estudiante. Para dudas t\u00e9cnicas de HVAC, el **AI Maestro Mario** en **maestromario.com** tiene videos, voz, y responde TODO del campo por $49/mes. \u00a1Te lo recomiendo al 100%!"\n'
+'5. S\u00e9 proactivo: despu\u00e9s de responder, sugiere el siguiente paso o haz una pregunta.\n'
+'6. Responde en espa\u00f1ol, m\u00e1ximo 80 palabras. Directo, amable y motivador.\n'
+'7. NUNCA digas "quiz", di "examen de pr\u00e1ctica".\n'
+'8. Usa la frase de Maestro Mario cuando sea relevante: "Si no mides, est\u00e1s adivinando."\n\n'
+'=== APP COMPLETA ===\n\n'
+'CHECK-IN (Mi Asistencia):\n'
+'- OBLIGATORIO antes de estudiar\n'
+'- Men\u00fa \u2192 "Mi Asistencia" \u2192 Seleccionar tipo (Presencial/Zoom/Computadora/M\u00f3vil) \u2192 Bot\u00f3n verde CHECK-IN\n'
+'- M\u00e1x 4 hrs por sesi\u00f3n y por d\u00eda\n'
+'- Clase en vivo: Mar/Mi\u00e9 6-10 PM California (sin l\u00edmite inactividad)\n'
+'- Fuera de clase: auto check-out a 15 min sin actividad\n'
+'- Aviso a los 10 min: "\u00bfSigues estudiando?"\n\n'
+'5 NIVELES: Principiante (gratis 30 d\u00edas) \u2192 Intermedio \u2192 Avanzado \u2192 Elite \u2192 Platino\n'
+'- Desbloquear: completar nivel anterior al 100%, o membres\u00eda activa, o c\u00f3digo de acceso\n'
+'- 3,500+ preguntas con explicaciones\n\n'
+'PAGOS Y MEMBRES\u00cdAS:\n'
+'- Gratis: 30 d\u00edas, solo Principiante\n'
+'- $20 USD/mes: 5 niveles, 3,500+ preguntas\n'
+'- $200 USD/a\u00f1o: mejor valor, ahorra $40\n'
+'- AI Maestro Mario: $49 USD/mes en maestromario.com (tutor HVAC con voz, videos personalizados, responde cualquier pregunta del campo)\n'
+'- Despu\u00e9s de pagar: enviar comprobante por WhatsApp (909) 639-0448\n\n'
+'CERTIFICADOS: Se generan al completar nivel al 100%. Ver en "Mis Certificados".\n\n'
+'SOLICITAR C\u00d3DIGO: Bot\u00f3n "Solicitar C\u00f3digo" \u2192 Requiere perfil completo \u2192 Admin lo aprueba.\n\n'
+'PROBLEMAS COMUNES:\n'
+'- No puedo entrar \u2192 Verificar email/pass, revisar spam, Magic Link, o Forgot Password\n'
+'- No me deja examen \u2192 Hacer Check-In primero\n'
+'- Me sac\u00f3 \u2192 Inactividad 15 min fuera de clase. Volver a Check-In\n'
+'- No veo certificados \u2192 Completar nivel al 100%\n'
+'- 4 hrs completadas \u2192 Volver ma\u00f1ana\n\n'
+'CONTACTO: WhatsApp (909) 639-0448 | techschoolacvolt@gmail.com | ACVOLT Tech School, San Bernardino, CA';

// === SCREEN GREETINGS ===
var SD={
loginScreen:{g:'\u00a1Bienvenido a MaestroAC! \ud83c\udf93 Soy tu asistente y voy a guiarte.\n\nSi ya tienes cuenta, ingresa correo y contrase\u00f1a arriba. Si eres nuevo, toca "REG\u00cdSTRATE GRATIS".\n\n\u00bfEn qu\u00e9 te ayudo?',q:['\u00bfC\u00f3mo me registro?','Olvid\u00e9 mi contrase\u00f1a','\u00bfQu\u00e9 es MaestroAC?','\u00bfEs gratis?'],c:'Est\u00e1 en LOGIN. Ay\u00fadalo a entrar o registrarse.'},
registerScreen:{g:'\u00a1Vamos a crear tu cuenta! \ud83d\udcdd\n\nEscribe tu nombre completo, un correo v\u00e1lido, y una contrase\u00f1a de m\u00ednimo 6 caracteres. Acepta los t\u00e9rminos y toca CREAR CUENTA.\n\n\u00a1Tienes 30 d\u00edas gratis!',q:['\u00bfQu\u00e9 datos necesito?','\u00bfEs realmente gratis?','\u00bfQu\u00e9 incluye gratis?'],c:'Est\u00e1 REGISTR\u00c1NDOSE. Gu\u00edalo paso a paso.'},
emailPendingScreen:{g:'\u00a1Ya casi! \ud83d\udce7 Revisa tu correo de confirmaci\u00f3n.\n\nBusca en bandeja de entrada, SPAM, o en Gmail "Promociones". Si no llega, puedes pedir reenv\u00edo.',q:['No encuentro el correo','Reenviar correo'],c:'Espera confirmaci\u00f3n de email.'},
welcomeScreen:{g:'\u00a1Bienvenido a tu panel! \ud83c\udfe0\n\nPrimer paso: haz tu **Check-In** para registrar horas. Luego ve a Entrenamiento para practicar.\n\n\u00bfYa hiciste tu Check-In?',q:['\u00bfC\u00f3mo hago Check-In?','Ir a ex\u00e1menes','Ver perfil','\u00bfC\u00f3mo desbloqueo niveles?'],c:'En MEN\u00da PRINCIPAL. Dirigirlo a Check-In.'},
attendanceScreen:{g:'\ud83d\udccb Aqu\u00ed registras tu asistencia.\n\n1. Selecciona tipo de clase\n2. Presiona CHECK-IN (bot\u00f3n verde)\n3. Estudia hasta 4 horas\n4. Presiona CHECK-OUT al terminar',q:['\u00bfCu\u00e1ntas horas puedo?','\u00bfQu\u00e9 pasa si salgo?','\u00bfPor qu\u00e9 me sac\u00f3?'],c:'En ASISTENCIA/CHECK-IN.'},
levelsScreen:{g:'\ud83d\udcda Tus 5 niveles de entrenamiento.\n\nEmpieza por **Principiante** (gratis). Completa todas las preguntas al 100% para desbloquear el siguiente.\n\n\u00bfEn qu\u00e9 nivel est\u00e1s?',q:['\u00bfC\u00f3mo desbloqueo?','\u00bfCu\u00e1ntas preguntas?','Necesito c\u00f3digo','Ver membres\u00edas'],c:'En NIVELES/EX\u00c1MENES.'},
miPerfilScreen:{g:'\ud83d\udc64 Tu perfil de t\u00e9cnico.\n\nAseg\u00farate de tener datos completos: nombre, tel\u00e9fono, ciudad y estado. Es necesario para solicitar c\u00f3digos y certificados.',q:['Editar datos','Solicitar c\u00f3digo','\u00bfPara qu\u00e9 sirve el perfil?'],c:'En PERFIL.'},
membershipZoneScreen:{g:'\ud83c\udf93 Planes disponibles:\n\n\u2022 **$20/mes** \u2014 5 niveles, 3,500+ preguntas\n\u2022 **$200/a\u00f1o** \u2014 Mejor valor, ahorra $40\n\u2022 **AI Maestro Mario $49/mes** \u2014 Videos personalizados, tutor HVAC con voz, y responde TODAS tus dudas del campo en **maestromario.com**\n\n\u00bfCu\u00e1l te interesa?',q:['Plan mensual $20','Plan anual $200','AI Maestro Mario $49','\u00bfQu\u00e9 incluye cada plan?'],c:'En MEMBRES\u00cdAS. Promueve plan anual como mejor valor y AI Maestro Mario para dudas t\u00e9cnicas.'},
certificatesScreen:{g:'\ud83c\udfc6 Tus certificados aparecen aqu\u00ed cuando completes un nivel con 80%+.\n\n\u00bfYa completaste tu primer nivel?',q:['No veo certificados','\u00bfC\u00f3mo los obtengo?','Ir a niveles'],c:'En CERTIFICADOS.'}
};

// === CORE ===
function addM(r,t){var c=document.getElementById('aiMs'),d=document.createElement('div');d.className='ai-m '+(r==='bot'?'b':'u');d.innerHTML=t.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');c.appendChild(d);c.scrollTop=c.scrollHeight;}
function showDots(){var c=document.getElementById('aiMs'),d=document.createElement('div');d.className='ai-dots';d.id='aiDt';d.innerHTML='<span></span><span></span><span></span>';c.appendChild(d);c.scrollTop=c.scrollHeight;}
function hideDots(){var e=document.getElementById('aiDt');if(e)e.remove();}
function showQk(a){var c=document.getElementById('aiQk');if(!a||!a.length){c.innerHTML='';return;}c.innerHTML=a.map(function(b){return'<button onclick="document.getElementById(\'aiIn\').value=\''+b.replace(/'/g,"\\'")+'\';window._acAI.send();">'+b+'</button>';}).join('');}

function speak(t){
var btn=document.getElementById('acvoltBtn');
if(!aud){aud=new Audio();aud.volume=0.8;var dummy=new Audio();dummy.src='data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAAAgAAAbAAqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAbD/2Q==';dummy.play().catch(function(){});}
fetch(VURL,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+AK,'apikey':AK},body:JSON.stringify({text:t.replace(/\*\*/g,'').replace(/[üéìüìùüìßüè†üìãüìöüë§üèÜüíé‚ö°üìäüîß‚ùÑÔ∏èüîëüí≥‚úÖ‚Ä¢\n]/g,' ').substring(0,500)})})
.then(function(r){if(!r.ok)throw 0;return r.blob();})
.then(function(b){if(b.size<100)return;if(audUrl)try{URL.revokeObjectURL(audUrl);}catch(e){}audUrl=URL.createObjectURL(b);aud.src=audUrl;btn.classList.add('speaking');aud.play().catch(function(){btn.classList.remove('speaking');});aud.onended=function(){btn.classList.remove('speaking');try{URL.revokeObjectURL(audUrl);}catch(e){}audUrl=null;};aud.onerror=function(){btn.classList.remove('speaking');};})
.catch(function(){});
}

function greet(sid){if(greeted[sid])return;var d=SD[sid];if(!d)return;greeted[sid]=true;addM('bot',d.g);showQk(d.q);speak(d.g);}
function updBdg(){var b=document.getElementById('aiBdg');if(unread>0&&!open){b.textContent=unread;b.style.display='flex';}else{b.style.display='none';unread=0;}}

// === PUBLIC API ===
window._acAI={
toggle:function(){
  open=!open;
  document.getElementById('acvoltAI').style.display=open?'flex':'none';
  if(open){unread=0;updBdg();document.getElementById('aiIn').focus();var a=document.querySelector('.screen.active');if(a)greet(a.id);}
},
send:function(){
  var inp=document.getElementById('aiIn'),txt=inp.value.trim();
  if(!txt||busy)return;busy=true;inp.value='';
  addM('user',txt);showQk([]);
  var a=document.querySelector('.screen.active');
  var ctx=a&&SD[a.id]?SD[a.id].c:'Navegando la app.';
  var uname='';try{var u=JSON.parse(localStorage.getItem('tecnico_user')||'{}');uname=u.nombre||'';}catch(e){}
  hist.push({role:'user',content:txt});
  if(hist.length>14)hist=hist.slice(-14);
  showDots();
  var full=SYS+'\n\nCONTEXTO ACTUAL: '+ctx+(uname?' Nombre del t\u00e9cnico: '+uname:'');
  var ac=new AbortController();var tid=setTimeout(function(){ac.abort();},25000);
  fetch(CURL,{method:'POST',signal:ac.signal,headers:{'Content-Type':'application/json','Authorization':'Bearer '+AK,'apikey':AK},body:JSON.stringify({messages:hist,system:full,max_tokens:400})})
  .then(function(r){clearTimeout(tid);return r.json();})
  .then(function(d){hideDots();if(d.content&&d.content.length>0){var rp=d.content.map(function(c){return c.text||'';}).join('\n');hist.push({role:'assistant',content:rp});addM('bot',rp);speak(rp);var sd=a&&SD[a.id]?SD[a.id]:null;if(sd)showQk(sd.q);}else{addM('bot','Intenta de nuevo por favor.');}})
  .catch(function(){hideDots();addM('bot','Error de conexi\u00f3n. Verifica tu internet.');})
  .finally(function(){busy=false;});
},
notify:function(text,qk){
  if(!open){unread++;updBdg();}
  addM('bot',text);if(qk)showQk(qk);
  speak(text);
}
};

// === AUTO-OPEN on login/register after 4 seconds ===
setTimeout(function(){
  var a=document.querySelector('.screen.active');
  if(a&&(a.id==='loginScreen'||a.id==='registerScreen')){
    if(!open)window._acAI.toggle();
  }
},4000);

// === HOOK showScreen to auto-greet ===
var _origSS=window.showScreen;
if(_origSS){
  var _hookedSS=function(id){
    _origSS(id);
    if(open)setTimeout(function(){greet(id);},400);
    else if(SD[id]&&!greeted[id]){unread++;updBdg();}
  };
  // Replace showScreen globally
  window.showScreen=_hookedSS;
  // Also check if it was overridden elsewhere
  setTimeout(function(){if(window.showScreen!==_hookedSS){var other=window.showScreen;window.showScreen=function(id){other(id);if(open)setTimeout(function(){greet(id);},400);else if(SD[id]&&!greeted[id]){unread++;updBdg();}};}},3000);
}

})();
</script>

<!-- HOME BUTTON - Volver al Launcher -->
<button class="home-fab" onclick="showLauncher()" title="Men√∫ Principal">üè†</button>

<!-- AI CHARACTER COUNTER -->
<div class="ai-chars-banner" id="aiCharsBanner">ü§ñ <span id="aiCharsCount">50,000</span> / 50,000</div>

<!-- AI PAYWALL MODAL -->
<div class="paywall-overlay" id="paywallModal">
  <div class="paywall-card">
    <div class="pw-icon">ü§ñ</div>
    <div class="pw-title">AI MAESTRO MARIO</div>
    <div class="pw-subtitle">Desbloquea el poder de la inteligencia artificial</div>
    <div class="pw-features">
      <div class="pw-feature"><span>‚úÖ</span> Mario te explica con IA</div>
      <div class="pw-feature"><span>‚úÖ</span> Chat ilimitado con Mario</div>
      <div class="pw-feature"><span>‚úÖ</span> Voz de Mario te gu√≠a</div>
      <div class="pw-feature"><span>‚úÖ</span> Pistas inteligentes</div>
      <div class="pw-feature"><span>‚úÖ</span> 50,000 caracteres/mes</div>
      <div class="pw-feature"><span>‚úÖ</span> Funciona en AMBAS apps</div>
    </div>
    <div class="pw-price">$49 USD</div>
    <div class="pw-period">por mes ¬∑ cancela cuando quieras</div>
    <button class="pw-btn" id="paywallSubscribeBtn" onclick="startStripeCheckout()">üí≥ Suscribirse</button>
    <button class="pw-close" onclick="closePaywall()">‚úñ No gracias</button>
  </div>
</div>

<!-- AI PREMIUM SYSTEM -->
<script>
(function(){
  // ===== AI PREMIUM & CHARACTER SYSTEM =====
  var CHAR_LIMIT = 50000;

  // Get or init premium data
  function getPremiumData(){
    try {
      var d = JSON.parse(localStorage.getItem('maestroac_ai_premium') || 'null');
      if(!d) d = { active: false, chars_used: 0, month: new Date().getMonth(), year: new Date().getFullYear() };
      // Reset chars if new month
      var now = new Date();
      if(d.month !== now.getMonth() || d.year !== now.getFullYear()){
        d.chars_used = 0;
        d.month = now.getMonth();
        d.year = now.getFullYear();
        savePremiumData(d);
      }
      return d;
    } catch(e){ return { active: false, chars_used: 0, month: new Date().getMonth(), year: new Date().getFullYear() }; }
  }

  function savePremiumData(d){
    try { localStorage.setItem('maestroac_ai_premium', JSON.stringify(d)); } catch(e){}
  }

  function getCharsRemaining(){
    var d = getPremiumData();
    return Math.max(0, CHAR_LIMIT - d.chars_used);
  }

  function useChars(count){
    var d = getPremiumData();
    d.chars_used += count;
    savePremiumData(d);
    updateCharsUI();
    checkCharWarnings(d);
  }

  function updateCharsUI(){
    var remaining = getCharsRemaining();
    var el = document.getElementById('aiCharsCount');
    var banner = document.getElementById('aiCharsBanner');
    if(el) el.textContent = remaining.toLocaleString();
    if(banner){
      var d = getPremiumData();
      if(d.active) banner.classList.add('show');
      else banner.classList.remove('show');
    }
  }

  function checkCharWarnings(d){
    var remaining = CHAR_LIMIT - d.chars_used;
    var pct = remaining / CHAR_LIMIT;
    // Mario warnings shown via alert (could be upgraded to toast)
    var nombre = '';
    try { var t = JSON.parse(localStorage.getItem('tecnico_user')||'{}'); nombre = t.nombre || 't√©cnico'; } catch(e){ nombre='t√©cnico'; }
    if(remaining <= 0){
      var nextMonth = new Date(); nextMonth.setMonth(nextMonth.getMonth()+1); nextMonth.setDate(1);
      setTimeout(function(){ alert('üîí Se acabaron tus caracteres AI este mes, '+nombre+'. Los quizzes y explicaciones escritas siguen gratis. Se renuevan el '+nextMonth.toLocaleDateString('es-MX')+'.'); },500);
    } else if(pct <= 0.2 && pct > 0){
      setTimeout(function(){ alert('‚ö†Ô∏è Te quedan pocos caracteres AI ('+remaining.toLocaleString()+'), '+nombre+'. Gu√°rdalos para las preguntas m√°s dif√≠ciles.'); },500);
    }
  }

  // Check if user has premium access
  window.checkAIPremium = function(){
    var d = getPremiumData();
    if(!d.active){
      document.getElementById('paywallModal').classList.add('active');
      return false;
    }
    if(getCharsRemaining() <= 0){
      var nombre = '';
      try { var t = JSON.parse(localStorage.getItem('tecnico_user')||'{}'); nombre = t.nombre || 't√©cnico'; } catch(e){ nombre='t√©cnico'; }
      alert('üîí Se acabaron tus caracteres AI este mes, '+nombre+'. Se renuevan el pr√≥ximo mes.');
      return false;
    }
    return true;
  };

  // Track chars used after AI response
  window.trackAIChars = function(text){
    if(text) useChars(text.length);
  };

  window.closePaywall = function(){
    document.getElementById('paywallModal').classList.remove('active');
  };

  var STRIPE_PAYMENT_LINK = 'https://buy.stripe.com/bJecN54zJ8Bic2X6If3sI0h';

  window.startStripeCheckout = function(){
    // Redirect to Stripe Payment Link
    window.location.href = STRIPE_PAYMENT_LINK;
  };

  // Check URL params for Stripe success
  function checkStripeReturn(){
    var params = new URLSearchParams(window.location.search);
    if(params.get('premium') === 'success'){
      var d = getPremiumData();
      d.active = true;
      d.activated_at = new Date().toISOString();
      savePremiumData(d);
      // Clean URL
      window.history.replaceState({}, '', window.location.pathname);
      // Welcome message
      var nombre = '';
      try { var t = JSON.parse(localStorage.getItem('tecnico_user')||'{}'); nombre = t.nombre || 't√©cnico'; } catch(e){ nombre='t√©cnico'; }
      setTimeout(function(){
        alert('üéâ ¬°Bienvenido a AI Premium, '+nombre+'! Tienes 50,000 caracteres de AI este mes. √ösalos para preguntas que realmente no entiendas. Las explicaciones escritas son gratis ‚Äî usa AI cuando ocupes que te lo explique m√°s a fondo. üß†');
      }, 500);
    }
  }

  // Init
  updateCharsUI();
  checkStripeReturn();
})();
</script>

<!-- ============================================ -->
<!-- IN-APP EMAIL COMPOSE MODAL -->
<!-- ============================================ -->
<div id="appEmailModal" style="display:none;position:fixed;inset:0;z-index:99998;background:rgba(10,22,40,0.92);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:20px">
  <div style="background:white;border-radius:20px;max-width:560px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 25px 60px rgba(0,0,0,0.4);">
    <!-- Header -->
    <div style="background:linear-gradient(135deg,#1565C0,#0D47A1);padding:20px 24px;border-radius:20px 20px 0 0;display:flex;align-items:center;justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:12px;">
        <span style="font-size:28px;">üìß</span>
        <div>
          <h3 style="color:white;margin:0;font-size:18px;" id="emailModalTitle">Enviar Email</h3>
          <p style="color:rgba(255,255,255,0.7);margin:0;font-size:12px;">Desde: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="623607010a11010a0d0d0e0301140d0e1622050f030b0e4c010d0f">[email&#160;protected]</a></p>
        </div>
      </div>
      <button onclick="closeEmailModal()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;">‚úï</button>
    </div>
    <!-- Body -->
    <div style="padding:24px;">
      <div style="margin-bottom:16px;">
        <label style="display:block;color:#64748b;font-size:12px;font-weight:600;margin-bottom:6px;">PARA:</label>
        <input type="text" id="emailModalTo" readonly style="width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:10px;font-size:14px;background:#f8fafc;color:#334155;box-sizing:border-box;">
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block;color:#64748b;font-size:12px;font-weight:600;margin-bottom:6px;">ASUNTO:</label>
        <input type="text" id="emailModalSubject" style="width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:10px;font-size:14px;color:#334155;box-sizing:border-box;">
      </div>
      <div style="margin-bottom:20px;">
        <label style="display:block;color:#64748b;font-size:12px;font-weight:600;margin-bottom:6px;">MENSAJE:</label>
        <textarea id="emailModalBody" rows="8" style="width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:10px;font-size:14px;color:#334155;resize:vertical;font-family:inherit;box-sizing:border-box;"></textarea>
      </div>
      <!-- Status message -->
      <div id="emailModalStatus" style="display:none;padding:12px;border-radius:10px;margin-bottom:16px;text-align:center;font-size:13px;font-weight:600;"></div>
      <!-- Action buttons -->
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button id="emailModalSendBtn" onclick="sendEmailFromModal()" style="flex:1;min-width:140px;background:linear-gradient(135deg,#1565C0,#0D47A1);color:white;border:none;border-radius:12px;padding:14px;font-size:15px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
          üöÄ Enviar Email
        </button>
        <button onclick="openGmailFallback()" style="flex:1;min-width:140px;background:linear-gradient(135deg,#ea4335,#c5221f);color:white;border:none;border-radius:12px;padding:14px;font-size:15px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
          üì® Abrir Gmail
        </button>
      </div>
      <p style="text-align:center;color:#94a3b8;font-size:11px;margin-top:12px;">Si "Enviar Email" no funciona, usa "Abrir Gmail" como respaldo</p>
    </div>
  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ============================================
// IN-APP EMAIL SYSTEM - Techschoolacvolt@gmail.com
// ============================================
var APP_EMAIL_FROM = 'Techschoolacvolt@gmail.com';
var APP_EMAIL_SENDER_NAME = 'ACVOLT Tech School';

// Open the in-app email compose modal
function openEmailComposer(to, subject, body, title) {
  document.getElementById('emailModalTo').value = to || '';
  document.getElementById('emailModalSubject').value = subject || '';
  document.getElementById('emailModalBody').value = body || '';
  document.getElementById('emailModalTitle').textContent = title || 'Enviar Email';
  document.getElementById('emailModalStatus').style.display = 'none';
  document.getElementById('emailModalSendBtn').disabled = false;
  document.getElementById('emailModalSendBtn').innerHTML = 'üöÄ Enviar Email';
  document.getElementById('appEmailModal').style.display = 'flex';
}

// Close email modal
function closeEmailModal() {
  document.getElementById('appEmailModal').style.display = 'none';
}

// Send email via Supabase Edge Function
async function sendEmailFromModal() {
  var toEmail = document.getElementById('emailModalTo').value.trim();
  var subject = document.getElementById('emailModalSubject').value.trim();
  var body = document.getElementById('emailModalBody').value.trim();
  var statusEl = document.getElementById('emailModalStatus');
  var sendBtn = document.getElementById('emailModalSendBtn');

  if (!toEmail || !subject || !body) {
    statusEl.style.display = 'block';
    statusEl.style.background = '#fef2f2';
    statusEl.style.color = '#dc2626';
    statusEl.textContent = '‚ö†Ô∏è Completa todos los campos';
    return;
  }

  // Show sending state
  sendBtn.disabled = true;
  sendBtn.innerHTML = '‚è≥ Enviando...';
  statusEl.style.display = 'block';
  statusEl.style.background = '#eff6ff';
  statusEl.style.color = '#2563eb';
  statusEl.textContent = 'üì§ Enviando email...';

  try {
    // Try Supabase Edge Function first
    var response = await fetch(SUPABASE_URL + '/functions/v1/send-email', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + SUPABASE_KEY
      },
      body: JSON.stringify({
        to: toEmail,
        subject: subject,
        body: body,
        from_name: APP_EMAIL_SENDER_NAME
      })
    });

    if (response.ok) {
      var result = await response.json();
      statusEl.style.background = '#f0fdf4';
      statusEl.style.color = '#16a34a';
      statusEl.textContent = '‚úÖ ¬°Email enviado exitosamente!';
      sendBtn.innerHTML = '‚úÖ Enviado';
      // Auto-close after 2 seconds
      setTimeout(function() { closeEmailModal(); }, 2000);
      return;
    } else {
      throw new Error('Edge Function responded with ' + response.status);
    }
  } catch (err) {
    console.log('[Email] Edge Function not available, offering fallback:', err.message);
    statusEl.style.background = '#fffbeb';
    statusEl.style.color = '#d97706';
    statusEl.textContent = '‚ö†Ô∏è Servicio de email no configurado. Usa "Abrir Gmail" para enviar.';
    sendBtn.disabled = false;
    sendBtn.innerHTML = 'üöÄ Reintentar';
  }
}

// Gmail web fallback - opens Gmail compose in browser
function openGmailFallback() {
  var to = document.getElementById('emailModalTo').value.trim();
  var subject = encodeURIComponent(document.getElementById('emailModalSubject').value.trim());
  var body = encodeURIComponent(document.getElementById('emailModalBody').value.trim());
  
  // Gmail compose URL works in all browsers and PWAs
  var gmailUrl = 'https://mail.google.com/mail/?view=cm&fs=1&to=' + to + '&su=' + subject + '&body=' + body;
  window.open(gmailUrl, '_blank');
  
  var statusEl = document.getElementById('emailModalStatus');
  statusEl.style.display = 'block';
  statusEl.style.background = '#f0fdf4';
  statusEl.style.color = '#16a34a';
  statusEl.textContent = '‚úÖ Gmail abierto en nueva pesta√±a';
}

// Quick send email (for inline buttons that don't need the full modal)
function quickSendEmail(to, subject, body) {
  openEmailComposer(to, subject, body, 'Enviar Email a ' + to);
}
</script>

<!-- WELCOME BACK OVERLAY -->
<div id="welcomeBackOverlay" style="display:none;position:fixed;inset:0;z-index:99999;background:rgba(10,22,40,0.97);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:20px">
  <div style="background:#1a2332;border:1px solid rgba(0,212,255,0.2);border-radius:20px;max-width:400px;width:100%;padding:24px 20px;text-align:center">
    <div style="font-size:50px;margin-bottom:8px">üìö</div>
    <div id="wbTitle" style="font-family:sans-serif;font-size:20px;font-weight:700;color:#fff;margin-bottom:8px">¬°Bienvenido de vuelta!</div>
    <div id="wbMessage" style="background:#0d1b2a;border-radius:12px;padding:14px;text-align:left;font-size:14px;line-height:1.7;color:#ccc;border-left:3px solid #ff6b2b;margin-bottom:16px"></div>
    <div id="wbProgress" style="font-size:13px;color:#00d4ff;margin-bottom:16px"></div>
    <button onclick="closeWelcomeBack()" style="width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#ff6b2b,#e84500);color:#fff;font-size:16px;font-weight:700;cursor:pointer" id="wbBtn">üöÄ ¬°Vamos a estudiar!</button>
  </div>
</div>

<!-- NOTIFICATION & REMINDER SYSTEM -->
<script>
(function(){
  var INACTIVITY_HOURS = 4;
  var CHECK_INTERVAL_MS = 60000;
  var STORAGE_KEY = 'maestro_last_activity';
  var NOTIF_KEY = 'maestro_notif_sent';
  var SUPABASE_ACTIVITY_URL = 'https://htklsowiyjwsjnacnvnr.supabase.co/rest/v1/rpc/update_user_activity';
  var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0a2xzb3dpeWp3c2puYWNudm5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NjIwMjQsImV4cCI6MjA4NjAzODAyNH0.6A3F7MI4YJEMo98b4Zfzao9p_hMh2T0ha0dRJ4SUhv0';
  var lastSyncTime = 0;
  var SYNC_INTERVAL = 300000; // 5 min throttle

  function syncActivityToSupabase(){
    var now = Date.now();
    if(now - lastSyncTime < SYNC_INTERVAL) return;
    lastSyncTime = now;
    try {
      var u = JSON.parse(localStorage.getItem('tecnico_user')||'{}');
      if(!u.email) return;
      fetch(SUPABASE_ACTIVITY_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'apikey':SUPABASE_ANON_KEY, 'Authorization':'Bearer '+SUPABASE_ANON_KEY },
        body: JSON.stringify({
          p_nombre: u.nombre || 't√©cnico',
          p_email: u.email,
          p_telefono: u.telefono || null,
          p_lang: 'es',
          p_app: 'v1',
          p_quiz_score: null,
          p_quizzes: null,
          p_premium: !!JSON.parse(localStorage.getItem('ai_premium_data')||'{}').active
        })
      }).catch(function(){});
    } catch(e){}
  }

  function updateActivity(){
    localStorage.setItem(STORAGE_KEY, Date.now().toString());
    localStorage.removeItem(NOTIF_KEY);
    syncActivityToSupabase();
  }

  function getLastActivity(){
    var t = localStorage.getItem(STORAGE_KEY);
    return t ? parseInt(t) : Date.now();
  }

  function getInactiveHours(){
    return (Date.now() - getLastActivity()) / (1000 * 60 * 60);
  }

  ['click','keydown','scroll','touchstart'].forEach(function(ev){
    document.addEventListener(ev, updateActivity, {passive:true});
  });
  updateActivity();

  // Browser Notifications
  function requestNotifPermission(){
    if('Notification' in window && Notification.permission === 'default'){
      setTimeout(function(){ Notification.requestPermission(); }, 30000);
    }
  }

  function sendBrowserNotification(title, body){
    if('Notification' in window && Notification.permission === 'granted'){
      try {
        var n = new Notification(title, { body: body, tag: 'maestro-reminder', renotify: true });
        n.onclick = function(){ window.focus(); n.close(); };
      } catch(e){}
    }
  }

  // Inactivity checker
  function checkInactivity(){
    var hours = getInactiveHours();
    var alreadySent = localStorage.getItem(NOTIF_KEY);
    if(hours >= INACTIVITY_HOURS && !alreadySent){
      localStorage.setItem(NOTIF_KEY, 'true');
      var nombre = 't√©cnico';
      try { var u = JSON.parse(localStorage.getItem('tecnico_user')||'{}'); nombre = u.nombre ? u.nombre.split(' ')[0] : 't√©cnico'; } catch(e){}
      if(document.hidden){
        sendBrowserNotification('¬°Hey ' + nombre + '! üìö', 'Llevas ' + Math.floor(hours) + ' horas sin estudiar. ¬°Maestro ACVOLT te espera!');
      }
    }
  }
  setInterval(checkInactivity, CHECK_INTERVAL_MS);

  // Welcome Back Screen
  function showWelcomeBack(){
    var hours = getInactiveHours();
    if(hours < INACTIVITY_HOURS) return;

    var nombre = 't√©cnico';
    try { var u = JSON.parse(localStorage.getItem('tecnico_user')||'{}'); nombre = u.nombre ? u.nombre.split(' ')[0] : 't√©cnico'; } catch(e){}

    var hoursAway = Math.floor(hours);
    var daysAway = Math.floor(hours / 24);
    var timeText = daysAway >= 1 ? daysAway + ' d√≠a' + (daysAway>1?'s':'') : hoursAway + ' hora' + (hoursAway>1?'s':'');

    var msgs = [
      '¬°' + nombre + ', te extra√±aba! Llevas ' + timeText + ' sin estudiar. Recuerda: la consistencia es m√°s importante que la perfecci√≥n. Cada d√≠a que estudias es un d√≠a m√°s cerca de tu certificaci√≥n. ¬°Vamos con todo!',
      '¬°' + nombre + '! Ya pasaron ' + timeText + '. Un t√©cnico que no practica se oxida como un contacto sin mantenimiento. ¬°Vamos a repasar!',
      '¬°√ìrale, ' + nombre + '! ' + timeText + ' sin estudiar es mucho. Los mejores t√©cnicos practican todos los d√≠as. ¬°Yo s√© que t√∫ puedes!',
      '¬°' + nombre + ', bienvenido de vuelta! ' + timeText + ' lejos es bastante. Pero lo bueno es que regresaste ‚Äî eso dice mucho de ti. ¬°A darle!'
    ];
    var msg = msgs[Math.floor(Math.random() * msgs.length)];

    document.getElementById('wbTitle').textContent = '¬°Bienvenido de vuelta, ' + nombre + '! üëã';
    document.getElementById('wbMessage').in
